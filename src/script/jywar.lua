-- 大字符
local function TXWZ_BIG(str, color, ttf) -- 显示阴影字符串
    ttf = ttf or CC.FontName
    local x = 0
    local y = 0
    local size = 60
    local x = CC.ScreenW / 2;
    local y = CC.ScreenH / 2 - size * 2;
    local stn = string.len(str)
    local offx = (#str) * size / 4
    local offy = size / 2
    for k = 1, 20 do
        Cat('实时特效动画')
        Cls()
        Cat('实时特效动画2')
        -- lib.Background(0,y-50,CC.ScreenW,y+50,98)
        DrawString(x - offx, y - offy, str, color, size, ttf);
        ShowScreen();
        lib.Delay(CC.BattleDelay)
    end
end

function Set_Eff_Text(id, wzid, str, dh)
    local z = {
        ['特效文字1'] = 1,
        ['特效文字2'] = 2,
        ['特效文字3'] = 3,
        ['特效文字4'] = 4,
        ['特效文字0'] = 0
    }
    local wz = ''
    if z[wzid] ~= nil then
        wzid = z[wzid]
    end
    wz = "特效文字" .. wzid
    local t = {}
    local twz = WAR.Person[id][wz]
    if twz == nil then
        twz = ''
    else
        t[#t + 1] = twz
    end
    if twz == '' then
        WAR.TXWZ[wz][id] = {}
        WAR.TXWZ[wz][id][str] = 1
        t[#t + 1] = str
    else
        if WAR.TXWZ[wz][id] ~= nil then
            if WAR.TXWZ[wz][id][str] == nil then
                WAR.TXWZ[wz][id][str] = 1
                t[#t + 1] = str
            end
        end
    end
    if wzid == 4 then
        twz = table.concat(t, '.')
    else
        twz = table.concat(t, '.')
    end
    WAR.Person[id][wz] = twz
    if WAR.Person[id]['护盾'] ~= nil and WAR.Person[id]['护盾'] > 0 then
        dh = -1
    end
    if dh ~= nil and WAR.Person[id]['特效动画'] == -1 then
        WAR.Person[id]['特效动画'] = dh
    end
end

-- 顶部特效文字 
function TXWZXS(str, cl, n)
    if n == nil then
        n = 0
    end
    local i = n
    if i > 20 then
        i = 20
    end
    Cat('实时特效动画')
    Cls()
    Cat('实时特效动画2')
    DrawStrBox(-1, 24, str, cl, 10 + i)
    ShowScreen()
    lib.Delay(CC.BattleDelay)
    if n == 40 then
        return
    else
        return TXWZXS(str, cl, n + 5)
    end
end

-- 返回两人之间的实际距离
function War_realjl(ida, idb)
    if ida == nil then
        ida = WAR.CurID
    end
    CleanWarMap(3, 255)
    local x = WAR.Person[ida]["坐标X"]
    local y = WAR.Person[ida]["坐标Y"]
    local steparray = {}
    steparray[0] = {}
    steparray[0].bushu = {}
    steparray[0].x = {}
    steparray[0].y = {}
    SetWarMap(x, y, 3, 0)
    steparray[0].num = 1
    steparray[0].bushu[1] = 0 -- 还能移动的步数
    steparray[0].x[1] = x
    steparray[0].y[1] = y
    return War_FindNextStep1(steparray, 0, ida, idb)
end

-- AI选择目标的函数
function unnamed(kfid)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local kungfuid = JY.Person[pid]["武功" .. kfid]
    local kungfulv = JY.Person[pid]["武功等级" .. kfid]
    if kungfulv == 999 then
        kungfulv = 11
    else
        kungfulv = math.modf(kungfulv / 100) + 1
    end
    -- local st1 = lib.GetTime()
    -- 武功范围计算
    local m1, m2, a1, a2, a3, a4, a5 = refw(kungfuid, kungfulv)
    -- 移动范围
    local mfw = {m1, m2}
    -- 攻击范围
    local atkfw = {a1, a2, a3, a4, a5}
    if kungfulv == 11 then
        kungfulv = 10
    end
    -- AI也用新的威力判定
    local kungfuatk = get_skill_power(pid, kungfuid, kungfulv)
    local atkarray = {}
    local num = 0
    CleanWarMap(4, -1)
    -- local st2 = lib.GetTime()
    -- 定义攻击者，攻击者移动步数，0表
    local movearray = War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)

    -- local st3 = lib.GetTime()
    -- 循环人物移动步数
    for i = 0, WAR.Person[WAR.CurID]["移动步数"] do
        -- 定义
        local step_num = movearray[i].num
        if step_num ~= nil then
            for j = 1, step_num do
                local xx = movearray[i].x[j]
                local yy = movearray[i].y[j]
                num = num + 1
                atkarray[num] = {}
                atkarray[num].x, atkarray[num].y = xx, yy
                atkarray[num].p, atkarray[num].ax, atkarray[num].ay = GetAtkNum(xx, yy, mfw, atkfw, kungfuatk)
            end
        end
    end
    for i = 1, num - 1 do
        for j = i + 1, num do
            if atkarray[i].p < atkarray[j].p then
                atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
            end
        end
    end
    --攻击范围内有敌人
    if atkarray[1].p > 0 then
        for i = 2, num do
            if atkarray[i].p == 0 or atkarray[i].p < atkarray[1].p / 2 then
                num = i - 1
                break
            end
        end

        for i = 1, num - 1 do
            for j = i + 1, num do
                if atkarray[i].p < atkarray[j].p then
                    atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
                elseif atkarray[i].p == atkarray[j].p and math.random(2) > 1 then
                    atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
                end
            end
        end
        local select = 1 -- math.random(num)
        -- say('时间1'..st1..'*'..'时间2'..st2..'*'..'时间3'..st3..'*'..'时间4'..st4..'*'..'时间5'..st5,1)		
        War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
        War_MovePerson(atkarray[select].x, atkarray[select].y)
        -- 老顾0309
        -- 随机招式 随机武功招式 优先绝招
        local zsn1 = {}
        local zsn = 0
        local YXSY = JY.Person[pid]["优先使用"]
        local zsmenu = {}
        local zspd = false
        if YXSY > 0 then
            for i = 1, JY.Base["武功数量"] do
                for j = 1, #CC.KFMove[YXSY] do
                    if j == 1 then
                        CC.KFMove[YXSY][j][3] = 0
                    end
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == YXSY then
                        if JY.Person[pid]["武功招式" .. zs] == 1 then
                            if JY.Person[pid]["能量"] >= CC.KFMove[YXSY][j][3] then
                                zsmenu[#zsmenu + 1] = j -- 招式位置   
                                -- lib.Debug('收集可用招式'..j)                                               
                            end
                        end
                    end
                end
            end
        end

        local zsnum = #zsmenu
        -- lib.Debug('可使用招式数量'..zsnum) 
        if WAR.LQZ[pid] == nil then
            WAR.LQZ[pid] = 0
        end

        local zn = zsnum
        if JY.Person[pid]['招式方针'] == 0 then 
            if WAR.LQZ[pid] - JZ_lqz(pid) < 0 then
                if zn < 1 then
                    zn = 1
                    zsmenu[#zsmenu + 1] = 1
                else
                    zn = zn - 1
                end
                -- lib.Debug('zn== '..zn)
                local zs1 = 1
                if zn > zs1 then
                    zs1 = math.random(zn)
                end
                -- lib.Debug(JY.Person[pid]['姓名']..'随机招式'..zs1)
                zsn = zsmenu[zs1]
                -- lib.Debug(JY.Person[pid]['姓名']..'使用招式'..zsn)
            else
                zsn = zsmenu[zsnum]
            end
        else
            if WAR.LQZ[pid] - JZ_lqz(pid) < 0 then
                zsn = JY.Person[pid]['招式方针']
            else
                zsn = zsmenu[zsnum]
            end  
        end

        -- 随机一个招式位置
        -- zsn = 1  
        if zsn ~= nil and zsn > 0 then
            -- lib.Debug(JY.Person[pid]['姓名']..' 使用'..JY.Wugong[YXSY]['名称']..'第'..zsn..'招')
            WAR.WGZS = zsn
            War_Fight_Sub(WAR.CurID, kfid, atkarray[select].ax, atkarray[select].ay)
        else
            War_AutoEscape()
            War_RestMenu()
        end
        if fjpd(WAR.CurID) then
            return
        end
        -- 阿凡提攻击完躲开
        if pid == 606 then
            WAR.Person[WAR.CurID]["移动步数"] = 10
            War_AutoEscape()
            War_RestMenu()
        end
    else
        if fjpd(WAR.CurID) then
            return
        end

        -- 打不到人，考虑吃药
        local jl, nx, ny = War_realjl()
        AutoMove()

        -- 剑魔BOSS
        if match_ID(pid, 592) and Boss(WAR.CurID) then
            War_Fight_Sub(WAR.CurID, kfid, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"])
            return
        end
        -- 默认为休息
        local what_to_do = 0
        local can_eat_drug = 0
        -- 非我方，会考虑吃药
        if WAR.Person[WAR.CurID]["我方"] == false then
            can_eat_drug = 1
            -- 如果是我方，只有在队且允许才会吃药
        else
            if isteam(pid) and JY.Person[pid]["是否吃药"] == 1 then
                can_eat_drug = 1
            end
        end
        -- 侠客正岛主战不吃药
        -- 洪七公居洪七公不吃药
        if WAR.Person[WAR.CurID]["我方"] == false and (WAR.ZDDH == 188 or WAR.ZDDH == 257) then
            can_eat_drug = 0
        end
        -- 左右第二下，不能吃药
        if WAR.ZYHB == 2 then
            can_eat_drug = 0
        end
        -- 1:吃体力药 2：吃血 3：医疗 4：吃内力 5：吃解毒 NPCWAR不吃药
        if can_eat_drug == 1 and WAR.ZDDH ~= 354 then
            local r = -1
            -- 体力低于10，吃体力药
            if JY.Person[pid]["体力"] < 10 then
                r = War_ThinkDrug(4)
                if r >= 0 then
                    what_to_do = 1
                end
            end
            local rate = -1
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
                rate = 90
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
                rate = 70
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
                rate = 50
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
                rate = 25
            end
            -- 内伤也增加吃血药几率
            if WAR.PD['内伤状态'][pid] ~= nil and WAR.PD['内伤状态'][pid] > 50 then
                rate = rate + 50
            end
            if Rnd(100) < rate then
                r = War_ThinkDrug(2)
                if r >= 0 then -- 如果有药吃药 
                    what_to_do = 2
                else
                    r = War_ThinkDoctor() -- 如果没有药，考虑医疗
                    if r >= 0 then
                        what_to_do = 3
                    end
                end
            end
            -- 考虑内力
            rate = -1
            if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
                rate = 100
            elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
                rate = 75
            elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
                rate = 50
            end
            if Rnd(100) < rate then
                r = War_ThinkDrug(3)
                if r >= 0 then
                    what_to_do = 4
                end
            end
            rate = -1
            if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
                rate = 60
            else
                if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
                    rate = 30
                end
            end
            -- 半血以下，才吃解毒药
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and Rnd(100) < rate then
                r = War_ThinkDrug(6)
                if r >= 0 then
                    what_to_do = 5
                end
            end
        end
        -- 吃药flag 2：生命 3：内力 4：体力 6：解毒
        if what_to_do == 0 then
            War_RestMenu()
        elseif what_to_do == 1 then
            War_AutoEatDrug(4)
        elseif what_to_do == 2 then
            War_AutoEatDrug(2)
        elseif what_to_do == 3 then
            War_AutoDoctor()
        elseif what_to_do == 4 then
            War_AutoEatDrug(3)
        elseif what_to_do == 5 then
            War_AutoEatDrug(6)
        end
    end
end

function AutoMove()
    local x, y = nil, nil
    local minDest = math.huge
    local enemyid = War_AutoSelectEnemy() -- 选择最近敌人

    War_CalMoveStep(WAR.CurID, 100, 0); -- 计算移动步数 假设最大100步

    for i = 0, CC.WarWidth - 1 do
        for j = 0, CC.WarHeight - 1 do
            local dest = GetWarMap(i, j, 3);
            if dest < 128 then
                local dx = math.abs(i - WAR.Person[enemyid]["坐标X"])
                local dy = math.abs(j - WAR.Person[enemyid]["坐标Y"])
                if minDest > (dx + dy) then -- 此时x,y是距离敌人的最短路径，虽然可能被围住
                    minDest = dx + dy;
                    x = i;
                    y = j;
                elseif minDest == (dx + dy) then
                    if Rnd(2) == 0 then
                        x = i;
                        y = j;
                    end
                end
            end
        end
    end

    if minDest < math.huge then -- 有路可走
        while true do -- 从目的位置反着找到可以移动的位置，作为移动的次序
            local i = GetWarMap(x, y, 3);
            if i <= WAR.Person[WAR.CurID]["移动步数"] then
                break
            end

            if GetWarMap(x - 1, y, 3) == i - 1 then
                x = x - 1;
            elseif GetWarMap(x + 1, y, 3) == i - 1 then
                x = x + 1;
            elseif GetWarMap(x, y - 1, 3) == i - 1 then
                y = y - 1;
            elseif GetWarMap(x, y + 1, 3) == i - 1 then
                y = y + 1;
            end
        end
        War_MovePerson(x, y); -- 移动到相应的位置
    end
end

function GetMovePoint(x, y, flag)
    local point = 0
    local wofang = WAR.Person[WAR.CurID]["我方"]
    local bs = WAR.Person[WAR.CurID]["移动步数"]
    local movearray = MY_CalMoveStep(x, y, bs, 1)
    for i = 1, bs do
        local step_num = movearray[i].num
        if step_num ~= nil then
            if step_num == 0 then
                break
            end
            for j = 1, step_num do
                local xx = movearray[i].x[j]
                local yy = movearray[i].y[j]
                local v = GetWarMap(xx, yy, 2)
                if v ~= -1 then
                    if v == WAR.CurID then
                        break
                    else
                        if WAR.Person[v]["我方"] == wofang then
                            point = point + i * 2 - 26
                        elseif WAR.Person[v]["我方"] ~= wofang then
                            if flag ~= nil then
                                point = point + i - 17
                            else
                                point = point + 26 - i
                            end
                        end
                    end
                end
            end
        end
    end
    return point
end

function MY_CalMoveStep(x, y, stepmax, flag)
    CleanWarMap(3, 255)
    local steparray = {}
    for i = 0, stepmax do
        steparray[i] = {}
        steparray[i].bushu = {}
        steparray[i].x = {}
        steparray[i].y = {}
    end
    SetWarMap(x, y, 3, 0)
    steparray[0].num = 1
    steparray[0].bushu[1] = stepmax
    steparray[0].x[1] = x
    steparray[0].y[1] = y
    War_FindNextStep(steparray, 0, flag)
    return steparray
end

--计算可攻击的敌人数量
function GetAtkNum(x, y, movfw, atkfw, atk)
    local point = {}
    local num = 0
    local kind, len = movfw[1], movfw[2]

    if kind == 0 then
        local array = MY_CalMoveStep(x, y, len, 1)
        for i = 0, len do
            local step_num = array[i].num
            if step_num ~= nil then
                if step_num == 0 then
                    break
                end
                for j = 1, step_num do
                    num = num + 1
                    point[num] = {array[i].x[j], array[i].y[j]}
                end
            end
        end
    elseif kind == 1 then
        local array = MY_CalMoveStep(x, y, len * 2, 1)
        for r = 1, len * 2 do
            for i = 0, r do
                local j = r - i
                if len < i or len < j then
                    SetWarMap(x + i, y + j, 3, 255)
                    SetWarMap(x + i, y - j, 3, 255)
                    SetWarMap(x - i, y + j, 3, 255)
                    SetWarMap(x - i, y - j, 3, 255)
                end
            end
        end
        for i = 0, len do
            local step_num = array[i].num
            if step_num ~= nil then
                if step_num == 0 then
                    break
                end
                for j = 1, step_num do
                    if GetWarMap(array[i].x[j], array[i].y[j], 3) < 128 then
                        num = num + 1
                        point[num] = {array[i].x[j], array[i].y[j]}
                    end
                end
            end
        end
    elseif kind == 2 then
        if not len then
            len = 1
        end
        for i = 1, len do
            if x + i < CC.WarWidth - 1 and GetWarMap(x + i, y, 1) > 0 and CC.WarWater[GetWarMap(x + i, y, 0)] == nil then
                break
            end
            num = num + 1
            point[num] = {x + i, y}
        end
        for i = 1, len do
            if x - i > 0 and GetWarMap(x - i, y, 1) > 0 and CC.WarWater[GetWarMap(x - i, y, 0)] == nil then
                break
            end
            num = num + 1
            point[num] = {x - i, y}
        end
        for i = 1, len do
            if y + i < CC.WarHeight - 1 and GetWarMap(x, y + i, 1) > 0 and CC.WarWater[GetWarMap(x, y + i, 0)] == nil then
                break
            end
            num = num + 1
            point[num] = {x, y + i}
        end
        for i = 1, len do
            if y - i > 0 and GetWarMap(x, y - i, 1) > 0 and CC.WarWater[GetWarMap(x, y - i, 0)] == nil then
                break
            end
            num = num + 1
            point[num] = {x, y - i}
        end
    elseif kind == 3 then
        if x + 1 < CC.WarWidth - 1 and GetWarMap(x + 1, y, 1) == 0 and CC.WarWater[GetWarMap(x + 1, y, 0)] == nil then
            num = num + 1
            point[num] = {x + 1, y}
        end
        if x - 1 > 0 and GetWarMap(x - 1, y, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y, 0)] == nil then
            num = num + 1
            point[num] = {x - 1, y}
        end
        if y + 1 < CC.WarHeight - 1 and GetWarMap(x, y + 1, 1) == 0 and CC.WarWater[GetWarMap(x, y + 1, 0)] == nil then
            num = num + 1
            point[num] = {x, y + 1}
        end
        if y - 1 > 0 and GetWarMap(x, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x, y - 1, 0)] == nil then
            num = num + 1
            point[num] = {x, y - 1}
        end
        if x + 1 < CC.WarWidth - 1 and y + 1 < CC.WarHeight - 1 and GetWarMap(x + 1, y + 1, 1) == 0 and
            CC.WarWater[GetWarMap(x + 1, y + 1, 0)] == nil then
            num = num + 1
            point[num] = {x + 1, y + 1}
        end
        if x - 1 > 0 and y + 1 < CC.WarHeight - 1 and GetWarMap(x - 1, y + 1, 1) == 0 and
            CC.WarWater[GetWarMap(x - 1, y + 1, 0)] == nil then
            num = num + 1
            point[num] = {x - 1, y + 1}
        end
        if x + 1 < CC.WarWidth - 1 and y - 1 > 0 and GetWarMap(x + 1, y - 1, 1) == 0 and
            CC.WarWater[GetWarMap(x + 1, y - 1, 0)] == nil then
            num = num + 1
            point[num] = {x + 1, y - 1}
        end
        if x - 1 > 0 and y - 1 > 0 and GetWarMap(x - 1, y - 1, 1) == 0 and CC.WarWater[GetWarMap(x - 1, y - 1, 0)] ==
            nil then
            num = num + 1
            point[num] = {x - 1, y - 1}
        end
    end
    local maxx, maxy, maxnum, atknum = 0, 0, 0, 0

    for i = 1, num do
        atknum = GetWarMap(point[i][1], point[i][2], 4)

        if atknum == -1 or atkfw[1] > 9 then
            atknum = WarDrawAtt(point[i][1], point[i][2], atkfw, 2, x, y, atk)
            SetWarMap(point[i][1], point[i][2], 4, atknum)
        end
        if atknum ~= nil and maxnum < atknum then
            maxnum, maxx, maxy = atknum, point[i][1], point[i][2]
        end
    end

    return maxnum, maxx, maxy
end

function War_FindNextStep1(steparray, step, id, idb) -- 设置下一步可移动的坐标
    -- 被上面的函数调用   
    local num = 0;
    local step1 = step + 1;

    steparray[step1] = {};
    steparray[step1].bushu = {};
    steparray[step1].x = {};
    steparray[step1].y = {};

    local function fujinnum(tx, ty)
        local tnum = 0
        local wofang = WAR.Person[id]["我方"]
        local tv;
        tv = GetWarMap(tx + 1, ty, 2);
        if idb == nil then
            if tv ~= -1 then
                if WAR.Person[tv]["我方"] ~= wofang then
                    return -1
                end
            end
        elseif tv == idb then
            return -1
        end
        if tv ~= -1 then
            if WAR.Person[tv]["我方"] ~= wofang then
                tnum = tnum + 1
            end
        end
        tv = GetWarMap(tx - 1, ty, 2);
        if idb == nil then
            if tv ~= -1 then
                if WAR.Person[tv]["我方"] ~= wofang then
                    return -1
                end
            end
        elseif tv == idb then
            return -1
        end
        if tv ~= -1 then
            if WAR.Person[tv]["我方"] ~= wofang then
                tnum = tnum + 1
            end
        end
        tv = GetWarMap(tx, ty + 1, 2);
        if idb == nil then
            if tv ~= -1 then
                if WAR.Person[tv]["我方"] ~= wofang then
                    return -1
                end
            end
        elseif tv == idb then
            return -1
        end
        if tv ~= -1 then
            if WAR.Person[tv]["我方"] ~= wofang then
                tnum = tnum + 1
            end
        end
        tv = GetWarMap(tx, ty - 1, 2);
        if idb == nil then
            if tv ~= -1 then
                if WAR.Person[tv]["我方"] ~= wofang then
                    return -1
                end
            end
        elseif tv == idb then
            return -1
        end
        if tv ~= -1 then
            if WAR.Person[tv]["我方"] ~= wofang then
                tnum = tnum + 1
            end
        end
        return tnum
    end

    for i = 1, steparray[step].num do
        -- if steparray[step].bushu[i]<128 then
        steparray[step].bushu[i] = steparray[step].bushu[i] + 1;
        local x = steparray[step].x[i];
        local y = steparray[step].y[i];
        if x + 1 < CC.WarWidth - 1 then -- 当前步数的相邻格
            local v = GetWarMap(x + 1, y, 3);
            if v == 255 and War_CanMoveXY(x + 1, y, 0) == true then
                num = num + 1;
                steparray[step1].x[num] = x + 1;
                steparray[step1].y[num] = y;
                SetWarMap(x + 1, y, 3, step1);
                local mnum = fujinnum(x + 1, y);
                if mnum == -1 then
                    return steparray[step].bushu[i], x + 1, y
                else
                    steparray[step1].bushu[num] = steparray[step].bushu[i] + mnum;
                end
            end
        end

        if x - 1 > 0 then -- 当前步数的相邻格
            local v = GetWarMap(x - 1, y, 3);
            if v == 255 and War_CanMoveXY(x - 1, y, 0) == true then
                num = num + 1;
                steparray[step1].x[num] = x - 1;
                steparray[step1].y[num] = y;
                SetWarMap(x - 1, y, 3, step1);
                local mnum = fujinnum(x - 1, y);
                if mnum == -1 then
                    return steparray[step].bushu[i], x - 1, y
                else
                    steparray[step1].bushu[num] = steparray[step].bushu[i] + mnum;
                end
            end
        end

        if y + 1 < CC.WarHeight - 1 then -- 当前步数的相邻格
            local v = GetWarMap(x, y + 1, 3);
            if v == 255 and War_CanMoveXY(x, y + 1, 0) == true then
                num = num + 1;
                steparray[step1].x[num] = x;
                steparray[step1].y[num] = y + 1;
                SetWarMap(x, y + 1, 3, step1);
                local mnum = fujinnum(x, y + 1);
                if mnum == -1 then
                    return steparray[step].bushu[i], x, y + 1
                else
                    steparray[step1].bushu[num] = steparray[step].bushu[i] + mnum;
                end
            end
        end

        if y - 1 > 0 then -- 当前步数的相邻格
            local v = GetWarMap(x, y - 1, 3);
            if v == 255 and War_CanMoveXY(x, y - 1, 0) == true then
                num = num + 1;
                steparray[step1].x[num] = x;
                steparray[step1].y[num] = y - 1;
                SetWarMap(x, y - 1, 3, step1);
                local mnum = fujinnum(x, y - 1);
                if mnum == -1 then
                    return steparray[step].bushu[i], x, y - 1
                else
                    steparray[step1].bushu[num] = steparray[step].bushu[i] + mnum;
                end
            end
        end
        -- end
    end
    if num == 0 then
        return -1
    end
    steparray[step1].num = num;
    for i = 1, num - 1 do
        for j = i + 1, num do
            if steparray[step1].bushu[i] > steparray[step1].bushu[j] then
                steparray[step1].bushu[i], steparray[step1].bushu[j] = steparray[step1].bushu[j],
                    steparray[step1].bushu[i]
                steparray[step1].x[i], steparray[step1].x[j] = steparray[step1].x[j], steparray[step1].x[i]
                steparray[step1].y[i], steparray[step1].y[j] = steparray[step1].y[j], steparray[step1].y[i]
            end
        end
    end

    return War_FindNextStep1(steparray, step1, id, idb)
end
-- 修炼物品
function War_PersonTrainDrug(pid)
    local p = JY.Person[pid]
    local thingid = p["修炼物品"]
    if thingid < 0 then
        return
    end
    if JY.Thing[thingid]["练出物品需经验"] <= 0 then
        return
    end

    local needpoint = (7 - math.modf(p["资质"] / 15)) * JY.Thing[thingid]["练出物品需经验"]
    if p["物品修炼点数"] < needpoint then
        return
    end

    local haveMaterial = 0
    local MaterialNum = -1
    for i = 1, CC.MyThingNum do
        if JY.Base["物品" .. i] == JY.Thing[thingid]["需材料"] then
            haveMaterial = 1
            MaterialNum = JY.Base["物品数量" .. i]
        end
    end

    -- 材料足够
    if haveMaterial == 1 then
        local enough = {}
        local canMake = 0
        for i = 1, 5 do
            if JY.Thing[thingid]["练出物品" .. i] >= 0 and JY.Thing[thingid]["需要物品数量" .. i] <=
                MaterialNum then
                canMake = 1
                enough[i] = 1
            else
                enough[i] = 0
            end
        end
        -- 可以练出
        if canMake == 1 then
            local makeID = nil
            while true do
                makeID = Rnd(5) + 1
                if thingid == 221 and pid == 88 and enough[4] == 1 then
                    makeID = 4
                end
                if thingid == 220 and pid == 89 and enough[4] == 1 then
                    makeID = 4
                end
                if enough[makeID] == 1 then
                    break
                end
            end

            local newThingID = JY.Thing[thingid]["练出物品" .. makeID]
            DrawStrBoxWaitKey(string.format("%s 制造出 %s", p["姓名"], JY.Thing[newThingID]["名称"]), C_WHITE,
                CC.DefaultFont)
            if instruct_18(newThingID) == true then
                instruct_32(newThingID, 1)
            else
                instruct_32(newThingID, 1)
            end
            instruct_32(JY.Thing[thingid]["需材料"], -JY.Thing[thingid]["需要物品数量" .. makeID])
            p["物品修炼点数"] = 0
        end
    end
end
-- 计算敌人中毒点数
-- pid 使毒人，
-- enemyid  中毒人
function War_PoisonHurt(pid, enemyid)
    -- 万毒
    local eid = WAR.Person[enemyid]["人物编号"]

    local yongdu = JY.Person[pid]["用毒能力"] + FJYONGD(pid)
    local vv = math.modf((yongdu - JY.Person[eid]["抗毒能力"]) / 4)

    -- 胡青牛在场王难姑用毒+50
    if JY.Status == GAME_WMAP then
        for i, v in pairs(CC.AddPoi) do
            if match_ID(pid, v[1]) then
                for wid = 0, WAR.PersonNum - 1 do
                    if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
                        vv = vv + v[3] / 4
                    end
                end
            end
        end
    end
    vv = vv - JY.Person[eid]["内力"] / 200

    vv = math.modf(vv)
    if vv < 0 then
        vv = 0
    end
    if myzd(enemyid) then
        vv = 0
    end
    local s = WAR.CurID
    WAR.CurID = enemyid
    if WAR.Person[WAR.CurID]["我方"] == false then
        -- WarDrawMap(0); --不加这条则动画位置无法正常显示
        -- CurIDTXDH(WAR.CurID, 64,1,"中毒",LightGreen);
    end
    WAR.CurID = s
    return AddPersonAttrib(eid, "中毒程度", vv)
end

-- 人物按轻功进行排序
function WarPersonSort(flag)
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]["人物编号"]
        local add = 0
        local p = JY.Person[id]

        WAR.Person[i]["轻功"] = Qg(i)
    end
    if flag ~= nil then
        return
    end
    for i = 0, WAR.PersonNum - 2 do
        local maxid = i
        for j = i, WAR.PersonNum - 1 do
            if WAR.Person[maxid]["轻功"] < WAR.Person[j]["轻功"] then
                maxid = j;
            end
        end
        WAR.Person[maxid], WAR.Person[i] = WAR.Person[i], WAR.Person[maxid]
    end
end

-- 显示非攻击时的点数
function War_Show_Count(id, str)
    if JY.Restart == 1 then
        return
    end

    local pid = WAR.Person[id]["人物编号"];
    local x = WAR.Person[id]["坐标X"];
    local y = WAR.Person[id]["坐标Y"];

    local hp = WAR.Person[id]["生命点数"];
    local mp = WAR.Person[id]["内力点数"];
    local tl = WAR.Person[id]["体力点数"];
    local ed = WAR.Person[id]["中毒点数"];
    local dd = WAR.Person[id]["解毒点数"];
    local ns = WAR.Person[id]["内伤点数"];

    local show = {x, y, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil}; -- x, y, 生命, 内力, 体力, 封穴, 流血, 中毒, 解毒, 内伤，冰封，灼烧

    if hp ~= nil and hp ~= 0 then -- 显示生命
        if hp > 0 then
            show[3] = "生命+" .. hp;
        else
            show[3] = "生命" .. hp;
        end
    end

    if mp ~= nil and mp ~= 0 then -- 显示内力
        if mp > 0 then
            show[5] = "内力+" .. mp;
        else
            show[5] = "内力" .. mp;
        end
    end

    if tl ~= nil and tl ~= 0 then -- 显示体力
        if tl > 0 then
            show[6] = "体力+" .. tl;
        else
            show[6] = "体力" .. tl;
        end
    end

    if WAR.FXXS[WAR.Person[id]["人物编号"]] ~= nil and WAR.FXXS[WAR.Person[id]["人物编号"]] == 1 then -- 显示是否封穴
        if WAR.FXDS[WAR.Person[id]["人物编号"]] ~= nil and WAR.FXDS[WAR.Person[id]["人物编号"]] > 0 then
            show[7] = "封穴 " .. WAR.FXDS[WAR.Person[id]["人物编号"]];
        end
        WAR.FXXS[WAR.Person[id]["人物编号"]] = 0
    end

    if WAR.LXXS[WAR.Person[id]["人物编号"]] ~= nil and WAR.LXXS[WAR.Person[id]["人物编号"]] == 1 then -- 显示是否被流血
        if WAR.LXZT[WAR.Person[id]["人物编号"]] ~= nil and WAR.LXZT[WAR.Person[id]["人物编号"]] > 0 then
            show[8] = "流血 " .. WAR.LXZT[WAR.Person[id]["人物编号"]];
        end
        WAR.LXXS[WAR.Person[id]["人物编号"]] = 0
    end

    if ed ~= nil and ed ~= 0 then -- 显示中毒
        show[9] = "中毒+" .. ed;
    end

    if dd ~= nil and dd ~= 0 then -- 显示解毒
        show[4] = "中毒-" .. dd;
    end

    if ns ~= nil and ns ~= 0 then -- 显示内伤
        if ns > 0 then
            show[10] = "内伤↑" .. ns;
        else
            show[10] = "内伤↓" .. -ns;
        end
    end

    if WAR.BFXS[WAR.Person[id]["人物编号"]] == 1 then -- 显示是否被冰封
        if JY.Person[WAR.Person[id]["人物编号"]]["冰封程度"] > 0 then
            show[11] = "冰封 " .. JY.Person[WAR.Person[id]["人物编号"]]["冰封程度"];
        end
        WAR.BFXS[WAR.Person[id]["人物编号"]] = 0
    end

    if WAR.ZSXS[WAR.Person[id]["人物编号"]] == 1 then -- 显示是否被灼烧
        if JY.Person[WAR.Person[id]["人物编号"]]["灼烧程度"] > 0 then
            show[12] = "灼烧 " .. JY.Person[WAR.Person[id]["人物编号"]]["灼烧程度"];
        end
        WAR.ZSXS[WAR.Person[id]["人物编号"]] = 0
    end

    -- 记录哪个位置上有点数
    local showValue = {};
    local showNum = 0;
    for i = 3, 12 do
        if show[i] ~= nil then
            showNum = showNum + 1;
            showValue[showNum] = i;
        end
    end

    if showNum == 0 then
        return;
    end

    local hb = GetS(JY.SubScene, x, y, 4);

    local ll = string.len(show[showValue[1]]); -- 长度

    local w = ll * CC.DefaultFont / 2 + 1
    local clip = {
        x1 = CC.ScreenW / 2 - w / 2 - CC.XScale / 2,
        y1 = CC.YScale + CC.ScreenH / 2 - hb,
        x2 = CC.XScale + CC.ScreenW / 2 + w,
        y2 = CC.YScale + CC.ScreenH / 2 + CC.DefaultFont + 1
    }
    local area = (clip.x2 - clip.x1) * (clip.y2 - clip.y1) + CC.DefaultFont * 4 -- 绘画的范围
    -- local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)		--绘画句柄

    for i = 5, 18 do
        if JY.Restart == 1 then
            break
        end
        local tstart = lib.GetTime()
        local y_off = i * 2

        -- lib.SetClip(0, 0, CC.ScreenW, CC.ScreenH)
        -- lib.LoadSur(surid, 0, 0)
        -- 显示文字
        Cat('实时特效动画')
        Cls()
        Cat('实时特效动画2')
        if str ~= nil then
            DrawString(clip.x1 - #str * CC.Fontsmall / 5 + 30, clip.y1 - y_off - CC.DefaultFont * 4, str, C_WHITE,CC.Fontsmall);
        end
        for j = 1, showNum do
            local c = showValue[j] - 1;
            if showValue[j] == 3 and (string.sub(show[3], 1, 1) == "-" or string.sub(show[3], 2, 2) == "-") then -- 减少生命，显示为红色
                c = 1;
            end
            DrawString(clip.x1, clip.y1 - y_off - (showNum - j + 1) * CC.DefaultFont, show[showValue[j]],WAR.L_EffectColor[c], CC.DefaultFont);
        end
        ShowScreen()
        lib.Delay(CC.BattleDelay)
    end

    -- lib.SetClip(0, 0, 0, 0)		--清除
    WAR.Person[id]["生命点数"] = nil;
    WAR.Person[id]["内力点数"] = nil;
    WAR.Person[id]["体力点数"] = nil;
    WAR.Person[id]["中毒点数"] = nil;
    WAR.Person[id]["解毒点数"] = nil;
    WAR.Person[id]["内伤点数"] = nil;
    Cls()
    -- lib.FreeSur(surid)
end

-- 计算医疗量
-- id1 医疗id2, 返回id2生命增加点数
function ExecDoctor(id1, id2)
    if JY.Person[id1]["体力"] < 50 then
        return 0
    end
    local add = JY.Person[id1]["医疗能力"] + FJYIL(id1)
    if WAR.PD['内伤状态'][id1] == nil then
        WAR.PD['内伤状态'][id1] = 0
    end
    local value = WAR.PD['内伤状态'][id1]
    if add + 20 < value then
        return 0
    end

    -- 平一指，医疗量和杀人数有关
    if (match_ID(id1, 28) or match_ID(id1, 9889)) and JY.Status == GAME_WMAP then
        add = math.modf(JY.Person[id1]["医疗能力"] * (1 + WAR.PYZ / 10))
    end

    add = add - (add) * value / 200
    add = math.modf(add) + Rnd(5)

    -- local n = AddPersonAttrib(id2, "受伤程度", -math.modf((add) / 10))  1018
    local n = (WAR.PD['内伤状态'][id2] or 0) - math.modf((add) / 10)

    -- 蓝烟清：医疗时显示内伤减少
    if JY.Status == GAME_WMAP then
        local p = -1;
        for wid = 0, WAR.PersonNum - 1 do
            if WAR.Person[wid]["人物编号"] == id2 and WAR.Person[wid]["死亡"] == false then
                p = wid;
                break
            end
        end
        WAR.Person[p]["内伤点数"] = n;
    end
    return AddPersonAttrib(id2, "生命", add)
end

-- 无酒不欢：计算武功伤害，WAR.CurID为攻击方
function War_WugongHurtLife(enemyid, wugong, level, ang, x, y)

end

-- 绘制战斗地图
-- flag=0  绘制基本战斗地图
--     =1  显示可移动的路径，(v1,v2)当前移动坐标，白色背景(雪地战斗)
--     =2  显示可移动的路径，(v1,v2)当前移动坐标，黑色背景
--     =3  命中的人物用白色轮廓显示
--     =4  战斗动作动画  v1 战斗人物pic, v2贴图所属的加载文件id
--                       v3 武功效果pic  -1表示没有武功效果
function WarDrawMap(flag, v1, v2, v3, v4, v5, ex, ey, px, py)
    local x = WAR.Person[WAR.CurID]["坐标X"]
    local y = WAR.Person[WAR.CurID]["坐标Y"]
    if not v4 then
        v4 = JY.SubScene
    end
    if not v5 then
        v5 = -1;
    end

    px = px or 0

    py = py or 0

    if flag == 0 then
        lib.DrawWarMap(0, x, y, 0, 0, -1, v4)
    elseif flag == 1 then
        -- 胡斐居，雪山，有间客栈，凌霄城，北京城，华山绝顶
        if v4 == 0 or v4 == 2 or v4 == 3 or v4 == 39 or v4 == 107 or v4 == 111 then
            lib.DrawWarMap(1, x, y, v1, v2, -1, v4)
        else
            lib.DrawWarMap(2, x, y, v1, v2, -1, v4)
        end
    elseif flag == 2 then
        lib.DrawWarMap(3, x, y, 0, 0, -1, v4)
    elseif flag == 4 then
        lib.DrawWarMap(4, x, y, v1, v2, v3, v4, v5, ex, ey)
        -- 单人动画
    elseif flag == 6 then
        lib.DrawWarMap(6, x, y, v1, v2, v3, v4, v5, ex, ey, px, py)

        -- 防御动画
    elseif flag == 7 then
        lib.DrawWarMap(7, x, y, 0, 0, v3, v4, v5, ex, ey, px, py)
    end

    if WAR.ShowHead == 1 then
        WarShowHead()
    end

    if JY.HPDisplay == 1 then
        if WAR.ShowHP == 1 then
            HP_Display_When_Idle() -- 常态显血
        end
    end
end

-- 敌方战斗数据
function WarSelectEnemy()
    -- 敌方数据特别调整
    if PNLBD[WAR.ZDDH] ~= nil then
        PNLBD[WAR.ZDDH]()
    end

    if WAR.ZDDH == 354 then
        local x = 20
        local y = 46
        for i = 1, #CC.HSLJ2 do
            local id = CC.HSLJ2[i]
            WAR.Person[WAR.PersonNum]["人物编号"] = id
            WAR.Person[WAR.PersonNum]["我方"] = false
            WAR.Person[WAR.PersonNum]["坐标X"] = x
            WAR.Person[WAR.PersonNum]["坐标Y"] = y
            WAR.Person[WAR.PersonNum]["死亡"] = false
            WAR.Person[WAR.PersonNum]["人方向"] = 0
            WAR.PersonNum = WAR.PersonNum + 1
            x = x + 1
            if x == 34 then
                x = 20
                y = y - 2
            end
        end
    else
        local dmenu1 = {}
        local dmenu2 = {}
        local dmenu3 = {}
        local dmenu4 = {}
        local dmenu5 = {}

        for i = 0, WAR.PersonNum - 1 do
            if inteam(i) == false then
                if JY.Person[i]['畅想分阶'] == 5 then
                    dmenu5[#dmenu5 + 1] = i
                end
                if JY.Person[i]['畅想分阶'] == 4 then
                    dmenu4[#dmenu4 + 1] = i
                end
                if JY.Person[i]['畅想分阶'] == 3 then
                    dmenu3[#dmenu3 + 1] = i
                end
                if JY.Person[i]['畅想分阶'] == 2 then
                    dmenu2[#dmenu2 + 1] = i
                end
                if JY.Person[i]['畅想分阶'] == 1 then
                    dmenu1[#dmenu1 + 1] = i
                end
            end
        end
        for i = 1, 20 do
            if WAR.Data["敌人" .. i] > 0 then
                if WAR.ZDDH == 362 then
                    -- 敌方参加人员
                    local df = {}
                    local df1 = {}
                    local id = WAR.Data["敌人" .. i]
                    local pd = 0
                    local cs = {2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20}
                    for j = 1, #cs do
                        if (JY.Base["天关"] + 8) / 5 == cs[j] then
                            pd = 1
                            -- break
                        else
                            pd = 2
                            -- break
                        end
                    end
                    -- 总人数
                    local rs = 756
                    local czrw1 = {}
                    local czboss = {}
                    for i = 1, rs do
                        if inteam(i) == false and JY.Person[i]["畅想分阶"] < 6 and JY.Person[i]["畅想分阶"] > 2 then
                            czrw1[#czrw1 + 1] = i
                        elseif inteam(i) == false and JY.Person[i]["畅想分阶"] <= 2 then
                            czboss[#czboss + 1] = i
                        end
                    end
                    local m = Rnd(20)
                    RandFetch(df1, m, #czrw1)
                    local m1 = Rnd(10)
                    RandFetch(df, m, #czboss)
                    if pd == 2 then
                        for j = 1, #df1 do
                            WAR.Data["敌人" .. j] = df1[j]
                            local id = WAR.Data["敌人" .. j]
                            local wg1 = {}
                            local wg = {}
                            local WugongNum = 245
                            for x = 1, WugongNum - 1 do
                                for y = 1, JY.Base["武功数量"] do
                                    local wg = Rnd(WugongNum - 1)
                                    if JY.Person[id]["武功" .. y] < 1 and
                                        JY.Wugong[JY.Person[id]["武功" .. y]]["武功类型"] < 8 then
                                        JY.Person[id]["武功" .. y] = wg
                                        JY.Person[id]["武功等级" .. y] = 999
                                    end
                                end
                            end
                            JY.Person[id]["生命最大值"] = 4000 + (JY.Base["天关"] + JY.Base["周目"]) * 30
                            JY.Person[id]["生命"] = JY.Person[id]["生命最大值"]
                            JY.Person[id]["内力最大值"] = 6000 + (JY.Base["天关"] + JY.Base["周目"]) * 30
                            JY.Person[id]["内力"] = JY.Person[id]["内力最大值"]
                            JY.Person[id]["攻击力"] = 420 + (JY.Base["天关"] + JY.Base["周目"]) * 10
                            JY.Person[id]["防御力"] = 420 + (JY.Base["天关"] + JY.Base["周目"]) * 10
                            JY.Person[id]["轻功"] = 420 + (JY.Base["天关"] + JY.Base["周目"]) * 10
                            JY.Person[id]["拳掌功夫"] = 420 + JY.Base["天关"] *(JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["指法技巧"] = 420 + JY.Base["天关"] * (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["御剑能力"] = 420 + JY.Base["天关"] *(JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["耍刀技巧"] = 420 + JY.Base["天关"] *(JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["特殊兵器"] = 420 + JY.Base["天关"] * (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["武学常识"] = 420 + JY.Base["天关"] * (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["实战"] = 500
                            JY.Person[id]["武学常识"] = 300 + JY.Base["天关"]
                        end
                    elseif pd == 1 then
                        for j = 1, #df do
                            WAR.Data["敌人" .. j] = df[j]
                            local id = WAR.Data["敌人" .. j]
                            local wg1 = {}
                            local wg = {}
                            local WugongNum = 381
                            for x = 1, WugongNum - 1 do
                                for y = 1, JY.Base["武功数量"] do
                                    local wg = Rnd(WugongNum - 1)
                                    if JY.Person[id]["武功" .. y] < 1 and JY.Wugong[wg]["武功类型"] < 8 then
                                        JY.Person[id]["武功" .. y] = wg
                                        JY.Person[id]["武功等级" .. y] = 999
                                    end
                                end
                            end
                            JY.Person[id]["生命最大值"] = 4000 + (JY.Base["天关"] + JY.Base["周目"]) * 30
                            JY.Person[id]["生命"] = JY.Person[id]["生命最大值"]
                            JY.Person[id]["内力最大值"] = 6000 + (JY.Base["天关"] + JY.Base["周目"]) * 30
                            JY.Person[id]["内力"] = JY.Person[id]["内力最大值"]
                            JY.Person[id]["攻击力"] = 420 + (JY.Base["天关"] + JY.Base["周目"]) * 10
                            JY.Person[id]["防御力"] = 420 + (JY.Base["天关"] + JY.Base["周目"]) * 10
                            JY.Person[id]["轻功"] = 420 + (JY.Base["天关"] + JY.Base["周目"]) * 10
                            JY.Person[id]["拳掌功夫"] = 420 + JY.Base["天关"] * (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["指法技巧"] = 420 + JY.Base["天关"] *(JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["御剑能力"] = 420 + JY.Base["天关"] *
                                                                (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["耍刀技巧"] = 420 + JY.Base["天关"] *
                                                                (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["特殊兵器"] = 420 + JY.Base["天关"] *
                                                                (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["武学常识"] = 420 + JY.Base["天关"] *
                                                                (JY.Base["天关"] + JY.Base["周目"])
                            JY.Person[id]["实战"] = 500
                            JY.Person[id]["武学常识"] = 300 + JY.Base["天关"]
                        end
                    end
                    local TF = {}
                    local tfnum = Rnd(3)
                    if tfnum < 1 then
                        tfnum = 1
                    end
                    for i = 1, #CC.Tiangtf do
                        RandFetch(TF, tfnum, #CC.Tiangtf)
                        SetTF(id, TF[i], 1)
                        break
                    end
                end
                -- 江陵比武
                if WAR.ZDDH == 125 then
                    local warid = {}
                    local fj = JY.Person[0]['畅想分阶']
                    local dfj = 0
                    if fj >= 4 then
                        dfj = fj - 1
                    else
                        dfj = fj
                    end
                    if dfj < 1 then
                        dfj = 1
                    end
                    for x = 1, 756 do
                        if JY.Person[x]['畅想分阶'] == dfj and JY.Person[x]['姓名'] ~= '备用' and
                            JY.Person[x]['姓名'] ~= '标主占用' and JY.Person[x]['姓名'] ~= '门主占用' then
                            warid[#warid + 1] = x
                            lib.Debug('比武对手' .. x .. '号' .. JY.Person[x]['姓名'])
                        end
                    end
                    local zid = math.random(1, #warid)
                    local pid = warid[zid]
                    lib.Debug('比武对手' .. JY.Person[pid]['姓名'])
                    WAR.Data["敌人" .. 1] = pid
                    CC.biwujl = pid
                end

                -- 冰糖恋：单挑陈达海
                if WAR.ZDDH == 92 and GetS(87, 31, 33, 5) == 1 then
                    for i = 2, 5 do
                        WAR.Data["敌人" .. i] = -1;
                    end
                end
                -- 茅十八
                if WAR.ZDDH == 261 then
                    WAR.Data["敌人4"] = 445
                    WAR.Data["敌人1"] = 442
                end
                -- 桃花岛郭靖
                if WAR.ZDDH == 76 then
                    WAR.Data["敌人1"] = 55
                end
                -- 紫竹林
                if WAR.ZDDH == 342 then
                    WAR.Data["敌人3"] = 445
                    WAR.Data["敌人4"] = 441
                    WAR.Data["敌人5"] = 443
                    WAR.Data["敌人6"] = 446
                end
                -- 紫竹林
                if WAR.ZDDH == 343 then
                    WAR.Data["敌人3"] = 733
                    WAR.Data["敌人4"] = 734
                    WAR.Data["敌人5"] = 735
                    WAR.Data["敌人6"] = 736
                end
                if WAR.ZDDH == 110 then
                    if JY.Person[0]['门派'] == 17 then
                        WAR.Data["敌人1"] = 97
                        WAR.Data["敌人2"] = 595
                        WAR.Data["敌人3"] = 753
                    end
                    if JY.Person[0]['门派'] == 6 then
                        WAR.Data["敌人1"] = 754
                        WAR.Data["敌人2"] = 749
                        WAR.Data["敌人3"] = 635
                    end
                end
                -- 神门十三剑
                if WAR.ZDDH == 267 then
                    for i = 1, 5 do
                        WAR.Data["敌人" .. i] = -1;
                    end
                    WAR.Data["敌人1"] = 699
                    WAR.Data["敌人2"] = 278
                    JY.Person[278]["姓名"] = "陈友谅"
                    JY.Person[278]["生命最大值"] = 500 * JY.Base["难度"]
                    JY.Person[278]["生命"] = 500 * JY.Base["难度"]
                    JY.Person[278]["内力最大值"] = 1000 * JY.Base["难度"]
                    JY.Person[278]["内力"] = 1000 * JY.Base["难度"]
                    JY.Person[278]["攻击力"] = JY.Person[278]["攻击力"] + 50
                    JY.Person[278]["防御力"] = JY.Person[278]["防御力"] + 50
                    JY.Person[278]["轻功"] = JY.Person[278]["轻功"] + 50
                    JY.Person[278]["武功1"] = 229
                    JY.Person[278]["武功等级1"] = 999
                    JY.Person[278]["武功2"] = 90
                    JY.Person[278]["武功等级2"] = 999
                    JY.Person[278]["主运内功"] = 90
                    JY.Person[699]["武功1"] = 205
                    JY.Person[699]["武功等级1"] = 999
                    JY.Person[699]["武功2"] = 241
                    JY.Person[699]["武功等级2"] = 999
                    JY.Person[699]["主运内功"] = 241
                    JY.Person[699]["攻击力"] = JY.Person[278]["攻击力"] + 50
                    JY.Person[699]["防御力"] = JY.Person[278]["防御力"] + 50
                    JY.Person[699]["轻功"] = JY.Person[278]["轻功"] + 50
                end
                -- 无酒不欢：新论剑敌人
                if WAR.ZDDH == 266 then
                    WAR.Data["敌人1"] = GetS(85, 40, 38, 4)
                end
                if WAR.ZDDH == 1 then
                    WAR.Data["敌人1"] = nil
                    WAR.Data["敌人1"] = 652
                end
                WAR.Person[WAR.PersonNum]["人物编号"] = WAR.Data["敌人" .. i]
                local did = WAR.Person[WAR.PersonNum]["人物编号"]
                local zmp = JY.Person[0]['门派']
                if MP_zw(0) == '掌门' and JY.Person[did]['门派'] == zmp then
                    say('啊，掌门在此，万万不可做了背叛本门的事情！', did, 0)
                    WAR.Person[WAR.PersonNum]["我方"] = true
                else
                    WAR.Person[WAR.PersonNum]["我方"] = false
                end
                WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["敌方X" .. i]
                WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["敌方Y" .. i]
                WAR.Person[WAR.PersonNum]["死亡"] = false
                WAR.Person[WAR.PersonNum]["人方向"] = 1
                if WAR.ZDDH == 226 then
                    JY.Person[591]["武功1"] = 1
                    JY.Person[591]["武功等级1"] = 999
                    JY.Person[591]["生命最大值"] = 9999
                    JY.Person[591]["生命"] = 9999
                    -- JY.Person[591]["防御力"] = 620
                end
                -- 无酒不欢：调整战斗初始面向
                -- 战海大富
                if WAR.ZDDH == 259 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 2
                end
                -- 双挑公孙止
                if WAR.ZDDH == 273 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 杨过单金轮
                if WAR.ZDDH == 275 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 战杨龙
                if WAR.ZDDH == 75 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 蒙哥
                if WAR.ZDDH == 278 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 芷若夺掌门
                if WAR.ZDDH == 279 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 单挑赵敏
                if WAR.ZDDH == 293 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 玄冥二老
                if WAR.ZDDH == 295 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                -- 三挑岳不群
                if WAR.ZDDH == 298 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 2
                end
                -- 侠客邪
                if WAR.ZDDH == 170 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 3
                end
                WAR.PersonNum = WAR.PersonNum + 1
            end

        end
    end

    local dddh = WAR.ZDDH
    local cx1 = 0
    local cx2 = 0
    local cx3 = 0
    local cx4 = 0
    local cx5 = 0
    local cx6 = 0

    for j = 1, 20 do
        local did = WAR.Data['敌人' .. j]
        if did >= 0 then
            if JY.Person[did]['畅想分阶'] == 1 then
                cx1 = cx1 + 1
            end
            if JY.Person[did]['畅想分阶'] == 2 then
                cx2 = cx2 + 1
            end
            if JY.Person[did]['畅想分阶'] == 3 then
                cx3 = cx3 + 1
            end
            if JY.Person[did]['畅想分阶'] == 4 then
                cx4 = cx4 + 1
            end
            if JY.Person[did]['畅想分阶'] == 5 then
                cx5 = cx5 + 1
            end
            if JY.Person[did]['畅想分阶'] == 6 then
                cx6 = cx6 + 1
            end
            --lib.Debug(JY.Person[did]['姓名']..'集气=='..Person_JQ(did))
        end
    end
    lib.Debug('神话敌人：' .. cx1 .. ' 宗师敌人 ' .. cx2 .. ' 豪侠敌人 ' .. cx3 .. ' 一流敌人 ' .. cx4 ..' 二流敌人 ' .. cx5 .. ' 三流敌人 ' .. cx6)
    WAR.Data['经验'] = cx1 * 2000 + cx2 * 1500 + cx3 * 1000 + cx4 * 500 + cx5 * 300 + cx6 * 100
    if dddh == 226 then
        WAR.Data['经验'] = 0
    end
    lib.Debug('战斗' .. dddh .. '经验是：' .. WAR.Data['经验'])
end

-- 计算战斗人物贴图
function WarCalPersonPic(id)
    local pid = WAR.Person[id]['人物编号']
    local t = 0
    local n = 0
    for i = 1, 5 do
        if JY.Person[pid]['出招动画帧数' .. i] > 0 then
            t = JY.Person[pid]['出招动画帧数' .. i]
            break
        end
    end

    n = n + WAR.Person[id]["人方向"] * t * 2
    return n
end

-- 计算标准主角特殊行走贴图
function WarCalPersonPic2(id, gender)
    local n = 5058
    if gender == 1 then
        n = 5010
    end
    n = n + WAR.Person[id]["人方向"] * 12
    return n
end

-- 战斗是否结束
function War_isEnd()
    for i = 0, WAR.PersonNum - 1 do
        if JY.Person[WAR.Person[i]["人物编号"]]["生命"] <= 0 then
            WAR.Person[i]["死亡"] = true
        end
    end
    Cat('实时特效动画')
    WarSetPerson()
    Cls()
    Cat('实时特效动画2')
    ShowScreen()
    lib.Delay(CC.BattleDelay)
    local myNum = 0
    local EmenyNum = 0
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["死亡"] == false then
            if WAR.Person[i]["我方"] == true then
                myNum = 1
            else
                EmenyNum = 1
            end
        end
    end

    if EmenyNum == 0 then
        return 1;
    end
    if myNum == 0 then
        return 2;
    end
    return 0
end

-- 无酒不欢：战斗是否结束2
function War_isEnd2()
    local myNum = 0
    local EmenyNum = 0
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["死亡"] == false then
            if JY.Person[WAR.Person[i]["人物编号"]]['生命'] > 0 then
                if WAR.Person[i]["我方"] == true then
                    myNum = 1
                else
                    EmenyNum = 1
                end
            elseif JY.Person[WAR.Person[i]["人物编号"]]['生命'] <= 0 then
                fuhuo(i)
            end
        end
    end

    if EmenyNum == 0 then
        return 1;
    end
    if myNum == 0 then
        return 2;
    end
    return 0
end

function WarSet()
    WAR.WGWL = 0 -- 记录武功10级的攻击力
    WAR.ZYHB = 0 -- 左右互搏，1：发动左右的回合，2：左右的额外回合
    WAR.ZYHBP = -1 -- 记录发动左右的人的编号
    WAR.ZHB = 0 -- 周伯通的追加左右判定
    WAR.AQBS = 0 -- 暗器倍数
    WAR.BJ = 0 -- 暴击
    WAR.XK = 0 -- 西狂之怒啸
    WAR.GXZ = 0
    WAR.XK2 = nil
    WAR.DXZL = 0 -- 东邪之怒
    WAR.DXZL2 = nil
    WAR.SKXYXS = 0 --
    WAR.TD = -1 -- 偷盗
    WAR.TDnum = 0 -- 偷盗数量
    WAR.HTSS = 0 -- 医生大招
    WAR.ZSF = 0 -- 张三丰万法自然
    WAR.QLBLX = 0 -- 李白千里不留行
    WAR.XZZ = 0 -- 虚竹福泽加护
    WAR.KFKJ = 0 -- 封不平狂风快剑
    WAR.HTS = 0 -- 何铁手五毒随机2-5倍威力
    WAR.ZWX = 0
    WAR.JYZJ_FXJ = 0 --	飞絮劲
    WAR.DZTG_DZS = 0 --	大宗师
    WAR.CQSX_WZSX = 0
    WAR.FS = 0 -- 四帮主之战，乔峰用铁掌
    WAR.ZBT = 1 -- 周伯通，每行动一次，攻击时伤害一+10%
    WAR.HTG = 1 -- 花铁杆每行动一次，集气+1
    WAR.QXJH = 0 -- 七星聚会	
    WAR.ZWQJZ = 0 -- 真武七截阵
    WAR.HQT = 0 -- 霍青桐 杀体力
    WAR.CY = 0 -- 程英 杀内力
    WAR.HDWZ = 0 -- 霍都随机上毒
    WAR.ZJZ = 0 -- 朱九真，随机得到食材
    WAR.YJ = 0 -- 阎基偷钱
    WAR.DJGZ = 0 -- 刀剑归真
    WAR.NSFEWSS = 0 -- 你是风儿我是沙
    WAR.DFMQ = 0 -- 大伏魔拳	
    WAR.WS = 0 -- 误伤
    WAR.ACT = 1 -- 连击回数
    WAR.WDKTJ = 0 --	
    WAR.HZGX = 0 -- 标记修改
    WAR.LYSH = 0 -- 两仪守护
    WAR.AJFHNP1 = 0 --
    WAR.SJHB = 0 -- 双剑合壁
    WAR.SJHB_G = 0 -- 双剑合壁.攻
    WAR.SJHB_S = 0 -- 双剑合壁.守		
    WAR.DZXY = 0 -- 斗转星移
    WAR.LXZQ = 0 -- 拳主大招
    WAR.LXYZ = 0 -- 指主大招
    WAR.JSYX = 0 -- 剑神大招
    WAR.QLJG = 0 -- 青莲剑歌大招
    WAR.DJD = 0
    WAR.SL23 = 0
    WAR.ASKD = 0 -- 刀主大招
    WAR.LXBR = 0 -- 龙象大招
    WAR.LXZL10 = 0 -- 龙象之力暴怒，忽视绝对气防	
    WAR.XC_WLCZ = 0 --
    WAR.YZG = 0
    WAR.XC_JJNP = 0 --	
    WAR.YZHYZ = 0 -- 刀主大招增加怒气计数
    WAR.GCTJ = 0 -- 奇门大招
    WAR.JSTG = 0 -- 天罡大招
    WAR.YTML = 0 -- 毒王大招
    WAR.SLSS = 0 -- 梁萧 星罗散手	
    WAR.NGXS = 0 -- 内功攻击的系数
    WAR.TJXS = 0
    WAR.TXZZ = 0 -- 太玄之重
    WAR.MMGJ = 0 -- 盲目攻击
    WAR.CMGJ = 0 -- 刺目攻击
    WAR.TFBW = 0 -- 听风辨位的文字记录
    WAR.JSAY = 0 -- 金蛇奥义
    WAR.QMJ = 0 -- 青蟒剑
    WAR.JYSZ = 0 -- 九阴神爪
    WAR.OYFXL = 0 -- 欧阳锋根据蛤蟆蓄力增加伤害
    WAR.LXXL = 0 -- 梁萧蓄力增加伤害
    WAR.XHMGXX = 0 -- 血海魔功吸血
    WAR.XWTXX = 0 -- 向问天吸血
    WAR.XDLeech = 0 -- 血刀吸血量
    WAR.RMXX = 0 -- 入魔吸血
    WAR.ZSXX = 0 -- 招式吸血 
    WAR.WYXLeech = 0 -- 韦一笑吸血量
    WAR.YLXX = 0 -- 殷离吸血量	标记修改
    WAR.QZWDS = 0 -- 千蛛万毒手吸血量	
    WAR.TMGLeech = 0 -- 天魔功吸血量
    WAR.BHLeech = 0 -- 碧海吸血量
    WAR.BMSGXL = 0 -- 北冥吸内	
    WAR.XHSJ = 0 -- 血河神鉴吸血量
    WAR.YYHY = 0 -- 以眼还眼
    WAR.XDQX1 = 0 -- 血刀
    WAR.WDRX = 0 -- 宋远桥使用太极拳或太极剑攻击后自动进入防御状态
    WAR.SLGFH = 0 -- 空性使用龙爪手
    WAR.KMZWD = 0 -- 周伯通空明之武道
    WAR.ARJY = 0 -- 黯然极意
    WAR.ARJY1 = 0 -- 黯然极意	
    WAR.wugongjz = 0 -- 武功绝招
    WAR.YLTW = 0 -- 云罗天网	
    WAR.LFHX = 0 -- 林朝英流风回雪
    WAR.LWSWD = 0 --	
    WAR.YQFSQ = 0 -- 一气化三清	
    WAR.QXWXJ = 0 -- 七弦无形剑 莫大	
    WAR.YYBJ = 0 -- 郭靖：有余不尽
    WAR.SEYB = 0
    WAR.MHSN = 0 --	
    WAR.KZJYBF = 0 --
    WAR.BJYPYZ = 0 --	
    WAR.BJYJF = 0 --		
    WAR.YNXJ = 0 -- 玉女心经：夭矫空碧
    WAR.HXZYJ = 0 -- 会心之一击
    WAR.QQSH1 = 0 -- 琴棋书画之持瑶琴
    WAR.QQSH2 = 0 -- 琴棋书画之妙笔丹青
    WAR.QQSH3 = 0 -- 琴棋书画之倚天屠龙功
    WAR.YZQS = 0 -- 一震七伤
    WAR.BJGJ = 0 -- 白驹过隙
    WAR.HYYQ = 0
    WAR.TYJQ = 0 -- 阿青天元剑气
    WAR.WWWJ = 0
    WAR.LDJT = 0 -- 雷动九天
    WAR.CXLZ = 0
    WAR.QBLL = 0 --
    WAR.SZXM = 0 --
    WAR.BLCC = 0
    WAR.XMJDHS = 0
    WAR.XMHSQ = 0
    WAR.JTYJ1 = 0 --
    WAR.HZD_1 = 0 -- 陆渐海之道，上善若水，
    WAR.HZD_2 = 0 -- 陆渐海之道，海纳百川		
    WAR.OYK = 0 -- 欧阳克灵蛇拳
    WAR.JYJS = 0 -- 九阴极盛
    WAR.DSWS = 0 -- 大蛇无双
    WAR.YTZ = 0 -- 游坦之
    WAR.HZJHS = 1 -- 虎爪绝户手
    WAR.DN = 0 -- 鹤笔翁
    WAR.JXG_SJG = 0 -- 鲸息功 神鲸歌
    WAR.JQBYH = 0 -- 六脉：剑气碧烟横
    WAR.CMDF = 0 -- 沧溟刀法
    WAR.NZQK = 0 -- 逆转乾坤
    WAR.BXCF = 0 -- 袁承志碧血长风
    WAR.XMCX = 0 -- 西门吹雪
    WAR.LJXD = 0 -- 立即行动
    WAR.LJXD1 = 0 -- 立即行动1		
    WAR.SBSYR = 0 -- 李白十步杀一人
    WAR.FLHS1 = 0 -- 其疾如风
    WAR.FLHS2 = 0 -- 其徐如林
    WAR.FLHS3 = 0 -- 其徐如林
    WAR.FLHS5 = 0 -- 其徐如林
    WAR.FLHS4 = 0 -- 不动如山
    WAR.FLHS6 = 0
    WAR.TDLP = 0 -- 天打雷劈	
    WAR.FLHS5 = 0 -- 难知如阴
    WAR.FLHS6 = 0 -- 动如雷霆
    -- WAR.ZYZD = 0		--中庸之道
    -- WAR.PD["三十二身像"] = 0		--三十二身相
    WAR.SSESS1 = 0 -- 三十二身相.诸天相
    WAR.SSESS4 = 0 -- 三十二身相.白毫相
    WAR.SSESS5 = 0 -- 三十二身相.神鱼相
    WAR.SSESS6 = 0 -- 三十二身相.马王相
    WAR.NGJL = 0 -- 当前加力内功编号
    WAR.NGHT = 0 -- 当前护体内功编号
    WAR.CQSX = 0 -- 除却四相
    WAR.ZWWW = 0 -- 坐忘勿我
    WAR.BMXH = 0 -- 三大吸功
    WAR.HDJY = 0 -- 胡刀极意   	
    WAR.BTJS = 0 -- 补天劫手
    WAR.ZYYD = 0 -- 记录左右的圣火移动步数
    WAR.LMSJwav = 0 -- 六脉神剑的音效
    WAR.XLwav = 0
    WAR.JNTM = 0 -- 鸡你太美
    WAR.JGZ_DMZ = 0 -- 达摩掌
    WAR.LHQ_BNZ = 0 -- 般若掌
    WAR.WD_CLSZ = 0 -- 赤练神掌
    WAR.LHFSD = 0 -- 连环腐尸毒
    WAR.QZ_QXJF = 0 -- 七星剑法
    WAR.BXXHSJ = 0 --	
    WAR.ShowHead = 0 -- 显示右下角头像信息
    WAR.Effect = 0 -- 本次攻击的效果，2：伤害，3：杀内，4：医疗，5：上毒，6：解毒
    WAR.Delay = 0
    WAR.LifeNum = 0
    WAR.TZ_MRF = 0 -- 慕容复指令
    WAR.KHBX = 0 -- 葵花刺目
    WAR.BFX = 0 -- 必封穴
    WAR.BLX = 0 -- 必流血
    WAR.BBF = 0 -- 必冰封
    WAR.BZS = 0 -- 必灼烧
    WAR.GSWS = 0 -- 盖世无双
    -- WAR.PD["三十二身像"] = 0 		--陆渐三十二身相
    -- WAR.PD["金刚法相"] = 0 		--陆渐金刚法相	
    WAR.TWLJ = 0 -- 天外连击
    WAR.DJJJ_LJ = 0
    WAR.SYLJ = 0 -- 陆渐三十二身相 神鱼相连击
    WAR.JYLJ = 0 -- 九阴连击	
    WAR.hit_DGQB = 0 -- 无酒不欢：独孤求败反击的特效显示
    WAR.XTTX = 0 -- 先天调息
    -- WAR.PD["万佛朝宗"][pid] = 0			--万佛朝宗	
    WAR.JHZT = 0
    WAR.MZSH = 0 -- 阿紫曼珠沙华，每杀一个人+200气攻气防
    WAR.XZSC = 0

    WAR.SZSD = -1 -- 被死战锁定的目标
    WAR.BJGX = 0
    WAR.JJZC = 0 -- 九剑真传的4种主动攻击特效
    WAR.JJDJ = 0 -- 九剑荡剑式
    WAR.Dodge = 0 -- 判定是否闪避

    WAR.CXLC = 0 -- 狄云赤心连城
    WAR.YTLJ = 0 -- 倚天连击	
    WAR.CXLC_Count = 0 -- 狄云赤心连城计数
    WAR.WLLJ_Count = 0
    WAR.FQY = 0 -- 风清扬无招胜有招
    WAR.GHQH = 0 -- 黄衫女 广寒清辉
    WAR.LXXZD = 0 -- 梁萧 谐之道	
    WAR.LPZ = 0 -- 林平之
    WAR.JMZL = 0
    WAR.L_TLD = 0; -- 装备屠龙刀特效，1流血
    WAR.PJTX = 0 -- 玄铁剑配玄铁剑法，破尽天下
    WAR.YLSJJ = 0
    WAR.NZZ1 = 0
    WAR.BXZS = 0 -- 辟邪招式
    WAR.JYZS = 0 -- 九阳招式
    WAR.KHSZ = 0 -- 葵花神针
    WAR.ZWYJF = 0 -- 有剑诀的五岳剑法，无视绝对气防
    WAR.KHLH = 0 -- 葵花 六合
    WAR.TXZS = 0 -- 太玄招式
    WAR.LMZS = 0
    WAR.WGZS = 0
    WAR.AJFHNP = 0 -- 阿九	
    WAR.JuHuo = 0 -- 举火燎原
    WAR.LiRen = 0 -- 利刃寒锋
    WAR.LWX = 0 -- 李文秀的破气防特效
    WAR.PDJN = 0 -- 陈家洛庖丁解牛
    WAR.KF = 0
    WAR.ATNum = 1
    WAR.RULAISZ = 0
    WAR.RULAISZ_1 = 0
end

-- 设置战斗全局变量
function WarSetGlobal()
    WAR = {}
    WAR.Data = {}
    WAR.Person = {}
    WAR.MCRS = 0 -- 无酒不欢：每场战斗选的人数
    for i = 0, 100 do
        WAR.Person[i] = {}
        WAR.Person[i]["人物编号"] = -1
        WAR.Person[i]["我方"] = true
        WAR.Person[i]["坐标X"] = -1
        WAR.Person[i]["坐标Y"] = -1
        WAR.Person[i]["死亡"] = true
        WAR.Person[i]["闪避"] = false;
        WAR.Person[i]["格挡"] = false;
        WAR.Person[i]["人方向"] = -1
        WAR.Person[i]["贴图"] = -1
        WAR.Person[i]["贴图类型"] = 0
        WAR.Person[i]["轻功"] = 0
        WAR.Person[i]["移动步数"] = 0
        WAR.Person[i]["经验"] = 0
        WAR.Person[i]["自动选择对手"] = -1
        WAR.Person[i].Move = {}
        WAR.Person[i].Action = {}
        WAR.Person[i].Time = 0
        WAR.Person[i].TimeAdd = 0
        WAR.Person[i].SpdAdd = 0
        WAR.Person[i].Point = 0
        WAR.Person[i]["特效动画"] = -1
        WAR.Person[i]["反击武功"] = -1
        WAR.Person[i]["特效文字0"] = nil
        WAR.Person[i]["特效文字1"] = nil
        WAR.Person[i]["特效文字2"] = nil
        WAR.Person[i]["特效文字3"] = nil
        WAR.Person[i]["特效文字4"] = nil -- 无酒不欢：加到这里 8-11
        WAR.Person[i]["先手反击"] = -1
        WAR.Person[i]["反击"] = -1
        WAR.Person[i]["护盾"] = -1
        WAR.Person[i]["护盾贴图"] = -1
        WAR.Person[i]["护盾延迟"] = nil
        WAR.Person[i]["神游太虚"] = nil
    end

    WAR.PersonNum = 0
    WAR.AutoFight = 0
    WAR.CurID = -1
    WAR.MissPd = 0
    WAR.ZSSS = 0 -- 张三
    WAR.LSFE = 0 -- 李四
    WAR.SXTJ = 0 -- 时序
    WAR.SSX_Counter = 0 -- 三时序计数器
    WAR.WSX_Counter = 0 -- 五时序计数器
    WAR.LSX_Counter = 0 -- 六时序计数器
    WAR.JSX_Counter = 0 -- 九时序计数器
    WAR.BDQS = 0 -- 王重阳北斗真打状态层数
    WAR.XYS = 4 -- 萧远山杀破狼
    WAR.QCF = 0 -- 戚长发复活
    WAR.WQTS_TY = 0 -- 忘情天书 师教	
    WAR.XMH = 0 -- 薛慕华 复活一个人
    WAR.ZSHY = {} -- 转瞬红颜计数器
    WAR.LMSS = {} -- 老谋深算计数器
    WAR.QWHW = {} -- 情为何物计数器
    WAR.HSSY = {} -- 含沙射影计数器
    WAR.WCY = {} -- 一灯复活
    WAR.CYZX = {} -- 王重阳复活
    WAR.ZHRM = {} -- 萧远山走火入魔	
    WAR.ZH001 = 0 -- 召唤计数（召唤模版）

    -- 出手判定
    WAR.ATK = {
        ['人物'] = nil,
        ['人物table'] = {},
        ['人物pd'] = {},
        ['中断'] = false
    }

    -- 常驻函数
    WarSet()
    WAR.PYZ = 0 -- 平一指杀人	
    WAR.ZDDH = -1 -- 战斗代号
    WAR.NO1 = -1 -- 旧版论剑第一名	
    WAR.TJAY = 0 -- 太极奥义
    WAR.DZXYLV = {}
    -- 战场人物是否存在某个天赋，用于改善循环
    WAR.TF = {}
    -- 战场人物是否存在某个天赋，用于改善循环
    WAR.TF1 = {}
    -- 战场人物是否存在某个武功，用于改善循环
    WAR.WG = {}
    -- Boss判定
    WAR.Boss = {}
    -- 记录特效文字
    WAR.TXWZ = {
        ['特效文字0'] = {},
        ['特效文字1'] = {},
        ['特效文字2'] = {},
        ['特效文字3'] = {},
        ['特效文字4'] = {},
        ['特效文字5'] = {}
    }
    -- 判定数据，统一书写
    WAR.PD = {
        ['太玄反震'] = {},
        ['混沌太玄'] = {},
        ['至刚反伤'] = {},
        ['至刚至阳'] = {},
        ['逆转乾坤'] = {},
        ['血魔吸血'] = {},
        ['剑心通明'] = {},
        ['玄冰界冻结'] = {},
        ['意气素霓生'] = {},
        ['君王'] = {},
        ['师教'] = {},
        ['气血相生'] = {},
        ['醉意'] = {},
        ['六道轮回'] = {},
        ['百劫'] = {},
        ['菩提树'] = {},
        ['高手'] = {},
        ['格挡点数'] = {},
        ['无妄'] = {},
		['天机秘术'] = {},
        ['化内力'] = {},
        ['吸怒气'] = {},
        ['吸体力'] = {},
        ['蓄气值'] = {},
        ['破绽'] = {},
        ['流血'] = {},
        ['冰封'] = {},
        ['冻结'] = {},
        ['灼烧'] = {},
        ['点燃'] = {},
        ['内伤状态'] = {},
        ['中毒'] = {},
        ['封穴'] = {},
        ['乾'] = {}, -- 八卦・乾特效
        ['坤'] = {}, -- 八卦・坤特效
        ['震'] = {}, -- 八卦・震特效
        ['巽'] = {}, -- 八卦・巽特效
        ['坎'] = {}, -- 八卦・坎特效
        ['离'] = {}, -- 八卦・离特效
        ['艮'] = {}, -- 八卦・艮特效
        ['兑'] = {}, -- 八卦・兑特效
        ['刀剑绝技'] = {}, -- 刀剑绝技
        ['你是风儿我是沙1'] = {}, -- 你是风儿我是沙
        ['你是风儿我是沙2'] = {}, -- 你是风儿我是沙
        ['临'] = {}, -- 八卦・兑特效
        ['兵'] = {}, -- 八卦・兑特效
        ['斗'] = {}, -- 八卦・兑特效
        ['者'] = {}, -- 八卦・兑特效
        ['列'] = {}, -- 八卦・兑特效
        ['阵'] = {}, -- 八卦・兑特效
        ['皆'] = {}, -- 八卦・兑特效
        ['在'] = {}, -- 八卦・兑特效
        ['前'] = {}, -- 八卦・兑特效
        ['神游太虚'] = {},
        ['蛇行狸翻'] = {},
        ['氤氲紫气'] = {},
        ['如来神掌'] = {},
        ['金刚般若'] = {},
        ['疾如风'] = {},
        ['侵如火'] = {},
        ['守如山'] = {},
        ['徐如林'] = {},
        ['绣花针'] = {},
        ['灵犀一指'] = {},
        ['无量禅震'] = {},
        ['诸法无我'] = {},
        ['偷天换日'] = {},
        ['梅长苏'] = {},
        ['先天护盾CD'] = {},
        ['先天护盾'] = {},
        ['金刚护盾'] = {},
        ['神足护盾'] = {}, -- 标记修改
        ['护盾值'] = {},
        ['坐忘无我'] = {},
        ['菩提金身'] = {},
        ['蛤蟆蓄力'] = {},
        ['鲸息蓄力'] = {},
        ['复活状态'] = {},
        ['走火状态'] = {},
        ['先天罡气'] = {},
        ['独孤求败'] = {},
        ['野球拳'] = {},
        ['西瓜刀'] = {},
        ['西瓜刀・残刀'] = {},
        ['西瓜刀・天人'] = {},
        ['长生诀'] = {},
        ['雪花六出'] = {},
        ['降龙・双龙取水'] = {},
        ['降龙・亢龙有悔'] = {},
        ['降龙・潜龙勿用'] = {},
        ['降龙・震惊百里'] = {},
        ['降龙・飞龙在天'] = {},
        ['降龙・见龙在田'] = {},
        ['降龙・时乘六龙'] = {},
        ['黯然・行尸走肉'] = {},
        ['黯然・饮恨吞声'] = {},
        ['黯然・无中生有'] = {},
        ['黯然・六神不安'] = {},
        ['黯然・倒行逆施'] = {},
        ['黯然・穷途末路'] = {},
        ['招式・再次行动'] = {},
        ['招式・再动概率'] = {},
        ['穿山虎铁臂神拳'] = {},
        ['龙破斩'] = {},
        ['龙爪手'] = {},
        ['必命中'] = {},
        ['火延'] = {},
        ['风流'] = {},
        ['云翳'] = {},
        ['复活・一灯'] = {},
        ['复活・天佛'] = {},
        ['复活・王重阳'] = {},
        ['复活・长生'] = {},
        ['复活・神照'] = {},
        ['复活・师教'] = {},
        ['复活・阿九'] = {},
        ['复活・戚长发'] = {},
        ['回气'] = {},
        ['绊字决'] = {},
        ['封字决'] = {},
        ['转字决'] = {},
        ['缠字决'] = {},
        ['挑字决'] = {},
        ['引字决'] = {},
        ['戳字决'] = {},
        ['曲夕烟隙'] = {},
        ['曲径通幽'] = {},
        ['八酒杯'] = {},
        ['梨花酒'] = {}, --
        ['玉露酒'] = {}, --
        ['五宝花蜜酒'] = {}, --			
        ['即墨老酒'] = {}, --
        ['白云熊胆'] = {}, --
        ['天王护命'] = {}, --
        ['小还丹'] = {}, --
        ['黄连解毒'] = {}, --
        ['牛黄血蝎'] = {}, --
        ['六阳正气'] = {}, --
        ['降临'] = {},
        ['洞火'] = {},
        ['中庸'] = {},
        ['天关阵4'] = {},
        ['立地成佛'] = {},
        ['放下屠刀'] = {},
        ['金刚咒'] = {},
        ['撕裂'] = {},
        ['西域奇毒'] = {},
        ['剧毒'] = {},
        ['禁疗'] = {},
        ['飞云回转刀'] = {},
        ['破剑八刀'] = {},
        ['破剑八刀CD'] = {},
        ['扶摇九天'] = {},
        ['金蛇缠丝手CD'] = {},
        ['无形气墙'] = {},
        ['奇门五转'] = {},
        ['吸星真气'] = {},
        ['独孤剑势'] = {},
        ['独孤破招'] = {},
        ['九阴破体'] = {},
        ['逍遥御风闪避'] = {},
        ['凌波微步闪避'] = {},
        ['神行百变闪避'] = {},
        ['入魔'] = {},
        ['傲寒六诀'] = {},
        ['御气纵横'] = {},
        ['时序出手'] = {},
        ['奇门流血'] = {},
        ['奇门内伤'] = {},
        ['奇门封穴'] = {},
        ['浩然罡气'] = {},
        ['虎啸龙吟'] = {},
        ['受想行识'] = {},
        ['亦复如是'] = {},
        ['毗婆舍那'] = {},
        ['虚弱状态'] = {},
        ['散功状态'] = {},
        ['无名业火'] = {},
        ['魔神降临'] = {},
        ['魔神降临计时'] = {},
        ['杀破狼'] = {},
        ['杀破狼计时'] = {},
        ['无招胜有招'] = {},
        ['紊乱状态'] = {},
        ['一空到底'] = {},
        ['琴音状态'] = {},
        ['冰冻状态'] = {},
        ['迟缓状态'] = {},
        ['混乱状态'] = {},
        ['魅惑状态'] = {},
        ['度化状态'] = {},
        ['破甲状态'] = {},
        ['锁足状态'] = {},
        ['刺猬状态'] = {},
        ['盲目状态'] = {},
        ['同归状态'] = {},
        ['恐惧状态'] = {},
        ['昏迷状态'] = {},
        ['参合状态'] = {},
        ['沉睡状态'] = {},
        ['麻痹状态'] = {},
        ['格挡状态'] = {},
        ['外伤状态1'] = {},
        ['外伤状态2'] = {},
        ['外伤状态3'] = {},
        ['外伤状态4'] = {},
        ['招式减防1'] = {},
        ['招式减防2'] = {},
        ['招式减防3'] = {},
        ['招式减防4'] = {},
        ['招式减攻1'] = {},
        ['招式减攻2'] = {},
        ['招式减攻3'] = {},
        ['招式减攻4'] = {},
        ['招式・集气加速1'] = {},
        ['招式・集气加速2'] = {},
        ['招式・集气加速3'] = {},
        ['招式・集气加速4'] = {},
        ['生死符'] = {},
        ['生死符绝学'] = {},
        ['流云飞袖'] = {},
        ['浮舟'] = {},
        ['扫荡群魔'] = {},
        ['辟邪连击'] = {},
        ['刺目'] = {},
        ['六脉招式'] = {},
        ['降龙招式'] = {},
        ['黯然招式'] = {},
        ['打狗招式'] = {},
        ['火焰招式'] = {},
        ['九剑招式'] = {},
        ['七略连击'] = {},
        ['七略集气'] = {},
        ['天地浑圆'] = {},
        ['天行健.攻'] = {},
        ['天行健.守'] = {},
        ['天行健'] = {},
        ['逆水寒'] = {},
        ['逆水寒1'] = {},
        ['逆水寒CD'] = {},
        ['我无'] = {},
        ['七略坤元'] = {},
        ['镇岳'] = {},
        ['合川'] = {},
        ['鹤啸九天'] = {}, -- 标记修改
        ['以气运剪'] = {}, -- 标记修改
        ['蛇影'] = {},
        ['天罗'] = {},
        ['婆罗双树枯'] = {},
        ['婆罗双树荣'] = {},
        ['金毗罗陀'] = {},
        ['风身'] = {},
        ['轻体'] = {},
        ['以剑御气'] = {},
        ['天剑'] = {},
        ['以眼还眼1'] = {},
        ['以眼还眼2'] = {},
        ['天魔解体'] = {},
        ['斗转伤害'] = {},
        ['斗转武功气攻'] = {},
        ['斗转招式名字'] = {},
        ['斗转招式'] = {},
        ['斗转武功等级'] = {},
        ['格挡'] = {},
        ['格挡反击'] = {},
        ['慧中灵剑'] = {},
        ['血战八方'] = {},
        ['否极泰来'] = {},
        ['复活'] = {},
        ['万佛朝宗'] = {},
        ['太极之形'] = {},
        ['曲风状态'] = {},
        ['十龙十象'] = {},
        ['禁药状态'] = {},
        ['玉石俱焚'] = {},
        ['天仙锁魂'] = {},
        ['雷音状态'] = {},
        ['号令三军'] = {},
        ['养生主'] = {},
        ['倾国倾城'] = {},
        ['三十二身像'] = {},
        ['金刚法相'] = {},
        ['小李飞刀'] = {},
        ['集中状态'] = {},
        ['十八盘'] = {},
        ['身藏身与名'] = {},
        ['长生回天'] = {},
        ['疾风劲'] = {},
        ['霸体'] = {},
        ['逍遥御风'] = {},
        ['唯我不败'] = {},
        ['止杀CD'] = {},
        ['减气'] = {},
        ['判官笔封穴'] = {},
        ['易容'] = {},
        ['走火入魔'] = {},
        ['封'] = {},
        ['无血状态'] = {},
        ['一剑无血'] = {},
        ['奇门DEBUF'] = {},
        ['玄铁令'] = {},
        ['定乾坤'] = {},
        ['剑气护体'] = {},
        ['激昂'] = {},
        ['无忧水镜'] = {},
        ['金刚伏魔'] = {},
        ['三才归元'] = {},
        ['血魔'] = {},
        ['吸血量'] = {},
        ['卸甲状态'] = {},
        ['突防状态'] = {},
        ['打狗要诀'] = {},
        ['血刀门特性'] = {},
        ['密宗特性'] = {},
        ['密宗印记'] = {},
        ['天罗地网'] = {},
        ['神罗CD'] = {},
        ['万象CD'] = {},
        ['神罗天征'] = {},
        ['真武七截阵'] = {}, --65
        ['十八罗汉阵'] = {}, --66
        ['天罡北斗阵'] = {}, --67
        ['九宫八卦阵'] = {}, --68
        ['五行光明阵'] = {}, --69
        ['两仪剑阵'] = {}, -- 70
        ['打狗大阵'] = {},
        ['剑胆琴心'] = {},
        ['招式必中'] = {},
        ['暴击判定'] = {},
        ['万毒蚀体'] = {},
        ['万毒蚀体CD'] = {},
        ['般若禅掌'] = {},
        ['盖世神拳'] = {},
        ['九歌'] = {},
        ['九歌回血'] = {},
        ['玄冰界'] = {},
        ['玄阴煞气'] = {},
        ['光君'] = {},
        ['天人合一'] = {},
        ['浩然正气'] = {},
        ['吃药CD'] = {},
        ['吃药max'] = {},
        ['天子观气'] = {},
        ['时序清流血'] = {},
        ['时序清中毒'] = {},
        ['时序清内伤'] = {},
        ['时序清灼烧'] = {},
        ['时序清冰封'] = {},
        ['柔网势'] = {},
        ['缓步'] = {}

    }

    -- 正面BUF，2表示可以自身使用，1表示即使偷取了BUF自己也没有效果
    WAR.Buf = {{'六阳正气', 2}, {'黄连解毒', 2}, {'牛黄血蝎', 2}, {'小还丹', 2}, {'天王护命', 2},
               {'白云熊胆', 2}, {'雷音状态', 2}, {'倾国倾城', 2}, {'十龙十象', 2}, {'集中状态', 1},
               {'十八盘', 2}, {'玉石俱焚', 2}, {'逍遥御风', 1}, {'即墨老酒', 2}, {'玉露酒', 2},
               {'梨花酒', 2}, {'五宝花蜜酒', 2}, {'诸法无我', 2}, {'皆', 1}, {'前', 1}, {'在', 1},
               {'阵', 1}, {'养生主', 2}, {'太极之形', 1}, {'长生回天', 2}, {'疾风劲', 2}, {'列', 1},
               {'者', 1}, {'斗', 1}, {'兵', 1}, {'临', 1}, {'西瓜刀・天人', 2}, {'西瓜刀・残刀', 2},
               {'血战八方', 2}, {'霸体', 2}, {'金刚法相', 1}, {'三十二身像', 1}, {'身藏身与名', 2},
               {'小李飞刀', 1}, {'曲风状态', 1}, {'蓄气值', 2}, {'疾如风', 2}, {'长生诀', 2},
               {'凌波微步闪避', 2}, {'神行百变闪避', 2}, {'逍遥御风闪避', 2}, {'天剑', 2},
               {'唯我不败', 1}, {'魔神降临', 1}, {'杀破狼', 1} ,-- {'先天护盾',1},护盾无法偷取
    }

    --		
    WAR.Buf2 = {}

    -- 负面BUF，1没有任何作用暂时
    -- 时序DEBUF
    WAR.Debuf = {{'虚弱状态', 1}, {'散功状态', 1}, {'无名业火', 1}, {'放下屠刀', 1}, {"禁疗", 1},
                 {"点燃", 1}, {'冻结', 1}, {'无招胜有招', 1}, {'生死符', 1}, {'紊乱状态', 1},
                 {"撕裂", 1}, {"西域奇毒", 1}, {'走火入魔', 1}, {'封', 1}}
    -- 基础DEBUF --负面BUF，1没有任何作用暂时
    WAR.Debuf1 = {{'流血', 1}, {'中毒', 1}, {'冰封', 1}, {'灼烧', 1}, {'内伤状态'}, {'封穴'}}
    -- 回合DEBUF
    WAR.Debuf2 = {{'琴音状态', 1}, {'冰冻状态', 1}, {'迟缓状态', 1}, {'混乱状态', 1},
                  {'魅惑状态', 1}, {'破甲状态', 1}, {'锁足状态', 1},  {'卸甲状态', 1},{'突防状态', 1},
                  {'恐惧状态', 1}, {'同归状态', 1}, {'昏迷状态', 1}, {'沉睡状态', 1},
                  {'参合状态', 1}, {'麻痹状态', 1}, {"洞火", 1}, {'放下屠刀', 1}, {'金刚咒', 1},
                  {'度化状态', 1}, {'魅惑状态', 1}, {'剧毒', 1}, }
    -- 毒布武林 标记修改
    WAR.Debuf3 = {{'虚弱状态', 1}, {'散功状态', 1}, {"禁疗", 1}, {'紊乱状态', 1}, {"撕裂", 1},
                  {"西域奇毒", 1}, {'冻结', 1}, {'无名业火', 1}}
    WAR.TGCD = {
        [356] = 50
    }
    WAR.CD = 0 -- 天关的CD

    WAR.BLCC_1 = {}

    WAR.TXXS = {} -- 特效点数显示

    WAR.tmp = {} -- 100：基础   200：蛤蟆功蓄力，1000：欧阳锋逆运走火，1500：鲸息功蓄力，2000：太极拳蓄力，3000：神照复活，4000：太虚剑意蓄力，5000：头像编号
    WAR.Actup = {} -- 蓄力记录
    WAR.Defup = {} -- 防御记录
    WAR.Wait = {} -- 等待记录
    -- WAR.PD["集中状态"] = {}		--集中记录
    WAR.HMGXL = {} -- 蛤蟆蓄力增加300集气
    WAR.Weakspot = {} -- 破绽计数
    -- WAR.PD["盲目状态"] = {}		--被刺目的人记录
    WAR.LQZ = {} -- 怒气值
    WAR.DLZ = {}
    WAR.FXDS = {} -- 封穴点数
    WAR.FXXS = {} -- 封穴显示
    WAR.LXZT = {} -- 流血点数
    WAR.LXXS = {} -- 流血显示
    WAR.BFXS = {} -- 冰封显示
    WAR.ZSXS = {} -- 灼烧显示
    WAR.SZJPYX = {} -- 已经提供过实战的人记录（被打死的）
    WAR.wuxuep = {} -- 已经提供过实战的人记录（被打死的）	

    WAR.DXMX = {} -- 大须弥相

    WAR.TZ_DY = 0 -- 段誉指令
    WAR.TZ_XZ = 0 -- 虚竹指令
    WAR.THYG = 0 -- 铁画银钩

    -- WAR.PD["生死符"] = {}	--中了生死符的人记录
    WAR.TXZQ = {} -- 太玄之轻

    WAR.DZZ = {} -- 三十二身相 大自在相
    WAR.FGPZ = {} --		
    WAR.JJJ = {} -- 将进酒
    WAR.JQSDXS = {} -- 无酒不欢：集气速度显示

    WAR.WXFS = nil -- 李秋水无相分身的编号记录
    WAR.JJPZ = {} -- 无酒不欢：九剑破招
    WAR.TKJQ = {} -- 太空卸劲减少集气
    WAR.BHJQ = {} -- 碧海惊涛掌招式4减少集气	

    -- = {}		--太极之形记录
    -- WAR.PD["万佛朝宗"][pid] = 0		--万佛朝宗 标记修改
    -- WAR.PD["天仙锁魂"] = {}		--万佛朝宗	
    -- WAR.PD["曲风状态"] = {}		--曲风记录	

    -- WAR.PD["无招胜有招"] = {}		--被无招胜有招击中的人
    WAR.ZXXS = {} -- 紫霞蓄力
    WAR.GMYS = 0 -- 范遥挨打加减伤
    WAR.GMZS = {} -- 被杨逍打中的人记录

    WAR.JYFX = {} -- 九阳7时序解除封穴

    WAR.QYBY = {} -- 林朝英轻云蔽月，每50时序可触发一次，免疫伤害10时序
    WAR.TMJT = {} -- 天魔金身，每200时序可触发一次，免疫伤害10时序	
    WAR.XZ_YB = {} -- 小昭影步记录
    -- WAR.PD["紊乱状态"] = {}		--被灵蛇拳击中的人记录

    WAR.HP_Bonus_Count = {} -- 记录血量翻倍的编号

    WAR.L_EffectColor = {} -- 异常状态的颜色显示
    WAR.L_EffectColor[1] = M_Silver; -- 显示减少生命
    WAR.L_EffectColor[2] = M_Pink; -- 显示增加生命
    WAR.L_EffectColor[3] = M_LightBlue; -- 显示解毒
    WAR.L_EffectColor[4] = M_DeepSkyBlue; -- 显示内力减少和增加
    WAR.L_EffectColor[5] = M_PaleGreen; -- 显示体力减少和增加
    WAR.L_EffectColor[6] = C_GOLD; -- 显示封穴
    WAR.L_EffectColor[7] = M_Red; -- 显示流血
    WAR.L_EffectColor[8] = M_DarkGreen; -- 显示中毒
    WAR.L_EffectColor[9] = PinkRed; -- 显示内伤减少和增加
    WAR.L_EffectColor[10] = LightSkyBlue; -- 显示冰封
    WAR.L_EffectColor[11] = C_ORANGE; -- 显示灼烧

    WAR.L_WNGZL = {}; -- 王难姑指令，持续中毒减血
    WAR.L_HQNZL = {}; -- 胡青牛指令，持续回血回内伤

    WAR.L_QKDNY = {}; -- 设定攻击多个人时，乾坤只能被反一次

    WAR.L_NOT_MOVE = {}; -- 记录不可移动的人

    WAR.ShowHP = 1 -- 血条显示
    WAR.FF = 0 -- 主角觉醒后，喵姐开局前三次不受伤害
    WAR.ZQHT = 0 -- 是否触发真气护体

    -- = {}			--霸体状态 	
    WAR.WQTS_WW = {} -- 我无	
    WAR.SKZX = {}
    WAR.HQT_CD = 0 -- 霍青桐指令
    WAR.WZ = {}
    WAR.WZ1 = {}
    WAR.PJZT = {} -- 破军状态
    WAR.PJJL = {} -- 被破军前的内功记录
    WAR.SGJL = {} -- 散功前的内功记录	
    WAR.WFZT = {} --	
    WAR.ZYCD = 0
    WAR.WTL_PJTL = {}
    WAR.JSZT2 = {} -- 通用计时状态敌方	

    WAR.BiXieZhaoShi = {} -- 辟邪招式	
    WAR.BXLQ = {} -- 辟邪冷却记录
    WAR.BXCD = {0, 2, 3, 3, 4, 5} -- 辟邪冷却时间
    WAR.BXCD1 = {0, 1, 2, 2, 3, 4} -- 辟邪冷却时间
    WAR.LMCD = {0, 1, 2, 3, 3, 5}
    WAR.LMLQ = {}
    WAR.JYLQ = {} -- 九阳冷却记录	
    WAR.JYCD = {0, 1, 5} -- 九阳九阳冷却时间
    WAR.JIUYANGZhaoShi = {} -- 九阳招式	

    WAR.XYYF_10 = 0 -- 本回合逍遥御风累积至9点

    WAR.YFCS = 0 -- 逍遥御风次数
    WAR.QMWZ = 0 -- 奇门五转

    WAR.ZQTL = {} -- 紫气天罗
    WAR.XDQX = {} -- 血刀

    WAR.Miss = {} -- 闪避的miss显示
    WAR.FHJZ = 0 -- 张家辉的复活戒指
    -- WAR.PD["复活"]={}	
    WAR.YSJZ = 0 -- 张家辉的隐身戒指

    WAR.FW = {}
    WAR.Atid = -1
    CleanWarMap(7, 0)
end

-- 显示人物的战斗信息，包括头像，生命，内力等
function WarShowHead(id)
    if not id then
        id = WAR.CurID
    end
    if id < 0 then
        return
    end
    local bx, by = CC.WX, CC.HY
    local pid = WAR.Person[id]["人物编号"]
    local p = JY.Person[pid]
    local h = CC.FontSMALL
    local width = CC.FontSMALL * 11 - CC.ScreenH / 128
    local height = (CC.FontSMALL + CC.RowPixel) * 9 - CC.ScreenH / 64
    local x1, y1 = 0, 0
    local i = 1
    local size = CC.FontSmall3

    local headw, headh = lib.GetPNGXY(1, p["半身像"])
    local headx = (width - headw) / 2
    local heady = (CC.ScreenH / 5 - headh) / 2
    -- 头像信息
    local headid = JY.Person[pid]["半身像"]
    local wfx, wfy = CC.ScreenW - CC.ScreenW / 6.84, CC.ScreenH - CC.ScreenH / 1.9948
    local dfx, dfy = CC.ScreenW / 50, CC.ScreenH / 25.6
    local x, y = 0, 0
    if WAR.Person[id]["我方"] then
        x = wfx
        y = wfy
    else
        x = dfx
        y = dfy
    end
    lib.LoadPNG(91, 39 * 2, x - size, y - size * 2, 1)
    lib.LoadPNG(1, headid * 2, x, y - size, 1, 0, CC.ScreenH / 6.4)
    lib.LoadPNG(91, 49 * 2, x - size, y - size * 2, 1)

    -- 战斗状态显示

    local color = C_WHITE1
    local name = p["姓名"]
    local namelen = string.len(name) / 2

    -- 姓名
    lib.LoadPNG(91, 38 * 2, x, y + size * 8, 1)
    lib.DrawStr(x + size * 3.5 - string.len(name) * size / 4, y + size * 8, name, C_WHITE, size * 1.8, CONFIG.CurrentPath .. "FONT/2.ttf", 0, 0)

    local wgw = size * 3.8

    -- 气显示
    local nlx, nly = x, y + size * 5.4
    local w1 = CC.ScreenW / 41.212121
    local nlzb = {{nlx, nly}, {nlx + w1, nly}, {nlx + w1 * 2, nly}, {nlx + w1 * 3, nly}, {nlx + w1 * 4, nly}}
    for i = 1, 5 do
        if JY.Person[pid]["能量"] >= i then
            lib.LoadPNG(91, 106 * 2, nlzb[i][1], nlzb[i][2], 1)
        else
            lib.LoadPNG(91, 107 * 2, nlzb[i][1], nlzb[i][2], 1)
        end
    end

    -- 血蓝怒体条
    local lifexs = "命 " .. p["生命"] -- 生命
    local nlxs = "内 " .. p["内力"] -- 内力
    local tlxs = "体 " .. p["体力"] -- 体力
    local Rlxz = WAR.LQZ[pid]
    if Rlxz == nil then
        Rlxz = 0
    end
    local lqzxs = "怒 " .. Rlxz; -- 怒气

    local pcx = x - size;
    local pcy = y + size * 10
    local pcx1 = x - size - CC.RowPixel;

    -- 生命条
    lib.LoadPNG(91, 293 * 2, pcx, pcy, 1, 0, 100)
    local pcw, pch = lib.GetPNGXY(91, 289 * 2);
    lib.SetClip(pcx1, pcy, pcx1 + (p["生命"] / p["生命最大值"]) * (pcw), pcy + pch)
    lib.LoadPNG(91, 289 * 2, pcx, pcy, 1, 0, 100)
    pcy = pcy + CC.RowPixel + size - 2
    lib.SetClip(0, 0, 0, 0)
    DrawString(pcx, pcy - size, lifexs, C_WHITE, size)

    -- 内力条
    local h = size / 2 - by * 10
    lib.LoadPNG(91, 293 * 2, pcx, pcy + h, 1, 0, 100)
    local pcw, pch = lib.GetPNGXY(91, 290 * 2);
    lib.SetClip(pcx1, pcy + h, pcx1 + (p["内力"] / p["内力最大值"]) * (pcw), pcy + pch + h)
    lib.LoadPNG(91, 290 * 2, pcx, pcy + h, 1, 0, 100)
    pcy = pcy + CC.RowPixel + size - 2
    lib.SetClip(0, 0, 0, 0)
    DrawString(pcx, pcy - size + h, nlxs, C_WHITE, size)

    -- 体力条
    local h = h + h
    lib.LoadPNG(91, 293 * 2, pcx, pcy + h, 1, 0, 100)
    local pcw, pch = lib.GetPNGXY(91, 291 * 2);
    lib.SetClip(pcx1, pcy + h, pcx1 + (p["体力"] / 100) * (pcw), pcy + pch + h)
    lib.LoadPNG(91, 291 * 2, pcx, pcy + h, 1, 0, 100)
    pcy = pcy + CC.RowPixel + size - 2
    lib.SetClip(0, 0, 0, 0)
    DrawString(pcx, pcy - size + h, tlxs, C_WHITE, size)

    -- 怒气
    local h = h + h
    lib.LoadPNG(91, 293 * 2, pcx, pcy + h, 1, 0, 100)
    local pcw, pch = lib.GetPNGXY(91, 292 * 2);
    lib.SetClip(pcx1, pcy + h, pcx1 + (Rlxz / 100) * (pcw), pcy + pch + h)
    lib.LoadPNG(91, 292 * 2, pcx, pcy + h, 1, 0, 100)
    pcy = pcy + CC.RowPixel + size - 2
    lib.SetClip(0, 0, 0, 0)
    DrawString(pcx, pcy - size + h, lqzxs, C_WHITE, size)

    local suf = CC.ScreenH / 5.907
    -- 装备武功
    if p["优先使用"] > 0 then
        local zyng = p["优先使用"]
        lib.LoadPNG(98, (500 + zyng) * 2, x - size, y + size * 16 - size / 2, 1, 0, suf)
    else
        lib.LoadPNG(91, 77 * 2, x - size, y + size * 16 - size / 2, 1, 0, suf)
    end
    if p["主运内功"] > 0 then
        local zyng = p["主运内功"]
        lib.LoadPNG(98, (500 + zyng) * 2, x - size + wgw, y + size * 16 - size / 2, 1, 0, suf)
    else
        lib.LoadPNG(91, 76 * 2, x - size + wgw, y + size * 16 - size / 2, 1, 0, suf)
    end
    if p["主运轻功"] > 0 then
        local zyng = p["主运轻功"]
        lib.LoadPNG(98, (500 + zyng) * 2, x - size + wgw * 2, y + size * 16 - size / 2, 1, 0, suf)
    else
        lib.LoadPNG(91, 78 * 2, x - size + wgw * 2, y + size * 16 - size / 2, 1, 0, suf)
    end
    ------敌方携带物品----
    if WAR.Person[id]["我方"] == false then
        if p["携带物品" .. i] >= 0 then
            y1 = dfy + size * 18
            lib.LoadPNG(91, 27 * 2, x1 - CC.ScreenW / 453.333, y1 + CC.ScreenH / 30.72, 1, 0, suf)
            local xdwp = "携带物品"
            lib.DrawStr(x1 + size * 5 - string.len(xdwp) * size / 4, y1 + CC.ScreenH / 25.6, xdwp, C_CYGOLD, size,CONFIG.CurrentPath .. "FONT/0.ttf", 0, 0)
            local hl = 1
            for i = 1, 4 do
                local wp = p["携带物品" .. i]
                local wps = p["携带物品数量" .. i]
                if wp >= 0 then
                    local wpm = JY.Thing[wp]["名称"]
                    DrawString(x - size / 2, y1 + size * 1.4 + hl * (size + CC.RowPixel), wpm .. "  " .. wps, C_WHITE,size)
                    hl = hl + 1
                end
            end
        end
    end

    ----------战斗buf/debuf显示------
    local ztx1, ztx2 = CC.ScreenW / 1.2052, CC.ScreenW / 1.2052
    local zty1 = CC.ScreenH / 1.0593
    local ztmenu = {}
    local ztmenu1 = {}
    local ztmenu2 = {}
    local zt_num = 0
    local zt_num1 = 0
    local d_num = 0
    local w_num = 0
    local cl = C_GOLD
    local ztx = 0
    local zty = 0
    if p["中毒程度"] > 0 then -- 中毒
        WAR.PD["中毒"][pid] = p["中毒程度"]
    end
    if p["冰封程度"] > 0 then -- 冰封
        WAR.PD["冰封"][pid] = p["冰封程度"]
    end
    if p["灼烧程度"] > 0 then
        WAR.PD["灼烧"][pid] = p["灼烧程度"] -- 灼烧
    end
    -- if p["受伤程度"] > 0 then 1018
    -- WAR.PD['内伤状态'][pid] = p["受伤程度"]             --内伤
    -- end    
    if WAR.FXDS[pid] ~= nil and WAR.FXDS[pid] > 0 then -- 封穴
        WAR.PD["封穴"][pid] = WAR.FXDS[pid]
    end
    if WAR.LXZT[pid] ~= nil and WAR.LXZT[pid] > 0 then -- 流血
        WAR.PD["流血"][pid] = WAR.LXZT[pid]
    end
    -- WAR.PD["封穴"][id] = WAR.FXDS[pid] or 0;		--封穴
    -- WAR.PD["流血"][id] = WAR.LXZT[pid] or 0;		--流血1
    -- local pmenu = {{"中毒",zdxs,""},{'内伤状态',nsxs,""},{"冰封",bfxs,""},{"灼烧",zsxs,""},{"封穴",fxxs,""},{"流血",lxxs,""}}
    local h = size * 4 + CC.RowPixel * 2

    local zx, zy = lib.GetPNGXY(91, 66 * 2) + size / 3
    if WAR.Person[id]["我方"] == true then
        ztx = x - size * 7 + zx
        zty = y + size * 15
    else
        ztx = x + size * 13
        zty = y - size
    end
    for i = 1, #CC.ZTSM do
        if CC.ZTSM[i] ~= nil then
            ztmenu[#ztmenu + 1] = CC.ZTSM[i][1]
            ztmenu1[#ztmenu1 + 1] = CC.ZTSM[i][3]
            ztmenu2[#ztmenu2 + 1] = CC.ZTSM[i][6]
        end
    end
    local n, m = 0, 0
    for i = 1, #ztmenu do
        local ztname = ztmenu[i]
        local stn = ''
        if ztmenu2[i] ~= nil then
            stn = string.len(ztmenu2[i]) / 2
        end
        local ztname1, ztname2, ztname3 = '', '', ''

        if stn == 2 then
            ztname1 = string.sub(ztmenu2[i], 1, 2)
            ztname2 = string.sub(ztmenu2[i], 3, 4)
        end
        if stn == 3 then
            ztname1 = string.sub(ztmenu2[i], 1, 2)
            ztname2 = string.sub(ztmenu2[i], 3, 4)
            ztname3 = string.sub(ztmenu2[i], 5, 6)
        end

        if WAR.PD[ztname] ~= nil then
            if WAR.PD[ztname][pid] ~= nil and WAR.PD[ztname][pid] > 0 then
                if ztmenu1[i] == 2 then
                    cl = C_RED
                end
                if ztmenu1[i] == 1 then
                    cl = C_BLACK
                end
                local wz = WAR.PD[ztname][pid] or 0
                local yy = 0
                local xx = 0
                local n, m = 0, 0

                d_num = d_num + 1
                if d_num >= 10 then
                    d_num = 1
                    zt_num1 = zt_num1 + 1
                end
                yy = zty + h * (zt_num1)
                xx = ztx + zx * (d_num - 1)

                lib.LoadPNG(91, 66 * 2, xx, yy, 1)
                local xxx = CC.ScreenH / 375
                local hh = size * 0.9
                if ztname3 == '' then
                    hh = hh * 2
                end
                DrawString(xx + CC.ScreenW / 680 - string.len(ztname1) * size * 1.2 / 4 + size + xxx,
                    yy + CC.ScreenH / 384, ztname1, cl, size * 1.2)
                DrawString(xx + CC.ScreenW / 680 - string.len(ztname2) * size * 1.2 / 4 + size + xxx,
                    yy + CC.ScreenH / 384 + hh, ztname2, cl, size * 1.2)
                DrawString(xx + CC.ScreenW / 680 - string.len(ztname3) * size * 1.2 / 4 + size + xxx,
                    yy + CC.ScreenH / 384 + hh * 2, ztname3, cl, size * 1.2)
                DrawString(xx + CC.ScreenW / 400 + size - string.len(wz) * size * 1.2 / 4, yy + size + CC.ScreenH / 22, wz, cl, size * 1.2)
            end
        end
    end
end

-- 自动选择合适的武功
function War_AutoSelectWugong()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local probability = {}
    local wugongnum = JY.Base["武功数量"]
    for i = 1, JY.Base["武功数量"] do
        local wugongid = JY.Person[pid]["武功" .. i]
        if wugongid > 0 then
            if JY.Wugong[wugongid]["伤害类型"] == 0 then
                -- 选择杀生命的武功，必须消耗内力比现有内力小，起码可以发出一级的武功。
                if JY.Wugong[wugongid]["消耗内力点数"] <= JY.Person[pid]["内力"] then
                    local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
                    probability[i] = get_skill_power(pid, wugongid, level) -- 无酒不欢：采用新公式
                else
                    probability[i] = 0
                end
                -- 轻功不可攻击特技不可攻击
                if JY.Wugong[wugongid]["武功类型"] == 7 or secondary_wugong(wugongid) then
                    probability[i] = 0
                end
                -- 内功攻击
                if JY.Wugong[wugongid]["武功类型"] == 6 then
                    if isteam(pid) == false and i == 1 then -- NPC会用第一格内功

                    elseif pid == 0 and JY.Base["畅想"] > 0 and i == 1 then -- 畅想会用第一格内功

                    elseif wugongid == 105 and (match_ID(pid, 36) or match_ID(pid, 27)) then -- 林平之 东方 使用葵花神功

                    elseif wugongid == 102 and match_ID(pid, 9759) then -- 混沌太玄 使用太玄神功
                    elseif wugongid == 106 and match_ID(pid, 638) then -- 斗酒僧 九阳神功					

                    elseif wugongid == 106 and match_ID(pid, 9) then -- 张无忌 使用九阳神功

                    elseif wugongid == 94 and match_ID(pid, 37) then -- 狄云 使用神经照

                    elseif wugongid == 108 and match_ID(pid, 114) then -- 扫地 使用易筋经

                    elseif wugongid == 93 and match_ID(pid, 66) then -- 小昭 使用圣火

                    elseif wugongid == 104 and match_ID(pid, 60) then -- 欧阳锋 使用逆运

                    elseif wugongid == 103 and (match_ID(pid, 39) or match_ID(pid, 40)) then -- 侠客岛主 使用龙象

                    elseif (pid == 0 and GetS(4, 5, 5, 5) == 5) or match_ID(pid, 9985) then -- 天罡  诸行无常使用内功

                    else
                        probability[i] = 0
                    end
                end

                -- 斗转星移
                if wugongid == 43 and match_ID(pid, 51) == false and match_ID(pid, 679) == false then
                    probability[i] = 0
                end

                -- 乔峰不用打狗
                if wugongid == 80 and pid == 50 then
                    probability[i] = 0
                end

                -- 商剑鸣不用八卦刀
                if wugongid == 231 and pid == 722 then
                    probability[i] = 0
                end
                -- 商夫人不用八卦掌
                if wugongid == 230 and pid == 737 then
                    probability[i] = 0
                end

                -- 黄药师不用玉萧落英
                if (wugongid == 12 or wugongid == 38) and pid == 57 then
                    probability[i] = 0
                end

                -- 周伯通不用太极拳
                if wugongid == 16 and pid == 64 then
                    probability[i] = 0
                end

                -- 二十大欧阳锋不用逆运蛤蟆
                if (wugongid == 95 or wugongid == 104) and pid == 60 and WAR.ZDDH == 289 then
                    probability[i] = 0
                end

                -- 襄阳金轮不用龙象
                -- 神邪战三绝不用龙象
                -- 二十大不用龙象
                if wugongid == 103 and pid == 62 and (WAR.ZDDH == 275 or WAR.ZDDH == 277 or WAR.ZDDH == 289) then
                    probability[i] = 0
                end

                -- 刀剑归真胡一刀不用苗剑
                if wugongid == 44 and pid == 633 and WAR.ZDDH == 280 then
                    probability[i] = 0
                end

                -- 刀剑合璧苗人凤不用胡刀
                if wugongid == 67 and pid == 3 and WAR.ZDDH == 280 then
                    probability[i] = 0
                end
                -- 陈正德
                if wugongid == 4 and pid == 311 and WAR.ZDDH == 314 then
                    probability[i] = 0
                end

                -- 左冷禅不用其他几个五岳剑法
                if pid == 22 and (wugongid == 30 or wugongid == 31 or wugongid == 32 or wugongid == 34) then
                    probability[i] = 0
                end
            else
                probability[i] = 0 -- 自动不会杀内力
            end
        else
            wugongnum = i - 1
            break
        end
    end

    if wugongnum == 0 then -- 如果没有武功，直接返回-1
        return -1;
    end

    local maxoffense = 0 -- 计算最大攻击力
    for i = 1, wugongnum do
        if maxoffense < probability[i] then
            maxoffense = probability[i]
        end
    end

    local mynum = 0 -- 计算我方和敌人个数
    local enemynum = 0
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["死亡"] == false then
            if WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                mynum = mynum + 1
            else
                enemynum = enemynum + 1
            end
        end
    end

    local factor = 0 -- 敌人人数影响因子，敌人多则对线面等攻击多人武功的选择概率增加
    if mynum < enemynum then
        factor = 2
    else
        factor = 1
    end
    if JY.Person[pid]['优先使用'] > 0 then

    else
        for i = 1, wugongnum do -- 考虑其他概率效果
            local wugongid = JY.Person[pid]["武功" .. i]
            if probability[i] > 0 then
                if probability[i] < maxoffense * 3 / 4 then -- 去掉攻击力小的武功
                    probability[i] = 0
                else
                    local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
                    probability[i] = probability[i] + JY.Wugong[wugongid]["移动范围" .. level] * factor * 10
                    if JY.Wugong[wugongid]["杀伤范围" .. level] > 0 then
                        probability[i] = probability[i] + JY.Wugong[wugongid]["杀伤范围" .. level] * factor * 10
                    end
                end
            end
        end
    end

    local s = {} -- 按照概率依次累加
    local maxnum = 0
    for i = 1, wugongnum do
        s[i] = maxnum
        maxnum = maxnum + probability[i]
    end
    s[wugongnum + 1] = maxnum
    if maxnum == 0 then -- 没有可以选择的武功
        return -1
    end

    local v = Rnd(maxnum) -- 产生随机数
    local selectid = 0
    for i = 1, wugongnum do -- 根据产生的随机数，寻找落在哪个武功区间
        if JY.Person[pid]['优先使用'] > 0 then
            if JY.Person[pid]['优先使用'] == JY.Person[pid]['武功' .. i] then
                selectid = i
                lib.Debug(pid .. '选择武功1时：优先使用===============' ..  JY.Wugong[JY.Person[pid]['武功' .. i]]['名称'])
            end
        else
            if s[i] <= v and v < s[i + 1] then
                selectid = i
                lib.Debug(pid .. '选择武功2时：优先使用===============' .. JY.Wugong[JY.Person[pid]['武功' .. i]]['名称'])
            end
        end
    end

    return selectid
end

-- 战斗武功选择菜单
-- sb star为无意义参数，仅为防止代码语法错误跳出
function War_FightMenu(sb, star, wgnum, ...)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local numwugong = 0
    local menu = {}
    local canuse = {}
    local c = 0;
    local ZS = 0
    local zswz = 0
    local tmp = JY.Person[pid]["优先使用"]

    local arg = select(1, ...);
    if CC.KFMove[tmp] ~= nil then
        local zs = CC.KFMove[tmp]
        for i = 1, #zs do
            for j = 1, JY.Base["武功数量"] do
                if JY.Person[pid]["武功" .. j] == JY.Person[pid]["优先使用"] then
                    ZS = CC.WUGONGZS[j][i]
                    if arg > 0 or i < 3 then
                        JY.Person[pid]["武功招式" .. ZS] = 1
                    end
                    zswz = CC.KFMove[tmp][i]
                end
            end
            menu[i] = {CC.KFMove[tmp][i][1], nil, 1}
            -- 内力少不显示
            if JY.Person[pid]["内力"] < JY.Wugong[tmp]["消耗内力点数"] then
                menu[i][3] = 0
            end

            -- 体力低于10不显示
            if JY.Person[pid]["体力"] < 10 then
                menu[i][3] = 0
            end

            numwugong = numwugong + 1

            if menu[i][3] == 1 then
                c = c + 1
                canuse[c] = i
            end
        end
    end
    if c == 0 then
        return 0
    end
    if wgnum == nil then
        local r = nil
        r = Cat('菜单', menu, numwugong, 0, CC.MainMenuX, CC.MainMenuY, 0, 0, 1, 1, CC.DefaultFont, C_ORANGE, C_WHITE)
        if r == 0 then
            return 0
        end
        WAR.ShowHead = 0
        local r2 = War_Fight_Sub(WAR.CurID, r)
        WAR.ShowHead = 1
        Cls()
        return r2
        -- 无酒不欢：数字快捷键直接使用武功
    else
        if wgnum <= c then
            WAR.ShowHead = 0
            local r2 = War_Fight_Sub(WAR.CurID, canuse[wgnum])
            -- say("嗯……我看看，这套武功的精妙之处其实不在于是否自宫。看我如何以剑入道克服这个问题！"..wgnum,0,1)
            WAR.ShowHead = 1
            Cls()
            return r2
        else
            return 0
        end
    end
end

-- 自动战斗时 做思考
-- 吃药的flag：2 生命；3内力；4体力；6 解毒
function War_Think()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local r = -1
    local minNeili = War_GetMinNeiLi(pid)
    local can_eat_drug = 0
    local eat_hp_drug = 0 --吃血药
    local eat_eng_drug = 0 --吃体力药
    local eat_mp_drug = 0 --吃内力药
    local eat_deto_drug = 0 --吃解毒药
    --吃红药  
    for i = 1,4 do 
        if JY.Person[pid]['吃红药方针'] == i and JY.Person[pid]['生命']/JY.Person[pid]['生命最大值'] < (i-1)*0.2+0.1 and (WAR.LQZ[pid] or 0) < 100  then 
            eat_hp_drug = 1
            --lib.Debug('吃红药方针'..i..' 开始吃药')
        end
    end
    --吃蓝药
    for i = 1,4 do 
        if JY.Person[pid]['吃蓝药方针'] == i and JY.Person[pid]['内力']/JY.Person[pid]['内力最大值'] < (i-1)*0.2+0.1 and (WAR.LQZ[pid] or 0) < 100 then 
            eat_mp_drug = 1
        end
    end
    --吃体力药
    for i = 1,4 do 
        if JY.Person[pid]['吃黄药方针'] == i and JY.Person[pid]['体力']/100 < (i-1)*0.2+0.1 and (WAR.LQZ[pid] or 0) < 100 then 
            eat_eng_drug = 1
        end
    end

    -- 非我方，会考虑吃药
    if WAR.Person[WAR.CurID]["我方"] == false then
        can_eat_drug = 1
        -- 如果是我方，只有在队且允许才会吃药
    end
    -- 侠客正岛主战不吃药
    -- 洪七公居洪七公不吃药
    if WAR.Person[WAR.CurID]["我方"] == false and (WAR.ZDDH == 188 or WAR.ZDDH == 257) then
        can_eat_drug = 0
    end
    -- 可以吃药的话
    if can_eat_drug == 1 then
        -- 吃体力药       
        if isteam(pid) then
            local fz = {50, 30, 10}
            if JY.Person[pid]["体力"] < 30 then
                eat_eng_drug = 1
            end
        else
            if JY.Person[pid]["体力"] < 10 then
                eat_eng_drug = 1
            end
        end
        -- 吃血药       
        if isteam(pid) then
            local fz = {0.7, 0.5, 0.3}
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
                eat_hp_drug = 1
            end
        else
            -- 根据生命确定吃血药几率
            local rate = -1
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
                rate = 90
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
                rate = 70
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
                rate = 50
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
                rate = 25
            end

            -- 内伤也增加吃血药几率
            -- if JY.Person[pid]["受伤程度"] > 50 then --1018
            if WAR.PD['内伤状态'][pid] ~= nil and WAR.PD['内伤状态'][pid] > 50 then
                rate = rate + 50
            end

            -- 暴气时，不吃药
            if Rnd(100) < rate and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] ~= 100 then
                eat_hp_drug = 1
            end
        end
        -- 吃内力药       
        if isteam(pid) then
            local fz = {0.7, 0.5, 0.3}
            if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] * 0.5 then
                eat_mp_drug = 1
            end
        else
            -- 考虑内力
            local rate = -1
            if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
                rate = 100
            elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
                rate = 75
            elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
                rate = 50
            end

            if Rnd(100) < rate or minNeili > JY.Person[pid]["内力"] then
                eat_mp_drug = 1
            end
        end
        local jdrate = -1
        if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
            jdrate = 60
        else
            if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
                jdrate = 30
            end
        end

        -- 半血以下吃解毒药
        -- 暴怒不吃解毒药
        if Rnd(100) < jdrate and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and WAR.LQZ[pid] ~= nil and WAR.LQZ[pid] ~= 100 then
            eat_deto_drug = 1
        end
    end
    --吃生命药
    if eat_hp_drug == 1 then
        --lib.Debug('准备吃药')
        r = War_ThinkDrug(2)
        if r >= 0 then -- 如果有药吃药
            --lib.Debug('吃药')
            return r
        else
            r = War_ThinkDoctor() -- 如果没有药，考虑医疗
            if r >= 0 then
                return r
            end
        end
    end
    --吃内力药
    if eat_mp_drug == 1 then
        r = War_ThinkDrug(3)
        if r >= 0 then
            return r
        end
    end

    --吃体力药
    if eat_eng_drug == 1 then
        r = War_ThinkDrug(4)
        if r >= 0 then
            return r
        end
        return 0
    end

    --吃解毒药
    if eat_deto_drug == 1 then 
        r = War_ThinkDrug(6)
        if r >= 0 then
            return r
        end
    end

    if isteam(pid) then
        if JY.Person[pid]["行为模式"] == 4 then
            r = 0
        elseif JY.Person[pid]["行为模式"] == 3 then
            r = 7
        elseif JY.Person[pid]["行为模式"] == 2 then
            r = 8
        elseif JY.Person[pid]["行为模式"] == 1 then
            if minNeili <= JY.Person[pid]["内力"] and JY.Person[pid]["体力"] > 10 then
                r = 1
            else
                r = 0
            end
        end
    else
        if minNeili <= JY.Person[pid]["内力"] and JY.Person[pid]["体力"] > 10 then
            r = 1
        else
            r = 0
        end
    end
    return r
end

-- 自动攻击
function War_AutoFight()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local wugongnum;
    if JY.Person[pid]["优先使用"] > 0 then
        for i = 1, JY.Base["武功数量"] do
            if JY.Person[pid]["武功" .. i] == JY.Person[pid]["优先使用"] then
                wugongnum = i
                -- lib.Debug(JY.Person[pid]["姓名"]..3)
            end
        end
        -- 加一条防止被洗掉等意外
        if wugongnum == nil then
            wugongnum = War_AutoSelectWugong()
        end
    else
        wugongnum = War_AutoSelectWugong()
    end
    -- lib.Debug(pid..'自动攻击：优先使用武功 ========'..JY.Wugong[JY.Person[pid]["武功"..wugongnum]]['名称'])
    if wugongnum <= 0 then
        War_AutoEscape()
        War_RestMenu()
        return
    end
    unnamed(wugongnum)
end

-- 自动战斗
function War_Auto()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    WAR.ShowHead = 1
    Cat('实时特效动画')
    WarDrawMap(0)
    Cat('实时特效动画2')
    ShowScreen()
    lib.Delay(CC.BattleDelay)
    WAR.ShowHead = 0
    if CC.AutoWarShowHead == 1 then
        WAR.ShowHead = 1
    end
    if WAR.PD["混乱状态"][pid] ~= nil then
        Cat('随机移动')
    end
    if WAR.PD['盲目状态'][pid] ~= nil and JLSD(0,50,pid) then 
        War_Focus()
    end

    -- 随机移动
    local tf57 = hastf(WAR.CurID, 57, 2)
    if tf57 ~= nil then
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then
                local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                if offset1 <= 9 and offset2 <= 9 and math.random(100) <= 25 then
                    Cat('随机移动')
                end
            end
        end
    end

    --复活方针
    local fhmenu = {}
    local kfmenu1= {}
    local kfmenu2= {}
    local fhkf = nil 

    local fhpd = false 
    if JY.Person[pid]['复活方针'] == 1 and JY.Person[pid]['生命'] < JY.Person[pid]['生命最大值']*0.1 then 
        fhpd = true 
    elseif JY.Person[pid]['复活方针'] == 2 and JY.Person[pid]['生命'] < JY.Person[pid]['生命最大值']*0.3 then 
        fhpd = true 
    elseif JY.Person[pid]['复活方针'] == 3 and JY.Person[pid]['生命'] < JY.Person[pid]['生命最大值']*0.5 then 
        fhpd = true        
    end
    if fhpd == true then 
        for i = 1,JY.Base['武功数量'] do 
            if JY.Wugong[JY.Person[pid]['武功'..i]]['武功类型'] == 6 then 
                fhmenu[#fhmenu+1] = JY.Person[pid]['武功'..i]
            end
        end
        if fhmenu[1] ~= nil then 
            for i = 1,#fhmenu do 
                for j = 1,10 do 
                    local kftx = JY.Wugong[fhmenu[i]]['特效'..j]
                    if kftx == 1005 then 
                        kfmenu1[#kfmenu1+1] = fhmenu[i]
                        kfmenu2[#kfmenu2+1] = JY.Wugong[fhmenu[i]]['层级']
                    end
                end
            end
        end
        local kfmax,kfid = Table_MaxValKey(kfmenu2)
        local kfng = kfmenu1[kfid]
        JY.Person[pid]['主运内功'] = kfng
    end

    --喝酒方针
    if JY.Person[pid]['喝酒方针'] == 1 and WAR.PD['五宝花蜜酒'][pid] == nil and instruct_18(25) == true then 
        WAR.PD['五宝花蜜酒'][pid] = 50
        instruct_2(25,-1)
        return 1
    elseif JY.Person[pid]['喝酒方针'] == 2 and WAR.PD['即墨老酒'][pid] == nil and instruct_18(24) == true then 
        WAR.PD['即墨老酒'][pid] = 50
        instruct_2(24,-1)
        return 1
    elseif JY.Person[pid]['喝酒方针'] == 3 and WAR.PD['梨花酒'][pid] == nil and instruct_18(22) == true then 
        WAR.PD['梨花酒'][pid] = 50
        instruct_2(22,-1)
        return 1
    elseif JY.Person[pid]['喝酒方针'] == 4 then 
        local tmenu = {{'梨花酒',22},{'玉露酒',23},{'即墨老酒',24},{'五宝花蜜酒',25},}
        local snum = tmenu[math.random(#tmenu)]
        if instruct_18(tmenu[snum][2]) == true and WAR.PD[tmenu[snum][1]][pid] == nil then 
            WAR.PD[tmenu[snum][1]][pid] = 50
            instruct_2(tmenu[snum][2],-1)    
        end 
        return 1
    end


    local autotype = War_Think()
    --攻击方针
    if JY.Person[pid]['行动方针'] == 0 or JY.Person[pid]['行动方针'] == 5 or autotype == 1  then 
        War_AutoFight()
        return 0
    elseif  JY.Person[pid]['行动方针'] == 1 or JY.Person[pid]['行动方针'] == 6 then 
        WAR.Person[WAR.CurID]["移动步数"] = 0
        War_AutoFight()
        return 0
    elseif JY.Person[pid]['行动方针'] == 2 or JY.Person[pid]['行动方针'] == 7 then 
        War_DefupMenu()
        return 0
    elseif JY.Person[pid]['行动方针'] == 3 or JY.Person[pid]['行动方针'] == 8 then 
        War_AutoEscape()
        War_DefupMenu()
        return 0
    elseif JY.Person[pid]['行动方针'] == 4 or JY.Person[pid]['行动方针'] == 9  then 
        War_RestMenu()
        return 0
    end

    -- 一言止杀
    if autotype == 1 and WAR.PD["恐惧状态"][pid] ~= nil then
        WarDrawMap(0); -- 不加这条则动画位置无法正常显示
        CurIDTXDH(WAR.CurID, 55, 1, "恐惧", C_ORANGE)
        autotype = 0
    end
    if match_ID(pid, 610) and WAR.LQZ[pid] ~= 100 then
        autotype = 0
    end

    if WAR.PD["受想行识"][pid] == 1 then
        autotype = 0
    end
    if autotype == 0 then
        War_AutoEscape()
        War_RestMenu() --休息
    elseif autotype == 2 then
        War_AutoEscape()
        War_AutoEatDrug(2)
    elseif autotype == 3 then
        War_AutoEscape()  --逃离
        War_AutoEatDrug(3)
    elseif autotype == 4 then
        War_AutoEscape()
        War_AutoEatDrug(4)
    elseif autotype == 5 then
        War_AutoEscape()
        War_AutoDoctor() --医疗
    elseif autotype == 6 then
        War_AutoEscape()
        War_AutoEatDrug(6) --吃药
    elseif autotype == 7 then
        War_RestMenu()
    elseif autotype == 8 then
        War_DefupMenu()  --防御
    end
    return 0
end

-- 人物升级

function War_AddPersonLVUP(pid)
    local tmplevel = JY.Person[pid]["等级"]
    if CC.Level <= tmplevel then
        return false
    end
    if JY.Person[pid]["经验"] < CC.Exp[tmplevel] then
        return false
    end
    while CC.Exp[tmplevel] <= JY.Person[pid]["经验"] do
        tmplevel = tmplevel + 1
        if CC.Level <= tmplevel then
            break
        end
    end

    tmplevel = 30

    DrawStrBoxWaitKey(string.format("%s 升级了", JY.Person[pid]["姓名"]), C_WHITE, CC.DefaultFont)
    -- 计算提升的等级
    -- local leveladd = tmplevel - JY.Person[pid]["等级"]

    -- JY.Person[pid]["等级"] = 30--JY.Person[pid]["等级"] + leveladd

    -- 提高生命增长
    AddPersonAttrib(pid, "生命最大值", (JY.Person[pid]["体质"]) * leveladd * 4)

    JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
    JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
    -- JY.Person[pid]["受伤程度"] = 0 1018
    WAR.PD['内伤状态'][pid] = 0

    JY.Person[pid]["中毒程度"] = 0

    local theadd = JY.Person[pid]["资质"] / 4
    -- 聪明人内力加少。。。
    -- 增加内力的成长
    AddPersonAttrib(pid, "内力最大值",
        math.modf(leveladd * ((16 - JY.Person[pid]["体质"]) * 7 + 210 / (theadd + 1))))

    -- 天罡内力每级额外加50
    -- if pid == 0 and JY.Base["标准"] == 6 then
    --    AddPersonAttrib(pid, "内力最大值", 50 * leveladd)
    -- end
    JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
    local p_zz = JY.Person[pid]["资质"];
    -- 循环提升等级，累加属性
    for i = 1, leveladd do
        local ups;

        if p_zz < 31 then -- 87*3 261   1/9
            ups = 3
        elseif p_zz >= 31 and p_zz <= 50 then -- 116*3 348  1/12
            ups = 4
        elseif p_zz >= 51 and p_zz <= 79 then -- 147*3 441  1/15
            ups = 5
        elseif p_zz >= 80 and p_zz <= 100 then -- 177*3 522  1/18
            ups = 6
        end

        -- 令狐冲 内伤回复前，每级3点

        if pid == 35 and GetD(82, 1, 0) == 1 then
            ups = 3
        end

        -- 队友郭靖 20级之后，每级6点
        -- if pid == 55 and JY.Person[pid]["等级"] > 20 then
        --	ups = 6
        -- end
        -- local nfqg = 0
        -- if JY.Base['畅想'] == 546 then
        --	nfqg = 3
        -- end		  
        -- AddPersonAttrib(pid, "攻击力", ups)
        -- AddPersonAttrib(pid, "防御力", ups)
        -- AddPersonAttrib(pid, "轻功", ups + nfqg)

        -- 修复医疗、用毒、解毒能力不与等级挂钩的问题
        if JY.Person[pid]["医疗能力"] >= 20 then
            AddPersonAttrib(pid, "医疗能力", 2)
        end
        if JY.Person[pid]["用毒能力"] >= 20 then
            AddPersonAttrib(pid, "用毒能力", 2)
        end
        if JY.Person[pid]["解毒能力"] >= 20 then
            AddPersonAttrib(pid, "解毒能力", 2)
        end

        -- 队友陈家洛 升级加五围
        if pid == 75 then
            if JY.Person[pid]["拳掌功夫"] >= 0 then
                AddPersonAttrib(pid, "拳掌功夫", (6))
            end
            if JY.Person[pid]["指法技巧"] >= 0 then
                AddPersonAttrib(pid, "指法技巧", (8))
            end
            if JY.Person[pid]["御剑能力"] >= 0 then
                AddPersonAttrib(pid, "御剑能力", (8))
            end
            if JY.Person[pid]["耍刀技巧"] >= 0 then
                AddPersonAttrib(pid, "耍刀技巧", (8))
            end
            if JY.Person[pid]["特殊兵器"] >= 0 then
                AddPersonAttrib(pid, "特殊兵器", (8))
            end
        end

        -- 暗器每级提高
        if JY.Person[pid]["暗器技巧"] >= 20 then
            AddPersonAttrib(pid, "暗器技巧", 2)
        end
    end

    local ey = 1; -- 每级的自由点数
    ey = ey + JY.Base["难度"];

    -- local zm = limitX(JY.Base["周目"],1,20)

    local n = ey * leveladd; -- 计算随机额外点数

    if match_ID(pid, 9927) then
        n = n + math.ceil(250 * leveladd / 29)
    else
        n = n + math.ceil(p_zz * 2.5 * leveladd / 29)
    end

    -- 加点
    local gj = JY.Person[pid]["攻击力"];
    local fy = JY.Person[pid]["防御力"];
    local qg = JY.Person[pid]["轻功"];
    local tmpN = n;

    -- 天赋ID
    local tfid;
    -- 主角
    if pid == 0 then
        -- 标主
        if JY.Base["标准"] > 0 then
            tfid = 280 + JY.Base["标准"]
            -- 特殊
        elseif JY.Base["特殊"] > 0 then
            tfid = 289 + JY.Base["特殊"]
            -- 畅想
        else
            tfid = JY.Base["畅想"]
        end
        -- 队友
    else
        tfid = pid
    end
    --
    -- 升级加点界面
    local current = 1
    while true do
        if JY.Restart == 1 then
            break
        end
        Cls();
        -- ShowPersonStatus_sub(pid, 1, 1, tfid, -17, 1)
        DrawString(CC.ScreenW / 4 - CC.Fontsmall * 6 - 2 + 28 - 10, CC.ScreenH / 2 + 100 + 20 - 15,
            string.format("可分配点数：%d 点", tmpN), C_ORANGE, CC.Fontsmall * 0.7);
        for i = 1, 3 do
            local shade_color = C_GOLD
            if i == current then
                shade_color = PinkRed
            end
            DrawString(CC.ScreenW / 4 - CC.Fontsmall * 7 - 30,
                CC.ScreenH / 2 + 100 + 24 + i * (CC.FontSmall4 + CC.PersonStateRowPixel) - 40, "→", shade_color,
                CC.Fontsmall * 0.7);
        end
        ShowScreen()
        local keypress, ktype, mx, my = WaitKey()
        -- lib.Delay(CC.Frame)
        if ktype == 1 then
            if keypress == VK_UP then
                current = current - 1
                if current < 1 then
                    current = 3
                end
            elseif keypress == VK_DOWN then
                current = current + 1
                if current > 3 then
                    current = 1
                end
            elseif keypress == VK_LEFT and tmpN < n then
                if current == 1 and JY.Person[pid]["攻击力"] > gj then
                    JY.Person[pid]["攻击力"] = JY.Person[pid]["攻击力"] - 1
                    tmpN = tmpN + 1
                elseif current == 2 and JY.Person[pid]["防御力"] > fy then
                    JY.Person[pid]["防御力"] = JY.Person[pid]["防御力"] - 1
                    tmpN = tmpN + 1
                elseif current == 3 and JY.Person[pid]["轻功"] > qg then
                    JY.Person[pid]["轻功"] = JY.Person[pid]["轻功"] - 1
                    tmpN = tmpN + 1
                end
            elseif keypress == VK_RIGHT and tmpN > 0 then
                if current == 1 and JY.Person[pid]["攻击力"] < 620 then
                    JY.Person[pid]["攻击力"] = JY.Person[pid]["攻击力"] + 1
                    tmpN = tmpN - 1
                elseif current == 2 and JY.Person[pid]["防御力"] < 620 then
                    JY.Person[pid]["防御力"] = JY.Person[pid]["防御力"] + 1
                    tmpN = tmpN - 1
                elseif current == 3 and JY.Person[pid]["轻功"] < 620 then
                    JY.Person[pid]["轻功"] = JY.Person[pid]["轻功"] + 1
                    tmpN = tmpN - 1
                end
            elseif keypress == VK_SPACE or keypress == VK_RETURN then
                if tmpN == 0 or
                    (JY.Person[pid]["攻击力"] == 620 and JY.Person[pid]["防御力"] == 620 and
                        JY.Person[pid]["轻功"] == 620) then
                    Cls();
                    break
                else
                    DrawStrBoxWaitKey("对不起，" .. JY.Person[pid]["姓名"] .. "还有剩余的点数没加!",
                        C_WHITE, CC.DefaultFont)
                end
            end
        end
    end

    return true
end

-- 战斗结束处理函数
-- isexp 经验值
-- warStatus 战斗状态
--显示人物的战斗信息，包括头像，生命，内力等
function WarShowHead(id)
	if not id then
		id = WAR.CurID
	end
	if id < 0 then
		return 
	end
	local bx,by = CC.WX,CC.HY
	local pid = WAR.Person[id]["人物编号"]
	local p = JY.Person[pid]
	local h = CC.FontSMALL
	local width = CC.FontSMALL*11 - CC.ScreenH/128
	local height = (CC.FontSMALL+CC.RowPixel)*9 - CC.ScreenH/64
	local x1, y1 = 0, 0
	local i = 1
	local size = CC.FontSmall3

	local headw, headh = lib.GetPNGXY(1, p["半身像"])
	local headx = (width - headw) / 2
	local heady = (CC.ScreenH/5 - headh) / 2
	--头像信息
	local headid = JY.Person[pid]["半身像"]
	local wfx,wfy = CC.ScreenW-CC.ScreenW/6.84,CC.ScreenH - CC.ScreenH/1.9948
	local dfx,dfy = CC.ScreenW/50,CC.ScreenH/25.6
	local x,y = 0,0
	if WAR.Person[id]["我方"] then
		x = wfx
		y = wfy
	else
		x = dfx
		y = dfy
	end
	lib.LoadPNG(91, 39*2, x-size,y-size*2, 1)
	lib.LoadPNG(1, headid*2, x,y-size,1,0,CC.ScreenH/6.4)
	lib.LoadPNG(91, 49*2, x-size,y-size*2, 1)	

    --战斗状态显示

	local color = C_WHITE1
	local name = p["姓名"]
	local namelen  = string.len(name) / 2	
	
	--姓名
	lib.LoadPNG(91,38*2,x,y+size*8,1)	
	lib.DrawStr(x+size*3.5-string.len(name)*size/4,y+size*8,name, C_WHITE,size*1.8, CONFIG.CurrentPath.."FONT/2.ttf",  0, 0)
		
	local wgw = size*3.8

	--气显示
	local nlx,nly = x ,y+size*5.4
	local w1 = CC.ScreenW/41.212121
	local nlzb = {{nlx,nly},{nlx+w1,nly},{nlx+w1*2,nly},{nlx+w1*3,nly},{nlx+w1*4,nly}}
	for i = 1,5 do
		if JY.Person[pid]["能量"] >= i then
			lib.LoadPNG(91,106*2,nlzb[i][1],nlzb[i][2],1)
		else
			lib.LoadPNG(91,107*2,nlzb[i][1],nlzb[i][2],1)
		end
	end


	--血蓝怒体条
	local lifexs = "命 "..p["生命"] --生命
	local nlxs = "内 "..p["内力"]  --内力
	local tlxs = "体 "..p["体力"] --体力
	local Rlxz = WAR.LQZ[pid]
	if Rlxz == nil then
		Rlxz = 0
	end
	local lqzxs = "怒 "..Rlxz;	--怒气

	local pcx = x-size ;
	local pcy = y + size*10
	local pcx1 = x-size- CC.RowPixel;	

	--生命条
	lib.LoadPNG(91, 293 * 2 , pcx  , pcy, 1,0,100)
	local pcw, pch = lib.GetPNGXY(91, 289 * 2);  
	lib.SetClip(pcx1, pcy, pcx1 + (p["生命"]/p["生命最大值"])*(pcw), pcy + pch)
	lib.LoadPNG(91, 289 * 2 , pcx  , pcy, 1,0,100)
	pcy = pcy + CC.RowPixel + size -2
	lib.SetClip(0,0,0,0)
	DrawString(pcx, pcy-size  , lifexs, C_WHITE, size)

	--内力条
	local h = size/2-by*10
	lib.LoadPNG(91, 293 * 2 , pcx  , pcy +h, 1,0,100)
	local pcw, pch = lib.GetPNGXY(91, 290 * 2);  
	lib.SetClip(pcx1, pcy +h, pcx1 + (p["内力"]/p["内力最大值"])*(pcw), pcy + pch +h)
	lib.LoadPNG(91, 290 * 2 , pcx  , pcy+h, 1,0,100)
	pcy = pcy + CC.RowPixel + size -2
	lib.SetClip(0,0,0,0)
	DrawString(pcx, pcy-size+h , nlxs, C_WHITE, size)

	--体力条
	local h = h + h
	lib.LoadPNG(91, 293 * 2 , pcx  , pcy +h, 1,0,100)
	local pcw, pch = lib.GetPNGXY(91, 291 * 2);  
	lib.SetClip(pcx1, pcy +h, pcx1 + (p["体力"]/100)*(pcw), pcy + pch +h)
	lib.LoadPNG(91, 291 * 2 , pcx  , pcy+h, 1,0,100)
	pcy = pcy + CC.RowPixel + size -2
	lib.SetClip(0,0,0,0)
	DrawString(pcx, pcy-size+h , tlxs, C_WHITE, size)

	--怒气
	local h = h + h
	lib.LoadPNG(91, 293 * 2 , pcx  , pcy +h, 1,0,100)
	local pcw, pch = lib.GetPNGXY(91, 292 * 2);  
	lib.SetClip(pcx1, pcy +h, pcx1 + (Rlxz/100)*(pcw), pcy + pch +h)
	lib.LoadPNG(91, 292 * 2 , pcx  , pcy+h, 1,0,100)
	pcy = pcy + CC.RowPixel + size -2
	lib.SetClip(0,0,0,0)
	DrawString(pcx, pcy-size+h , lqzxs, C_WHITE, size)

	local suf = CC.ScreenH/5.907
	--装备武功
	if p["优先使用"] > 0 then
		local zyng = p["优先使用"]
		lib.LoadPNG(98,(500+zyng)*2,x-size,y+size*16-size/2,1,0,suf)
	else
		lib.LoadPNG(91, 77 * 2 , x-size, y+size*16-size/2, 1,0,suf)
	end		
	if p["主运内功"] > 0 then
		local zyng = p["主运内功"]
		lib.LoadPNG(98,(500+zyng)*2,x-size+wgw,y+size*16-size/2,1,0,suf)
	else	
		lib.LoadPNG(91, 76 * 2 , x-size+wgw, y+size*16-size/2, 1,0,suf)
	end	
	if p["主运轻功"] > 0 then
		local zyng = p["主运轻功"]
		lib.LoadPNG(98,(500+zyng)*2,x-size+wgw*2,y+size*16-size/2,1,0,suf)
	else
		lib.LoadPNG(91, 78 * 2 , x-size+wgw*2, y+size*16-size/2, 1,0,suf)
	end		
	------敌方携带物品----
	if WAR.Person[id]["我方"] == false then
		if p["携带物品" .. i] >= 0 then 
			y1 = dfy+size*18
			lib.LoadPNG(91, 27 * 2 ,x1-CC.ScreenW/453.333,y1+CC.ScreenH/30.72, 1,0,suf)	 
			local xdwp = "携带物品"
			lib.DrawStr(x1+size*5-string.len(xdwp)*size/4,y1+CC.ScreenH/25.6,xdwp, C_CYGOLD,size, CONFIG.CurrentPath.."FONT/2.ttf",  0, 0)
			local hl = 1
			for i = 1, 4 do
				local wp = p["携带物品" .. i]
				local wps = p["携带物品数量" .. i]
				if wp >= 0 then
					local wpm = JY.Thing[wp]["名称"]
					DrawString(x-size/2, y1+size*1.4 + hl * (size+CC.RowPixel) , wpm .."  ".. wps, C_WHITE, size)
					hl = hl + 1
				end
			end
		end
	end	

	----------战斗buf/debuf显示------
	local ztx1,ztx2 = CC.ScreenW/1.2052,CC.ScreenW/1.2052
	local zty1 = CC.ScreenH/1.0593
	local ztmenu = {}
	local ztmenu1= {}
	local ztmenu2 = {}
	local zt_num = 0
	local zt_num1 = 0		
	local d_num = 0
	local w_num = 0
	local cl = C_GOLD
	local ztx = 0
	local zty = 0
    if p["中毒程度"] > 0 then                           --中毒
        WAR.PD["中毒"][pid] = p["中毒程度"]
    end 	
    if p["冰封程度"] > 0 then                           --冰封
        WAR.PD["冰封"][pid] = p["冰封程度"]
    end   	
    if p["灼烧程度"] > 0 then 
        WAR.PD["灼烧"][pid] = p["灼烧程度"]             --灼烧
    end  
    --if p["受伤程度"] > 0 then 1018
        --WAR.PD["内伤"][pid] = p["受伤程度"]             --内伤
    --end    
    if WAR.FXDS[pid] ~= nil and WAR.FXDS[pid] > 0 then --封穴
        WAR.PD["封穴"][pid] =  WAR.FXDS[pid]
    end
    if WAR.LXZT[pid] ~= nil and WAR.LXZT[pid] > 0 then --流血
        WAR.PD["流血"][pid] =  WAR.LXZT[pid]
    end
	--WAR.PD["封穴"][id] = WAR.FXDS[pid] or 0;		--封穴
	--WAR.PD["流血"][id] = WAR.LXZT[pid] or 0;		--流血1
	--local pmenu = {{"中毒",zdxs,""},{"内伤",nsxs,""},{"冰封",bfxs,""},{"灼烧",zsxs,""},{"封穴",fxxs,""},{"流血",lxxs,""}}
	local h = size*4+CC.RowPixel*2
    
    local zx,zy = lib.GetPNGXY(91, 66* 2) + size/3
	if WAR.Person[id]["我方"] == true then
		ztx = x - size*7 + zx
		zty = y + size*15  
	else
		ztx = x + size*13
		zty = y - size 
	end 

	for i = 1,#CC.ZTSM do
		if CC.ZTSM[i] ~= nil then
			ztmenu[#ztmenu+1] = CC.ZTSM[i][1]
			ztmenu1[#ztmenu1+1] = CC.ZTSM[i][3]
			ztmenu2[#ztmenu2+1] = CC.ZTSM[i][6]
		end
	end
    local n,m = 0,0
	for i = 1,#ztmenu do
		local ztname = ztmenu[i] 
		local stn = ''
		if ztmenu2[i] ~= nil then 
			stn = string.len(ztmenu2[i]) / 2
		end
		local ztname1,ztname2,ztname3 = '','',''
		
		if stn == 2 then 
			ztname1 = string.sub(ztmenu2[i],1,2)
			ztname2 = string.sub(ztmenu2[i],3,4)
		end
		if stn == 3 then 
			ztname1 = string.sub(ztmenu2[i],1,2)
			ztname2 = string.sub(ztmenu2[i],3,4)			
			ztname3 = string.sub(ztmenu2[i],5,6)
		end


		if WAR.PD[ztname]~=nil then
			if WAR.PD[ztname][pid] ~= nil and WAR.PD[ztname][pid] > 0 then
				if ztmenu1[i] == 2 then
					cl = TG_Red_Bright
				end
				if ztmenu1[i] == 1 then
					cl = M_Cyan
				end
				local wz =  WAR.PD[ztname][pid] or 0
				local yy = 0
				local xx = 0
                local n,m = 0,0
				if WAR.Person[id]["我方"] == true then
					w_num = w_num + 1 
					if w_num >= 10 then 
                        w_num = 1
						zt_num = zt_num + 1						
					end					
					yy = zty  - h*(zt_num) 
					xx = ztx - zx*(w_num - 1)
				else
					d_num = d_num + 1 
					if d_num >=10  then 
						d_num = 1
						zt_num1 = zt_num1 + 1
					end		
					yy = zty + h*(zt_num1)
					xx = ztx + zx*(d_num - 1)
				end
				lib.LoadPNG(91, 66 * 2 ,xx, yy, 1)
				local xxx = CC.ScreenH/375
                local hh = size*0.9
                if ztname3 == ''then 
                    hh = hh*2
                end 
				DrawString(xx+CC.ScreenW/680-string.len(ztname1) * size*1.2/4+size+xxx, yy+CC.ScreenH/384,ztname1, C_BLACK, size*1.2)
				DrawString(xx+CC.ScreenW/680-string.len(ztname2) * size*1.2/4+size+xxx, yy+CC.ScreenH/384+hh,ztname2, C_BLACK, size*1.2)
				DrawString(xx+CC.ScreenW/680-string.len(ztname3) * size*1.2/4+size+xxx, yy+CC.ScreenH/384+hh*2,ztname3, C_BLACK, size*1.2)
				DrawString(xx+CC.ScreenW/400+size-string.len(wz) * size*1.2/4, yy+size+CC.ScreenH/22, wz, C_BLACK, size*1.2)
			end
		end
	end
end

-- 无酒不欢：选择移动
-- 增加7*7的显示flag
function War_SelectMove(flag)
    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
    local x = x0
    local y = y0
    if flag ~= nil then
        CleanWarMap(7, 0)
    end
    while true do
        if JY.Restart == 1 then
            break
        end
        local x2 = x
        local y2 = y

        Cat('实时特效动画')

        WarDrawMap(1, x, y)

        if flag ~= nil then
            for i = 1, 4 do
                for j = 1, 4 do
                    SetWarMap(x + i - 1, y + j - 1, 7, 1)
                    SetWarMap(x - i + 1, y + j - 1, 7, 1)
                    SetWarMap(x + i - 1, y - j + 1, 7, 1)
                    SetWarMap(x - i + 1, y - j + 1, 7, 1)
                end
            end
            WarDrawMap(1, x, y)
        end

        WarShowHead(GetWarMap(x, y, 2))

        -- 如阴时显示集气条
        if WAR.FLHS5 == 2 then
            DrawTimeBar_sub()
        end
        Cat('实时特效动画2')
        ShowScreen()

        if flag ~= nil then
            CleanWarMap(7, 0)
        end

        lib.Delay(CC.BattleDelay + 1)
        local key, ktype, mx, my = lib.GetKey()
        if key == VK_UP then
            PlayWavE(77)
            y2 = y - 1
        elseif key == VK_DOWN then
            PlayWavE(77)
            y2 = y + 1
        elseif key == VK_LEFT then
            PlayWavE(77)
            x2 = x - 1
        elseif key == VK_RIGHT then
            PlayWavE(77)
            x2 = x + 1
        elseif key == VK_SPACE or key == VK_RETURN then
            PlayWavE(77)
            return x, y
        elseif key == VK_ESCAPE or ktype == 4 then
            PlayWavE(77)
            return nil
        elseif ktype == 2 or ktype == 3 then
            PlayWavE(77)
            mx = mx - CC.ScreenW / 2
            my = my - CC.ScreenH / 2
            mx = (mx) / CC.XScale
            my = (my) / CC.YScale
            mx, my = (mx + my) / 2, (my - mx) / 2
            if mx > 0 then
                mx = mx + 0.99
            else
                mx = mx - 0.01
            end
            if my > 0 then
                my = my + 0.99
            else
                mx = mx - 0.01
            end
            mx = math.modf(mx)
            my = math.modf(my)
            for i = 0, 10 do
                if mx + i <= 63 then
                    if my + i > 63 then
                        break
                    end
                end
                local hb = GetS(JY.SubScene, x0 + mx + i, y0 + my + i, 4)

                if math.abs(hb - CC.YScale * i * 2) < 5 then
                    mx = mx + i
                    my = my + i
                end
            end
            x2, y2 = mx + x0, my + y0

            if ktype == 3 then
                PlayWavE(77)
                return x, y
            end
        end

        -- 无酒不欢：避免跳出
        if GetWarMap(x2, y2, 3) ~= nil and GetWarMap(x2, y2, 3) < 128 then
            x = x2
            y = y2
        end
    end
end

-- 获取武功最小内力
function War_GetMinNeiLi(pid)
    local minv = math.huge
    for i = 1, JY.Base["武功数量"] do
        local tmpid = JY.Person[pid]["优先使用"]
        if tmpid > 0 and JY.Wugong[tmpid]["消耗内力点数"] < minv then
            minv = JY.Wugong[tmpid]["消耗内力点数"]
        end
    end
    return minv
end

-- 无酒不欢：手动战斗菜单上级
function War_Manual()
    local r = nil
    local pid = WAR.Person[WAR.CurID]['人物编号']
    if WAR.PD["混乱状态"][pid] ~= nil then
        Cat('随机移动')
    end
    -- 随机移动
    local tf57 = hastf(WAR.CurID, 57, 2)
    if tf57 ~= nil then
        if math.random(100) <= 25 then
            Cat('随机移动')
        end
    end
    local x, y, move, pic, face_dir = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"],
        WAR.Person[WAR.CurID]["移动步数"], WAR.Person[WAR.CurID]["贴图"], WAR.Person[WAR.CurID]["人方向"]
    while true do
        if JY.Restart == 1 then
            break
        end
        WAR.ShowHead = 1
        -- r = War_Manual_Sub()
        r = Cat('战斗菜单')
        -- 移动，这里实际返回的应该是-1
        if r == 1 or r == -1 then
            -- WAR.Person[WAR.CurID]["移动步数"] = 0 
            -- ESC返回
        elseif r == 0 then
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.CurID]["移动步数"] =
                x, y, move
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, pic)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            -- 无酒不欢：人物面相也要还原
            WAR.Person[WAR.CurID]["人方向"] = face_dir
        elseif r == 20 then

        else
            break
        end
    end
    WAR.ShowHead = 0
    WarDrawMap(0)
    return r -- 无酒不欢：这里的返回值似乎没什么庞
end

function WarTitleSelection()
    local choice = 1
    local buttons = {{967, 971, 100, 0, 200, 0}, {968, 972, 100, 40, 220, 40}, {969, 973, 100, 80, 200, 80},
                     {970, 974, 100, 120, 200, 120}, {970, 974, 100, 160, 200, 160}, {970, 974, 100, 200, 200, 200},
                     {970, 974, 100, 240, 200, 240}, {970, 974, 100, 280, 200, 280}}
    local function on_button(mx, my)
        local r = 0
        for i = 1, #buttons do
            if mx >= buttons[i][4] and mx <= buttons[i][6] and my >= buttons[i][5] and my <= buttons[i][7] then
                r = i
                break
            end
        end
        return r
    end
    while true do
        if JY.Restart == 1 then
            return
        end
        local keypress, ktype, mx, my = lib.GetKey()
        if keypress == VK_DOWN or keypress == VK_RIGHT then
            PlayWavE(77)
            choice = choice + 1
            if choice > #buttons then
                choice = 1
            end
        elseif keypress == VK_UP or keypress == VK_LEFT then
            PlayWavE(77)
            choice = choice - 1
            if choice < 1 then
                choice = #buttons
            end
        else
            if (ktype == 2 or ktype == 3 or ktype == 4 or ktype == 5 or ktype == 6 or ktype == 7 or ktype == 7) then
                -- PlayWavE(77)
                local r = on_button(mx, my)
                if r > 0 then
                    choice = r
                end
            end
            if keypress == VK_RETURN or (ktype == 9 and on_button(mx, my) > 0) then
                PlayWavE(77)
                break
            end
        end
        Cls()
        for i = 1, #buttons do
            local picid = buttons[i][1]
            if i == choice then
                picid = buttons[i][2]
            end
            lib.LoadPNG(1, picid * 2, buttons[i][3], buttons[i][4], 1)
        end
        ShowScreen()
        lib.Delay(CC.BattleDelay)
    end
    return choice
end

-- 老顾0304
-- 无酒不欢：运功选择菜单
function War_YunGongMenu()
    local bx, by = CC.WX, CC.HY
    local id = WAR.Person[WAR.CurID]["人物编号"]
    local menu = {};
    menu[1] = {"运行内功", SelectNeiGongMenu, 1};
    menu[2] = {"切换外功", Qiehuanwg, 1};
    menu[3] = {"运行轻功", SelectQingGongMenu, 1};
    local r = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE, CC.FontSmall, 1)
    if r == 0 then
        return 0
    end
    local r1 = menu[r][2]()
    if r1 == 2 then
        return 20;
    elseif r1 == 20 then
        return 20;
    elseif r1 == 4 then
        return 20;
    elseif r1 == 10 then
        return 10;
    end
end

-- 无酒不欢：选择内功菜单
function SelectNeiGongMenu()
    local bx, by = CC.WX, CC.HY
    local id, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"],
        WAR.Person[WAR.CurID]["坐标Y"]
    local menu = {};
    local a = 0
    for i = 1, JY.Base["武功数量"] do
        menu[i] = {JY.Wugong[JY.Person[id]["武功" .. i]]["名称"], nil, 0};
        if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 6 then
            menu[i][3] = 1;
        end
        -- 天罡不能运三大
        if (id == 0 and JY.Base["标准"] == 6) and
            (JY.Person[id]["武功" .. i] == 106 or JY.Person[id]["武功" .. i] == 107 or JY.Person[id]["武功" .. i] == 108) then
            menu[i][3] = 0;
        end
        -- 五岳剑诀不能运
        -- if JY.Person[id]["武功" .. i] == 175 then
        --	menu[i][3]=0
        -- end
        if menu[i][3] == 1 then
            a = 1
        end
    end
    if a == 0 then
        return 0
    end
    local main_neigong = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
        CC.FontSmall, 1)
    -- local main_neigong =  Cat('菜单',menu,#menu,0,CC.MainMenuX, CC.MainMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
    if main_neigong ~= nil and main_neigong > 0 then
        CleanWarMap(4, 0)
        SetWarMap(x1, y1, 4, 1)
        War_ShowFight(id, 0, 0, 0, 0, 0, 9)
        AddPersonAttrib(id, "体力", -10);
        JY.Person[id]["主运内功"] = JY.Person[id]["武功" .. main_neigong]
        Hp_Max(id)
        Mp_Max(id)
        return 20;
    end
end

-- 老顾0309
-- 武功套路选择
function Qiehuanwg()
    local bx, by = CC.WX, CC.HY
    local pid, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"],
        WAR.Person[WAR.CurID]["坐标Y"]
    local menu = {};
    local a = 0
    local numwugong = 0
    local kfmenu = {}
    for i = 1, JY.Base["武功数量"] do
        local tmp = JY.Person[pid]["武功" .. i]
        if tmp > 0 then
            menu[i] = {JY.Wugong[tmp]["名称"], i, 1} -- 如果是1则显示按排序i显示

            -- 内功无法攻击
            -- 游坦之可以	标记修改
            if JY.Wugong[tmp]["武功类型"] == 6 and match_ID(pid, 9985) == false then
                menu[i][3] = 0
            end

            -- 轻功无法攻击
            if JY.Wugong[tmp]["武功类型"] == 7 or secondary_wugong(tmp) then
                menu[i][3] = 0
            end

            -- 斗转星移不显示
            if tmp == 43 then
                menu[i][3] = 0
            end
            -- 如果主角是天罡，内功可攻击，畅想第一格内功可攻击
            if ((pid == 0 and JY.Base["标准"] == 6) or (pid == 0 and JY.Base["畅想"] > 0 and i == 1)) and
                JY.Wugong[tmp]["武功类型"] == 6 then
                menu[i][3] = 1
            end
            -- 林平之 东方 萧半和 显示葵花神功
            if tmp == 105 and (match_ID(pid, 36) or match_ID(pid, 27) or match_ID(pid, 189)) then
                menu[i][3] = 1
            end

            -- 石破天 显示太玄神功
            if tmp == 102 and match_ID(pid, 9759) then
                menu[i][3] = 1
            end

            -- 张无忌 显示九阳神功
            if tmp == 106 and match_ID(pid, 9) then
                menu[i][3] = 1
            end
            -- 斗酒僧 显示九阳神功
            if tmp == 106 and (match_ID(pid, 638) or match_ID(pid, 9999)) then
                menu[i][3] = 1
            end

            -- 狄云 显示神经照
            if tmp == 94 and match_ID(pid, 37) then
                menu[i][3] = 1
            end

            -- 慕容复 显示斗转星移
            if tmp == 43 and (match_ID(pid, 51) or match_ID(pid, 679)) then
                menu[i][3] = 1
            end

            -- 欧阳锋 显示逆运
            if tmp == 104 and match_ID(pid, 60) then
                menu[i][3] = 1
            end

            -- 小昭 显示圣火
            if tmp == 93 and match_ID(pid, 66) then
                menu[i][3] = 1
            end

            -- 内力少不显示
            if JY.Person[pid]["内力"] < 100 then
                menu[i][3] = 0
            end

            -- 体力低于10不显示
            if JY.Person[pid]["体力"] < 10 then
                menu[i][3] = 0
            end
            if menu[i][3] == 1 then
                a = 1
            end
        end
    end
    if a == 0 then
        return 0
    end
    local main_neigong = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
        CC.FontSmall, 1)
    if main_neigong ~= nil and main_neigong > 0 then
        CleanWarMap(4, 0)
        SetWarMap(x1, y1, 4, 1)
        local dh = JY.Wugong[JY.Person[pid]["武功" .. main_neigong]]["武功动画&音效"]
        War_ShowFight(pid, 0, 0, 0, 0, 0, dh)
        JY.Person[pid]["优先使用"] = JY.Person[pid]["武功" .. main_neigong]
        AddPersonAttrib(pid, "体力", -10);
        return 0;
    end
end

-- 无酒不欢：选择轻功菜单
function SelectQingGongMenu()
    local bx, by = CC.WX, CC.HY
    local id, x1, y1 = WAR.Person[WAR.CurID]["人物编号"], WAR.Person[WAR.CurID]["坐标X"],
        WAR.Person[WAR.CurID]["坐标Y"]
    local menu = {};
    local a = 0
    for i = 1, JY.Base["武功数量"] do
        menu[i] = {JY.Wugong[JY.Person[id]["武功" .. i]]["名称"], nil, 0};
        if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 7 then
            menu[i][3] = 1;
        end
        if menu[i][3] == 1 then
            a = 1
        end
    end
    if a == 0 then
        return 0
    end
    local main_qinggong = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
        CC.FontSmall, 1)
    -- local main_qinggong =  Cat('菜单',menu,#menu,0,CC.MainMenuX, CC.MainMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
    if main_qinggong ~= nil and main_qinggong > 0 then
        CleanWarMap(4, 0)
        SetWarMap(x1, y1, 4, 1)
        War_ShowFight(id, 0, 0, 0, 0, 0, 9)
        AddPersonAttrib(id, "体力", -10);
        WAR.YQG = 1
        JY.Person[id]["主运轻功"] = JY.Person[id]["武功" .. main_qinggong]
        return 10;
    end
end

-- 无酒不欢：战术菜单
function War_TacticsMenu()
    local bx, by = CC.WX, CC.HY
    local menu = {};
    menu[1] = {"蓄力Ｐ", nil, 1};
    menu[2] = {"防御Ｄ", nil, 1};
    menu[3] = {"等待Ｗ", nil, 1};
    menu[4] = {"集中Ｊ", nil, 1};
    menu[5] = {"休息Ｒ", nil, 1};
    local r = Cat('菜单', menu, 10, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE, CC.FontSmall, 1,
        LimeGreen)
    -- local r = Cat('菜单',menu,#menu,0,CC.MainMenuX, CC.MainMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);
    -- 蓄力
    if r == 1 then
        return War_ActupMenu()
        -- 防御
    elseif r == 2 then
        return War_DefupMenu()
        -- 等待
    elseif r == 3 then
        return War_Wait()
        -- 集中
    elseif r == 4 then
        return War_Focus()
        -- 休息
    elseif r == 5 then
        return War_RestMenu()
        -- 快捷键的额外判定	
    elseif r == 6 then
        return 1
        -- 快捷键的额外判定
    elseif r == 7 then
        return 20
    end
end

-- 无酒不欢：其它菜单
function War_OtherMenu()
    local bx, by = CC.WX, CC.HY
    local menu = {};
    menu[1] = {"用毒Ｖ", nil, 1};
    menu[2] = {"解毒Ｑ", nil, 1};
    menu[3] = {"医疗Ｆ", nil, 1};
    -- menu[4]={"物品",nil,1};
    menu[4] = {"状态Ｚ", nil, 1};
    local r = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE, CC.FontSmall, 1,
        LimeGreen)
    -- local r = Cat('菜单',menu,#menu,0,CC.MainMenuX, CC.MainMenuY,0,0,1,1,CC.DefaultFont,C_ORANGE, C_WHITE);

    -- 用毒
    if r == 1 then
        return War_PoisonMenu()
        -- 解毒
    elseif r == 2 then
        return War_DecPoisonMenu()
        -- 医疗
    elseif r == 3 then
        return War_DoctorMenu()
        -- 物品
        -- elseif r == 4 then
        -- return  War_ThingMenu()
        -- 状态
    elseif r == 4 then
        return Ckstatus()
        -- 快捷键的额外判定
    elseif r == 6 then
        return 1
        -- 快捷键的额外判定
    elseif r == 7 then
        return 20
    end
end
-- 修炼武功
function War_PersonTrainBook1(pid)
    local p = JY.Person[pid]
    local thingid = p["修炼物品"]
    if thingid < 0 then
        return
    end
    JY.Thing[101]["加御剑能力"] = 1
    JY.Thing[123]["加拳掌功夫"] = 1
    local wugongid = JY.Thing[thingid]["练出武功"]
    local wg = 0
    if JY.Person[pid]["武功" .. JY.Base["武功数量"]] > 0 and wugongid >= 0 then
        for i = 1, JY.Base["武功数量"] do
            if JY.Thing[thingid]["练出武功"] == JY.Person[pid]["武功" .. i] then
                wg = 1
            end
        end
        if wg == 0 then -- 修复第一版本，不可修炼武功的BUG
            return
        end
    end
    local yes1, yes2, kfnum = false, false, nil
    while true do
        local needpoint = TrainNeedExp(pid)
        if needpoint <= p["修炼点数"] then
            yes1 = true
            AddPersonAttrib(pid, "生命最大值", JY.Thing[thingid]["加生命最大值"])
            -- 修炼血刀减少生命
            -- 狄云不减
            if thingid == 139 and match_ID(pid, 37) == false then
                AddPersonAttrib(pid, "生命最大值", -15)
                AddPersonAttrib(pid, "生命", -15)
                if JY.Person[pid]["生命最大值"] < 1 then
                    JY.Person[pid]["生命最大值"] = 1
                end
            end
            if JY.Person[pid]["生命"] < 1 then
                JY.Person[pid]["生命"] = 1
            end
            if JY.Thing[thingid]["改变内力性质"] == 2 and JY.Person[pid]["内力性质"] ~= 3 and
                match_ID(pid, 9987) == false then
                p["内力性质"] = 2
                if match_ID(pid, 9771) then
                    JY.Person[pid]["内力性质"] = 1
                end
            end

            if match_ID(pid, 9928) or match_ID(pid, 9862) then -- 冯衡 双倍属性值
                AddPersonAttrib(pid, "内力最大值", JY.Thing[thingid]["加内力最大值"])
                AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"])
                AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"])
                AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
                AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"])
                AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"])
                AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
                AddPersonAttrib(pid, "医疗能力", JY.Thing[thingid]["加医疗能力"])
                AddPersonAttrib(pid, "用毒能力", JY.Thing[thingid]["加用毒能力"])
                AddPersonAttrib(pid, "解毒能力", JY.Thing[thingid]["加解毒能力"])
                AddPersonAttrib(pid, "抗毒能力", JY.Thing[thingid]["加抗毒能力"])
            else
                AddPersonAttrib(pid, "内力最大值", JY.Thing[thingid]["加内力最大值"])
                AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"])
                AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"])
                AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
                AddPersonAttrib(pid, "医疗能力", JY.Thing[thingid]["加医疗能力"])
                AddPersonAttrib(pid, "用毒能力", JY.Thing[thingid]["加用毒能力"])
                AddPersonAttrib(pid, "解毒能力", JY.Thing[thingid]["加解毒能力"])
                AddPersonAttrib(pid, "抗毒能力", JY.Thing[thingid]["加抗毒能力"])
            end
            if match_ID(pid, 9928) or match_ID(pid, 9863) then -- 黄蓉 萧中慧 双倍兵器值
                AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] * 2)
                AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] * 2)
                AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] * 2)
                AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] * 2)
                AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] * 2)
            elseif match_ID(pid, 9947) then
                for i = 1, JY.Base["武功数量"] do
                    local bqz = 0
                    local bqz1 = 0
                    if JY.Thing[thingid]["练出武功"] == JY.Person[pid]["武功" .. i] and
                        JY.Wugong[wugongid]["武功类型"] == 6 then
                        bqz = bqz + 1
                    end
                end
                bqz1 = bqz * 20
                AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] + bqz1)
                AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] + bqz1)
                AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] + bqz1)
                AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] + bqz1)
                AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] + bqz1)
            else
                AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"])
                AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"])
                AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"])
                AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"])
                AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"])
            end

            AddPersonAttrib(pid, "暗器技巧", JY.Thing[thingid]["加暗器技巧"])
            AddPersonAttrib(pid, "武学常识", JY.Thing[thingid]["加武学常识"])
            -- AddPersonAttrib(pid, "品德", JY.Thing[thingid]["加品德"])
            AddPersonAttrib(pid, "攻击带毒", JY.Thing[thingid]["加攻击带毒"])

            p["修炼点数"] = p["修炼点数"] - needpoint

            if wugongid >= 0 then
                yes2 = true
                local oldwugong = 0
                for i = 1, JY.Base["武功数量"] do
                    if p["武功" .. i] == wugongid then
                        oldwugong = 1
                        p["武功等级" .. i] = math.modf((p["武功等级" .. i] + 100) / 100) * 100
                        kfnum = i
                        break
                    end
                end
                if oldwugong == 0 then
                    for i = 1, JY.Base["武功数量"] do
                        if p["武功" .. i] == 0 then
                            p["武功" .. i] = wugongid
                            p["武功等级" .. i] = 0;
                            kfnum = i
                            break
                        end
                    end
                end
            end
        else
            break
        end
    end
    if yes2 then
        -- 无酒不欢：自动到极的判定在这里
        if p["武功等级" .. kfnum] == 900 then
            -- 胡斐等人优先判定
            if (match_ID(pid, 1) and wugongid == 67) or (match_ID(pid, 37) and wugongid == 94) or
                (match_ID(pid, 49) and wugongid == 14) then
                DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                    math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
                -- 内功和轻功
            elseif JY.Wugong[wugongid]["武功类型"] == 6 or JY.Wugong[wugongid]["武功类型"] == 7 then
                -- 黄裳直接到极
                if match_ID(pid, 637) then
                    p["武功等级" .. kfnum] = 999
                    DrawStrBoxWaitKey(string.format("%s 已修炼到登峰造极", JY.Wugong[wugongid]["名称"]),
                        C_WHITE, CC.DefaultFont)
                    -- 天内天轻可以到极
                elseif wugongid == p["天赋内功"] or wugongid == p["天赋轻功"] then
                    p["武功等级" .. kfnum] = 999
                    DrawStrBoxWaitKey(string.format("%s 已修炼到登峰造极", JY.Wugong[wugongid]["名称"]),
                        C_WHITE, CC.DefaultFont)
                else
                    DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                        math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
                end
                -- 外功直接到极
            else
                p["武功等级" .. kfnum] = 900
                DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                    math.modf(p["武功等级" .. kfnum] / 100)), C_WHITE, CC.DefaultFont)
            end
        else
            DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
        end
    end
    Hp_Max(pid)
    Mp_Max(pid)
end
-- 修炼武功
function War_PersonTrainBook(pid)
    local p = JY.Person[pid]
    local thingid = p["修炼物品"]
    thingid = -1
    if thingid < 0 then
        return
    end
    JY.Thing[101]["加御剑能力"] = 1
    JY.Thing[123]["加拳掌功夫"] = 1
    local wugongid = JY.Thing[thingid]["练出武功"]
    local wg = 0
    if JY.Person[pid]["武功" .. JY.Base["武功数量"]] > 0 and wugongid >= 0 then
        for i = 1, JY.Base["武功数量"] do
            if JY.Thing[thingid]["练出武功"] == JY.Person[pid]["武功" .. i] then
                wg = 1
            end
        end
        if wg == 0 then -- 修复第一版本，不可修炼武功的BUG
            return
        end
    end

    local yes1, yes2, kfnum = false, false, nil
    while true do
        local needpoint = TrainNeedExp(pid)
        if needpoint <= p["修炼点数"] then
            yes1 = true
            AddPersonAttrib(pid, "生命最大值", JY.Thing[thingid]["加生命最大值"])
            -- 修炼血刀减少生命
            -- 狄云不减
            if thingid == 139 and match_ID(pid, 37) == false then
                AddPersonAttrib(pid, "生命最大值", -15)
                AddPersonAttrib(pid, "生命", -15)
                if JY.Person[pid]["生命最大值"] < 1 then
                    JY.Person[pid]["生命最大值"] = 1
                end
            end
            if JY.Person[pid]["生命"] < 1 then
                JY.Person[pid]["生命"] = 1
            end
            if JY.Thing[thingid]["改变内力性质"] == 2 and JY.Person[pid]["内力性质"] ~= 3 and
                match_ID(pid, 9987) == false then
                p["内力性质"] = 2
                if match_ID(pid, 9771) then
                    JY.Person[pid]["内力性质"] = 1
                end
            end

            if match_ID(pid, 9928) or match_ID(pid, 9862) then -- 冯衡 双倍属性值
                AddPersonAttrib(pid, "内力最大值", JY.Thing[thingid]["加内力最大值"])
                AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"] * 2)
                AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"] * 2)
                AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"] * 2)
                AddPersonAttrib(pid, "医疗能力", JY.Thing[thingid]["加医疗能力"])
                AddPersonAttrib(pid, "用毒能力", JY.Thing[thingid]["加用毒能力"])
                AddPersonAttrib(pid, "解毒能力", JY.Thing[thingid]["加解毒能力"])
                AddPersonAttrib(pid, "抗毒能力", JY.Thing[thingid]["加抗毒能力"])
            else
                AddPersonAttrib(pid, "内力最大值", JY.Thing[thingid]["加内力最大值"])
                AddPersonAttrib(pid, "攻击力", JY.Thing[thingid]["加攻击力"])
                AddPersonAttrib(pid, "轻功", JY.Thing[thingid]["加轻功"])
                AddPersonAttrib(pid, "防御力", JY.Thing[thingid]["加防御力"])
                AddPersonAttrib(pid, "医疗能力", JY.Thing[thingid]["加医疗能力"])
                AddPersonAttrib(pid, "用毒能力", JY.Thing[thingid]["加用毒能力"])
                AddPersonAttrib(pid, "解毒能力", JY.Thing[thingid]["加解毒能力"])
                AddPersonAttrib(pid, "抗毒能力", JY.Thing[thingid]["加抗毒能力"])
            end
            if match_ID(pid, 9928) or match_ID(pid, 9863) then -- 黄蓉 萧中慧 双倍兵器值
                AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] * 2)
                AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] * 2)
                AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] * 2)
                AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] * 2)
                AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] * 2)
            elseif match_ID(9947, pid) then
                for i = 1, JY.Base["武功数量"] do
                    local bqz = 0
                    local bqz1 = 0
                    if JY.Thing[thingid]["练出武功"] == JY.Person[pid]["武功" .. i] and
                        JY.Wugong[wugongid]["武功类型"] == 6 then
                        bqz = bqz + 1
                    end
                end
                bqz1 = bqz * 20
                AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"] + bqz1)
                AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"] + bqz1)
                AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"] + bqz1)
                AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"] + bqz1)
                AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"] + bqz1)
            else
                AddPersonAttrib(pid, "拳掌功夫", JY.Thing[thingid]["加拳掌功夫"])
                AddPersonAttrib(pid, "指法技巧", JY.Thing[thingid]["加指法技巧"])
                AddPersonAttrib(pid, "御剑能力", JY.Thing[thingid]["加御剑能力"])
                AddPersonAttrib(pid, "耍刀技巧", JY.Thing[thingid]["加耍刀技巧"])
                AddPersonAttrib(pid, "特殊兵器", JY.Thing[thingid]["加特殊兵器"])
            end

            AddPersonAttrib(pid, "暗器技巧", JY.Thing[thingid]["加暗器技巧"])
            AddPersonAttrib(pid, "武学常识", JY.Thing[thingid]["加武学常识"])
            -- AddPersonAttrib(pid, "生命", JY.Thing[thingid]["加品德"])
            AddPersonAttrib(pid, "攻击带毒", JY.Thing[thingid]["加攻击带毒"])
            if JY.Thing[thingid]["加攻击次数"] == 1 then
                if JY.Base["畅想"] == 152 and pid == 0 then
                else
                    p["左右互搏"] = 1
                end
            end
            if thingid == 372 and Pmiji(pid, 1) == false and Pmiji(pid, 2) == false then
                local r = LGMsgBox("请选择", "何为中庸之道？*一：天命之谓性*二：率性之谓道",
                    {"一", "二"}, 2, 189)
                if r == 1 then
                    p["中庸"] = 1
                    break
                elseif r == 2 then
                    p["中庸"] = 2
                    break
                end
            end
            p["修炼点数"] = p["修炼点数"] - needpoint

            if wugongid >= 0 then
                yes2 = true
                local oldwugong = 0
                for i = 1, JY.Base["武功数量"] do
                    if p["武功" .. i] == wugongid then
                        oldwugong = 1
                        p["武功等级" .. i] = math.modf((p["武功等级" .. i] + 100) / 100) * 100
                        kfnum = i
                        break
                    end
                end
                if oldwugong == 0 then
                    for i = 1, JY.Base["武功数量"] do
                        if p["武功" .. i] == 0 then
                            p["武功" .. i] = wugongid
                            p["武功等级" .. i] = 0;
                            kfnum = i
                            break
                        end
                    end
                end
            end
        else
            break
        end
    end

    if yes1 then
        DrawStrBoxWaitKey(string.format("%s 修炼 %s 成功", p["姓名"], JY.Thing[thingid]["名称"]), C_WHITE,
            CC.DefaultFont)
    end
    if yes2 then
        -- 无酒不欢：自动到极的判定在这里
        if p["武功等级" .. kfnum] == 900 then
            -- 胡斐等人优先判定
            if (match_ID(pid, 1) and wugongid == 67) or (match_ID(pid, 37) and wugongid == 94) or
                (match_ID(pid, 49) and wugongid == 14) then
                DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                    math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
                -- 内功和轻功
            elseif JY.Wugong[wugongid]["武功类型"] == 6 or JY.Wugong[wugongid]["武功类型"] == 7 then
                -- 黄裳直接到极
                if match_ID(pid, 637) then
                    p["武功等级" .. kfnum] = 999
                    DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE,
                        CC.DefaultFont)
                    -- 天内天轻可以到极
                elseif wugongid == p["天赋内功"] or wugongid == p["天赋轻功"] then
                    p["武功等级" .. kfnum] = 999
                    DrawStrBoxWaitKey(string.format("%s 已修炼到极", JY.Wugong[wugongid]["名称"]), C_WHITE,
                        CC.DefaultFont)
                else
                    DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                        math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
                end
                -- 外功直接到极
            else
                p["武功等级" .. kfnum] = 900
                DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                    math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
            end
        else
            DrawStrBoxWaitKey(string.format("%s 升为第%s级", JY.Wugong[wugongid]["名称"],
                math.modf(p["武功等级" .. kfnum] / 100) + 1), C_WHITE, CC.DefaultFont)
        end
    end
    Hp_Max(pid)
    Mp_Max(pid)
end

-- 特色指令
function War_TgrtsMenu()
    local bx, by = CC.ScreenW / 936, CC.ScreenH / 701
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    Cls()
    WAR.ShowHead = 0
    WarDrawMap(0)
    local grts_id;
    -- 如果是畅想
    if pid == 0 then
        grts_id = JY.Base["畅想"]
    else
        grts_id = pid
    end
    -- local 
    -- if JY.Person[pid]["特色指令"] == 1 then

    -- 李清露的特色指令特殊
    if pid == 574 or (pid == 0 and JY.Base["畅想"] == 574) then
        local wg = LGMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"寒袖", "白虹"}, 2, pid, 1)
        if wg == 1 then
            JY.Person[pid]["武功1"] = 201
            JY.Person[pid]["优先使用"] = 201
        elseif wg == 2 then
            JY.Person[pid]["武功1"] = 202
            JY.Person[pid]["优先使用"] = 202
        end
        return 0
        -- 郭襄的指令特殊
    elseif pid == 626 or (pid == 0 and JY.Base["畅想"] == 626) then
        local wg = LGMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"弹指", "玉萧", "落英"}, 3,
            pid, 1)
        if wg == 1 then
            JY.Person[pid]["武功1"] = 18
            JY.Person[pid]["优先使用"] = 18
        elseif wg == 2 then
            JY.Person[pid]["武功1"] = 38
            JY.Person[pid]["优先使用"] = 38
        elseif wg == 3 then
            JY.Person[pid]["武功1"] = 12
            JY.Person[pid]["优先使用"] = 12
        end
        return 0
    else
        local yn = LGMsgBox("特色指令：" .. GRTS[grts_id], GRTSSAY[grts_id], {"确定", "取消"}, 2, pid, 1)
        if yn == 2 then
            return 0
        end
    end

    -- 段誉
    if pid == 53 or (pid == 0 and JY.Base["畅想"] == 53) then
        if JY.Person[pid]["体力"] > 20 then
            WAR.TZ_DY = 1
            PlayWavE(16)
            CurIDTXDH(WAR.CurID, 72, 1, "休迅飞凫 飘忽若神", M_DeepSkyBlue, 15);
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end
    if pid == 308 or (pid == 0 and JY.Base["畅想"] == 308) then
        if JY.Person[pid]["体力"] > 25 and JY.Person[pid]["内力"] > 1000 then
            local r = LGMsgBox("天变",
                "天地无极，乾坤借法，雷公电母，行云布雨，急急如律令，改天变气。",
                {"雨天", "雪天", "雾天", "晴天"}, 4, 301, 1)
            if r >= 1 then
                CC.weat = r
                CurIDTXDH(WAR.CurID, 109, 1, "天地无极，乾坤借法", M_DeepSkyBlue, 15);
                AddPersonAttrib(pid, "体力", -20)
                AddPersonAttrib(pid, "内力", -1000)
            else
                return 0
            end
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end
    -- 春哥
    if pid == 757 or (pid == 0 and JY.Base["畅想"] == 757) then
        if JY.Person[pid]["体力"] > 25 and JY.Person[pid]["内力"] > 1000 and WAR.Data["自动选择参战人2"] < 0 and
            instruct_31(6000) == true then
            local r = LGMsgBox3("大保健", "请选择要召唤的女技师", {"1号", "2号", "3号", "4号", "5号"},
                5, 640, 596, 27, 605, 604, 757)
            local NJS = 0
            CurIDTXDH(WAR.CurID, 72, 1, "召唤女技师", M_DeepSkyBlue, 50);
            if r == "1号" then
                NJS = 640
            elseif r == "2号" then
                NJS = 596
            elseif r == "3号" then
                NJS = 27
            elseif r == "4号" then
                NJS = 605
            elseif r == "5号" then
                NJS = 718
            end
            local x, y = WE_xy(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1)
            WAR.Data["自动选择参战人2"] = NJS
            NewWARPersonZJ(NJS, true, x, y, false, 2)
            Health_in_Battle()
            instruct_32(174, -6000)
            AddPersonAttrib(pid, "体力", -25)
            AddPersonAttrib(pid, "内力", -1000)
            WuKu(NJS)
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 虚竹
    if pid == 49 or (pid == 0 and JY.Base["畅想"] == 49) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
            local ssh = {}
            local num = 1
            for i = 0, WAR.PersonNum - 1 do
                local wid = WAR.Person[i]["人物编号"]
                if WAR.PD["生死符"][wid] == 1 and WAR.Person[i]["死亡"] == false then
                    -- 封穴25点
                    if WAR.FXDS[wid] == nil then
                        WAR.FXDS[wid] = 20
                    else
                        WAR.FXDS[wid] = WAR.FXDS[wid] + 20
                    end
                    if WAR.FXDS[wid] > 20 then
                        WAR.FXDS[wid] = 20
                    end
                    WAR.PD["生死符"][wid] = nil
                    if WAR.Person[i].Time > 995 then
                        WAR.Person[i].Time = 995
                    end
                    ssh[num] = {}
                    ssh[num][1] = i
                    ssh[num][2] = wid
                    num = num + 1
                end
            end
            local name = {}
            for i = 1, num - 1 do
                name[i] = {}
                name[i][1] = JY.Person[ssh[i][2]]["姓名"]
                name[i][2] = nil
                name[i][3] = 1
            end
            -- DrawStrBox(CC.MainMenuX, CC.MainMenuY, "催符：", C_GOLD, CC.DefaultFont)
            local r = Cat('菜单', name, num - 1, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            -- Cat('菜单',name, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
            Cls()
            PlayWavAtk(32)
            CurIDTXDH(WAR.CurID, 72, 1, "符掌生死 德折群雄")
            PlayWavE(8)
            -- local sssid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
            for DH = 114, 129 do
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                for i = 1, num - 1 do
                    local x0 = WAR.Person[WAR.CurID]["坐标X"]
                    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
                    local dx = WAR.Person[ssh[i][1]]["坐标X"] - x0
                    local dy = WAR.Person[ssh[i][1]]["坐标Y"] - y0
                    local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
                    local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
                    local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

                    ry = ry - hb

                    lib.PicLoadCache(3, DH * 2, rx, ry, 2, 192)
                    if DH > 124 then
                        DrawString(rx - 10, ry - 15, "封穴", C_GOLD, CC.DefaultFont)
                    end
                end
                ShowScreen()
                -- lib.ShowSurface(0)
                -- lib.LoadSur(sssid, 0, 0)
                lib.Delay(CC.BattleDelay)
            end
            -- lib.FreeSur(sssid)
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 人厨子
    if pid == 89 or (pid == 0 and JY.Base["畅想"] == 89) then
        if JY.Person[pid]["体力"] > 25 and JY.Person[pid]["内力"] > 300 then
            local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
            local mxy = {{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1},
                         {WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1},
                         {WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]},
                         {WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}
            local zdp = {}
            local num = 1
            for i = 1, 4 do
                if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
                    local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
                    if inteam(WAR.Person[mid]["人物编号"]) then
                        zdp[num] = WAR.Person[mid]["人物编号"]
                        num = num + 1
                    end
                end

            end
            local zdp2 = {}
            for i = 1, num - 1 do
                zdp2[i] = {}
                zdp2[i][1] = JY.Person[zdp[i]]["姓名"] .. "・" .. JY.Person[zdp[i]]["体力"]
                zdp2[i][2] = nil
                zdp2[i][3] = 1
            end
            -- DrawStrBox(CC.MainMenuX, CC.MainMenuY, "气补：", C_GOLD, CC.DefaultFont)
            local r = Cat('菜单', zdp2, num - 1, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            -- local r = Cat('菜单',zdp2, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
            Cls()
            AddPersonAttrib(zdp[r], "体力", 50)
            AddPersonAttrib(pid, "体力", -25)
            AddPersonAttrib(pid, "内力", -300)
            PlayWavE(28)
            -- lib.Delay(10)
            CurIDTXDH(WAR.CurID, 86, 1, "化气补元")
            local Ocur = WAR.CurID
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["人物编号"] == zdp[r] then
                    WAR.CurID = i
                end
            end
            Cat('实时特效动画')
            WarDrawMap(0)
            Cat('实时特效动画2')
            PlayWavE(36)
            -- lib.Delay(CC.Frame)
            lib.Delay(CC.BattleDelay)
            CurIDTXDH(WAR.CurID, 86, 1, "恢复体力50点")
            WAR.CurID = Ocur
            WarDrawMap(0)
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 张无忌
    if pid == 9 or (pid == 0 and JY.Base["畅想"] == 9) then
        if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 500 then
            local nyp = {}
            local num = 1
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and
                    i ~= WAR.CurID then
                    nyp[num] = {}
                    nyp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"]
                    nyp[num][2] = nil
                    nyp[num][3] = 1
                    nyp[num][4] = i
                    num = num + 1
                end
            end
            -- DrawStrBox(CC.MainMenuX, CC.MainMenuY, "挪移：", C_GOLD, CC.DefaultFont)
            local r = Cat('菜单', nyp, num - 1, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            -- local r = Cat('菜单',nyp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
            Cls()
            local mid = WAR.Person[nyp[r][4]]["人物编号"]
            QZXS("请选择要将" .. JY.Person[mid]["姓名"] .. "挪移到什么位置？")
            War_CalMoveStep(WAR.CurID, 8, 1)
            local nx, ny = nil, nil
            while true do
                nx, ny = War_SelectMove()
                if nx ~= nil then
                    if lib.GetWarMap(nx, ny, 2) > 0 or lib.GetWarMap(nx, ny, 5) > 0 then
                        QZXS("此处有人！请重新选择") -- 此处有人！请重新选择
                    elseif CC.SceneWater[lib.GetWarMap(nx, ny, 0)] ~= nil then
                        QZXS("水面，不可进入！请重新选择") -- 水面，不可进入！请重新选择
                    else
                        break
                    end
                end
            end
            PlayWavE(5)
            CurIDTXDH(WAR.CurID, 88, 1, "九阳明尊 挪移乾坤") -- 九阳明尊 挪移乾坤
            local Ocur = WAR.CurID
            WAR.CurID = nyp[r][4]
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 88, 1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 88, 1)
            WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 88, 1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 88, 1)
            WAR.CurID = Ocur
            AddPersonAttrib(pid, "体力", -10)
            AddPersonAttrib(pid, "内力", -500)

        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 祖千秋
    if pid == 88 or (pid == 0 and JY.Base["畅想"] == 88) then
        if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 700 then
            local dxp = {}
            local num = 1
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and
                    i ~= WAR.CurID then
                    dxp[num] = {}
                    dxp[num][1] = JY.Person[WAR.Person[i]["人物编号"]]["姓名"]
                    dxp[num][2] = nil
                    dxp[num][3] = 1
                    dxp[num][4] = i
                    num = num + 1
                end
            end
            -- DrawStrBox(CC.MainMenuX, CC.MainMenuY, "传功：", C_GOLD, 30)
            local r = Cat('菜单', dxp, num - 1, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            -- local r = Cat('菜单',dxp, num - 1, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
            Cls()
            local mid = WAR.Person[dxp[r][4]]["人物编号"]
            PlayWavE(28)
            -- lib.Delay(10)
            CurIDTXDH(WAR.CurID, 87, 1, "酒神戏红尘")
            local Ocur = WAR.CurID
            WAR.CurID = dxp[r][4]
            Cat('实时特效动画')
            WarDrawMap(0)
            Cat('实时特效动画2')
            PlayWavE(36)
            lib.Delay(CC.BattleDelay)
            CurIDTXDH(WAR.CurID, 87, 1, "集气上升500")
            WAR.CurID = Ocur
            WarDrawMap(0)
            WAR.Person[dxp[r][4]].Time = WAR.Person[dxp[r][4]].Time + 500
            if WAR.Person[dxp[r][4]].Time > 999 then
                WAR.Person[dxp[r][4]].Time = 999
            end
            AddPersonAttrib(pid, "体力", -10)
            AddPersonAttrib(pid, "内力", -1000)
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 不戒
    if pid == 573 or (pid == 0 and JY.Base["畅想"] == 573) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
            local mxy = {{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1},
                         {WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1},
                         {WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]},
                         {WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}
            local zdp = {}
            local num = 1
            for i = 1, 4 do
                if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
                    local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
                    if inteam(WAR.Person[mid]["人物编号"]) then
                        zdp[num] = WAR.Person[mid]["人物编号"]
                        num = num + 1
                    end
                end

            end
            local zdp2 = {}
            for i = 1, num - 1 do
                zdp2[i] = {}
                zdp2[i][1] = JY.Person[zdp[i]]["姓名"] .. "・" .. JY.Person[zdp[i]]["体力"]
                zdp2[i][2] = nil
                zdp2[i][3] = 1
            end
            local r = Cat('菜单', zdp2, num - 1, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            Cls()
            PlayWavE(28)
            CurIDTXDH(WAR.CurID, 87, 1, "不可不戒")
            local Ocur = WAR.CurID
            WAR.CurID = zdp[r]
            Cat('实时特效动画')
            WarDrawMap(0)
            Cat('实时特效动画2')
            PlayWavE(36)
            lib.Delay(CC.BattleDelay)
            WAR.CurID = Ocur
            WarDrawMap(0)
            if JY.Person[zdp[r]]["性别"] == 0 then
                JY.Person[zdp[r]]["性别"] = 2
                say("２一刀解千愁。", 0, 2) -- 对话
                local add, str = AddPersonAttrib(zdp[r], "攻击力", -20)
                DrawStrBoxWaitKey(JY.Person[zdp[r]]["姓名"] .. str, C_ORANGE, CC.DefaultFont)
                local add, str = AddPersonAttrib(zdp[r], "防御力", -30)
                DrawStrBoxWaitKey(JY.Person[zdp[r]]["姓名"] .. str, C_ORANGE, CC.DefaultFont)
            else
                say("２没地方下刀。", 0, 2) -- 对话
            end
            AddPersonAttrib(pid, "体力", -20)
            AddPersonAttrib(pid, "内力", -1000)
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 萧中慧，慧心
    if pid == 77 or (pid == 0 and JY.Base["畅想"] == 77) then
        -- if JY.Person[pid]["生命"] > 500 and JY.Person[pid]["受伤程度"] < 50 then   --1018
        if JY.Person[pid]["生命"] > 500 and WAR.PD['内伤状态'][pid] ~= nil and WAR.PD['内伤状态'][pid] < 50 then
            local zjwid = nil
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["人物编号"] == 0 and WAR.Person[i]["死亡"] == false then
                    zjwid = i
                    break
                end
            end
            if zjwid ~= nil then
                DrawStrBoxWaitKey("我心本慧・侠女柔情", C_RED, 36)
                say("２慧妹……！", 0, 1)
                if JY.Person[0]["性别"] == 0 then
                    say("１ｎ哥哥，９请…………２加油！", 77, 0)
                else
                    say("１ｎ姐姐，９请…………２加油！", 77, 0)
                end
                JY.Person[pid]["生命"] = 1
                -- JY.Person[pid]["受伤程度"] = 100  --1018
                WAR.PD['内伤状态'][pid] = 100
                WAR.Person[WAR.CurID].Time = -100
                JY.Person[0]["生命"] = JY.Person[0]["生命最大值"]
                -- JY.Person[0]["受伤程度"] = 0
                WAR.PD['内伤状态'][0] = 0
                WAR.Person[zjwid].Time = 999
                WAR.FXDS[0] = nil
                WAR.LQZ[0] = 100
            else
                DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont) -- "未满足发动条件"
                return 0
            end

        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont) -- "未满足发动条件"
            return 0
        end
    end

    -- 蓝烟清：王难姑特色指令 - 施毒  周围五格范围内的敌人时序中毒并时序减血
    if pid == 17 or (pid == 0 and JY.Base["畅想"] == 17) then
        if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 300 then
            CleanWarMap(4, 0);
            AddPersonAttrib(pid, "体力", -15)
            AddPersonAttrib(pid, "内力", -300)
            local x1 = WAR.Person[WAR.CurID]["坐标X"];
            local y1 = WAR.Person[WAR.CurID]["坐标Y"];
            for ex = x1 - 5, x1 + 5 do
                for ey = y1 - 5, y1 + 5 do
                    SetWarMap(ex, ey, 4, 1)
                    if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                        local ep = GetWarMap(ex, ey, 2)
                        if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then

                            WAR.L_WNGZL[WAR.Person[ep]["人物编号"]] = 50; -- 50时序内持续减中毒+减血
                            SetWarMap(ex, ey, 4, 4)
                        end
                    end
                end
            end
            War_ShowFight(pid, 0, 0, 0, x1, y1, 30);
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- brolycjw：胡青牛特色指令 - 群疗  周围五格范围内的队友时序回内伤并按比例回血
    if pid == 16 or (pid == 0 and JY.Base["畅想"] == 16) then
        if JY.Person[pid]["体力"] >= 30 and JY.Person[pid]["内力"] >= 300 then
            CleanWarMap(4, 0);
            AddPersonAttrib(pid, "体力", -15)
            AddPersonAttrib(pid, "内力", -300)
            local x1 = WAR.Person[WAR.CurID]["坐标X"];
            local y1 = WAR.Person[WAR.CurID]["坐标Y"];

            for ex = x1 - 5, x1 + 5 do
                for ey = y1 - 5, y1 + 5 do
                    SetWarMap(ex, ey, 4, 1)
                    if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                        local ep = GetWarMap(ex, ey, 2)
                        if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then

                            WAR.L_HQNZL[WAR.Person[ep]["人物编号"]] = 20; -- 20时序内持续回血+回内伤
                            SetWarMap(ex, ey, 4, 4)

                        end
                    end
                end
            end
            War_ShowFight(pid, 0, 0, 0, x1, y1, 0);

        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 慕容复 幻梦
    if pid == 51 or (pid == 0 and JY.Base["畅想"] == 51) then
        if JY.Person[pid]["体力"] > 20 then
            WAR.TZ_MRF = 1
            CurIDTXDH(WAR.CurID, 127, 1, "顾盼子孙贤 铭记复国志", C_GOLD);
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 小昭 影步
    if pid == 66 or (pid == 0 and JY.Base["畅想"] == 66) then
        if JY.Person[pid]["体力"] > 30 and JY.Person[pid]["内力"] > 2000 then
            War_CalMoveStep(WAR.CurID, 10, 0)
            WAR.XZ_YB[1], WAR.XZ_YB[2] = War_SelectMove()
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 20
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 1000
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 钟灵指令 灵貂
    if pid == 90 or (pid == 0 and JY.Base["畅想"] == 90) then
        if JY.Person[pid]["体力"] > 10 then
            War_CalMoveStep(WAR.CurID, 8, 1)
            local x, y = War_SelectMove()
            if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
                local tdID = lib.GetWarMap(x, y, 2)
                if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    return 0
                end
                local eid = WAR.Person[tdID]["人物编号"]
                local x0, y0 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
                local x1, y1 = WAR.Person[tdID]["坐标X"], WAR.Person[tdID]["坐标Y"]
                for i = 1, 4 do
                    if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] then
                        WAR.TD = JY.Person[eid]["携带物品" .. i]
                        WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
                        JY.Person[eid]["携带物品数量" .. i] = 0
                        JY.Person[eid]["携带物品" .. i] = -1
                        break
                    end
                end
                WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
                CleanWarMap(4, 0)
                SetWarMap(x1, y1, 4, 1)
                WAR.Person[tdID]["中毒点数"] = (WAR.Person[tdID]["中毒点数"] or 0) +AddPersonAttrib(eid, "中毒程度", 50)
                WAR.TXXS[eid] = 1
                War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 12)
                if WAR.TD ~= -1 then
                    if WAR.TD == 118 then
                        say("１想要从我慕容复手中偷东西？哼哼，下辈子吧！", 51, 0)
                    else
                        instruct_2(WAR.TD, WAR.TDnum)
                    end
                    WAR.TD = -1
                    WAR.TDnum = 0
                end
                WAR.TXXS[eid] = nil
            else
                return 0
            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 5
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 胡斐 飞狐
    if pid == 1 or (pid == 0 and JY.Base["畅想"] == 1) then
        if JY.Person[pid]["体力"] > 20 then
            War_CalMoveStep(WAR.CurID, 10, 2)
            local x, y = War_SelectMove()
            if not x then
                return 0
            end
            if GetWarMap(x, y, 1) > 0 or GetWarMap(x, y, 2) > 0 or GetWarMap(x, y, 5) > 0 or
                CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
                return 0
            else
                CurIDTXDH(WAR.CurID, 25, 1, "雪山飞狐", Violet);
                WAR.Person[WAR.CurID]["移动步数"] = 10
                War_MovePerson(x, y, 1)
                WAR.Person[WAR.CurID]["移动步数"] = 0
                JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            end
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 鸠摩智 幻化
    if pid == 103 or (pid == 0 and JY.Base["畅想"] == 103) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            local thing = {}
            local thingnum = {}
            for i = 0, CC.MyThingNum - 1 do
                thing[i] = -1
                thingnum[i] = 0
            end
            local num = 0
            for i = 0, CC.MyThingNum - 1 do
                local id = JY.Base["物品" .. i + 1]
                if id >= 0 then
                    if JY.Thing[id]["类型"] == 2 and JY.Thing[id]["练出武功"] > -1 then
                        thing[num] = id
                        thingnum[num] = JY.Base["物品数量" .. i + 1]
                        num = num + 1
                    end
                end
            end
            IsViewingKungfuScrolls = 1
            local r = SelectThing(thing, thingnum)
            if r >= 0 then
                WAR.PD["昏迷状态"][pid] = 2
                CurIDTXDH(WAR.CurID, 93, 1, "无相幻化", C_GOLD)
                JY.Person[pid]["武功2"] = JY.Thing[r]["练出武功"]
                JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
                JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
                savewg(WAR.CurID)
                return 0
            else
                return 0
            end
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 达尔巴指令 死战
    if pid == 160 or (pid == 0 and JY.Base["畅想"] == 160) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            War_CalMoveStep(WAR.CurID, 8, 1)
            local x, y = War_SelectMove()
            if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
                local tdID = lib.GetWarMap(x, y, 2)
                if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    return 0
                end
                local eid = WAR.Person[tdID]["人物编号"]
                WAR.SZSD = eid

                CurIDTXDH(WAR.CurID, 93, 1, "锁定目标", C_GOLD)
                JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
                JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
            else
                return 0
            end
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 金轮 龙象
    if pid == 62 or (pid == 0 and JY.Base["畅想"] == 62) then
        if JY.Person[pid]["体力"] > 35 and JY.Person[pid]["内力"] > 3500 then
            War_ActupMenu()
            WAR.SLSX[pid] = 2
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 30
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 3000
            return 0
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 黄蓉 遁甲
    if pid == 56 or (pid == 0 and JY.Base["畅想"] == 56) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            local x, y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
            -- 1绿色，2红色，3蓝色，4紫色
            CleanWarMap(6, -1);

            local QMDJ = {"休", "生", "伤", "杜", "景", "死", "惊", "开"}

            -- 在自身周围绘制奇阵
            SetWarMap(x, y, 6, math.random(4))

            for j = 1, 2 do
                SetWarMap(x + math.random(6), y + math.random(6), 6, math.random(4));
                for n = 30, 40 do
                    local i = n
                    if i > 40 then
                        i = 40
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end

            for j = 3, 4 do
                SetWarMap(x + math.random(6), y - math.random(6), 6, math.random(4));
                for n = 30, 40 do
                    local i = n
                    if i > 40 then
                        i = 40
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end

            for j = 5, 6 do
                SetWarMap(x - math.random(6), y - math.random(6), 6, math.random(4));
                for n = 30, 40 do
                    local i = n
                    if i > 40 then
                        i = 40
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end

            for j = 7, 8 do
                SetWarMap(x - math.random(6), y + math.random(6), 6, math.random(4));
                for n = 30, 40 do
                    local i = n
                    if i > 40 then
                        i = 40
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end

            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 阿紫，禁药
    if pid == 47 or (pid == 0 and JY.Base["畅想"] == 47) then
        WAR.JYZT[pid] = 1
        CurIDTXDH(WAR.CurID, 128, 1, "禁药", C_RED);
        return 20
    end

    -- 韦小宝 口才
    if pid == 601 or (pid == 0 and JY.Base["畅想"] == 601) then
        if JY.Person[pid]["体力"] > 30 then
            War_CalMoveStep(WAR.CurID, 8, 1)
            local x, y = War_SelectMove()
            if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
                local tdID = lib.GetWarMap(x, y, 2)
                if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    return 0
                end
                local eid = WAR.Person[tdID]["人物编号"]
                WAR.PD["沉睡状态"][eid] = 1

                Cls()
                local KC = {"阁下英明神武", "鸟生鱼汤"}

                for n = 1, #KC + 25 do
                    local i = n
                    if i > #KC then
                        i = #KC
                    end
                    lib.GetKey()
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    DrawString(-1, -1, KC[i], C_GOLD, CC.Fontsmall)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
                Cls()
                local s = WAR.CurID
                WAR.CurID = tdID
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 145, 1)
                WAR.CurID = s
                JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 15
            else
                return 0
            end
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 苗人凤指令 破军
    if pid == 3 or (pid == 0 and JY.Base["畅想"] == 3) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            WAR.MRF = 1
            if Cat('武功招式') == 0 then
                return 0
            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 300
            WAR.MRF = 0
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 灭绝，俱焚
    if pid == 6 or (pid == 0 and JY.Base["畅想"] == 6) then
        WAR.PD['玉石俱焚'][pid] = 100
        CurIDTXDH(WAR.CurID, 124, 1, "玉石俱焚", M_Silver);
        return 20
    end

    -- 谢逊指令 咆哮
    if pid == 13 or (pid == 0 and JY.Base["畅想"] == 13) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 3000 then
            CurIDTXDH(WAR.CurID, 118, 1, "狮王咆哮", C_GOLD)
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                    WAR.PD["混乱状态"][WAR.Person[j]["人物编号"]] = 2
                end
            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 2000
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end
    -- 丘处机 一言止杀
    if pid == 68 or (pid == 0 and JY.Base["畅想"] == 68) then
        if JY.Person[pid]["体力"] > 20 and WAR.JSZT1[pid] ~= nil and WAR.JSZT1[pid] == 0 then
            CurIDTXDH(WAR.CurID, 118, 1, "一言止杀", C_GOLD)
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                    local offset1 = math.abs(WAR.Person[j]["坐标X"] - WAR.Person[WAR.CurID]["坐标X"])
                    local offset2 = math.abs(WAR.Person[j]["坐标Y"] - WAR.Person[WAR.CurID]["坐标Y"])
                    if offset1 < 10 and offset2 < 10 then
                        WAR.PD["恐惧状态"][WAR.Person[j]["人物编号"]] = 1
                    end
                end
            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 15
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
        WAR.JSZT1[pid] = nil
    end
    -- 霍青桐统率指令，我方全体防御提升50时序
    if pid == 74 or (pid == 0 and JY.Base["畅想"] == 74) then
        if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 150 and WAR.HQT_CD == 0 then
            CurIDTXDH(WAR.CurID, 92, 1, "指挥"); -- 动画显示
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false then
                    WAR.HQT_ZL[WAR.Person[i]["人物编号"]] = 50
                    WAR.HQT_CD = 2
                    WAR.Person[i].Time = WAR.Person[i].Time + 500;
                    if WAR.Person[i].Time > 999 then
                        WAR.Person[i].Time = 999;
                    end
                end
            end
            AddPersonAttrib(pid, "体力", -15)
            AddPersonAttrib(pid, "内力", -500)
            -- lib.Delay(CC.Frame)		
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 何太冲指令 琴音
    if pid == 7 or (pid == 0 and JY.Base["畅想"] == 7) then
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            CleanWarMap(4, 0)
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    local eid = WAR.Person[j]["人物编号"]
                    local qycs = WAR.PD["琴音状态"][eid] or 0
                    if qycs > 0 then
                        WAR.TXXS[eid] = 1
                        -- 无酒不欢：记录人物血量
                        WAR.Person[j]["Life_Before_Hit"] = JY.Person[eid]["生命"]
                        JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - 50 * qycs
                        WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 50 * qycs
                        SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 1)
                        WAR.PD["琴音状态"][eid] = nil
                    end
                end
            end
            War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 144)
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 阎基指令 虚弱
    if pid == 4 or (pid == 0 and JY.Base["畅想"] == 4) then
        if JY.Person[pid]["体力"] > 20 then
            War_CalMoveStep(WAR.CurID, 8, 1)
            local x, y = War_SelectMove()
            if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
                local tdID = lib.GetWarMap(x, y, 2)
                if WAR.Person[tdID]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    return 0
                end
                local eid = WAR.Person[tdID]["人物编号"]
                local x0, y0 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
                local x1, y1 = WAR.Person[tdID]["坐标X"], WAR.Person[tdID]["坐标Y"]

                WAR.PD["虚弱状态"][eid] = 40
                WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
                CleanWarMap(4, 0)
                SetWarMap(x1, y1, 4, 1)
                War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, 0, 0, 0, 0, 148)
            else
                return 0
            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 黛绮丝，倾国
    if pid == 15 or (pid == 0 and JY.Base["畅想"] == 15) then
        if JY.Person[pid]['内力'] >= 2000 and JY.Person[pid]["体力"] >= 10 then
            WAR.PD['倾国倾城'][pid] = 6
            CurIDTXDH(WAR.CurID, 149, 1)
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 2000
            WAR.ZSLW = 1
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 杨冰羽，招生	--615修改
    if pid == 516 or (pid == 0 and JY.Base["畅想"] == 516) then
        if JY.Person[pid]['内力'] >= 2000 and JY.Person[pid]["体力"] >= 20 and instruct_20() == false and
            instruct_31(6000) then
            local num = 0
            local e_list = {}
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    table.insert(e_list, i)
                    num = num + 1
                end
            end
            local name = {}
            for i = 1, num do
                name[i] = {}
                name[i][1] = JY.Person[WAR.Person[e_list[i]]['人物编号']]['姓名']
                name[i][2] = nil
                name[i][3] = 1
            end
            DrawStrBox(CC.MainMenuX, CC.MainMenuY, "要把谁收为徒弟？", C_GOLD, CC.DefaultFont)
            local c =
                ShowMenu(name, num, 10, CC.MainMenuX, CC.MainMenuY + 45, 0, 0, 1, 0, CC.DefaultFont, C_RED, C_GOLD)
            local o_id = WAR.CurID
            if JY.Person[WAR.Person[e_list[c]]['人物编号']]["畅想分阶"] > 2 then
                say(
                    "２雪羽宗开课招生了！性感妩媚的师傅，冰山冷艳的师姐，清纯可人的师妹，这些统统没有，宗门连个草屋都没有，人傻钱多的速来。 ",
                    0, 2) -- 对话
                WAR.CurID = e_list[c]
                WAR.Person[WAR.CurID]["我方"] = true
                instruct_10(WAR.Person[e_list[c]]['人物编号'])
                instruct_2(174, -6000)
            else
                say("２失败了，知道因为啥失败吗？他一个厨师不看菜谱看起兵法了，撤！ ", 0,
                    2) -- 对话
            end
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 20
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 2000
            WAR.YBY = 1
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 喵姐指令 女装
    if pid == 92 or (pid == 0 and JY.Base["畅想"] == 92) then
        if JY.Person[pid]["体力"] > 20 then
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 135, 1, "日出东方 唯喵姐不败", C_GOLD)
            lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            WarDrawMap(0)
            local mj = {}
            if JY.Person[pid]["性别"] == 0 then
                JY.Person[pid]["头像代号"] = 384
                JY.Person[pid]["半身像"] = 504
                JY.Person[pid]["性别"] = 1
                JY.Person[pid]["武功2"] = 105
                JY.Person[pid]["天赋内功"] = 105
                JY.Person[pid]["主运内功"] = 105
                mj[1] = {0, 13, 0, 0, 0}
                mj[2] = {0, 11, 0, 0, 0}
                mj[3] = {0, 11, 0, 0, 0}
            else
                JY.Person[pid]["头像代号"] = 387
                JY.Person[pid]["半身像"] = 92
                JY.Person[pid]["性别"] = 0
                JY.Person[pid]["武功2"] = 105
                JY.Person[pid]["天赋内功"] = 105
                JY.Person[pid]["主运内功"] = 105
                mj[1] = {0, 14, 0, 0, 0}
                mj[2] = {0, 12, 0, 0, 0}
                mj[3] = {0, 12, 0, 0, 0}
            end
            for i = 1, 5 do
                JY.Person[pid]["出招动画帧数" .. i] = mj[1][i]
                JY.Person[pid]["出招动画延迟" .. i] = mj[2][i]
                JY.Person[pid]["武功音效延迟" .. i] = mj[3][i]
            end

            WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 135, 1, "日出东方 唯喵不败", C_GOLD)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 135, 1, "日出东方 唯喵不败", C_GOLD)
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end
    -- 李寻欢 飞刀
    if pid == 498 or (pid == 0 and JY.Base["畅想"] == 498) then
        if WAR.PD['小李飞刀'][pid] ~= nil then
            WAR.PD['小李飞刀'][pid] = nil
            return 20
        end
        if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 1000 then
            WAR.PD['小李飞刀'][pid] = 100
            CurIDTXDH(WAR.CurID, 124, 1, "小李飞刀", C_GOLD)
            JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
            JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 500
            return 20
        else
            DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
            return 0
        end
    end

    -- 梅长苏 麒麟
    if match_ID(pid, 507) or match_ID(pid, 508) then
        local ql = 1
        local bx, by = CC.ScreenW / 936, CC.ScreenH / 701
        local menu = {};
        local mj = {}
        local str = '策马迎风 看人生起伏'
        local p = 507
        local ts = JY.Base['天书数量']
        menu[1] = {"换装", nil, 1};
        menu[2] = {"麒麟不动", nil, 1};
        mj[1] = {0, 10, 0, 0, 0}
        mj[2] = {0, 9, 0, 0, 0}
        mj[3] = {0, 9, 0, 0, 0}
        if match_ID(pid, 507) then
            mj[1] = {0, 14, 0, 0, 0}
            mj[2] = {0, 14, 0, 0, 0}
            mj[3] = {0, 14, 0, 0, 0}
            p = 508
            str = '江左梅郎  麒麟之才'
            ql = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE, CC.FontSmall, 1)
            if ql == 0 then
                return 0
            end
        end
        if match_ID(pid, 508) then
            mj[1] = {0, 10, 0, 0, 0}
            mj[2] = {0, 9, 0, 0, 0}
            mj[3] = {0, 9, 0, 0, 0}
            p = 507
            str = '策马迎风 看人生起伏'
            ql = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE, CC.FontSmall, 1)
            if ql == 0 then
                return 0
            end
        end
        ql = Cat('菜单', menu, #menu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE, CC.FontSmall, 1)
        if ql == 0 then
            return 0
        end
        -- end
        if ql == 1 then
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 135, 1, str, C_GOLD)
            lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            WarDrawMap(0)
            JY.Person[pid]["头像代号"] = JY.Person[p]["头像代号"]
            JY.Person[pid]["半身像"] = JY.Person[p]["半身像"]
            for i = 1, 5 do
                JY.Person[pid]["出招动画帧数" .. i] = mj[1][i]
                JY.Person[pid]["出招动画延迟" .. i] = mj[2][i]
                JY.Person[pid]["武功音效延迟" .. i] = mj[3][i]
            end
            JY.Base['畅想'] = p
            WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 135, 1, str, C_GOLD)
            lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 135, 1, str, C_GOLD)
        elseif ql == 2 then
            if ts <= 0 or JY.Person[pid]['体力'] < 10 then
                DrawStrBoxWaitKey("未满足发动条件", C_WHITE, CC.DefaultFont)
                return 0
            end
            local x = WAR.Person[WAR.CurID]["坐标X"];
            local y = WAR.Person[WAR.CurID]["坐标Y"];
            local page = 1

            War_CalMoveStep(WAR.CurID, 255, 1)
            Cat('实时特效动画')
            WarDrawMap(1, x, y);
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
            x, y = War_SelectMove()
            if x == nil then
                return 0
            end
            local id = -1
            local kfmenu = {}
            local i = GetWarMap(x, y, 2)
            local kfid = 0
            local kflv = 0
            if i >= 0 and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                id = WAR.Person[i]['人物编号']
                for j = 1, JY.Base['武功数量'] do
                    if JY.Person[id]['武功' .. j] > 0 then
                        kfmenu[#kfmenu + 1] = {JY.Wugong[JY.Person[id]['武功' .. j]]['名称'],
                                               JY.Person[id]['武功' .. j], 1, JY.Person[id]['武功等级' .. j]}
                    end
                end
            end
            if #kfmenu == 0 then
                DrawStrBoxWaitKey("目标无武功可学", C_WHITE, CC.DefaultFont)
                return 0
            end
            local r = Cat('菜单', kfmenu, #kfmenu, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            if r <= 0 then
                return 0
            end

            kfid = kfmenu[r][2]
            kflv = kfmenu[r][4]
            local kfmenu1 = {}
            if ts > JY.Base["武功数量"] then
                ts = JY.Base["武功数量"]
            end
            for j = 1, ts do
                local kn = '空白'
                if JY.Person[pid]['武功' .. j] > 0 then
                    kn = JY.Wugong[JY.Person[pid]['武功' .. j]]['名称']
                end
                kfmenu1[#kfmenu1 + 1] = {kn, j, 1}
                if JY.Person[pid]['武功' .. j] <= 0 then
                    break
                end
            end
            local r1 = Cat('菜单', kfmenu1, #kfmenu1, CC.ScreenW / 54.4, CC.ScreenH - CC.ScreenH / 12.8, C_WHITE,
                CC.FontSmall, 1)
            if r1 <= 0 then
                return 0
            end
            JY.Person[pid]['武功' .. kfmenu1[r1][2]] = kfid
            JY.Person[pid]['武功等级' .. kfmenu1[r1][2]] = kflv
            AddPersonAttrib(pid, '体力', -10)
            CurIDTXDH(WAR.CurID, 135, 1, '江左梅郎  麒麟之才', C_GOLD)
        end
    end
    return 1
end

-- 战斗蓄力
function War_ActupMenu()
    local p = WAR.CurID
    local id = WAR.Person[p]["人物编号"]
    local x0, y0 = WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"]
    local kf = JY.Person[id]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    --内轻特效1007
    if NeiGong_tx(id,1007) then 
        local wz = '蓄力成功'
        WAR.Actup[id] = 2
        if kf == 98 then 
            WAR.Defup[id] = 1
            WAR.HMGXL[id] = 1
            wz = "攻守兼备・蓄势待发"
        end
        if kf == 103 then 
            WAR.Defup[id] = 1
            wz = "龙之蓄力・象之防御"
        end
        if kf == 89 then 
            wz = "紫霞蓄势・连绵不绝"
        end
        CurIDTXDH(WAR.CurID, 85, 1, wz, LightGreen);
        return 1;
    -- 标主蓄力必成功
    elseif id == 0 then
        WAR.Actup[id] = 2
    -- NPC蓄力必成功
    elseif not isteam(id) then
        WAR.Actup[id] = 2
    -- 我方，赵敏在场必成功
    elseif ZDGH(WAR.CurID, 9736) then
        WAR.Actup[id] = 2
    -- 常态70%几率成功
    elseif JLSD(15, 85, id) then
        WAR.Actup[id] = 2
    end
    if WAR.Actup[id] ~= 2 then
        for i = 1, 10 do
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            DrawStrBox(-1, -1, "蓄力失败", C_GOLD, CC.DefaultFont)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    else
        CurIDTXDH(WAR.CurID, 85, 1, "蓄力成功", C_GOLD);
    end
    return 1
end
-- 战斗防御
function War_DefupMenu()
    local p = WAR.CurID
    local id = WAR.Person[p]["人物编号"]
    local x0, y0 = WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"]
    WAR.Defup[id] = 1
    Cls()
    -- local hb = GetS(JY.SubScene, x0, y0, 4)

    -- 太玄防御带蓄力
    --if Curr_NG(id, 102) then
    --    WAR.Actup[id] = 2;
    --    CurIDTXDH(WAR.CurID, 86, 1, "防御开始・太玄蓄力", C_RED);
    --    return 1;
    --end

    CurIDTXDH(WAR.CurID, 86, 1, "防御开始", LimeGreen);

    return 1
end

--设置人物的集气值，返回一个综合值以便循环刷新集气条
function GetJiqi()
	local num, total = 0, 0
	--无酒不欢：轻功对于人物集气的影响函数
	local function getnewmove(x)
		if x <= 0 then 
			return 0
		end
		return math.sqrt(x)
	end
	--老顾 集气
	local function getnewmove1(a, b)
		local x = (a * 2 + b) / 3
		if x > 7600 then
			return 4 + math.min((x - 5600) / 600, 3)
		elseif x > 3600 then
			return 3 + (x - 3600) / 600
		elseif x > 2000 then
			return 2 + (x - 2000) / 600
		elseif x > 800 then
			return 1 + (x - 800) / 600
		else
			return x / 400
		end
	end
	--无酒不欢：敌人集气随难度变化
	local function NPCjiqimod(nd)
		local x;
		if nd == 1 then
			return 0.8
		elseif nd == 2 then
			return 1.6
		elseif nd == 3 then
			return 1.8
		elseif nd == 4 then
			return 2.0
		end
	end
	local dgqb = {}			--记录独孤求败的数据
	local max_jq = 0		--记录全场最高集气	
	for i = 0, WAR.PersonNum - 1 do
		if not WAR.Person[i]["死亡"] then
			local id = WAR.Person[i]["人物编号"]	
            local kf_ng = JY.Person[id]['主运内功']
            local dkfcj_ng = JY.Wugong[kf_ng]['层级']	
            local kf_qg = JY.Person[id]['主运轻功']
            local dkfcj_qg = JY.Wugong[kf_qg]['层级']	
			WAR.Person[i].TimeAdd = (getnewmove(Qg(i)) + getnewmove1(JY.Person[id]["内力"], JY.Person[id]["内力最大值"]) + JY.Person[id]["体力"] / 30)
			
			WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd)
			--end									
			--5点集气集气 JY.Person[id]["防具"] == 61
			if WAR.Person[i].TimeAdd < 5 then
				WAR.Person[i].TimeAdd = 5
			end
            -- 内轻特效701
			if NeiGong_tx(id, 701) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + dkfcj_ng * 2
			end

			--主运葵花，集气速度+20%
			--萧半和觉醒
			if Curr_NG(id,105) or (match_ID_awakened(id, 189, 1) and Curr_NG(id, 105)) then
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * 1.2)
            end
			--
			--打狗阵
	        if WAR.ZDDH == 344 and isteam(id) == false then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
            end	
			
			--白秀全场集气-5
			for j = 0, WAR.PersonNum - 1 do
				if match_ID(WAR.Person[j]["人物编号"], 582) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 5
					break	
				end
			end
			
			--谢烟客全场集气-10
			for j = 0, WAR.PersonNum - 1 do
				if match_ID(WAR.Person[j]["人物编号"], 164) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 10
					break	
				end
			end
       
			--丁不三 丁不四
			
			for j = 0, WAR.PersonNum - 1 do
                local bsbs = 0
				if match_ID(WAR.Person[j]["人物编号"], 162) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 3
					bsbs = bsbs + 1	
				end
				if match_ID(WAR.Person[j]["人物编号"], 163) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 4
					bsbs = bsbs + 1
				end
			    if bsbs > 1 then
				    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 7		
				end
			end
				
            --百劫
            if WAR.PD['百劫'][id] ~= nil then 
                WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PD['百劫'][id]
            end			
			--运行天赋轻功
			if JY.Person[id]["主运轻功"] > 0 and JY.Person[id]["主运轻功"] == JY.Person[id]["天赋轻功"] then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
			end
			
			--胡斐，乔峰，集气+8
			if match_ID(id, 1) or match_ID(id, 9755) or match_ID(id, 539) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8
			end
			
			--风云再起，集气+6
			if match_ID(id, 9763) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 6
			end


            if WAR.PD['八酒杯'][id] ~= nil then 
                WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PD['八酒杯'][id]*4
            end
            
			--韦一笑，成昆，黄药师
			if match_ID(id, 14) or match_ID(id, 18) or match_ID(id, 57)  then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10
			end
			--一灯，重生后额外集气速度+5
			if match_ID(id, 65) and WAR.PD["复活"][id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end

			--王重阳，重生后额外集气速度+5
			if match_ID(id, 9787) and WAR.PD["复活"][id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
			end

			if WAR.PD["招式・集气加速1"][id] ~= nil  then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 1.1
			end
			if WAR.PD["招式・集气加速2"][id] ~= nil  then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 1.2
			end
			if WAR.PD["招式・集气加速3"][id] ~= nil  then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 1.3
			end
			if WAR.PD["招式・集气加速4"][id] ~= nil  then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 1.4
			end
			--万里独行 人越少集气越快
			if match_ID(id, 9962)  then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 4
					end
				end
			end
		  
			--公孙止，我方每死亡一个人，集气速度+2
			if match_ID(id, 616) then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == true and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
					end
				end
			end
            
			--司空摘星，敌方人越多集气速度越快
			if match_ID(id, 579) then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5
					end
				end
			end	

			--圣火三使，同时在场时，每人集气速度额外+20点
			if WAR.ZDDH == 14 and (id == 173 or id == 174 or id == 175) then
				local shz = 0
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						shz = shz + 1
					end
				end
				
				if shz == 3 then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
				end
			end
		  
			--蓝烟清：天罡北斗阵，集气+7
			if (id == 68 or id == 123 or id == 124 or id == 125 or id == 126 or id == 127 or id == 128) and WAR.Person[i]["我方"] == false then
			local s = 0
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and (WAR.Person[j]["人物编号"] == 68 or WAR.Person[j]["人物编号"] == 123 or WAR.Person[j]["人物编号"] == 124 or WAR.Person[j]["人物编号"] ==125 or WAR.Person[j]["人物编号"] == 126 or WAR.Person[j]["人物编号"] == 127 or WAR.Person[j]["人物编号"] == 128) then
                    s = s + 1
                end
            end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + s
			end
			
			if id==0 and (JY.Base["畅想"]==68 or JY.Base["畅想"]==123) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 1
			end
			
			--蓝烟清：真武七截阵，集气+7
			if (id == 532 or id == 533 or id == 534 or id == 535 or id == 536 or id == 537 or id == 538) and WAR.Person[i]["我方"] == false then
			local s = 0
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and (WAR.Person[j]["人物编号"] == 538 or WAR.Person[j]["人物编号"] == 533 or WAR.Person[j]["人物编号"] == 534 or WAR.Person[j]["人物编号"] ==535 or WAR.Person[j]["人物编号"] == 536 or WAR.Person[j]["人物编号"] == 537 or WAR.Person[j]["人物编号"] == 538) then
                    s = s + 1
                end
            end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + s
			end
			  
			--山洞妹妹给主角+2集气
			if id == 0 then
				for j = 0, WAR.PersonNum - 1 do
					if WAR.Person[j]["人物编号"] == 9981 and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
						WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 2
						break
					end
				end
			end
			
			if WAR.PD['徐如林'][id] ~= nil then 
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PD['徐如林'][id]
			end
			
			--主运太极神功，太极之形增加集气
			if NeiGong_tx(id, 1029) and WAR.PD["太极之形"][id] ~= nil then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PD["太极之形"][id]
			end
	      	--司空摘星挨打增加集气
	        if match_ID(id, 9740)  and  WAR.SKZX[id] ~= nil then
	       		WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.SKZX[id]
	        end			
			--主角论剑打赢东方奖励+8
			if id == 0 and CC.TX["东方不败奖励"] == 1 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8
			end
	  
			--平一指，集气速度额外加成5*杀人数
			if match_ID(id, 28) or match_ID(id, 9889) then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + WAR.PYZ * 5
			end

			local zqjq_jc = 0
			if JY.Person[id]["坐骑"] > 0 then
				local fb = 1
				if match_ID(id,131) then 
					fb = 2
				end
				--装备白马 1级加2集气，
				if JY.Person[id]["坐骑"] == 230 then
					local zqjq_jc = 2*fb
					if JY.Thing[230]["装备等级"] >= 5 then
						zqjq_jc = 4*fb
					elseif JY.Thing[230]["装备等级"] >= 3 then
						zqjq_jc = 3*fb
					end
					--李文秀的效果翻倍
					if match_ID(id, 590) then
						if match_ID(id,131) then 
							fb = 2
						end
						zqjq_jc = zqjq_jc * fb
					end
				end
				--装备毛驴 集气速度+10点
				if JY.Person[id]["坐骑"] == 279 then
					--WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 10;
					zqjq_jc = 5* fb
				end
				--装备飞云 集气速度+10点
				if JY.Person[id]["坐骑"] == 264 then
					--WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 12;
					zqjq_jc = 10* fb
				end			
				--装备青驴 集气速度+5点
				if JY.Person[id]["坐骑"] == 339 then
					--WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 5;
					zqjq_jc = 5* fb
				end
				--装备汗血宝马 集气速度+5点
				if JY.Person[id]["坐骑"] == 262 then
					--WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 8;
					zqjq_jc = 8* fb
				end			
				--瘦黄马，血量越低集气越快，50%血+5，0血+10
				if JY.Person[id]["坐骑"] == 284 and JY.Thing[284]["装备等级"] == 6 and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]/2 then
					local spd_add = 5;
					spd_add = spd_add + math.floor(JY.Person[id]["生命最大值"]/2 - JY.Person[id]["生命"]/100)
					--WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + spd_add;
					zqjq_jc = spd_add* fb
				end	
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd  + zqjq_jc
				--聂风
				if match_ID(id, 546) or match_ID(id, 9911) then
					WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd  + zqjq_jc
				end
			end
			--阿紫曼珠沙华，血量越低集气越快，100%血无加成，0血100%加成
			if match_ID(id, 9757) and WAR.PD["禁药状态"][id]~=nil then
				local bonus_perctge = 0
				bonus_perctge = 2 - JY.Person[id]["生命"] / JY.Person[id]["生命最大值"]
				WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd * bonus_perctge)
			end
            
			--秀若芝兰，每个外功+1集气
			if  match_ID(id, 9798) then
				local zzr = 0
				for i = 1, JY.Base["武功数量"] do
					if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] < 6 then
						zzr = zzr + 1
					end
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + zzr
			end	
			--天子观气			
			for j = 0, WAR.PersonNum - 1 do
				if match_ID(WAR.Person[j]["人物编号"], 9800) and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[i]["我方"] then
					WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*0.5 )
					break	
				end
			end	
		  		  			 
			--剑神，每个剑法到极，+2集气
			if JY.Base["标准"] == 3 and id == 0 then
				local jsyx = 0
				for i = 1, JY.Base["武功数量"] do
					if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 3 and JY.Person[id]["武功等级" .. i] == 999 then
						jsyx = jsyx + 1
					end
				end
				if jsyx > 7 then
					jsyx = 7
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + jsyx*2
			end
		  
			--李文秀，每个奇门到极，+2集气
			if match_ID(id, 590) then
				local lwx = 0
				for i = 1, JY.Base["武功数量"] do
					if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 5 and JY.Person[id]["武功等级" .. i] == 999 then
						lwx = lwx + 1
					end
				end
				if lwx > 7 then
					lwx = 7
				end
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + lwx*2
			end

            if WAR.PD['降龙・飞龙在天'][id] == 1 then
               -- WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*1.5)
            end
            --花铁杆，每行动一次，集气速度加一
			if id==0 and JY.Base["畅想"]==52 then
				WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd+WAR.HTG
	        end
			--内轻特效305 
			if NeiGong_tx(id,305)  then 
				WAR.Person[i].TimeAdd  = WAR.Person[i].TimeAdd + (dkfcj_ng*2)
			end	
			--内轻特效305 
			if NeiGong_tx(id,305,1)  then 
                WAR.Person[i].TimeAdd  = WAR.Person[i].TimeAdd + (dkfcj_qg*2)
			end	            
            -- 内轻特效1040 
            if NeiGong_tx(id, 1040) and WAR.LQZ[id] == 100 then
                WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd * 2
            end
            --下雪天集气-3
            if  CC.Weather[2][1] > 0 and CC.TX['战斗天气'] == 0  then 
                --踏雪无痕不减反增
                WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 3
            end
            --集气加成倍数
            local jqbs = 1

			--集气上限70点
			if WAR.Person[i].TimeAdd > 70 then
                --千变万劫
                if match_ID(id,9740) then
                    if WAR.Person[i].TimeAdd > 80 then 
                        WAR.Person[i].TimeAdd = 80
                    end
                else
				    WAR.Person[i].TimeAdd = 70
                end
			end     

            --神机营
            if match_ID(id,733) or match_ID(id,735)  or match_ID(id,734)   or match_ID(id,736)  then 
                WAR.Person[i].TimeAdd = math.modf(WAR.Person[i].TimeAdd*0.7)  
            end     	
			--集气下限10点
			if WAR.Person[i].TimeAdd < 10 and id ~= 591  then
				WAR.Person[i].TimeAdd = 10
			end	  
			--木桩不集气
			if id == 591 and WAR.ZDDH == 226 then
				WAR.Person[i].TimeAdd = 0
			end
			
			--李秋水的无相分身不集气
			if id == 600  then
				WAR.Person[i].TimeAdd = 0
			end
			if max_jq < WAR.Person[i].TimeAdd then
				max_jq = WAR.Person[i].TimeAdd
			end
	        --独孤求败
          	if match_ID(id, 592)  then
				dgqb = {i, WAR.Person[i].TimeAdd}
			end	  
			num = num + 1
			total = total + WAR.Person[i].TimeAdd
		end
	end
	     
  	--独孤求败集气锁定全场最高
	if dgqb[1] then
		if dgqb[2] < max_jq then
			total = total - WAR.Person[dgqb[1]].TimeAdd + max_jq + 1
			WAR.Person[dgqb[1]].TimeAdd = max_jq + 1
		end
	end
  
	--无酒不欢：这个返回值表达不明确，存疑
	WAR.LifeNum = num
	return math.modf(((total) / (num) + (num) - 2))
end

-- 武功范围选择
function War_KfMove(movefanwei, atkfanwei, wugong)
    local kind = movefanwei[1] or 0
    local len = movefanwei[2] or 0
    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
    local x = x0
    local y = y0
    if kind ~= nil then
        if kind == 0 then
            War_CalMoveStep(WAR.CurID, len, 1)
        elseif kind == 1 then
            War_CalMoveStep(WAR.CurID, len * 2, 1)
            for r = 1, len * 2 do
                for i = 0, r do
                    local j = r - i
                    if len < i or len < j then
                        SetWarMap(x0 + i, y0 + j, 3, 255)
                        SetWarMap(x0 + i, y0 - j, 3, 255)
                        SetWarMap(x0 - i, y0 + j, 3, 255)
                        SetWarMap(x0 - i, y0 - j, 3, 255)
                    end
                end
            end
        elseif kind == 2 then
            War_CalMoveStep(WAR.CurID, len, 1)
            for i = 1, len - 1 do
                for j = 1, len - 1 do
                    SetWarMap(x0 + i, y0 + j, 3, 255)
                    SetWarMap(x0 - i, y0 + j, 3, 255)
                    SetWarMap(x0 + i, y0 - j, 3, 255)
                    SetWarMap(x0 - i, y0 - j, 3, 255)
                end
            end
        elseif kind == 3 then
            War_CalMoveStep(WAR.CurID, 2, 1)
            SetWarMap(x0 + 2, y0, 3, 255)
            SetWarMap(x0 - 2, y0, 3, 255)
            SetWarMap(x0, y0 + 2, 3, 255)
            SetWarMap(x0, y0 - 2, 3, 255)
        else
            War_CalMoveStep(WAR.CurID, 0, 1)
        end
    end

    CleanWarMap(7, 0)

    while true do
        if JY.Restart == 1 then
            break
        end
        local x2 = x
        local y2 = y
        Cat('实时特效动画')
        WarDrawMap(1, x, y)
        if wugong == 26 then
            WarDrawAtt(x, y, atkfanwei, 4, nil, nil, nil, 1)
        else
            WarDrawAtt(x, y, atkfanwei, 4)
        end
        -- 判断合击，判断是否有合击者

        local ZHEN_ID = -1;
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and i ~= WAR.CurID and WAR.Person[i]["死亡"] ==
                false then
                local nx = WAR.Person[i]["坐标X"]
                local ny = WAR.Person[i]["坐标Y"]
                local fid = WAR.Person[i]["人物编号"]
                for j = 1, JY.Base["武功数量"] do
                    if JY.Person[fid]["武功" .. j] == wugong then
                        if math.abs(nx - x0) + math.abs(ny - y0) < 9 then
                            local flagx, flagy = 0, 0
                            if math.abs(nx - x0) <= 1 then
                                flagx = 1
                            end
                            if math.abs(ny - y0) <= 1 then
                                flagy = 1
                            end
                            if x0 == nx then
                                flagy = 1
                            end
                            if y0 == ny then
                                flagx = 1
                            end
                            if between(x, x0, nx, flagx) and between(y, y0, ny, flagy) then
                                -- 合击人的战场编号
                                ZHEN_ID = i
                                -- 绘画合击的范围
                                local tmp_id = WAR.CurID
                                WAR.CurID = ZHEN_ID
                                WarDrawAtt(WAR.Person[ZHEN_ID]["坐标X"] + x0 - x,
                                    WAR.Person[ZHEN_ID]["坐标Y"] + y0 - y, atkfanwei, 4)
                                SetWarMap(nx, ny, 7, 3)
                                WAR.CurID = tmp_id
                                break
                            end
                        end
                    end
                end
                if ZHEN_ID >= 0 then
                    break
                end
            end
        end

        WarDrawMap(1, x, y)
        WarShowHead(GetWarMap(x, y, 2))

        -- 合击人标识
        if ZHEN_ID ~= -1 then
            local nx = WAR.Person[ZHEN_ID]["坐标X"]
            local ny = WAR.Person[ZHEN_ID]["坐标Y"]
            local dx = nx - x0
            local dy = ny - y0
            local size = CC.FontSmall;
            local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
            local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2

            local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

            DrawString(rx - size * 1.5, ry - hb - size / 2, "合击者", M_DeepSkyBlue, size);
        end

        -- 显示可以覆盖的敌人信息
        for i = 0, CC.WarWidth - 1 do
            for j = 0, CC.WarHeight - 1 do
                local target = GetWarMap(i, j, 7)
                if target ~= nil and target == 2 then
                    if GetWarMap(i, j, 2) ~= nil and WAR.Person[GetWarMap(i, j, 2)]["人物编号"] ~= nil then
                        local x0 = WAR.Person[WAR.CurID]["坐标X"];
                        local y0 = WAR.Person[WAR.CurID]["坐标Y"];
                        local dx = i - x0
                        local dy = j - y0
                        local size = CC.FontSmall;
                        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
                        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2

                        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

                        ry = ry - hb - CC.ScreenH / 6;

                        if ry < 1 then -- 加上这个，防止看不到血的情况
                            ry = 1;
                        end

                        -- 显示选中人物的生命值
                        local color = RGB(245, 251, 5);
                        local hp = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["生命"] or 0;
                        local maxhp = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["生命最大值"] or 0;

                        -- local ns = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["受伤程度"] or 0;  --1018
                        local ns = WAR.PD['内伤状态'][WAR.Person[GetWarMap(i, j, 2)]["人物编号"]] or 0
                        local zd = JY.Person[WAR.Person[GetWarMap(i, j, 2)]["人物编号"]]["中毒程度"] or 0;
                        local len = #(string.format("%d/%d", hp, maxhp));
                        rx = rx - len * size / 4;
                        -- 颜色根据所受的内伤确定
                        if ns < 33 then
                            color = RGB(236, 200, 40)
                        elseif ns < 66 then
                            color = RGB(244, 128, 32)
                        else
                            color = RGB(232, 32, 44)
                        end

                        DrawString(rx, ry, string.format("%d", hp), color, size);
                        DrawString(rx + #string.format("%d", hp) * size / 2, ry, "/", C_GOLD, size);

                        if zd == 0 then
                            color = RGB(252, 148, 16)
                        elseif zd < 50 then
                            color = RGB(120, 208, 88)
                        else
                            color = RGB(56, 136, 36)
                        end
                        DrawString(rx + #string.format("%d", hp) * size / 2 + size / 2, ry, string.format("%d", maxhp),
                            color, size)
                    end
                end
            end
        end
        Cat('实时特效动画2')
        ShowScreen()
        CleanWarMap(7, 0)
        lib.Delay(CC.BattleDelay)
        local key, ktype, mx, my = lib.GetKey()

        if key == VK_UP then
            PlayWavE(77)
            y2 = y - 1
        elseif key == VK_DOWN then
            PlayWavE(77)
            y2 = y + 1
        elseif key == VK_LEFT then
            PlayWavE(77)
            x2 = x - 1
        elseif key == VK_RIGHT then
            PlayWavE(77)
            x2 = x + 1
        elseif (key == VK_SPACE or key == VK_RETURN) then
            PlayWavE(77)
            return x, y

        elseif key == VK_ESCAPE or ktype == 4 then
            PlayWavE(77)
            return nil
        elseif ktype == 2 or ktype == 3 then
            PlayWavE(77)
            mx = mx - CC.ScreenW / 2
            my = my - CC.ScreenH / 2
            mx = (mx) / CC.XScale
            my = (my) / CC.YScale
            mx, my = (mx + my) / 2, (my - mx) / 2
            if mx > 0 then
                mx = mx + 0.99
            else
                mx = mx - 0.01
            end
            if my > 0 then
                my = my + 0.99
            else
                mx = mx - 0.01
            end
            mx = math.modf(mx)
            my = math.modf(my)
            for i = 1, 20 do
                if mx + i > 63 or my + i > 63 then
                    return;
                end
                local hb = GetS(JY.SubScene, mx + i, my + i, 4)

                if math.abs(hb - CC.YScale * i * 2) < 8 then
                    mx = mx + i
                    my = my + i
                end
            end

            x2, y2 = mx + x0, my + y0
            if ktype == 3 and (kind < 2 or x ~= x0 or y ~= y0) then
                return x, y
            end

        end
        if x2 >= 0 and x2 < CC.WarWidth and y2 >= 0 and y2 < CC.WarHeight then
            if GetWarMap(x2, y2, 3) ~= nil and GetWarMap(x2, y2, 3) < 128 then
                x = x2
                y = y2
            end
        end
    end
end
-- WarDrawAtt
-- xl为降龙的范围显示
function WarDrawAtt(x, y, fanwei, flag, cx, cy, atk, xl)
    local x0, y0 = nil, nil
    if cx == nil or cy == nil then
        x0 = WAR.Person[WAR.CurID]["坐标X"]
        y0 = WAR.Person[WAR.CurID]["坐标Y"]
    else
        x0, y0 = cx, cy
    end
    local kind = fanwei[1] -- 攻击范围
    local len1 = fanwei[2]
    local len2 = fanwei[3]
    local len3 = fanwei[4]
    local len4 = fanwei[5]
    local xy = {}
    local num = 0
    if kind == 0 then
        num = 1
        xy[1] = {x, y}
    elseif kind == 1 then
        if not len1 then
            len1 = 0
        end
        if not len2 then
            len2 = 0
        end
        num = num + 1
        xy[num] = {x, y}
        for i = 1, len1 do
            xy[num + 1] = {x + i, y}
            xy[num + 2] = {x - i, y}
            xy[num + 3] = {x, y + i}
            xy[num + 4] = {x, y - i}
            num = num + 4
        end
        for i = 1, len2 do
            xy[num + 1] = {x + i, y + i}
            xy[num + 2] = {x - i, y - i}
            xy[num + 3] = {x - i, y + i}
            xy[num + 4] = {x + i, y - i}
            num = num + 4
        end
    elseif kind == 2 then
        for tx = x - len1, x + len1 do
            for ty = y - len1, y + len1 do
                if len1 < math.abs(tx - x) + math.abs(ty - y) then

                else
                    num = num + 1
                    xy[num] = {tx, ty}
                end

            end
        end
    elseif kind == 3 then
        if not len2 then
            len2 = len1
        end
        local dx, dy = math.abs(x - x0), math.abs(y - y0)
        if dy < dx then
            len1, len2 = len2, len1
        end
        for tx = x - len1, x + len1 do
            for ty = y - len2, y + len2 do
                num = num + 1
                xy[num] = {tx, ty}
            end
        end
    elseif kind == 5 then
        if not len1 then
            len1 = 0
        end
        if not len2 then
            len2 = 0
        end
        num = num + 1
        xy[num] = {x, y}
        for i = 1, len1 do
            xy[num + 1] = {x + i, y}
            xy[num + 2] = {x - i, y}
            xy[num + 3] = {x, y + i}
            xy[num + 4] = {x, y - i}
            num = num + 4
        end
        if len2 > 0 then
            xy[num + 1] = {x + 1, y + 1}
            xy[num + 2] = {x + 1, y - 1}
            xy[num + 3] = {x - 1, y + 1}
            xy[num + 4] = {x - 1, y - 1}
            num = num + 4
        end
        for i = 2, len2 do
            xy[num + 1] = {x + i, y + 1}
            xy[num + 2] = {x - i, y - 1}
            xy[num + 3] = {x - i, y + 1}
            xy[num + 4] = {x + i, y - 1}
            xy[num + 5] = {x + 1, y + i}
            xy[num + 6] = {x - 1, y - i}
            xy[num + 7] = {x - 1, y + i}
            xy[num + 8] = {x + 1, y - i}
            num = num + 8
        end
    elseif kind == 6 then
        if not len2 then
            len2 = len1
        end
        xy[1] = {x + 1, y}
        xy[2] = {x - 1, y}
        xy[3] = {x, y + 1}
        xy[4] = {x, y - 1}
        num = num + 4
        if len1 > 0 or len2 > 0 then
            xy[5] = {x + 1, y + 1}
            xy[6] = {x + 1, y - 1}
            xy[7] = {x - 1, y + 1}
            xy[8] = {x - 1, y - 1}
            num = num + 4
            for i = 2, len1 do
                xy[num + 1] = {x + i, y + 1}
                xy[num + 2] = {x - i, y + 1}
                xy[num + 3] = {x + i, y - 1}
                xy[num + 4] = {x - i, y - 1}
                num = num + 4
            end
            for i = 2, len2 do
                xy[num + 1] = {x + 1, y + i}
                xy[num + 2] = {x + 1, y - i}
                xy[num + 3] = {x - 1, y + i}
                xy[num + 4] = {x - 1, y - i}
                num = num + 4
            end
        end
    elseif kind == 7 then
        if not len2 then
            len2 = len1
        end
        if len1 == 0 then
            for i = y - len2, y + len2 do
                num = num + 1
                xy[num] = {x, i}
            end
        elseif len2 == 0 then
            for i = x - len1, x + len1 do
                num = num + 1
                xy[num] = {i, y}
            end
        else
            for i = x - len1, x + len1 do
                num = num + 1
                xy[num] = {i, y}
                num = num + 1
                xy[num] = {i, y + len2}
                num = num + 1
                xy[num] = {i, y - len2}
            end
            for i = 1, len2 - 1 do
                xy[num + 1] = {x, y + i}
                xy[num + 2] = {x, y - i}
                xy[num + 3] = {x - len1, y + i}
                xy[num + 4] = {x - len1, y - i}
                xy[num + 5] = {x + len1, y + i}
                xy[num + 6] = {x + len1, y - i}
                num = num + 6
            end
        end
    elseif kind == 8 then
        xy[1] = {x, y}
        num = 1
        for i = 1, len1 do
            xy[num + 1] = {x + i, y}
            xy[num + 2] = {x - i, y}
            xy[num + 3] = {x, y + i}
            xy[num + 4] = {x, y - i}
            xy[num + 5] = {x + i, y + len1}
            xy[num + 6] = {x - i, y - len1}
            xy[num + 7] = {x + len1, y - i}
            xy[num + 8] = {x - len1, y + i}
            num = num + 8
        end
    elseif kind == 9 then
        xy[1] = {x, y}
        num = 1
        for i = 1, len1 do
            xy[num + 1] = {x + i, y}
            xy[num + 2] = {x - i, y}
            xy[num + 3] = {x, y + i}
            xy[num + 4] = {x, y - i}
            xy[num + 5] = {x - i, y + len1}
            xy[num + 6] = {x + i, y - len1}
            xy[num + 7] = {x + len1, y + i}
            xy[num + 8] = {x - len1, y - i}
            num = num + 8
        end
    elseif x == x0 and y == y0 then
        return 0
    elseif kind == 10 then
        if not len2 then
            len2 = 0
        end
        if not len3 then
            len3 = 0
        end
        if not len4 then
            len4 = 0
        end
        local fx, fy = x - x0, y - y0
        if fx > 0 then
            fx = 1
        elseif fx < 0 then
            fx = -1
        end
        if fy > 0 then
            fy = 1
        elseif fy < 0 then
            fy = -1
        end
        local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
        dx1 = -(dx1 + fx) / 2
        dx2 = -(dx2 + fx) / 2
        dy1 = -(dy1 + fy) / 2
        dy2 = -(dy2 + fy) / 2
        if dx1 > 0 then
            dx1 = 1
        elseif dx1 < 0 then
            dx1 = -1
        end
        if dx2 > 0 then
            dx2 = 1
        elseif dx2 < 0 then
            dx2 = -1
        end
        if dy1 > 0 then
            dy1 = 1
        elseif dy1 < 0 then
            dy1 = -1
        end
        if dy2 > 0 then
            dy2 = 1
        elseif dy2 < 0 then
            dy2 = -1
        end
        for i = 0, len1 - 1 do
            num = num + 1
            xy[num] = {x + i * fx, y + i * fy}
        end
        for i = 0, len2 - 1 do
            num = num + 1
            xy[num] = {x + dx1 + i * fx, y + dy1 + i * fy}
            num = num + 1
            xy[num] = {x + dx2 + i * fx, y + dy2 + i * fy}
        end
        for i = 0, len3 - 1 do
            num = num + 1
            xy[num] = {x + 2 * dx1 + i * fx, y + 2 * dy1 + i * fy}
            num = num + 1
            xy[num] = {x + 2 * dx2 + i * fx, y + 2 * dy2 + i * fy}
        end
        for i = 0, len4 - 1 do
            num = num + 1
            xy[num] = {x + 3 * dx1 + i * fx, y + 3 * dy1 + i * fy}
            num = num + 1
            xy[num] = {x + 3 * dx2 + i * fx, y + 3 * dy2 + i * fy}
        end
    elseif kind == 11 then
        local fx, fy = x - x0, y - y0
        if fx > 1 then
            fx = 1
        elseif fx < -1 then
            fx = -1
        end
        if fy > 1 then
            fy = 1
        elseif fy < -1 then
            fy = -1
        end
        local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
        if fx ~= 0 and fy ~= 0 then
            dx1 = -(dx1 + fx) / 2
            dx2 = -(dx2 + fx) / 2
            dy1 = -(dy1 + fy) / 2
            dy2 = -(dy2 + fy) / 2
            len1 = math.modf(len1 * 0.7071)
            for i = 0, len1 do
                num = num + 1
                xy[num] = {x + i * fx, y + i * fy}
                for j = 1, 2 * i + 1 do
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
                end
            end
        else
            for i = 0, len1 do
                num = num + 1
                xy[num] = {x + i * fx, y + i * fy}
                for j = 1, len1 - i do
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
                end
            end
        end
    elseif kind == 12 then
        local fx, fy = x - x0, y - y0
        if fx > 1 then
            fx = 1
        elseif fx < -1 then
            fx = -1
        end
        if fy > 1 then
            fy = 1
        elseif fy < -1 then
            fy = -1
        end
        local dx1, dy1, dx2, dy2 = -fy, fx, fy, -fx
        if fx ~= 0 and fy ~= 0 then
            dx1 = (dx1 + fx) / 2
            dx2 = (dx2 + fx) / 2
            dy1 = (dy1 + fy) / 2
            dy2 = (dy2 + fy) / 2
            len1 = math.modf(len1 * 1.41421)
            for i = 0, len1 do
                if i <= len1 / 2 then
                    num = num + 1
                    xy[num] = {x + i * fx, y + i * fy}
                end
                for j = 1, len1 - i * 2 do
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
                end
            end
        else
            for i = 0, len1 do
                num = num + 1
                xy[num] = {x + i * fx, y + i * fy}
                for j = 1, i do
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx1), y + i * fy + j * (dy1)}
                    num = num + 1
                    xy[num] = {x + i * fx + j * (dx2), y + i * fy + j * (dy2)}
                end
            end
        end
    elseif kind == 13 then
        local fx, fy = x - x0, y - y0
        if fx > 1 then
            fx = 1
        elseif fx < -1 then
            fx = -1
        end
        if fy > 1 then
            fy = 1
        elseif fy < -1 then
            fy = -1
        end
        local xx = x + fx * len1
        local yy = y + fy * len1
        for tx = xx - len1, xx + len1 do
            for ty = yy - len1, yy + len1 do
                if len1 < math.abs(tx - xx) + math.abs(ty - yy) then
                    break
                end
                num = num + 1
                xy[num] = {tx, ty}
            end
        end
    else
        return 0
    end

    -- 降龙的范围
    if xl then
        local xl_x = WAR.Person[WAR.CurID]["坐标X"]
        local xl_y = WAR.Person[WAR.CurID]["坐标Y"]
        for i = 1, 11, 2 do
            for j = 1, 11, 2 do
                num = num + 1
                xy[num] = {xl_x - i, xl_y + j}
                num = num + 1
                xy[num] = {xl_x - i, xl_y - j}
                num = num + 1
                xy[num] = {xl_x + i, xl_y + j}
                num = num + 1
                xy[num] = {xl_x + i, xl_y - j}
            end
        end
    end

    if flag == 1 then
        local thexy = function(nx, ny, x, y)
            local dx, dy = nx - x, ny - y
            local hb = lib.GetS(JY.SubScene, nx, ny, 4)
            return CC.ScreenW / 2 + CC.XScale * (dx - dy), CC.ScreenH / 2 + CC.YScale * (dx + dy) - hb
        end

        for i = 1, num do
            if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
                local tx, ty = thexy(xy[i][1], xy[i][2], x0, y0)

                if GetWarMap(xy[i][1], xy[i][2], 2) ~= nil and GetWarMap(xy[i][1], xy[i][2], 2) >= 0 and
                    GetWarMap(xy[i][1], xy[i][2], 2) ~= WAR.CurID then
                    if not isteam(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]) and
                        WAR.Person[WAR.CurID]["我方"] then
                        local x0 = WAR.Person[WAR.CurID]["坐标X"];
                        local y0 = WAR.Person[WAR.CurID]["坐标Y"];
                        local dx = xy[i][1] - x0
                        local dy = xy[i][2] - y0
                        local size = CC.FontSmall;
                        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
                        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2

                        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

                        ry = ry - hb - CC.ScreenH / 6;

                        if ry < 1 then -- 加上这个，防止看不到血的情况
                            ry = 1;
                        end

                        -- 显示选中人物的生命值
                        local color = RGB(245, 251, 5);
                        local hp = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["生命"];
                        local maxhp =
                            JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["生命最大值"];

                        -- local ns = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["受伤程度"]; --1018
                        local ns = WAR.PD['内伤状态'][WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]

                        local zd = JY.Person[WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]]["中毒程度"];
                        local len = #(string.format("%d/%d", hp, maxhp));
                        rx = rx - len * size / 4;

                        -- 颜色根据所受的内伤确定
                        if ns < 33 then
                            color = RGB(236, 200, 40)
                        elseif ns < 66 then
                            color = RGB(244, 128, 32)
                        else
                            color = RGB(232, 32, 44)
                        end

                        DrawString(rx, ry, string.format("%d", hp), color, size);
                        DrawString(rx + #string.format("%d", hp) * size / 2, ry, "/", C_GOLD, size);

                        if zd == 0 then
                            color = RGB(252, 148, 16)
                        elseif zd < 50 then
                            color = RGB(120, 208, 88)
                        else
                            color = RGB(56, 136, 36)
                        end
                        DrawString(rx + #string.format("%d", hp) * size / 2 + size / 2, ry, string.format("%d", maxhp),
                            color, size)
                    end

                    -- lib.PicLoadCache(0, 0, tx, ty, 2, 200)
                else
                    -- lib.PicLoadCache(0, 0, tx, ty, 2, 112)
                end

            end
        end

    elseif flag == 2 then
        local diwo = WAR.Person[WAR.CurID]["我方"]
        local atknum = 0
        for i = 1, num do
            if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
                local id = GetWarMap(xy[i][1], xy[i][2], 2)

                if id ~= -1 and id ~= WAR.CurID then
                    local xa, xb, xc = nil, nil, nil
                    local e_diwo = WAR.Person[id]["我方"]
                    -- 张家辉的隐身戒指
                    if (JY.Person[WAR.Person[id]["人物编号"]]["防具"] == 304 and WAR.YSJZ == 0) then
                        e_diwo = diwo
                    end

                    if diwo ~= e_diwo then
                        xa = 2
                    else
                        xa = 0
                    end

                    if WAR.PD["混乱状态"][WAR.Person[WAR.CurID]["人物编号"]] ~= nil then
                        if e_diwo == diwo and math.random(100) <= 40 then
                            xa = 2
                        end
                        if e_diwo ~= diwo and math.random(100) <= 40 then
                            xa = 0
                        end
                    end

                    local hp = JY.Person[WAR.Person[id]["人物编号"]]["生命"]
                    if hp < atk / 6 then
                        xb = 2
                    elseif hp < atk / 3 then
                        xb = 1
                    else
                        xb = 0
                    end
                    local danger = JY.Person[WAR.Person[id]["人物编号"]]["内力最大值"]
                    xc = danger / 500
                    atknum = atknum + xa * math.modf(xb * (xc) + 5)
                end
            end
        end
        return atknum
    elseif flag == 3 then
        for i = 1, num do
            if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
                SetWarMap(xy[i][1], xy[i][2], 4, 1)
            end
        end
        -- 武功选择范围
    elseif flag == 4 then
        for i = 1, num do
            if xy[i][1] >= 0 and xy[i][1] < CC.WarWidth and xy[i][2] >= 0 and xy[i][2] < CC.WarHeight then
                if GetWarMap(xy[i][1], xy[i][2], 2) ~= nil and GetWarMap(xy[i][1], xy[i][2], 2) >= 0 then
                    -- 是否学有迷踪步
                    -- 自动不触发
                    local eid = WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]
                    if match_ID(eid, 498) and math.random(10) < 4 and WAR.Person[WAR.CurID]["我方"] ~=
                        WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
                        -- 用李寻欢的品德作为触蜻蜓三抄水的判定
                        JY.Person[498]["品德"] = 30
                    end
                    -- 小昭影步
                    if match_ID(eid, 66) and WAR.Person[WAR.CurID]["我方"] ~=
                        WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
                        -- 用小昭的品德作为触发影步的判定
                        JY.Person[66]["品德"] = 90
                    end
                    -- 畅想张无忌逆转乾坤
                    -- 自动不触发
                    if match_ID(eid, 9990)  and WAR.AutoFight == 0 and WAR.Person[WAR.CurID]["我方"] ~=
                        WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["我方"] then
                        -- 基础35%几率
                        local chance = 36
                        -- 每本天书+1几率
                        chance = chance + JY.Base["天书数量"]
                        if WAR.LQZ[0] == 100 then
                            chance = chance + 10
                        end
                        if JLSD(0, chance, eid) then
                            lib.Debug('触发逆转乾坤1')
                            --WAR.PD['逆转乾坤'][eid] = 1
                            CC.TX['逆转乾坤'] = 1
                        end
                    end

                    -- 命中的敌方的点为2
                    if not isteam(WAR.Person[GetWarMap(xy[i][1], xy[i][2], 2)]["人物编号"]) and
                        WAR.Person[WAR.CurID]["我方"] then
                        SetWarMap(xy[i][1], xy[i][2], 7, 2)
                    else
                        SetWarMap(xy[i][1], xy[i][2], 7, 1)
                    end
                else
                    SetWarMap(xy[i][1], xy[i][2], 7, 1)
                end
            end
        end
    end
end
PNLBD = {}
-- 招亲郭靖
PNLBD[76] = function()
    JY.Person[683]["武功1"] = 26
    JY.Person[683]["武功等级1"] = 600
    JY.Person[683]["武功2"] = 15
    JY.Person[683]["武功等级2"] = 500
    JY.Person[683]["武功3"] = 107
    JY.Person[683]["武功等级3"] = 50
end

PNLBD[68] = function()
    JY.Person[684]["防具"] = 58
end

PNLBD[185] = function()
    JY.Person[684]["防具"] = 63
end

-- 神正杨过单金轮
PNLBD[275] = function()
    JY.Person[62]["武功3"] = 169
    JY.Person[62]["武功等级3"] = 999
end

-- boss 占位暴怒
function BOSSBF(id, x, y)
    local pid = WAR.Person[id]['人物编号']
    if r == 1 then
        return
    end
    local s = WAR.CurID
    WAR.CurID = id
    -- 1绿色，2红色，3蓝色，4紫色
    CleanWarMap(6, -1);

    local QMDJ = {"天", "地", "人", "鬼"}

    -- 在自身周围绘制奇阵
    SetWarMap(x, y, 4, math.random(4));

    for j = 1, 2 do
        SetWarMap(x + math.random(4), y + math.random(4), 4, math.random(4));
        for n = 30, 100 do
            local i = n
            if i > 100 then
                i = 100
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end

    end

    for j = 3, 4 do
        SetWarMap(x + math.random(4), y - math.random(4), 4, math.random(4));
        for n = 30, 100 do
            local i = n
            if i > 100 then
                i = 100
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    for j = 5, 6 do
        SetWarMap(x - math.random(4), y - math.random(4), 4, math.random(4));
        for n = 30, 100 do
            local i = n
            if i > 100 then
                i = 100
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    for j = 7, 8 do
        SetWarMap(x - math.random(4), y + math.random(4), 4, math.random(4));
        for n = 30, 100 do
            local i = n
            if i > 100 then
                i = 100
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    WAR.CurID = s
end

-- 黄蓉：奇门遁甲
function WarNewLand(id, x, y)
    if WAR.ZDDH == 226 then
        return
    end
    local pid = WAR.Person[id]['人物编号']
    local r = LGMsgBox("奇门遁甲", "是否要开启奇门遁甲？", {"否", "是"}, 2, pid)
    if r == 1 then
        return
    end
    local s = WAR.CurID
    WAR.CurID = id
    -- 1绿色，2红色，3蓝色，4紫色
    CleanWarMap(6, -1);

    local QMDJ = {"休", "生", "伤", "杜", "景", "死", "惊", "开"}

    -- 在自身周围绘制奇阵
    SetWarMap(x, y, 6, math.random(4));

    for j = 1, 2 do
        SetWarMap(x + math.random(6), y + math.random(6), 6, math.random(4));
        for n = 30, 40 do
            local i = n
            if i > 40 then
                i = 40
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end

    end

    for j = 3, 4 do
        SetWarMap(x + math.random(6), y - math.random(6), 6, math.random(4));
        for n = 30, 40 do
            local i = n
            if i > 40 then
                i = 40
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    for j = 5, 6 do
        SetWarMap(x - math.random(6), y - math.random(6), 6, math.random(4));
        for n = 30, 40 do
            local i = n
            if i > 40 then
                i = 40
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    for j = 7, 8 do
        SetWarMap(x - math.random(6), y + math.random(6), 6, math.random(4));
        for n = 30, 40 do
            local i = n
            if i > 40 then
                i = 40
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            NewDrawString(-1, -1, QMDJ[j], C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    WAR.CurID = s
end

-- 山洞妹妹，布阵
function buzhen()
    if not inteam(92) then
        return
    end
    if WAR.ZDDH == 226 then
        return
    end
    local line = "要布置阵型吗？";
    local tiles = 2;
    if (WAR.ZDDH == 133 or WAR.ZDDH == 134) and WAR.MCRS == 1 then
        if JY.Person[0]["性别"] == 0 then
            line = "哥哥你真勇敢，一个人挑战十五大高手，请千万小心。"
        else
            line = "姐姐你真勇敢，一个人挑战十五大高手，请千万小心。"
        end
        tiles = 4
    end
    say(line, 92, 0, JY.Person[92]["姓名"])
    if not DrawStrBoxYesNo(-1, -1, "要布置阵型吗？", C_WHITE, CC.DefaultFont) then
        return
    end
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] then
            WAR.CurID = i
            WAR.ShowHead = 1
            WarDrawMap(0)
            -- 布阵统一为2格
            WAR.Person[WAR.CurID]["移动步数"] = tiles
            War_CalMoveStep(WAR.CurID, tiles, 0)
            local x, y = nil, nil
            while true do
                if JY.Restart == 1 then
                    break
                end
                x, y = War_SelectMove()
                if x ~= nil then

                    WAR.ShowHead = 0
                    War_MovePerson(x, y)
                    break
                end
            end
        end
    end
end

-- 无酒不欢：在自身位置播放动画的函数
function CurIDTXDH(id, eft, order, str, strColor, endFrame)
    -- 增加文字颜色控制
    if strColor == nil then
        strColor = C_GOLD
    end
    -- 增加强制结束帧
    if endFrame == nil then
        endFrame = CC.Effect[eft]
    end
    local x0, y0 = WAR.Person[id]["坐标X"], WAR.Person[id]["坐标Y"]
    local hb = GetS(JY.SubScene, x0, y0, 4)
    local starteft = 0

    for i = 0, eft - 1 do
        starteft = starteft + CC.Effect[i]
    end
    local px = 0
    local py = 0

    -- 霸体画位置
    if eft == 118 then
        py = -CC.YScale * 34
    end
    if eft == 200 then
        -- py = y0 - CC.YScale * 34
    end
    -- local ssid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
    for ii = 1, endFrame, order do
        lib.GetKey()
        Cat('实时特效动画')
        WarDrawMap(6, 0, 0, (starteft + ii) * 2, nil, 3)
        Cat('实时特效动画2')
        if str ~= nil then
            DrawString(-1, CC.ScreenH / 2 - hb, str, strColor, CC.DefaultFont)
        end
        ShowScreen()
        lib.Delay(CC.BattleDelay)
        -- lib.LoadSur(ssid, 0, 0)
    end
    -- lib.FreeSur(ssid)
    Cls()
end

function WE_xy(x, y, id)
    if id ~= nil then
        War_CalMoveStep(id, 128, 0)
    else
        CleanWarMap(3, 0)
    end
    if GetWarMap(x, y, 3) ~= 255 and War_CanMoveXY(x, y, 0) then
        return x, y
    else
        for s = 1, 128 do
            for i = 1, s do
                local j = s - i
                if x + i < 63 and y + j < 63 and GetWarMap(x + i, y + j, 3) ~= 255 and War_CanMoveXY(x + i, y + j, 0) then
                    return x + i, y + j
                end
                if x + j < 63 and y - i > 0 and GetWarMap(x + j, y - i, 3) ~= 255 and War_CanMoveXY(x + j, y - i, 0) then
                    return x + j, y - i
                end
                if x - i > 0 and y - j > 0 and GetWarMap(x - i, y - j, 3) ~= 255 and War_CanMoveXY(x - i, y - j, 0) then
                    return x - i, y - j
                end
                if x - j > 0 and y + i < 63 and GetWarMap(x - j, y + i, 3) ~= 255 and War_CanMoveXY(x - j, y + i, 0) then
                    return x - j, y + i
                end
            end
        end
    end
    for s = 1, 128 do
        for i = 1, s do
            local j = s - i
            if x + i < 63 and y + j < 63 and War_CanMoveXY(x + i, y + j, 0) then
                return x + i, y + j
            end
            if x + j < 63 and y - i > 0 and War_CanMoveXY(x + j, y - i, 0) then
                return x + j, y - i
            end
            if x - i > 0 and y - j > 0 and War_CanMoveXY(x - i, y - j, 0) then
                return x - i, y - j
            end
            if x - j > 0 and y + i < 63 and War_CanMoveXY(x - j, y + i, 0) then
                return x - j, y + i
            end
        end
    end
    return x, y
end

-- 计算暗器伤害
function War_AnqiHurt(pid, emeny, thingid)
    local emenyid = WAR.Person[emeny]['人物编号']
    local eid = emenyid
    local num = nil
    local dam = nil
    local kd = JY.Person[emenyid]["抗毒能力"]
    if WAR.PD['内伤状态'][emenyid] == nil then
        WAR.PD['内伤状态'][emenyid] = 0
    end

    -- if JY.Person[emenyid]["受伤程度"] == 0 then  --1018
    if WAR.PD['内伤状态'][emenyid] == 0 then
        num = JY.Thing[thingid]["加生命"] / 2 - Rnd(3)
        -- elseif JY.Person[emenyid]["受伤程度"] <= 33 then
    elseif WAR.PD['内伤状态'][emenyid] <= 33 then
        num = math.modf(JY.Thing[thingid]["加生命"] * 2 / 3) - Rnd(3)
        -- elseif JY.Person[emenyid]["受伤程度"] <= 66 then --1018
    elseif WAR.PD['内伤状态'][emenyid] <= 66 then
        num = JY.Thing[thingid]["加生命"] - Rnd(3)
    else
        num = math.modf(JY.Thing[thingid]["加生命"] * 4 / 3) - Rnd(3)
    end

    num = math.modf(num - JY.Person[pid]["暗器技巧"] / 4 + JY.Person[emenyid]["暗器技巧"] / 4)

    dam = num * WAR.AQBS

    dam = dam * (0.1 + (JY.Person[emenyid]["畅想分阶"] * 0.2))

    Cat('挪移闪避', 0)

    -- 闪避不受伤害
    if WAR.Miss[emenyid] == 1 then
        return 0
    end

    -- 集气位置低于0不受伤害
    --if Curr_NG(emenyid, 238) and WAR.Person[emeny].Time < 0 then
    --内轻特效1019
    if NeiGong_tx(eid,1019) and  WAR.Person[emeny].Time < 0 then
        return 0
    end

    -- 霸体 定乾坤不受伤害
    if WAR.PD["霸体"][emenyid] ~= nil or WAR.PD["定乾坤"][emenyid] then
        return 0
    end
    if WAR.Weakspot[emenyid] ~= nil and Pmiji(emenyid, 73) then
        return 0
    end
    if WAR.PD["逆水寒"][emenyid] ~= nil then
        return 0
    end
    -- 文泰来不受伤害
    if WAR.WTL_PJTL[emenyid] ~= nil then
        return 0
    end
    if WAR.PD["亦复如是"][emenyid] == 1 then
        return 0
    end

    dam = math.modf(dam) -- 标记修改
    --    if Curr_NG(eid,152) then

    if WAR.PD['护盾值'][emenyid] ~= nil and WAR.PD['护盾值'][emenyid] > 0 then
        if dam < WAR.PD['护盾值'][emenyid] then
            WAR.PD['护盾值'][emenyid] = WAR.PD['护盾值'][emenyid] - dam
            dam = 0
        else
            dam = dam - WAR.PD['护盾值'][emenyid]
            WAR.PD['护盾值'][emenyid] = nil
            Cat('护盾停止', emeny)
        end
    end
    if dam == nil or dam == 0 then
        return 0
    end

    if WAR.PD['六阳正气'][emenyid] ~= nil then
        kd = kd + WAR.PD['六阳正气'][emenyid]
    end

    if myns(emeny) == false then
        -- WAR.Person[emeny]["内伤点数"] = AddPersonAttrib(emenyid, "受伤程度", math.modf(-num / 6)) 1018
        WAR.Person[emeny]["内伤点数"] = (WAR.PD['内伤状态'][emenyid] or 0) - math.modf(-num / 6)
    end

    local r = AddPersonAttrib(emenyid, "生命", math.modf(dam))

    fuhuo(emeny, 1)

    if JY.Person[emenyid]["生命"] <= 0 then
        WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 150
        -- 心魔战
        local eid = emenyid
        if inteam(eid) == false and WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[emeny]['我方'] and
            JY.Person[eid]["生命"] <= 0 then
            if eid == 512 then
                JY.Person[512]["品德"] = 2
                JY.Person[502]["声望"] = JY.Person[502]["声望"] + 5
                if JY.Person[502]["声望"] > 1500 then
                    JY.Person[502]["声望"] = 1500
                end
                AddPersonAttrib(pid, "物品修炼点数", 10000)
                AddPersonAttrib(pid, '武学点数', 100)
                DrawStrBoxWaitKey("我方获得武学点数100点", C_ORANGE, CC.DefaultFont)
            end
        end
    end

    if JY.Thing[thingid]["加中毒解毒"] > 0 and myzd(emeny) == false then
        num = math.modf(JY.Thing[thingid]["加中毒解毒"] + JY.Person[pid]["暗器技巧"] / 4)
        num = num - kd
        num = limitX(num, 0, CC.PersonAttribMax["用毒能力"])
        WAR.Person[emeny]["中毒点数"] = AddPersonAttrib(emenyid, "中毒程度", num)
    end

    -- 沉睡状态的敌人会醒来
    if WAR.PD["沉睡状态"][emenyid] ~= nil then
        WAR.PD["沉睡状态"][emenyid] = nil
    end
    WAR.TXXS[emenyid] = 1
    -- Cat('数值显示')
    return r
end

-- 计算从(x,y)开始攻击最多能够击中几个敌人
function War_AutoCalMaxEnemy(x, y, wugongid, level)
    local wugongtype = JY.Wugong[wugongid]["攻击范围"]
    local movescope = JY.Wugong[wugongid]["移动范围" .. level]
    local fightscope = JY.Wugong[wugongid]["杀伤范围" .. level]
    local maxnum = 0
    local xmax, ymax = nil, nil
    if wugongtype == 0 or wugongtype == 3 then
        local movestep = War_CalMoveStep(WAR.CurID, movescope, 1) -- 计算武功移动步数
        for i = 1, movescope do
            local step_num = movestep[i].num
            if step_num == 0 then
                break
            end
            for j = 1, step_num do
                local xx = movestep[i].x[j]
                local yy = movestep[i].y[j]
                local enemynum = 0
                for n = 0, WAR.PersonNum - 1 do
                    if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~=
                        WAR.Person[WAR.CurID]["我方"] then
                        local x = math.abs(WAR.Person[n]["坐标X"] - xx)
                        local y = math.abs(WAR.Person[n]["坐标Y"] - yy)
                    end
                    if x <= fightscope and y <= fightscope then
                        enemynum = enemynum + 1
                    end
                end
                if maxnum < enemynum then
                    maxnum = enemynum
                    xmax = xx
                    ymax = yy
                end
            end
        end
    elseif wugongtype == 1 then
        for direct = 0, 3 do
            local enemynum = 0
            for i = 1, movescope do
                local xnew = x + CC.DirectX[direct + 1] * i
                local ynew = y + CC.DirectY[direct + 1] * i
                if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
                    local id = GetWarMap(xnew, ynew, 2)
                end
                if id >= 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[id]["我方"] then
                    enemynum = enemynum + 1
                end
            end
            if maxnum < enemynum then
                maxnum = enemynum
                xmax = x + CC.DirectX[direct + 1]
                ymax = y + CC.DirectY[direct + 1]
            end
        end
    elseif wugongtype == 2 then
        local enemynum = 0
        for direct = 0, 3 do
            for i = 1, movescope do
                local xnew = x + CC.DirectX[direct + 1] * i
                local ynew = y + CC.DirectY[direct + 1] * i
                if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
                    local id = GetWarMap(xnew, ynew, 2)
                end
                if id >= 0 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[id]["我方"] then
                    enemynum = enemynum + 1
                end
            end
        end
    end
    if enemynum > 0 then
        maxnum = enemynum
        xmax = x
        ymax = y
    end
    return maxnum, xmax, ymax
end

-- 得到可以走到攻击到敌人的最近位置。
-- scope可以攻击的范围
-- 返回 x,y。如果无法走到攻击位置，返回空
function War_AutoCalMaxEnemyMap(wugongid, level)
    local wugongtype = JY.Wugong[wugongid]["攻击范围"]
    local movescope = JY.Wugong[wugongid]["移动范围" .. level]
    local fightscope = JY.Wugong[wugongid]["杀伤范围" .. level]
    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
    CleanWarMap(4, 0)
    if wugongtype == 0 or wugongtype == 3 then
        for n = 0, WAR.PersonNum - 1 do
            if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~=
                WAR.Person[WAR.CurID]["我方"] then
                local xx = WAR.Person[n]["坐标X"]
                local yy = WAR.Person[n]["坐标Y"]
                local movestep = War_CalMoveStep(n, movescope, 1)
                for i = 1, movescope do
                    local step_num = movestep[i].num
                    if step_num == 0 then

                    else
                        for j = 1, step_num do
                            SetWarMap(movestep[i].x[j], movestep[i].y[j], 4, 1)
                        end
                    end
                end
            end
        end
    elseif wugongtype == 1 or wugongtype == 2 then
        for n = 0, WAR.PersonNum - 1 do
            if n ~= WAR.CurID and WAR.Person[n]["死亡"] == false and WAR.Person[n]["我方"] ~=
                WAR.Person[WAR.CurID]["我方"] then
                local xx = WAR.Person[n]["坐标X"]
                local yy = WAR.Person[n]["坐标Y"]
                for direct = 0, 3 do
                    for i = 1, movescope do
                        local xnew = xx + CC.DirectX[direct + 1] * i
                        local ynew = yy + CC.DirectY[direct + 1] * i
                        if xnew >= 0 and xnew < CC.WarWidth and ynew >= 0 and ynew < CC.WarHeight then
                            local v = GetWarMap(xnew, ynew, 4)
                            SetWarMap(xnew, ynew, 4, v + 1)

                        end
                    end
                end
            end
        end
    end
end

-- 自动医疗
function War_AutoDoctor()
    local x1 = WAR.Person[WAR.CurID]["坐标X"]
    local y1 = WAR.Person[WAR.CurID]["坐标Y"]
    War_ExecuteMenu_Sub(x1, y1, 3, -1)
end

--自动暗器
function War_AutoAnqi()
    local pid = WAR.Person[WAR.CurID]['人物编号']
    local x1 = WAR.Person[WAR.CurID]["坐标X"]
    local y1 = WAR.Person[WAR.CurID]["坐标Y"]
    local x2,y2 = nil,nil 
    local getDistance = nil
    local AnQiDistance = JY.Person[pid]['暗器技巧']
    for i = 0,WAR.PersonNum - 1 do 
        if WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] and WAR.Person[i]['死亡'] == false then 
            x2, y2 = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
            getDistance = limitX(11 - math.abs(x - x1) - math.abs(y - y1), 0, zb)
        end
    end

end

-- 自动吃药
-- flag=2 生命，3内力；4体力  6 解毒
function War_AutoEatDrug(flag)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local life = JY.Person[pid]["生命"]
    local maxlife = JY.Person[pid]["生命最大值"]
    local selectid = nil
    local minvalue = math.huge
    local shouldadd, maxattrib, str = nil, nil, nil
    if flag == 2 then
        maxattrib = JY.Person[pid]["生命最大值"]
        shouldadd = maxattrib - JY.Person[pid]["生命"]
        str = "加生命"

    elseif flag == 3 then
        maxattrib = JY.Person[pid]["内力最大值"]
        shouldadd = maxattrib - JY.Person[pid]["内力"]
        str = "加内力"

    elseif flag == 4 then
        maxattrib = CC.PersonAttribMax["体力"]
        shouldadd = maxattrib - JY.Person[pid]["体力"]
        str = "加体力"

    elseif flag == 6 then
        maxattrib = CC.PersonAttribMax["中毒程度"]
        shouldadd = JY.Person[pid]["中毒程度"]
        str = "加中毒解毒"

    else
        return
    end
    local function Get_Add(thingid)
        if flag == 6 then
            return -JY.Thing[thingid][str] / 2
        else
            return JY.Thing[thingid][str]
        end
    end

    -- 在队
    if isteam(pid) and WAR.Person[WAR.CurID]["我方"] == true then
        local extra = 0
        for i = 1, CC.MyThingNum do
            local thingid = JY.Base["物品" .. i]
            if thingid >= 0 then
                local add = Get_Add(thingid)
                if JY.Thing[thingid]["类型"] == 3 and add > 0 then
                    local v = shouldadd - add
                    if v < 0 then
                        extra = 1
                    elseif v < minvalue then
                        minvalue = v
                        selectid = thingid
                    end
                end
            end
        end
        if extra == 1 then
            minvalue = math.huge
            for i = 1, CC.MyThingNum do
                local thingid = JY.Base["物品" .. i]
                if thingid >= 0 then
                    local add = Get_Add(thingid)
                    if JY.Thing[thingid]["类型"] == 3 and add > 0 then
                        local v = add - shouldadd
                        if v >= 0 and v < minvalue then
                            minvalue = v
                            selectid = thingid
                        end
                    end
                end
            end
        end
        -- 使用物品
        if UseThingEffect(selectid, pid) == 1 then
            instruct_32(selectid, -1)

        end
        -- 不在队
    else
        local extra = 0
        for i = 1, 4 do
            local thingid = JY.Person[pid]["携带物品" .. i]
            local tids = JY.Person[pid]["携带物品数量" .. i]
            if thingid >= 0 and tids > 0 then
                local add = Get_Add(thingid)
                if JY.Thing[thingid]["类型"] == 3 and add > 0 then
                    local v = shouldadd - add
                    if v < 0 then -- 可以加满生命, 用其他方法找合适药品
                        extra = 1
                    elseif v < minvalue then
                        minvalue = v
                        selectid = thingid
                    end
                end
            end
        end
        if extra == 1 then
            minvalue = math.huge
            for i = 1, 4 do
                local thingid = JY.Person[pid]["携带物品" .. i]
                local tids = JY.Person[pid]["携带物品数量" .. i]
                if thingid >= 0 and tids > 0 then
                    local add = Get_Add(thingid)
                    if JY.Thing[thingid]["类型"] == 3 and add > 0 then
                        local v = add - shouldadd
                        if v >= 0 and v < minvalue then
                            minvalue = v
                            selectid = thingid
                        end
                    end
                end
            end
        end
        -- NPC使用物品
        if UseThingEffect(selectid, pid) == 1 then
            instruct_41(pid, selectid, -1)
        end
    end
    -- lib.Delay(500)
end

-- 自动逃跑
function War_AutoEscape()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    if JY.Person[pid]["体力"] <= 5 then
        return
    end
    local x, y = nil, nil
    War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0) -- 计算移动步数
    Cat('实时特效动画')
    WarDrawMap(1)
    Cat('实时特效动画2')
    ShowScreen()
    lib.Delay(CC.BattleDelay)
    local array = {}
    local num = 0

    for i = 0, CC.WarWidth - 1 do
        for j = 0, CC.WarHeight - 1 do
            if GetWarMap(i, j, 3) < 128 then
                local minDest = math.huge
                for k = 0, WAR.PersonNum - 1 do
                    if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[k]["我方"] and WAR.Person[k]["死亡"] == false then
                        local dx = math.abs(i - WAR.Person[k]["坐标X"])
                        local dy = math.abs(j - WAR.Person[k]["坐标Y"])
                        if dx + dy < minDest then -- 计算当前距离敌人最近的位置
                            minDest = dx + dy
                        end
                    end
                end
                num = num + 1
                array[num] = {}
                array[num].x = i
                array[num].y = j
                array[num].p = minDest
            end
        end
    end

    for i = 1, num - 1 do
        for j = i, num do
            if array[i].p < array[j].p then
                array[i], array[j] = array[j], array[i]
            end
        end
    end
    for i = 2, num do
        if array[i].p < array[1].p / 2 then
            num = i - 1
            break
        end
    end
    for i = 1, num do
        array[i].p = array[i].p * 5 + GetMovePoint(array[i].x, array[i].y, 1)
    end
    for i = 1, num - 1 do
        for j = i, num do
            if array[i].p < array[j].p then
                array[i], array[j] = array[j], array[i]
            end
        end
    end
    x = array[1].x
    y = array[1].y

    War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
    War_MovePerson(x, y) -- 移动到相应的位置
end

-- 自动执行战斗，此时的位置一定可以打到敌人
function War_AutoExecuteFight(wugongnum)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
    local wugongid = JY.Person[pid]["武功" .. wugongnum]
    local level = math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1
    local maxnum, x, y = War_AutoCalMaxEnemy(x0, y0, wugongid, level)
    if x ~= nil then
        War_Fight_Sub(WAR.CurID, wugongnum, x, y)
        WAR.Person[WAR.CurID].Action = {"atk", x - WAR.Person[WAR.CurID]["坐标X"], y - WAR.Person[WAR.CurID]["坐标Y"]}
    end
end

-- 自动战斗
function War_AutoMenu()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    WAR.AutoFight = 1
    WAR.ShowHead = 0
    Cls()
    War_Auto()
    return 1
end

-- 计算可移动步数
-- id 战斗人id，
-- stepmax 最大步数，
-- flag=0  移动，物品不能绕过，1 武功，用毒医疗等，不考虑挡路。
-- flag=2  无视建筑
function War_CalMoveStep(id, stepmax, flag)
    CleanWarMap(3, 255)
    local x = WAR.Person[id]["坐标X"]
    local y = WAR.Person[id]["坐标Y"]
    local steparray = {}
    for i = 0, stepmax do
        steparray[i] = {}
        steparray[i].bushu = {}
        steparray[i].x = {}
        steparray[i].y = {}
    end
    SetWarMap(x, y, 3, 0)
    steparray[0].num = 1
    steparray[0].bushu[1] = stepmax
    steparray[0].x[1] = x
    steparray[0].y[1] = y
    War_FindNextStep(steparray, 0, flag, id)
    return steparray
end

-- 判断x,y是否为可移动位置
function War_CanMoveXY(x, y, flag)
    if flag == 2 then
        return true
    end
    if GetWarMap(x, y, 1) > 0 then
        return false
    end
    if flag == 1 then
        if CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
            return false
        end
        if GetWarMap(x, y, 2) >= 0 then
            return true
        end
    end
    if flag == 0 then
        if CC.WarWater[GetWarMap(x, y, 0)] ~= nil then
            return false
        end
        if GetWarMap(x, y, 2) >= 0 then
            return false
        end
    end
    return true
end

-- 解毒菜单
function War_DecPoisonMenu()
    WAR.ShowHead = 0
    local r = War_ExecuteMenu(2)
    WAR.ShowHead = 1
    Cls()
    return r
end

-- 判断攻击后面对的方向
function War_Direct(x1, y1, x2, y2)
    local x = x2 - x1
    local y = y2 - y1
    if x == 0 and y == 0 then
        return WAR.Person[WAR.CurID]["人方向"]
    end
    if math.abs(x) < math.abs(y) then
        if y > 0 then
            return 3
        else
            return 0
        end
    else
        if x > 0 then
            return 1
        else
            return 2
        end
    end
end

-- 医疗菜单
function War_DoctorMenu()
    WAR.ShowHead = 0
    local r = War_ExecuteMenu(3)
    WAR.ShowHead = 1
    Cls()
    return r
end

---执行医疗，解毒用毒
---flag=1 用毒， 2 解毒，3 医疗 4 暗器
---thingid 暗器物品id
function War_ExecuteMenu(flag, thingid)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local step = nil
    local sts = nil
    if flag == 1 then
        step = math.modf((JY.Person[pid]["用毒能力"] + FJYONGD(pid)) / 40)
    elseif flag == 2 then
        step = math.modf(JY.Person[pid]["解毒能力"] / 40)
    elseif flag == 3 then
        step = math.modf((JY.Person[pid]["医疗能力"] + FJYIL(pid)) / 40)
    elseif flag == 4 then
        step = math.modf((JY.Person[pid]["暗器技巧"] + FJANQI(pid)) / 15) + 1
    end
    War_CalMoveStep(WAR.CurID, step, 1)
    -- 增加部分人物的7*7显示
    if pid == 0 and JY.Base["标准"] == 8 and flag == 3 then
        sts = 1
    elseif pid == 0 and JY.Base["标准"] == 9 and flag == 1 then
        sts = 1
    elseif match_ID(pid, 83) and flag == 4 then
        sts = 1
    end
    local x1, y1 = War_SelectMove(sts)
    if x1 == nil then
        lib.GetKey()
        Cls()
        return 0
    else
        return War_ExecuteMenu_Sub(x1, y1, flag, thingid)
    end
end

-- 选择武功的函数，手动和AI都经过这里
function War_FightSelectType(movefanwei, atkfanwei, x, y, wugong)
    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
    if x == nil and y == nil then
        x, y = War_KfMove(movefanwei, atkfanwei, wugong)
        if x == nil then
            lib.GetKey()
            Cls()
            return
        end
        -- 无酒不欢：AI也显示选择范围
    else
        Cat('实时特效动画')
        WarDrawAtt(x, y, atkfanwei, 4)
        WarDrawMap(1, x, y)
        Cat('实时特效动画2')
        ShowScreen()
        lib.Delay(CC.BattleDelay)
        Delay(5, x, y)
        -- 逆转乾坤
        --if WAR.PD['逆转乾坤'][JY.Person[WAR.Person[WAR.CurID]['人物编号']]] == 1 then
        if CC.TX['逆转乾坤'] == 1 then 
            CC.TX['逆转乾坤'] = 0    
            --WAR.PD['逆转乾坤'][JY.Person[WAR.Person[WAR.CurID]['人物编号']]] = nil
            lib.Debug('触发逆转乾坤0')
            WAR.PD['逆转乾坤'][JY.Person[WAR.Person[WAR.CurID]['人物编号']]] = nil
            local z = WAR.CurID
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["人物编号"] == 0 and JY.Person[0]["生命"] > 0 then
                    WAR.CurID = j
                    break
                end
            end
            Cls()
            CurIDTXDH(WAR.CurID, 114, 1, "逆转乾坤", C_ORANGE);
            WAR.CurID = z
            local ori_x, ori_y = x, y
            local min_x, min_y, max_x, max_y = x - 2, y - 2, x + 2, y + 2
            Cls()
            CleanWarMap(3, 255)
            local ssx = 0
            for i = min_x + 1, max_x - 1 do
                for j = min_y + 1, max_y - 1 do
                    SetWarMap(i, j, 3, 0)
                end
            end

            SetWarMap(min_x, y, 3, 0)
            SetWarMap(max_x, y, 3, 0)
            SetWarMap(x, min_y, 3, 0)
            SetWarMap(x, max_y, 3, 0)
            Cat('实时特效动画')
            WarDrawMap(1, x, y)
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
            x = math.random(min_x,max_x)
            y = math.random(min_y,max_y)
            if JY.Person[0]["内力"] >= 300 then
                JY.Person[0]["内力"] = JY.Person[0]["内力"] - 300
                WAR.NZQK = 2
                --break
            else
                x, y = ori_x, ori_y
                WAR.NZQK = 1
                CleanWarMap(7, 0)
                WarDrawAtt(x, y, atkfanwei, 4)
                WarDrawMap(1, x, y)
                ShowScreen()
                --break
            end
            Cat('实时特效动画')
            CleanWarMap(7, 0)
            WarDrawAtt(x, y, atkfanwei, 4)
            WarDrawMap(1, x, y)
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
            --[[
            while true do
                if JY.Restart == 1 then
                    break
                end
                local key, ktype, mx, my = lib.GetKey()
                if key == VK_UP then
                    PlayWavE(77)
                    if (y > min_y + 1 and x > min_x and x < max_x) or (x == ori_x and y > min_y) then
                        y = y - 1
                    end
                elseif key == VK_DOWN then
                    PlayWavE(77)
                    if (y < max_y - 1 and x > min_x and x < max_x) or (x == ori_x and y < max_y) then
                        y = y + 1
                    end
                elseif key == VK_LEFT then
                    PlayWavE(77)
                    if (x > min_x + 1 and y > min_y and y < max_y) or (y == ori_y and x > min_x) then
                        x = x - 1
                    end
                elseif key == VK_RIGHT then
                    PlayWavE(77)
                    if (x < max_x - 1 and y > min_y and y < max_y) or (y == ori_y and x < max_x) then
                        x = x + 1
                    end
                elseif key == VK_ESCAPE then
                    PlayWavE(77)
                    x, y = ori_x, ori_y
                    WAR.NZQK = 1
                    Cat('实时特效动画')
                    CleanWarMap(7, 0)
                    WarDrawAtt(x, y, atkfanwei, 4)
                    WarDrawMap(1, x, y)
                    Cat('实时特效动画2')
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                    break
                elseif (key == VK_SPACE or key == VK_RETURN) then
                    PlayWavE(77)
                    -- 内力大于等于300才能使用
                    if JY.Person[0]["内力"] >= 300 then
                        JY.Person[0]["内力"] = JY.Person[0]["内力"] - 300
                        WAR.NZQK = 2
                        break
                    else
                        x, y = ori_x, ori_y
                        WAR.NZQK = 1
                        CleanWarMap(7, 0)
                        WarDrawAtt(x, y, atkfanwei, 4)
                        WarDrawMap(1, x, y)
                        ShowScreen()
                        break
                    end
                end
                Cat('实时特效动画')
                CleanWarMap(7, 0)
                WarDrawAtt(x, y, atkfanwei, 4)
                WarDrawMap(1, x, y)
                Cat('实时特效动画2')
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
 
            ]]
        end
        -- 迷踪步
        if CC.TX["迷踪步"] == 1 then
            local z = WAR.CurID
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
                    WAR.CurID = j
                    break
                end
            end
            Cls()
            CurIDTXDH(WAR.CurID, 129, 1, "迷踪步", Violet);
            WAR.Person[WAR.CurID]["移动步数"] = 6
            War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
            local x, y = nil, nil
            while 1 do
                if JY.Restart == 1 then
                    break
                end
                x, y = War_SelectMove()
                if x ~= nil then
                    WAR.ShowHead = 0
                    War_MovePerson(x, y)
                    break
                end
            end
            WAR.CurID = z
            CC.TX["迷踪步"] = 0
        end
        -- 李寻欢 蜻蜓三抄水躲避攻击
        if JY.Person[498]["品德"] == 30 then
            local z = WAR.CurID
            local pd = false
            for j = 0, WAR.PersonNum - 1 do
                if JY.Person[WAR.Person[j]["人物编号"]]["生命"] > 0 then
                    if (WAR.Person[j]["人物编号"] == 0 and JY.Base['畅想'] == 498) or
                        (WAR.Person[j]["人物编号"] == 498) then
                        WAR.CurID = j
                        break
                    end
                end
            end
            Cls()
            CurIDTXDH(WAR.CurID, 129, 1, "蜻蜓三抄水", Violet);

            WAR.Person[WAR.CurID]["移动步数"] = 6
            War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
            local x, y = nil, nil
            while 1 do
                if JY.Restart == 1 then
                    break
                end
                x, y = War_SelectMove()
                if x ~= nil then
                    WAR.ShowHead = 0
                    War_MovePerson(x, y)
                    break
                end
            end
            WAR.CurID = z
            JY.Person[498]["品德"] = 10
        end
        -- 小昭影步
        if JY.Person[66]["品德"] == 90 then
            JY.Person[66]["品德"] = 50
            if WAR.XZ_YB[1] ~= nil then
                local z = WAR.CurID
                for j = 0, WAR.PersonNum - 1 do
                    if ((WAR.Person[j]["人物编号"] == 0 and JY.Base['畅想'] == 66) or
                        WAR.Person[j]["人物编号"] == 66) and 0 < JY.Person[0]["生命"] then
                        WAR.CurID = j
                        break
                    end
                end
                Cls()
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 122, 1, "接引离斯毒火海", C_RED)
                lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
                lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
                lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
                WarDrawMap(0)
                WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = WAR.XZ_YB[1], WAR.XZ_YB[2]
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 122, 1, "幻光游世常自在", C_RED)
                lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                    WAR.Person[WAR.CurID]["贴图"])
                lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
                SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                    JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
                WarDrawMap(0)
                WAR.XZ_YB[1] = nil
                WAR.XZ_YB[2] = nil
                WAR.CurID = z
            end
        end
        CleanWarMap(7, 0)
    end
    if not War_Direct(x0, y0, x, y) then
        WAR.Person[WAR.CurID]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
    else
        WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x, y)
    end
    SetWarMap(x, y, 4, 1)
    return x, y
end

-- 设置下一步可移动的坐标
function War_FindNextStep(steparray, step, flag, id)
    local num = 0
    local step1 = step + 1

    -- ZOC判定
    local fujinnum = function(tx, ty)
        if flag ~= 0 or id == nil then
            return 0
        end
        local tnum = 0
        local wofang = WAR.Person[id]["我方"]
        local tv = nil
        tv = GetWarMap(tx + 1, ty, 2)
        if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
            tnum = 9999
        end
        tv = GetWarMap(tx - 1, ty, 2)
        if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
            tnum = 999
        end
        tv = GetWarMap(tx, ty + 1, 2)
        if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
            tnum = 999
        end
        tv = GetWarMap(tx, ty - 1, 2)
        if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
            tnum = 999
        end
        return tnum
    end

    for i = 1, steparray[step].num do
        if steparray[step].bushu[i] > 0 then
            steparray[step].bushu[i] = steparray[step].bushu[i] - 1
            local x = steparray[step].x[i]
            local y = steparray[step].y[i]
            if x + 1 < CC.WarWidth - 1 then
                local v = GetWarMap(x + 1, y, 3)
                if v == 255 and War_CanMoveXY(x + 1, y, flag) == true then
                    num = num + 1
                    steparray[step1].x[num] = x + 1
                    steparray[step1].y[num] = y
                    SetWarMap(x + 1, y, 3, step1)
                    steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x + 1, y)
                end
            end

            if x - 1 > 0 then
                local v = GetWarMap(x - 1, y, 3)
                if v == 255 and War_CanMoveXY(x - 1, y, flag) == true then
                    num = num + 1
                    steparray[step1].x[num] = x - 1
                    steparray[step1].y[num] = y
                    SetWarMap(x - 1, y, 3, step1)
                    steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x - 1, y)
                end
            end

            if y + 1 < CC.WarHeight - 1 then
                local v = GetWarMap(x, y + 1, 3)
                if v == 255 and War_CanMoveXY(x, y + 1, flag) == true then
                    num = num + 1
                    steparray[step1].x[num] = x
                    steparray[step1].y[num] = y + 1
                    SetWarMap(x, y + 1, 3, step1)
                    steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x, y + 1)
                end
            end

            if y - 1 > 0 then
                local v = GetWarMap(x, y - 1, 3)
                if v == 255 and War_CanMoveXY(x, y - 1, flag) == true then
                    num = num + 1
                    steparray[step1].x[num] = x
                    steparray[step1].y[num] = y - 1
                    SetWarMap(x, y - 1, 3, step1)
                    steparray[step1].bushu[num] = steparray[step].bushu[i] - fujinnum(x, y - 1)
                end
            end
        end
    end
    if num == 0 then
        return
    end
    steparray[step1].num = num
    War_FindNextStep(steparray, step1, flag, id)
end

-- 判断是否能打到敌人
function War_GetCanFightEnemyXY()
    local num, x, y = nil, nil, nil
    num, x, y = War_realjl(WAR.CurID)
    if num == -1 then
        return
    end
    return x, y
end

-- 移动
function War_MoveMenu()
    if WAR.Person[WAR.CurID]["人物编号"] ~= -1 then
        WAR.ShowHead = 0
        if WAR.Person[WAR.CurID]["移动步数"] <= 0 then
            return 0
        end
        War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
        local r = nil
        local x, y = War_SelectMove()
        if x ~= nil then
            War_MovePerson(x, y, 1)
            r = 1
        else
            r = 0
            WAR.ShowHead = 1
            Cls()
        end
        lib.GetKey()
        return r
    else
        local ydd = {}
        local n = 1
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                ydd[n] = i
                n = n + 1
            end
        end
        local dx = ydd[math.random(n - 1)]
        local DX = WAR.Person[dx]["坐标X"]
        local DY = WAR.Person[dx]["坐标Y"]
        local YDX = {DX + 1, DX - 1, DX}
        local YDY = {DY + 1, DY - 1, DY}
        local ZX = YDX[math.random(3)]
        local ZY = YDY[math.random(3)]
        if not SceneCanPass(ZX, ZY) or GetWarMap(ZX, ZY, 2) < 0 then
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            WAR.Person[WAR.CurID]["坐标X"] = ZX
            WAR.Person[WAR.CurID]["坐标Y"] = ZY
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
        end
    end
    return 1
end

-- 人物移动
function War_MovePerson(x, y, flag)
    local id = WAR.Person[WAR.CurID]['人物编号']
    local x1 = x
    local y1 = y
    if not flag then
        flag = 0
    end
    local movenum = GetWarMap(x, y, 3)
    local movetable = {}
    for i = movenum, 1, -1 do
        movetable[i] = {}
        movetable[i].x = x
        movetable[i].y = y
        if GetWarMap(x - 1, y, 3) == i - 1 then
            x = x - 1
            movetable[i].direct = 1
        elseif GetWarMap(x + 1, y, 3) == i - 1 then
            x = x + 1
            movetable[i].direct = 2
        elseif GetWarMap(x, y - 1, 3) == i - 1 then
            y = y - 1
            movetable[i].direct = 3
        elseif GetWarMap(x, y + 1, 3) == i - 1 then
            y = y + 1
            movetable[i].direct = 0
        end
    end
    -- 减少移动步数
    movetable.num = movenum
    movetable.now = 0
    WAR.Person[WAR.CurID].Move = movetable
    if WAR.Person[WAR.CurID]["移动步数"] < movenum then
        movenum = WAR.Person[WAR.CurID]["移动步数"]
        WAR.Person[WAR.CurID]["移动步数"] = 0
    else
        WAR.Person[WAR.CurID]["移动步数"] = WAR.Person[WAR.CurID]["移动步数"] - movenum
    end
    -- 移动人物
    -- 标主的特殊显示
    if match_ID(id, 9976) then
        Cat('神游太虚', x1, y1)
    elseif movenum > 2 and JY.Person[id]["主运轻功"] > 0 then
        local a = 0
        local gender = 0
        if JY.Person[0]["性别"] > 0 then
            gender = 1
        end
        for i = 1, movenum do
            local t1 = lib.GetTime()
            if a == 6 then
                a = 0
            end
            if i == 1 then
                SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
                SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            end
            if i > 3 then
                SetWarMap(movetable[i - 3].x, movetable[i - 3].y, 2, -1)
                SetWarMap(movetable[i - 3].x, movetable[i - 3].y, 5, -1)
            end
            if i == movenum then
                SetWarMap(movetable[i - 2].x, movetable[i - 2].y, 2, -1)
                SetWarMap(movetable[i - 2].x, movetable[i - 2].y, 5, -1)
                SetWarMap(movetable[i - 1].x, movetable[i - 1].y, 2, -1)
                SetWarMap(movetable[i - 1].x, movetable[i - 1].y, 5, -1)
            end
            WAR.Person[WAR.CurID]["坐标X"] = movetable[i].x
            WAR.Person[WAR.CurID]["坐标Y"] = movetable[i].y
            WAR.Person[WAR.CurID]["人方向"] = movetable[i].direct
            if i < movenum then
                WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic2(WAR.CurID, gender) + (a) * 2
            else
                WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
            end
            WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])

            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])

            WarDrawMap(0)
            ShowScreen()
            a = a + 1
            lib.Delay(CC.BattleDelay)
        end
    else
        for i = 1, movenum do
            local t1 = lib.GetTime()
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            WAR.Person[WAR.CurID]["坐标X"] = movetable[i].x
            WAR.Person[WAR.CurID]["坐标Y"] = movetable[i].y
            WAR.Person[WAR.CurID]["人方向"] = movetable[i].direct
            WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            Cat('实时特效动画')
            WarDrawMap(0)
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end
    -- 主运轻功的话遇到ZOC移动不清0，反之清0
    if JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["主运轻功"] == 0 then
        local fujinnum = function(tx, ty)
            local tnum = 0
            local wofang = WAR.Person[WAR.CurID]["我方"]
            local tv = nil
            tv = GetWarMap(tx + 1, ty, 2)
            if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
                tnum = 999
            end
            tv = GetWarMap(tx - 1, ty, 2)
            if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
                tnum = 999
            end
            tv = GetWarMap(tx, ty + 1, 2)
            if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
                tnum = 999
            end
            tv = GetWarMap(tx, ty - 1, 2)
            if tv ~= -1 and WAR.Person[tv]["我方"] ~= wofang then
                tnum = 999
            end
            return tnum
        end
        if fujinnum(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]) ~= 0 then
            WAR.Person[WAR.CurID]["移动步数"] = 0
        end
    end
end

---用毒菜单
function War_PoisonMenu()
    WAR.ShowHead = 0
    local r = War_ExecuteMenu(1)
    WAR.ShowHead = 1
    Cls()
    return r
end

-- 战斗休息
function War_RestMenu()
    if WAR.CurID and WAR.CurID >= 0 then
        local pid = WAR.Person[WAR.CurID]["人物编号"]
        if WAR.PD['内伤状态'][pid] == nil then
            WAR.PD['内伤状态'][pid] = 0
        end
        -- 走火不能休息
        if WAR.PD["走火状态"][pid] == 1 or match_ID(pid, 98) or match_ID(pid, 9875) then
            return 1
        end
        -- local vv = math.modf(JY.Person[pid]["体力"] / 100 - JY.Person[pid]["受伤程度"] / 50 - JY.Person[pid]["中毒程度"] / 50) + 2 --1018
        local vv = math.modf(JY.Person[pid]["体力"] / 100 - (WAR.PD['内伤状态'][pid] or 0) / 50 -JY.Person[pid]["中毒程度"] / 50) + 2

        local v = 3 + Rnd(3)
        if WAR.Person[WAR.CurID]["移动步数"] > 0 then
            vv = vv + 2
        end
        if isteam(pid) then
            vv = vv + math.random(3)
        else
            vv = vv + 6
        end
        if match_ID(pid, 177) or match_ID(pid, 178) or match_ID(pid, 179) then
            v = v * 2
            vv = vv * 2
        end
        vv = (vv) / 120

        WAR.Person[WAR.CurID]["体力点数"] = AddPersonAttrib(pid, "体力", v)
        WAR.Person[WAR.CurID]["中毒点数"] = AddPersonAttrib(pid, "中毒程度", -v * 3)
        if JY.Person[pid]["内力"] < 100 then
            local hn = 3 + math.modf(JY.Person[pid]["内力最大值"] * (vv))
            WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(pid, "内力", hn)
        else
            if not isteam(pid) then
                v = 3 + math.modf(JY.Person[pid]["生命最大值"] / 4 * (vv))
            else
                v = 3 + math.modf(JY.Person[pid]["生命最大值"] / 4 * (vv))
            end
            WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", v)
            v = 3 + math.modf(JY.Person[pid]["内力最大值"] * (vv))
            WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(pid, "内力", v)
        end

        War_Show_Count(WAR.CurID); -- 显示当前控制人的点数

        if match_ID(pid, 721) then
            Cls()
            WAR.Actup[pid] = 2;
            WAR.Defup[pid] = 1
            CurIDTXDH(WAR.CurID, 85, 1, "蓄力・防御", LimeGreen);
        end
        -- 阿凡提休息带蓄力+防御
        if match_ID(pid, 606) then
            Cls()
            WAR.Actup[pid] = 2;
            WAR.Defup[pid] = 1
            CurIDTXDH(WAR.CurID, 85, 1, "运筹帷幄・决胜千里", LimeGreen);
        end
        --[[NPC休息会自动蓄力
		--先天调息不触发
		if not isteam(pid) and WAR.XTTX == 0 then
			if math.modf(JY.Person[pid]["生命最大值"] / 2) < JY.Person[pid]["生命"] then
				Cls()
				return War_ActupMenu()
			else
				Cls()
				return War_DefupMenu()
			end
		else
			return 1
		end]]
        return 1
    end
end

-- 战斗查看状态
function War_StatusMenu()
    WAR.ShowHead = 0
    Menu_Status()
    WAR.ShowHead = 1
    Cls()
end

-- 战斗物品菜单
function War_ThingMenu()
    WAR.ShowHead = 0
    local thing = {}
    local thingnum = {}
    for i = 0, CC.MyThingNum - 1 do
        thing[i] = -1
        thingnum[i] = 0
    end
    local num = 0
    for i = 0, CC.MyThingNum - 1 do
        local id = JY.Base["物品" .. i + 1]
        if id >= 0 and (JY.Thing[id]["类型"] == 1 or JY.Thing[id]["类型"] == 3 or JY.Thing[id]["类型"] == 4) then
            thing[num] = id
            thingnum[num] = JY.Base["物品数量" .. i + 1]
            num = num + 1
        end
    end
    local r = SelectThing(thing, thingnum)
    Cls()
    local rr = 0
    if r >= 0 and UseThing(r) == 1 then
        rr = 1
    end
    WAR.ShowHead = 1
    Cls()
    return rr
end

-- 自动战斗判断是否能医疗
function War_ThinkDoctor()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    if WAR.PD['内伤状态'][pid] == nil then
        WAR.PD['内伤状态'][pid] = 0
    end
    if JY.Person[pid]["体力"] < 50 or JY.Person[pid]["医疗能力"] < 20 then
        return -1
    end
    -- if (JY.Person[pid]["医疗能力"] + FJYIL(pid)) + 20 < JY.Person[pid]["受伤程度"] then 1018
    if (JY.Person[pid]["医疗能力"] + FJYIL(pid)) + 20 < WAR.PD['内伤状态'][pid] then
        return -1
    end
    local rate = -1
    local v = JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"]
    if (JY.Person[pid]["医疗能力"] + FJYIL(pid)) < v / 4 then
        rate = 30
    elseif (JY.Person[pid]["医疗能力"] + FJYIL(pid)) < v / 3 then
        rate = 50
    elseif (JY.Person[pid]["医疗能力"] + FJYIL(pid)) < v / 2 then
        rate = 70
    else
        rate = 90
    end
    if JLSD(0, rate, pid) then
        return 5
    end
    return -1
end

-- 能否吃药增加参数
-- flag=2 生命，3内力；4体力  6 解毒
function War_ThinkDrug(flag)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local str = nil
    local r = -1
    if flag == 2 then
        str = "加生命"
    elseif flag == 3 then
        str = "加内力"
    elseif flag == 4 then
        str = "加体力"
    elseif flag == 6 then
        str = "加中毒解毒"
    else
        return r
    end
    local function Get_Add(thingid)
        if flag == 6 then
            return -JY.Thing[thingid][str]
        else
            return JY.Thing[thingid][str]
        end
    end

    -- 身上是否有药品
    if isteam(pid) and WAR.Person[WAR.CurID]["我方"] == true then
        for i = 1, CC.MyThingNum do
            local thingid = JY.Base["物品" .. i]
            if thingid >= 0 and JY.Thing[thingid]["类型"] == 3 and Get_Add(thingid) > 0 then
                r = flag
                break
            end
        end
    else
        for i = 1, 4 do
            local thingid = JY.Person[pid]["携带物品" .. i]
            if thingid >= 0 and JY.Thing[thingid]["类型"] == 3 and Get_Add(thingid) > 0 then
                r = flag
                break
            end
        end
    end
    return r
end

-- 使用暗器
function War_UseAnqi(id)

    return War_ExecuteMenu(4, id)
end

-- 初始化战斗数据
function WarLoad(warid)
    WarSetGlobal()
    local data = Byte.create(CC.WarDataSize)
    Byte.loadfile(data, CC.WarFile, warid * CC.WarDataSize, CC.WarDataSize)
    LoadData(WAR.Data, CC.WarData_S, data)
    WAR.ZDDH = warid
end

-- 加载战斗地图
function WarLoadMap(mapid)
    lib.Debug(string.format("load war map %d", mapid))
    lib.LoadWarMap(CC.WarMapFile[1], CC.WarMapFile[2], mapid, 12, CC.WarWidth, CC.WarHeight)
end

function GetWarMap(x, y, level)
    if x > 63 or x < 0 or y > 63 or y < 0 then
        return
    end
    return lib.GetWarMap(x, y, level)
end

function SetWarMap(x, y, level, v)
    if x > 63 or x < 0 or y > 63 or y < 0 then
        return
    end
    lib.SetWarMap(x, y, level, v)
end

function CleanWarMap(level, v)
    lib.CleanWarMap(level, v)
end

-- 设置人物贴图
function WarSetPerson()
    CleanWarMap(2, -1)
    CleanWarMap(5, -1)
    CleanWarMap(10, -1)
    WAR.TF = {}
    WAR.TF1 = {}
    for i = 0, WAR.PersonNum - 1 do
        savetf(i)
        if WAR.Person[i]["死亡"] == false then
            SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 2, i)
            SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 5, WAR.Person[i]["贴图"])
            SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 10,
                JY.Person[WAR.Person[i]["人物编号"]]['头像代号'])
        end
    end

end

-- 显示武功动画，人物受伤动画，音效等
function War_ShowFight(pid, wugong, wugongtype, level, x, y, eft, ZHEN_ID)
    -- 攻击时不显示血条
    WAR.ShowHP = 0
    local atdh = nil or eft
    -- 没有合击
    if not ZHEN_ID then
        ZHEN_ID = -1
    end

    -- 内功
    if wugongtype == 6 then
        wugongtype = WAR.NGXS
    end
    -- 老顾1209
    -- 特技显示
    if wugongtype == 8 then
        wugongtype = WAR.TJXS
    end
    if wugong == 93 then
        wugongtype = 5
    end
    -- 老顾1209
    if wugongtype == 8 then
        wugongtype = 6
    end
    -- 无酒不欢：设置一下新的动画顺序
    if wugongtype == 2 then
        wugongtype = 1
    elseif wugongtype > 2 and wugongtype < 6 then
        wugongtype = wugongtype - 1
    end

    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]

    local starteft = 0

    if pid > -1 then
        Cat('神游太虚2', 1)
        local using_anqi = 0
        local anqi_name;
        -- 暗器动画
        if wugongtype == -1 then
            using_anqi = 1
            anqi_name = JY.Thing[eft]["名称"]
            -- 何铁手含沙射影
            if match_ID(pid, 83) then
                anqi_name = "含沙射影・" .. anqi_name
            end
            eft = JY.Thing[eft]["暗器动画编号"]
            -- 李寻欢小李飞刀 例不虚发
            if WAR.PD["小李飞刀"][pid] ~= nil then
                anqi_name = "小李飞刀・例不虚发"
            end
            -- 西域商人
            if match_ID(pid, 158) then
                anqi_name = "金钱镖"
            end
            -- 铁掌莲花
            if match_ID(pid, 617) then
                anqi_name = "枣核钉"
            end
            eft = 125
        end

        -- 般若金刚掌
        -- if Pmiji(pid,15) and (wugong == 189 or wugong == 22) then
        --   eft = 171
        -- end
        -- 斗转幻梦星辰特效动画
        if WAR.DZXYLV[pid] == 120 then
            eft = 107
        end
        -- 扫地老僧  随机动画
        if match_ID(pid, 114) or match_ID(pid, 9946) then
            eft = math.random(100)
        end
        if pid == 0 and JY.Person[0]['攻击力'] > 800 then
            eft = math.random(100)
        end
        if wugong == 47 then
            eft = math.random(100)
        end
        if WAR.PD['降龙・双龙取水'][pid] == 1 or WAR.PD['降龙・亢龙有悔'][pid] == 1 or
            WAR.PD['降龙・潜龙勿用'][pid] == 1 or WAR.PD['降龙・震惊百里'][pid] == 1 or
            WAR.PD['降龙・飞龙在天'][pid] == 1 or WAR.PD['降龙・见龙在田'][pid] == 1 then
            eft = 192
        end

        -- 萧秋水 动画
        if match_ID(pid, 652) then
            eft = 75
        end
        -- 陆渐 动画
        if match_ID(pid, 497) then
            eft = math.random(100)
        end
        if match_ID(pid, 721) and
            (WAR.PD['玉露酒'][pid] ~= nil or WAR.PD['梨花酒'][pid] ~= nil or WAR.PD['即墨老酒'][pid] ~= nil or WAR.PD['五宝花蜜酒'][pid] ~= nil) then
            eft = 168
        end
        -- 伏魔杖法动画
        if (wugong == 86 or wugong == 96 or wugong == 82 or wugong == 83) and ShiZunXM(pid) then
            -- eft = 7
            eft = 173
        end
        -- 易筋经 动画
        if wugong == 108 then
            eft = math.random(100)
        end
        -- 奔雷手 动画
        if WAR.LDJT == 1 then
            eft = 9
        end

        if wugong == 73 then
            eft = 61
        end
        -- 双剑合壁动画
        if (wugong == 39 or wugong == 42 or wugong == 139) and Pmiji(pid, 23) then
            eft = 83
        end
        -- 黯然极意动画
        if WAR.ARJY == 1 or WAR.ARJY1 == 1 then
            eft = 7
        end

        -- 霍都  龙象动画
        if match_ID(pid, 84) and wugong == 103 then
            eft = 73
        end

        -- 金蛇奥义动画
        if wugong == 40 and WAR.JSAY == 1 then
            eft = 44
        end
        -- 青蟒剑动画
        if wugong == 40 and WAR.QMJ == 1 then
            eft = 144
        end
        -- 万佛朝宗动画
        if WAR.PD["万佛朝宗"][pid] == 1 or (WAR.PD["如来神掌"][pid] ~= nil and WAR.PD["如来神掌"][pid] > 0) then
            eft = 169
        end
        --
        if WAR.WDKTJ == 1 then
            eft = 170
        end
        if WAR.AJFHNP == 1 then
            eft = 61
        end
        -- 七弦无形剑奥义动画
        if WAR.QXWXJ == 1 then
            eft = 125
        end
        --
        if WAR.YQFSQ == 1 then
            eft = 126
        end
        -- 追魂夺命的动画
        if wugong == 192 then
            eft = 162
        end
        -- 玄铁剑法的动画
        if wugong == 45 then
            eft = 164
        end

        -- 进阶万花
        if wugong == 30 and PersonKF(pid, 175) then
            eft = 138
        end
        -- 进阶泰山
        if wugong == 31 and PersonKF(pid, 175) then
            eft = 138
        end
        -- 进阶云雾
        if wugong == 32 and PersonKF(pid, 175) then
            eft = 138
        end
        -- 进阶万岳
        if wugong == 33 and PersonKF(pid, 175) then
            eft = 138
        end
        -- 进阶太岳
        if wugong == 34 and PersonKF(pid, 175) then
            eft = 138
        end
        -- 阳春白雪曲
        if wugong == 185 then
            eft = 129
        end
        -- 无酒不欢的特效动画
        if pid == 0 and JY.Base["特殊"] == 1 then
            if JY.Person[0]["性别"] == 0 then
                eft = 65
            else
                eft = 8
            end
        end

        -- 杨康的杨家枪法
        if match_ID(pid, 650) and wugong == 68 then
            eft = 150
        end

        -- 无招胜有招动画
        if wugong == 47 and WAR.FQY == 1 then
            eft = 83
        end

        if WAR.WZ[pid] ~= nil then
            WAR.Person[WAR.CurID]['特效文字0'] = WAR.WZ[pid][1]
            WAR.Person[WAR.CurID]['特效文字1'] = WAR.WZ[pid][2]
            WAR.Person[WAR.CurID]['特效文字2'] = WAR.WZ[pid][3]
            WAR.Person[WAR.CurID]['特效文字3'] = WAR.WZ[pid][4]
            WAR.Person[WAR.CurID]['特效文字4'] = WAR.WZ[pid][5]
            WAR.Person[WAR.CurID]['特效动画'] = WAR.WZ[pid][6]
        end

        WAR.WZ[pid] = nil

        -- 剑魔BOSS
        if match_ID(pid, 592) and Boss(WAR.CurID) then
            if WAR.PD['独孤剑势'][pid] ~= nil then
                if WAR.PD['独孤剑势'][pid] <= 3 then
                    WAR.Person[WAR.CurID]['特效动画'] = 24
                    if WAR.Person[WAR.CurID]['特效文字3'] == nil then
                        WAR.Person[WAR.CurID]['特效文字3'] = '利剑'
                    else
                        WAR.Person[WAR.CurID]['特效文字3'] = WAR.Person[WAR.CurID]['特效文字3'] .. '・利剑'
                    end
                    eft = 24
                elseif WAR.PD['独孤剑势'][pid] <= 5 then
                    WAR.Person[WAR.CurID]['特效动画'] = 48
                    if WAR.Person[WAR.CurID]['特效文字3'] == nil then
                        WAR.Person[WAR.CurID]['特效文字3'] = '软剑'
                    else
                        WAR.Person[WAR.CurID]['特效文字3'] = WAR.Person[WAR.CurID]['特效文字3'] .. '・软剑'
                    end
                    eft = 48
                elseif WAR.PD['独孤剑势'][pid] <= 7 then
                    WAR.Person[WAR.CurID]['特效动画'] = 10
                    if WAR.Person[WAR.CurID]['特效文字3'] == nil then
                        WAR.Person[WAR.CurID]['特效文字3'] = '重剑'
                    else
                        WAR.Person[WAR.CurID]['特效文字3'] = WAR.Person[WAR.CurID]['特效文字3'] .. '・重剑'
                    end
                    eft = 10
                elseif WAR.PD['独孤剑势'][pid] <= 9 then
                    WAR.Person[WAR.CurID]['特效动画'] = 46
                    if WAR.Person[WAR.CurID]['特效文字3'] == nil then
                        WAR.Person[WAR.CurID]['特效文字3'] = '木剑'
                    else
                        WAR.Person[WAR.CurID]['特效文字3'] = WAR.Person[WAR.CurID]['特效文字3'] .. '・木剑'
                    end
                    eft = 46
                else
                    if WAR.Person[WAR.CurID]['特效文字3'] == nil then
                        WAR.Person[WAR.CurID]['特效文字3'] = '无剑'
                    else
                        WAR.Person[WAR.CurID]['特效文字3'] = WAR.Person[WAR.CurID]['特效文字3'] .. '・无剑'
                    end
                    eft = 84
                end
            end
        end

        ------------------------------------------------------
        -- 大武功特效	
        local ex, ey = -1, -1;
        -- 指定XY，那么只显示在一个点显示动画	
        if eft == 173 then
            ex, ey = x, y;
        end
        if eft == 172 then
            ex, ey = x, y;
        end
        if eft == 170 then
            ex, ey = x, y;
        end
        if eft == 168 then
            ex, ey = x, y;
        end
        if eft == 169 then
            ex, ey = x, y;
        end
        if eft == 191 then
            ex, ey = x, y;
        end
        if eft == 192 then
            ex, ey = x, y;
        end
        if eft == 197 then
            ex, ey = x, y;
        end
        ----------------------------------------------------- 
        -- 六脉神剑的类型设置为拳法
        if wugong == 49 then
            wugongtype = 1
        end

        -- 合击动画
        local ZHEN_pid, ZHEN_type, ZHEN_startframe, ZHEN_fightframe = nil, nil, nil, nil
        if ZHEN_ID >= 0 then
            ZHEN_pid = WAR.Person[ZHEN_ID]["人物编号"]
            ZHEN_type = wugongtype
            ZHEN_startframe = 0
            ZHEN_fightframe = 0
        end

        local fightdelay, fightframe, sounddelay = nil, nil, nil
        if wugongtype >= 0 then
            fightdelay = JY.Person[pid]["出招动画延迟" .. wugongtype + 1]
            fightframe = JY.Person[pid]["出招动画帧数" .. wugongtype + 1]
            sounddelay = JY.Person[pid]["武功音效延迟" .. wugongtype + 1]
        else
            fightdelay = 0
            fightframe = -1
            sounddelay = -1
        end

        if fightdelay == 0 or fightframe == 0 then
            for i = 1, 5 do
                if JY.Person[pid]["出招动画帧数" .. i] ~= 0 then
                    fightdelay = JY.Person[pid]["出招动画延迟" .. i]
                    fightframe = JY.Person[pid]["出招动画帧数" .. i]
                    sounddelay = JY.Person[pid]["武功音效延迟" .. i]
                    wugongtype = i - 1
                end
            end
        end

        if ZHEN_ID >= 0 then
            if JY.Person[ZHEN_pid]["出招动画帧数" .. ZHEN_type + 1] == 0 then
                for i = 1, 5 do
                    if JY.Person[ZHEN_pid]["出招动画帧数" .. i] ~= 0 then
                        ZHEN_type = i - 1
                        ZHEN_fightframe = JY.Person[ZHEN_pid]["出招动画帧数" .. i]
                    end
                end
            else
                ZHEN_fightframe = JY.Person[ZHEN_pid]["出招动画帧数" .. ZHEN_type + 1]
            end
        end

        local framenum = fightdelay + CC.Effect[eft]

        local oldframe = framenum
        local maxfram = 0
        maxfram = zjgd()

        if framenum < fightdelay + maxfram then
            framenum = fightdelay + maxfram
        end

        local oldframe2 = framenum
        if framenum < fightdelay + 20 then
            framenum = fightdelay + 20
        end

        local startframe = 0
        if wugongtype >= 0 then
            for i = 0, wugongtype - 1 do
                startframe = startframe + 4 * JY.Person[pid]["出招动画帧数" .. i + 1]
            end
        end
        if ZHEN_ID >= 0 and ZHEN_type >= 0 then
            for i = 0, ZHEN_type - 1 do
                ZHEN_startframe = ZHEN_startframe + 4 * JY.Person[ZHEN_pid]["出招动画帧数" .. i + 1]
            end
        end

        -- local starteft = 0
        for i = 0, eft - 1 do
            starteft = starteft + CC.Effect[i]
        end

        WAR.Person[WAR.CurID]["贴图类型"] = 0
        WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
        if ZHEN_ID >= 0 then
            WAR.Person[ZHEN_ID]["贴图类型"] = 0
            WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
        end

        local oldpic = WAR.Person[WAR.CurID]["贴图"] / 2 -- 当前贴图的位置
        local oldpic_type = 0
        local oldeft = -1
        local kfname = JY.Wugong[wugong]["名称"]
        local showsize = CC.FontBig
        local showx = CC.ScreenW / 2 - showsize * string.len(kfname) / 4
        local hb = GetS(JY.SubScene, x0, y0, 4)
        local hname = ""
        if ZHEN_ID >= 0 then
            -- kfname = "合击・"..kfname
            hname = "合击"
        end
        if WAR.ACT > 1 then
            hname = hname .. '连击'
        end
        -- 显示武功，放到特效文字4
        if wugong ~= 0 then
            if WAR.LHQ_BNZ == 1 then
                kfname = "般若掌"
            end
            if WAR.JGZ_DMZ == 1 then
                kfname = "达摩掌"
            end
            if WAR.WD_CLSZ == 1 then
                kfname = "赤练神掌"
            end
            if WAR.PD['傲寒六诀'][pid] ~= nil and WAR.PD['傲寒六诀'][pid] == 1 then
                kfname = "傲寒六诀"
                WAR.PD['傲寒六诀'][pid] = nil
            end
            if WAR.QZ_QXJF == 1 then
                kfname = "七星剑法"
            end
            if (wugong == 22 or wugong == 189) and Pmiji(pid, 15) then
                kfname = "金刚般若掌"
            end
            if wugong == 93 then
                kfname = "圣火令神功"
            end
        end

        -- 王重阳一气化三清文字
        if WAR.YQFSQ == 1 then
            kfname = "中神通・一气化三清"
        end
        if WAR.PD["如来神掌"][pid] == 1 then
            kfname = "如来神掌"

        end
        if WAR.PD["如来神掌"][pid] == 2 then
            kfname = "如来神掌●灭"
        end
        if WuyueJFSL(pid) > 4 then
            if wugong == 30 then
                kfname = "北岳神剑"
            elseif wugong == 31 then
                kfname = "东岳神剑"
            elseif wugong == 32 then
                kfname = "南岳神剑"
            elseif wugong == 33 then
                kfname = "中岳神剑"
            elseif wugong == 34 then
                kfname = "西岳神剑"
            end
        end
        -- 金蛇奥义
        if WAR.JSAY == 1 then
            -- kfname = "奥义・金蛇狂舞"
            -- hname = hname..'・奥义・金蛇狂舞'
        end
        -- 青蟒剑
        if WAR.QMJ == 1 then
            kfname = "青蟒剑"
        end
        -- 陈正德
        if WAR.CZD == 1 then
            kfname = "无情三绝斩"
        end
        -- 莫大七弦无形剑 奥义
        if WAR.QXWXJ == 1 then
            -- kfname = "绝技・七弦无形剑・无形剑气"
            hname = hname .. '・绝技・七弦无形剑气'
        end
        -- 周威信呼延十八鞭显示倍数
        if wugong == 206 and match_ID(pid, 612) and WAR.ZWX > 0 then
            kfname = kfname .. " X " .. WAR.ZWX
        end
        -- 卓天雄呼延十八鞭显示倍数
        if wugong == 206 and match_ID(pid, 613) and WAR.ZWX > 0 then
            kfname = kfname .. " X " .. WAR.ZWX
        end
        -- 卓天雄震天铁掌显示倍数
        if wugong == 205 and match_ID(pid, 613) and WAR.ZWX > 0 then
            kfname = kfname .. " X " .. WAR.ZWX
        end
        -- 何铁手五毒显示倍数
        if wugong == 3 and (match_ID(pid, 83) or match_ID(pid, 9814) or Curr_NG(pid, 220)) and WAR.HTS > 0 then
            kfname = kfname .. " X " .. WAR.HTS
        end
        -- ・云罗天网
        if WAR.YLTW > 0 then
            kfname = "〖云罗天网〗・" .. kfname
        end
        -- 井月八法
        if WAR.KZJYBF > 0 then
            kfname = "【井月八法】・" .. WAR.KZJYBF .. " 式・" .. kfname
        end

        if WAR.PD["天剑"][pid] ~= nil then
            if wugong ~= 380 then
                kfname = "『天剑』・" .. kfname
            end
        end
        if (wugong == 39 or wugong == 42 or wugong == 139) and Pmiji(pid, 23) then
            kfname = "『双剑合璧』・" .. kfname
        end
        if WAR.BXXHSJ == 1 then
            kfname = "『雪花神剑』・" .. kfname
        end

        -- 特效文字4和武功名称显示
        if wugong > 0 or WAR.hit_DGQB == 1 then -- 使用武功时才显示，独孤求败反击也显示
            if WAR.Person[WAR.CurID]["特效文字4"] ~= nil then
                for k = 0, 30, 4 do
                    local i = k
                    if i > 20 then
                        i = 20
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    local n, strs = Split(WAR.Person[WAR.CurID]["特效文字4"], "・");
                    local len = string.len(WAR.Person[WAR.CurID]["特效文字4"]);
                    local color = RGB(255, 40, 10);
                    local off = 0;
                    for j = 1, n do
                        if strs[j] == "连击" or strs[j] == "天赋外功.炉火纯青" or strs[j] ==
                            "碧箫声里双鸣凤" or strs[j] == "英雄无双风流婿" or strs[j] ==
                            "刀光掩映孔雀屏" or strs[j] == "太极之形.圆转不断" then
                            color = M_LightBlue;
                        elseif strs[j] == "左右互搏" then
                            color = M_DarkOrange
                        else
                            color = RGB(255, 40, 10);
                        end
                        if j > 1 then
                            strs[j] = strs[j];
                            off = off + 42
                        end
                        DrawStrBox(-1, 10 + off, strs[j], color, 10 + i)
                    end

                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end
            ---老顾0309
            -- 武功招式文字显示
            -- 看有没有招式
            local zsnum
            if CC.KFMove[JY.Person[pid]["优先使用"]] ~= nil then
                local cz = 0

                if wugong == JY.Person[pid]["优先使用"] then
                    zsnum = WAR.WGZS
                else
                    zsnum = 1
                end
                local zsname = CC.KFMove[JY.Person[pid]["优先使用"]][zsnum][1]
                if zsnum ~= #CC.KFMove[JY.Person[pid]["优先使用"]] then
                    for n = 5, 20 do
                        local i = n
                        if i > 20 then
                            i = 20
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')

                        if WAR.DZXY == 1 then
                            zsname = WAR.PD['斗转招式名字'][pid]
                        end

                        local size = CC.DefaultFont * 2.5
                        local name = kfname
                        local name1 = string.sub(name, 1, 2)
                        local name2 = string.sub(name, 3, 4)
                        local name3 = string.sub(name, 5, 6)
                        local name4 = string.sub(name, 7, 8)
                        local name5 = string.sub(name, 9, 10)
                        local name6 = string.sub(name, 11, 12)
                        local stn = string.len(name) / 2
                        local hsize = CC.ScreenH / 4.266 / stn

                        local rx, ry = CC.ScreenW / 2, CC.ScreenH / 2
                        local nx = rx - #name * size / 2
                        local ax, ay = 0, 0
                        local cl = C_RED
                        local cl1 = C_WHITE
                        local cl2 = M_DeepSkyBlue

                        local mx, my = lib.GetPNGXY(91, 30 * 2)
                        local mx1, my1 = lib.GetPNGXY(91, 20 * 2)
                        local ny = ry - my / 1.1

                        local size1 = CC.FONT2
                        local size2 = size * 0.6
                        local size3 = size * 0.6
                        lib.LoadPNG(91, 30 * 2, nx - mx / 4, ny + size2 / 4, 1)
                        lib.DrawStr(nx, ny + size2, name1, cl, size3, size1, 0, 0)
                        lib.DrawStr(nx, ny + size2 * 2, name2, cl, size3, size1, 0, 0)
                        lib.DrawStr(nx, ny + size2 * 3, name3, cl, size3, size1, 0, 0)
                        lib.DrawStr(nx, ny + size2 * 4, name4, cl, size3, size1, 0, 0)
                        lib.DrawStr(nx, ny + size2 * 5, name5, cl, size3, size1, 0, 0)
                        lib.DrawStr(nx, ny + size2 * 6, name6, cl, size3, size1, 0, 0)

                        -- 招式名称

                        local zsname1 = string.sub(zsname, 1, 2)
                        local zsname2 = string.sub(zsname, 3, 4)
                        local zsname3 = string.sub(zsname, 5, 6)
                        local zsname4 = string.sub(zsname, 7, 8)
                        local zsname5 = string.sub(zsname, 9, 10)
                        local zsname6 = string.sub(zsname, 11, 12)
                        local stn1 = string.len(zsname) / 2
                        local hsize1 = CC.ScreenH / 4.266 / stn1
                        local nx1 = nx + mx
                        local ny1 = ny + size3
                        lib.LoadPNG(91, 30 * 2, nx1 - mx / 4, ny1 + size2 / 4, 1)
                        lib.DrawStr(nx1, ny1 + size2, zsname1, cl1, size3, size1, 0, 0)
                        lib.DrawStr(nx1, ny1 + size2 * 2, zsname2, cl1, size3, size1, 0, 0)
                        lib.DrawStr(nx1, ny1 + size2 * 3, zsname3, cl1, size3, size1, 0, 0)
                        lib.DrawStr(nx1, ny1 + size2 * 4, zsname4, cl1, size3, size1, 0, 0)
                        lib.DrawStr(nx1, ny1 + size2 * 5, zsname5, cl1, size3, size1, 0, 0)
                        lib.DrawStr(nx1, ny1 + size2 * 6, zsname6, cl1, size3, size1, 0, 0)

                        -- 合计、奥义
                        if hname ~= "" then
                            local hname1 = string.sub(hname, 1, 2)
                            local hname2 = string.sub(hname, 3, 4)
                            local hname3 = string.sub(hname, 5, 6)
                            local hname4 = string.sub(hname, 7, 8)
                            local hname5 = string.sub(hname, 9, 10)
                            local hname6 = string.sub(hname, 11, 12)

                            local stn2 = string.len(hname) / 2
                            local hsize2 = CC.ScreenH / 4.266 / stn2
                            local nx2 = nx - mx
                            local ny2 = ny - size3
                            lib.LoadPNG(91, 20 * 2, nx2 - mx / 2, ny2 + size2 / 2 + size2 / 4, 1)
                            lib.DrawStr(nx2, ny2 + size2, hname1, cl2, size3, size1, 0, 0)
                            lib.DrawStr(nx2, ny2 + size2 * 2, hname2, cl2, size3, size1, 0, 0)
                            lib.DrawStr(nx2, ny2 + size2 * 3, hname3, cl2, size3, size1, 0, 0)
                            lib.DrawStr(nx2, ny2 + size2 * 4, hname4, cl2, size3, size1, 0, 0)
                            lib.DrawStr(nx2, ny2 + size2 * 4, hname5, cl2, size3, size1, 0, 0)
                            lib.DrawStr(nx2, ny2 + size2 * 4, hname6, cl2, size3, size1, 0, 0)
                        end

                        -- draw3(name,bx*1280,by*473- ((stn-1)*hsize+size)/2, C_CYGOLD, size,nil,hsize)
                        -- lib.LoadPNG(91,118*2,CC.ScreenW/9.784,by*48,1)
                        -- lib.DrawStr(bx*480-string.len(kfname)/2*CC.DefaultFont*2,by*80,kfname, C_GOLD,CC.DefaultFont*2, CONFIG.CurrentPath.."FONT/1.ttf",  0, 0)
                        -- lib.DrawStr(bx*488,by*95,zsname, C_WHITE,CC.DefaultFont*1.4, CONFIG.CurrentPath.."FONT/1.ttf",  0, 0)
                        ShowScreen()
                        lib.Delay(CC.BattleDelay + i)
                    end
                else
                    -- 绝招文字 绝招背景
                    local name = kfname
                    local size = CC.DefaultFont * 2.5
                    local size1 = CC.FONT2
                    local size2 = size
                    local size3 = size
                    local rx, ry = CC.ScreenW / 2, CC.ScreenH / 2
                    local nx = rx - #name * size / 2
                    local ax, ay = 0, 0
                    local cl = M_Black
                    local cl1 = C_WHITE
                    local cl2 = M_DeepSkyBlue

                    local mx, my = lib.GetPNGXY(91, 30 * 2)
                    local mx1, my1 = lib.GetPNGXY(91, 20 * 2)
                    local ny = ry - my / 1.1

                    for k = 1, 20 do
                        local i = 12 + k
                        if i > 24 then
                            i = 24
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        -- NewDrawString(-1, -1,  '绝 招 ・ ' .. '['..zsname..']', C_GOLD, 25 + i)
                        -- local cx, h = lib.GetPNGXY(91, 3* 2)
                        lib.LoadPNG(91, 313 * 2, nx - size, ny, 1)
                        lib.DrawStr(nx - size, ny + size2, '绝招・', M_Red, size3 * 1.5, size1, 0, 0)
                        lib.DrawStr(nx + size * 3.5, ny + size2 * 1.4, zsname, M_DarkOrange, size3, size1, 0, 0)
                        -- lib.DrawStr(nx,ny+size2*2,name2, cl,size3, size1,  0, 0)
                        -- lib.DrawStr(nx,ny+size2*3,name3, cl,size3, size1,  0, 0)
                        -- lib.DrawStr(nx,ny+size2*4,name4, cl,size3, size1,  0, 0)	
                        -- lib.DrawStr(nx,ny+size2*5,name5, cl,size3, size1,  0, 0)
                        -- lib.DrawStr(nx,ny+size2*6,name6, cl,size3, size1,  0, 0)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                end
            end
        end

        -- 暗器显示
        if using_anqi == 1 then
            for i = 5, 10 do
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                if WAR.KHSZ == 1 then
                    KungfuString("葵花神针", CC.ScreenW / 2 - #anqi_name / 2, CC.ScreenH / 3 - 20 - hb, C_RED,
                        CC.FontBig + i, CC.FontName, 0)
                else
                    KungfuString(anqi_name .. "×" .. WAR.AQBS, CC.ScreenW / 2 - #anqi_name / 2,
                        CC.ScreenH / 3 - 20 - hb, C_GOLD, CC.FontBig + i, CC.FontName, 0)
                end
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
        end

        -- 显示攻击动画
        for i = 0, framenum - 1 do
            if JY.Restart == 1 then
                break
            end
            local tstart = lib.GetTime()
            local mytype = nil
            if fightframe > 0 then
                WAR.Person[WAR.CurID]["贴图类型"] = 1
                mytype = 101 + JY.Person[pid]['头像代号']
                if i < fightframe then
                    WAR.Person[WAR.CurID]["贴图"] =
                        (startframe + WAR.Person[WAR.CurID]["人方向"] * fightframe + i) * 2
                end
            else
                WAR.Person[WAR.CurID]["贴图类型"] = 0
                WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
                mytype = 0
            end

            if ZHEN_ID >= 0 then
                if ZHEN_fightframe > 0 then
                    WAR.Person[ZHEN_ID]["贴图类型"] = 1

                    if i < ZHEN_fightframe and i < oldframe - 1 then
                        WAR.Person[ZHEN_ID]["贴图"] = (ZHEN_startframe + WAR.Person[ZHEN_ID]["人方向"] *
                                                            ZHEN_fightframe + i) * 2
                    else
                        WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
                    end
                else
                    WAR.Person[ZHEN_ID]["贴图类型"] = 0
                    WAR.Person[ZHEN_ID]["贴图"] = WarCalPersonPic(ZHEN_ID)
                end
                SetWarMap(WAR.Person[ZHEN_ID]["坐标X"], WAR.Person[ZHEN_ID]["坐标Y"], 5,
                    WAR.Person[ZHEN_ID]["贴图"])
            end

            if oldframe2 <= framenum then
                zjgd(i, oldframe2 - 1)
            else
                zjgd(i, framenum - 1)
            end

            if i == sounddelay then
                PlayWavAtk(JY.Wugong[wugong]["出招音效"]) --
            end

            if i == fightdelay then
                PlayWavE(eft)
            end

            -- 六脉神剑的音效
            if i == 1 and WAR.LMSJwav == 1 then
                PlayWavAtk(31)
                WAR.LMSJwav = 0
            end
            if i == 1 and WAR.XLwav == 1 then
                PlayWavAtk(71)
                WAR.XLwav = 0
            end
            if i == 1 and WAR.JNTM == 1 then
                PlayWavAtk(33)
                WAR.JNTM = 0
            end

            local pic = WAR.Person[WAR.CurID]["贴图"] / 2

            lib.SetClip(0, 0, 0, 0)

            oldpic = pic
            oldpic_type = mytype

            -- 无酒不欢：攻击特效文字显示 8-3

            if i < fightdelay then
                WarDrawMap(4, pic * 2, mytype, -1)

                -- 袁承志暴击倍数显示
                -- 仅限我方
                if match_ID(pid, 54) and isteam(pid) and using_anqi == 0 and WAR.BJ == 1 then
                    local cri_factor = 1.5 + 0.1 * JY.Base["天书数量"]
                    KungfuString("暴击×" .. cri_factor, CC.ScreenW - 230 + i * 2, CC.ScreenH / 3 - 50 - hb - i * 2,
                        C_RED, CC.FontBig + i * 2, CC.FontName, 0)
                end

                if i == 1 and WAR.Person[WAR.CurID]["特效动画"] ~= -1 then
                    local theeft = WAR.Person[WAR.CurID]["特效动画"]
                    local sf = 0
                    for ii = 0, theeft - 1 do
                        sf = sf + CC.Effect[ii]
                    end
                    -- 攻击动画位置
                    if theeft == 118 then
                        py = CC.YScale * 150
                    end

                    for ii = 1, CC.Effect[theeft] do
                        lib.GetKey()

                        Cat('实时特效动画')
                        WarDrawMap(6, pic * 2, mytype, (sf + ii) * 2, nil, 3, nil, nil)
                        Cat('实时特效动画2')
                        -- lib.PicLoadCache(3, (sf+ii) * 2, CC.ScreenW/2 , CC.ScreenH/2  - hb, 2, 192, nil, 0, 0)	
                        if WAR.Person[WAR.CurID]["特效文字0"] ~= nil then
                            KungfuString(WAR.Person[WAR.CurID]["特效文字0"], CC.ScreenW / 2,
                                CC.ScreenH / 702 * 265 - hb, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
                        end
                        if WAR.Person[WAR.CurID]["特效文字1"] ~= nil then
                            KungfuString(WAR.Person[WAR.CurID]["特效文字1"], CC.ScreenW / 2,
                                CC.ScreenH / 702 * 265 - hb, C_RED, CC.FontSmall5, CC.FontName, 3)
                        end
                        if WAR.Person[WAR.CurID]["特效文字2"] ~= nil then
                            KungfuString(WAR.Person[WAR.CurID]["特效文字2"], CC.ScreenW / 2,
                                CC.ScreenH / 702 * 265 - hb, C_GOLD, CC.FontSmall5, CC.FontName, 2)
                        end
                        if WAR.Person[WAR.CurID]["特效文字3"] ~= nil then
                            KungfuString(WAR.Person[WAR.CurID]["特效文字3"], CC.ScreenW / 2,
                                CC.ScreenH / 702 * 265 - hb, C_WHITE, CC.FontSmall5, CC.FontName, 1)
                        end
                        -- Cat('实时特效动画2')
                        ShowScreen()
                        lib.Delay(CC.BattleDelay)

                    end
                    WAR.Person[WAR.CurID]["特效动画"] = -1
                else
                    if WAR.Person[WAR.CurID]["特效文字0"] ~= nil or WAR.Person[WAR.CurID]["特效文字1"] ~= nil or
                        WAR.Person[WAR.CurID]["特效文字2"] ~= nil or WAR.Person[WAR.CurID]["特效文字3"] ~= nil then
                        Cat('实时特效动画')
                        WarDrawMap(4, pic * 2, mytype, -1)
                        Cat('实时特效动画2')
                        KungfuString(WAR.Person[WAR.CurID]["特效文字0"], CC.ScreenW / 2,
                            CC.ScreenH / 702 * 265 - hb, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
                        KungfuString(WAR.Person[WAR.CurID]["特效文字1"], CC.ScreenW / 2,
                            CC.ScreenH / 702 * 265 - hb, C_RED, CC.FontSmall5, CC.FontName, 3)
                        KungfuString(WAR.Person[WAR.CurID]["特效文字2"], CC.ScreenW / 2,
                            CC.ScreenH / 702 * 265 - hb, C_GOLD, CC.FontSmall5, CC.FontName, 2)
                        KungfuString(WAR.Person[WAR.CurID]["特效文字3"], CC.ScreenW / 2,
                            CC.ScreenH / 702 * 265 - hb, C_WHITE, CC.FontSmall5, CC.FontName, 1)
                    else
                        Cat('实时特效动画')
                        WarDrawMap(4, pic * 2, mytype, -1)
                        Cat('实时特效动画2')
                    end
                end
            else
                for k = 0, WAR.PersonNum - 1 do
                    local sx, sy = WAR.Person[k]['坐标X'], WAR.Person[k]['坐标Y']
                    if WAR.Person[k]['死亡'] == false then
                        if WAR.Person[k]['闪避'] == true then
                            if GetWarMap(sx, sy, 4) <= 10 then
                                SetWarMap(sx, sy, 4, 11)
                            else
                                SetWarMap(sx, sy, 4, GetWarMap(sx, sy, 4) + 1)
                            end
                        end
                    end
                end
                -- 人物动作计算
                if i <= oldframe - 1 then
                    starteft = starteft + 1
                else
                    starteft = -1
                end

                Cat('实时特效动画')
                WarDrawMap(4, pic * 2, mytype, (starteft) * 2, nil, 3, ex, ey)

                Cat('实时特效动画2')
                oldeft = starteft

                if WAR.MissPd == 0 then
                    if oldframe2 < framenum then
                        if i == oldframe2 - 1 then
                            break
                        end
                    else
                        if i == framenum - 1 then
                            break
                        end
                    end
                end
            end
            ShowScreen()
            lib.Delay(CC.BattleDelay);
            lib.GetKey();
        end
        WAR.Person[WAR.CurID]['特效文字0'] = nil;
        WAR.Person[WAR.CurID]['特效文字1'] = nil;
        WAR.Person[WAR.CurID]['特效文字2'] = nil;
        WAR.Person[WAR.CurID]['特效文字3'] = nil;
        WAR.Person[WAR.CurID]['特效文字4'] = nil;
        WAR.Person[WAR.CurID]['特效动画'] = -1;

        -- lib.SetClip(0, 0, 0, 0)
        WAR.Person[WAR.CurID]["贴图类型"] = 0
        WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
        WAR.MissPd = 0
        WarSetPerson()
        Cat('实时特效动画')
        WarDrawMap(0)
        Cat('实时特效动画2')
        ShowScreen()
        lib.Delay(CC.BattleDelay)
        local yc = math.ceil(200 / CC.BattleDelay)
        for j = 1, yc do
            Cat('实时特效动画')
            WarDrawMap(2)
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end
end
--自动暗器
function Auto_Anqi()
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local kungfuid = JY.Person[pid]["武功" .. kfid]
    local kungfulv = JY.Person[pid]["武功等级" .. kfid]
    if kungfulv == 999 then
        kungfulv = 11
    else
        kungfulv = math.modf(kungfulv / 100) + 1
    end
    -- local st1 = lib.GetTime()
    -- 武功范围计算
    local m1, m2, a1, a2, a3, a4, a5 = refw(kungfuid, kungfulv)
    -- 移动范围
    local mfw = {m1, m2}
    -- 攻击范围
    local atkfw = {a1, a2, a3, a4, a5}
    if kungfulv == 11 then
        kungfulv = 10
    end
    -- AI也用新的威力判定
    local kungfuatk = get_skill_power(pid, kungfuid, kungfulv)
    local atkarray = {}
    local num = 0
    CleanWarMap(4, -1)
    -- local st2 = lib.GetTime()
    -- 定义攻击者，攻击者移动步数，0表
    local movearray = War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)

    -- local st3 = lib.GetTime()
    -- 循环人物移动步数
    for i = 0, WAR.Person[WAR.CurID]["移动步数"] do
        -- 定义
        local step_num = movearray[i].num
        if step_num ~= nil then
            for j = 1, step_num do
                local xx = movearray[i].x[j]
                local yy = movearray[i].y[j]
                num = num + 1
                atkarray[num] = {}
                atkarray[num].x, atkarray[num].y = xx, yy
                atkarray[num].p, atkarray[num].ax, atkarray[num].ay = GetAtkNum(xx, yy, mfw, atkfw, kungfuatk)
            end
        end
    end
    for i = 1, num - 1 do
        for j = i + 1, num do
            if atkarray[i].p < atkarray[j].p then
                atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
            end
        end
    end
    --攻击范围内有敌人
    if atkarray[1].p > 0 then
        for i = 2, num do
            if atkarray[i].p == 0 or atkarray[i].p < atkarray[1].p / 2 then
                num = i - 1
                break
            end
        end

        for i = 1, num - 1 do
            for j = i + 1, num do
                if atkarray[i].p < atkarray[j].p then
                    atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
                elseif atkarray[i].p == atkarray[j].p and math.random(2) > 1 then
                    atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
                end
            end
        end
        local select = 1 -- math.random(num)
        -- say('时间1'..st1..'*'..'时间2'..st2..'*'..'时间3'..st3..'*'..'时间4'..st4..'*'..'时间5'..st5,1)		
        War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
        War_MovePerson(atkarray[select].x, atkarray[select].y)
        -- 老顾0309
        -- 随机招式 随机武功招式 优先绝招
        local zsn1 = {}
        local zsn = 0
        local YXSY = JY.Person[pid]["优先使用"]
        local zsmenu = {}
        local zspd = false
        if YXSY > 0 then
            for i = 1, JY.Base["武功数量"] do
                for j = 1, #CC.KFMove[YXSY] do
                    if j == 1 then
                        CC.KFMove[YXSY][j][3] = 0
                    end
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == YXSY then
                        if JY.Person[pid]["武功招式" .. zs] == 1 then
                            if JY.Person[pid]["能量"] >= CC.KFMove[YXSY][j][3] then
                                zsmenu[#zsmenu + 1] = j -- 招式位置   
                                -- lib.Debug('收集可用招式'..j)                                               
                            end
                        end
                    end
                end
            end
        end

        local zsnum = #zsmenu
        -- lib.Debug('可使用招式数量'..zsnum) 
        if WAR.LQZ[pid] == nil then
            WAR.LQZ[pid] = 0
        end

        local zn = zsnum
        if JY.Person[pid]['招式方针'] == 0 then 
            if WAR.LQZ[pid] - JZ_lqz(pid) < 0 then
                if zn < 1 then
                    zn = 1
                    zsmenu[#zsmenu + 1] = 1
                else
                    zn = zn - 1
                end
                -- lib.Debug('zn== '..zn)
                local zs1 = 1
                if zn > zs1 then
                    zs1 = math.random(zn)
                end
                -- lib.Debug(JY.Person[pid]['姓名']..'随机招式'..zs1)
                zsn = zsmenu[zs1]
                -- lib.Debug(JY.Person[pid]['姓名']..'使用招式'..zsn)
            else
                zsn = zsmenu[zsnum]
            end
        else
            if WAR.LQZ[pid] - JZ_lqz(pid) < 0 then
                zsn = JY.Person[pid]['招式方针']
            else
                zsn = zsmenu[zsnum]
            end  
        end

        -- 随机一个招式位置
        -- zsn = 1  
        if zsn ~= nil and zsn > 0 then
            -- lib.Debug(JY.Person[pid]['姓名']..' 使用'..JY.Wugong[YXSY]['名称']..'第'..zsn..'招')
            WAR.WGZS = zsn
            War_Fight_Sub(WAR.CurID, kfid, atkarray[select].ax, atkarray[select].ay)
        else
            War_AutoEscape()
            War_RestMenu()
        end
        if fjpd(WAR.CurID) then
            return
        end
        -- 阿凡提攻击完躲开
        if pid == 606 then
            WAR.Person[WAR.CurID]["移动步数"] = 10
            War_AutoEscape()
            War_RestMenu()
        end
    else
        if fjpd(WAR.CurID) then
            return
        end

        -- 打不到人，考虑吃药
        local jl, nx, ny = War_realjl()
        AutoMove()

        -- 剑魔BOSS
        if match_ID(pid, 592) and Boss(WAR.CurID) then
            War_Fight_Sub(WAR.CurID, kfid, WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"])
            return
        end
        -- 默认为休息
        local what_to_do = 0
        local can_eat_drug = 0
        -- 非我方，会考虑吃药
        if WAR.Person[WAR.CurID]["我方"] == false then
            can_eat_drug = 1
            -- 如果是我方，只有在队且允许才会吃药
        else
            if isteam(pid) and JY.Person[pid]["是否吃药"] == 1 then
                can_eat_drug = 1
            end
        end
        -- 侠客正岛主战不吃药
        -- 洪七公居洪七公不吃药
        if WAR.Person[WAR.CurID]["我方"] == false and (WAR.ZDDH == 188 or WAR.ZDDH == 257) then
            can_eat_drug = 0
        end
        -- 左右第二下，不能吃药
        if WAR.ZYHB == 2 then
            can_eat_drug = 0
        end
        -- 1:吃体力药 2：吃血 3：医疗 4：吃内力 5：吃解毒 NPCWAR不吃药
        if can_eat_drug == 1 and WAR.ZDDH ~= 354 then
            local r = -1
            -- 体力低于10，吃体力药
            if JY.Person[pid]["体力"] < 10 then
                r = War_ThinkDrug(4)
                if r >= 0 then
                    what_to_do = 1
                end
            end
            local rate = -1
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 5 then
                rate = 90
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
                rate = 70
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 3 then
                rate = 50
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
                rate = 25
            end
            -- 内伤也增加吃血药几率
            if WAR.PD['内伤状态'][pid] ~= nil and WAR.PD['内伤状态'][pid] > 50 then
                rate = rate + 50
            end
            if Rnd(100) < rate then
                r = War_ThinkDrug(2)
                if r >= 0 then -- 如果有药吃药 
                    what_to_do = 2
                else
                    r = War_ThinkDoctor() -- 如果没有药，考虑医疗
                    if r >= 0 then
                        what_to_do = 3
                    end
                end
            end
            -- 考虑内力
            rate = -1
            if JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 6 then
                rate = 100
            elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 5 then
                rate = 75
            elseif JY.Person[pid]["内力"] < JY.Person[pid]["内力最大值"] / 4 then
                rate = 50
            end
            if Rnd(100) < rate then
                r = War_ThinkDrug(3)
                if r >= 0 then
                    what_to_do = 4
                end
            end
            rate = -1
            if CC.PersonAttribMax["中毒程度"] * 3 / 4 < JY.Person[pid]["中毒程度"] then
                rate = 60
            else
                if CC.PersonAttribMax["中毒程度"] / 2 < JY.Person[pid]["中毒程度"] then
                    rate = 30
                end
            end
            -- 半血以下，才吃解毒药
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 and Rnd(100) < rate then
                r = War_ThinkDrug(6)
                if r >= 0 then
                    what_to_do = 5
                end
            end
        end
        -- 吃药flag 2：生命 3：内力 4：体力 6：解毒
        if what_to_do == 0 then
            War_RestMenu()
        elseif what_to_do == 1 then
            War_AutoEatDrug(4)
        elseif what_to_do == 2 then
            War_AutoEatDrug(2)
        elseif what_to_do == 3 then
            War_AutoDoctor()
        elseif what_to_do == 4 then
            War_AutoEatDrug(3)
        elseif what_to_do == 5 then
            War_AutoEatDrug(6)
        end
    end
    --WAR.Person[emeny]["生命点数"] = War_AnqiHurt(pid, emeny, thingid)
    --SetWarMap(x1, y1, 4, 2)
end

---执行医疗，解毒用毒暗器的子函数，自动医疗也可调用
function War_ExecuteMenu_Sub(x1, y1, flag, thingid)
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local x0 = WAR.Person[WAR.CurID]["坐标X"]
    local y0 = WAR.Person[WAR.CurID]["坐标Y"]
    CleanWarMap(4, 0)
    WAR.ShowHP = 0
    WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x1, y1)
    SetWarMap(x1, y1, 4, 1)
    local emeny = GetWarMap(x1, y1, 2)
    if emeny >= 0 then
        if flag == 1 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
            Cat('神游太虚2')
            if myzd(emeny) == false then
                WAR.Person[emeny]["中毒点数"] = War_PoisonHurt(pid, emeny)
                WAR.TXXS[WAR.Person[emeny]["人物编号"]] = 1
            end
            SetWarMap(x1, y1, 4, 5)
        elseif flag == 2 and WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
            WAR.Person[emeny]["解毒点数"] = ExecDecPoison(pid, WAR.Person[emeny]["人物编号"])
            SetWarMap(x1, y1, 4, 6)
            WAR.TXXS[WAR.Person[emeny]["人物编号"]] = 1
        elseif flag == 3 then
            -- 医生单独判定
            if WAR.Person[WAR.CurID]["人物编号"] == 0 and JY.Base["标准"] == 8 then

            elseif WAR.Person[WAR.CurID]["我方"] == WAR.Person[emeny]["我方"] then
                WAR.Person[emeny]["生命点数"] = ExecDoctor(pid, WAR.Person[emeny]["人物编号"])
                SetWarMap(x1, y1, 4, 4)
                WAR.TXXS[WAR.Person[emeny]["人物编号"]] = 1
            end

            -- 暗器
        elseif flag == 4 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] then
            Cat('神游太虚2')
            -- 葵花尊者反击暗器
            if WAR.Person[emeny]["人物编号"] == 27 and match_ID(WAR.Person[WAR.CurID]["人物编号"], 498) == false then
                CleanWarMap(4, 0)
                local orid = WAR.CurID
                WAR.CurID = emeny

                WAR.Person[WAR.CurID]["人方向"] = War_Direct(WAR.Person[WAR.CurID]["坐标X"],
                    WAR.Person[WAR.CurID]["坐标Y"], x0, y0)

                Cls()
                local KHZZ = {"无知的" .. JY.Person[0]["外号2"], "竟然想班门弄斧", "吃我的葵花神针"}

                for n = 1, #KHZZ + 25 do
                    local i = n
                    if i > #KHZZ then
                        i = #KHZZ
                    end
                    lib.GetKey()
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    DrawString(-1, -1, KHZZ[i], C_GOLD, CC.Fontsmall)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end

                SetWarMap(x0, y0, 4, 1)

                WAR.Person[orid]["生命点数"] = (WAR.Person[orid]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "生命", -300)
                if myzd(orid) == false then
                    WAR.Person[orid]["中毒点数"] = (WAR.Person[orid]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"],"中毒程度", 150)
                end
                WAR.TXXS[WAR.Person[orid]["人物编号"]] = 1

                WAR.KHSZ = 1

                War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, -1, 0, x0, y0, 35)

                WAR.KHSZ = 0

                WAR.CurID = orid
                return 1
            end
            -- 亦复如是
            if WAR.PD["亦复如是"][WAR.Person[emeny]["人物编号"]] == 1 then
                local aq = War_AnqiHurt(pid, emeny, thingid)
                local orid = WAR.CurID
                WAR.CurID = emeny
                Cls()
                WAR.Person[orid]["生命点数"] = (WAR.Person[orid]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "生命", -War_AnqiHurt(pid, emeny, -aq))
                if myzd(orid) == false then
                    WAR.Person[orid]["中毒点数"] = (WAR.Person[orid]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[orid]["人物编号"], "中毒程度", 150)
                end
                WAR.TXXS[WAR.Person[orid]["人物编号"]] = 1
                War_ShowFight(WAR.Person[WAR.CurID]["人物编号"], 0, -1, 0, x0, y0, 35)
                WAR.CurID = orid
                return 1
            end

            -- 独孤求败免疫暗器
            if match_ID(WAR.Person[emeny]["人物编号"], 592) and match_ID(WAR.Person[WAR.CurID]["人物编号"], 498) == false then
                local orid = WAR.CurID
                WAR.CurID = emeny
                Cls()
                CurIDTXDH(WAR.CurID, 137, 1, "料敌先机・破针式", C_GOLD)
                WAR.CurID = orid
                return 1
            end
            -- 免疫暗器
            if match_ID(WAR.Person[emeny]["人物编号"], 641) and match_ID(WAR.Person[WAR.CurID]["人物编号"], 498) == false then
                local orid = WAR.CurID
                WAR.CurID = emeny
                Cls()
                WAR.CurID = orid
                return 1
            end
            -- 暗器随机伤害倍数
            WAR.AQBS = math.random(3)

            if match_ID(pid, 721) then
                WAR.AQBS = 1
            end

            if match_ID(pid, 83) then
                WAR.AQBS = 1
            end

            -- 袁承志用金蛇锥必定三倍
            if (match_ID(pid, 54) and thingid == 30) or match_ID(pid, 498) then
                WAR.AQBS = 3
            end
            -- 夏雪宜用金蛇锥必定三倍
            if match_ID(pid, 639) and thingid == 30 then
                WAR.AQBS = math.random(3, 5)
            end
            -- 李寻欢暗器攻击倍数
            if WAR.PD["小李飞刀"][pid] ~= nil then
                WAR.AQBS = math.random(3, 5)
            end
            if WAR.PD["小李飞刀"][pid] ~= nil and JLSD(35, 55, pid) and JY.Person[0]["六如觉醒"] > 0 then
                WAR.AQBS = math.random(5, 10)
            end

            -- 含沙射影使用暗器为7*7方阵
            if match_ID(pid, 9752) then
                -- 暗器随机伤害倍数
                for ex = x1 - 3, x1 + 3 do
                    for ey = y1 - 3, y1 + 3 do
                        SetWarMap(ex, ey, 4, 1)
                        if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                            local ep = GetWarMap(ex, ey, 2)
                            if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
                                WAR.Person[ep]["生命点数"] = War_AnqiHurt(pid, ep, thingid)
                                SetWarMap(ex, ey, 4, 4)
                            end
                        end
                    end
                end
            elseif match_ID(pid, 498) and JY.Base["天书数量"] > 5 then
                for ex = x1 - 3, x1 + 3 do
                    for ey = y1 - 3, y1 + 3 do
                        SetWarMap(ex, ey, 4, 1)
                        if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                            local ep = GetWarMap(ex, ey, 2)
                            if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
                                WAR.Person[ep]["生命点数"] = War_AnqiHurt(pid, ep, thingid)
                                SetWarMap(ex, ey, 4, 4)
                            end
                        end
                    end
                end
            else
                WAR.Person[emeny]["生命点数"] = War_AnqiHurt(pid, emeny, thingid)
                SetWarMap(x1, y1, 4, 2)
            end
        end
    end

    -- 主角医生方阵医疗
    if flag == 3 and pid == 0 and JY.Base["标准"] == 8 then
        for ex = x1 - 3, x1 + 3 do
            for ey = y1 - 3, y1 + 3 do
                SetWarMap(ex, ey, 4, 1)
                if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                    local ep = GetWarMap(ex, ey, 2)
                    if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then
                        WAR.Person[ep]["生命点数"] = ExecDoctor(pid, WAR.Person[ep]["人物编号"])
                        SetWarMap(ex, ey, 4, 4)
                        WAR.Effect = 4
                    end
                end
            end
        end
    end
    -- 张三	
    if (match_ID(pid, 41) or match_ID(pid, 9825)) and WAR.ZSSS == 1 then
        for ex = x1 - 6, x1 + 6 do
            for ey = y1 - 6, y1 + 6 do
                SetWarMap(ex, ey, 4, 1)
                if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                    local ep = GetWarMap(ex, ey, 2)
                    if WAR.Person[WAR.CurID]["我方"] == WAR.Person[ep]["我方"] then
                        if isteam(pid) then
                            WAR.Person[ep]["生命点数"] = ExecDoctor(pid, WAR.Person[ep]["人物编号"])
                        else
                            WAR.Person[ep]["生命点数"] =
                                (WAR.Person[ep]["生命点数"] or 0) +
                                    AddPersonAttrib(WAR.Person[ep]["人物编号"], "生命", 100)
                        end
                        SetWarMap(ex, ey, 5, 5)
                        WAR.Effect = 4
                    end
                end
            end
        end
    end
    -- 主角毒王方阵上毒，可以给自己上毒
    if flag == 1 and pid == 0 and JY.Base["标准"] == 9 then
        for ex = x1 - 3, x1 + 3 do
            for ey = y1 - 3, y1 + 3 do
                SetWarMap(ex, ey, 4, 1)
                if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                    local ep = GetWarMap(ex, ey, 2)
                    if (WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"]) or ep == WAR.CurID then
                        if myzd(ep) == false then
                            WAR.Person[ep]["中毒点数"] = War_PoisonHurt(pid, ep)
                        end
                        SetWarMap(ex, ey, 4, 5)
                        WAR.Effect = 5
                    end
                end
            end
        end
    end

    -- 李四	标记修改
    if (match_ID(pid, 42) or match_ID(pid, 9824)) and WAR.LSFE == 1 then
        for ex = x1 - 6, x1 + 6 do
            for ey = y1 - 6, y1 + 6 do
                SetWarMap(ex, ey, 4, 1)
                if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                    local ep = GetWarMap(ex, ey, 2)
                    if (WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"]) then
                        WAR.Person[ep]["Life_Before_Hit"] = JY.Person[WAR.Person[ep]["人物编号"]]["生命"]
                        if myzd(ep) == false then
                            if isteam(pid) then
                                WAR.Person[ep]["中毒点数"] = War_PoisonHurt(pid, ep)
                            else
                                WAR.Person[ep]["中毒点数"] = (WAR.Person[ep]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[ep]["人物编号"], "中毒程度", 150)
                            end
                        end
                        SetWarMap(ex, ey, 5, 6)
                        WAR.Effect = 5
                        WAR.TXXS[WAR.Person[ep]["人物编号"]] = 1
                    end
                end
            end
        end
        Cat('数值显示')
    end

    if flag == 1 then
        War_ShowFight(pid, 0, 0, 0, x1, y1, 30)
    elseif flag == 2 then
        War_ShowFight(pid, 0, 0, 0, x1, y1, 36)
    elseif flag == 3 then
        War_ShowFight(pid, 0, 0, 0, x1, y1, 0)
    elseif flag == 4 and (emeny >= 0 or match_ID(pid, 83)) then
        War_ShowFight(pid, 0, -1, 0, x1, y1, thingid)
    end

    Cat('数值显示')
    if flag == 4 then
        if emeny >= 0 or match_ID(pid, 83) then
            instruct_32(thingid, -1)
            -- 张家辉的隐身戒指
            if JY.Person[pid]["防具"] == 304 then
                local cd = 40
                if JY.Thing[304]["装备等级"] >= 5 then
                    cd = 20
                elseif JY.Thing[304]["装备等级"] >= 3 then
                    cd = 30
                end
                WAR.YSJZ = cd
            end
            return 1
        else
            return 0
        end
    else
        -- WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 1
        if WAR.ZSSS == 1 or WAR.LSFE == 1 then
        else
            AddPersonAttrib(pid, "体力", -2)
        end
    end

    if isteam(pid) then
        if WAR.ZSSS == 1 or WAR.LSFE == 1 then
        else
            AddPersonAttrib(pid, "体力", -4)
        end
    end
    return 1
end

-- 无酒不欢：挨打后，绘画动态集气条的判定
function DrawTimeBar2()
    local bx, by = CC.WX, CC.HY
    local x1, x2, y = bx * CC.ScreenW * 1 / 2 - CC.ScreenW / 40, bx * CC.ScreenW * 19 / 20 - CC.ScreenW / 680,
        by * CC.ScreenH / 10 + CC.ScreenH / 26.48275
    local draw = false
    local heal_amount;

    -- 这三个是固定的，只需要加载一次就可以了
    -- 无酒不欢：这里也要判定是否有需要draw，如无需要则不加载
    local drawframe = false
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["死亡"] == false then
            if WAR.Person[i].TimeAdd ~= 0 then
                drawframe = true
                break
            end
        end
    end
    if drawframe == true then

        lib.LoadPNG(91, 23 * 2, CC.ScreenW / 3.4, CC.ScreenH / 153.6, 1)
        GUWarTime()
    end

    local pd = false
    while true do
        if JY.Restart == 1 then
            break
        end
        lib.GetKey()
        draw = false

        for i = 0, WAR.PersonNum - 1 do
            lib.GetKey()
            local pid = WAR.Person[i]["人物编号"];
            local kf = JY.Person[pid]['主运内功']
            local dkfcj_ng = JY.Wugong[kf]['层级']
            if WAR.PD['内伤状态'][pid] == nil then
                WAR.PD['内伤状态'][pid] = 0
            end
            -- 首先判定人物是否活着
            if WAR.Person[i]["死亡"] == false then
                if match_ID(pid, 114) and WAR.Person[i].TimeAdd < 0 then
                    WAR.Person[i].TimeAdd = 0
                end
                -- 逍遥御风累积9点，未行动前不会被杀气
                if WAR.PD["逍遥御风"][pid] ~= nil and WAR.PD["逍遥御风"][pid] == 11 and WAR.Person[i].TimeAdd < 0 then
                    WAR.Person[i].TimeAdd = 0
                end
                if  WAR.Defup[pid] ~= nil and WAR.Defup[pid] > 0 then
                    if WAR.Person[i].TimeAdd < 0 then
                        WAR.Person[i].TimeAdd = 0
                    end
                end
                -- 这里TimeAdd小于0代表集气位置要减少，数值为减少总量
                if WAR.Person[i].TimeAdd < 0 then
                    draw = true
                    -- 减量以20为单位循环增加，增加到超过0时，判定将不再成立，既停止减少集气位置
                    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd + 20
                    if WAR.Person[i].TimeAdd > 0 then
                        WAR.Person[i].TimeAdd = 0;
                    end
                    -- 如果人物的集气位置没有达到-100，则减少20，向-100靠近
                    if WAR.Person[i].Time > -100 then
                        -- 内轻特效610
                        if NeiGong_tx(pid, 610) then
                            if WAR.Person[i].Time > (dkfcj_ng - 1) * 80 then
                                WAR.Person[i].Time = WAR.Person[i].Time - 20
                                if WAR.Person[i].Time <= (dkfcj_ng - 1) * 80 then
                                    WAR.Person[i].Time = (dkfcj_ng - 1) * 80
                                    WAR.Person[i].TimeAdd = 0
                                end
                            end
                            -- 惊才绝艳    
                        elseif match_ID(pid, 9804) then
                            if WAR.Person[i].Time > 300 then
                                WAR.Person[i].Time = WAR.Person[i].Time - 20
                                if WAR.Person[i].Time <= 300 then
                                    WAR.Person[i].Time = 300
                                    WAR.Person[i].TimeAdd = 0
                                end
                            end
                            -- 双剑合壁杀气不会低于-100  
                        elseif Pmiji(pid, 23) then
                            if WAR.Person[i].Time > 0 then
                                WAR.Person[i].Time = WAR.Person[i].Time - 20
                                if WAR.Person[i].Time <= -100 then
                                    WAR.Person[i].Time = -100
                                    WAR.Person[i].TimeAdd = 0
                                end
                            end
                        else
                            WAR.Person[i].Time = WAR.Person[i].Time - 20
                        end
                        -- 如果人物的集气位置已经达到-100，则集气位置不再减少，而是转换为内伤
                        if WAR.Person[i].Time <= -100 then
                            WAR.Person[i].Time = -100
                            WAR.Person[i].TimeAdd = 0
                        end
                    else
                        for k = 0, -WAR.Person[i].TimeAdd, 20 do
                            local ns = WAR.PD['内伤状态'][pid] or 0 -- 1018
                            if ns < 100 then
                                -- AddPersonAttrib(pid, "受伤程度", math.random(3))
                                WAR.PD['内伤状态'][pid] = WAR.PD['内伤状态'][pid] + math.random(3)
                            else
                                WAR.Person[i].TimeAdd = 0
                                break
                            end
                        end
                        WAR.Person[i].TimeAdd = 0
                    end
                    --内轻特效1014                   
                    if NeiGong_tx(pid,1014) and  WAR.Person[i].Time <= -100  then -- 练了先天功后，当集气被杀到-100，内伤直接清0
                        WAR.Person[i].TimeAdd = 0
                        WAR.PD['内伤状态'][pid] = 0;
                        heal_amount = JY.Person[pid]["生命"]
                        heal_amount = math.modf(heal_amount * 0.15)
                        WAR.Person[i]["生命点数"] = AddPersonAttrib(pid, "生命", heal_amount)
                        Cls()
                        War_Show_Count(i, "不息")
                    end
                    -- 大于0代表集气位置要增加，
                elseif WAR.Person[i].TimeAdd > 0 then
                    draw = true
                    -- 增量以20为单位循环减少，减少到低于0时，判定将不再成立，既停止增加集气位置
                    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 20
                    -- 人物的集气位置以20为单位增加，如果集气位置超过995，则强制定为995
                    WAR.Person[i].Time = WAR.Person[i].Time + 20
                    if WAR.Person[i].Time > 995 then
                        WAR.Person[i].Time = 995;
                        WAR.Person[i].TimeAdd = 0
                    end
                end
            end
        end

        if draw then
            Cls()
            Cat('实时特效动画')
            DrawTimeBar_sub()
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
            pd = true
        else
            break
        end

    end
    if pd == true then
        local n = math.ceil(400 / CC.BattleDelay)
        for i = 1, n do
            Cls()
            Cat('实时特效动画')
            DrawTimeBar_sub()
            Cat('实时特效动画2')
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end
end

-- 绘制集气条
function DrawTimeBar()

    -- local x1,x2,y = CC.ScreenW * 1 / 2 - 34, CC.ScreenW * 19 / 20 - 2, CC.ScreenH/10 + 29
    local xunhuan = true
    local zdme = 0
    -- local xh = 0
    local jqwz = 0
    local atid = -1
    if WAR.ATK['人物'] ~= nil then
        atid = WAR.ATK['人物']
        WAR.ATK['人物'] = nil
        goto label1
    end
    WAR.ZYHB = 0

    if #WAR.ATK['人物table'] > 0 then
        atid = WAR.ATK['人物table'][#WAR.ATK['人物table']]
        local id = WAR.Person[atid]['人物编号']
        table.remove(WAR.ATK['人物table'], #WAR.ATK['人物table'])
        WAR.ATK['人物pd'][id] = nil
        if #WAR.ATK['人物table'] == 0 then
            WAR.ATK['人物table'] = {}
        end
        goto label1
    end

    while xunhuan do
        if JY.Restart == 1 then
            break
        end
        for i = 0, WAR.PersonNum - 1 do
            local menu = {}
            local menu1 = {}
            if WAR.Person[i]["死亡"] == true then
                menu1[#menu1] = i
            end
            if WAR.Person[i]["死亡"] == false then
                local jqid = WAR.Person[i]["人物编号"]
                local kf_ng = JY.Person[jqid]['主运内功']
                local kf_qg = JY.Person[jqid]['主运轻功']
                local kfcj_ng = JY.Wugong[kf_ng]['层级']
                local kfcj_qg = JY.Wugong[kf_qg]['层级']
                local Sxjs = {{9, WAR.JSX_Counter}, {6, WAR.LSX_Counter}, {5, WAR.WSX_Counter}, {3, WAR.SSX_Counter}}
                -- WAR.SSX_Counter = 0	--三时序计数器
                -- WAR.WSX_Counter = 0	--五时序计数器
                -- WAR.LSX_Counter = 0	--六时序计数器
                -- WAR.JSX_Counter = 0	--九时序计数器
                if WAR.PD['内伤状态'][jqid] == nil then
                    WAR.PD['内伤状态'][jqid] = 0
                end
            ----------------------------------人的集气位置 影响集气因素-----------------------------------------------
                local jq = WAR.Person[i].TimeAdd -- 人物集气速度
				--lib.Debug(JY.Person[jqid]['姓名']..'DrawTimeBar集气=='..jq)
                local ZQTL_tq = 0
                local HTC_tq = 0
                local bf_factor = 0;
                local chzt_jq = 0
                local jqpdyx = false
                -- 无酒不欢：每25点内伤-1集气，每25点中毒-1集气，玩家与NPC一样
                local ns_factor = math.modf((WAR.PD['内伤状态'][jqid] or 0) / 25)
                local zd_factor = math.modf(JY.Person[jqid]["中毒程度"] / 25)
                -- 毒王中毒反而增加集气
                if jqid == 0 and JY.Base["标准"] == 9 then
                    jq = jq + (zd_factor * 2)
                end
                -- 冰封也减少				
                if JY.Person[jqid]["冰封程度"] >= 50 then
                    jq = jq - 6
                elseif JY.Person[jqid]["冰封程度"] > 0 then
                    jq = jq - 3
                end
                -- 铁琴减少集气，一层减少1%

                if WAR.PD["琴音状态"][jqid] ~= nil then
                    jq = jq - jq * 0.015 * WAR.PD["琴音状态"][jqid]
                end

                if WAR.PD["冰冻状态"][jqid] ~= nil then
                    jq = jq - jq * 0.01 * WAR.PD["冰冻状态"][jqid]
                end

                -- 迟缓减少集气，一层减少1%
                if WAR.PD["迟缓状态"][jqid] ~= nil then
                    jq = jq - jq * 0.01 * WAR.PD["迟缓状态"][jqid]
                end
                local hsv_jq = 0
                -- 黄衫女 疾风增另集气 一层增加1.25%
                if WAR.PD["疾风劲"][jqid] ~= nil then
                    jq = jq + jq * (-0.0125) * WAR.PD["疾风劲"][jqid]
                end
                -- 魔帝BOSS，距离越近，速度越慢
                local tf26 = hastf(i, 26, 2)
                if tf26 ~= nil then
                    for j = 1, #tf26 do
                        local p = tf26[j]
                        if Boss(p) then
                            local x, y = WAR.Person[p]['坐标X'], WAR.Person[p]['坐标Y']
                            local x1, y1 = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
                            local jl = limitX(11 - math.abs(x - x1) - math.abs(y - y1), 0, 10)
                            jq = jq * (1 - jl / 20)
                        end
                    end
                end
                -- 集气不受状态影响				               
                if match_ID(jqid, 118) then
                    jqpdyx = true
                end
                -- 内轻特效611
                if NeiGong_tx(jqid, 611) then
                    jqpdyx = true
                end
                -- 内轻特效1040
                if NeiGong_tx(jqid, 1040) and WAR.LQZ[jqid] == 100 then
                    jqpdyx = true
                end
                --千变万劫
                if match_ID(jqid,9740) then
                    jqpdyx = true
                end
                if jqpdyx == false then
                    jq = jq - ns_factor - zd_factor - bf_factor - HTC_tq - chzt_jq - hsv_jq - ZQTL_tq
                end

                if jq < 10 then
                    jq = 10
                end

                if WAR.LQZ[jqid] == 100 then
                    jq = jq * 2 -- 暴怒3倍集气
                end
                -- 晴天冻结效果减半
                if CC.Weather[4][1] > 0 and CC.TX['战斗天气'] == 0  then
                    if WAR.PD['冻结'][jqid] ~= nil then
                        WAR.PD['冻结'][jqid] = WAR.PD['冻结'][jqid] / 2
                    end
                end
                -- 沉睡的敌人，无法集气 
                local jqpd = 0
                if WAR.PD["玄冰界"][jqid] ~= nil and WAR.PD["玄冰界"][jqid] >= 270 then
                    WAR.PD['玄冰界冻结'][jqid] = 1
                end
                if WAR.PD["沉睡状态"][jqid] == 1 then
                    lib.Debug('沉睡状态' .. JY.Person[jqid]['姓名'] .. '无法正常集气')
                    -- 木桩无法集气
                elseif jqid == 591 then
                    -- lib.Debug('591'..JY.Person[jqid]['姓名']..'无法正常集气') 
                    -- 被无招胜有招击中的人，无法集气
                elseif WAR.PD["无招胜有招"][jqid] ~= nil then
                    -- 上限10
                    WAR.PD["无招胜有招"][jqid] = limitX(WAR.PD["无招胜有招"][jqid], 0, 20)
                    -- lib.Debug('无招胜有招'..JY.Person[jqid]['姓名']..'无法正常集气')              
                elseif WAR.PD["定乾坤"][jqid] ~= nil then
                    -- 冻结的敌人，无法集气	晴天无法冻结		
                elseif WAR.PD["冻结"][jqid] ~= nil and WAR.PD["冻结"][jqid] > 0 then
                    -- 上限10 玄冰界30
                    if WAR.PD['玄冰界冻结'][jqid] == 1 then
                        WAR.PD["冻结"][jqid] = limitX(WAR.PD["冻结"][jqid], 0, 30)
                    else
                        WAR.PD["冻结"][jqid] = limitX(WAR.PD["冻结"][jqid], 0, 10)
                    end
                    if WAR.PD['天罗'][jqid] ~= nil then
                        JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - JY.Person[jqid]["生命"] * 0.001 * WAR.PD['天罗'][jqid]
                    end
                    -- lib.Debug(JY.Person[jqid]['姓名']..'  冻结无法集气'..WAR.PD["冻结"][jqid])
                    if WAR.PD["冻结"][jqid] < 1 then
                        WAR.PD['天罗'][jqid] = nil
                        WAR.PD["冻结"][jqid] = nil
                    end
                    -- lib.Debug('冻结'..JY.Person[jqid]['姓名']..'无法正常集气')             		
                    -- 没有封穴的情况下，可以集气
                elseif WAR.FXDS[jqid] ~= nil then
                    -- lib.Debug('封穴'..JY.Person[jqid]['姓名']..'无法正常集气')     
                else
                    -- 欧阳锋会跳气
                    if match_ID(jqid, 9858) and JLSD(0, 20, jqid) then
                        jq = jq + math.random(30, 60);
                    end
                    --百劫
                    if WAR.PD['百劫'][jqid] ~= nil then 
                        jq = jq + WAR.PD['百劫'][jqid]*10
                    end
                    -- 光君
                    if WAR.PD['光君'][jqid] ~= nil then
                        WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                        CurIDTXDH(i, 73, 1, "光君", C_ORANGE);
                        jq = jq + 100
                        WAR.PD['光君'][jqid] = nil
                    end
                    -- 浩然正气
                    if WAR.PD['浩然正气'][jqid] ~= nil and WAR.PD['浩然正气'][jqid] > 0 then
                        jq = jq + 10 * WAR.PD['浩然正气'][jqid]
                        WAR.PD['浩然正气'][jqid] = nil
                    end
                    -- 波斯三使会跳气
                    if (match_ID(jqid, 173) or match_ID(jqid, 174) or match_ID(jqid, 175)) and JLSD(0, 40, jqid) then
                        jq = jq + math.random(20, 40);
                    end
                    -- 颠三倒四
                    if match_ID(jqid, 9837) then
                        jq = jq + math.random(-30, 40)
                    end
                    -- 翻江虎身手不凡
                    if Pmiji(jqid, 11) then
                        local jgfmq = 0
                        for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
                                jgfmq = jgfmq + 1
                            end
                        end
                        if jgfmq >= 4 and math.random(10) < 4 then
                            jq = jq + 10;
                        end

                    end

                    --内轻特效1038
                    if NeiGong_tx(jqid,1038) then
                        local jl1 = kfcj_ng*5 
                        local jl2 = kfcj_qg*5
                        local tq1 = math.random(kfcj_ng*5,kfcj_ng*10)
                        local tq2 = math.random(kfcj_ng*10,kfcj_ng*20)
                        if JLSD(0, jl1, jqid) then
                            WAR.Person[i].Time = WAR.Person[i].Time + tq1
                            jq = jq + tq1
                        end
                        if JLSD(0,jl2,jqid) then 
                            WAR.Person[i].Time = WAR.Person[i].Time + tq2
                            jq = jq + tq2
                        end
                        -- lib.Debug('蛇行狸翻跳气'..JY.Person[jqid]['姓名']..' +jq='..jq)
                    end
                    --内轻特效1038
                    if NeiGong_tx(jqid,1038,1) then
                        local jl2 = kfcj_qg*5
                        local tq1 = math.random(kfcj_qg*5,kfcj_qg*10)
                        local tq2 = math.random(kfcj_qg*10,kfcj_qg*20)
                        if JLSD(0,jl2,jqid) then 
                            WAR.Person[i].Time = WAR.Person[i].Time + tq2
                            jq = jq + tq2
                        end
                        -- lib.Debug('蛇行狸翻跳气'..JY.Person[jqid]['姓名']..' +jq='..jq)
                    end
                    -- 丁当会跳气
                    if match_ID(jqid, 9741) and JLSD(0, 20, jqid) then
                        local a = math.random(10, 30);
                        if WAR.LQZ[jqid] == 100 then
                            a = a * 3
                        end
                        jq = jq + a
                        -- lib.Debug('丁当会跳气'..JY.Person[jqid]['姓名']..' +jq='..jq)
                    end
                    if WAR.PD["一空到底"][jqid] ~= nil then -- 一空到底
                        WAR.Person[i].Time = WAR.Person[i].Time - jq
                        WAR.PD["一空到底"][jqid] = WAR.PD["一空到底"][jqid] - 1
                        if WAR.PD["一空到底"][jqid] == 0 then
                            WAR.PD["一空到底"][jqid] = nil
                        end
                        -- lib.Debug('一空到底'..JY.Person[jqid]['姓名']..' -jq='..jq)
                    end
                    if WAR.PD["紊乱状态"][jqid] ~= nil then -- 被灵蛇拳击中，集气波动20时序
                        -- 上限20
                        WAR.PD["紊乱状态"][jqid] = limitX(WAR.PD["紊乱状态"][jqid], 0, 20)

                        jq = math.floor(jq)
                        if jq ~= 0 then
                            WAR.Person[i].Time = WAR.Person[i].Time - math.random(-jq, jq)
                        end
                        WAR.PD["紊乱状态"][jqid] = WAR.PD["紊乱状态"][jqid] - 1
                        if WAR.PD["紊乱状态"][jqid] == 0 then
                            WAR.PD["紊乱状态"][jqid] = nil
                        end
                        -- lib.Debug('紊乱状态'..JY.Person[jqid]['姓名']..' +jq='..jq)
                    else
                        WAR.Person[i].Time = WAR.Person[i].Time + jq
                        -- lib.Debug(JY.Person[jqid]['姓名']..' +jq='..jq)
                    end
                    -- lib.Debug(JY.Person[jqid]['姓名']..'集气时速度为'..WAR.Person[i].Time)
                    if WAR.Person[i].Time > 1005 then
                        WAR.Person[i].Time = 1005
                    end

                    if WAR.Person[i].Time < -100 then
                        WAR.Person[i].Time = -100
                    end
                    -- lib.Debug(JY.Person[jqid]['姓名']..'正常集气='..WAR.Person[i].Time.. ' jq='..jq)
                end

            ----------------------------------时序封穴恢复-----------------------------------------------
                if WAR.FXDS[jqid] ~= nil and WAR.FXDS[jqid] > 0 then
                    WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
                    -- 定心圆气
                    if match_ID(jqid, 9805) then
                        -- 封穴
                        if WAR.FXDS[jqid] ~= nil then
                            WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
                        end
                    end
                    -- 内轻特效218
                    if NeiGong_tx(jqid, 218) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
                        end
                    end
                    -- 黑级浮屠 封穴回复+2
                    if match_ID(jqid, 9930) then
                        WAR.FXDS[jqid] = WAR.FXDS[jqid] - 2
                    end
                    -- 内轻特效612
                    if NeiGong_tx(jqid, 612) then
                        if WAR.JYFX[jqid] == nil then
                            WAR.JYFX[jqid] = 1;
                        elseif WAR.JYFX[jqid] < (Sxjs[kfcj_ng][1] + 4) then
                            WAR.JYFX[jqid] = WAR.JYFX[jqid] + 1;
                        else
                            WAR.JYFX[jqid] = nil;
                            WAR.FXDS[jqid] = 0;
                        end
                    end

                    -- 暴怒时解穴速度加倍
                    if WAR.LQZ[jqid] == 100 then
                        WAR.FXDS[jqid] = WAR.FXDS[jqid] - 1
                    end

                    if WAR.FXDS[WAR.Person[i]["人物编号"]] < 1 then
                        WAR.FXDS[WAR.Person[i]["人物编号"]] = nil
                    end
                end

                -- 文泰来计时状态
                if match_ID(jqid, 9847) and WAR.PD["否极泰来"][jqid] == nil then
                    WAR.PD["否极泰来"][jqid] = 100
                end
            ----------------------------------时序回复生命/时序回复内力/时序回复体力/时序回复怒气-------------------------
                if WAR.PD['禁疗'][jqid] == nil   then
                    -- 内轻特效106
                    if NeiGong_tx(jqid, 106) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            AddPersonAttrib(jqid, '生命', kfcj_ng)
                        end
                    end
                    -- 内轻特效107
                    if NeiGong_tx(jqid, 107) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            AddPersonAttrib(jqid, '内力', kfcj_ng)
                        end
                    end
                    -- 内轻特效108
                    if NeiGong_tx(jqid, 108) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            AddPersonAttrib(jqid, '体力', 1)
                        end
                    end
                    -- 内轻特效200
                    if NeiGong_tx(jqid, 200) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] and  (WAR.LQZ[jqid] or 0) < 100 then
                            WAR.LQZ[jqid] = (WAR.LQZ[jqid] or 0) + kfcj_ng
                            if WAR.LQZ[jqid] > 100 then
                                WAR.LQZ[jqid] = 100
                                -- WarDrawMap(0)
                                --local s = WAR.CurID
                                --WAR.CurID = i
                                --WarDrawMap(0)
                                --CurIDTXDH(WAR.CurID, 64, 1, "怒气暴发", LightGreen)
                                --WAR.CurID = s
                            end
                        end
                    end
                    -- 内轻特效110 
                    if WAR.PD['气血相生'][jqid] == nil then 
                        if NeiGong_tx(jqid, 110) and JY.Person[jqid]['生命'] / JY.Person[jqid]['生命最大值'] < JY.Person[jqid]['内力'] / JY.Person[jqid]['内力最大值'] then
                            local sm = JY.Person[jqid]['生命最大值'] * kfcj_ng / 100
                            if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                                CurIDTXDH(WAR.CurID, 103, 1, "气血相生", C_ORANGE);
                                AddPersonAttrib(jqid, '生命', sm)
                                WAR.PD['气血相生'][jqid] = 99
                            end
                        -- 内轻特效111
                        elseif NeiGong_tx(jqid, 111) and JY.Person[jqid]['生命'] / JY.Person[jqid]['生命最大值'] > JY.Person[jqid][ '内力'] /JY.Person[jqid]['内力最大值'] then
                            local sm = JY.Person[jqid]['内力最大值'] * kfcj_ng / 100
                            if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                                CurIDTXDH(WAR.CurID, 103, 1, "气血相生", C_ORANGE);
                                AddPersonAttrib(jqid, '内力', sm)
                                WAR.PD['气血相生'][jqid] = 99
                            end
                        end
                        
                    end
                    -- 祝由术
                    if JY.Person[jqid]['奇穴' .. 110] == 1 then
                        AddPersonAttrib(jqid, '生命', 3)
                        AddPersonAttrib(jqid, '内力', 10)
                        if WAR.LSX_Counter == 6 then
                            AddPersonAttrib(jqid, '体力', 1)
                        end
                    end
                    -- 玄冰界
                    if WAR.PD['玄冰界'][jqid] ~= nil and WAR.PD['玄冰界'][jqid] >= 270 then
                        local n = math.modf(JY.Person[jqid]['生命最大值'] / 100)
                        AddPersonAttrib(jqid, '生命', n)
                    end
                    -- 黑级浮屠回内
                    if match_ID(jqid, 9930) then
                        AddPersonAttrib(jqid, '内力', 12)
                    end
                    -- 一无无血
                    if WAR.PD["一剑无血"][jqid] ~= nil then
                        AddPersonAttrib(jqid, '生命', WAR.WXXX)
                        WAR.PD["一剑无血"][jqid] = nil
                    end

                    -- 神秘护符回复
                    if JY.Person[jqid]["坐骑"] == 312 then
                        -- AddPersonAttrib(jqid,'生命',999)
                    end

                    if WAR.PD['天王护命'][jqid] ~= nil then
                        local sm = 2
                        if JY.Person[jqid]['实战'] >= 500 then
                            sm = 4
                        end
                        AddPersonAttrib(jqid, '生命', sm)
                        WAR.PD['天王护命'][jqid] = WAR.PD['天王护命'][jqid] - 1
                        if WAR.PD['天王护命'][jqid] < 1 then
                            WAR.PD['天王护命'][jqid] = nil
                        end
                    end

                    if WAR.PD['白云熊胆'][jqid] ~= nil then
                        AddPersonAttrib(jqid, '内力', 8)
                        WAR.PD['白云熊胆'][jqid] = WAR.PD['白云熊胆'][jqid] - 1
                        if WAR.PD['白云熊胆'][jqid] < 1 then
                            WAR.PD['白云熊胆'][jqid] = nil
                        end
                    end

                    -- 主角医生回血内，减内伤，减中毒
                    if jqid == 0 and JY.Base["标准"] == 8 then
                        AddPersonAttrib(jqid, '生命', math.random(5))
                        AddPersonAttrib(jqid, '内力', math.random(5))
                        AddPersonAttrib(jqid, '中毒程度', -math.random(5))
                        WAR.PD['内伤状态'][jqid] = WAR.PD['内伤状态'][jqid] or 0 - math.random(5)
                    end
                    -- 回复体力
                    if JY.Person[jqid]["体力"] < 100 then
                        -- 定心圆气
                        if match_ID(jqid, 9805) then
                            AddPersonAttrib(jqid, '生命', 5)
                            AddPersonAttrib(jqid, '内力', 10)
                            AddPersonAttrib(jqid, '体力', 1)
                        end

                    end
                end
            ----------------------------------流血回复---------------------------------------------------
                -- 每时序回复1点流血
                if WAR.LXZT[jqid] ~= nil then
                    if WAR.WSX_Counter == 5 then 
                        WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
                        AddPersonAttrib(jqid, '生命', -math.random(5))
                    end
                    -- 内轻特效215
                    if NeiGong_tx(jqid, 215) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
                        end
                    end
                    if JY.Person[jqid]["坐骑"] == 262  and WAR.LXZT[jqid] ~= nil then
                        WAR.LXZT[jqid] = (WAR.LXZT[jqid] or 0) - 2 
                        
                    end
                    -- 定心圆气
                    if match_ID(jqid, 9805) then
                        -- 流血					
                        if WAR.LXZT[jqid] ~= nil then
                            WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
                        end
                    end

                    -- 内轻特效615
                    if NeiGong_tx(jqid, 615) then
                        if WAR.PD['时序清流血'][jqid] == nil then
                            WAR.PD['时序清流血'][jqid] = 1;
                        elseif WAR.PD['时序清流血'][jqid] < (Sxjs[kfcj_ng][1] + 10) then
                            WAR.PD['时序清流血'][jqid] = WAR.PD['时序清流血'][jqid] + 1;
                        else
                            WAR.PD['时序清流血'][jqid] = nil;
                            WAR.LXZT[jqid] = 0;
                        end
                    end
                    if WAR.LXZT[jqid] < 1 then
                        WAR.LXZT[jqid] = nil
                    end
                end

            ----------------------------------冰封回复-----------------------------------
                --默认每5时序花费5点内回复1点冰封
                if WAR.WSX_Counter == 5 then 
                    JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
                    AddPersonAttrib(jqid, '内力', -math.random(5))
                end
                if JY.Person[jqid]["冰封程度"] > 0 and JY.Person[jqid]["灼烧程度"] > 0 then
                    AddPersonAttrib(jqid, '生命', -math.random(2, 5))
                    AddPersonAttrib(jqid, '内力', -math.random(2, 5))
                    if JY.Person[jqid]["生命"] < 1 then
                        JY.Person[jqid]["生命"] = 1
                    end
                end
                -- 每时序回复1点冰封
                if JY.Person[jqid]["冰封程度"] > 0 then
                    -- 内轻特效216
                    if NeiGong_tx(jqid, 216) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            JY.Person[jqid]["冰封程度"] = JY.Person[jqid]["冰封程度"] - 1
                        end
                    end
                    -- 每时序-5内
                    AddPersonAttrib(jqid, '内力', -5)
                    -- 深度冰封每时序-15内
                    if JY.Person[jqid]["冰封程度"] >= 50 then
                        AddPersonAttrib(jqid, '内力', -10)
                    end

                    -- 定心圆气
                    if match_ID(jqid, 9805) then
                        AddPersonAttrib(jqid, '冰封程度', -1)
                    end
                    -- 内轻特效614
                    if NeiGong_tx(jqid, 614) then
                        if WAR.PD['时序清冰封'][jqid] == nil then
                            WAR.PD['时序清冰封'][jqid] = 1;
                        elseif WAR.PD['时序清冰封'][jqid] < (Sxjs[kfcj_ng][1] + 10) then
                            WAR.PD['时序清冰封'][jqid] = WAR.PD['时序清冰封'][jqid] + 1;
                        else
                            WAR.PD['时序清冰封'][jqid] = nil;
                            JY.Person[jqid]["冰封程度"] = 0;
                        end
                    end
                end
            ----------------------------------灼烧回复-----------------------------------
                -- 每时序回复1点灼烧
                if JY.Person[jqid]["灼烧程度"] > 0 then
                    --默认每5时序花费5点内回复1点灼烧
                    if WAR.WSX_Counter == 5 then 
                        JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
                        AddPersonAttrib(jqid, '内力', -math.random(5))
                    end
                    -- 内轻特效214
                    if NeiGong_tx(jqid, 214) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            JY.Person[jqid]["灼烧程度"] = JY.Person[jqid]["灼烧程度"] - 1
                        end
                    end
                    -- 枯荣额外恢复灼烧
                    if match_ID(jqid, 102) then
                        AddPersonAttrib(jqid, '灼烧程度', -1)
                    end
                    -- 定心圆气
                    if match_ID(jqid, 9805) then
                        AddPersonAttrib(jqid, '灼烧程度', -1)
                    end
                    -- 内轻特效617
                    if NeiGong_tx(jqid, 617) then
                        if WAR.PD['时序清灼烧'][jqid] == nil then
                            WAR.PD['时序清灼烧'][jqid] = 1;
                        elseif WAR.PD['时序清灼烧'][jqid] < (Sxjs[kfcj_ng][1] + 10) then
                            WAR.PD['时序清灼烧'][jqid] = WAR.PD['时序清灼烧'][jqid] + 1;
                        else
                            WAR.PD['时序清灼烧'][jqid] = nil;
                            JY.Person[jqid]["灼烧程度"] = 0;
                        end
                    end
                end
            ----------------------------------内伤回复-----------------------------------
                -- 无酒不欢：时序回复内伤的设定
                -- if JY.Person[jqid]["受伤程度"] > 0 then
                if WAR.PD['内伤状态'][jqid] ~= nil and WAR.PD['内伤状态'][jqid] > 0 then
                    --默认每5时序花费5点内回复1点灼烧
                    if WAR.WSX_Counter == 5 then 
                        WAR.PD['内伤状态'][jqid] = WAR.PD['内伤状态'][jqid] - 1
                        AddPersonAttrib(jqid, '生命', -math.random(5))
                    end
                    -- 内轻特效217
                    if NeiGong_tx(jqid, 217) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            WAR.PD['内伤状态'][jqid] = WAR.PD['内伤状态'][jqid] - 1
                        end
                    end
                    -- 定心圆气
                    if match_ID(jqid, 9805) then
                        -- AddPersonAttrib(jqid,'受伤程度',-1)
                        WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 1
                    end
                    -- 魔帝吸星BOSS
                    if match_ID(jqid, 9764) then
                        if WAR.SSX_Counter == 3 then
                            local n = -1
                            if Boss(i) then
                                n = -2
                            end
                            -- AddPersonAttrib(jqid,'受伤程度',n)
                            WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 2
                        end
                    end

                    -- 黑级浮屠
                    if match_ID(jqid, 9930) then
                        -- AddPersonAttrib(jqid,'受伤程度',-2)
                        WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 2
                    end

                    -- 主运天赋内功，5时序额外回1内伤
                    if JY.Person[jqid]["主运内功"] ~= 0 and JY.Person[jqid]["主运内功"] ==
                        JY.Person[jqid]["天赋内功"] then
                        if WAR.WSX_Counter == 5 then
                            -- JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1
                            -- AddPersonAttrib(jqid,'受伤程度',-1)
                            WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 1
                        end
                    end

                    if WAR.PD['小还丹'][jqid] ~= nil then
                        WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 1
                    end
                    -- 内轻特效616
                    if NeiGong_tx(jqid, 616) then
                        if WAR.PD['时序清内伤'][jqid] == nil then
                            WAR.PD['时序清内伤'][jqid] = 1;
                        elseif WAR.PD['时序清内伤'][jqid] < (Sxjs[kfcj_ng][1] + 10) then
                            WAR.PD['时序清内伤'][jqid] = WAR.PD['时序清内伤'][jqid] + 1;
                        else
                            WAR.PD['时序清内伤'][jqid] = nil;
                            WAR.PD['内伤状态'][jqid] = 0;
                        end
                    end
                end
            ----------------------------------中毒回复-----------------------------------
                -- 毒王时序增加中毒
                if jqid == 0 and JY.Base["标准"] == 9 then
                    AddPersonAttrib(jqid, '中毒程度', math.random(10))
                end
                if JY.Person[jqid]['中毒程度'] > 0 then
                    if WAR.WSX_Counter == 5 then 
                        JY.Person[jqid]['中毒程度'] = JY.Person[jqid]['中毒程度'] - 1
                        AddPersonAttrib(jqid, '生命', -math.random(5))
                    end
                    -- 内轻特效213
                    if NeiGong_tx(jqid, 213) then
                        if Sxjs[kfcj_ng][2] == Sxjs[kfcj_ng][1] then
                            JY.Person[jqid]['中毒程度'] = JY.Person[jqid]['中毒程度'] - 1
                        end
                    end
                    -- 黑级浮屠
                    if match_ID(jqid, 9930) then
                        AddPersonAttrib(jqid, '中毒程度', -2)
                    end

                    -- 任盈盈，每时序回复5点中毒
                    if match_ID(jqid, 73) then
                        AddPersonAttrib(jqid, '中毒程度', -5)
                    end

                    if WAR.PD['黄连解毒'][jqid] ~= nil then
                        AddPersonAttrib(jqid, '中毒程度', -1)
                        WAR.PD['黄连解毒'][jqid] = WAR.PD['黄连解毒'][jqid] - 1
                        if WAR.PD['黄连解毒'][jqid] < 1 then
                            WAR.PD['黄连解毒'][jqid] = nil
                        end
                    end
                    -- 定心圆气
                    if match_ID(jqid, 9805) then
                        AddPersonAttrib(jqid, '中毒程度', -1)
                    end

                    if WAR.PD['牛黄血蝎'][jqid] ~= nil then
                        AddPersonAttrib(jqid, '中毒程度', -1)
                        WAR.PD['牛黄血蝎'][jqid] = WAR.PD['牛黄血蝎'][jqid] - 1
                        if WAR.PD['牛黄血蝎'][jqid] < 1 then
                            WAR.PD['牛黄血蝎'][jqid] = nil
                        end
                    end
                    -- 内轻特效613
                    if NeiGong_tx(jqid, 613) then
                        if WAR.PD['时序清中毒'][jqid] == nil then
                            WAR.PD['时序清中毒'][jqid] = 1;
                        elseif WAR.PD['时序清中毒'][jqid] < (Sxjs[kfcj_ng][1] + 10) then
                            WAR.PD['时序清中毒'][jqid] = WAR.PD['时序清中毒'][jqid] + 1;
                        else
                            WAR.PD['时序清中毒'][jqid] = nil;
                            WAR.PD['内伤状态'][jqid] = 0;
                        end
                    end
                    if JY.Person[jqid]['中毒程度'] < 0 then
                        JY.Person[jqid]['中毒程度'] = 0
                    end
                end
            ----------------------------------时序掉血-----------------------------------    
                -- 阿紫曼珠沙华，每时序掉1%血
                if match_ID(jqid, 9757) and WAR.PD["禁药状态"][jqid] ~= nil then
                    AddPersonAttrib(jqid, '生命', -math.modf(JY.Person[jqid]["生命最大值"] * 0.01))
                    if JY.Person[jqid]["生命"] < 1 then
                        JY.Person[jqid]["生命"] = 0
                        WAR.Person[WAR.CurID]["死亡"] = true
                        WarSetPerson()
                        break
                    end
                end
                -- 引燃：每时序损失1%当前血量
                if WAR.PD['点燃'][jqid] ~= nil then
                    local jsm = math.modf(JY.Person[jqid]["生命"] * 0.01)
                    local bs = 1
                    -- 下雪天
                    if CC.Weather[2][1] > 0 and CC.TX['战斗天气'] == 0  then
                        if WAR.PD['点燃'][jqid] ~= nil then
                            jsm = jsm / 2
                        end
                    end

                    -- 晴天 
                    if CC.Weather[4][1] > 0 and CC.TX['战斗天气'] == 0  then
                        if WAR.PD['点燃'][jqid] ~= nil then
                            jsm = jsm * 2
                        end
                    end
                    -- 下雨天无法触发引燃
                    if CC.Weather[1][1] == 1 and CC.TX['战斗天气'] == 0   then
                    else
                        AddPersonAttrib(jqid, '生命', -math.modf(jsm))
                        if JY.Person[jqid]["生命"] < 1 then
                            JY.Person[jqid]["生命"] = 1
                        end
                        WAR.PD['点燃'][jqid] = WAR.PD['点燃'][jqid] - 1
                        if WAR.PD['点燃'][jqid] < 1 then
                            WAR.PD['点燃'][jqid] = nil
                        end
                    end
                end
                -- 撕裂：每时序损失0.5%最大值血量
                if WAR.PD['撕裂'][jqid] ~= nil then
                    AddPersonAttrib(jqid, '生命', -math.modf(JY.Person[jqid]["生命最大值"] * 5 / 1000))
                    if JY.Person[jqid]["生命"] < 1 then
                        JY.Person[jqid]["生命"] = 1
                    end
                    WAR.PD['撕裂'][jqid] = WAR.PD['撕裂'][jqid] - 1

                    if WAR.PD['撕裂'][jqid] < 1 then
                        WAR.PD['撕裂'][jqid] = nil
                    end
                end

                -- 西域奇毒：每时序损失1%最大值血量
                if WAR.PD['西域奇毒'][jqid] ~= nil then
                    AddPersonAttrib(jqid, '生命', -math.modf(JY.Person[jqid]["生命最大值"] / 100))
                    if JY.Person[jqid]["生命"] < 1 then
                        JY.Person[jqid]["生命"] = 1
                    end
                    WAR.PD['西域奇毒'][jqid] = WAR.PD['西域奇毒'][jqid] - 1
                    if WAR.PD['西域奇毒'][jqid] < 1 then
                        WAR.PD['西域奇毒'][jqid] = nil
                    end
                end
                -- 向问天时序掉血
                if match_ID(jqid, 234) then
                    JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - 3
                    if JY.Person[jqid]["生命"] < 1 then
                        JY.Person[jqid]["生命"] = 1
                    end
                end
                -- 流血时序掉3点生命值
                if WAR.LXZT[jqid] ~= nil then
                    local bs = 1
                    -- 下雨天
                    if CC.Weather[1][1] == 1 and CC.TX['战斗天气'] == 0  then
                        bs = 2
                    end
                    -- 大雾天
                    if CC.Weather[3][1] == 1 and CC.TX['战斗天气'] == 0  then
                        bs = bs - bs / 2
                    end
                    local lxsm = 2 + math.modf((WAR.PD['内伤状态'][jqid] or 0) / 50)
                    JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - lxsm * bs
                    if WAR.PD["扫荡群魔"][jqid] ~= nil then
                        JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] -
                                                        (JY.Person[jqid]["生命最大值"] * 1 / 200) * bs
                    end

                    WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
                    -- 一剑无血
                    if WAR.PD["无血状态"][jqid] ~= nil then
                        JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] - math.modf(lxsm * bs * WAR.LXZT[jqid])
                        WAR.WXXX = math.modf(lxsm * bs * WAR.LXZT[jqid])
                        WAR.PD["无血状态"][jqid] = nil
                        WAR.LXZT[jqid] = nil
                    end

                    if JY.Person[jqid]["生命"] < 1 then
                        JY.Person[jqid]["生命"] = 1
                    end
                end
            ----------------------------------时序中毒-----------------------------------
                -- 万毒蚀体
                if WAR.PD['万毒蚀体CD'][jqid] == nil and JY.Person[jqid]['奇穴' .. 28] == 1 then
                    local x1 = WAR.Person[WAR.CurID]["坐标X"];
                    local y1 = WAR.Person[WAR.CurID]["坐标Y"];
                    local pd = 0
                    for ex = x1 - 5, x1 + 5 do
                        for ey = y1 - 5, y1 + 5 do
                            SetWarMap(ex, ey, 4, 1)
                            if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                                local ep = GetWarMap(ex, ey, 2)
                                if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] then
                                    WAR.PD['万毒蚀体'][WAR.Person[i]["人物编号"]] = 1
                                end
                            end
                        end
                    end
                    if WAR.PD['万毒蚀体'][jqid] ~= nil and WAR.PD['万毒蚀体'][jqid] == 1 then
                        -- lib.Debug('触发万毒')
                        WAR.PD['万毒蚀体'][jqid] = nil
                        local s = WAR.CurID
                        WAR.CurID = i
                        WarDrawMap(0)
                        CurIDTXDH(WAR.CurID, 64, 1, "万毒蚀体", LightGreen)
                        WAR.CurID = s
                        -- lib.Debug('万毒攻击方动画')                           
                        for ex = x1 - 5, x1 + 5 do
                            for ey = y1 - 5, y1 + 5 do
                                SetWarMap(ex, ey, 4, 1)
                                if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                                    local ep = GetWarMap(ex, ey, 2)

                                    if WAR.Person[ep]["我方"] ~= WAR.Person[i]["我方"] then
                                        -- lib.Debug('范围内有人= '..GetWarMap(ex, ey, 2))
                                        if myzd(ep) == false then
                                            WAR.Person[ep]["中毒点数"] = War_PoisonHurt(jqid, ep)
                                            WAR.PD['万毒蚀体CD'][jqid] = 100
                                        end
                                        SetWarMap(ex, ey, 4, 4)
                                    end
                                end
                            end
                        end
                    end
                end
            ----------------------------------时序掉内-----------------------------------    			
                -- 散功：每时序损失1%当前内力
                if WAR.PD["散功状态"][jqid] ~= nil then
                    AddPersonAttrib(jqid, '内力', -math.modf(JY.Person[jqid]["内力"] * 0.01))
                    if JY.Person[jqid]["内力"] < 1 then
                        JY.Person[jqid]["内力"] = 1
                    end
                    WAR.PD["散功状态"][jqid] = WAR.PD["散功状态"][jqid] - 1
                    if WAR.PD["散功状态"][jqid] < 1 then
                        WAR.PD["散功状态"][jqid] = nil
                    end
                end
                -- 破剑八刀
                if match_ID(jqid, 513) then
                    if WAR.PD['破剑八刀'][jqid] ~= nil then
                        WAR.PD['破剑八刀'][jqid] = WAR.PD['破剑八刀'][jqid] - 1
                        if WAR.PD['破剑八刀'][jqid] <= 0 then
                            WAR.PD['破剑八刀'][jqid] = nil
                            Cat('护盾停止', i)
                        end
                    end
                    if WAR.PD['破剑八刀CD'][jqid] ~= nil then
                        WAR.PD['破剑八刀CD'][jqid] = WAR.PD['破剑八刀CD'][jqid] - 1
                        if WAR.PD['破剑八刀CD'][jqid] <= 0 then
                            WAR.PD['破剑八刀CD'][jqid] = nil
                        end
                    end
                    if WAR.PD['破剑八刀CD'][jqid] == nil and WAR.PD['破剑八刀'][jqid] == nil then
                        WAR.PD['破剑八刀CD'][jqid] = 100
                        WAR.PD['破剑八刀'][jqid] = 50
                        if WAR.Person[i]['护盾'] == nil then
                            WAR.Person[i]['护盾'] = 7
                        end
                        WAR.CurID = i
                        WarDrawMap(0)
                        CurIDTXDH(WAR.CurID, 132, 1, '破剑八刀')
                    end
                end

                if match_ID(jqid, 9961) and Boss(i) then
                    WAR.PD['金蛇缠丝手CD'][jqid] = (WAR.PD['金蛇缠丝手CD'][jqid] or 0) + 1
                    if WAR.PD['金蛇缠丝手CD'][jqid] == 30 then
                        WAR.PD['金蛇缠丝手CD'][jqid] = 0
                        Cat('金蛇缠丝手', i)
                    end
                    -- end
                end

                -- 胡一刀觉醒
                if NeiGong_tx(jqid, 200) or match_ID_awakened(jqid, 633, 1) or
                    (match_ID(jqid, 9939) and Boss(WAR.CurID)) then
                    if WAR.LQZ[jqid] == nil then
                        WAR.LQZ[jqid] = 1
                    elseif WAR.LQZ[jqid] < 100 then
                        WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
                        if WAR.LQZ[jqid] > 100 then 
                            WAR.LQZ[jqid] = 100
                        end
                        if WAR.LQZ[jqid] == 100 then
                            -- 东方不败，葵花秘法・化凤为凰
                            local s = WAR.CurID
                            local say = "怒气爆发"
                            local ani_num = 6
                            WAR.CurID = i
                            if match_ID(jqid, 27) and Curr_NG(jqid, 105) then
                                say = "葵花秘法・化凤为凰"
                                ani_num = 7
                            end
                            if match_ID(jqid, 568) then
                                say = "精忠报国"
                                ani_num = 8
                            end
                            WarDrawMap(0)
                            -- 聂风
                            if match_ID(jqid, 9949) and JLSD(0, 60, jqid) then
                                WAR.PD['入魔'][jqid] = 1
                                ani_num = 157
                                say = "冰心见魔・入魔"
                            end
                            CurIDTXDH(WAR.CurID, ani_num, 1, say)
                            -- 天魔功
                            --内轻特效1028
                            --if Curr_NG(jqid, 160) and JLSD(0, 30, jqid) then
                            if NeiGong_tx(jqid,1028) and JLSD(0,kfcj_ng*10,jqid) then 
                                WAR.PD['入魔'][jqid] = 1
                                ani_num = 157
                                say = "天魔大法"
                            end
                            CurIDTXDH(WAR.CurID, ani_num, 1, say)
                        end
                    end
                end

                -- 文泰来，血量少于一半时，+2点时序怒气
                if match_ID(jqid, 151) then
                    if WAR.LQZ[jqid] == nil then
                        WAR.LQZ[jqid] = 1
                    elseif WAR.LQZ[jqid] < 100 then
                        WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
                        if JY.Person[jqid]["生命"] < JY.Person[jqid]["生命最大值"] * 0.5 then
                            WAR.LQZ[jqid] = WAR.LQZ[jqid] + 1
                            if WAR.LQZ[jqid] >= 100 then
                                WAR.LQZ[jqid] = 100
                                WarDrawMap(0)
                                CurIDTXDH(i, 6, 1, "怒气爆发")
                            end
                        end
                    end
                end

                -- 梅长苏 偷天换日
                if match_ID(jqid, 9969) then
                    if WAR.PD["偷天换日"][jqid] == nil then
                        WAR.PD["偷天换日"][jqid] = 1
                    else
                        WAR.PD["偷天换日"][jqid] = WAR.PD["偷天换日"][jqid] + 1
                    end
                    if WAR.PD["偷天换日"][jqid] >= 100 and JY.Person[jqid]["冰封程度"] == 0 and
                        JY.Person[jqid]["灼烧程度"] == 0 then
                        WAR.PD["偷天换日"][jqid] = nil
                        WAR.ZSXS[jqid] = 1
                        AddPersonAttrib(jqid, '灼烧程度', 50)
                        WAR.BFXS[jqid] = 1
                        AddPersonAttrib(jqid, '冰封程度', 100)
                        local s = WAR.CurID
                        WAR.CurID = i
                        WarDrawMap(0)
                        CurIDTXDH(WAR.CurID, 104, 1, "火寒毒发・偷天换日", PinkRed)
                        WAR.CurID = s
                        JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
                        JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
                        JY.Person[jqid]["体力"] = 100
                        JY.Person[jqid]["中毒程度"] = 0
                        -- 流血
                        if WAR.LXZT[jqid] ~= nil then
                            WAR.LXZT[jqid] = nil
                        end
                        -- 封穴
                        if WAR.FXDS[jqid] ~= nil then
                            WAR.FXDS[jqid] = nil
                        end
                        if WAR.PD['内伤状态'][jqid] ~= nil then
                            WAR.PD['内伤状态'][jqid] = 0
                        end
                    end
                end

                -- 转瞬红颜
                if match_ID(jqid, 9868) then
                    if WAR.ZSHY[jqid] == nil then
                        WAR.ZSHY[jqid] = 1
                    else
                        WAR.ZSHY[jqid] = WAR.ZSHY[jqid] + 1
                    end
                    if WAR.ZSHY[jqid] == 199 then
                        WAR.ZSHY[jqid] = nil
                        local s = WAR.CurID
                        WAR.CurID = i
                        WarDrawMap(0)
                        CurIDTXDH(WAR.CurID, 104, 1, "红颜弹指老・刹那芳华", PinkRed)
                        Cat('清除所有异常', WAR.CurID)
                        WAR.CurID = s
                        JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
                        JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
                        JY.Person[jqid]["体力"] = 100

                        -- 流血
                        if WAR.LXZT[jqid] ~= nil then
                            WAR.LXZT[jqid] = nil
                        end
                        -- 封穴
                        if WAR.FXDS[jqid] ~= nil then
                            WAR.FXDS[jqid] = nil
                        end
                        if WAR.PD['内伤状态'][jqid] ~= nil then
                            WAR.PD['内伤状态'][jqid] = 0
                        end
                    end
                end

                -- 贝海石：老谋深算
                if match_ID(jqid, 85) then
                    if WAR.LMSS[jqid] == nil then
                        WAR.LMSS[jqid] = 1
                    else
                        WAR.LMSS[jqid] = WAR.LMSS[jqid] + 1
                    end
                    if WAR.LMSS[jqid] == 999 then
                        WAR.LMSS[jqid] = nil
                        local s = WAR.CurID
                        WAR.CurID = i

                        WarDrawMap(0)

                        CurIDTXDH(WAR.CurID, 136, 1, "久病成良医", PinkRed)
                        WAR.CurID = s

                        JY.Person[jqid]["生命"] = JY.Person[jqid]["生命最大值"]
                        JY.Person[jqid]["内力"] = JY.Person[jqid]["内力最大值"]
                        JY.Person[jqid]["体力"] = 100
                        JY.Person[jqid]["中毒程度"] = 0
                        -- JY.Person[jqid]["受伤程度"] = 0
                        JY.Person[jqid]["冰封程度"] = 0
                        JY.Person[jqid]["灼烧程度"] = 0
                        -- 流血
                        if WAR.LXZT[jqid] ~= nil then
                            WAR.LXZT[jqid] = nil
                        end
                        -- 封穴
                        if WAR.FXDS[jqid] ~= nil then
                            WAR.FXDS[jqid] = nil
                        end
                        if WAR.PD['内伤状态'][jqid] ~= nil then
                            WAR.PD['内伤状态'][jqid] = 0
                        end
                    end
                end
                -- 李莫愁：情为何物
                if match_ID(jqid, 9827) then
                    if WAR.QWHW[jqid] == nil then
                        WAR.QWHW[jqid] = 1
                    else
                        WAR.QWHW[jqid] = WAR.QWHW[jqid] + 1
                    end
                    if WAR.QWHW[jqid] == 50 then
                        WAR.QWHW[jqid] = nil
                        local s = WAR.CurID
                        WAR.CurID = i
                        WarDrawMap(0)
                        local XZ = {}
                        for j = 0, WAR.PersonNum - 1 do
                            if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] ==
                                false then
                                WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                                local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[j]["坐标X"])
                                local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[j]["坐标Y"])
                                local jl = 9
                                if offset1 <= jl and offset2 <= jl then
                                    table.insert(XZ, j)
                                end
                            end
                        end
                        if #XZ > 0 then
                            CurIDTXDH(WAR.CurID, 106, 1, "问世间情是何物", PinkRed)
                            local ri = XZ[math.random(#XZ)]
                            War_ExecuteMenu_Sub(WAR.Person[ri]["坐标X"], WAR.Person[ri]["坐标Y"], 4, 34)
                            local si = XZ[math.random(#XZ)]
                            War_ExecuteMenu_Sub(WAR.Person[si]["坐标X"], WAR.Person[si]["坐标Y"], 4, 34)
                            local ti = XZ[math.random(#XZ)]
                            War_ExecuteMenu_Sub(WAR.Person[ti]["坐标X"], WAR.Person[ti]["坐标Y"], 4, 34)
                            WAR.CurID = s
                        end
                    end
                end
            --------------------------------------时序其他状态--------------------------
                -- 武当派太极神功时序序力
                --内轻特效310				
                if NeiGong_tx(jqid,310) then
                    if WAR.PD["蓄气值"][jqid] == nil or WAR.PD["蓄气值"][jqid] == 0 then
                        WAR.PD["蓄气值"][jqid] = 10
                    end
                    if WAR.PD["蓄气值"][jqid] ~= nil and WAR.PD["蓄气值"][jqid] > 0 then
                        WAR.PD["蓄气值"][jqid] = WAR.PD["蓄气值"][jqid] + 10
                        if WAR.PD["蓄气值"][jqid] > 1080 then
                            WAR.PD["蓄气值"][jqid] = 1080
                        end
                    end
                end
                -- 玄阴煞气
                if JY.Person[jqid]['奇穴' .. 83] == 1 then
                    if Curr_NG(jqid, 107) then
                        if WAR.PD['玄阴煞气'][jqid] == nil then
                            local x1 = WAR.Person[WAR.CurID]["坐标X"];
                            local y1 = WAR.Person[WAR.CurID]["坐标Y"];
                            local pd = 0
                            local ep = nil
                            for ex = x1 - 5, x1 + 5 do
                                for ey = y1 - 5, y1 + 5 do
                                    SetWarMap(ex, ey, 4, 1)
                                    if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                                        ep = GetWarMap(ex, ey, 2)
                                        if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"] and
                                            WAR.Person[WAR.CurID]["人物编号"] == jqid then
                                            WAR.PD['玄阴煞气'][jqid] = 100
                                        end
                                    end
                                end
                            end
                            for x = 0, WAR.PersonNum - 1 do
                                if WAR.Person[x]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
                                    WAR.Person[x]["死亡"] == false then
                                    local offset1 =
                                        math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[x]["坐标X"])
                                    local offset2 =
                                        math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[x]["坐标Y"])
                                    if offset1 <= 5 and offset2 <= 5 then
                                        WAR.PD['破甲状态'][WAR.Person[x]["人物编号"]] = 1
                                    end
                                    SetWarMap(WAR.Person[x]["坐标X"], WAR.Person[x]["坐标Y"], 4, 1)
                                end
                            end
                        end
                        if WAR.PD['玄阴煞气'][jqid] ~= nil and WAR.PD['玄阴煞气'][jqid] == 100 then
                            local s = WAR.CurID
                            WAR.CurID = i
                            WarDrawMap(0)
                            CurIDTXDH(WAR.CurID, 123, 1, "玄阴煞气", LightGreen)
                            WAR.CurID = s
                            WAR.PD['玄阴煞气'][jqid] = 99
                        end
                    end
                end
                -- 张家辉的隐身戒指
                if WAR.YSJZ ~= 0 then
                    WAR.YSJZ = WAR.YSJZ - 1
                end
                if Pmiji(jqid, 1) then
                    local t = JY.Person[jqid]['资质'] - 1
                    if t < 30 then
                        t = 30
                    end
                    if WAR.PD['中庸'][jqid] == nil or WAR.PD['中庸'][jqid] < t then
                        WAR.PD['中庸'][jqid] = (WAR.PD['中庸'][jqid] or 0) + 1
                        if WAR.PD['中庸'][jqid] >= t then
                            WAR.PD['中庸'][jqid] = 0
                            Cat('立刻出手', i)
                            WAR.CurID = i
                            WarDrawMap(0)
                            CurIDTXDH(WAR.CurID, 6, 1, "中庸之道", PinkRed)
                            -- atid = i
                            xunhuan = false
                        end
                    end
                end

                if WAR.PD["逆水寒"][jqid] ~= nil and WAR.PD["逆水寒"][jqid] > 0 then
                    WAR.PD["逆水寒CD"][jqid] = 5
                    Cat('立刻出手', i)
                    Cat('护盾停止', i)
                    WAR.CurID = i
                    xunhuan = false
                end

                -- 万毒蚀体3
                if WAR.PD['万毒蚀体CD'][jqid] ~= nil and WAR.PD['万毒蚀体CD'][jqid] > 0 then
                    WAR.PD['万毒蚀体CD'][jqid] = WAR.PD['万毒蚀体CD'][jqid] - 1
                    if WAR.PD['万毒蚀体CD'][jqid] <= 0 then
                        WAR.PD['万毒蚀体CD'][jqid] = nil
                    end
                end
                -- WAR.Person[i].Time = 1001
                -- 蓝烟清：王难姑指令，按时序中毒
                if WAR.L_WNGZL[jqid] ~= nil and WAR.L_WNGZL[jqid] > 0 then
                    AddPersonAttrib(jqid, '中毒程度', 1)
                    WAR.L_WNGZL[jqid] = WAR.L_WNGZL[jqid] - 1;

                    if WAR.L_WNGZL[jqid] <= 0 then
                        WAR.L_WNGZL[jqid] = nil;
                    end
                end

                -- brolycjw：胡青牛指令，每个时序回复1%血
                if WAR.L_HQNZL[jqid] ~= nil and WAR.L_HQNZL[jqid] > 0 then
                    -- JY.Person[jqid]["生命"] = JY.Person[jqid]["生命"] + math.modf(JY.Person[jqid]["生命最大值"]/100);
                    AddPersonAttrib(jqid, '生命', math.modf(JY.Person[jqid]["生命最大值"] / 100))

                    -- if JY.Person[jqid]["受伤程度"] > 50 then
                    if WAR.PD['内伤状态'][jqid] ~= nil and WAR.PD['内伤状态'][jqid] > 50 then
                        -- JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 2;
                        -- AddPersonAttrib(jqid,'受伤程度',-2)
                        WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 2
                    else
                        -- JY.Person[jqid]["受伤程度"] = JY.Person[jqid]["受伤程度"] - 1;
                        -- AddPersonAttrib(jqid,'受伤程度',-1)
                        WAR.PD['内伤状态'][jqid] = (WAR.PD['内伤状态'][jqid] or 0) - 1
                    end
                    WAR.L_HQNZL[jqid] = WAR.L_HQNZL[jqid] - 1;
                    if WAR.L_HQNZL[jqid] <= 0 then
                        WAR.L_HQNZL[jqid] = nil;
                    end
                end
                -- 长生回天回复 标记修改
                if WAR.PD["长生回天"][jqid] ~= nil then
                    AddPersonAttrib(jqid, '生命', math.modf(JY.Person[jqid]["生命最大值"] / 200))
                    AddPersonAttrib(jqid, '内力', math.modf(JY.Person[jqid]["内力最大值"] / 200))
                    AddPersonAttrib(jqid, '体力', 1)
                    AddPersonAttrib(jqid, '中毒程度', -1)
                    AddPersonAttrib(jqid, '受伤程度', -1)
                    AddPersonAttrib(jqid, '冰封程度', -1)
                    AddPersonAttrib(jqid, '灼烧程度', -1)
                    WAR.PD["长生回天"][jqid] = WAR.PD["长生回天"][jqid] - 1;
                    if WAR.PD["长生回天"][jqid] <= 0 then
                        WAR.PD["长生回天"][jqid] = nil;
                    end
                end

                if match_ID(jqid, 9742) then
                    if WAR.Person[i].Time < 0 then
                        WAR.Person[i].Time = 0
                    end
                end

                if WAR.PD['禁疗'][jqid] ~= nil then
                    WAR.PD['禁疗'][jqid] = WAR.PD['禁疗'][jqid] - 1
                    if WAR.PD['禁疗'][jqid] <= 0 then
                        WAR.PD['禁疗'][jqid] = nil
                    end
                end
                -- 无酒不欢：集气读数获取位置
                WAR.JQSDXS[jqid] = math.modf(jq)
				--lib.Debug(JY.Person[jqid]['姓名']..'集气值 ='..WAR.JQSDXS[jqid])
                if WAR.Person[i].Time >= 1000 then
                    -- if jqwz < WAR.Person[i].Time then 
                    jqwz = WAR.Person[i].Time
                    atid = i
                    -- end
                    xunhuan = false
                end

                if WAR.PD['御气纵横'][jqid] ~= nil then
                    WAR.PD['御气纵横'][jqid] = WAR.PD['御气纵横'][jqid] - 1
                    if WAR.PD['御气纵横'][jqid] < 1 then
                        WAR.PD['御气纵横'][jqid] = nil
                        Cat('护盾停止', i)
                    end
                    if math.random(10) < 2 then
                        WAR.CurID = i
                        WarDrawMap(0)
                        CurIDTXDH(WAR.CurID, 129, 1, '御气纵横')
                        WAR.PD['时序出手'][#WAR.PD['时序出手'] + 1] = i
                        xunhuan = false
                    end
                end
            -----------------------------------时序恢复状态---------------------------
                if WAR.PD['气血相生'][jqid] ~= nil then
                    WAR.PD["气血相生"][jqid] = WAR.PD["气血相生"][jqid] - 1
                    if WAR.PD["气血相生"][jqid] < 1 then
                        WAR.PD["气血相生"][jqid] = nil
                    end
                end            
                if WAR.PD['冻结'][jqid] ~= nil then
                    WAR.PD["冻结"][jqid] = WAR.PD["冻结"][jqid] - 1
                    if WAR.PD["冻结"][jqid] < 1 then
                        WAR.PD["冻结"][jqid] = nil
                    end
                end
                if WAR.PD['玄阴煞气'][jqid] ~= nil then
                    WAR.PD["玄阴煞气"][jqid] = WAR.PD["玄阴煞气"][jqid] - 1
                    if WAR.PD["玄阴煞气"][jqid] < 1 then
                        WAR.PD["玄阴煞气"][jqid] = nil
                    end
                end
                if WAR.PD['小还丹'][jqid] ~= nil then
                    WAR.PD['小还丹'][jqid] = WAR.PD['小还丹'][jqid] - 1
                    if WAR.PD['小还丹'][jqid] < 1 then
                        WAR.PD['小还丹'][jqid] = nil
                    end
                end

                if WAR.PD["魔神降临"][jqid] ~= nil then
                    WAR.PD["魔神降临"][jqid] = WAR.PD["魔神降临"][jqid] - 1
                    if WAR.PD["魔神降临"][jqid] < 1 then
                        WAR.PD["魔神降临"][jqid] = nil
                    end
                end
                if WAR.PD["定乾坤"][jqid] ~= nil then
                    WAR.PD["定乾坤"][jqid] = WAR.PD["定乾坤"][jqid] - 1
                    if WAR.PD["定乾坤"][jqid] < 1 then
                        WAR.PD["定乾坤"][jqid] = nil
                    end
                end
                if WAR.PD["无招胜有招"][jqid] ~= nil then
                    WAR.PD["无招胜有招"][jqid] = WAR.PD["无招胜有招"][jqid] - 1
                    if WAR.PD["无招胜有招"][jqid] < 1 then
                        WAR.PD["无招胜有招"][jqid] = nil
                    end
                end

                if WAR.PD["玄冰界"][jqid] ~= nil then
                    WAR.PD["玄冰界"][jqid] = WAR.PD["玄冰界"][jqid] - 1
                    if WAR.PD["玄冰界"][jqid] <= 270 then
                        WAR.Person[i]['护盾'] = nil
                    end
                    if WAR.PD["玄冰界"][jqid] < 1 then
                        WAR.PD["玄冰界"][jqid] = nil
                    end
                end
                if WAR.PD['梨花酒'][jqid] ~= nil then
                    AddPersonAttrib(jqid, '冰封程度', -1)
                    WAR.PD['梨花酒'][jqid] = WAR.PD['梨花酒'][jqid] - 1
                    if WAR.PD['梨花酒'][jqid] < 1 then
                        WAR.PD['梨花酒'][jqid] = nil
                    end
                end

                if WAR.PD['玉露酒'][jqid] ~= nil then
                    AddPersonAttrib(jqid, '灼烧程度', -1)
                    WAR.PD['玉露酒'][jqid] = WAR.PD['玉露酒'][jqid] - 1
                    if WAR.PD['玉露酒'][jqid] < 1 then
                        WAR.PD['玉露酒'][jqid] = nil
                    end
                end
                if WAR.PD['五宝花蜜酒'][jqid] ~= nil then
                    WAR.PD['五宝花蜜酒'][jqid] = WAR.PD['五宝花蜜酒'][jqid] - 1
                    if WAR.PD['五宝花蜜酒'][jqid] < 1 then
                        WAR.PD['五宝花蜜酒'][jqid] = nil
                    end
                end
                if WAR.PD['即墨老酒'][jqid] ~= nil then
                    if WAR.LXZT[jqid] ~= nil then
                        WAR.LXZT[jqid] = WAR.LXZT[jqid] - 1
                        if WAR.LXZT[jqid] < 1 then
                            WAR.LXZT[jqid] = nil
                        end
                    end
                    WAR.PD['即墨老酒'][jqid] = WAR.PD['即墨老酒'][jqid] - 1
                    if WAR.PD['即墨老酒'][jqid] < 1 then
                        WAR.PD['即墨老酒'][jqid] = nil
                    end
                end

                -- 灭绝的玉石俱焚，100时序
                if WAR.PD["玉石俱焚"][jqid] ~= nil then
                    WAR.PD["玉石俱焚"][jqid] = WAR.PD["玉石俱焚"][jqid] - 1

                    if WAR.PD["玉石俱焚"][jqid] < 1 then
                        WAR.PD["玉石俱焚"][jqid] = nil
                    end
                end
                -- 神罗cd
                if Pmiji(jqid, 7) and WAR.PD['神罗CD'][jqid] ~= nil then
                    WAR.PD['神罗CD'][jqid] = WAR.PD['神罗CD'][jqid] - 1
                    if WAR.PD['神罗CD'][jqid] < 1 then
                        WAR.PD['神罗CD'][jqid] = nil
                    end
                end
                -- 神罗天征
                if Pmiji(jqid, 7) and WAR.PD['神罗天征'][jqid] ~= nil then
                    WAR.PD['神罗天征'][jqid] = WAR.PD['神罗天征'][jqid] - 1
                    if WAR.PD['神罗天征'][jqid] < 1 then
                        WAR.PD['神罗天征'][jqid] = nil
                    end
                end
                -- 李寻欢小李飞刀状态，
                if WAR.PD["小李飞刀"][jqid] ~= nil then
                    WAR.PD["小李飞刀"][jqid] = WAR.PD["小李飞刀"][jqid] - 1

                    if WAR.PD["小李飞刀"][jqid] < 1 then
                        WAR.PD["小李飞刀"][jqid] = nil
                    end
                end

                if WAR.PD['西瓜刀・残刀'][jqid] ~= nil then
                    if WAR.PD['西瓜刀・残刀'][jqid][2] ~= nil and WAR.PD['西瓜刀・残刀'][jqid][2] > 0 then
                        WAR.PD['西瓜刀・残刀'][jqid][2] = WAR.PD['西瓜刀・残刀'][jqid][2] - 1
                        if WAR.PD['西瓜刀・残刀'][jqid][2] < 1 then
                            WAR.PD['西瓜刀・残刀'][jqid] = nil
                        end
                    end
                end
                -- 逍遥御风闪避
                if WAR.PD['逍遥御风闪避'][jqid] ~= nil and WAR.PD['逍遥御风闪避'][jqid] > 1 then
                    WAR.PD['逍遥御风闪避'][jqid] = WAR.PD['逍遥御风闪避'][jqid] - 1
                end
                -- 虚弱状态 
                if WAR.PD["虚弱状态"][jqid] ~= nil then
                    WAR.PD["虚弱状态"][jqid] = WAR.PD["虚弱状态"][jqid] - 1
                    if WAR.PD["虚弱状态"][jqid] < 1 then
                        WAR.PD["虚弱状态"][jqid] = nil
                    end
                end
                -- 神行百变清除
                if WAR.PD["神行百变闪避"][jqid] ~= nil then
                    WAR.PD["神行百变闪避"][jqid] = WAR.PD["神行百变闪避"][jqid] - 1
                    if WAR.PD["神行百变闪避"][jqid] < 1 then
                        WAR.PD["神行百变闪避"][jqid] = nil
                    end
                end
                if WAR.PD["扫荡群魔"][jqid] ~= nil then
                    WAR.PD["扫荡群魔"][jqid] = WAR.PD["扫荡群魔"][jqid] - 1
                    if WAR.PD["扫荡群魔"][jqid] < 1 then
                        WAR.PD["扫荡群魔"][jqid] = nil
                    end
                end
                -- 先天护盾
                if WAR.PD["先天护盾CD"][jqid] ~= nil and WAR.PD["先天护盾"][jqid] == nil then
                    WAR.PD["先天护盾CD"][jqid] = WAR.PD["先天护盾CD"][jqid] - 1
                    if WAR.PD["先天护盾CD"][jqid] < 1 then
                        WAR.PD["先天护盾CD"][jqid] = nil
                    end
                end

                -- 轻云蔽月时序计数
                if WAR.QYBY[jqid] ~= nil then
                    WAR.QYBY[jqid] = WAR.QYBY[jqid] - 1
                    if WAR.QYBY[jqid] < 1 then
                        WAR.QYBY[jqid] = nil
                    end
                end
                -- 唯我不败
                if WAR.PD["唯我不败"][jqid] ~= nil then
                    WAR.PD["唯我不败"][jqid] = WAR.PD["唯我不败"][jqid] - 1
                    if WAR.PD["唯我不败"][jqid] < 1 then
                        WAR.PD["唯我不败"][jqid] = nil
                    end
                end
                -- 天魔金身时序计数
                if WAR.TMJT[jqid] ~= nil then
                    WAR.TMJT[jqid] = WAR.TMJT[jqid] - 1
                    if WAR.TMJT[jqid] < 1 then
                        WAR.TMJT[jqid] = nil
                    end
                end

                -- 进阶泰山，使用后30时序内闪避 
                if WAR.PD["十八盘"][jqid] ~= nil then
                    WAR.PD["十八盘"][jqid] = WAR.PD["十八盘"][jqid] - 1
                    if WAR.PD["十八盘"][jqid] < 1 then
                        WAR.PD["十八盘"][jqid] = nil
                    end
                end
                -- 霍青桐指令
                if WAR.PD["号令三军"][jqid] ~= nil then
                    WAR.PD["号令三军"][jqid] = WAR.PD["号令三军"][jqid] - 1
                    if WAR.PD["号令三军"][jqid] < 1 then
                        WAR.PD["号令三军"][jqid] = nil
                    end
                end
                -- 文泰来 否极泰来状态计时 WTL_PJTL
                if WAR.WTL_PJTL[jqid] ~= nil then
                    WAR.WTL_PJTL[jqid] = WAR.WTL_PJTL[jqid] - 1
                    if WAR.WTL_PJTL[jqid] < 1 then
                        WAR.WTL_PJTL[jqid] = nil
                        WAR.PD["否极泰来"][jqid] = nil
                    end
                end
                -- 文泰来 否极泰来倒计时
                if WAR.PD["否极泰来"][jqid] ~= nil then
                    WAR.PD["否极泰来"][jqid] = WAR.PD["否极泰来"][jqid] - 1
                    if WAR.PD["否极泰来"][jqid] < 1 then
                        WAR.PD["否极泰来"][jqid] = 0
                    end
                end

                -- 青莲剑仙，使用后50时序内闪避
                if WAR.PD["身藏身与名"][jqid] ~= nil then
                    WAR.PD["身藏身与名"][jqid] = WAR.PD["身藏身与名"][jqid] - 1
                    if WAR.PD["身藏身与名"][jqid] < 1 then
                        WAR.PD["身藏身与名"][jqid] = nil
                    end
                end
                -- 大周天功回复50时序
                if WAR.PD["养生主"][jqid] ~= nil then
                    WAR.PD["养生主"][jqid] = WAR.PD["养生主"][jqid] - 1
                    if WAR.PD["养生主"][jqid] < 1 then
                        WAR.PD["养生主"][jqid] = nil
                    end
                end
                -- 陆渐三十二身相 一合相
                if WAR.PD["三十二身像"][jqid] ~= nil then
                    WAR.PD["三十二身像"][jqid] = WAR.PD["三十二身像"][jqid] - 1
                    if WAR.PD["三十二身像"][jqid] < 1 then
                        WAR.PD["三十二身像"][jqid] = nil
                    end
                end
                -- 陆渐 金刚法相
                if WAR.PD["金刚法相"][jqid] ~= nil then
                    WAR.PD["金刚法相"][jqid] = WAR.PD["金刚法相"][jqid] - 1
                    if WAR.PD["金刚法相"][jqid] < 1 then
                        WAR.PD["金刚法相"][jqid] = nil
                    end
                end

                if WAR.PD['长生诀'][jqid] ~= nil then
                    AddPersonAttrib(jqid, '生命', math.modf(JY.Person[jqid]["生命最大值"] / 100))
                    AddPersonAttrib(jqid, '内力', math.modf(JY.Person[jqid]["内力最大值"] / 100))
                    AddPersonAttrib(jqid, '体力', 1)
                    WAR.PD['长生诀'][jqid] = WAR.PD['长生诀'][jqid] - 1
                    if WAR.PD['长生诀'][jqid] < 1 then
                        WAR.PD['长生诀'][jqid] = nil
                    end
                end
                -- 无明业火状态，耗损使用的内力一半的生命，30时序
                if WAR.PD["无名业火"][jqid] ~= nil then
                    WAR.PD["无名业火"][jqid] = WAR.PD["无名业火"][jqid] - 1
                    if WAR.PD["无名业火"][jqid] < 1 then
                        WAR.PD["无名业火"][jqid] = nil
                    end
                end
                -- 浑天气功 天行键
                if WAR.PD['天行健'][jqid] ~= nil then
                    WAR.PD['天行健'][jqid] = WAR.PD['天行健'][jqid] - 1
                    if WAR.PD['天行健'][jqid] < 1 then
                        WAR.PD['天行健'][jqid] = nil
                    end
                end
            end
        end
        if WAR.CD > 0 then
            WAR.CD = WAR.CD - 1
        end
        Cat('天关阵')

        if #WAR.ATK['人物table'] > 0 then
            atid = WAR.ATK['人物table'][#WAR.ATK['人物table']]
            local id = WAR.Person[atid]['人物编号']
            table.remove(WAR.ATK['人物table'], #WAR.ATK['人物table'])
            WAR.ATK['人物pd'][id] = nil
            if #WAR.ATK['人物table'] == 0 then
                WAR.ATK['人物table'] = {}
            end
        end

        Cat('实时特效动画')
        WarDrawMap(0)

        DrawTimeBar_sub()
        Cat('实时特效动画2', 1)
        ShowScreen()
        lib.Delay(CC.BattleDelay) -- 黑魅灵蜜汁调整刷新速度
        -- lib.Delay(10)
        WAR.SXTJ = WAR.SXTJ + 1
        -- 无酒不欢：三时序，五时序，六时序，九时序的计数器
        WAR.SSX_Counter = WAR.SSX_Counter + 1
        if WAR.SSX_Counter == 4 then
            WAR.SSX_Counter = 1
        end
        WAR.WSX_Counter = WAR.WSX_Counter + 1
        if WAR.WSX_Counter == 6 then
            WAR.WSX_Counter = 1
        end
        WAR.LSX_Counter = WAR.LSX_Counter + 1
        if WAR.LSX_Counter == 7 then
            WAR.LSX_Counter = 1
        end
        WAR.JSX_Counter = WAR.JSX_Counter + 1
        if WAR.JSX_Counter == 10 then
            WAR.JSX_Counter = 1
        end
        -- lib.Delay(10) -- 无酒不欢：减缓集气条速度	

        -- 集气过程中按空格或回车停止自动
        local keypress = lib.GetKey()
        if (keypress == VK_SPACE or keypress == VK_RETURN or keypress == VK_ESCAPE) then
            if WAR.AutoFight == 1 then
                WAR.AutoFight = 0
            end
        end
        -- fuhuo(emenyid)
        local ed = War_isEnd2()
        if 0 < ed then
            xunhuan = false
            atid = 0
            WAR.ATK['中断'] = true
        end
        -- lib.LoadSur(surid, x1 - ((x2 - x1) / 2)-100, 0)	--无酒不欢：修复杀到-100后集气条小头像刷新问题
    end

    ::label1::

    -- local warStatus = War_isEnd()   --战斗是否结束？   0继续，1赢，2输

    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["死亡"] == false then
            WAR.Person[i].TimeAdd = 0
        end
    end

    if #WAR.PD['时序出手'] > 0 then
        for i = 1, #WAR.PD['时序出手'] do
            local p = WAR.PD['时序出手'][i]
            local id = WAR.Person[p]['人物编号']
            if JY.Person[id]['生命'] > 0 and WAR.Person[p]['死亡'] == false then
                WAR.CurID = p
                WarDrawMap(0)
                if WAR.AutoFight == 1 or WAR.Person[p]['我方'] == false or WAR.ZDDH == 354 then
                    War_AutoFight()
                else
                    Cat('武功招式')
                end
            end
        end
    end

    WAR.PD['时序出手'] = {}
    if atid == -1 then
        atid = 0
        WAR.ATK['中断'] = true
    end
    -- WAR.ZYHBP = -1
    -- lib.SetClip(0, 0, 0, 0)
    -- lib.FreeSur(surid)
    return atid
end

-- 绘画整体集气条
function DrawTimeBar_sub(x1, x2, y, flag)
    local bx, by = CC.WX, CC.HY
    local size = CC.FontSMALL
    -- 无酒不欢：绘画部分增加破绽区显示
    if not x2 then
        x2 = CC.ScreenW * 19 / 20 - CC.ScreenW / 680 -- X上方位置
    end
    if not y then
        y = CC.ScreenH / 10 + CC.ScreenH / 26.482
    end
    if not x1 then
        x1 = CC.ScreenW * 1 / 2 - CC.ScreenW / 40 -- X下方位置

        lib.LoadPNG(91, 23 * 2, CC.ScreenW / 3.4, CC.ScreenH / 153.6, 1)

        GUWarTime()
    end

    for i = 0, WAR.PersonNum - 1 do
        if not WAR.Person[i]["死亡"] then
            -- 无酒不欢：修正集气条显示，不会飞过1000
            if WAR.Person[i].Time > 1001 then
                WAR.Person[i].Time = 1001
            end
            if WAR.Person[i].Time < -100 then
                WAR.Person[i].Time = -100
            end
            local id = WAR.Person[i]["人物编号"]
            local cx = x1 + math.modf(WAR.Person[i].Time * (x2 - x1) / 1000)
            local headid = JY.Person[id]["半身像"]
            if headid == nil then
                headid = JY.Person[id]["半身像"]
            end
            local w, h = limitX(CC.ScreenW / 25, 12, 35), limitX(CC.ScreenW / 25, 12, 35)
            local jq_color = C_WHITE
            if JY.Person[id]["中毒程度"] > 99 then
                jq_color = RGB(56, 136, 36)
            elseif JY.Person[id]["中毒程度"] >= 50 then
                jq_color = RGB(120, 208, 88)
            end
            if WAR.LQZ[id] == 100 then
                jq_color = C_RED
            end
            if WAR.Person[i]["我方"] then
                drawname(cx, 1, id, CC.FontSmall)
                lib.LoadPNG(99, headid * 2, cx - w / 2, y - h - 4, 1)
                if JY.Person[id]["灼烧程度"] ~= 0 then
                    DrawString(cx, y - CC.ScreenH / 17.86, string.format("%3d", JY.Person[id]["灼烧程度"]), C_ORANGE, CC.FontSMALL) -- 灼烧数值
                end
                if WAR.FXDS[id] ~= nil and WAR.FXDS[id] ~= 0 then
                    DrawString(cx - CC.ScreenW / 64.762, y - CC.ScreenH / 17.86, string.format("%3d", WAR.FXDS[id]), C_GOLD, CC.FontSMALL) -- 封穴数值
                end
            else
                drawname(cx, y + h, id, CC.FontSmall)
                lib.LoadPNG(99, headid * 2, cx - w / 2, y, 1)
                if JY.Person[id]["灼烧程度"] ~= 0 then
                    DrawString(cx, y + h - CC.ScreenH / 23.2727, string.format("%3d", JY.Person[id]["灼烧程度"]), C_ORANGE, CC.FontSMALL) -- 灼烧数值
                end
                if WAR.FXDS[id] ~= nil and WAR.FXDS[id] ~= 0 then
                    DrawString(cx - CC.ScreenW / 64.762, y + h - CC.ScreenH / 23.2727,string.format("%3d", WAR.FXDS[id]), C_GOLD, CC.FontSMALL) -- 封穴数值
                end
            end
        end
    end
    local sxwz = "时序"
    local sxwzx = 0
    if WAR.SXTJ > 9 then
        sxwzx = CC.ScreenW / 91.2
    end
    if WAR.SXTJ > 99 then
        sxwzx = CC.ScreenW / 45.333
    end
    if WAR.SXTJ > 999 then
        sxwzx = CC.ScreenW / 30.222
    end
    if WAR.SXTJ > 9999 then
        sxwzx = CC.ScreenW / 22.666
    end
    if WAR.AutoFight == 1 then
        lib.LoadPNG(91, 69 * 2, CC.ScreenW - CC.ScreenW / 20, CC.ScreenH / 1.5, 1)
    end
    lib.DrawStr(CC.ScreenW / 2.5185 - string.len(sxwz) * size / 4, CC.ScreenH / 9.035, sxwz, C_GOLD, size * 1.6,CONFIG.CurrentPath .. "FONT/2.ttf", 0, 0)
    DrawString(CC.ScreenW / 2.72 - sxwzx, CC.ScreenH / 9.035, WAR.SXTJ, C_GOLD, CC.DefaultFont * 0.9)
    local X, ktype, mx, my = lib.GetKey();
    if mx ~= -1 and my ~= -1 then
        -- px,py = mx,my
    end
    local mxx = false
    if mx > CC.ScreenW - CC.ScreenW / 20 and mx < CC.ScreenW - CC.ScreenW / 20 + CC.ScreenW / 20 and my > CC.ScreenH /
        1.5 and my < CC.ScreenH / 1.5 + CC.ScreenH / 10 then
        mxx = true
    end
    if mxx == true and ktype == 3 then
        WAR.AutoFight = 0
    end
end

-- 绘画集气条上的名字
function drawname(x, y, id, size)
    local name = JY.Person[id]["姓名"]
    local color = C_WHITE
    -- 名字颜色随冰封和内伤变化 
    local ns = (WAR.PD['内伤状态'][id] or 0)
    if ns > JY.Person[id]["冰封程度"] then
        if JY.Person[id]["受伤程度"] > 99 then
            color = RGB(232, 32, 44)
        elseif JY.Person[id]["受伤程度"] > 66 then
            color = RGB(244, 128, 32)
        elseif JY.Person[id]["受伤程度"] > 33 then
            color = RGB(236, 200, 40)
        end
    else
        if JY.Person[id]["冰封程度"] >= 50 then
            color = M_RoyalBlue
        elseif JY.Person[id]["冰封程度"] > 0 then
            color = LightSkyBlue
        end
    end
    x = x - math.modf(size / 2)
    local namelen = string.len(name) / 2
    local zi = {}
    for i = 1, namelen do
        zi[i] = string.sub(name, i * 2 - 1, i * 2)
        DrawString(x, y, zi[i], color, size)
        y = y + size
    end
end

function draw2(str, x, y, color, size, color2)

    x = x - size / 2
    local namelen = string.len(str) / 2
    local zi = {}
    for i = 1, namelen do
        zi[i] = string.sub(str, i * 2 - 1, i * 2)
        if color2 ~= nil then
            if i == namelen then
                color = color2
            end
        end
        DrawString(x, y + size * (i - 1) / 2, zi[i], color, size)
        y = y + size
    end
end

function draw3(str, x, y, color, size, color2, h,ttf)
    ttf = ttf or CC.FontName
    x = x - size / 2
    local namelen = string.len(str) / 2
    local zi = {}
    h = h or size
    for i = 1, namelen do
        zi[i] = string.sub(str, i * 2 - 1, i * 2)
        if color2 ~= nil then
            if i == namelen then
                color = color2
            end
        end
        DrawString(x, y, zi[i], color, size,ttf)
        y = y + h
    end
end

-- 判断两人之间的距离
function RealJL(id1, id2, len)
    if not len then
        len = 1
    end
    local x1, y1 = WAR.Person[id1]["坐标X"], WAR.Person[id1]["坐标Y"]
    local x2, y2 = WAR.Person[id2]["坐标X"], WAR.Person[id2]["坐标Y"]
    local s = math.abs(x1 - x2) + math.abs(y1 - y2)
    if len == nil then
        return s
    end
    if s <= len then
        return true
    else
        return false
    end
end

-- 计算武功范围
function refw(wugong, level)
    -- 无酒不欢：参数说明
    -- m1为移动范围斜向延伸：
    -- 0：延伸为直线距离-1，1：延伸至直线距离，2：延伸为0 3：移动范围固定为自身周围8格
    -- m2为移动范围直线延伸；
    -- 数字即等于延伸距离
    -- a1为攻击范围类型：
    -- 0：点攻，1：十字，2：菱形，3：面攻，5：十字，6：井字，7：田字，8：d字，9：e字，10：直线，11：正三角，12：倒三角，13：横线
    -- a2为攻击范围长度距离：
    -- 0：点攻，大于0时，距离 = a2
    -- a3为攻击范围宽度(偏移1格)距离：
    -- 0：点攻，大于0时，距离 = a3  
    -- a4为攻击范围宽度(偏移2格)距离：
    -- 0：点攻，大于0时，距离 = a4
    -- a5为攻击范围宽度(偏移3格)距离：
    -- 0：点攻，大于0时，距离 = a5
    local m1, m2, a1, a2, a3, a4, a5, a6 = nil, nil, nil, nil, nil, nil, nil, nil
    if JY.Wugong[wugong]["攻击范围"] == -1 then
        return JY.Wugong[wugong]["加内力1"], JY.Wugong[wugong]["加内力2"], JY.Wugong[wugong]["未知1"],
            JY.Wugong[wugong]["未知2"], JY.Wugong[wugong]["未知3"], JY.Wugong[wugong]["未知4"],
            JY.Wugong[wugong]["未知5"]
    end
    -- 0：点
    -- 1：线
    -- 2：十字
    -- 3：面
    local fightscope = JY.Wugong[wugong]["攻击范围"]
    local kfkind = JY.Wugong[wugong]["武功类型"]
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    -- 六脉神剑算剑法的范围
    if wugong == 49 then
        kfkind = 3
    end
    -- 玄女剑法算奇门的范围
    if wugong == 161 then
        kfkind = 5
    end
    -- 逍遥神剑算刀法的范围
    if wugong == 168 then
        kfkind = 4
    end
    -- 阴风刀算剑法的范围
    if wugong == 174 then
        kfkind = 3
    end
    if wugong == 47 or wugong == 363 then
        kfkind = 2
    end
    -- 王语嫣妙法无形
    local MiaofaWX = 0
    local mx = 0

    -- 王语嫣妙法无形
    local tf76 = hastf(WAR.CurID, 76, 1)
    if tf76 ~= nil then
        for j = 1, #tf76 do
            MiaofaWX = MiaofaWX + 1
        end
    end
    -- 内轻特效935
    if NeiGong_tx(pid, 935) and (JY.Person[pid]["武器"] == 335) == false then
        mx = MiaofaWX + 1
        if mx > 2 then
            mx = 2
        end
        MiaofaWX = mx
    end

    -- 诸行无常
    if match_ID(pid, 9985) then
        mx = MiaofaWX + 1
        if mx > 2 then
            mx = 2
        end
        MiaofaWX = mx
    end
    -- 方证用拳法范围+1
    if match_ID(pid, 149) and kfkind == 1 then
        mx = MiaofaWX + 1
        if mx > 2 then
            mx = 2
        end
        MiaofaWX = mx
    end
    -- 萧半和混元功范围+1
    if match_ID(pid, 9795) and wugong == 90 then
        mx = MiaofaWX + 1
        if mx > 2 then
            mx = 2
        end
        MiaofaWX = mx
    end
    -- 萧秋水 剑气飞纵 用武功范围+1
    if match_ID(pid, 9725) and (JY.Base["天书数量"] > 5 or inteam(pid) == false) then
        mx = MiaofaWX + 1
        if mx > 2 then
            mx = 2
        end
        MiaofaWX = mx
    end
    -- 莫大剑法范围+1
    if match_ID(pid, 9890) and kfkind == 3 then
        mx = MiaofaWX + 1
        if mx > 2 then
            mx = 2
        end
        MiaofaWX = mx
    end

    -- 双剑合壁范围增加范围
    if (wugong == 39 or wugong == 42 or wugong == 139) and Pmiji(pid, 23) then
        mx = MiaofaWX + 1
        if mx > 4 then
            mx = 4
        end
        MiaofaWX = mx
    end

    -- 苗人凤，苗剑范围随御剑系数增加
    if match_ID(pid, 3) and wugong == 44 then
        MiaofaWX = MiaofaWX + math.modf(TrueYJ(pid) / 200)
    end
    -- 闪电貂和妙手空空范围不增加
    if wugong == 113 or wugong == 116 then
        MiaofaWX = 0
    end
    -- 点
    if fightscope == 0 then
        if level > 10 then
            m1 = 1
            m2 = JY.Wugong[wugong]["移动范围" .. 10]
            a1 = 1
            a2 = 3 + MiaofaWX
            a3 = 3 + MiaofaWX
        else
            m1 = 0
            m2 = JY.Wugong[wugong]["移动范围" .. level]
            a1 = 1
            a2 = math.modf(level / 5) + MiaofaWX
            a3 = math.modf(level / 8) + MiaofaWX
        end
        -- 线
    elseif fightscope == 1 then
        -- 拳指
        if kfkind == 1 or kfkind == 2 then
            a1 = 12
            if level > 10 then
                m1 = 3
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
            else
                m1 = 2
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
            end
            -- 剑
        elseif kfkind == 3 then
            a1 = 10
            if level > 10 then
                m1 = 3
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. 10] + MiaofaWX
                a3 = a2 - 1
                a4 = a3 - 1
            else
                m1 = 2
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
            end
            if level > 7 then
                a3 = a2 - 1
            end
            -- 刀
        elseif kfkind == 4 then
            a1 = 11
            if level > 10 then
                m1 = 3
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
            else
                m1 = 2
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
            end
            -- 奇
        elseif kfkind == 5 then
            m1 = 2
            if level > 10 then
                m2 = JY.Wugong[wugong]["移动范围" .. 10] - 1
                a1 = 7
                -- 田字斗转时不会增加范围
                if WAR.DZXY == 0 then
                    a2 = 1 + math.modf(level / 3) + MiaofaWX
                else
                    a2 = 1 + math.modf(level / 3)
                end
                a3 = a2
            else
                m2 = JY.Wugong[wugong]["移动范围" .. level] - 1
                a1 = 1
                a2 = 1 + math.modf(level / 3) + MiaofaWX
            end
        else
            a1 = 11
            if level > 10 then
                m1 = 3
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
            else
                m1 = 2
                m2 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. level] - 1 + MiaofaWX
            end
        end
        -- 十字
    elseif fightscope == 2 then
        m1 = 0
        m2 = 0
        -- 刀
        if kfkind == 4 then
            if level > 10 then
                a1 = 6
                a2 = JY.Wugong[wugong]["移动范围" .. 10] + MiaofaWX
            else
                a1 = 8
                a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
            end
            -- 到极的非刀
        elseif level > 10 then
            -- 拳指
            if kfkind == 1 or kfkind == 2 then
                a1 = 5
                a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
                a3 = a2 - 3
                -- 剑
            elseif kfkind == 3 then
                a1 = 1
                a2 = JY.Wugong[wugong]["移动范围" .. 10] - 1 + MiaofaWX
                a3 = a2
            else
                a1 = 2
                a2 = 1 + math.modf(JY.Wugong[wugong]["移动范围" .. 10] / 2) + MiaofaWX
            end
            -- 不到极的非刀
        else
            a1 = 1
            a2 = JY.Wugong[wugong]["移动范围" .. level] + MiaofaWX
            a3 = 0
        end
        -- 面
    elseif fightscope == 3 then
        m1 = 0
        a1 = 3
        if level > 10 then
            m2 = JY.Wugong[wugong]["移动范围" .. 10] + 1
            a2 = JY.Wugong[wugong]["杀伤范围" .. 10] + MiaofaWX
            a3 = a2
        else
            m2 = JY.Wugong[wugong]["移动范围" .. level]
            a2 = JY.Wugong[wugong]["杀伤范围" .. level] + MiaofaWX
        end
    end
    -- 悲天佛怜 
    if (match_ID(pid, 9983) or Pmiji(pid, 15)) and wugong == 189 then
        a1 = 0
        m1 = 0
        m2 = 8
    end
    -- 擒龙手
    if wugong == 187 then
        a1 = 0
        m1 = 0
        m2 = 7
    end
    -- 太极神功范围随着蓄力变化
    -- 斗转时范围不变化
    if Curr_NG(pid, 171) and (wugong == 16 or wugong == 46) and WAR.PD["蓄气值"][pid] ~= nil and
        WAR.PD["蓄气值"][pid] > 0 and WAR.DZXY == 0 then
        if WAR.PD["蓄气值"][pid] > 600 then
            m1 = 0
            m2 = 4
            a1 = 3
            a2 = 4 + MiaofaWX
            a3 = a2
        elseif WAR.PD["蓄气值"][pid] > 500 then
            m1 = 0
            m2 = 4
            a1 = 3
            a2 = 3 + MiaofaWX
            a3 = a2
        elseif WAR.PD["蓄气值"][pid] > 300 then
            a2 = a2 + 2
            a3 = a3 + 2
        else
            a2 = a2 + 1
            a3 = a3 + 1
        end
    end

    -- 青冥剑随御剑系数增加
    if JY.Person[pid]["武器"] == 335 and kfkind == 3 then
        mx = 1
        a2 = a2 + mx
        a3 = a2
    end

    -- 玉箫剑法，配合桃花绝技范围增加
    if wugong == 38 and level == 11 and Pmiji(pid, 5) then
        a2 = 8 + MiaofaWX
        a3 = a2 - 1
        a4 = a3 - 1
    end
    -- 落英神剑掌，配合桃花绝技可移动
    if wugong == 12 and level == 11 and Pmiji(pid, 5) then
        m1 = 0
        m2 = 6
    end
    if wugong == 47 or wugong == 363 then
        m1 = 0
        m2 = 6
    end
    -- 玄铁可移动 标记修改
    if wugong == 45 then
        local pd = false
        if pid == 0 and JY.Base["标准"] == 3 then
            m1 = 0
            m2 = 4
        end
        if match_ID(pid, 58) or match_ID(pid, 9859) then
            m1 = 0
            m2 = 4
        end
        -- 一剑镇神州
        if JY.Person[pid]['奇穴' .. 19] == 1 then
            m1 = 0
            m2 = 4
        end
    end
    -- 辟邪可移动
    if wugong == 48 then
        if JY.Person[pid]['奇穴' .. 19] == 1 then
            m1 = 0
            m2 = 4
        end
    end
    -- 进阶万花，范围+1
    if (wugong == 30 or wugong == 370) and PersonKF(pid, 175) then
        a2 = a2 + 1
        a3 = a2
    end

    return m1, m2, a1, a2, a3, a4, a5, a6

end

-- 用CC表判断人物是否为队友，不管在不在队
function isteam(p)

    if p == 0 then
        return true
    end

    if CC.PersonExit[p] ~= nil then
        return true
    end

    return false
end

-- 判断人物是否有某种武功
function PersonKF(p, kf)
    -- 战场直接判定武功
    if JY.Status == GAME_WMAP then
        if WAR.WG[p] ~= nil then
            if WAR.WG[p][kf] ~= nil and WAR.WG[p][kf] >= 0 then
                return true
            end
        end
    else
        -- 其他场景正常循环		
        for i = 1, JY.Base["武功数量"] do
            if JY.Person[p]["武功" .. i] <= 0 then
                return false;
            elseif JY.Person[p]["武功" .. i] == kf then
                return true
            end
        end
    end
    -- if (match_ID(p, 19) or match_ID(p, 20) or match_ID(p, 21) or match_ID(p, 22) or match_ID(p, 23)) and kf==175 then
    --    return true
    -- end
end

-- 武功等级判定
function KfLv(p, kf)
    -- 战场直接判定武功等级
    if JY.Status == GAME_WMAP then
        if WAR.WG[p] ~= nil then
            if WAR.WG[p][kf] ~= nil then
                return WAR.WG[p][kf]
            end
        end
    else
        -- 其他场景正常循环	
        for i = 1, JY.Base["武功数量"] do
            if JY.Person[p]["武功" .. i] <= 0 then
                return 0;
            elseif JY.Person[p]["武功" .. i] == kf then
                return JY.Person[p]["武功等级" .. i]
            end
        end
    end
    return 0
end

-- 判断人物是否有某种武功，并且等级为极
function PersonKFJ(p, kf)
    -- 战场直接判定武功等级
    if JY.Status == GAME_WMAP then
        if WAR.WG[p] ~= nil then
            if WAR.WG[p][kf] == 999 then
                return true
            end
        end
    else
        for i = 1, JY.Base["武功数量"] do
            if JY.Person[p]["武功" .. i] <= 0 then
                return false;
            elseif JY.Person[p]["武功" .. i] == kf and JY.Person[p]["武功等级" .. i] == 999 then
                return true
            end
        end
    end
    return false
end

-- 判断触发机率
function myrandom(p, id)
    -- 生命越低，几率越高，最多10
    p = p + math.modf((JY.Person[id]["生命最大值"] - JY.Person[id]["生命"]) / 100 + 1);

    -- 体力越高，几率越高，最多10
    p = p + math.modf(JY.Person[id]["体力"] / 10)

    -- 惊才绝艳
    if match_ID(id, 9804) then
        p = p + 10
    end

    -- 奇门五转+5
    if PersonKF(id, 317) then
        if JY.Person[id]['奇穴' .. 142] then
            p = p + 5
        end
        p = p + 5
    end

    -- 逆运走火+20
    if WAR.PD["走火状态"][id] == 1 or match_ID(id, 98) then
        p = p + 20
    end

    -- 每25点实战+1，上限20
    local jp = math.modf(JY.Person[id]["实战"] / 25 + 1)
    if jp > 20 then
        jp = 20
    end
    p = p + jp

    -- 每500内力+1，最多20
    p = p + limitX(math.modf(JY.Person[id]["内力"] / 500), 0, 20)

    -- 每50点攻击力+1，最多10
    p = p + limitX(math.modf(JY.Person[id]["攻击力"] / 50), 0, 10)

    -- 每50点防御力+1，最多10
    p = p + limitX(math.modf(JY.Person[id]["防御力"] / 50), 0, 10)

    -- 每50点轻功+1，最多10
    p = p + limitX(math.modf(JY.Person[id]["轻功"] / 50), 0, 10)

    -- 基础判定次数为一次
    local times = 1
    -- 如果是我方
    if isteam(id) then
        -- 我方天书增加几率
        p = p + JY.Base["天书数量"]
        -- 石破天必定二次判定
        if match_ID(id, 9760) and times == 1 then
            times = 2
        end
        -- NPC默认为三次判定且几率+60
    else
        times = 3
        p = p + 50
    end

    for i = 1, times do
        local bd = math.random(120)
        if bd <= p then
            return true
        end
    end
    return false
end

function ZSrandom(p, id)

    -- 惊才绝艳
    if match_ID(id, 9804) then
        p = p + 10
    end

    -- 奇门五转+5
    if PersonKF(id, 317) then
        p = p + 5
    end

    -- 逆运走火+20
    if WAR.PD["走火状态"][id] == 1 or match_ID(id, 98) then
        p = p + 20
    end

    -- 每25点实战+1，上限20
    local jp = math.modf(JY.Person[id]["实战"] / 25 + 1)
    if jp > 20 then
        jp = 20
    end
    p = p + jp

    -- 每500内力+1，最多20
    p = p + limitX(math.modf(JY.Person[id]["内力"] / 500), 0, 20)

    -- 每50点攻击力+1，最多10
    p = p + limitX(math.modf(JY.Person[id]["攻击力"] / 50), 0, 10)

    -- 每50点防御力+1，最多10
    p = p + limitX(math.modf(JY.Person[id]["防御力"] / 50), 0, 10)

    -- 每50点轻功+1，最多10
    p = p + limitX(math.modf(JY.Person[id]["轻功"] / 50), 0, 10)

    -- 基础判定次数为一次
    local times = 1
    -- 如果是我方
    if isteam(id) then
        -- 我方天书增加几率
        p = p + JY.Base["天书数量"]
        -- 石破天必定二次判定
        if match_ID(id, 9760) and times == 1 then
            times = 2
        end
        -- NPC默认为三次判定且几率+60
    else
        times = 3
        p = p + 50
    end

    for i = 1, times do
        local bd = math.random(120)
        if bd <= p then
            return true
        end
    end
    return false
end

-- 自动选择敌人
function War_AutoSelectEnemy()
    local enemyid = War_AutoSelectEnemy_near()
    WAR.Person[WAR.CurID]["自动选择对手"] = enemyid
    return enemyid
end

-- 选择最近敌人
function War_AutoSelectEnemy_near()
    War_CalMoveStep(WAR.CurID, 100, 1) -- 标记每个位置的步数
    local maxDest = math.huge
    local nearid = -1
    for i = 0, WAR.PersonNum - 1 do -- 查找最近步数的敌人
        if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[i]["我方"] and WAR.Person[i]["死亡"] == false then
            local step = GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 3)
            if step < maxDest then
                nearid = i
                maxDest = step
            end
        end
    end
    return nearid
end

-- 无酒不欢：判定合击用的函数
function between(num_1, num_2, num_3, flag)
    if not flag then
        flag = 0
    end
    if num_3 < num_2 then
        num_2, num_3 = num_3, num_2
    end
    if flag == 0 and num_2 < num_1 and num_1 < num_3 then
        return true
    elseif flag == 1 and num_2 <= num_1 and num_1 <= num_3 then
        return true
    else
        return false
    end
end
-- 无酒不欢：独孤求败反击的伤害判定
function First_strike_dam_DG(pid, eid)
    local dam;
    local YJ_dif = TrueYJ(pid) * 1.2 - TrueYJ(eid)
    local p_wc = JY.Person[pid]["武学常识"]
    local e_wc = JY.Person[eid]["武学常识"]
    if p_wc < e_wc then
        p_wc = e_wc
    end
    dam = (JY.Person[pid]["攻击力"] - JY.Person[eid]["防御力"]) + (p_wc * 1.2 - e_wc) +
              (getnl(pid) / 50 * 1.2 - getnl(eid) / 50)
    dam = math.modf(dam + YJ_dif)
    return dam
end

-- 伤害公式中的内力，当前内力和最大内力都参与计算
function getnl(id)
    return (JY.Person[id]["内力"] * 2 + JY.Person[id]["内力最大值"]) / 3
end

-- 无酒不欢：血量翻倍函数
function Health_in_Battle()
    for i = 0, WAR.PersonNum - 1 do
        local pid = WAR.Person[i]["人物编号"]
        local dzmenu = {}
        if inteam(pid) or WAR.Person[i]["我方"] == true then
            -- 阵法
            if CC.TX['我方阵法'] > 0 then
                local zf = ZHEN[CC.TX['我方阵法']]
                WAR.PD[zf][pid] = 1
            end

            local num = 0
            local ngmenu = {}
            local wgmenu = {}
            local num1 = 0
            for i = 1, JY.Base["武功数量"] do
                if JY.Person[pid]["武功" .. i] > 0 then
                    local wugonglvl = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
                    local kfid = JY.Person[pid]["武功" .. i]
                    local wugongwl = get_skill_power(pid, kfid, wugonglvl)
                    if JY.Wugong[kfid]["武功类型"] < 6 and kfid > 0 then
                        wgmenu[#wgmenu + 1] = {kfid, wugongwl}
                        num1 = num1 + 1
                    end
                    if JY.Wugong[kfid]["武功类型"] == 6 and kfid > 0 then
                        num = num + 1
                        ngmenu[#ngmenu + 1] = {kfid, wugongwl}
                    end
                end
            end
            local wgmenu1 = {}
            for i = 1, #wgmenu do
                wgmenu1[#wgmenu1 + 1] = wgmenu[i][2]
            end
            local key, max = 1, wgmenu1[1]
            for k, v in ipairs(wgmenu1) do
                if wgmenu1[k] > max then
                    key, max = k, v
                end
            end
            if num1 > 0 and
                (JY.Person[pid]["优先使用"] < 1 or PersonKF(pid, JY.Person[pid]["优先使用"]) == false) then
                JY.Person[pid]["优先使用"] = wgmenu[key][1]
            end
            lib.Debug("我方：" .. JY.Person[pid]["姓名"] .. "(编号：" .. pid .. ")")
        else
            -- 阵法
            if CC.TX['敌方阵法'] > 0 then
                local zf = ZHEN[CC.TX['敌方阵法']]
                WAR.PD[zf][pid] = 1
            end
            -- lib.Debug("敌方："..JY.Person[pid]["姓名"].."(编号："..pid..")")    
        end
        -- 无酒不欢：非我方自动运功
        -- 老顾0309
        -- 外功
        if inteam(pid) == false or WAR.Person[i]["我方"] == false and pid ~= 512 then
            -- 阵法
            for w = 1, 10 do
                if JY.Person[pid]['秘技' .. w] >= 65 and JY.Person[pid]['秘技' .. w] <= 71 then
                    dzmenu[#dzmenu + 1] = JY.Person[pid]['秘技' .. w]
                end
            end
            if dzmenu[1] ~= nil then
                local nn = math.random(#dzmenu)
                lib.Debug('判断敌方有无阵法 大于0则为有 ' .. ' ' .. dzmenu[nn])
                CC.TX['敌方阵法'] = dzmenu[nn] - 64
            end
            if CC.TX['敌方阵法'] > 0 then
                local zf = ZHEN[CC.TX['敌方阵法']]
                WAR.PD[zf][pid] = 1
                lib.Debug('敌方阵法' .. ' ' .. ZHEN[CC.TX['敌方阵法']])
            end
            local num = 0
            local ngmenu = {}
            local wgmenu = {}
            local num1 = 0
            for i = 1, JY.Base["武功数量"] do
                local wugonglvl = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
                local kfid = JY.Person[pid]["武功" .. i]
                local wugongwl = get_skill_power(pid, kfid, wugonglvl)
                if (JY.Wugong[kfid]["武功类型"] < 6 and kfid > 0) or kfid == 93 then
                    wgmenu[#wgmenu + 1] = {kfid, wugongwl}
                    num1 = num1 + 1

                elseif JY.Wugong[kfid]["武功类型"] == 6 and kfid > 0 then
                    num = num + 1
                    ngmenu[#ngmenu + 1] = {kfid, wugongwl}
                end
            end
            local wgmenu1 = {}
            for i = 1, #wgmenu do
                wgmenu1[#wgmenu1 + 1] = wgmenu[i][2]
            end
            local key, max = 1, wgmenu1[1]
            for k, v in ipairs(wgmenu1) do
                if wgmenu1[k] > max then
                    key, max = k, v
                end
            end
            -- 外功 
            if JY.Person[pid]["优先使用"] == 0 then
                if num1 > 0 then
                    JY.Person[pid]["优先使用"] = wgmenu[key][1]
                    lib.Debug('无优先使用武功，增加优先使用武功' ..
                                  JY.Wugong[JY.Person[pid]["优先使用"]]['名称'])
                end
                if JY.Person[pid]["天赋外功1"] > 0 and PersonKF(pid, JY.Person[pid]["天赋外功1"]) then
                    JY.Person[pid]["优先使用"] = JY.Person[pid]["天赋外功1"]
                elseif JY.Person[pid]["天赋外功2"] > 0 and PersonKF(pid, JY.Person[pid]["天赋外功2"]) then
                    JY.Person[pid]["优先使用"] = JY.Person[pid]["天赋外功2"]
                end
            end

            -- 内功
            if num < 1 then
                if JY.Person[pid]["主运内功"] == 0 and JY.Person[pid]["畅想分阶"] > 5 and pid ~= 591 then
                    JY.Person[pid]["主运内功"] = 219
                end
                if JY.Person[pid]["主运内功"] == 0 and JY.Person[pid]["畅想分阶"] <= 5 and
                    JY.Person[pid]["畅想分阶"] > 2 then
                    local clone_choice = CC.NG1[math.random(#CC.NG1)]
                    JY.Person[pid]["主运内功"] = clone_choice
                end
                if JY.Person[pid]["主运内功"] == 0 and JY.Person[pid]["畅想分阶"] < 3 then
                    local clone_choice = CC.NG2[math.random(#CC.NG2)]
                    JY.Person[pid]["主运内功"] = clone_choice
                end
                if JY.Person[pid]["天赋内功"] > 0 then
                    JY.Person[pid]["主运内功"] = JY.Person[pid]["天赋内功"]
                end
            else
                local ngmenu1 = {}
                for i = 1, #ngmenu do
                    ngmenu1[#ngmenu1 + 1] = ngmenu[i][2]
                end
                local key, max = 1, ngmenu1[1]
                for k, v in ipairs(ngmenu1) do
                    if ngmenu1[k] > max then
                        key, max = k, v
                    end
                end
                JY.Person[pid]["主运内功"] = ngmenu[key][1]
            end
            if JY.Person[pid]["天赋内功"] > 0 and PersonKF(pid, JY.Person[pid]["天赋内功"]) then
                JY.Person[pid]["主运内功"] = JY.Person[pid]["天赋内功"]
            end
            -- 标记修改
            -- 轻功
            if JY.Person[pid]["主运轻功"] == 0 and JY.Person[pid]["畅想分阶"] <= 5 and
                JY.Person[pid]["畅想分阶"] > 2 then
                local clone_choice = CC.QG1[math.random(#CC.QG1)]
                JY.Person[pid]["主运轻功"] = clone_choice
            end
            if JY.Person[pid]["主运轻功"] == 0 and JY.Person[pid]["畅想分阶"] < 3 then
                local clone_choice = CC.QG2[math.random(#CC.QG2)]
                JY.Person[pid]["主运轻功"] = clone_choice
            end
            if JY.Person[pid]["天赋轻功"] > 0 then
                JY.Person[pid]["主运轻功"] = JY.Person[pid]["天赋轻功"]
            end
            lib.Debug("敌方：" .. JY.Person[pid]["姓名"] .. '优先使用武功' ..
                          JY.Wugong[JY.Person[pid]["优先使用"]]['名称'])
            -- lib.Debug("敌方："..JY.Person[pid]["姓名"].."(编号："..pid..")")
        end
        JY.Person[499]['优先使用'] = 49
        if WAR.ZDDH == 354 and WAR.Person[i]["我方"] then
            if JY.Person[pid]["天赋内功"] > 0 then
                JY.Person[pid]["主运内功"] = JY.Person[pid]["天赋内功"]
            end
            if JY.Person[pid]["天赋轻功"] > 0 then
                JY.Person[pid]["主运轻功"] = JY.Person[pid]["天赋轻功"]
            end
        end
    end
end

-- 无酒不欢：血量还原函数
function Health_in_Battle_Reset()

end

-- 战斗中查看敌方简易信息
function MapWatch()
    local x = WAR.Person[WAR.CurID]["坐标X"];
    local y = WAR.Person[WAR.CurID]["坐标Y"];
    WAR.ShowHead = 0
    War_CalMoveStep(WAR.CurID, 128, 1);
    Cat('实时特效动画')
    WarDrawMap(1, x, y);
    Cat('实时特效动画2')
    ShowScreen();
    lib.Delay(CC.BattleDelay + 1)
    x, y = War_SelectMove()
    if x == nil then
        return
    end
    WAR.ShowHead = 1
end

-- 无酒不欢：等待指令
function War_Wait()
    local id = WAR.Person[WAR.CurID]["人物编号"]
    WAR.Wait[id] = 1
    Cls()
    CurIDTXDH(WAR.CurID, 72, 1, "伺机待发", LightGreen, 15)
    -- 仙剑神猿等待时蓄力
    if match_ID(id, 185) or match_ID(id, 575) then
        WAR.Actup[id] = 2
    end
    return 1
end

-- 集中指令
function War_Focus()
    local id = WAR.Person[WAR.CurID]["人物编号"]
    WAR.PD["集中状态"][id] = 2
    Cls()
    CurIDTXDH(WAR.CurID, 151, 1, "心念合一", C_GOLD)
    return 1
end

-- 无酒不欢：撤退
function War_Retreat()
    local id = WAR.Person[WAR.CurID]["人物编号"]
    local r = LGMsgBox(JY.Person[id]["姓名"], "确定要我撤退吗？", {"否", "是"}, 2, id)
    if r == 2 then
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]["我方"] then
                JY.Person[WAR.Person[i]['人物编号']]['生命'] = 0
                WAR.Person[i]["死亡"] = true
            end
        end
        return 1;
    end
end

-- 无酒不欢：常态血条显示
function HP_Display_When_Idle()
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
    for k = 0, WAR.PersonNum - 1 do
        local tmppid = WAR.Person[k]["人物编号"]
        if WAR.Person[k]["死亡"] == false then
            local dx = WAR.Person[k]["坐标X"] - x0
            local dy = WAR.Person[k]["坐标Y"] - y0

            local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
            local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2

            local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
            ry = ry - hb - CC.YScale * 7

            local pid = WAR.Person[k]["人物编号"]

            local Color = RGB(238, 44, 44)
            -- local Color1 = RGB(30, 144, 255)

            local HP_MAX = JY.Person[pid]["生命最大值"]
            local MP_MAX = JY.Person[pid]["内力最大值"]
            local PH_MAX = 100

            local Current_HP = limitX(JY.Person[pid]["生命"], 0, HP_MAX)
            local Current_MP = limitX(JY.Person[pid]["内力"], 0, MP_MAX)
            local Current_PH = limitX(WAR.LQZ[pid] or 0, 0, PH_MAX)
            -- 友军NPC显示为绿色血条
            if WAR.Person[k]["我方"] == true then
                Color = RGB(0, 238, 0)
            end
            local HD = WAR.PD['护盾值'][pid] 
            -- DrawString(rx-CC.XScale*7/3+CC.XScale/11, ry-CC.YScale*8/3,Person_JQ(pid),Color,CC.DefaultFont*0.6)
            --集气速度
            if WAR.JQSDXS[pid] ~= nil then
                DrawString(rx - CC.XScale * 7 / 3 + CC.XScale / 11, ry - CC.YScale * 8 / 3, WAR.JQSDXS[pid], Color,CC.FontSMALL) -- 集气速度
            end

            -- 生命
            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx + CC.XScale * 1.4, ry - CC.YScale * 30 / 17, C_GRAY22) -- 背景
            if HP_MAX > 0 then
                lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx - CC.XScale * 1.4 + (Current_HP / HP_MAX) * (2.8 * CC.XScale), ry - CC.YScale * 30 / 17, Color) 
            end
            -- 护盾
            if HD~= nil and HD > 0 then
                lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx - CC.XScale * 1.4 + (HD / 5000) * (2.8 * CC.XScale), ry - CC.YScale * 30 / 17, C_ORANGE)
            end
            DrawBox3(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx + CC.XScale * 1.4, ry - CC.YScale * 30 / 17, C_BLACK)

            --内力
            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 11 + 0.5, rx + CC.XScale * 1.4, ry - CC.YScale * 30 / 21, C_GRAY22) -- 背景			
            if MP_MAX > 0 then
                lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 11 + 0.5, rx - CC.XScale * 1.4 + (Current_MP / MP_MAX) * (2.8 * CC.XScale), ry - CC.YScale * 30 / 21, C_BLUE) -- 内力
            end
            DrawBox3(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 11 + 0.5, rx + CC.XScale * 1.4, ry - CC.YScale * 30 / 21, C_BLACK)

            --怒气
            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 13 + 1, rx + CC.XScale * 1.4, ry - CC.YScale * 60 / 54 + 1, C_GRAY22) -- 背景
            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 13 + 1, rx - CC.XScale * 1.4 + (Current_PH / PH_MAX) * (2.8 * CC.XScale), ry - CC.YScale * 60 / 54 + 1, S_Yellow) -- 怒气
            DrawBox3(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 13 + 1, rx + CC.XScale * 1.4, ry - CC.YScale * 60 / 54 + 1, C_BLACK)
        end
    end
end

-- 无酒不欢：挨打掉血显示
function HP_Display_When_Hit(ssxx)
    local x0 = WAR.Person[WAR.CurID]["坐标X"];
    local y0 = WAR.Person[WAR.CurID]["坐标Y"];
    -- 掉血渐变显示			
    ssxx = ssxx - 4
    for k = 0, WAR.PersonNum - 1 do
        local tmppid = WAR.Person[k]["人物编号"]
        -- 血量有变化才显示
        if WAR.Person[k]["死亡"] == false and WAR.Person[k]["生命点数"] ~= nil and WAR.Person[k]["生命点数"] ~=
            0 then
            local dx = WAR.Person[k]["坐标X"] - x0
            local dy = WAR.Person[k]["坐标Y"] - y0

            local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
            local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2

            local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)
            ry = ry - hb - CC.YScale * 7

            local pid = WAR.Person[k]["人物编号"]

            local Color = RGB(238, 44, 44)
            -- local Color1 = RGB(30, 144, 255)
            -- 计算掉血
            local HP_MAX = JY.Person[pid]["生命最大值"]
            local HP_AfterHit = JY.Person[pid]["生命"]
            if HP_AfterHit < 0 then
                HP_AfterHit = 0
            end
            local HP_BeforeHit = WAR.Person[k]["Life_Before_Hit"] or 0
            local HP_Loss = HP_BeforeHit - HP_AfterHit
            local Gradual_HP_Loss;
            local Gradual_HP_Display;
            Gradual_HP_Loss = HP_Loss * (ssxx / 11)
            Gradual_HP_Display = HP_BeforeHit - Gradual_HP_Loss

            local HD_AfterHit = WAR.PD['护盾值'][pid] or 0
            if HD_AfterHit < 0 then 
                HD_AfterHit = 0 
            end
            local HD = WAR.PD['护盾值'][pid] or 0 
            local HD_BeforeHit = WAR.Person[k]["HD_Before_Hit"] or 0
            local HD_Loss = HD_BeforeHit - HD_AfterHit
            local Gradual_HD_Loss;
            local Gradual_HD_Display;
            Gradual_HD_Loss = HD_Loss * (ssxx / 11)
            Gradual_HD_Display = HD_BeforeHit - Gradual_HD_Loss

            -- 友军NPC显示为绿色血条
            if WAR.Person[k]["我方"] == true then
                Color = RGB(0, 238, 0)
            end

            
            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx + CC.XScale * 1.4, ry - CC.YScale * 15 / 9, grey21) -- 背景

            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx - CC.XScale * 1.4 + (HP_AfterHit / HP_MAX) * (2.8 * CC.XScale), ry - CC.YScale * 15 / 9, Color) -- 生命

            lib.FillColor(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx - CC.XScale * 1.4 + (HD_AfterHit / 5000) * (2.8 * CC.XScale), ry - CC.YScale * 30 / 17, C_ORANGE)
            if HD_Loss > 0 then
                lib.FillColor(rx - CC.XScale * 1.4 + (HD_AfterHit / HP_MAX) * (2.8 * CC.XScale),
                    ry - CC.YScale * 20 / 9, rx - CC.XScale * 1.4 + (Gradual_HD_Display / 5000) * (2.8 * CC.XScale),
                    ry - CC.YScale * 15 / 9, Color) -- 失去护盾
            end            

            -- 掉血显示
            if HP_Loss > 0 then
                lib.FillColor(rx - CC.XScale * 1.4 + (HP_AfterHit / HP_MAX) * (2.8 * CC.XScale),
                    ry - CC.YScale * 20 / 9, rx - CC.XScale * 1.4 + (Gradual_HP_Display / HP_MAX) * (2.8 * CC.XScale),
                    ry - CC.YScale * 15 / 9, Color) -- 失去生命
            end
            DrawBox3(rx - CC.XScale * 1.4, ry - CC.YScale * 20 / 9, rx + CC.XScale * 1.4, ry - CC.YScale * 15 / 9, C_BLACK)
        end
    end
end

-- 苍天泰坦：被战场显血函数调用
function DrawBox3(x1, y1, x2, y2, color)
    lib.DrawRect(x1, y1, x2, y1, color)
    lib.DrawRect(x1, y2, x2, y2, color)
    lib.DrawRect(x1, y1, x1, y2, color)
    lib.DrawRect(x2, y1, x2, y2, color)
    -- 无酒不欢：生命和内力的分隔线
    -- lib.DrawRect(x1, y1+(y2-y1)/2+1, x2, y1+(y2-y1)/2+1, color)
end

-- 显示出招动画的选择出战人物界面
function WarSelectTeam_Enhance()
    if JY.Restart == 1 then
        do
            return
        end
    end
    local T_Num = GetTeamNum();
    local bx = CC.WX
    local by = CC.HY
    local zuobiao = {10, 512}
    local tb, tb1, tb2 = 1, 0, 1
    local lieshu = 9
    local pg = 0
    local jg = 20
    local Tmenu = {}
    local cl = C_CYGOLD
    local size = CC.DefaultFont
    local pid = 0
    local id = 0
    local TB = 0
    local ZDmenu = {{626, 104}, {410, 33}, {872, 33}, {410, 228}, {872, 228}, {636, 278}}
    local czmenu = {}
    local czmenu1 = {}
    local czmenu2 = {}
    local p = {}
    local t_num = 0
    local pd = 0
    local lb = 0
    local wz = {"选择阵法", "全部选择", "开始战斗"}
    local x2, y2 = 460, 466
    local x3, y3 = 453, 466
    -- local ZHEN = {"真武七截阵","十八罗汉阵","天罡北斗阵","九宫八卦阵","五行光明阵","两仪剑阵","打狗大阵"}
    local zf = 0
    local zfpd = {}
    local zfmenu = {}
    local zfture = 0
    for i = 1, CC.TeamNum do
        if JY.Base['队伍' .. i] >= 0 then
            local n = 0;
            local m = 0;
            for j = 1, 5 do
                if JY.Person[JY.Base['队伍' .. i]]['出招动画帧数' .. j] > 0 then
                    if j > 1 then
                        m = j;
                        break
                    end
                    n = n + JY.Person[JY.Base['队伍' .. i]]['出招动画帧数' .. j]
                end
            end
            p[i] = {
                id = JY.Base['队伍' .. i],
                zid = JY.Person[JY.Base['队伍' .. i]]["头像代号"],
                Pic = n * 8 + JY.Person[JY.Base['队伍' .. i]]['出招动画帧数' .. m] * 6,
                PicNum = JY.Person[JY.Base['队伍' .. i]]['出招动画帧数' .. m],
                idx = 0,
                picked = 0
            };
            Tmenu[i] = {JY.Person[JY.Base['队伍' .. i]]['姓名'], JY.Base['队伍' .. i], 1, i} -- 1名字，2人物id,3是否参战，4站向，5动画帧数					
        end
    end
    local pnum = {}
    if WAR.ZDDH == 354 then
        local x = 20
        local y = 17
        for i = 1, #CC.HSLJ do
            local id = CC.HSLJ[i]
            WAR.Person[WAR.PersonNum]["人物编号"] = id
            WAR.Person[WAR.PersonNum]["我方"] = true
            WAR.Person[WAR.PersonNum]["坐标X"] = x
            WAR.Person[WAR.PersonNum]["坐标Y"] = y
            WAR.Person[WAR.PersonNum]["死亡"] = false
            WAR.Person[WAR.PersonNum]["人方向"] = 3
            WAR.PersonNum = WAR.PersonNum + 1
            x = x + 1
            if x == 34 then
                x = 20
                y = y + 2
            end
        end
        return
    end

    if JY.Base["单通"] == -1 then
        -- 手动清除人物
        for i = 1, 6 do
            WAR.Data["手动选择参战人" .. i] = -1
        end
        for i = 1, 6 do
            if WAR.Data["自动选择参战人" .. i] >= 0 then
                local mid = WAR.Data["自动选择参战人" .. i]
                if mid == JY.Base["畅想"] then
                    mid = 0
                end
                if inteam(mid) then
                    WAR.Data["手动选择参战人" .. i] = mid
                    WAR.Data["自动选择参战人" .. i] = -1
                else
                    WAR.MCRS = WAR.MCRS + 1
                end
            end
        end
    elseif JY.Base["单通"] > 0 then
        WAR.Data["自动选择参战人1"] = 0
        for i = 2, 6 do
            WAR.Data["自动选择参战人" .. i] = -1
        end
    end

    -- 剪裁的背景图
    -- 没有自动选择出战人时??显示
    -- 单挑陈达海战特殊判定
    if WAR.Data["自动选择参战人1"] == -1 and not (WAR.ZDDH == 92 and GetS(87, 31, 33, 5) == 1) then

    end
    for i = 1, T_Num do
        local pid = JY.Base["队伍" .. i];
        if pid < 0 then
            break
        end
        if JY.Base["单通"] > 0 then
            -- 冰糖恋：单挑陈达海
            if WAR.ZDDH == 92 and GetS(87, 31, 33, 5) == 1 then
                WAR.Data["自动选择参战人1"] = 0;
                WAR.Data["我方X1"] = 33
                WAR.Data["我方Y1"] = 24
            end

            -- 畅想杨过绝情谷两战
            if (WAR.ZDDH == 272 or WAR.ZDDH == 273) and JY.Base["畅想"] == 58 then
                WAR.Data["自动选择参战人2"] = 59
            end

        end
        -- 战三渡，如果周芷若在队则周芷若必出战
        if WAR.ZDDH == 253 and inteam(631) then
            WAR.Data["手动选择参战人2"] = 631
        end
        for i = 1, 6 do
            local id = WAR.Data["自动选择参战人" .. i]
            if id >= 0 then
                -- 畅想的情况，畅想主角会取代强制出战的队友
                if id == JY.Base["畅想"] then
                    WAR.Person[WAR.PersonNum]["人物编号"] = 0
                else
                    WAR.Person[WAR.PersonNum]["人物编号"] = id
                end
                WAR.Person[WAR.PersonNum]["我方"] = true
                WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
                WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
                WAR.Person[WAR.PersonNum]["死亡"] = false
                WAR.Person[WAR.PersonNum]["人方向"] = 2
                -- 无酒不欢：调整战斗初始面向
                -- 战海大富
                if WAR.ZDDH == 259 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 1
                end
                -- 双挑公孙止
                if WAR.ZDDH == 273 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 1
                end
                -- 杨过单金轮
                if WAR.ZDDH == 275 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                -- 战杨龙
                if WAR.ZDDH == 75 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                -- 蒙哥
                if WAR.ZDDH == 278 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                -- 周芷若夺掌门
                if WAR.ZDDH == 279 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                -- 单挑赵敏
                if WAR.ZDDH == 293 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                -- 玄冥二老
                if WAR.ZDDH == 295 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                -- 三挑岳不群
                if WAR.ZDDH == 298 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 1
                end
                -- 侠客邪
                if WAR.ZDDH == 170 then
                    WAR.Person[WAR.PersonNum]["人方向"] = 0
                end
                WAR.PersonNum = WAR.PersonNum + 1
                WAR.MCRS = WAR.MCRS + 1
            end
        end

        if WAR.PersonNum > 0 and WAR.ZDDH ~= 235 then
            return
        end
    end
    if JY.Base["单通"] > 0 then
        -- 战三渡
        if WAR.ZDDH == 253 then
            WAR.MCRS = WAR.MCRS + 3
        end

        -- 逍遥御风 天池怪侠 太白诗仙 古墓黄杉 金蛇郎君
        -- 限定1人
        if WAR.ZDDH == 281 or WAR.ZDDH == 283 or WAR.ZDDH == 284 or WAR.ZDDH == 285 or WAR.ZDDH == 286 then
            WAR.MCRS = WAR.MCRS + 5
        end

        -- 刀剑合璧
        -- 限定2人
        if WAR.ZDDH == 280 then
            WAR.MCRS = WAR.MCRS + 4
        end
    end
    -- 无酒不欢：强制出战的队友
    for j = 1, 6 do
        for i = 1, #Tmenu do
            if WAR.Data["手动选择参战人" .. j] == p[i].id then
                -- p[i].picked = 1
                p[i].picked = 1
                WAR.MCRS = WAR.MCRS + 1
                t_num = t_num + 1
                czmenu1[#czmenu1 + 1] = {p[i].id, p[i].zid, p[i].Pic, p[i].idx, p[i].PicNum, p[i].picked, 1}
            end
        end
        break
    end
    for j = 1, 6 do
        for i = 1, #Tmenu do
            if WAR.Data["自动选择参战人" .. j] == p[i].id then
                -- p[i].picked = 1
                p[i].picked = 2
                WAR.MCRS = WAR.MCRS + 1
                t_num = t_num + 1
                czmenu1[#czmenu1 + 1] = {p[i].id, p[i].zid, p[i].Pic, p[i].idx, p[i].PicNum, p[i].picked, 1}
            end
        end
        break
    end
    local x1, y1 = lib.GetPNGXY(91, 149 * 2)
    while true do
        Cls()
        if JY.Restart == 1 then
            break
        end
        -- local i = 0
        lib.Background(0, CC.ScreenH / 2 + by * 150, CC.ScreenW, CC.ScreenH / 2 + by * 350, 98)

        lib.LoadPNG(91, 149 * 2, CC.ScreenW / 2 - x1 / 2, CC.ScreenH / 38.4, 1)
        local wz2 = "参战人员"
        lib.LoadPNG(91, 140 * 2, x2 + size * 4, y2 - size * 14, 1, 0, 120)
        lib.DrawStr(x2 + size * 6 - string.len(wz2) / 4 * size, y2 - size * 14, wz2, C_WHITE, size * 1.3,CONFIG.CurrentPath .. "FONT/2.TTF", 0, 0)
        if lieshu > #Tmenu then
            lieshu = #Tmenu
        end
        for ai = 1, lieshu do
            pid = Tmenu[ai + pg][2]
            local tw = 0
            if CC.Png[JY.Person[pid]['半身像']] ~= nil then
                tw = CC.Png[JY.Person[pid]['半身像']]
            end
            local cl1 = C_CYGOLD
            if tb == ai then
                cl1 = C_RED
                id = ai + pg
            end
            DrawString(bx * zuobiao[1] + bx * 62 - string.len(Tmenu[ai + pg][1]) / 4 * size + (ai - 1) * bx * 152,
                by * zuobiao[2] + by * 150, Tmenu[ai + pg][1], cl1, size)
            local headid = JY.Person[pid]["半身像"]
            lib.PicLoadCache(92, 116 * 2, bx * zuobiao[1] + (ai - 1) * bx * 152, by * zuobiao[2], 1)
            lib.LoadPNG(1, headid * 2, bx * zuobiao[1] + (ai - 1) * bx * 152, by * zuobiao[2], 1)
            lib.PicLoadCache(92, 117 * 2, bx * zuobiao[1] + (ai - 1) * bx * 152, by * zuobiao[2], 1)
            if p[ai + pg].picked == 1 then
                lib.LoadPNG(91, 126 * 2, bx * zuobiao[1] + (ai - 1) * bx * 152 + bx * 80, by * zuobiao[2] + by * 100, 1, 0, 50)
            end
            if tb == ai then
                lib.LoadPNG(91, 36 * 2, bx * zuobiao[1] + (ai - 1) * bx * 152 - bx * 8, by * zuobiao[2], 1, 0, 72)
            end
        end
        -- 出战人员	
        for i = 1, t_num do
            if czmenu1[i][1] >= 0 and czmenu1[i][7] == 1 then
                local xx, yy = -bx * 60, by * 50
                lib.LoadPNG(91, 142 * 2, bx * ZDmenu[i][1] + xx, by * ZDmenu[i][2] + yy, 1)
                lib.LoadPNG(1, JY.Person[czmenu1[i][1]]["半身像"] * 2, bx * ZDmenu[i][1], by * ZDmenu[i][2], 1)
                DrawString(
                    bx * ZDmenu[i][1] + xx + size * 3 - string.len(JY.Person[czmenu1[i][1]]["姓名"]) / 4 * size,
                    by * ZDmenu[i][2] + yy + size * 3, JY.Person[czmenu1[i][1]]["姓名"], C_WHITE, size * 0.9)
                if p[tb + pg].id == czmenu1[i][1] then
                    lib.PicLoadCache(czmenu1[i][2] + 101, czmenu1[i][3] + czmenu1[i][4] * 2, bx * ZDmenu[i][1],
                        by * ZDmenu[i][2] + yy * 2, 1, 0, 0, -1, -1, 0, 0, 100)
                    czmenu1[i][4] = czmenu1[i][4] + 1;
                    if czmenu1[i][4] >= czmenu1[i][5] then
                        czmenu1[i][4] = 0;
                    end
                end
            end
        end
        -- 出战选择
        for i = 1, 3 do
            local cl = C_WHITE
            if tb1 == i then
                cl = C_RED
            end
            lib.LoadPNG(91, 140 * 2, x2 + (i - 1) * size * 4.5, y2, 1)
            lib.DrawStr(x2 + size * 2.5 + (i - 1) * size * 4.5 - string.len(wz[i]) / 4 * size, y2 + size / 3, wz[i], cl,size * 0.8, CONFIG.CurrentPath .. "FONT/2.TTF", 0, 0)
        end
        -- 阵法选择
        for i = 1, #ZHEN do
            zfmenu[i] = {ZHEN[i], 0, -1, -1}
        end
        local zmenu = {}
        if zf == 1 then
            lib.LoadPNG(91, 222 * 2, x3 - size * 9, y3 - size * 11, 1)
            for j = 1, #czmenu1 do
                if czmenu1[j][1] >= 0 then
                    local id = czmenu1[j][1]
                    for w = 1, 10 do
                        if JY.Person[id]['秘技' .. w] > 0 then
                            local tid = JY.Person[id]['秘技' .. w]
                            zmenu[#zmenu + 1] = {id, tid}
                        end
                    end
                end
            end
            for i = 1, #ZHEN do
                local cl = M_DimGray
                for w = 1, #zmenu do
                    if JY.Teji[zmenu[w][2]]['名称'] == ZHEN[i] then
                        cl = C_WHITE
                        zfmenu[i][2] = 1 -- 参战阵法
                        zfmenu[i][3] = zmenu[w][1] -- 阵法拥有者
                        zfmenu[i][4] = zmenu[w][2] -- 阵法ID 
                        lib.Debug('拥有人' .. JY.Person[zfmenu[i][3]]['姓名'] .. '  ' .. zfmenu[i][4])
                        break
                    end
                end
                if tb2 == i then
                    if cl == C_WHITE then
                        cl = C_RED
                    else
                        cl = M_DarkGreen
                    end
                end
                DrawString(x3 - size * 5.5 - string.len(ZHEN[i]) / 4 * size + bx * 1,
                    y3 - size * 10 + (i - 1) * size + by * 1, ZHEN[i], M_DimGray, size * 0.8)
                DrawString(x3 - size * 5.5 - string.len(ZHEN[i]) / 4 * size, y3 - size * 10 + (i - 1) * size, ZHEN[i],
                    cl, size * 0.8)
            end
            if zfpd == 1 then
                lib.LoadPNG(91, 129 * 2, x3 - size * 3.9, y3 - size * 9.7 + (CC.TX['我方阵法'] - 1) * size, 1)
            end
        end
        if zfpd == 1 then
            local x = CC.ScreenW / 2;
            local y = CC.ScreenH / 2;
            lib.Background(x - x / 2.1, y, x + x / 2.1, y + y / 4.5, 98)
            lib.DrawStr(x3 - size * 3, y3 - size * 2.2, ZHEN[CC.TX['我方阵法']], C_RED, size * 2,CONFIG.CurrentPath .. "FONT/2.TTF", 0, 0)
            local zfname = {94, 95, 96, 97, 98, 99, 100}
            for i = zfname[1], zfname[#zfname] do
                if ZHEN[CC.TX['我方阵法']] == CC.ZTSM[i][1] then
                    tjm(x3 + size * 7, y3 - size * 2.2, CC.ZTSM[i][2], C_WHITE, size * 0.73, 12, size * 0.8)
                end
            end
        end
        ShowScreen()
        lib.Delay(100)
        local X, ktype, mx, my = lib.GetKey()
        if X == VK_ESCAPE or ktype == 4 then
            if zf == 1 then
                zf = 0
            end
        elseif X == VK_SPACE or X == VK_RETURN then
            if zf == 1 then
                for i = 1, #zfmenu do
                    if zfmenu[i][2] == 1 and tb2 == i then
                        zfpd = 1
                        CC.TX['我方阵法'] = tb2
                        zfmenu[i][2] = 2
                    else
                    end
                end
            elseif lb == 1 then
                if tb1 == 1 then
                    zf = 1
                    tb2 = 1
                elseif tb1 == 2 then
                    if t_num == 0 then
                        local tnum = 6
                        if T_Num < 6 then
                            tnum = T_Num
                        end
                        for i = 1, tnum do
                            if p[i].picked == 0 then
                                wz[2] = "全部取消"
                                p[i].picked = 1
                                t_num = tnum
                                czmenu1[i] = {p[i].id, p[i].zid, p[i].Pic, p[i].idx, p[i].PicNum, p[i].picked, 1} -- 人物ID，人物头象，人物动画，人物动画帧数，选定判定，是否参战
                            end
                        end
                    elseif t_num == 6 and pd == 0 then
                        for i = 1, #Tmenu do
                            if p[i].picked == 1 then
                                p[i].picked = 0
                                czmenu1[#czmenu1 + 1] = {p[i].id, p[i].zid, p[i].Pic, p[i].idx, p[i].PicNum, p[i].picked, 1}
                            end
                        end
                        for i = 1, t_num do
                            wz[2] = "全部选择"
                            t_num = 0
                            table.remove(czmenu1, i)
                        end
                    end
                elseif tb1 == 3 then
                    for i = 1, #czmenu1 do
                        if czmenu1[i][1] >= 0 then
                            WAR.Person[WAR.PersonNum]["人物编号"] = czmenu1[i][1]
                            WAR.Person[WAR.PersonNum]["我方"] = true
                            WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
                            WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
                            WAR.Person[WAR.PersonNum]["死亡"] = false
                            WAR.Person[WAR.PersonNum]["人方向"] = 2
                            -- 无酒不欢：调整战斗初始面向
                            -- 战海大富
                            if WAR.ZDDH == 259 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 1
                            end
                            -- 双挑公孙止
                            if WAR.ZDDH == 273 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 1
                            end
                            -- 杨过单金轮
                            if WAR.ZDDH == 275 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 战杨龙
                            if WAR.ZDDH == 75 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 蒙哥
                            if WAR.ZDDH == 278 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 周芷若夺掌门
                            if WAR.ZDDH == 279 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 单挑赵敏
                            if WAR.ZDDH == 293 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 无聊单挑葵花
                            if WAR.ZDDH == 355 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 玄冥二老
                            if WAR.ZDDH == 295 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 三挑岳不群
                            if WAR.ZDDH == 298 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 1
                            end
                            -- 侠客邪
                            if WAR.ZDDH == 170 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            WAR.PersonNum = WAR.PersonNum + 1
                        end
                    end
                    if JY.Base["单通"] == -1 then
                        for i = 1, 6 do
                            if WAR.Data["自动选择参战人" .. i] >= 0 then
                                WAR.Person[WAR.PersonNum]["人物编号"] = WAR.Data["自动选择参战人" .. i]
                                WAR.Person[WAR.PersonNum]["我方"] = true
                                WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
                                WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
                                WAR.Person[WAR.PersonNum]["死亡"] = false
                                WAR.Person[WAR.PersonNum]["人方向"] = 2
                                WAR.PersonNum = WAR.PersonNum + 1
                            end
                        end
                    end
                    for i = 1, #czmenu1 do
                        if czmenu1[i][7] == 1 then
                            return 0
                        end
                    end
                end
            else
                local n = 0
                local cot = tb + pg
                if p[cot].picked == 0 then
                    if t_num <= 6 then -- 如果没满员
                        if t_num == 0 then
                            p[cot].picked = 1 -- 参战
                            t_num = t_num + 1
                            if t_num > 6 - WAR.MCRS then
                                t_num = 6
                            end
                            czmenu1[t_num] = {p[cot].id, p[cot].zid, p[cot].Pic, p[cot].idx, p[cot].PicNum,
                                              p[cot].picked, 1} -- 增加参战人员
                        else
                            if pd > 0 then -- 判定是否有空位
                                for i = 1, t_num do
                                    if czmenu1[i][7] == 2 then -- 判断表中空位的位置
                                        p[cot].picked = 1 -- 参战
                                        pd = pd - 1 -- 空位减1
                                        czmenu1[i] = {p[cot].id, p[cot].zid, p[cot].Pic, p[cot].idx, p[cot].PicNum,
                                                      p[cot].picked, 1} -- 插入参战人员
                                        break
                                    end
                                end
                            else
                                if t_num < 6 then -- 没满员
                                    p[cot].picked = 1 -- 出战
                                    t_num = t_num + 1
                                    if t_num > 6 then
                                        t_num = 6
                                    end
                                    czmenu1[t_num] = {p[cot].id, p[cot].zid, p[cot].Pic, p[cot].idx, p[cot].PicNum,
                                                      p[cot].picked, 1} -- 参加参战人员
                                    if t_num == 6 then
                                        wz[2] = "全部取消"
                                    end
                                end
                            end
                        end
                    end
                elseif p[cot].picked == 1 then -- 已经出战
                    if t_num > 1 then
                        for i = 1, t_num do
                            if p[cot].id == czmenu1[i][1] then
                                lib.Debug("移除" .. i .. " 号参战人员 " .. Tmenu[cot][1])
                                p[cot].picked = 0 -- 不出战
                                czmenu1[i] = {-1, -1, 0, 0, 0, 0, 2} -- 移除参战人员
                                pd = pd + 1
                                zfture = 0
                                -- zfmenu[tb2][2] = 0
                                tb2 = 0
                                CC.TX['我方阵法'] = 0
                                zfpd = 0
                            end
                        end
                    end
                end
            end
        elseif X == VK_RIGHT then
            if lb == 0 then
                tb = tb + 1
                if tb > lieshu then
                    pg = pg + 1
                    tb = lieshu
                end
                if tb + pg > #Tmenu then
                    tb = 1
                    pg = 0
                end
            else
                tb1 = tb1 + 1
                if tb1 > 3 then
                    tb1 = 1
                end
            end
            -- say(tb,1,1)
        elseif X == VK_LEFT then
            if lb == 0 then
                if pg > 0 then
                    if tb > 1 then
                        tb = tb - 1
                    else
                        pg = pg - 1
                    end
                else
                    tb = tb - 1
                    if tb < 1 then
                        tb = lieshu
                    end
                end
            else
                tb1 = tb1 - 1
                if tb1 < 1 then
                    tb1 = 3
                end
            end
        elseif X == VK_UP then
            if zf == 1 then
                tb2 = tb2 - 1
                if tb2 < 1 then
                    tb2 = #ZHEN
                end
            else
                if lb == 0 then
                    lb = 1
                    tb1 = 1
                end
            end
        elseif X == VK_DOWN then
            if zf == 1 then
                tb2 = tb2 + 1
                if tb2 > #ZHEN then
                    tb2 = 1
                end
            else
                if lb == 1 then
                    lb = 0
                    tb1 = 0
                end
            end
        elseif ktype == 6 then
            if zf == 0 then
                pg = pg - lieshu
                tb = 1
                if pg < 0 then
                    pg = 0
                end
            end
        elseif ktype == 7 then
            if zf == 0 then
                pg = pg + lieshu
                if pg + lieshu > #Tmenu then
                    pg = #Tmenu - lieshu
                    tb = 1
                end
            end
        else
            local mxx = false
            for j = 1, lieshu do
                if mx > bx * 10 + (j - 1) * bx * 152 and mx < bx * 152 + (j - 1) * bx * 152 and my > by * 510 and my <
                    by * 700 and zf == 0 then
                    lb = 0
                    tb1 = 0
                    tb = j
                    mxx = true
                    break
                end
            end
            if mxx == true and ktype == 3 then
                local n = 0
                local cot = tb + pg
                local n = 0
                local cot = tb + pg
                if p[cot].picked == 0 then
                    if t_num <= 6 then -- 如果没满员
                        if t_num == 0 then
                            p[cot].picked = 1 -- 参战
                            t_num = t_num + 1
                            if t_num > 6 then
                                t_num = 6
                            end
                            czmenu1[t_num] = {p[cot].id, p[cot].zid, p[cot].Pic, p[cot].idx, p[cot].PicNum, p[cot].picked, 1} -- 增加参战人员
                        else
                            if pd > 0 then -- 判定是否有空位
                                for i = 1, t_num do
                                    if czmenu1[i][7] == 2 then -- 判断表中空位的位置
                                        p[cot].picked = 1 -- 参战
                                        pd = pd - 1 -- 空位减1
                                        czmenu1[i] = {p[cot].id, p[cot].zid, p[cot].Pic, p[cot].idx, p[cot].PicNum, p[cot].picked, 1} -- 插入参战人员
                                        break
                                    end
                                end
                            else
                                if t_num < 6 then -- 没满员
                                    p[cot].picked = 1 -- 出战
                                    t_num = t_num + 1
                                    if t_num > 6 then
                                        t_num = 6
                                    end
                                    czmenu1[t_num] = {p[cot].id, p[cot].zid, p[cot].Pic, p[cot].idx, p[cot].PicNum,  p[cot].picked, 1} -- 参加参战人员
                                    if t_num == 6 then
                                        wz[2] = "全部取消"
                                    end
                                end
                            end
                        end
                    end
                elseif p[cot].picked == 1 then -- 已经出战
                    lib.Debug('取消判定0')
                    if t_num > 1 then
                        lib.Debug('取消判定0-1')
                        for i = 1, t_num do
                            if p[cot].id == czmenu1[i][1] then
                                p[cot].picked = 0 -- 不出战
                                czmenu1[i] = {-1, -1, 0, 0, 0, 0, 2} -- 移除参战人员
                                pd = pd + 1
                                zfture = 0
                                -- zfmenu[tb2][2] = 0
                                tb2 = 0
                                CC.TX['我方阵法'] = 0
                                zfpd = 0
                            end
                        end
                    end
                end
            end
            for i = 1, 3 do
                if mx > x2 + (i - 1) * size * 4.5 and mx < x2 + (i - 1) * size * 4.5 + 150 * i and my > y2 and my < y2 +
                    by * 40 and zf == 0 then
                    mxx = true
                    tb1 = i
                    lb = 1
                end
            end
            if mxx == true and ktype == 3 then
                if tb1 == 1 then
                    zf = 1
                    tb2 = 1
                elseif tb1 == 2 then
                    if t_num == 0 then
                        local tnum = 6
                        if T_Num < 6 then
                            tnum = T_Num
                        end
                        for i = 1, tnum do
                            if p[i].picked == 0 then
                                wz[2] = "全部取消"
                                p[i].picked = 1
                                t_num = tnum
                                czmenu1[i] = {p[i].id, p[i].zid, p[i].Pic, p[i].idx, p[i].PicNum, p[i].picked, 1}
                            end
                        end
                    elseif t_num == 6 and pd == 0 then
                        for i = 1, #Tmenu do
                            if p[i].picked == 1 then
                                p[i].picked = 0
                                czmenu1[#czmenu1 + 1] = {p[i].id, p[i].zid, p[i].Pic, p[i].idx, p[i].PicNum,  p[i].picked, 1}
                            end
                        end
                        for i = 1, t_num do
                            wz[2] = "全部选择"
                            t_num = 0
                            table.remove(czmenu1, i)
                        end
                    end
                elseif tb1 == 3 then
                    for i = 1, #czmenu1 do
                        if czmenu1[i][1] >= 0 then
                            WAR.Person[WAR.PersonNum]["人物编号"] = czmenu1[i][1]
                            WAR.Person[WAR.PersonNum]["我方"] = true
                            WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
                            WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
                            WAR.Person[WAR.PersonNum]["死亡"] = false
                            WAR.Person[WAR.PersonNum]["人方向"] = 2
                            -- 无酒不欢：调整战斗初始面向
                            -- 战海大富
                            if WAR.ZDDH == 259 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 1
                            end
                            -- 双挑公孙止
                            if WAR.ZDDH == 273 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 1
                            end
                            -- 杨过单金轮
                            if WAR.ZDDH == 275 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 战杨龙
                            if WAR.ZDDH == 75 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 蒙哥
                            if WAR.ZDDH == 278 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 周芷若夺掌门
                            if WAR.ZDDH == 279 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 单挑赵敏
                            if WAR.ZDDH == 293 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 无聊单挑葵花
                            if WAR.ZDDH == 355 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 玄冥二老
                            if WAR.ZDDH == 295 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            -- 三挑岳不群
                            if WAR.ZDDH == 298 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 1
                            end
                            -- 侠客邪
                            if WAR.ZDDH == 170 then
                                WAR.Person[WAR.PersonNum]["人方向"] = 0
                            end
                            WAR.PersonNum = WAR.PersonNum + 1
                        end
                    end
                    if JY.Base["单通"] == -1 then
                        for i = 1, 6 do
                            if WAR.Data["自动选择参战人" .. i] >= 0 then
                                WAR.Person[WAR.PersonNum]["人物编号"] = WAR.Data["自动选择参战人" .. i]
                                WAR.Person[WAR.PersonNum]["我方"] = true
                                WAR.Person[WAR.PersonNum]["坐标X"] = WAR.Data["我方X" .. i]
                                WAR.Person[WAR.PersonNum]["坐标Y"] = WAR.Data["我方Y" .. i]
                                WAR.Person[WAR.PersonNum]["死亡"] = false
                                WAR.Person[WAR.PersonNum]["人方向"] = 2
                                WAR.PersonNum = WAR.PersonNum + 1
                            end
                        end
                    end
                    for i = 1, #czmenu1 do
                        if czmenu1[i][7] == 1 then
                            return 0
                        end
                    end
                end
            end
            local mxxx = false
            for i = 1, #ZHEN do
                if zf == 1 then
                    -- 170 30
                    if mx > x3 - size * 8 and mx < x3 - size * 8 + bx * 170 and my > y3 - size * 10 + (i - 1) * size and
                        my < y3 - size * 10 + (i - 1) * size + by * 30 then
                        mxxx = true
                        tb2 = i
                    end
                end
            end
            if mxxx == true and ktype == 3 then
                for i = 1, #zfmenu do
                    if zfmenu[i][2] == 1 and tb2 == i then
                        zfpd = 1
                        CC.TX['我方阵法'] = tb2
                        zfmenu[i][2] = 2
                    else
                    end
                end
            end
        end
    end
end

-- 葵花魅影
function kuihuameiying()
    local x, y
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
            x, y = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
            break
        end
    end
    if x == nil then
        return false
    end

    War_CalMoveStep(WAR.CurID, 100, 1)

    local function vacant(x, y)
        local r = true
        if GetWarMap(x, y, 3) == 255 then
            r = false
        end
        if lib.GetWarMap(x, y, 2) > 0 or lib.GetWarMap(x, y, 5) > 0 then
            r = false
        elseif CC.SceneWater[lib.GetWarMap(x, y, 0)] ~= nil then
            r = false
        end
        if x < 1 or x > 63 then
            r = false
        end
        if y < 1 or y > 63 then
            r = false
        end
        return r
    end
    local telx, tely = 0, 0
    local can_tele = 0
    for i = -5, 5 do
        for j = -5, 5 do
            if vacant(x + i, y + j) then
                telx, tely = x + i, y + j
                can_tele = 1
                break
            end
        end
    end
    if can_tele == 1 then
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 120, 1, "葵花魅影", C_GOLD)
        lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
        lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
        lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
        WarDrawMap(0)
        WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = telx, tely
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 120, 1, "葵花魅影", C_GOLD)
        lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
            WAR.Person[WAR.CurID]["贴图"])
        lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
            JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])

        WarDrawMap(0)
        return true
    else
        return false
    end
end

function DGFJ()
    local pd = 0
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]['人物编号']
        if WAR.Person[i]['死亡'] == false and WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[i]['我方'] and
            WAR.PD['恐惧状态'][id] == nil then
            local x, y = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
            local eft = GetWarMap(x, y, 4)
            local md = false
            local wugong = JY.Person[id]['优先使用']
            local wglx = JY.Wugong[wugong]['武功类型']
            if match_ID(id, 9982) then
                md = true
            elseif JY.Person[id]['奇穴' .. 19] == 1 and wglx == 3 and math.random(100) <= 10 then
                md = true
            end
            if md == true and JY.Person[id]['生命'] > 0 and JY.Person[id]['体力'] > 10 and fjpd(WAR.CurID) == false and eft > 0 and WAR.Person[i]['先手反击'] == -1 and WAR.DZXY == 0 then
                WAR.Person[i]['先手反击'] = 1
                WAR.Person[i]["移动步数"] = 0
                WAR.FW = {}
                for i = 0, CC.WarWidth - 1 do
                    for j = 0, CC.WarHeight - 1 do
                        local effect = GetWarMap(i, j, 4)
                        if effect > 0 then
                            WAR.FW[#WAR.FW + 1] = {i, j}
                        end
                    end
                end
                savewar()
                local pid = WAR.Person[WAR.CurID]['人物编号']
                local tx = {}
                local at = WAR.CurID
                tx.dh = WAR.Person[WAR.CurID]['特效动画']
                tx.wz1 = WAR.Person[WAR.CurID]['特效文字1']
                tx.wz2 = WAR.Person[WAR.CurID]['特效文字2']
                tx.wz3 = WAR.Person[WAR.CurID]['特效文字3']
                tx.wz4 = WAR.Person[WAR.CurID]['特效文字4']
                WAR.Person[WAR.CurID]['特效动画'] = -1
                WAR.Person[WAR.CurID]['特效文字1'] = nil
                WAR.Person[WAR.CurID]['特效文字2'] = nil
                WAR.Person[WAR.CurID]['特效文字3'] = nil
                WAR.Person[WAR.CurID]['特效文字4'] = nil
                WAR.CurID = i
                WarDrawMap(0)
                local pid = WAR.Person[i]["人物编号"]
                -- JY.Person[pid]["能量"] = JY.Person[pid]["能量"] + 1
                for i = 1, JY.Base["武功数量"] do
                    local wg = JY.Person[pid]["武功" .. i]
                    -- PNGHH_nl(pid)
                end
                CurIDTXDH(WAR.CurID, 84, 1, "无我无剑", C_GOLD)
                WarSet()
                if WAR.AutoFight == 1 or WAR.Person[i]['我方'] == false or WAR.ZDDH == 354 then
                    War_AutoFight()
                else
                    War_AutoFight()
                end
                WAR.Person[i]['先手反击'] = -1
                WAR.CurID = at
                WarDrawMap(0)

                WAR.Person[WAR.CurID]['特效动画'] = tx.dh
                WAR.Person[WAR.CurID]['特效文字1'] = tx.wz1
                WAR.Person[WAR.CurID]['特效文字2'] = tx.wz2
                WAR.Person[WAR.CurID]['特效文字3'] = tx.wz3
                WAR.Person[WAR.CurID]['特效文字4'] = tx.wz4
                CleanWarMap(4, 0)
                for i = 1, #WAR.FW do
                    SetWarMap(WAR.FW[i][1], WAR.FW[i][2], 4, 1)
                end
                WAR.FW = {}
                loadwar()
                if match_ID(id, 592) and JLSD(0, 30, id) then
                    -- CurIDTXDH(WAR.CurID, 84,1, "破剑式", C_GOLD)				
                    pd = 1
                end
            end
        end
    end
    -- say(WAR.Person[WAR.CurID]['人物编号'],0)
    return pd
end

function savewar()
    local file = io.open(CONFIG.DataPath .. '1', "w");
    assert(file);
    for i, v in pairs(WAR) do
        local t = type(WAR[i]); -- 判断对象类型
        if t == "number" then
            file:write(string.format("WAR.%s =", i))
            file:write(WAR[i])
            file:write("\n")
        end
    end
    file:close();
end

function loadwar()
    if existFile(CONFIG.DataPath .. '1') then
        dofile(CONFIG.DataPath .. '1')
        os.remove(CONFIG.DataPath .. '1');
    end
end

-- 是否触发反击，用于反击的一些判定
function fjpd(i)
    local id = WAR.Person[i]['人物编号']
    if WAR.Person[i]["反击武功"] ~= -1 then
        return true
    end
    if WAR.Person[i]["先手反击"] ~= -1 then
        return true
    end
    if WAR.Person[i]["反击"] ~= -1 then
        return true
    end
    return false
end

-- 免疫反击判定
function MyFj(i)
    local id = WAR.Person[i]['人物编号']
    local kf = JY.Person[id]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']

    -- 内轻特效607
    if NeiGong_tx(id, 607) and JLSD(0, (dkfcj_ng * 25), id) then
        return true
    elseif JY.Person[id]['奇穴' .. 106] == 1 and JLSD(0, 30, id) then
        return true
    end
    return false
end

function fjtx()
    local at = WAR.CurID
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]['人物编号']
        if WAR.Person[i]['死亡'] == false and WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[i]['我方'] and
            WAR.PD['恐惧状态'][id] == nil then
            if fjpd(WAR.CurID) == false and WAR.Person[i]['反击'] == 1 and JY.Person[id]['生命'] > 0 and JY.Person[id]['体力'] > 10 then
                lib.Debug(JY.Person[id]['姓名'] .. ' 判定反击成功')
                WAR.Person[i]["移动步数"] = 0
                WAR.CurID = i
                WarDrawMap(0)
                War_AutoFight()
                WAR.CurID = at
                WarDrawMap(0)
            end
            WAR.Person[i]['反击'] = -1
        end
    end
end

function Bagua(pid)

    local str = {}
    local lb = {'临', '兵', '斗', '者', '列', '阵', '皆', '在', '前'}

    local jl = {30, 25, 25, 25, 25, 20, 20, 15, 15}
    if JY.Base["天书数量"] < 10 then
        table.remove(lb, #lb)
    end
    if JY.Base["天书数量"] < 7 then
        table.remove(lb, #lb)
    end
    if JY.Person[pid]['实战'] < 500 then
        table.remove(lb, #lb)
    end
    if JY.Person[pid]['实战'] < 400 then
        table.remove(lb, #lb)
    end
    if JY.Person[pid]['实战'] < 300 then
        table.remove(lb, #lb)
    end
    if JY.Person[pid]['实战'] < 200 then
        table.remove(lb, #lb)
    end
    for i = 1, #lb do
        WAR.PD[lb[i]][pid] = nil
        if JLSD(0, jl[i], pid) then
            str[#str + 1] = i
            WAR.PD[lb[i]][pid] = 1
            -- if #lb > 2 then
            -- break
            -- end
        end
    end

    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    local a = 2546
    local c = 1
    local e = 1
    local zoom = CONFIG.Zoom / 100
    if #str > 0 then
        local hb = GetS(JY.SubScene, WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4) *
                       CONFIG.Zoom / 100
        local x, y = CC.ScreenW / 2, CC.ScreenH / 2
        local x1, y1 = math.sin(40 * 2 * math.pi / 360) * 220 * zoom, math.sin(50 * 2 * math.pi / 360) * 220 * zoom
        local x2, y2 = math.sin(80 * 2 * math.pi / 360) * 220 * zoom, math.sin(10 * 2 * math.pi / 360) * 220 * zoom
        local x3, y3 = math.sin(60 * 2 * math.pi / 360) * 220 * zoom, math.sin(30 * 2 * math.pi / 360) * 220 * zoom
        local x4, y4 = math.sin(20 * 2 * math.pi / 360) * 220 * zoom, math.sin(70 * 2 * math.pi / 360) * 220 * zoom
        local bl = {{0, 1 / 2}, {-x1 / 220 / zoom, y1 / 2 / 220 / zoom}, {-x2 / 220 / zoom, y2 / 2 / 220 / zoom},
                    {-x3 / 220 / zoom, -y3 / 2 / 220 / zoom}, {-x4 / 220 / zoom, -y4 / 2 / 220 / zoom},
                    {x4 / 220 / zoom, -y4 / 2 / 220 / zoom}, {x3 / 220 / zoom, -y3 / 2 / 220 / zoom},
                    {x2 / 220 / zoom, y2 / 2 / 220 / zoom}, {x1 / 220 / zoom, y1 / 2 / 220 / zoom}}

        local zb = {{x, y - 220 / 2 * zoom - zoom * 18}, {x + x1, y - y1 / 2 - zoom * 18},
                    {x + x2, y - y2 / 2 - zoom * 18}, {x + x3, y + y3 / 2 - zoom * 18},
                    {x + x4, y + y4 / 2 - zoom * 18}, {x - x4, y + y4 / 2 - zoom * 18},
                    {x - x3, y + y3 / 2 - zoom * 18}, {x - x2, y - y2 / 2 - zoom * 18}, {x - x1, y - y1 / 2 - zoom * 18}}
        for i = 1, #str do
            lib.GetKey()
            local n = str[i]
            for j = 0, 220 * zoom, 20 * zoom do
                lib.GetKey()
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                SetWarMap(x0, y0, 8, a * 2)
                e = e + 1
                if e == 3 then
                    e = 1
                    a = a + 1
                end
                if a > 2569 then
                    a = 2546
                end
                for i = 1, #lb do
                    if WAR.PD[lb[i]][pid] == nil then
                        lib.PicLoadCache(3, (2536 + i) * 2, zb[i][1], zb[i][2] - hb, 2, 256, nil, CC.WX * 50 * zoom)
                    else -- if  
                        lib.PicLoadCache(3, (2536 + i) * 2, zb[i][1], zb[i][2] - hb, 10, 256, nil, CC.WX * 50 * zoom)
                    end
                end
                if j <= 200 * zoom then
                    -- lib.PicLoadCache(99,(158+n)*2,zb[n][1]+bl[n][1]*j,zb[n][2]+bl[n][2]*j,10,256,nil,CC.ScreenW/1360*50)
                    lib.PicLoadCache(3, (2536 + n) * 2, zb[n][1] + bl[n][1] * j, zb[n][2] + bl[n][2] * j - hb, 10, 256,
                        nil, CC.WX * 50 * zoom)
                end
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
        end
    end
    CleanWarMap(8, -1)
end

Ct['实时特效动画2'] = function(flag)
    local bx, by = CC.WX, CC.HY
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]['人物编号']
        local xx, yy = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']

        local x0 = WAR.Person[WAR.CurID]["坐标X"]
        local y0 = WAR.Person[WAR.CurID]["坐标Y"]
        local dx = WAR.Person[i]["坐标X"] - x0
        local dy = WAR.Person[i]["坐标Y"] - y0
        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4) * CONFIG.Zoom / 100
        ry = ry - hb

        if WAR.Person[i]['死亡'] == false then
            -- 飞云回转刀
            if match_ID(id, 9964) then
                FeiYunHuiZhuanDao(i, x0, y0, flag)
            end
        end
    end
end

Ct['实时特效动画'] = function(s)
    CleanWarMap(9, -1)
    local bx, by = CC.WX, CC.HY
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]['人物编号']
        local xx, yy = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']

        local x0 = WAR.Person[WAR.CurID]["坐标X"]
        local y0 = WAR.Person[WAR.CurID]["坐标Y"]
        local dx = WAR.Person[i]["坐标X"] - x0
        local dy = WAR.Person[i]["坐标Y"] - y0
        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4) * CONFIG.Zoom / 100
        ry = ry - hb
        if WAR.Person[i]['死亡'] == false then
            if WAR.Person[i]['护盾'] ~= nil and WAR.Person[i]['护盾'] > 0 then
                local hd = WAR.Person[i]['护盾']
                if CC.HD[hd] ~= nil then
                    local ys = math.ceil(30 / CC.BattleDelay)
                    local t1 = CC.HD[hd].tt
                    local t2 = CC.HD[hd].tt1
                    if WAR.Person[i]['护盾延迟'] == nil then
                        WAR.Person[i]['护盾延迟'] = 1
                    else
                        if WAR.Person[i]['护盾延迟'] < ys then
                            WAR.Person[i]['护盾延迟'] = WAR.Person[i]['护盾延迟'] + 1
                        end
                    end
                    if WAR.Person[i]['护盾延迟'] == ys then
                        if WAR.Person[i]['护盾贴图'] == -1 then
                            WAR.Person[i]['护盾贴图'] = t1
                        else
                            WAR.Person[i]['护盾贴图'] = WAR.Person[i]['护盾贴图'] + 1
                        end
                        if WAR.Person[i]['护盾贴图'] > t2 then
                            WAR.Person[i]['护盾贴图'] = t1
                        end
                        SetWarMap(xx, yy, 9, WAR.Person[i]['护盾贴图'] * 2)
                        WAR.Person[i]['护盾延迟'] = 0
                    else
                        if WAR.Person[i]['护盾贴图'] == -1 then
                            WAR.Person[i]['护盾贴图'] = t1
                        end
                        SetWarMap(xx, yy, 9, WAR.Person[i]['护盾贴图'] * 2)
                    end
                end
            end
        end
    end
end

function Delay(tt, x, y)
    for i = 1, tt do
        Cat('实时特效动画')
        if x ~= nil and y ~= nil then
            WarDrawMap(1, x, y)
        else
            WarDrawMap(0)
        end
        Cat('实时特效动画2')
        ShowScreen()
        lib.Delay(CC.BattleDelay)
    end
end

Ct['菜单'] = function(me, num, x, y, color, size, lx, color2, h)
    local bx, by = CC.WX, CC.HY
    local menu = {}
    local size = CC.FontSmall
    local cot = 1
    local cot1 = 0
    for i = 1, #me do
        if me[i][3] == 1 then
            menu[#menu + 1] = {me[i][1], i}
        end
    end
    if #menu == 0 then
        return 0
    end
    if num == nil then
        num = #menu
    else
        if num > #menu then
            num = #menu
        end
    end
    while true do
        if JY.Restart == 1 then
            break
        end
        Cat('实时特效动画')
        Cls()
        Cat('实时特效动画2')
        for i = 1, num do
            lib.PicLoadCache(92, 1 * 2, x + (i - 1) * bx * 40, y, 2, 255)
            local cl = C_WHITE
            if i == cot then
                cl = C_RED
            end
            if lx == nil then
                draw2(menu[i + cot1][1], x + (i - 1) * bx * 40, y - size * 2, cl, size, color2, h)
            else
                local stn = string.len(menu[i + cot1][1]) / 2
                local hsize = bx * 100 / stn
                draw3(menu[i + cot1][1], x + (i - 1) * bx * 40, y - ((stn - 1) * hsize + size) / 2, cl, size, color2,
                    hsize)
            end
        end
        ShowScreen()
        lib.Delay(CC.BattleDelay)

        local X, ktype, mx, my = lib.GetKey();
        if X == VK_SPACE or X == VK_RETURN then
            PlayWavE(77)
            return menu[cot + cot1][2]
        elseif X == VK_ESCAPE or ktype == 4 then
            return 0
        elseif X == VK_UP then
            PlayWavE(77)
        elseif X == VK_DOWN then
            PlayWavE(77)
        elseif X == VK_LEFT then
            PlayWavE(77)
            if cot > 1 then
                cot = cot - 1
            else
                if cot1 > 0 then
                    cot1 = cot1 - 1
                else
                    cot = num
                    cot1 = #menu - num
                end
            end
        elseif X == VK_RIGHT then
            PlayWavE(77)
            if cot + cot1 < #menu then
                if cot < num then
                    cot = cot + 1
                else
                    cot1 = cot1 + 1
                end
            else
                cot = 1
                cot1 = 0
            end
        elseif menu[1] ~= nil and string.sub(menu[1][1], 1, 4) == '蓄力' and X == VK_P then
            PlayWavE(77)
            return 1
        elseif menu[2] ~= nil and string.sub(menu[2][1], 1, 4) == '防御' and X == VK_D then
            PlayWavE(77)
            return 2
        elseif menu[3] ~= nil and string.sub(menu[3][1], 1, 4) == '等待' and X == VK_W then
            PlayWavE(77)
            return 3
        elseif menu[4] ~= nil and string.sub(menu[4][1], 1, 4) == '集中' and X == VK_J then
            PlayWavE(77)
            return 4
        elseif menu[5] ~= nil and string.sub(menu[5][1], 1, 4) == '休息' and X == VK_R then
            PlayWavE(77)
            return 5
        else
            local mxx = false
            for i = 1, #menu do
                if mx >= CC.ScreenW / 54.4 + (i - 1) * bx * 40 - bx * 20 and mx <= CC.ScreenW / 54.4 + (i - 1) * bx * 40 +
                    bx * 20 and my >= CC.ScreenH - CC.ScreenH / 12.8 - by * 55 and my <= CC.ScreenH - CC.ScreenH / 12.8 +
                    by * 55 then
                    cot = i
                    mxx = true
                    break
                end
            end
            if ktype == 3 and mxx == true then
                PlayWavE(77)
                return menu[cot + cot1][2]
            end
        end

    end
end

Ct['战斗菜单'] = function()
    -- 疑问002
    local bx, by = CC.WX, CC.HY
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local yx = 1
    local px, py = -1, -1
    local ZDWeather =
        {{"下雨天影响轻功的发挥和人物动作，移动减-2步，攻击力-5%，无法点燃，流血效果翻倍。"},
         {"下雪天影响集气速度和冰冻灼烧效果，集气-3，轻功-5%，灼烧和点燃效果减半，冻结和冰冻效果翻倍。"},
         {"有雾天影响人物视野和命中，命中-5%。流血交果减半，封穴效果加倍。"},
         {"晴天因为敌方发挥正常，闪避-5%，灼烧和点燃效果翻倍，冻结和冰冻效果减半。"}}
    local zx, zy, zh = 500, 10, 70
    for i = 1, JY.Base["武功数量"] do
        if JY.Person[pid]["武功" .. i] == JY.Person[pid]["优先使用"] then
            yx = i
        end
    end
    local warmenu = {{'移动Ｍ', '移动', 1}, {'武功Ａ', '武功招式', 1}, {'绝技Ｌ', '绝技', 1},
                     {'运功Ｇ', '运功', 1}, {'战术Ｓ', '战术', 1}, {'物品Ｅ', '物品', 1},
                     {'其他Ｈ', '其他', 1}, {'撤退Ｃ', '撤退', 1}, {'自动Ｔ', '自动', 1}}
    if JY.Person[pid]["特色指令"] == 1 then
        -- 如果是畅想
        if pid == 0 then
            -- '绝技'
            warmenu[3][1] = GRTS[JY.Base["畅想"]] .. 'Ｌ'
        else
            -- '绝技'
            warmenu[3][1] = GRTS[pid] .. 'Ｌ'
        end
    else
        -- '绝技'
        warmenu[3][3] = 0
    end

    -- 虚竹
    if match_ID(pid, 49) then
        -- 如果没有中生死符的人物则不显示特色指令
        local t = 0
        for i = 0, WAR.PersonNum - 1 do
            local wid = WAR.Person[i]["人物编号"]
            if WAR.PD["生死符"][wid] == 1 and WAR.Person[i]["死亡"] == false then
                t = 1
            end
        end
        -- '绝技'
        if t == 0 then
            warmenu[3][3] = 0
        end
        -- 体力小于20不显示特色指令
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 then
            warmenu[3][3] = 0
        end
    end

    -- 祖千秋
    if match_ID(pid, 88) then
        -- 如果周围没有队友不显示特色指令
        local yes = 0
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 5) and i ~=
                WAR.CurID then
                yes = 1
            end
        end
        -- '绝技'
        if yes == 0 then
            warmenu[3][3] = 0
        end
        -- 体力小于20不显示特色指令
        -- 内力小于1000不显示
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end

    -- 人厨子
    if match_ID(pid, 89) then
        -- 如果周围没有队友不显示特色指令
        local px, py = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
        local mxy = {{WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] + 1},
                     {WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1},
                     {WAR.Person[WAR.CurID]["坐标X"] + 1, WAR.Person[WAR.CurID]["坐标Y"]},
                     {WAR.Person[WAR.CurID]["坐标X"] - 1, WAR.Person[WAR.CurID]["坐标Y"]}}

        local yes = 0
        for i = 1, 4 do
            if GetWarMap(mxy[i][1], mxy[i][2], 2) >= 0 then
                local mid = GetWarMap(mxy[i][1], mxy[i][2], 2)
                if inteam(WAR.Person[mid]["人物编号"]) then
                    yes = 1
                end
            end
        end
        -- '绝技'
        if yes == 0 then
            warmenu[3][3] = 0
        end
        -- '绝技'
        -- 体力小于25不显示特色指令
        if JY.Person[pid]["体力"] < 25 then
            warmenu[3][3] = 0
        end
    end

    -- 张无忌
    if match_ID(pid, 9) then
        -- 如果周围没有队友不显示特色指令
        local yes = 0
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false and RealJL(WAR.CurID, i, 8) and i ~=
                WAR.CurID then
                yes = 1
            end
        end
        -- '绝技'
        if yes == 0 then
            warmenu[3][3] = 0
        end
        -- '绝技'
        -- 体力小于20不显示特色指令
        if JY.Person[pid]["体力"] < 20 then
            warmenu[3][3] = 0
        end
    end

    -- 霍青桐指挥指令
    if match_ID(pid, 74) then
        -- 体力小于10不显示特色指令
        -- '绝技'
        if JY.Person[pid]["体力"] < 10 or JY.Person[pid]["内力"] < 150 or WAR.HQT_CD > 0 then
            warmenu[3][3] = 0
        end
    end

    -- 慕容复指令 幻梦
    if match_ID(pid, 51) then
        -- 体力小于20不显示特色指令
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 then
            warmenu[3][3] = 0
        end
    end

    -- 小昭指令 影步
    if match_ID(pid, 66) then
        -- 体力小于30，或内力小于2000不显示特色指令
        -- '绝技'
        if JY.Person[pid]["体力"] < 30 or JY.Person[pid]["内力"] < 2000 then
            warmenu[3][3] = 0
        end
    end

    -- 钟灵指令 灵貂
    if match_ID(pid, 90) then
        -- 体力小于10不显示特色指令
        if JY.Person[pid]["体力"] < 10 then
            -- '绝技'
            warmenu[3][3] = 0
        end
    end

    -- 喵姐指令 变装
    if match_ID(pid, 92) then
        -- 体力小于20不显示特色指令
        if JY.Person[pid]["体力"] < 20 then
            -- '绝技'
            warmenu[3][3] = 0
        end
    end
    -- 丘机处 止杀
    if match_ID(pid, 68) then
        -- 体力小于20不显示特色指令
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or WAR.JSZT1[pid] > 0 then
            warmenu[3][3] = 0
        end
    end
    -- 胡斐指令 飞狐
    if match_ID(pid, 1) then
        -- 体力小于20不显示特色指令
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 then
            warmenu[3][3] = 0
        end
    end

    -- 鸠摩智指令 幻化
    if match_ID(pid, 103) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end

    -- 达尔巴指令 死战
    if match_ID(pid, 160) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 or WAR.SZSD ~= -1 then
            warmenu[3][3] = 0
        end
    end

    -- 金轮 龙象
    if match_ID(pid, 62) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end

    -- 黄蓉 遁甲
    if match_ID(pid, 56) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end

    -- 韦小宝 口才
    if match_ID(pid, 601) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 30 then
            warmenu[3][3] = 0
        end
    end

    -- 苗人凤 破军
    if match_ID(pid, 3) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end

    -- 何太冲 铁琴
    if match_ID(pid, 7) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end

    -- 方证 金身
    -- '绝技'
    if match_ID(pid, 149) then
        if JY.Person[pid]["体力"] < 20 or JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end
    -- 李寻欢 飞刀
    if match_ID(pid, 498) then
        -- '绝技'
        if JY.Person[pid]["内力"] < 1000 then
            warmenu[3][3] = 0
        end
    end
    -- 萧秋水 天剑
    -- '绝技'
    -- if match_ID(pid, 652) and JY.Base["天书数量"] < 7 then
    --	warmenu[3][3] = 0
    -- end

    -- 阎基 虚弱
    if match_ID(pid, 4) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 then
            warmenu[3][3] = 0
        end
    end
    -- 张中 变天
    if match_ID(pid, 308) then
        -- '绝技'
        if JY.Person[pid]["体力"] < 20 then
            warmenu[3][3] = 0
        end
    end
    ------------------------------------------------------
    ------------------------------------------------------
    -- 出左右时，移动，解毒，医疗，物品，特色，自动不可见
    if WAR.ZYHB == 2 then
        for i = 1, #warmenu do
            if i == 2 or i == 4 or i == 5 then
                warmenu[i][3] = 1
            else
                warmenu[i][3] = 0
            end
        end
    end
    -- warmenu[3][3] = 0
    -- 体力小于5或者已经移动过时，移动不可见
    if JY.Person[pid]["体力"] <= 5 or WAR.Person[WAR.CurID]["移动步数"] <= 0 then
        warmenu[1][3] = 0
        -- isEsc = 1
    end

    -- 判断最小内力，是否可显示攻击
    local minv = War_GetMinNeiLi(pid)
    if JY.Person[pid]["内力"] < minv or JY.Person[pid]["体力"] < 10 then
        warmenu[2][3] = 0
    end
    if JY.Person[pid]["优先使用"] < 1 then
        lib.Debug(JY.Person[pid]["姓名"] .. 6)
        warmenu[2][3] = 0
    end
    -- 止杀禁止攻击
    if WAR.PD["恐惧状态"][pid] ~= nil or WAR.PD["止杀CD"] == 3 then
        warmenu[2][3] = 0
    end

    if match_ID(pid, 610) and WAR.LQZ[pid] ~= 100 then
        warmenu[2][3] = 0
    end
    local menu = {}
    for i = 1, #warmenu do
        if warmenu[i][3] == 1 then
            menu[#menu + 1] = {warmenu[i][2], i, warmenu[i][1]}
        end
    end
    local size = CC.FontSmall
    local cot = 1
    local FY = 0
    local ztbg = 0
    local tb = 0
    local ztnum = 0
    while true do
        if JY.Restart == 1 then
            break
        end
        Cat('实时特效动画')
        Cls()
        Cat('实时特效动画2')
        DrawTimeBar_sub()
        for i = 1, #menu do
            lib.PicLoadCache(92, 1 * 2, CC.ScreenW / 54.4 + (i - 1) * bx * 40, CC.ScreenH - CC.ScreenH / 12.8, 2, 255)
            local cl = C_WHITE
            if i == cot then
                cl = C_RED
            end
            draw2(menu[i][3], CC.ScreenW / 54.4 + (i - 1) * bx * 40, CC.ScreenH - CC.ScreenH / 12.8 - size * 2, cl,
                size, LimeGreen)
        end
        -- BUFF
        local size1 = CC.DefaultFont * 0.7
        local hs = 0
        local name = {}
        local n = {}
        local m = {}
        local ztwz = {}
        local ZUIDHS = 15
        local h = 0
        for z = 1, #CC.ZTSM do
            if WAR.PD[CC.ZTSM[z][1]] ~= nil then
                if CC.ZTSM[z] ~= nil and WAR.PD[CC.ZTSM[z][1]][pid] ~= nil and WAR.PD[CC.ZTSM[z][1]][pid] > 0 then
                    name[#name + 1] = CC.ZTSM[z][1]
                    ztwz[#ztwz + 1] = CC.ZTSM[z][2]
                    n[#n + 1] = CC.ZTSM[z][3]
                    m[#m + 1] = CC.ZTSM[z][4]
                end
            end
        end
        local nn = 0
        local mm = 0
        for i = 1, #name do
            if px >= bx * 1075 - (i - 1) * 56 and px <= bx * 1075 + bx * 45 - (i - 1) * 56 and py >= 700 - mm * (bx * 100) and py <= 749 - mm * (bx * 100) then
                lib.LoadPNG(91, 189 * 2, bx * 510, by * 340, 1, 0, 120)
                if #name > 0 then
                    for i = 1, #name do
                        if tb == i then
                            -- DrawString(bx*700-string.len(name[i])/4*size,by*343,name[i],C_RED,CC.DefaultFont*0.6)
                            lib.DrawStr(bx * 700 - size / 2.5 - string.len(name[i]) / 4 * size * 0.9, by * 343, name[i],
                                C_RED, size * 0.9, CC.FontName)
                            lib.DrawStr(bx * 530, by * 340 + size1 * 1.5, name[i] .. ": " .. WAR.PD[name[i]][pid],
                                C_RED, CC.DefaultFont * 0.6, CC.FontName)
                            h = tjm(bx * 530, by * 340 + size1 * 2.5, ztwz[i], C_CYGOLD, size1 * 0.9, 15, size1 * 0.9,
                                FY - hs, ZUIDHS + 1 - hs + FY)
                            hs = hs + h
                            break
                        end
                    end
                end
            end
            nn = nn + 1
            if nn >= 10 then
                mm = mm + 1
                nn = 1
            end
        end
        if px > zx and px < zx + zh and py > zy and py < zy + zh then
            local str = nil
            for i = 1, #CC.Weather do
                if CC.Weather[i][1] > 0 then
                    str = CC.Weather[i][4]
                end
            end
            lib.LoadPNG(91, 37 * 2, zx - size * 10, zy, 1, 0, 140)
            tjm(zx - size * 9, zy + size * 0.2, str, C_BLACK, size * 0.85, 8, size * 0.85)
        end
        ShowScreen()
        lib.Delay(CC.Frame)
        local X, ktype, mx, my = lib.GetKey();
        if mx ~= -1 and my ~= -1 then
            px, py = mx, my
        end
        if X == VK_SPACE or X == VK_RETURN then
            PlayWavE(77)
            local r
            if menu[cot][2] ~= nil then
                r = Cat(menu[cot][1])
                if r == 1 then
                    if menu[cot][2] == 1 then
                        return 1
                    else
                        break
                    end
                end
            end
        elseif X == VK_ESCAPE or ktype == 4 then
            PlayWavE(77)
            if ztbg == 1 then
                ztbg = 0
            end
            return 0
        elseif X == VK_UP then
            PlayWavE(77)
        elseif X == VK_DOWN then
            PlayWavE(77)
        elseif X == VK_LEFT then
            PlayWavE(77)
            cot = cot - 1
            if cot < 1 then
                cot = #menu
            end
        elseif X == VK_RIGHT then
            PlayWavE(77)
            cot = cot + 1
            if cot > #menu then
                cot = 1
            end
            -- 移动
        elseif X == VK_M then
            PlayWavE(77)
            if warmenu[1][3] == 1 then
                local r = Cat(warmenu[1][2])
                if r == 1 then
                    return 1
                end
            end
            -- 武功
        elseif X == VK_A then
            PlayWavE(77)
            if warmenu[2][3] == 1 then
                if JY.Person[pid]["优先使用"] >= 1 then
                    local r = Cat(warmenu[2][2])
                    if r == 1 then
                        break
                    end
                end
            end
            -- 绝技
        elseif X == VK_L then
            PlayWavE(77)
            if warmenu[3][3] == 1 then
                local r = Cat(warmenu[3][2])
                if r == 1 then
                    break
                end
            end
            -- 运功
        elseif X == VK_G then
            PlayWavE(77)
            if warmenu[4][3] == 1 then
                local r = Cat(warmenu[4][2])
                if r == 1 then
                    break
                end
            end
            -- 战术
        elseif X == VK_S then
            PlayWavE(77)
            if warmenu[5][3] == 1 then
                local r = Cat(warmenu[5][2])
                if r == 1 then
                    break
                end
            end
            -- 物品
        elseif X == VK_E then
            PlayWavE(77)
            if warmenu[6][3] == 1 then
                local r = Cat(warmenu[6][2])
                if r == 1 then
                    break
                end
            end
            -- 其他
        elseif X == VK_H then
            PlayWavE(77)
            if warmenu[7][3] == 1 then
                local r = Cat(warmenu[7][2])
                if r == 1 then
                    break
                end
            end
            -- 撤退
        elseif X == VK_C then
            PlayWavE(77)
            if warmenu[8][3] == 1 then
                local r = Cat(warmenu[8][2])
                if r == 1 then
                    break
                end
            end
            -- 自动
        elseif X == VK_T then
            PlayWavE(77)
            if warmenu[9][3] == 1 then
                local r = Cat(warmenu[9][2])
                if r == 1 then
                    break
                end
            end
        elseif X >= 49 and X <= 57 and warmenu[2][3] == 1 then

        elseif X == VK_P and warmenu[5][3] == 1 then
            PlayWavE(77)
            War_ActupMenu()
            break
        elseif X == VK_D and warmenu[5][3] == 1 then
            PlayWavE(77)
            War_DefupMenu()
            break
        elseif X == VK_W and warmenu[5][3] == 1 then
            PlayWavE(77)
            War_Wait()
            break
        elseif X == VK_J and warmenu[5][3] == 1 then
            PlayWavE(77)
            War_Focus()
            break
        elseif X == VK_R and warmenu[5][3] == 1 then
            PlayWavE(77)
            War_RestMenu()
            break
        elseif X == VK_V and warmenu[7][3] == 1 then
            PlayWavE(77)
            local r = War_PoisonMenu()
            -- 解毒
            if r == 1 then
                break
            end
        elseif X == VK_Q and warmenu[7][3] == 1 then
            PlayWavE(77)
            local r = War_DecPoisonMenu()
            -- 医疗
            if r == 1 then
                break
            end
        elseif X == VK_F and warmenu[7][3] == 1 then
            PlayWavE(77)
            local r = War_DoctorMenu()
            if r == 1 then
                break
            end
        elseif X == VK_Z and warmenu[7][3] == 1 then
            PlayWavE(77)
            Ckstatus()
        else
            local mxx = false
            for i = 1, #menu do
                if mx >= CC.ScreenW / 54.4 + (i - 1) * bx * 40 - bx * 20 and mx <= CC.ScreenW / 54.4 + (i - 1) * bx * 40 +
                    bx * 20 and my >= CC.ScreenH - CC.ScreenH / 12.8 - by * 55 and my <= CC.ScreenH - CC.ScreenH / 12.8 +
                    by * 55 then
                    cot = i
                    mxx = true
                    break
                end
            end
            if ktype == 3 and mxx == true then
                PlayWavE(77)
                local r
                if menu[cot][2] ~= nil then
                    r = Cat(menu[cot][1])
                    if r == 1 then
                        if menu[cot][2] == 1 then
                            return 1
                        else
                            break
                        end
                    end
                end
            end
            local ztmx = false
            for i = 1, #name do
                local zx = bx * 1055
                if mx >= zx - (i - 1) * 56 and mx <= zx + bx * 56 - (i - 1) * by * 56 and my >= by * 700 and my <= by *
                    749 then
                    tb = i
                    ztmx = true
                    break
                end
            end
            if ztmx == true and ktype == 3 then
                ztbg = 1
            end
        end

    end
end

Ct['移动'] = function()
    if WAR.Person[WAR.CurID]["人物编号"] ~= -1 then
        WAR.ShowHead = 0
        if WAR.Person[WAR.CurID]["移动步数"] <= 0 then
            return 0
        end
        War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
        local r = nil
        local x, y = War_SelectMove()
        if x ~= nil then
            War_MovePerson(x, y, 1)
            r = 1
        else
            r = 0
            WAR.ShowHead = 1
            Cls()
        end
        lib.GetKey()
        return r
    else
        local ydd = {}
        local n = 1
        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                ydd[n] = i
                n = n + 1
            end
        end
        local dx = ydd[math.random(n - 1)]
        local DX = WAR.Person[dx]["坐标X"]
        local DY = WAR.Person[dx]["坐标Y"]
        local YDX = {DX + 1, DX - 1, DX}
        local YDY = {DY + 1, DY - 1, DY}
        local ZX = YDX[math.random(3)]
        local ZY = YDY[math.random(3)]
        if not SceneCanPass(ZX, ZY) or GetWarMap(ZX, ZY, 2) < 0 then
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            WAR.Person[WAR.CurID]["坐标X"] = ZX
            WAR.Person[WAR.CurID]["坐标Y"] = ZY
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
        end
    end
    return 1
end
-- 老顾0305
Ct['武功'] = function()
    local bx, by = CC.WX, CC.HY
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local numwugong = 0
    local kfmenu = {}
    local zs = {}
    WAR.WGZS = 0
    for i = 1, JY.Base["武功数量"] do
        local tmp = JY.Person[pid]["武功" .. i]
        if tmp > 0 then
            kfmenu[i] = {tmp, i, 1} -- 如果是1则显示按排序i显示

            -- 内功无法攻击
            -- 游坦之可以	标记修改
            if JY.Wugong[tmp]["武功类型"] == 6 and match_ID(pid, 9985) == false then
                kfmenu[i][3] = 0
            end

            -- 轻功无法攻击
            if JY.Wugong[tmp]["武功类型"] == 7 or
                (tmp == 85 or tmp == 87 or tmp == 88 or tmp == 144 or tmp == 175 or tmp == 182 or tmp == 199) then
                kfmenu[i][3] = 0
            end

            -- 斗转星移不显示
            if tmp == 43 then
                kfmenu[i][3] = 0
            end

            -- 如果主角是天罡，内功可攻击，畅想第一格内功可攻击
            if ((pid == 0 and JY.Base["标准"] == 6) or (pid == 0 and JY.Base["畅想"] > 0 and i == 1)) and
                JY.Wugong[tmp]["武功类型"] == 6 then
                kfmenu[i][3] = 1
            end
            -- 林平之 东方 萧半和 显示葵花神功
            if tmp == 105 and (match_ID(pid, 36) or match_ID(pid, 27) or match_ID(pid, 189)) then
                kfmenu[i][3] = 1
            end

            -- 石破天 显示太玄神功
            if tmp == 102 and match_ID(pid, 9759) then
                kfmenu[i][3] = 1
            end

            -- 张无忌 显示九阳神功
            if tmp == 106 and match_ID(pid, 9) then
                kfmenu[i][3] = 1
            end
            -- 斗酒僧 显示九阳神功
            if tmp == 106 and (match_ID(pid, 638) or match_ID(pid, 9999)) then
                kfmenu[i][3] = 1
            end

            -- 狄云 显示神经照
            if tmp == 94 and match_ID(pid, 37) then
                kfmenu[i][3] = 1
            end

            -- 慕容复 显示斗转星移
            if tmp == 43 and (match_ID(pid, 51) or match_ID(pid, 679)) then
                kfmenu[i][3] = 1
            end

            -- 欧阳锋 显示逆运
            if tmp == 104 and match_ID(pid, 60) then
                kfmenu[i][3] = 1
            end

            -- 小昭 显示圣火
            if tmp == 93 and match_ID(pid, 66) then
                kfmenu[i][3] = 1
            end

            -- 内力少不显示
            if JY.Person[pid]["内力"] < JY.Wugong[tmp]["消耗内力点数"] then
                kfmenu[i][3] = 0
            end

            -- 体力低于10不显示
            if JY.Person[pid]["体力"] < 10 then
                kfmenu[i][3] = 0
            end
            numwugong = numwugong + 1
        end
    end

    local menu = {}
    local tmp = 0
    for ai = 1, JY.Base["武功数量"] do
        tmp = JY.Person[pid]["武功" .. ai]
    end
    for i = 1, #kfmenu do -- 查找kfmenu表
        if kfmenu[i][3] == 1 then -- 如果表中第三项等于1则
            menu[#menu + 1] = {kfmenu[i][1], i} -- menu表添加1个等于kfneu表中1项
        end
    end

    if #menu == 0 then
        return 0
    end
    local num = 15
    if num > #menu then
        num = #menu
    end

    local size = CC.FontSmall -- *0.95
    local cot = 1
    local cot1 = 0
    while true do
        if JY.Restart == 1 then
            break
        end
        Cat('实时特效动画')
        Cls()
        Cat('实时特效动画2')
        for i = 1, num do
            lib.PicLoadCache(92, 1 * 2, CC.ScreenW / 54.4 + (i - 1) * bx * 40, CC.ScreenH - CC.ScreenH / 12.8, 2, 255)
            local cl = C_WHITE
            if i == cot then
                cl = C_RED
            end
            local stn = string.len(JY.Wugong[menu[i + cot1][1]]['名称']) / 2
            local hsize = bx * 100 / stn
            if WuyueJFSL(pid) > 4 then
                if tmp == 30 then
                    JY.Wugong[30]['名称'] = "北岳神剑"
                end
                if tmp == 31 then
                    JY.Wugong[31]['名称'] = "东岳神剑"
                end
                if tmp == 32 then
                    JY.Wugong[32]['名称'] = "南岳神剑"
                end
                if tmp == 33 then
                    JY.Wugong[33]['名称'] = "中岳神剑"
                end
                if tmp == 34 then
                    JY.Wugong[34]['名称'] = "西岳神剑"
                end
            end
            draw3(JY.Wugong[menu[i + cot1][1]]['名称'], CC.ScreenW / 54.4 + (i - 1) * bx * 40,
                CC.ScreenH - CC.ScreenH / 12.8 - ((stn - 1) * hsize + size) / 2, cl, size, nil, hsize)
        end
        ShowScreen()
        lib.Delay(80)

        local X, ktype, mx, my = lib.GetKey();
        if X == VK_SPACE or X == VK_RETURN then
            Cat("武功招式")
        elseif X == VK_ESCAPE or ktype == 4 then
            PlayWavE(77)
            return 0
        elseif X == VK_UP then
            PlayWavE(77)
        elseif X == VK_DOWN then
            PlayWavE(77)
        elseif X == VK_LEFT then
            PlayWavE(77)
            if cot > 1 then
                cot = cot - 1
            else
                if cot1 > 0 then
                    cot1 = cot1 - 1
                else
                    cot = num
                    cot1 = #menu - num
                end
            end
        elseif X == VK_RIGHT then
            PlayWavE(77)
            if cot + cot1 < #menu then
                if cot < num then
                    cot = cot + 1
                else
                    cot1 = cot1 + 1
                end
            else
                cot = 1
                cot1 = 0
            end
        elseif X >= 49 and X <= 57 then
            PlayWavE(77)
            local r = War_FightMenu(nil, nil, X - 48);
            if r == 1 then
                return 1
            end
        else
            local mxx = false
            for i = 1, #menu do
                if mx >= CC.ScreenW / 54.4 + (i - 1) * bx * 40 - bx * 20 and mx <= CC.ScreenW / 54.4 + (i - 1) * bx * 40 +
                    bx * 20 and my >= CC.ScreenH - CC.ScreenH / 12.8 - by * 55 and my <= CC.ScreenH - CC.ScreenH / 12.8 +
                    by * 55 then
                    cot = i
                    mxx = true
                    break
                end
            end
            if ktype == 3 and mxx == true then
                PlayWavE(77)
                return Cat("武功招式")
            end
        end

    end
end

-- 老顾0305
Ct['武功招式'] = function()
    local bx, by = CC.WX, CC.HY
    WAR.WGZS = 0
    local size = CC.DefaultFont
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    -- local surid = lib.SaveSur(0, 0, CC.ScreenW, CC.ScreenH)
    local choice = 1
    local size = CC.FontSmall
    local zssm = {}
    local level = 0
    local wl = 0
    local B = JY.Person[pid]
    local STARTH = 0
    local FY = 0
    local STARTH1 = 0
    local FY1 = 0
    if WAR.LQZ[pid] == nil then
        WAR.LQZ[pid] = 0
    end

    local lqz = WAR.LQZ[pid] - JZ_lqz(pid)
    while true do
        if JY.Restart == 1 then
            break
        end

        Cat('实时特效动画')
        Cls()
        Cat('实时特效动画2')

        -- local zs =CC.KFMove[JY.Person[id]["优先使用"]]
        local wg = JY.Person[pid]["优先使用"]
        local kflx = JY.Wugong[wg]['武功类型']
        local yx = 1
        local xs = 0
        for i = 1, JY.Base["武功数量"] do
            if JY.Person[pid]["武功" .. i] > 0 then 
                CC.KFMove[JY.Person[pid]["武功" .. i]][1][3] = 0
            end
            if JY.Person[pid]["武功" .. i] == wg then               
                yx = i
            end
        end
        
        -- 内力少不显示
        if CC.KFMove[wg] ~= nil then
            local zs = CC.KFMove[wg]
            local zswz1 = ''
            for i = 1, #zs do
                lib.LoadPNG(91, 64 * 2, bx, by * 417, 1, 0, 63)
                lib.PicLoadCache(92, 1 * 2, CC.ScreenW / 54.4 + (i - 1) * bx * 40, CC.ScreenH - CC.ScreenH / 12.8, 2,
                    255)
                local color = C_WHITE
                for j = 1, JY.Base["武功数量"] do
                    if JY.Person[pid]["武功" .. j] == wg then
                        xs = CC.WUGONGZS[j][i]
                    end
                end
                local pdzs = false
                if B["武功招式" .. xs] == 0 then
                    pdzs = true
                end
                if B["能量"] < CC.KFMove[wg][i][3] then
                    pdzs = true
                end
                if i == #zs and kflx < 6 then
                    -- if  JUEZHAO(pid) == false then 
                    if lqz < 0 then
                        -- lib.Debug('绝招判定失败')
                        pdzs = true
                    end
                end
                if pdzs == true then
                    color = M_Gray
                    lib.LoadPNG(91, 86 * 2, CC.ScreenW / 54.4 + (i - 1) * bx * 40, CC.ScreenH - CC.ScreenH / 12.8, 2)
                end
                if choice == i then
                    color = C_RED
                    zswz1 = KF_zswz(wg, choice)
                    if B["武功招式" .. xs] == 0 then
                        color = M_DarkSlateBlue
                    end
                end
                local namelen = string.len(zs[i][1]) / 2
                local stn = string.len(zs[i][1]) / 2
                local hsize = bx * 100 / stn
                draw3(zs[i][1], CC.ScreenW / 54.4 + (i - 1) * bx * 40, CC.ScreenH - CC.ScreenH / 12.8 - ((stn - 1) * hsize + size) / 2, color, size, nil, hsize)
            end
            local wl
            local n = KF_zswl(pid, wg, choice)
            local atk = Atk(WAR.CurID)
            local sz = math.modf(atk * (1 + n / 2000))
            local sznum = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十"}
            local wz1 = JY.Wugong[JY.Person[pid]["优先使用"]]["名称"] .. "第" .. sznum[choice] .. "招，" ..
                            "造成基础伤害" .. 'Ｇ' .. sz .. "Ｗ" .. "点。"
            local zsmc1
            if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 1 then
                zsmc1 = "Ｇ" .. "◆" .. zs[choice][1]
            else
                zsmc1 = "Ｗ" .. "◆" .. zs[choice][1]
            end
            -- local zsqg = "招式气攻：".."Ｇ"..CC.KFMove[wg][choice][2]
            local zsqg = "招式气攻：" .. "Ｇ" .. n
            tjm(bx * 10, by * 425, zsmc1, C_WHITE, size * 1.2, 11, size)
            tjm(bx * 10, by * 450, zsqg, C_WHITE, size, 11, size)
            if choice == #zs then
                tjm(bx * 13, by * 428, '怒', C_RED, size * 0.9, 11, size)
            end
            local hs1 = 0
            local ZUIDHS1 = 2
            local h1 = 0
            local hs = 0
            local ZUIDHS = 1
            local h = 0
            h1 = tjm(bx * 10, by * 470 + size * (hs1 - FY1), wz1, C_WHITE, size * 0.9, 10, size * 0.9, FY1 - hs1,
                ZUIDHS1 + 1 - hs1 + FY1)
            hs1 = hs1 + h1
            local kf1 = wg

            h = tjm(bx * 10, by * 510 + size * (hs - STARTH), zswz1, C_ORANGE, size * 0.9, 10, size * 0.9, STARTH - hs,
                ZUIDHS + 1 - hs + FY)
            hs = hs + h
            if hs > ZUIDHS then
                FY = limitX(hs - ZUIDHS - 1, 0)
            else
                FY = 0
            end
            lib.LoadPNG(91, 85 * 2, bx * 1, by * 550, 1, 0, 120)
            DrawString(bx * 10, by * 555, JY.Wugong[wg]["名称"], C_WHITE, size * 1.5)
            local NLZB = {{240, 422}, {220, 422}, {200, 422}, {180, 422}, {160, 422}}
            for nl = 1, CC.KFMove[wg][choice][3] do
                lib.LoadPNG(91, 106 * 2, bx * NLZB[nl][1], by * NLZB[nl][2], 1, 0, 50)
            end
            ShowScreen()
            lib.Delay(CC.Frame)
            local keyPress, ktype, mx, my = lib.GetKey();
            if keyPress == VK_SPACE or keyPress == VK_RETURN then
                PlayWavE(77)
                if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 1 then
                    if choice < #zs then
                        if (JY.Person[pid]["能量"] - CC.KFMove[wg][choice][3] >= 0) then
                            WAR.WGZS = choice
                            return War_Fight_Sub(WAR.CurID, yx)
                        else
                            DrawStrBoxWaitKey("真气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil, C_RED)
                        end
                    else
                        if (JY.Person[pid]["能量"] - CC.KFMove[wg][choice][3] >= 0) then
                            if kflx < 6 then
                                if lqz >= 0 or choice == 1 then
                                    WAR.WGZS = choice
                                    return War_Fight_Sub(WAR.CurID, yx)
                                else
                                    DrawStrBoxWaitKey("怒气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil,
                                        C_RED)
                                end
                            else
                                WAR.WGZS = choice
                                return War_Fight_Sub(WAR.CurID, yx)
                            end
                        else
                            DrawStrBoxWaitKey("真气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil, C_RED)
                        end
                    end
                else
                    if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 0 then
                        DrawStrBoxWaitKey("未领悟此招式", C_GOLD, CC.DefaultFont, nil, C_RED)
                    end
                    Cls()
                end
            elseif keyPress == VK_ESCAPE or ktype == 4 then
                break
            elseif keyPress == VK_UP or keyPress == VK_LEFT then
                STARTH = 0
                PlayWavE(77)
                choice = choice - 1
                if choice < 1 then

                    choice = #zs
                    -- say("数字键"..choice,0,1)
                end
            elseif keyPress == VK_DOWN or keyPress == VK_RIGHT then
                STARTH = 0
                PlayWavE(77)
                choice = choice + 1
                if choice > #zs then
                    choice = 1
                end
            elseif keyPress >= 49 and keyPress <= 57 then
                PlayWavE(77)
                local input = keyPress - 48
                if input <= #zs then
                    choice = input
                    local jz = #zs
                    if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 1 then
                        if choice < #zs then
                            if (JY.Person[pid]["能量"] - CC.KFMove[wg][choice][3] >= 0) then
                                WAR.WGZS = choice
                                return War_Fight_Sub(WAR.CurID, yx)
                            else
                                DrawStrBoxWaitKey("真气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil,
                                    C_RED)
                                -- if B["武功招式"..CC.WUGONGZS[yx][choice]] == B["武功招式"..#CC.KFM[yx]] then 
                            end
                        else
                            if (JY.Person[pid]["能量"] - CC.KFMove[wg][choice][3] >= 0) then
                                -- if  JUEZHAO(pid) == true then 
                                if kflx < 6 then
                                    if lqz >= 0 or choice == 1 then
                                        WAR.WGZS = choice
                                        return War_Fight_Sub(WAR.CurID, yx)
                                    else
                                        DrawStrBoxWaitKey("怒气不够无法使用此招式", C_GOLD, CC.DefaultFont,
                                            nil, C_RED)
                                    end
                                else
                                    WAR.WGZS = choice
                                    return War_Fight_Sub(WAR.CurID, yx)
                                end
                            else
                                DrawStrBoxWaitKey("真气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil,
                                    C_RED)
                            end
                        end
                    else
                        if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 0 then
                            DrawStrBoxWaitKey("未领悟此招式", C_GOLD, CC.DefaultFont, nil, C_RED)
                        end
                        Cls()
                    end
                    break
                end

            elseif keyPress == VK_PGUP or ktype == 6 then
                STARTH = STARTH - 1
                if STARTH < 0 then
                    STARTH = 0
                end
            elseif keyPress == VK_PGDN or ktype == 7 then
                STARTH = STARTH + 1
                if STARTH > FY then
                    STARTH = FY
                end
            else
                local mxx = false
                for i = 1, #zs do
                    if mx >= CC.ScreenW / 54.4 + (i - 1) * bx * 40 - bx * 20 and mx <= CC.ScreenW / 54.4 + (i - 1) * bx *
                        40 + bx * 20 and my >= CC.ScreenH - CC.ScreenH / 12.8 - by * 55 and my <= CC.ScreenH -
                        CC.ScreenH / 12.8 + by * 55 then
                        choice = i
                        mxx = true
                        break
                    end
                end
                if ktype == 3 and mxx == true then
                    if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 1 then
                        if choice == 1 then
                            CC.KFMove[wg][choice][3] = 0
                        end
                        if choice < #zs then
                            if (JY.Person[pid]["能量"] - CC.KFMove[wg][choice][3] >= 0) then
                                WAR.WGZS = choice
                                return War_Fight_Sub(WAR.CurID, yx)
                            else
                                DrawStrBoxWaitKey("真气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil,
                                    C_RED)
                                -- if B["武功招式"..CC.WUGONGZS[yx][choice]] == B["武功招式"..#CC.KFM[yx]] then 
                            end
                        else
                            if (JY.Person[pid]["能量"] - CC.KFMove[wg][choice][3] >= 0) then
                                if kflx < 6 then
                                    if lqz >= 0 or choice == 1 then
                                        WAR.WGZS = choice
                                        return War_Fight_Sub(WAR.CurID, yx)
                                    else
                                        DrawStrBoxWaitKey("怒气不够无法使用此招式", C_GOLD, CC.DefaultFont,
                                            nil, C_RED)
                                    end
                                else
                                    WAR.WGZS = choice
                                    return War_Fight_Sub(WAR.CurID, yx)
                                end
                            else
                                DrawStrBoxWaitKey("真气不够无法使用此招式", C_GOLD, CC.DefaultFont, nil,
                                    C_RED)
                            end
                        end
                    else
                        if B["武功招式" .. CC.WUGONGZS[yx][choice]] == 0 then
                            DrawStrBoxWaitKey("未领悟此招式", C_GOLD, CC.DefaultFont, nil, C_RED)
                        end
                        Cls()
                    end
                end
            end
            WAR.WGZS = choice
        end
    end
    return
end

Ct['绝技'] = function()
    return War_TgrtsMenu()
end

Ct['运功'] = function()
    return War_YunGongMenu()
end

Ct['战术'] = function()
    return War_TacticsMenu()
end

Ct['其他'] = function()
    return War_OtherMenu()
end

Ct['物品'] = function()
    return War_ThingMenu()
end

Ct['撤退'] = function()
    return War_Retreat()
end

Ct['自动'] = function()
    return War_AutoMenu()
end

function Ckstatus()
    -- function MapWatch()
    -- WAR.ShowHead = 0

    local x = WAR.Person[WAR.CurID]["坐标X"];
    local y = WAR.Person[WAR.CurID]["坐标Y"];
    local page = 1
    local lb = 0

    War_CalMoveStep(WAR.CurID, 255, 1)
    Cat('实时特效动画')
    WarDrawMap(1, x, y);
    Cat('实时特效动画2')
    ShowScreen()
    lib.Delay(CC.BattleDelay)
    x, y = War_SelectMove()
    local X, ktype, mx, my = lib.GetKey();
    if x == nil then
        return
    end
    local i
    local id = -1
    for i = 0, WAR.PersonNum do
        if WAR.Person[i]["坐标X"] == x and WAR.Person[i]["坐标Y"] == y and WAR.Person[i]["死亡"] == false then
            id = WAR.Person[i]["人物编号"]
            break
        end
    end
    if ktype == 3 then
        say(id, 0, 0)
    end
    if id >= 0 then
        -- say(id,0,0)
        PersonCK(id)
        -- WARHD(WAR.Person[id]["人物编号"])
    end
    -- end
end

-- 护盾停止
Ct['护盾停止'] = function(i)
    WAR.Person[i]['护盾'] = -1
    WAR.Person[i]['护盾贴图'] = -1
    WAR.Person[i]['护盾延迟'] = nil
    -- 自动循环判定是否存在其他护盾，防止一个护盾被破其他护盾还存在
    if WAR.Person[i]['护盾'] == nil or WAR.Person[i]['护盾'] == -1 then
        local id = WAR.Person[i]['人物编号']
        for j = 1, #CC.HD do
            local hname = CC.HD[j].name
            if WAR.PD[hname] ~= nil then
                if WAR.PD[hname][id] ~= nil then
                    WAR.Person[i]['护盾'] = j
                    break
                end
            end
        end
    end
end

Ct['神游太虚'] = function(x, y)
    local id = WAR.Person[WAR.CurID]['人物编号']
    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    PlayWavE(5)
    CurIDTXDH(WAR.CurID, 129, 1, '神游太虚')
    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
    -- WarDrawMap(0)
    -- CurIDTXDH(WAR.CurID, 129,1)
    WAR.Person[WAR.CurID]["人方向"] = War_Direct(x0, y0, x, y)
    WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = x, y
    WarDrawMap(0)
    -- CurIDTXDH(WAR.CurID, 129,1)
    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
    lib.SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
        JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
    -- WarDrawMap(0)
    CurIDTXDH(WAR.CurID, 129, 1, '神游太虚')
end

Ct['神游太虚2'] = function(flag)
    if flag == nil then
        local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
        WAR.PD['神游太虚'] = {}
        for j = 0, WAR.PersonNum - 1 do
            local mid = WAR.Person[j]['人物编号']
            local zbx, zby = WAR.Person[j]['坐标X'], WAR.Person[j]['坐标Y']
            local mx = WAR.Person[j]['人方向']
            local zm = false
            -- 为啥这么麻烦？我想看看中间的概率
            local a = math.random(10)
            if mx == 0 then
                if y0 < zby then
                    if math.abs(x0 - zbx) - math.abs(y0 - zby) >= 1 then
                        if (a < 8 and a > 4) or WAR.LQZ[mid] == 100 then
                            zm = true
                        end
                    else
                        zm = true
                    end
                end
            elseif mx == 1 then
                if x0 > zbx then
                    if math.abs(y0 - zby) - math.abs(x0 - zbx) >= 1 then
                        if (a < 8 and a > 4) or WAR.LQZ[mid] == 100 then
                            zm = true
                        end
                    else
                        zm = true
                    end
                end
            elseif mx == 2 then
                if x0 < zbx then
                    if math.abs(y0 - zby) - math.abs(x0 - zbx) >= 1 then
                        if (a < 8 and a > 4) or WAR.LQZ[mid] == 100 then
                            zm = true
                        end
                    else
                        zm = true
                    end
                end
            elseif mx == 3 then
                if y0 > zby then
                    if math.abs(x0 - zbx) - math.abs(y0 - zby) >= 1 then
                        if (a < 8 and a > 4) or WAR.LQZ[mid] == 100 then
                            zm = true
                        end
                    else
                        zm = true
                    end
                end
            end
            if zm == true and WAR.Person[j]['死亡'] == false and j ~= WAR.CurID and match_ID(mid, 9976) then
                WAR.PD['神游太虚'][mid] = {}
                WAR.PD['神游太虚'][mid].hp = JY.Person[mid]['生命']
                WAR.PD['神游太虚'][mid].nl = JY.Person[mid]['内力']
                WAR.PD['神游太虚'][mid].tl = JY.Person[mid]['体力']
                WAR.PD['神游太虚'][mid].zd = JY.Person[mid]['中毒程度']
                -- WAR.PD['神游太虚'][mid].ns = JY.Person[mid]['受伤程度']
                WAR.PD['神游太虚'][mid].ns = WAR.PD['内伤状态'][mid] or 0
                WAR.PD['神游太虚'][mid].bs = JY.Person[mid]['冰封程度']
                WAR.PD['神游太虚'][mid].zs = JY.Person[mid]['灼烧程度']
                WAR.PD['神游太虚'][mid]['生命点数'] = WAR.Person[j]['生命点数']
                WAR.PD['神游太虚'][mid]['内力点数'] = WAR.Person[j]['内力点数']
                WAR.PD['神游太虚'][mid]['体力点数'] = WAR.Person[j]['体力点数']
                WAR.PD['神游太虚'][mid]['中毒点数'] = WAR.Person[j]["中毒点数"];
                WAR.PD['神游太虚'][mid]['内伤点数'] = WAR.Person[j]["内伤点数"];
                for k, v in pairs(WAR) do
                    if k ~= 'Person' and k ~= 'Data' then
                        local t = type(WAR[k])
                        if t == 'table' then
                            WAR.PD['神游太虚'][mid][k] = WAR[k][mid]
                        end
                    end
                end
                WAR.Person[j]['神游太虚'] = 1
            end
        end
    else
        for j = 0, WAR.PersonNum - 1 do
            local mid = WAR.Person[j]['人物编号']
            local zbx, zby = WAR.Person[j]['坐标X'], WAR.Person[j]['坐标Y']
            if WAR.Person[j]['死亡'] == false and match_ID(mid, 9976) and WAR.Person[j]['神游太虚'] == 1 and
                (GetWarMap(zbx, zby, 4) > 1 or WAR.TXXS[mid] ~= nil) then
                if WAR.PD['神游太虚'][mid] ~= nil then
                    WAR.Person[j]["特效动画"] = -1
                    WAR.Person[j]["特效文字0"] = nil
                    WAR.Person[j]["特效文字1"] = nil
                    WAR.Person[j]["特效文字2"] = nil
                    WAR.Person[j]["特效文字3"] = nil
                    WAR.Person[j]["特效文字4"] = nil
                    JY.Person[mid]['生命'] = WAR.PD['神游太虚'][mid].hp
                    JY.Person[mid]['内力'] = WAR.PD['神游太虚'][mid].nl
                    JY.Person[mid]['体力'] = WAR.PD['神游太虚'][mid].tl
                    JY.Person[mid]['中毒程度'] = WAR.PD['神游太虚'][mid].zd
                    -- JY.Person[mid]['受伤程度'] = WAR.PD['神游太虚'][mid].ns 
                    WAR.PD['内伤状态'][mid] = WAR.PD['神游太虚'][mid].ns
                    JY.Person[mid]['冰封程度'] = WAR.PD['神游太虚'][mid].bs
                    JY.Person[mid]['灼烧程度'] = WAR.PD['神游太虚'][mid].zs
                    WAR.Person[j]['生命点数'] = WAR.PD['神游太虚'][mid]['生命点数']
                    WAR.Person[j]['内力点数'] = WAR.PD['神游太虚'][mid]['内力点数']
                    WAR.Person[j]['体力点数'] = WAR.PD['神游太虚'][mid]['体力点数']
                    WAR.Person[j]['中毒点数'] = WAR.PD['神游太虚'][mid]['中毒点数']
                    WAR.Person[j]['内伤点数'] = WAR.PD['神游太虚'][mid]['内伤点数']
                    for k, v in pairs(WAR) do
                        if k ~= 'Person' and k ~= 'Data' then
                            local t = type(WAR[k])
                            if t == 'table' then
                                WAR[k][mid] = WAR.PD['神游太虚'][mid][k]
                            end
                        end
                    end
                    WAR.Person[j]["特效文字3"] = "神游太虚"
                    WAR.Person[j]["特效动画"] = 129
                    if WAR.Person[j].TimeAdd ~= nil and WAR.Person[j].TimeAdd < 0 then
                        WAR.Person[j].TimeAdd = 0
                    end
                    WAR.Person[j]['神游太虚'] = nil
                    SetWarMap(zbx, zby, 4, 0)
                    WAR.TXXS[mid] = nil
                end
            end
        end

        WAR.PD['神游太虚'] = {}
    end
end

-- 战场攻击力
function Atk(i)
    local id = WAR.Person[i]['人物编号']
    local gj = 0
    gj = gj + JY.Person[id]['攻击力']
    -- lib.Debug(JY.Person[id]['姓名']..'人物攻击力'..gj)	
    if WAR.PD["招式减攻1"][id] ~= nil and WAR.PD["招式减攻1"][id] > 0 then
        gj = gj - gj * 0.05
    end
    if WAR.PD["招式减攻2"][id] ~= nil and WAR.PD["招式减攻2"][id] > 0 then
        gj = gj - gj * 0.1
    end
    if WAR.PD["招式减攻3"][id] ~= nil and WAR.PD["招式减攻3"][id] > 0 then
        gj = gj - gj * 0.15
    end
    if WAR.PD["招式减攻4"][id] ~= nil and WAR.PD["招式减攻4"][id] > 0 then
        gj = gj - gj * 0.2
    end
    local nlgj = limitX((JY.Person[id]['内力'] - JY.Person[id]['资质'] * 10) / 60, 0)
    -- lib.Debug(JY.Person[id]['姓名']..'内力加成攻击力'..nlgj)	
    gj = gj + nlgj
    gj = gj + FJGONGJ(id)

    -- lib.Debug(JY.Person[id]['姓名']..'附加攻击力'..FJGONGJ(id))	
    return gj
end

-- 战场防御力
function Def(i)
    local id = WAR.Person[i]['人物编号']
    local fy = 0
    local kf = JY.Person[id]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    fy = fy + JY.Person[id]['防御力']
    if WAR.PD["招式减防1"][id] ~= nil and WAR.PD["招式减防1"][id] > 0 then
        fy = fy - fy * 0.05
    end
    if WAR.PD["招式减防2"][id] ~= nil and WAR.PD["招式减防2"][id] > 0 then
        fy = fy - fy * 0.1
    end
    if WAR.PD["招式减防3"][id] ~= nil and WAR.PD["招式减防3"][id] > 0 then
        fy = fy - fy * 0.15
    end
    if WAR.PD["招式减防4"][id] ~= nil and WAR.PD["招式减防4"][id] > 0 then
        fy = fy - fy * 0.2
    end
    if WAR.PD['卸甲状态'][id] == nil then
        fy = fy + FJFANGY(id)
    end
    if WAR.PD['突防状态'][id] ~= nil then
        fy = FJFANGY(id)
    end
    fy = fy + limitX((JY.Person[id]['内力'] - JY.Person[id]['资质'] * 10) / 60, 0)
    return fy
end

-- 战场轻功
function Qg(i)
    local id
    id = WAR.Person[i]['人物编号']
    local qg = 0

    qg = qg + JY.Person[id]['轻功']
    qg = qg + limitX((JY.Person[id]['内力'] - JY.Person[id]['资质'] * 10) / 60, 0)
    local fb = 1

    -- 聂风
    if match_ID(id, 546) or match_ID(id, 9911) then
        fb = 2
    end

    -- 队友轻功加成
    for i, v in pairs(CC.AddSpd) do
        if match_ID(id, v[1]) then
            for wid = 0, WAR.PersonNum - 1 do
                if match_ID(WAR.Person[wid]["人物编号"], v[2]) and WAR.Person[wid]["死亡"] == false then
                    qg = qg + v[3]
                end
            end
        end
    end

    qg = qg + FJQINGG(id)
    return qg
end

-- 战场光环
function ZDGH(i, id)
    for j = 0, WAR.PersonNum - 1 do
        local zid = WAR.Person[j]["人物编号"]
        if WAR.Person[j]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[j]["我方"] and match_ID(zid, id) then
            return true
        end
    end
end

-- 十方步
Ct['十方步'] = function(i, bs, lx, auto)
    local nx, ny = nil, nil
    local id = WAR.Person[i]['人物编号']
    if lx == nil then
        lx = 0
    end
    local at = WAR.CurID
    -- auto 自动
    if WAR.Person[i]['我方'] == false or WAR.AutoFight == 1 or auto == '自动' or WAR.ZDDH == 354 then
        -- say('1')
        local menu = {}
        local menu2 = {}
        War_CalMoveStep(i, bs, lx)
        local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
        -- 记录所有可以移动的坐标
        for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
            for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
                if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                    menu[#menu + 1] = {ix, iy}
                end
            end
        end
        -- 随机选择一个可以移动的坐标，记录当前坐标地图层2的数值，设定当前坐标
        if #menu > 0 then
            local a = math.random(#menu)
            nx = menu[a][1]
            ny = menu[a][2]
        end
    else
        WAR.CurID = i
        War_CalMoveStep(i, bs, lx)
        while true do
            -- WAR.Person[WAR.CurID]["移动步数"] = 2
            -- War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
            nx, ny = War_SelectMove() -- 显示+选择步数
            if nx ~= nil then
                if GetWarMap(nx, ny, 3) ~= 255 and GetWarMap(nx, ny, 2) < 0 then
                    break
                end
            elseif nx == nil then
                break
            end
        end
    end

    if nx ~= nil and ny ~= nil then
        PlayWavE(5)
        WAR.CurID = i
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 89, 1, "十方步")
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
        WarDrawMap(0)
        WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
            JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
        CurIDTXDH(WAR.CurID, 89, 1, "十方步")
    end
    WAR.CurID = at
    if fjpd(WAR.CurID) == false and MyFj(WAR.CurID) == false then
        WAR.Person[i]['反击'] = 1 -- 反击100%伤害
        WAR.DZXYLV[WAR.Person[i]['人物编号']] = 200
        -- PNGHH_nl(WAR.Person[i]['人物编号'])
    end
end

Ct['灵鳌步'] = function(i, bs, lx, auto)
    local nx, ny = nil, nil
    local id = WAR.Person[i]['人物编号']
    if lx == nil then
        lx = 0
    end
    local at = WAR.CurID
    -- auto 自动
    if WAR.Person[i]['我方'] == false or WAR.AutoFight == 1 or auto == '自动' or WAR.ZDDH == 354 then
        -- say('1')
        local menu = {}
        local menu2 = {}
        War_CalMoveStep(i, bs, lx)
        local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
        -- 记录所有可以移动的坐标
        for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
            for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
                if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                    menu[#menu + 1] = {ix, iy}
                end
            end
        end
        -- 随机选择一个可以移动的坐标，记录当前坐标地图层2的数值，设定当前坐标
        if #menu > 0 then
            local a = math.random(#menu)
            nx = menu[a][1]
            ny = menu[a][2]
        end
    else
        WAR.CurID = i
        War_CalMoveStep(i, bs, lx)
        while true do
            -- WAR.Person[WAR.CurID]["移动步数"] = 2
            -- War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
            nx, ny = War_SelectMove() -- 显示+选择步数
            if nx ~= nil then
                if GetWarMap(nx, ny, 3) ~= 255 and GetWarMap(nx, ny, 2) < 0 then
                    break
                end
            elseif nx == nil then
                break
            end
        end
    end

    if nx ~= nil and ny ~= nil then
        PlayWavE(5)
        WAR.CurID = i
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 89, 1, "灵鳌步")
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
        WarDrawMap(0)
        WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
            JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
        CurIDTXDH(WAR.CurID, 89, 1, "灵鳌步")
    end
    WAR.CurID = at
end

Ct['挪移'] = function(i, bs, lx, auto)
    local nx, ny = nil, nil
    local id = WAR.Person[i]['人物编号']
    if lx == nil then
        lx = 0
    end
    local at = WAR.CurID
    -- auto 自动
    if WAR.Person[i]['死亡'] == false then 
        if WAR.Person[i]['我方'] == false or WAR.AutoFight == 1 or auto == '自动' or WAR.ZDDH == 354 then
            lib.Debug('自动或敌方')
            local menu = {}
            local menu2 = {}
            War_CalMoveStep(i, bs, lx)
            local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
            -- 记录所有可以移动的坐标
            for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
                for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
                    if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                        menu[#menu + 1] = {ix, iy}
                    end
                end
            end
            -- 随机选择一个可以移动的坐标，记录当前坐标地图层2的数值，设定当前坐标
            if #menu > 0 then
                local a = math.random(#menu)
                nx = menu[a][1]
                ny = menu[a][2]
                -- WAR.NyPd[#WAR.NyPd+1] = {nx,ny,GetWarMap(nx,ny,2)}
                -- SetWarMap(nx,ny,2,i)
            end
        else
            lib.Debug('我方非自动')
            WAR.CurID = i
            War_CalMoveStep(i, bs, lx)
            while true do
                nx, ny = War_SelectMove() -- 显示+选择步数
                if nx ~= nil then
                    if GetWarMap(nx, ny, 3) ~= 255 and GetWarMap(nx, ny, 2) < 0 then
                        -- WAR.NyPd[#WAR.NyPd+1] = {nx,ny,GetWarMap(nx,ny,2)}
                        -- SetWarMap(nx,ny,2,i)
                        break
                    end
                elseif nx == nil then
                    break
                end
            end

        end

        if nx ~= nil and ny ~= nil then
            PlayWavE(5)
            WAR.CurID = i
            WarDrawMap(0)
            CurIDTXDH(WAR.CurID, 89, 1, "空蝉")
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            --WarDrawMap(0)
            -- CurIDTXDH(WAR.CurID, 89,1, "真・葵花挪移")
            WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
            -- WarDrawMap(0)
            -- CurIDTXDH(WAR.CurID, 89,1, "真・葵花挪移")
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            -- WarDrawMap(0)
            --CurIDTXDH(WAR.CurID, 89, 1, "空蝉")
            local pid = WAR.Person[WAR.CurID]['人物编号']

        end
        --内轻特效1033
        if NeiGong_tx(id,1033) then 
            WAR.PD['百劫'][id] = (WAR.PD['百劫'][id] or 0 ) + 1
            --WAR.Person[i]["特效文字0"] = "葵花百劫"
        end  
        WAR.CurID = at

    end      
    -- return nx,ny
end

Ct['奇门五转'] = function(i, bs, lx, auto)
    local nx, ny = nil, nil
    local id = WAR.Person[i]['人物编号']
    if lx == nil then
        lx = 0
    end
    local at = WAR.CurID

    local menu = {}
    local menu2 = {}
    War_CalMoveStep(i, bs, lx)
    local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
    for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
        for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
            if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                menu[#menu + 1] = {ix, iy}
            end
        end
    end
    if #menu > 0 then
        local a = math.random(#menu)
        nx = menu[a][1]
        ny = menu[a][2]
    end

    if nx ~= nil and ny ~= nil then
        PlayWavE(5)
        WAR.CurID = i
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 95, 2, "奇门五转・中土")
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
        WarDrawMap(0)
        WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
            JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
        CurIDTXDH(WAR.CurID, 95, 2, "奇门五转・中土")
    end

    WAR.CurID = at

    -- return nx,ny
end

Ct['自动攻击'] = function(kfid)
    local x, y = nil, nil
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local kungfuid = JY.Person[pid]["武功" .. kfid]
    local kungfulv = JY.Person[pid]["武功等级" .. kfid]
    if kungfulv == 999 then
        kungfulv = 11
    else
        kungfulv = math.modf(kungfulv / 100) + 1
    end
    local m1, m2, a1, a2, a3, a4, a5 = refw(kungfuid, kungfulv)
    local mfw = {m1, m2}
    local atkfw = {a1, a2, a3, a4, a5}
    if kungfulv == 11 then
        kungfulv = 10
    end
    -- AI也用新的威力判定
    local kungfuatk = get_skill_power(pid, kungfuid, kungfulv)
    local atkarray = {}
    local num = 0
    CleanWarMap(4, -1)
    local movearray = War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)

    for i = 0, WAR.Person[WAR.CurID]["移动步数"] do
        local step_num = movearray[i].num
        if step_num ~= nil then
            for j = 1, step_num do
                local xx = movearray[i].x[j]
                local yy = movearray[i].y[j]
                num = num + 1
                atkarray[num] = {}
                atkarray[num].x, atkarray[num].y = xx, yy
                atkarray[num].p, atkarray[num].ax, atkarray[num].ay = GetAtkNum(xx, yy, mfw, atkfw, kungfuatk)
            end
        end
    end
    for i = 1, num - 1 do
        for j = i + 1, num do
            if atkarray[i].p < atkarray[j].p then
                atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
            end
        end
    end
    if atkarray[1].p > 0 then
        for i = 2, num do
            if atkarray[i].p == 0 or atkarray[i].p < atkarray[1].p / 2 then
                num = i - 1
                break
            end
        end
        for i = 1, num - 1 do
            for j = i + 1, num do
                if atkarray[i].p < atkarray[j].p then
                    atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
                elseif atkarray[i].p == atkarray[j].p and math.random(2) > 1 then
                    atkarray[i], atkarray[j] = atkarray[j], atkarray[i]
                end
            end
        end
        for i = 2, num do
            if atkarray[i].p < atkarray[1].p * 4 / 5 then
                num = i - 1
                break
            end
        end

        local select = 1

        War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
        War_MovePerson(atkarray[select].x, atkarray[select].y)
        War_Fight_Sub(WAR.CurID, kfid, atkarray[select].ax, atkarray[select].ay)
    end
    -- return x,y
end

function Atid(i)
    if WAR.Atid == i then
        WAR.Person[i].Time = 1000
        WAR.Atid = -1
        return true
    end
    if WAR.Person[i].Time > 1000 then
        return true
    end
    return false
end

Ct['随机移动'] = function()
    local id = WAR.Person[WAR.CurID]['人物编号']
    local lx = 0
    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    local bs = WAR.Person[WAR.CurID]['移动步数']
    local xx, yy = nil, nil
    local menu = {}
    if bs <= 0 then
        return
    end
    War_CalMoveStep(WAR.CurID, bs, lx)

    for ix = limitX(x0 - bs, 0), limitX(x0 + bs, x0, 62) do
        for iy = limitX(y0 - bs, 0), limitX(y0 + bs, y0, 62) do
            if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 then
                menu[#menu + 1] = {ix, iy}
            end
        end
    end

    if #menu > 0 then
        local a = math.random(#menu)
        xx = menu[a][1]
        yy = menu[a][2]
        War_MovePerson(xx, yy)
        WAR.Person[WAR.CurID]['移动步数'] = 0
    end
end

Ct['随机移动1'] = function()
    local id = WAR.Person[WAR.CurID]['人物编号']
    local lx = 0
    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    local bs = 1
    local xx, yy = nil, nil
    local menu = {}
    War_CalMoveStep(WAR.CurID, bs, lx)
    for ix = limitX(x0 - bs, 0), limitX(x0 + bs, x0, 62) do
        for iy = limitX(y0 - bs, 0), limitX(y0 + bs, y0, 62) do
            if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 then
                menu[#menu + 1] = {ix, iy}
            end
        end
    end

    if #menu > 0 then
        local a = math.random(#menu)
        xx = menu[a][1]
        yy = menu[a][2]
        War_MovePerson(xx, yy)
        War_MovePerson(x0, y0)
    end
end

Ct['破绽'] = function(enemyid)
    local pid = WAR.Person[WAR.CurID]['人物编号']
    local eid = WAR.Person[enemyid]['人物编号']
    local wugong = 0
    for i = 1, JY.Base["武功数量"] do
        wugong = JY.Person[pid]["武功" .. i]
    end
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效609
    if NeiGong_tx(eid, 609) and JLSD(0, (dkfcj_ng * 25), eid) then
        return false
    end
    -- 防御无法破绽
    if WAR.Defup[eid] ~= nil and WAR.Defup[eid] > 0 then
        return false
    end

    -- 玄虚劲
    if Pmiji(eid, 73) then
        return false
    end
    if WAR.PD['破绽'][eid] ~= nil then
        return true
    end
    -- 天池红花
    if match_ID(pid, 75) and JLSD(0, 30, pid) then
        return true
    end

    if match_ID(pid, 9965) then
        if WAR.LQZ[pid] == nil or WAR.LQZ[pid] < 100 then
            return false
        elseif WAR.LQZ[pid] == 100 then
            return true
        end
    end

    if match_ID(eid, 9987) or Pmiji(eid, 12) then
        return false
    end
    if match_ID(eid, 9965) then
        if WAR.LQZ[eid] == nil or WAR.LQZ[eid] < 100 then
            return false
        elseif WAR.LQZ[eid] == 100 then
            return true
        end
    end

    if match_ID(pid, 9987) and WAR.LQZ[pid] == 100 then
        return true
    end

    if match_ID(pid, 9731) and WAR.Weakspot[eid] ~= nil and WAR.Weakspot[eid] < 6 and
        (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500 or isteam(pid) == false) then
        return true
    end
    if WAR.JJPZ[eid] ~= nil then
        return true
    end
    if WAR.Person[enemyid].Time >= -200 and WAR.Person[enemyid].Time <= 200 then
        return true
    end

    if WAR.SJHB_G == 1 then
        return true
    end

    if WAR.PD["皆"][pid] == 1 then
        return true
    end
    return false
end

-- 流血抗性
function lxkx(i, lxsz)
    lxsz = lxsz or 0
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效411
    if NeiGong_tx(eid, 411) then
        lxsz = lxsz - dkfcj_ng * 2
    end
    lxsz = limitX(lxsz, 0)
    return lxsz
end

-- 中毒抗性
function zdkx(i, zdsz)
    zdsz = zdsz or 0
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效409
    if NeiGong_tx(eid, 409) then
        zdsz = zdsz - dkfcj_ng * 2
    end
    for wid = 0, WAR.PersonNum - 1 do
        -- 队友防御加成
        if ZDGH(wid, 93) then
            zdsz = zdsz + 20
            break
        end
    end

    zdsz = limitX(zdsz, 0)
    return zdsz
end

-- 封穴抗性
function fxkx(i, fxsz)
    fxsz = fxsz or 0

    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效406 
    if NeiGong_tx(eid, 406) then
        fxsz = fxsz - dkfcj_ng * 2
    end
    -- 装备金丝背心，1级封穴-5，6级封穴-10
    if JY.Person[eid]["防具"] == 60 then
        fxsz = fxsz - 5 - 1 * (JY.Thing[60]["装备等级"] - 1)
    end

    -- 公孙止受封穴减半
    if match_ID(eid, 616) then
        fxsz = math.modf(fxsz * 0.5)
    end

    fxsz = limitX(fxsz, 0)
    return fxsz
end

-- 内伤抗性
function nskx(i, nssz)
    nssz = nssz or 0
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效408
    if NeiGong_tx(eid, 408) then
        nssz = nssz - dkfcj_ng * 2
    end
    -- 装备乌蚕衣，1级内伤-5，6级内伤-10
    if JY.Person[eid]["防具"] == 59 then
        nssz = nssz - 5 - 1 * (JY.Thing[59]["装备等级"] - 1)
    end

    nssz = limitX(nssz, 0)
    return nssz
end

-- 冰封抗性
function bfkx(i, bfsz)
    bfsz = bfsz or 0
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效407
    if NeiGong_tx(eid, 407) then
        bfsz = bfsz - dkfcj_ng * 2
    end
    -- 装备皮衣，1级冰封-50%，6级免疫冰封
    if JY.Person[eid]["防具"] == 63 then
        local kh = 0.5 + 0.1 * (JY.Thing[63]["装备等级"] - 1)
        bfsz = math.modf(bfsz * (1 - kh))
    end

    bfsz = limitX(bfsz, 0)
    return bfsz
end

-- 灼烧抗性
function zskx(i, zssz)
    zssz = zssz or 0
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效410
    if NeiGong_tx(eid, 410) then
        zssz = bfsz - dkfcj_ng * 2
    end
    -- 装备佛心甲，1级灼烧-50%，6级免疫灼烧
    if JY.Person[eid]["防具"] == 62 then
        local kz = 0.5 + 0.1 * (JY.Thing[62]["装备等级"] - 1)
        zssz = math.modf(zssz * (1 - kz))
    end


    zssz = limitX(zssz, 0)
    return zssz
end

-- 免疫内伤
function myns(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效605
    if NeiGong_tx(eid, 605) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    -- 除却四相
    if Pmiji(eid, 37) and JLSD(0, 50, eid) then
        return true
    end


    -- 天佛降世
    if match_ID(eid, 9986) and WAR.PD["复活"][eid] ~= nil then
        return true
    end

    return false
end

-- 免疫流血
function mylx(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效601
    if NeiGong_tx(eid, 601) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    -- 巨木旗使 亘天烈焰
    if match_ID(eid, 304) or match_ID(eid, 9745) then
        return true
    end

    return false
end

-- 免疫中毒
function myzd(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效606
    if NeiGong_tx(eid, 606) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    -- 陆无双免疫中毒
    if match_ID_awakened(eid, 580, 1) then
        return true
    end
    -- 万毒之王
    if match_ID(eid, 190) then
        return true
    end
    -- 万毒蚀体
    if JY.Person[eid]['奇穴' .. 28] == 1 then
        return true
    end
    -- 星宿特性
    if JY.Person[eid]['门派'] == 28 then
        return true
    end
    -- 五宝花蜜酒免疫中毒
    if WAR.PD['五宝花蜜酒'][eid] ~= nil then
        return true
    end
    return false
end

-- 免疫封穴
function myfx(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效603
    if NeiGong_tx(eid, 603) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    -- 除却四相
    if Pmiji(eid, 37) and JLSD(0, 50, eid) then
        return true
    end

    -- 逍遥御风累积9点，未行动前不会被封穴
    if WAR.PD["逍遥御风"][eid] ~= nil and WAR.PD["逍遥御风"][eid] == 11 then
        return true
    end

    -- 入魔
    if WAR.PD['入魔'][eid] ~= nil and WAR.PD['入魔'][eid] == 1 then
        return true
    end
    -- 大周天功回复50时序
    if WAR.PD["养生主"][eid] ~= nil then
        return true
    end
    -- 阿九暴怒免封穴
    if match_ID(eid, 629) and WAR.LQZ[eid] == 100 then
        return true
    end
    -- 黄赏免疫封穴
    if match_ID(eid, 0) then
        return true
    end
    -- 黄赏免疫封穴
    if match_ID(eid, 637) then
        -- return true 
    end
    -- 除却四相
    if Pmiji(eid, 37) and JLSD(0, 50, eid) then
        return true
    end
    return false
end

-- 免疫冰封
function mybf(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效604
    if NeiGong_tx(eid, 604) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    -- 至阴之体
    if JY.Person[eid]['奇穴' .. 83] == 1 then
        return true
    end
    if match_ID(eid, 9965) then
        return true
    end
    -- 除却四相
    if Pmiji(eid, 37) and JLSD(0, 50, eid) then
        return true
    end
    -- 雪怪
    for j = 420, 429 do
        if match_ID(eid, j) then
            return true
        end
    end

    -- 胡一刀免疫冰封
    if match_ID(eid, 633) then
        return true
    end

    -- 徐子陵免疫冰封
    if match_ID(eid, 9978) then
        return true
    end

    -- 白秀
    if match_ID(eid, 582) then
        return true
    end

    -- 白万剑
    if match_ID(eid, 43) or match_ID(eid, 9823) then
        return true
    end

    return false
end

-- 免疫灼烧
function myzs(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']

    -- 内轻特效600
    if NeiGong_tx(eid, 600) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    if match_ID(eid, 9965) then
        return true
    end
    if WAR.CQSX == 1 then
        return true
    end
    -- 火蟾
    if match_ID(eid, 440) then
        return true
    end
    -- 除却四相
    if Pmiji(eid, 37) and JLSD(0, 50, eid) then
        return true
    end
    -- 烈火旗使
    if match_ID(eid, 303) then
        return true
    end
    return false
end

-- 免疫混乱
function myhl(i)

    return false
end

-- 免疫昏迷
function myhm(i)

    return false
end

-- 免疫锁足
function mysz(i)
    local eid = WAR.Person[i]['人物编号']
    local kf = JY.Person[eid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    -- 内轻特效618
    if NeiGong_tx(eid, 618) and JLSD(0, (dkfcj_ng * 25), eid) then
        return true
    end
    -- 万里独行
    if match_ID(eid, 9962) then
        return true
    end
    return false
end

-- 立刻出手判定
Ct['立刻出手'] = function(i)
    local id = WAR.Person[i]['人物编号']
    if WAR.ATK['人物pd'][id] == nil then
        WAR.ATK['人物table'][#WAR.ATK['人物table'] + 1] = i
        WAR.ATK['人物pd'][id] = #WAR.ATK['人物table']
    end
end

-- 人物移动步数判定
Ct['人物移动步数'] = function()
    local function getnewmove(x, y)
        local mob = x + y
        if mob > 478 then
            return 7
        elseif mob > 328 then
            return 6
        elseif mob > 198 then
            return 5
        elseif mob > 148 then
            return 4
        elseif mob > 126 then
            return 3
        elseif mob > 116 then
            return 2
        else
            return 1
        end
    end
    local p = WAR.CurID
    WAR.Person[p]["轻功"] = Qg(p)
    local id = WAR.Person[p]['人物编号']
    local kf_ng = JY.Person[id]['主运内功']
    local dkfcj_ng = JY.Wugong[kf_ng]['层级']
    -- 左右触发之后，不可移动
    if WAR.ZYHB == 2 then
        WAR.Person[p]["移动步数"] = 0
        -- 特效：不可移动
    elseif WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] ~= nil and WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] == 1 then
        WAR.Person[p]["移动步数"] = 0
        WAR.L_NOT_MOVE[WAR.Person[p]["人物编号"]] = nil
    else
        -- 计算移动步数
        local ns = WAR.PD['内伤状态'][id] or 0
        WAR.Person[p]["移动步数"] = Person_YD(id)
        --lib.Debug(JY.Person[id]['姓名']..'移动步数='..Person_YD(id))
        -- 毒王中毒移动能力补偿
        if id == 0 and JY.Base["标准"] == 9 then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + math.modf(JY.Person[id]["中毒程度"] / 50)
                                                
        end

        if WAR.PD['缓步'][id] ~= nil then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - WAR.PD['缓步'][id]
        end
        -- 天赋66小昭，限制移动
        local tf66 = hastf(p, 66, 2)
        if tf66 ~= nil then
            for j = 1, #tf66 do
                WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
            end
        end

        -- 天赋57黄药师，限制移动
        local tf57 = hastf(p, 57, 2)
        if tf57 ~= nil then
            for j = 1, #tf57 do
                WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 2
            end
        end

        -- 天赋498，限制移动
        local tf498 = hastf(p, 498, 2)
        if tf498 ~= nil then
            for j = 1, #tf498 do
                WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
            end
        end

        -- 铁甲重骑
        if match_ID(id, 654) or match_ID(id, 659) or match_ID(id, 660) or match_ID(id, 661) then
            WAR.Person[p]["移动步数"] = 10
        end

        -- 令狐冲，灭绝，血刀老祖，阿凡提，神雕移动+3格
        if match_ID(id, 35) or match_ID(id, 9813) or match_ID(id, 97) or match_ID(id, 9802) or match_ID(id, 9859) then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 3
        end
        -- 通微显化，移动至少8格
        if match_ID(id, 9770) and WAR.Person[p]["移动步数"] < 8 then
            WAR.Person[p]["移动步数"] = 8
        end
        -- 主运飞天，凌波，天罗，移动+1 胡一刀 逍遥游
        if match_ID(id, 633) then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 1
        end

        -- 踏雪无痕，移动锁定10格
        if match_ID(id, 511) then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
        end
        -- 铁腿水上飘，移动+5
        if match_ID(id, 67) or match_ID(id, 9852) then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 5
        end
        -- 长风万里，移动+2
        if match_ID(id, 9962) then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + 2
        end

        -- 李寻欢学会蜻蜓三大抄水后，移动+2
        if match_ID(id, 498) and WAR.Person[p]["移动步数"] < 8 then
            WAR.Person[p]["移动步数"] = 8
        end
        -- 雨天移动-2
        if CC.Weather[1][1] > 0 and CC.TX['战斗天气'] == 0  then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 1
        end

        if WAR.PD["洞火"][id] ~= nil then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - 2
            WAR.PD["洞火"][id] = nil
        end
        -- 金刚伏魔圈，移动变1格
        if match_ID(id, 9737) then
            WAR.Person[p]["移动步数"] = 1
        end
        -- 内轻特效708
        if NeiGong_tx(id, 708) then
            local kf_ng = JY.Person[id]['主运内功']
            local dkfcj_ng = JY.Wugong[kf_ng]['层级']
            local level = KF_level(id, kf_ng)
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] + dkfcj_ng
        end
        -- 柔网势，敌人移动减一格
        if WAR.PD['柔网势'][WAR.Person[p]["人物编号"]] ~= nil and WAR.PD['柔网势'][WAR.Person[p]["人物编号"]] == 1 then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] -  (WAR.PD['柔网势'][WAR.Person[p]["人物编号"]] or 0)
            WAR.PD['柔网势'][WAR.Person[p]["人物编号"]] = nil
        end

        -- 张家辉的麻痹戒指，减少敌人移动
        if WAR.PD["麻痹状态"][WAR.Person[p]["人物编号"]] ~= nil then
            WAR.Person[p]["移动步数"] = WAR.Person[p]["移动步数"] - WAR.PD["麻痹状态"][WAR.Person[p]["人物编号"]]
            WAR.PD["麻痹状态"][WAR.Person[p]["人物编号"]] = nil
        end

        -- 孤独求败，移动锁定10格
        if match_ID(id, 592) then
            WAR.Person[p]["移动步数"] = 10
        end
    end
    -- 最大移动步数10
    if WAR.Person[p]["移动步数"] > 10 then
        WAR.Person[p]["移动步数"] = 10
    end
    -- 锁足，敌人不可移动
    if WAR.PD["锁足状态"][id] ~= nil then
        WAR.Person[p]["移动步数"] = 0
        WAR.PD["锁足状态"][id] = nil
    end
    if WAR.Person[p]["移动步数"] < 0 then
        WAR.Person[p]["移动步数"] = 0
    end
end

-- 天关阵法
Ct['天关阵'] = function()
    if WAR.ZDDH == 356 then
        if WAR.CD == 0 then
            WAR.PD['天关阵4'] = {}
            local menu = {}
            local str = {
                [5] = '林',
                [27] = '风',
                [50] = '火',
                [114] = '山'
            }
            for i = 0, WAR.PersonNum - 1 do
                local id = WAR.Person[i]['人物编号']
                if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] == false then
                    if id == 5 or id == 27 or id == 50 or id == 114 then
                        menu[#menu + 1] = {id, i}
                    end
                end
            end
            if #menu > 1 then
                local m = math.random(#menu)
                local id = menu[m][1]
                for i = 1, #menu do
                    if i ~= m then
                        WAR.PD['天关阵4'][menu[i][1]] = id
                    end
                end
                WAR.CurID = menu[m][2]
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 19, 1, '风林火山・' .. str[id], LimeGreen);
            end
            WAR.CD = WAR.TGCD[WAR.ZDDH]
        end
    end
end
-- 清除所有异常
Ct['清除基础异常'] = function(i)
    local pid = WAR.Person[i]['人物编号']
    for j = 1, #WAR.Debuf1 do
        local yc = WAR.Debuf1[j][1]
        if WAR.PD[yc][pid] ~= nil and WAR.PD[yc][pid] > 0 then
            WAR.PD[yc][pid] = nil
        end
    end
    -- JY.Person[pid]['受伤程度'] = 0
    JY.Person[pid]['中毒程度'] = 0
    JY.Person[pid]['冰封程度'] = 0
    JY.Person[pid]['灼烧程度'] = 0
end

-- 清除所有异常
Ct['清除所有异常'] = function(i)
    local pid = WAR.Person[i]['人物编号']
    for j = 1, #WAR.Debuf do
        local yc = WAR.Debuf[j][1]
        if WAR.PD[yc][pid] ~= nil and WAR.PD[yc][pid] > 0 then
            WAR.PD[yc][pid] = nil
        end
    end
    for j = 1, #WAR.Debuf2 do
        local yc = WAR.Debuf2[j][1]
        if WAR.PD[yc][pid] ~= nil and WAR.PD[yc][pid] > 0 then
            WAR.PD[yc][pid] = nil
        end
    end
    for j = 1, #WAR.Debuf1 do
        local yc = WAR.Debuf2[j][1]
        if WAR.PD[yc][pid] ~= nil and WAR.PD[yc][pid] > 0 then
            WAR.PD[yc][pid] = nil
        end
    end
    -- JY.Person[pid]['受伤程度'] = 0
    JY.Person[pid]['中毒程度'] = 0
    JY.Person[pid]['冰封程度'] = 0
    JY.Person[pid]['灼烧程度'] = 0
end

-- 复活特效 复活统一写在这里
function fuhuo(enemyid)
    local eid = WAR.Person[enemyid]['人物编号']
    local ekf_ng = JY.Person[eid]['主运内功']
    local ekfcj_ng = JY.Wugong[ekf_ng]['层级']
    --内轻特效1005
    if JY.Person[eid]["生命"] <= 0  and WAR.PD["复活"][eid] == nil then
        local pd = false
        local num = 0
        local wz = "起死回生"
        local dh = 19
        if NeiGong_tx(eid,1005) then 
            if JLSD(0,ekfcj_ng*25,eid) then 
                pd = true
                num = ekfcj_ng*25/100
            end
        elseif  match_ID(eid, 9777)   then
            pd = true
            num = 1
        elseif match_ID(eid, 9853) then 
            pd = true
            num = 1
        --鹤笔翁 伍六七    
        elseif match_ID(eid, 9728) or match_ID(eid, 514) then 
            pd = true
            num = 1
            WAR.LQZ[eid] = 100
         -- 王重阳，复活    
        elseif match_ID(eid, 9787) then 
            pd = true
            num = 1
            WAR.LQZ[eid] = 100
            -- 畅想主角的七闪数量随天书增加，NPC固定为7
            if eid == 0 then
                WAR.BDQS = math.modf(JY.Base["天书数量"] / 2)
            else
                WAR.BDQS = 7
            end
            wz = '重阳再现'
            dh = 115
        --天佛降世
        elseif match_ID(eid, 9986) then 
            pd = true
            num = 1
            wz = '天佛降世'
        --阿九复活     
        elseif match_ID_awakened(eid, 629, 1) then 
            pd = true
            num = 1
            wz = '浴火重生'
            dh = 154
        --戚长发    
        elseif match_ID(eid, 594) then 
            pd = true
            num = 0.7
            wz = "闭气离墙 起死回生"
        --奇穴114   -- 归元境 
        elseif PersonKF(eid, 100) or PersonKF(eid, 203) or PersonKF(eid, 94) or PersonKF(eid, 177) then
            if JY.Person[eid]['奇穴' .. 114] == 1 then 
                pd = true
                num = ekfcj_ng*2/10
                local hd = 500
                if PersonKF(eid, 100) then
                    hd = 1000
                end
                WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + hd
                if WAR.Person[enemyid]['护盾'] == nil then
                    WAR.Person[enemyid]['护盾'] = 6
                end
            elseif match_ID(eid, 9761)  then
                pd = true
                num = 1
            end
        end
        --薛慕华
        for i = 0, WAR.PersonNum - 1 do
            if match_ID(WAR.Person[i]["人物编号"], 45) and WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[enemyid]["我方"] then
                pd = true
                num = 1
                wz = "阎王敌 重生"
                dh = 89
            end
        end
        if pd == true then
            WAR.Person[enemyid]["特效动画"] = dh
            WAR.Person[enemyid]["特效文字3"] = wz
            JY.Person[eid]["生命"] = JY.Person[eid]["生命最大值"] * num
            JY.Person[eid]["内力"] = JY.Person[eid]["内力"] + (JY.Person[eid]["内力最大值"] - JY.Person[eid]["内力"]) * num
            JY.Person[eid]["体力"] = JY.Person[eid]["体力"] + (100 - JY.Person[eid]["体力"]) *num
            Cat('清除基础异常', enemyid)
            WAR.Person[enemyid].Time = 980
            WAR.PD["复活"][eid] = 1
        end
    end    
end

function savetf(i)
    if WAR.Person[i]['死亡'] == false then
        local id = WAR.Person[i]['人物编号']
        if JY.Base['畅想'] > 0 and id == 0 then
            id = JY.Base['畅想']
        end
        if CC.PTF[id] ~= nil then
            for j, v in pairs(CC.PTF[id]) do
                if v == 1 then
                    if WAR.Person[i]['我方'] then
                        if WAR.TF[j] == nil then
                            WAR.TF[j] = {}
                        end
                        WAR.TF[j][#WAR.TF[j] + 1] = i
                    else
                        if WAR.TF1[j] == nil then
                            WAR.TF1[j] = {}
                        end
                        WAR.TF1[j][#WAR.TF1[j] + 1] = i
                    end
                end
            end
        end
    end
end

function hastf(i, tf, lx)
    if lx == 1 then
        if WAR.Person[i]['我方'] then
            if WAR.TF[tf] ~= nil then
                return WAR.TF[tf]
            end
        else
            if WAR.TF1[tf] ~= nil then
                return WAR.TF1[tf]
            end
        end
    end
    if lx == 2 then
        if WAR.Person[i]['我方'] then
            if WAR.TF1[tf] ~= nil then
                return WAR.TF1[tf]
            end
        else
            if WAR.TF[tf] ~= nil then
                return WAR.TF[tf]
            end
        end
    end
    return nil
end

-- 记录武功存在
function savewg(i)
    local id = WAR.Person[i]['人物编号']
    WAR.WG[id] = {}
    for j = 1, JY.Base['武功数量'] do
        local kf = JY.Person[id]['武功' .. j]
        local lv = JY.Person[id]['武功等级' .. j]
        if kf > 0 then
            WAR.WG[id][kf] = lv
        end
    end
    -- 如果武功等级不等于nil则存在武功
end

-- 飞云回转刀
function FeiYunHuiZhuanDao(i, x0, y0, flag)
    local id = WAR.Person[i]['人物编号']
    local x, y = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
    if WAR.PD['飞云回转刀'][id] == nil then
        WAR.PD['飞云回转刀'][id] = {}
        for j = 1, 8 do
            WAR.PD['飞云回转刀'][id][j] = {x, y, nil, 1426, 1432, 1426, 0}
        end
        if Boss(i) then
            for j = 9, 16 do
                WAR.PD['飞云回转刀'][id][j] = {x, y, nil, 1426, 1432, 1426, 0}
            end
        end
    else
        for j = 1, #WAR.PD['飞云回转刀'][id] do
            local fd = WAR.PD['飞云回转刀'][id][j]

            local dx = fd[1] - x0
            local dy = fd[2] - y0
            local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
            local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
            local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4) * CONFIG.Zoom / 100
            ry = ry - hb
            local cl = nil
            if WAR.Person[i]['我方'] then
                cl = C_RED
            end
            lib.PicLoadCache(0, 0, rx, ry, 2, 50)
            lib.PicLoadCache(3, fd[4] * 2, rx, ry, 18, 200, cl)
            if flag == 1 then
                for k = -1, 1 do
                    for v = -1, 1 do
                        local zbx, zby = limitX(fd[1] + k, 0, 62), limitX(fd[2] + v, 0, 62)
                        local em = GetWarMap(zbx, zby, 2)
                        if em >= 0 then
                            if WAR.Person[em]['我方'] ~= WAR.Person[i]['我方'] and WAR.Person[em]['死亡'] == false then
                                AddPersonAttrib(WAR.Person[em]['人物编号'], '生命', -20)
                                -- 重合状态额外造成10点
                                if k == 0 and v == 0 then
                                    AddPersonAttrib(WAR.Person[em]['人物编号'], '生命', -20)
                                end
                            end
                        end
                    end
                end
            end
            if fd[7] == 0 then
                -- if flag == 1 then
                local em = GetWarMap(fd[1], fd[2], 2)
                if em >= 0 and WAR.Person[em]['我方'] ~= WAR.Person[i]['我方'] and WAR.Person[em]['死亡'] == false and
                    flag == 1 then
                else
                    if fd[1] - x <= -8 then
                        fd[1] = limitX(fd[1] + 1, 0, 62)
                    elseif fd[1] - x >= 8 then
                        fd[1] = limitX(fd[1] - 1, 0, 62)
                    else
                        fd[1] = limitX(fd[1] + math.random(-1, 1), 0, 62)
                    end

                    if fd[2] - y <= -8 then
                        fd[2] = limitX(fd[2] + 1, 0, 62)
                    elseif fd[2] - y >= 8 then
                        fd[2] = limitX(fd[2] - 1, 0, 62)
                    else
                        fd[2] = limitX(fd[2] + math.random(-1, 1), 0, 62)
                    end
                    if flag == 1 then

                    end
                end
                -- end
                fd[7] = 2
            end

            -- 计时
            fd[7] = fd[7] - 1
            -- 贴图刷新
            fd[4] = fd[4] + 1
            if fd[4] > fd[5] then
                fd[4] = fd[6]
            end

        end
    end
end

-- Boss机制判定
function Boss(i)
    local id = WAR.Person[i]['人物编号']
    if WAR.Boss[id] == 1 and WAR.Person[i]['我方'] == false then
        return true
    end
    return false
end

Ct['金蛇缠丝手'] = function(i)
    local id = WAR.Person[i]['人物编号']
    local menu = {}
    local menu2 = {}
    local bs = 3
    War_CalMoveStep(i, bs, 1)
    local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
    local nx, ny = -1, -1

    -- 记录所有可以移动的坐标
    for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
        for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
            if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                menu[#menu + 1] = {ix, iy}
            end
        end
    end
    -- 随机选择一个可以移动的坐标，记录当前坐标地图层2的数值，设定当前坐标
    if #menu > 0 then
        local a = math.random(#menu)
        nx = menu[a][1]
        ny = menu[a][2]
    else
        return
    end
    for j = 0, WAR.PersonNum - 1 do
        if WAR.Person[j]['死亡'] == false and WAR.Person[j]['我方'] ~= WAR.Person[i]['我方'] then
            local x, y = WAR.Person[j]['坐标X'], WAR.Person[j]['坐标Y']
            if math.abs(x - xi) + math.abs(y - yi) > 3 then
                menu2[#menu2 + 1] = j
            end
        end
    end
    if #menu2 > 0 then
        local p = menu2[math.random(#menu2)]
        WAR.CurID = i
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 29, 2, "金蛇缠丝手", C_RED)
        CleanWarMap(4, 0)
        SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 1)
        War_ShowFight(id, 0, 0, 0, WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 82)
        SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 0)

        PlayWavE(5)
        WAR.CurID = p
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
        WarDrawMap(0)
        WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
        SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
            JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
        CurIDTXDH(WAR.CurID, 82, 1)
        if mysz(p) == false then
            WAR.PD["锁足状态"][WAR.Person[WAR.CurID]["人物编号"]] = 1
        end
    end
end

function WANXIANGTY(i)
    local id = WAR.Person[i]['人物编号']
    local menu = {}
    local menu2 = {}
    local bs = 3
    War_CalMoveStep(i, bs, 1)
    local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
    local nx, ny = -1, -1

    -- 记录所有可以移动的坐标
    for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
        for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
            if GetWarMap(ix, iy, 3) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                menu[#menu + 1] = {ix, iy}
            end
        end
    end
    -- 随机选择一个可以移动的坐标，记录当前坐标地图层2的数值，设定当前坐标
    if #menu > 0 then
        local a = math.random(#menu)
        nx = menu[a][1]
        ny = menu[a][2]
    else
        return
    end
    for j = 0, WAR.PersonNum - 1 do
        if WAR.Person[j]['死亡'] == false and WAR.Person[j]['我方'] ~= WAR.Person[i]['我方'] then
            local x, y = WAR.Person[j]['坐标X'], WAR.Person[j]['坐标Y']
            if math.abs(x - xi) + math.abs(y - yi) > 3 and math.abs(x - xi) + math.abs(y - yi) < 10 then
                menu2[#menu2 + 1] = j
            end
        end
    end
    if #menu2 > 0 then
        -- local p = menu2[math.random(#menu2)]
        local p = nil
        WAR.CurID = i
        WarDrawMap(0)
        CurIDTXDH(WAR.CurID, 63, 2, "万象天引", C_RED)
        -- War_ShowFight(id,0,0,0,0,0,63);
        CleanWarMap(4, 0)
        for w = 1, #menu2 do
            p = menu2[w]
            SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 1)
            War_ShowFight(id, 0, 0, 0, WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 82)
            SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 0)

            PlayWavE(5)
            WAR.CurID = p
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
            WarDrawMap(0)
            WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] = nx, ny
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                WAR.Person[WAR.CurID]["贴图"])
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
            SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
            CurIDTXDH(WAR.CurID, 71, 1)
            if mysz(p) == false then
                WAR.PD["锁足状态"][WAR.Person[WAR.CurID]["人物编号"]] = 1
            end
        end
        WAR.CurID = i
    end
end

function SHENLUOTZ(i)
    local id = WAR.Person[i]['人物编号']
    local menu = {}
    local menu2 = {}
    local bs = 3
    War_CalMoveStep(i, bs, 1)
    local xi, yi = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
    local nx, ny = -1, -1

    -- 记录所有可以移动的坐标
    for ix = limitX(xi - bs, 0, xi), limitX(xi + bs, xi, 62) do
        for iy = limitX(yi - bs, 0, yi), limitX(yi + bs, yi, 62) do
            if GetWarMap(ix, iy, 5) ~= 255 and GetWarMap(ix, iy, 2) < 0 and GetWarMap(ix, iy, 4) <= 0 then
                menu[#menu + 1] = {ix, iy}
            end
        end
    end
    -- 随机选择一个可以移动的坐标，记录当前坐标地图层2的数值，设定当前坐标
    if #menu > 0 then
        local a = math.random(#menu)
        nx = menu[a][1]
        ny = menu[a][2]
    else
        return
    end
    local p = WAR.CurID
    local pd = false
    if WAR.Person[p]['死亡'] == false and WAR.Person[p]['我方'] ~= WAR.Person[i]['我方'] then
        local x, y = WAR.Person[p]['坐标X'], WAR.Person[p]['坐标Y']
        if math.abs(x - xi) + math.abs(y - yi) < 3 then
            pd = true
        end
    end
    WAR.CurID = i
    WarDrawMap(0)
    CurIDTXDH(WAR.CurID, 184, 2, "神罗天征", C_RED)
    CleanWarMap(4, 0)

    SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 1)
    War_ShowFight(id, 0, 0, 0, WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 82)
    SetWarMap(WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"], 4, 0)

    PlayWavE(5)
    WAR.CurID = p
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
    WarDrawMap(0)
    WAR.Person[p]["坐标X"], WAR.Person[p]["坐标Y"] = nx, ny
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, WAR.Person[WAR.CurID]["贴图"])
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
        JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
    CurIDTXDH(p, 71, 1)
    if mysz(p) == false then
        WAR.PD["虚弱状态"][WAR.Person[WAR.CurID]["人物编号"]] = 1
    end
end

Ct['剑魔再临'] = function(id, kf)
    -- 拥有剑魔再临天赋
    if match_ID(id, 9975) then
        -- 独孤求败使用剑法必出
        if match_ID(id, 592) and JY.Wugong[kf]['武功类型'] == 3 then
            return true
        end
        -- 其他人使用玄铁50%概率
        if JLSD(0, 50, id) then
            return true
        end
    end
    -- 杨过50%概率出
    if match_ID(id, 58) and CC.TX['杨过剑魔'] == 1 and JLSD(0, 70, id) then
        return true
    end
    return false
end

Ct['九剑真传'] = function(id, kf)
    -- 拥有剑魔再临天赋
    if match_ID(id, 9974) then
        -- 独孤求败使用剑法必出
        if match_ID(id, 592) and JY.Wugong[kf]['武功类型'] == 3 then
            return true
        end
        -- 其他人使用九剑50%概率
        if kf == 47 and JLSD(0, 50, id) then
            return true
        end
    end
    return false
end

Ct['防御方动画'] = function()
    -- 挨打特效文字显示
    local txsx = 0
    local txwz = 0
    local mz = false
    local pid = WAR.Person[WAR.CurID]['人物编号']
    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    -- 计算最大动画帧数
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["死亡"] == false then
            local theeft = 0
            -- lib.Debug('CC.Effect = '..#CC.Effect)
            if WAR.Person[i]["特效动画"] > #CC.Effect then
                WAR.Person[i]["特效动画"] = -1
            end
            theeft = WAR.Person[i]["特效动画"]
            if theeft ~= -1 then
                if theeft > #CC.Effect then
                    theeft = math.random[#CC.Effect]
                end
                -- lib.Debug('txsx = '..txsx)
                -- lib.Debug('theeft = '..theeft)
                -- lib.Debug('CC.Effect[theeft] = '..CC.Effect[theeft])
                if txsx < CC.Effect[theeft] then
                    txsx = CC.Effect[theeft]
                end
            end
            if theeft == -1 and
                (WAR.Person[i]["特效文字0"] ~= nil or WAR.Person[i]["特效文字1"] ~= nil or
                    WAR.Person[i]["特效文字2"] ~= nil or WAR.Person[i]["特效文字3"] ~= nil or
                    WAR.Person[i]["特效文字4"] ~= nil) then
                txwz = 1
            end
            mz = true
        end
    end
    local bj = {-6, 6, -5, 5, -4, 4, -3, 3}

    -- 显示特效文字
    -- 没有特效固定10次循环
    if txsx == 0 and (txwz == 1 or (WAR.BJ == 1 and CC.Bj == 1)) then
        txsx = 10
    end

    local zt_count = 0
    for ii = 1, txsx do
        if JY.Restart == 1 then
            break
        end
        local yanshi = false
        local yanshi2 = false -- 无动画时的延迟

        local _, ys = math.modf(ii / 2)
        if ys == 0 then
            zt_count = zt_count + 1
        end

        for i = 0, WAR.PersonNum - 1 do
            if WAR.Person[i]["死亡"] == false then
                local theeft = WAR.Person[i]["特效动画"]
                local ix, iy = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
                if theeft ~= -1 and ii < CC.Effect[theeft] then

                    local starteft = ii
                    for i = 0, WAR.Person[i]["特效动画"] - 1 do
                        starteft = starteft + CC.Effect[i]
                    end
                    SetWarMap(ix, iy, 11, (starteft + 1) * 2)
                else
                    SetWarMap(ix, iy, 11, 0)
                end
            end
        end

        Cat('实时特效动画')

        if (WAR.BJ == 1 and CC.Bj == 1) or WAR.PD["万佛朝宗"][pid] == 1 then

            if ii < 9 then
                WarDrawMap(7, 0, 0, nil, nil, 3, nil, nil, bj[ii])
            else
                WarDrawMap(7, 0, 0, nil, nil, 3)
            end
        else
            WarDrawMap(7, 0, 0, nil, nil, 3)
        end
        Cat('实时特效动画2')

        for i = 0, WAR.PersonNum - 1 do
            lib.GetKey()
            local starteft = 0
            if WAR.Person[i]["死亡"] == false then
                local theeft = WAR.Person[i]["特效动画"]
                -- 郭襄的诸天化身步
                if theeft ~= -1 and ii < CC.Effect[theeft] then
                    local dx = WAR.Person[i]["坐标X"] - x0
                    local dy = WAR.Person[i]["坐标Y"] - y0
                    local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
                    local ry = CC.YScale * (dx + dy) + CC.ScreenH / 702 * 265
                    local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

                    local py = 0

                    ry = ry - hb
                    starteft = ii
                    for i = 0, WAR.Person[i]["特效动画"] - 1 do
                        starteft = starteft + CC.Effect[i]
                    end

                    -- 无酒不欢：特效文字一起出，不再用依次显示的方式
                    -- if ii < TPXS[i] * TP and (TPXS[i] - 1) * TP < ii then	
                    KungfuString(WAR.Person[i]["特效文字3"], rx, ry, C_WHITE, CC.FontSmall5, CC.FontName, 1)
                    KungfuString(WAR.Person[i]["特效文字2"], rx, ry, C_GOLD, CC.FontSmall5, CC.FontName, 2)
                    KungfuString(WAR.Person[i]["特效文字1"], rx, ry, C_RED, CC.FontSmall5, CC.FontName, 3)
                    KungfuString(WAR.Person[i]["特效文字0"], rx, ry, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
                    yanshi = true
                    -- end
                else
                    -- 蓝烟清： 修正无动画时不显示文字的BUG
                    if theeft == -1 and
                        (WAR.Person[i]["特效文字0"] ~= nil or WAR.Person[i]["特效文字1"] ~= nil or
                            WAR.Person[i]["特效文字2"] ~= nil or WAR.Person[i]["特效文字3"] ~= nil or
                            WAR.Person[i]["特效文字4"] ~= nil) then
                        local dx = WAR.Person[i]["坐标X"] - x0
                        local dy = WAR.Person[i]["坐标Y"] - y0
                        local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
                        local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
                        local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)

                        ry = ry - hb

                        KungfuString(WAR.Person[i]["特效文字3"], rx, ry, C_WHITE, CC.FontSmall5, CC.FontName, 1)
                        KungfuString(WAR.Person[i]["特效文字2"], rx, ry, C_GOLD, CC.FontSmall5, CC.FontName, 2)
                        KungfuString(WAR.Person[i]["特效文字1"], rx, ry, C_RED, CC.FontSmall5, CC.FontName, 3)
                        KungfuString(WAR.Person[i]["特效文字0"], rx, ry, C_ORANGE, CC.FontSmall5, CC.FontName, 4)
                        yanshi2 = true
                    end
                end
            end
        end
        ShowScreen()
        lib.Delay(CC.BattleDelay)
    end

    -- 清除特效文字
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]["人物编号"]
        WAR.Person[i]["特效动画"] = -1
        WAR.Person[i]["特效文字0"] = nil
        WAR.Person[i]["特效文字1"] = nil
        WAR.Person[i]["特效文字2"] = nil
        WAR.Person[i]["特效文字3"] = nil
        WAR.Person[i]["特效文字4"] = nil
        WAR.Person[i]["闪避"] = false;
        WAR.Person[i]["格挡"] = false;
        WAR.Miss[id] = nil
        WAR.TXWZ['特效文字0'][i] = nil;
        WAR.TXWZ['特效文字1'][i] = nil;
        WAR.TXWZ['特效文字2'][i] = nil;
        WAR.TXWZ['特效文字3'][i] = nil;
        WAR.TXWZ['特效文字4'][i] = nil;
    end
    lib.SetClip(0, 0, 0, 0)
    Cat('实时特效动画')
    WarDrawMap(0)
    Cat('实时特效动画2')
    ShowScreen()
    lib.Delay(CC.BattleDelay)
    CleanWarMap(11, 0)
end

Ct['数值显示'] = function()
    -- 计算攻击到的人
    local HitXY = {}
    local HitXYNum = 0
    local hnum = 13; -- HitXY的长度个数
    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    for i = 0, WAR.PersonNum - 1 do
        local x1 = WAR.Person[i]["坐标X"]
        local y1 = WAR.Person[i]["坐标Y"]
        local id = WAR.Person[i]['人物编号']

        -- 被特效击中的也显示
        if WAR.Person[i]["死亡"] == false and WAR.TXXS[WAR.Person[i]["人物编号"]] == 1 then
            local dx = 0
            if GetWarMap(x1, y1, 4) > 1 then
                dx = 1
            end
            SetWarMap(x1, y1, 4, 1)

            local hp = WAR.Person[i]["生命点数"];
            local mp = WAR.Person[i]["内力点数"];
            local tl = WAR.Person[i]["体力点数"];
            local ed = WAR.Person[i]["中毒点数"];
            local dd = WAR.Person[i]["解毒点数"];
            local ns = WAR.Person[i]["内伤点数"];
            local eid = WAR.Person[i]["人物编号"]
            local lx = WAR.LXZT[eid]
            local bf = JY.Person[WAR.Person[i]["人物编号"]]["冰封程度"]
            local zs = JY.Person[WAR.Person[i]["人物编号"]]["灼烧程度"]
            local fx = WAR.FXDS[WAR.Person[i]["人物编号"]]

            -- 免疫锁足
            if mysz(i) then
                WAR.PD["锁足状态"][eid] = nil
            end

            -- 免疫昏迷
            if myhm(i) then
                WAR.PD["昏迷状态"][eid] = nil
            end

            -- 免疫混乱
            if myhl(i) then
                WAR.PD["混乱状态"][eid] = nil
            end
            -- 造成任何状态或者伤害就会醒来
            WAR.PD["沉睡状态"][WAR.Person[i]["人物编号"]] = nil

            HitXY[HitXYNum] = {x1, y1, nil, nil, nil, nil, nil, nil, nil, nil, nil, nil}; -- x, y, 生命, 内力, 体力, 封穴, 流血, 中毒, 解毒, 内伤，冰封，灼烧

            if hp ~= nil and (dx == 1 or hp ~= 0) then
                local eid = WAR.Person[i]["人物编号"]
                if hp == 0 then -- 显示受到的生命
                    -- if WAR.Miss[WAR.Person[i]["人物编号"]] ~= nil  then
                    HitXY[HitXYNum][3] = ""
                    if WAR.PD["霸体"][eid] ~= nil then
                        HitXY[HitXYNum][3] = "霸体"
                    elseif WAR.PD["定乾坤"][eid] ~= nil then
                        HitXY[HitXYNum][3] = "定乾坤"
                    elseif WAR.PD["逆水寒"][eid] ~= nil then
                        HitXY[HitXYNum][3] = "逆水寒"
                    elseif match_ID(eid, 9944) then
                        HitXY[HitXYNum][3] = "招架"
                    end
                    -- end
                elseif hp > 0 then
                    HitXY[HitXYNum][3] = "+" .. hp;
                else
                    if WAR.PD['暴击判定'][eid] ~= nil and WAR.PD['暴击判定'][eid] == 1 then
                        HitXY[HitXYNum][3] = '暴击 ' .. hp
                        WAR.PD['暴击判定'][eid] = nil
                    else
                        HitXY[HitXYNum][3] = hp;
                    end
                end
            end

            if mp ~= nil then -- 显示内力变化
                if mp > 0 then
                    HitXY[HitXYNum][5] = "内力+" .. mp;
                elseif mp == 0 then
                    HitXY[HitXYNum][5] = nil; -- 变化为0时不显示
                else
                    HitXY[HitXYNum][5] = "内力" .. mp;
                end
            end

            if tl ~= nil then -- 显示体力变化
                if tl > 0 then
                    HitXY[HitXYNum][6] = "体力+" .. tl;
                elseif tl == 0 then
                    HitXY[HitXYNum][6] = nil;
                else
                    HitXY[HitXYNum][6] = "体力" .. tl;
                end
            end

            if WAR.FXXS[WAR.Person[i]["人物编号"]] ~= nil and WAR.FXXS[WAR.Person[i]["人物编号"]] == 1 then -- 显示是否封穴
                if WAR.FXDS[WAR.Person[i]["人物编号"]] ~= nil and WAR.FXDS[WAR.Person[i]["人物编号"]] > 0 then
                    HitXY[HitXYNum][7] = "封穴 " .. WAR.FXDS[WAR.Person[i]["人物编号"]];
                end
                WAR.FXXS[WAR.Person[i]["人物编号"]] = 0
            end

            if fx ~= nil then -- 显示封穴7
                if fx == 0 then
                    HitXY[HitXYNum][8] = nil;
                elseif fx > 0 then
                    -- HitXY[HitXYNum][8] = "封穴↑"..fx
                else
                    -- HitXY[HitXYNum][8] = "封穴↓"..fx
                end
            end

            if lx ~= nil then -- 显示流血8
                if lx == 0 then
                    HitXY[HitXYNum][8] = nil;
                elseif lx > 0 then
                    -- HitXY[HitXYNum][8] = "流血↑"..lx
                else
                    -- HitXY[HitXYNum][8] = "流血↓"..lx
                end
            end

            if ed ~= nil then -- 显示中毒9
                if ed == 0 then
                    HitXY[HitXYNum][9] = nil;
                else
                    HitXY[HitXYNum][9] = "中毒↑" .. ed;
                end
            end

            if dd ~= nil then -- 显示解毒4
                if dd == 0 then
                    HitXY[HitXYNum][4] = nil;
                else
                    HitXY[HitXYNum][4] = "中毒↓" .. dd;
                end
            end

            if ns ~= nil then -- 显示内伤10
                if ns == 0 then
                    HitXY[HitXYNum][10] = nil;
                elseif ns > 0 then
                    HitXY[HitXYNum][10] = "内伤↑" .. ns;
                else
                    HitXY[HitXYNum][10] = "内伤↓" .. ns;
                end
            end

            -- 冰封11

            if bf ~= nil then
                if bf == 0 then
                    -- HitXY[HitXYNum][11] = nil;
                elseif bf > 0 then
                    -- HitXY[HitXYNum][11] = "冰封↑"..bf
                else
                    -- HitXY[HitXYNum][11] = "冰封↓"..bf
                end
            end

            -- 灼烧12
            if zs ~= nil then
                if zs == 0 then
                    -- HitXY[HitXYNum][12] = nil;
                elseif zs > 0 then
                    -- HitXY[HitXYNum][12] = "灼烧↑"..zs
                else
                    -- HitXY[HitXYNum][12] = "灼烧↓"..zs
                end
            end

            HitXYNum = HitXYNum + 1
        end

        -- 偷东西，斗转不可偷
        if WAR.TD > -1 then
            if WAR.TD == 118 then
                say("１想要从我慕容复手中偷东西？哼哼，下辈子吧！", 51, 0)
            else
                instruct_2(WAR.TD, WAR.TDnum)
                Cls()
            end
            WAR.TD = -1
        end
    end

    -- 无酒不欢：挨打时的掉血和状态显示
    if HitXYNum > 0 then
        local clips = {}
        for i = 0, HitXYNum - 1 do
            local dx = HitXY[i][1] - x0
            local dy = HitXY[i][2] - y0
            local hb = GetS(JY.SubScene, HitXY[i][1], HitXY[i][2], 4) -- 海拔

            local ll = 4;
            for y = 3, hnum do
                if HitXY[i][y] ~= nil then
                    ll = string.len(HitXY[i][y]);
                    break
                end
            end
            local w = ll * CC.DefaultFont / 2 + 1
            clips[i] = {
                x1 = CC.XScale * (dx - dy) + CC.ScreenW / 2,
                y1 = CC.YScale * (dx + dy) + CC.ScreenH / 2 - hb,
                x2 = CC.XScale * (dx - dy) + CC.ScreenW / 2 + w,
                y2 = CC.YScale * (dx + dy) + CC.ScreenH / 2 + CC.DefaultFont + 1
            }
        end

        local clip = clips[0]
        for i = 1, HitXYNum - 1 do
            clip = MergeRect(clip, clips[i])
        end

        local area = (clip.x2 - clip.x1) * (clip.y2 - clip.y1) -- 绘画的范围

        Cat('实时特效动画')
        local xs = false
        -- 显示点数
        -- 无酒不欢：一次显示两种状态
        for y = 3, hnum - 2, 2 do
            if JY.Restart == 1 then
                break
            end
            local flag = false;
            for i = 5, 15 do
                local tstart = lib.GetTime()
                local y_off = i * 2 + CC.DefaultFont + CC.RowPixel
                local pd = 0
                -- WarDrawMap(0)
                for j = 0, HitXYNum - 1 do
                    if HitXY[j][y] ~= nil or HitXY[j][y + 1] ~= nil then
                        if pd == 0 then
                            WarDrawMap(0)
                            pd = 1
                        end
                        local c = y - 1;
                        -- 无酒不欢：这里用字符串的首位判定是否为掉血
                        if y == 3 and HitXY[j][y] ~= nil and string.sub(HitXY[j][y], 1, 1) == "-" then
                            if JY.HPDisplay == 1 then
                                HP_Display_When_Hit(i) -- 无酒不欢：实时显血
                            end
                            DrawString(clips[j].x1 - string.len(HitXY[j][y]) * CC.DefaultFont / 4 + CC.DefaultFont,
                                clips[j].y1 - y_off, HitXY[j][y], Color_Hurt1, CC.DefaultFont)
                        else
                            -- 无酒不欢：双排显示暂时这样写了
                            local spacing = 0
                            if HitXY[j][y] ~= nil then
                                DrawString(clips[j].x1 - string.len(HitXY[j][y]) * CC.DefaultFont / 4 + CC.DefaultFont,
                                    clips[j].y1 - y_off, HitXY[j][y], WAR.L_EffectColor[c], CC.DefaultFont)
                                spacing = CC.DefaultFont
                            end
                            if HitXY[j][y + 1] ~= nil then
                                DrawString(clips[j].x1 - string.len(HitXY[j][y + 1]) * CC.DefaultFont / 4 +
                                               CC.DefaultFont, clips[j].y1 + spacing - y_off, HitXY[j][y + 1],
                                    WAR.L_EffectColor[c + 1], CC.DefaultFont)
                            end
                        end

                        flag = true;
                    end
                end

                if flag then
                    Cat('实时特效动画')
                    Cat('实时特效动画2')
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end
        end
    end
    -- 清除点数
    for i = 0, HitXYNum - 1 do
        local id = GetWarMap(HitXY[i][1], HitXY[i][2], 2);
        WAR.Person[id]["生命点数"] = nil;
        WAR.Person[id]["内力点数"] = nil;
        WAR.Person[id]["体力点数"] = nil;
        WAR.Person[id]["中毒点数"] = nil;
        WAR.Person[id]["解毒点数"] = nil;
        WAR.Person[id]["内伤点数"] = nil;
        WAR.Person[id]["Life_Before_Hit"] = 0;
        local mid = WAR.Person[i]["人物编号"]
        WAR.Miss[mid] = nil
    end
    -- 动画后恢复血条
    WAR.ShowHP = 1
end

Ct['乾坤反弹'] = function(i, wugong, hurt, ang, level)
    local id = WAR.Person[i]['人物编号']
    if WAR.Person[i]['死亡'] == false and JY.Person[id]['生命'] > 0 and hurt > 0 then
        if Curr_NG(id, 97) then
            local menu = {}
            local f1 = -1
            local f2 = -1
            local fs = 0
            local ng = 0
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]['死亡'] == false and DWPD(i, j) and MyFj(j) == false then
                    menu[#menu + 1] = j
                end
            end
            -- 概率50
            local jl = 50
            -- 减伤20
            local cfr = 0.7
            -- 张无忌反弹40%
            if match_ID(id, 9) then
                cfr = 0.6
            end
            -- 明尊反弹40%
            if match_ID(id, 641) then
                jl = 100
                cfr = 0.6
            end
            -- 逆转乾坤40%
            if match_ID(id, 641) then
                jl = 100
                cfr = 0.6
            end
            -- 学会九阳神功
            -- if Curr_NG(id,106) then
            --    cfr = 0.6
            --    jl = 80
            -- end         
            if PersonKF(id, 93) then
                cfr = 0.6
                jl = jl + 10
            end
            -- 逆转乾坤，必定反弹50%
            if WAR.NZQK == 1 then
                jl = 100
                cfr = 0.5
            end

            local str = '乾坤挪移'

            -- 概率触发
            if JLSD(0, jl, id) then
                -- 反伤返杀气
                fs = hurt * (1 - cfr)
                lib.Debug('乾坤反弹伤害===' .. fs)
                if JY.Person[id]['奇穴' .. 132] == 1 then
                    fs = fs * 2
                    lib.Debug('乾坤双倍反弹伤害===' .. fs)
                end
                ng = ang * (1 - cfr)

                -- 承受伤害
                hurt = hurt * cfr
                ang = ang * cfr

                -- 如果能够被反弹
                if MyFj(WAR.CurID) == false then
                    -- 有人可以弹
                    if #menu > 0 then
                        local n = math.random(#menu)
                        f1 = menu[n]
                        table.remove(menu, n)
                        Cat('伤害计算Def', f1, wugong, level, ng, fs, 1)
                        WAR.TXXS[WAR.Person[f1]['人物编号']] = 1
                    end

                    -- 有人可以反弹，张无忌之类的可以返2次
                    if #menu > 0 then
                        if match_ID(id, 9990) then
                            local n = math.random(#menu)
                            f2 = menu[n]
                            table.remove(menu, n)
                            Cat('伤害计算Def', f2, wugong, level, ng, fs, 1)
                            str = '乾坤挪移・双'
                            WAR.TXXS[WAR.Person[f2]['人物编号']] = 1
                        end
                    end
                end
                Set_Eff_Text(i, "特效文字2", "乾坤挪移");
            end
        end
    end
    return hurt, ang
end

function DWPD(a, d)
    if WAR.Person[a]['我方'] ~= WAR.Person[d]['我方'] then
        return true
    end
    return false
end

function G_NOT_ACT(pid)
    local act = true
    if WAR.PD['冻结'][pid] ~= nil then
        return false
    elseif WAR.PD['昏迷状态'][pid] ~= nil then
        return false
    end
    return act
end
-- 闪避命中一起计算
Ct['闪避'] = function(enemyid, wugong)

    local pid = WAR.Person[WAR.CurID]['人物编号']  --攻方人物ID
    local eid = WAR.Person[enemyid]['人物编号']   --防方人物ID
    local kf = JY.Person[eid]['主运内功']
    local ekfcj_ng = JY.Wugong[kf]['层级']
    -- 老顾0313
    local SB = Person_SB(eid) + FJPerson_SB(eid)
    local MZ = Person_MZ(pid) + FJPerson_MZ(pid)

    if WAR.PD['凌波微步闪避'][eid] ~= nil then
        SB = SB + WAR.PD['凌波微步闪避'][eid]
    end
    
    if WAR.PD['神行百变闪避'][eid] ~= nil then
        SB = SB * 2
    end
    if WAR.PD['菩提树'][eid] ~= nil then 
        SB = SB*ekfcj_ng*0.1
    end
    --醉意
    if WAR.PD['醉意'][eid] ~= nil then 
        local zy = SB*(WAR.PD['醉意'][pid] or 0)*0.05
        SB = SB + zy
    end

    -- 天子观气
    if WAR.PD['天子观气'][pid] ~= nil then
        MZ = MZ * 0.8
    end
    if WAR.PD['菩提树'][pid] ~= nil then 
        MZ = MZ*ekfcj_ng*0.1
    end
    -- 剑胆琴心
    if Pmiji(eid, 18) then
        local x, y = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
        local x1, y1 = WAR.Person[enemyid]['坐标X'], WAR.Person[enemyid]['坐标Y']
        local jdmz = limitX(11 - math.abs(x - x1) - math.abs(y - y1), 0, 10)
        lib.Debug('剑胆减少敌方命中' .. MZ * (jdmz / 20))
        MZ = MZ - MZ * (jdmz / 30)
    end
    if Pmiji(pid, 18) then
        local x, y = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
        local x1, y1 = WAR.Person[enemyid]['坐标X'], WAR.Person[enemyid]['坐标Y']
        local jdmz = limitX(11 - math.abs(x - x1) - math.abs(y - y1), 0, 10)
        lib.Debug('剑胆增加命中' .. MZ * (jdmz / 20))
        MZ = MZ + MZ * (jdmz / 30)
    end
    -- 引字诀
    if WAR.PD['引字决'][pid] ~= nil or WAR.PD['生死符'][pid] ~= nil then
        MZ = MZ * 0.5
    end
    -- 华山特性
    if WAR.ACT > 1 and JY.Person[pid]['门派'] == 9 then
        MZ = MZ * 1.2
    end
    --醉意
    if WAR.PD['醉意'][pid] ~= nil then 
        local zy = (WAR.PD['醉意'][pid] or 0)
        MZ = MZ*(100-zy*5)/100
    end 
    local SBJL = (1 - MZ / (MZ - JY.Person[eid]["轻功"] * 0.1 + SB)) * 100
    if SBJL > 50 then
        SBJL = 50
    end
    ------------------------------------闪避计算 命中计算--------------------------------------
    --无妄无视必中的闪避概率--
    if NeiGong_tx(eid,824) and JLSD(0,ekfcj_ng*7,eid) then 
        WAR.Dodge = 1
        WAR.PD['无妄'][eid] = 1
    end

    if match_ID(pid, 510) and WAR.PD['曲径通幽'][pid] == 1  then
        lib.Debug('必中=1，不计算闪避')
        -- 无情千手神针
    elseif match_ID(pid, 448) or match_ID(pid, 449)  then
        lib.Debug('必中=1，不计算闪避')
    elseif match_ID(pid, 498) and WAR.PD["小李飞刀"][pid] ~= nil  then
        lib.Debug('必中=1，不计算闪避')
    elseif WAR.JYZJ_FXJ == 1  then
        lib.Debug('必中=1，不计算闪避')
    elseif WAR.PD["必命中"][pid] ~= nil  then
        lib.Debug('必中=1，不计算闪避')
        -- 天剑 无视闪壁
    elseif (WAR.PD["天剑"][pid] ~= nil or WAR.SL23 == 1)  then
        lib.Debug('必中=1，不计算闪避')
        -- 独孤先手反击必中
    elseif WAR.Person[WAR.CurID]['先手反击'] == 1 and match_ID(pid, 592)  then
        lib.Debug('必中=1，不计算闪避')
    -- 剑心通明剑法必中    
    elseif WAR.PD['剑心通明'][pid] == 1  then
        lib.Debug('必中=1，不计算闪避')
        -- 慕容博斗转必中    
    elseif WAR.DZXY == 1 and match_ID(pid, 113)  then
        lib.Debug('必中=1，不计算闪避')
        -- 天罗地网  
    elseif WAR.PD['天罗地网'][pid] ~= nil  then
        lib.Debug('必中=1，不计算闪避')
        -- 岳云岳家枪法必命中
    elseif match_ID(pid, 568) and wugong == 200  then
        lib.Debug('必中=1，不计算闪避')
        -- 心念合一
    elseif WAR.PD["集中状态"][pid] ~= nil  then
        lib.Debug('必中=1，不计算闪避')
        -- 达尔巴死战
    elseif match_ID(pid, 160) and WAR.SZSD == eid  then
        lib.Debug('必中=1，不计算闪避')
        -- elseif WAR.PD['降龙・见龙在田'][pid] == 1 then	
        -- 招式概率必中
    elseif WAR.PD['招式必中'][pid] ~= nil  then
        lib.Debug('必中=1，不计算闪避')
        -- lib.Debug('触发招式必中')
    elseif WAR.PD['龙爪手'][pid] == 1 then
        lib.Debug('必中=1，不计算闪避')
    elseif match_ID(pid, 113) and WAR.DZXY > 0  then
        lib.Debug('必中=1，不计算闪避')
    else
        lib.Debug('没有必中，计算闪避')
        ------------独立计算闪避概率写在这里--------------------------    
        -- 逍遥御风
        if WAR.PD['逍遥御风闪避'][eid] ~= nil and WAR.PD['逍遥御风闪避'][eid] > 0 and WAR.Dodge ~= 1 then
            -- WAR.Person[enemyid]["特效动画"] = 153
            Set_Eff_Text(enemyid, 0, "逍遥御风・闪避")
            WAR.Dodge = 1
            WAR.PD['逍遥御风闪避'][eid] = WAR.PD['逍遥御风闪避'][eid] - 1
            if WAR.PD['逍遥御风闪避'][eid] < 1 then
                WAR.PD['逍遥御风闪避'][eid] = nil
            end
        end
        -- 内轻特效822 之一
        if WAR.PD['天机秘术'][eid] == 1 then
            WAR.Dodge = 1
            WAR.Person[enemyid]["特效文字2"] = "闪避"
            WAR.PD['天机秘术'][eid] = nil
            
        end
        -- 祖千秋，30%闪避
        if match_ID(eid, 88) or match_ID(eid, 9841) and WAR.Dodge ~= 1 then
            local jl = 30
            if JLSD(0, jl, eid) then
                WAR.Person[enemyid]["特效文字2"] = "酒神秘踪步"
                WAR.Dodge = 1
            end
        end

            -- 电饭锅，25%闪避
        if match_ID(eid, 515) and WAR.Dodge ~= 1 then
            local jl = 25
            if JLSD(0, jl, eid) then
                WAR.Person[enemyid]["特效文字2"] = "不粘锅"
                WAR.Dodge = 1
            end
        end
        if match_ID(eid, 9965) and WAR.Dodge ~= 1 then
            local jl = 5
            if WAR.PD['八酒杯'][eid] ~= nil then
                jl = jl + 30
            end
            if JLSD(0, jl, eid) then
                WAR.Dodge = 1
                WAR.Person[enemyid]["特效文字2"] = "八酒杯・酒神迷踪步"
            end
        end
        -- 段誉 40%闪避
        if match_ID(eid, 53) and WAR.TZ_DY == 1 and WAR.Dodge ~= 1 then
            local jl = 40
            if JLSD(0, jl, eid) then
                WAR.Person[enemyid]["特效文字2"] = "休迅飞凫 飘忽若神"
                WAR.Dodge = 1
            end
        end
            -- 白驹过隙
        if match_ID(eid, 9907) then
            local sbjl = 15
            if JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 4 then
                sbjl = sbjl + 20
            elseif JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] / 2 then
                sbjl = sbjl + 10
            end
            if JLSD(0, sbjl, eid) and WAR.BJGJ == 0 then
                WAR.Dodge = 1
                if fjpd(WAR.CurID) == false and MyFj(WAR.CurID) == false then
                    WAR.BJGJ = 1
                end
            end
        end    
            -- 黄蓉奇门遁甲，紫色，30%闪避
        if WAR.Person[enemyid]["我方"] == true and
            GetWarMap(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], 6) == 4 and WAR.Dodge ~= 1 then
            local jl = 30
            if JLSD(0, jl, eid) then
                WAR.Dodge = 1
            end
        end
            -- 进阶泰山，使用后30时序内闪避
        if WAR.PD["十八盘"][eid] ~= nil and WAR.Dodge ~= 1 then
            local jl = 20
            if JLSD(0, jl, eid) then
                WAR.Person[enemyid]["特效文字2"] = "峻岭横空"
                WAR.Dodge = 1
            end
        end
            -- 李白，使用后30时序内闪避
        if WAR.PD["身藏身与名"][eid] ~= nil and WAR.Dodge ~= 1 then
            local jl = 50
            if JLSD(0, jl, eid) then
                WAR.Person[enemyid]["特效文字2"] = "深藏身与名"
                WAR.Dodge = 1
            end
        end

        -- 主角 特系，初始15%闪避，每个奇门练到极，增加5%闪避
        if JY.Base["标准"] == 5 and eid == 0 and WAR.Dodge ~= 1 then
            local gctj = 15
            for i = 1, JY.Base["武功数量"] do
                if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 5 and JY.Person[0]["武功等级" .. i] >=
                    900 then
                    gctj = gctj + 5
                end
            end
            if gctj > 50 then
                gctj = 50
            end
            if JLSD(0, gctj, eid) then
                WAR.Person[enemyid]["特效文字1"] = "神机身法" -- 天机身法
                WAR.Dodge = 1
            end
        end
            -- 李沅芷 闪避
        if ZDGH(enemyid, 569) and WAR.Dodge ~= 1 then
            local jl = 15
            if JLSD(0, jl, eid) and WAR.Dodge ~= 1 then
                WAR.Person[enemyid]["特效文字1"] = "沅芷澧兰"
                WAR.Dodge = 1
            end
        end
        if ZDGH(enemyid, 9736) and WAR.Person[enemyid]['死亡'] == false and WAR.Dodge ~= 1 then
            lib.Debug('光环9736')
        end
        if match_ID(eid, 9934) and ((WAR.ACT > 1 and JLSD(0, 20, eid)) or (WAR.BJ == 1 and JLSD(0, 20, eid))) and  WAR.Dodge == 0 then
            WAR.Dodge = 1
            Set_Eff_Text(enemyid, "特效文字1", "七略.归元")
        end
        ------------根据闪避和命中值，计算人物闪避概率--------------------------    
        if WAR.Dodge ~= 1 and WAR.Person[enemyid]['死亡'] == false and WAR.Person[enemyid]["我方"] == false then
            -- 盲目状态，命中只有15%
            if WAR.PD["盲目状态"][pid]~= nil and  WAR.PD["盲目状态"][pid] > 0 then    --盲目判定
                MZ = MZ*0.15
                lib.Debug(JY.Person[pid]["姓名"] .. "处于盲目状态，命中" .. "=="..MZ)             
            end
            local jl = MZ / (MZ + SB) * 1.2   --命中和闪避计算后的命中概率计算
            local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) + math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
            if offset > 11 then
                offset = 11
            end
            local jl = jl * (100 - (offset - 1) * 3) / 100
            local mzjl = 100 - jl * 100 -- Rnd(1000)	
            

            if mzjl < 0 then
                mzjl = 0
            end
            if mzjl > 99 then
                mzjl = 99
            end
            lib.Debug('没有必中  开始触发' .. JY.Person[eid]["姓名"] .. "闪避" .. SB .. "/" ..JY.Person[pid]["姓名"] .. "命中" .. MZ .. "/" .. JY.Person[eid]["姓名"] .."闪避概率=" .. (math.modf(mzjl)) .. "%")
            if mzjl >= 0 and JLSD(0, mzjl, eid) then  
                WAR.Dodge = 1   --闪避
            end
        end
        -- 闪避
        if WAR.Dodge == 1 and eid ~= 449 then
            WAR.Miss[eid] = 1
            WAR.Person[enemyid]['闪避'] = true
            WAR.MissPd = 1
            -- 凌波微步闪避清除
            if WAR.PD['凌波微步闪避'][eid] ~= nil then
                WAR.PD['凌波微步闪避'][eid] = nil
            end
            --内轻特效1033
            if NeiGong_tx(eid,1033) then 
                WAR.PD['百劫'][eid] = (WAR.PD['百劫'][eid] or 0 ) + 1
                WAR.Person[enemyid]["特效文字0"] = "葵花百劫"
            end
            -- 白驹过隙
            if match_ID(eid, 9907) and WAR.BJGJ == 1 and WAR.DZXY ~= 1  then
                -- if fjpd(WAR.CurID) == false and MyFj(WAR.CurID) == false then
                WAR.Person[enemyid]["特效文字2"] = "白驹过隙"
                WAR.Person[enemyid]['反击'] = 1
                WAR.DZXYLV[eid] = 200
                PNGHH_nl(eid)
                WAR.BJGJ = 0
                lib.Debug('白驹过隙' .. '反击')
                -- end
            end
            -- 格挡反击
            if WAR.PD["格挡反击"][eid] ~= nil and WAR.PD["格挡反击"][eid] == 1  then
                WAR.Person[enemyid]["特效文字2"] = "格挡反击"
                if fjpd(WAR.CurID) == false and MyFj(WAR.CurID) == false then
                    WAR.Person[i]['反击'] = 1
                    WAR.DZXYLV[WAR.Person[enemyid]['人物编号']] = 200 -- 反击100%伤害
                    WAR.Person[enemyid]['反击武功'] = JY.Person[WAR.Person[enemyid]['人物编号']]['优先使用']
                    WAR.PD["格挡反击"][eid] = nil
                    lib.Debug('格挡反击' .. '反击')
                end
            end
            -- 无量禅震
            if match_ID(pid, 9994) then
                if WAR.PD['无量禅震'][pid] == nil then
                    WAR.PD['无量禅震'][pid] = {}
                    WAR.PD['无量禅震'][pid].n = 1
                    WAR.PD['无量禅震'][pid].s = 1
                else
                    if WAR.PD['无量禅震'][pid].s == nil then
                        WAR.PD['无量禅震'][pid].s = 1
                        WAR.PD['无量禅震'][pid].n = (WAR.PD['无量禅震'][pid].n or 0) + 1
                    end
                end
            end
            WAR.Dodge = 0
        end
    end
end

Ct['挪移闪避'] = function(wugong, x, y)
    local x0, y0 = WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y']
    local pid = WAR.Person[WAR.CurID]['人物编号']
    local kf = JY.Person[pid]['主运轻功']
    local kf1 = JY.Person[pid]['主运内功']
    local dkfcj_qg = JY.Wugong[kf]['层级']
    local dkfcj_qg = JY.Wugong[kf1]['层级']
    for i = 0, WAR.PersonNum - 1 do
        local mid = WAR.Person[i]['人物编号']
        local mkf = JY.Person[mid]['主运轻功']
        local mkf1 = JY.Person[mid]['主运内功']
        local mdkfcj_qg = JY.Wugong[mkf]['层级']
        local mdkfcj_ng = JY.Wugong[mkf1]['层级']
        if WAR.PD['锁足状态'][mid] == nil or WAR.PD["冻结"][mid] == nil then
            -- 灵犀一指
            if JY.Person[mid]["奇穴" .. 9] == 1 and i ~= WAR.CurID then
                if math.random(100) <= 20 then
                    local x1, y1 = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
                    for j = -1, 1 do
                        for k = -1, 1 do
                            SetWarMap(j + x1, k + y1, 4, 0)
                        end
                    end
                    WAR.Person[i]['特效文字0'] = '彩凤鸣岐'
                    WAR.Person[i]['特效动画'] = 154
                end
                lib.Debug('彩凤触发的人=' .. mid)
            -- 绝处逢生
            elseif Pmiji(mid, 22) and WAR.Person[i]['死亡'] == false and
                GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 and WAR.Person[WAR.CurID]['我方'] ~=
                WAR.Person[i]['我方'] then
                local jl = 15
                if match_ID(mid, 9892) then
                    jl = 15
                end
                if JLSD(0, jl, mid) then
                    local x1, y1 = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
                    for j = -1, 1 do
                        for k = -1, 1 do
                            SetWarMap(j + x1, k + y1, 4, 0)
                        end
                    end
                    WAR.Person[i]['特效文字0'] = '绝处逢生'
                    WAR.Person[i]['特效动画'] = 63
                end
            --我无
            elseif WAR.PD['我无'][mid] ~= nil and WAR.PD['我无'][mid] == 1 then 
                if WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[i]['我方'] and WAR.Person[i]["死亡"] == false and
                    GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 3 and offset2 <= 3 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 0)
                        WAR.Person[i]['特效文字0'] = '我无'
                        WAR.Person[i]['特效动画'] = 63
                    end
                end
            -- 玄冰界
            elseif WAR.PD['玄冰界'][mid] ~= nil and WAR.PD['玄冰界'][mid] >= 270 and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then
                local x1, y1 = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
                for j = -1, 1 do
                    for k = -1, 1 do
                        SetWarMap(j + x1, k + y1, 4, 0)

                    end
                end
            -- 凌空一羽
            elseif match_ID(mid, 754) and JLSD(0, 35, mid) then
                if WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[i]['我方'] and WAR.Person[i]["死亡"] == false and
                    GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 3 and offset2 <= 3 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 0)
                        WAR.Person[i]['特效文字0'] = '凌空一羽'
                        WAR.Person[i]['特效动画'] = 63
                    end
                end
            -- 天机宫弟子
            elseif JY.Person[mid]['门派'] == 6 and JLSD(0, 15, mid) then
                if WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[i]['我方'] and WAR.Person[i]["死亡"] == false and
                    GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 3 and offset2 <= 3 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 0)
                        WAR.Person[i]['特效文字0'] = '天机六爻'
                        WAR.Person[i]['特效动画'] = 63
                    end
                end
            end
            -- 内轻特效804
            if NeiGong_tx(mid, 804) then
                local jl = dkfcj_qg * 10
                local yd = dkfcj_qg + 1
                if WAR.Person[i]['死亡'] == false and GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) >   0 and i ~= WAR.CurID and JLSD(0, jl, mid) then
                    Cat('挪移', i, yd, 1)
                end
            end
            if WAR.PD['天机秘术'][mid] ~= nil and WAR.PD['天机秘术'][mid] == 3 then
                if WAR.Person[i]['死亡'] == false and  GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 and i ~= WAR.CurID then
                    Cat('挪移', i, 4, 1)
                    WAR.PD['天机秘术'][mid] = nil
                end
            end


           -- if Curr_NG(mid, 317) and WAR.QMWZ < 1 then
             --   local jl = 5
               -- if WAR.Person[i]['死亡'] == false and GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) >
                   -- 0 and i ~= WAR.CurID and JLSD(0, jl, mid) then
                    --Cat('奇门五转', i, 5, 1)
                --    WAR.QMWZ = WAR.QMWZ + 1
                --end
            --end
            -- 闪避
            if WAR.Person[i]['死亡'] == false and GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 and
                i ~= WAR.CurID then
                Cat('闪避', i, wugong)
            end

            -- 格挡
            if WAR.Person[i]['死亡'] == false and GetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4) > 0 and
                WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]['闪避'] == false then
                local PGD = Person_GD(mid) + FJPerson_GD(mid)
                if WAR.PD['格挡点数'][mid] ~= nil and WAR.PD['格挡点数'][mid]  > 0 then 
                    PGD = PGD + WAR.PD['格挡点数'][eid] 
                end
                if match_ID(mid, 459) and wugong == 26 then
                    PGD = PGD + 200
                end

                -- 真武七截阵增加格档
                if WAR.PD['真武七截阵'][mid] ~= nil then
                    PGD = PGD + 200
                end

                local jl = math.modf(PGD / 20)
                if WAR.PD['挑字决'][mid] == nil then
                    local gdpd = 0
                    if JLSD(0, jl, mid) then
                        gdpd = 1
                    --内轻特效827    
                    elseif NeiGong_tx(mid,827) and JLSD(0,mdkfcj_ng*10,mid) then 
                        gdpd = 1    
                    end
                    if WAR.PD["格挡状态"][mid] ~= nil and WAR.PD["格挡状态"][mid] > 0 then
                        gdpd = 1
                    end
                    -- 灵犀一指
                    if JY.Person[mid]["奇穴" .. 9] == 1 then
                        gdpd = 1
                    end
                    if gdpd == 1 then
                        WAR.Person[i]['特效动画'] = 196
                        WAR.PD["格挡"][mid] = 1
                        WAR.Person[i]['格挡'] = true
                        WAR.PD['格挡点数'][mid] = nil
                        -- lib.Debug('已经格挡 格挡值是=='..PGD)                                       
                    end
                end
            end
        end
    end
end

Ct['斗转'] = function(enemyid, wugong)
    local pid = WAR.Person[WAR.CurID]['人物编号']
    local eid = WAR.Person[enemyid]['人物编号']
    -- 斗转星移
    -- 50%几率发动，慕容复，慕容博必发动if fjpd(WAR.CurID) == false and MyFj(WAR.CurID) == false then
    if WAR.PD['恐惧状态'][eid] == nil and Pmiji(eid, 3) and MyFj(WAR.CurID) == false and JY.Person[eid]["体力"] > 10 and WAR.DZXY ~= 1 and WAR.Person[enemyid]["反击武功"] == -1 
        and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and JY.Person[eid]["生命"] > 0 then
        -- local gl = 0
        lib.Debug('斗转有用000' .. JY.Person[eid]['姓名'])
        local gl = 20 + (JY.Person[eid]['资质'] - 30) / 2
        -- gl = 25 + math.ceil(zz/2)
        if WAR.LQZ[eid] == 100 then
            gl = gl + 20
        end
        if match_ID(eid, 9882) then
            gl = 100
        end
        if fjpd(WAR.CurID) == false and fjpd(enemyid) == false and JLSD(0, gl, eid) then
            local dzlv = Xishu_sum(eid) - JY.Base["周目"] * 5 -- 标记修改
            local dzwz = nil
            -- 兵器值之和大于等于360出离合参商
            -- 慕容复，慕容博，天罡必出
            if dzlv >= 360 and (match_ID(eid, 9882) or (eid == 0 and JY.Base["标准"] == 6)) then
                local hm = 0
                -- 兵器值之和超过520，有几率出幻梦星辰反击
                -- 几率为兵器值之和-520，上限50%几率
                if dzlv > 520 then
                    local chance = limitX(dzlv - 520, 0, 50)
                    if JLSD(0, chance, eid) then
                        hm = 1
                    end
                end
                if hm == 1 then
                    dzwz = "幻梦星辰"
                    WAR.DZXYLV[eid] = 120
                else
                    dzwz = "离合参商"
                    WAR.DZXYLV[eid] = 110
                end
                -- 兵器值之和大于等于240出斗转星移
            elseif dzlv >= 240 then
                dzwz = "斗转星移"
                WAR.DZXYLV[eid] = 100
                -- 都不满足，则是北斗移辰
            else
                dzwz = "北斗移辰"
                WAR.DZXYLV[eid] = 90
            end
            if match_ID(eid, 9882) and WAR.DZXYLV[eid] < 110 then
                WAR.DZXYLV[eid] = 110
            end
            Set_Eff_Text(enemyid, "特效文字2", dzwz)
            if WAR.Person[enemyid]["特效动画"] == -1 then
                WAR.Person[enemyid]["特效动画"] = 93
            end
            if WAR.DZXYLV[eid] == 200 then
                wugong = JY.Person[eid]['优先使用']
            end
            WAR.Person[enemyid]["反击武功"] = wugong
            for i = 1, JY.Base['武功数量'] do
                if JY.Person[pid]['武功' .. i] == wugong then
                    local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1;
                    if level > 10 then
                        level = 11
                    end
                    WAR.PD['斗转招式名字'][eid] = CC.KFMove[wugong][WAR.WGZS][1]
                    WAR.PD['斗转招式'][eid] = WAR.WGZS
                    WAR.PD['斗转武功等级'][eid] = JY.Person[pid]['武功等级' .. i]
                    WAR.PD['斗转武功气攻'][eid] = get_skill_power(pid, wugong, level) * WAR.DZXYLV[eid] / 100
                    lib.Debug("斗转武功" .. JY.Wugong[wugong]['名称'] .. "。斗转武功等级" ..
                                  WAR.PD['斗转武功等级'][eid] .. "。 斗转武功气攻" ..
                                  WAR.PD['斗转武功气攻'][eid] .. '招式是' .. WAR.PD['斗转招式名字'][eid])
                    break
                end
            end
            lib.Debug('斗转武功' .. '反击')
        end
    elseif WAR.Person[enemyid]['反击'] == 1 then
        -- dzwz = "反击"
        -- WAR.DZXYLV[eid] = 200
    end
end
-- 战斗中加入新人物
function NewWARPersonZJ(id, dw, x, y, life, fx)
    WAR.Person[WAR.PersonNum]["人物编号"] = id
    WAR.Person[WAR.PersonNum]["我方"] = dw
    WAR.Person[WAR.PersonNum]["坐标X"] = x
    WAR.Person[WAR.PersonNum]["坐标Y"] = y
    WAR.Person[WAR.PersonNum]["死亡"] = life
    WAR.Person[WAR.PersonNum]["人方向"] = fx
    WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)
    SetWarMap(x, y, 2, WAR.PersonNum)
    SetWarMap(x, y, 5, WAR.Person[WAR.PersonNum]["贴图"])
    SetWarMap(x, y, 10, JY.Person[WAR.Person[WAR.PersonNum]["人物编号"]]['头像代号'])
    savetf(WAR.PersonNum)
    savewg(WAR.PersonNum)
	LoadFights(id,WAR.PersonNum) --适配新fight
    WAR.PersonNum = WAR.PersonNum + 1
    Health_in_Battle()
end

-- 适用于外功攻击类
Ct['tx'] = function(kf, s)
    -- kf = wugong 
    local zs = WAR.WGZS
    if zs == 0 then
        return 0
    end

    local pid = WAR.Person[WAR.CurID]['人物编号']
    local a = 0

    if CC.KFMove[kf] ~= nil then
        if CC.KFMove[kf][zs] ~= nil then
            if CC.KFMove[kf][zs].tx ~= nil then
                local k = CC.KFMove[kf][zs].tx
                if k[s] ~= nil then
                    local num = k[s].num
                    local gl = k[s].gl or 100
                    if JLSD(0, gl, pid) then
                        a = num
                    end
                end
            end
        end
    end
    return a
end

function zjgd(num, num2, flag)
    local n = 0
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]['死亡'] == false and WAR.Person[i]['格挡'] == true then
            local mid = WAR.Person[i]['人物编号']
            local xx, yy = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
            -- local x,y = WAR.Person[i]["坐标X"],WAR.Person[i]["坐标Y"]	   
            -- local x0 = WAR.Person[WAR.CurID]["坐标X"]
            -- local y0 = WAR.Person[WAR.CurID]["坐标Y"]
            -- local dx = WAR.Person[i]["坐标X"] - x0
            -- local dy = WAR.Person[i]["坐标Y"] - y0
            -- local rx = CC.XScale * (dx - dy) + CC.ScreenW / 2
            -- local ry = CC.YScale * (dx + dy) + CC.ScreenH / 2
            -- local hb = GetS(JY.SubScene, dx + x0, dy + y0, 4)*CONFIG.Zoom/100

            local kf = JY.Person[mid]['优先使用']
            local lx = 1
            local zsf = 0
            local zsnum = 0
            -- if 招架变量 then
            if kf > 0 then
                lx = JY.Wugong[kf]['武功类型']
                if lx > 5 then
                    lx = 5
                end
            end
            if JY.Person[mid]['出招动画帧数' .. lx] == 0 then
                for j = 1, 5 do
                    if JY.Person[mid]['出招动画帧数' .. j] ~= 0 then
                        zsnum = JY.Person[mid]['出招动画帧数' .. j]
                        break
                    end
                end
            else
                for j = 1, lx - 1 do
                    zsf = zsf + JY.Person[mid]['出招动画帧数' .. j]
                end
                zsnum = JY.Person[mid]['出招动画帧数' .. lx]
            end
            if num ~= nil and num2 ~= nil then
                if zsnum > 0 then
                    if num < zsnum and num < num2 then
                        WAR.Person[i]["贴图"] = (zsf * 4 + WAR.Person[i]["人方向"] * zsnum + num) * 2

                    elseif num >= num2 then
                        WAR.Person[i]["贴图"] = WarCalPersonPic(i)
                    end
                else
                    WAR.Person[i]["贴图"] = WarCalPersonPic(i)
                end
                SetWarMap(xx, yy, 5, WAR.Person[i]["贴图"])
            end
            if n < zsnum then
                n = zsnum
            end
            -- end
        end
    end
    return n
end

-- 战场时间天气显示
function GUWarTime()
    -- lib.Debug("GUWarTime()")

    ShowStatus()
    -- 比利
    local bx, by = CC.WX, CC.HY
    -- 文字大小
    local size = CC.DefaultFont * 0.6
    -- 文字大小2
    local size2 = CC.DefaultFont * 0.55
    -- 时间
    -- 时间
    local menu2 = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二"}
    local menu3 = {"初一", "初二", "初三", "初四", "初五", "初六", "初七", "初八", "初九", "初十",
                   "十一", "十二", "十三", "十四", "十五", "十六", "十七", "十八", "十九", "二十",
                   "廿一", "廿二", "廿三", "廿四", "廿五", "廿六", "廿七", "廿八", "廿九", "三十"}
    local menu4 = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二", "十三",
                   "十四", "十五", "十六", "十七", "十八", "十九", "二十", "廿一", "廿二", "廿三",
                   "廿四", "廿五", "廿六", "廿七", "廿八", "廿九", "三十", "三一", "三二", "三三",
                   "三四", "三五", "三六", "三七", "三八", "三九", "四十", "四一", "四二", "四三",
                   "四四", "四五", "四六", "四七", "四八", "四九", "五十"}
    local sc = {"子", "丑", "寅", "卯", "辰", "巳", "午", "未", "申", "酉", "戌", "亥"}
    local sc1 = {"一", "二", "三", "四"}
    local t = CC.Miao
    local t1, t2, t3, t4, t5 = CC.Shichen, CC.Day, CC.Month, CC.Year, 1 -- 时，日，月,年，刻
    local tx, ty = CC.ScreenW / 2.229, CC.ScreenH / 30.72

    local YY = menu4[t4]
    local MM = menu2[t3]
    local DD = menu3[t2]
    local HH = sc[t1]
    local MIN = sc1[t5]
    CC.Shichen = t1
    CC.Day = t2
    CC.Month = t3
    CC.Year = t4
    local Hwz = {"凌晨", "上午", "正午", "午后", "傍晚", "深夜"}
    if t1 == 3 then
        CC.Daytime = 1
    elseif t1 == 4 or t1 == 5 then
        CC.Daytime = 2
    elseif t1 == 6 or t1 == 7 then
        CC.Daytime = 3
    elseif t1 == 8 or t1 == 9 then
        CC.Daytime = 4
    elseif t1 == 10 then
        CC.Daytime = 5
    elseif t1 == 12 or t1 == 1 or t1 == 2 or t1 == 11 then
        CC.Daytime = 6
    end
    local Mmenu = {"春", "夏", "秋", "冬"}
    local Mwz = nil
    local scolor = C_WHITE
    if CC.Month == 1 or CC.Month == 2 or CC.Month == 3 then
        Mwz = Mmenu[1]
        scolor = M_SeaGreen
    elseif CC.Month == 4 or CC.Month == 5 or CC.Month == 6 then
        Mwz = Mmenu[2]
        scolor = C_RED
    elseif CC.Month == 7 or CC.Month == 8 or CC.Month == 9 then
        Mwz = Mmenu[3]
        scolor = C_ORANGE
    elseif CC.Month == 10 or CC.Month == 11 or CC.Month == 12 then
        Mwz = Mmenu[4]
    end
    local w1 = 0

    -- 天气
    if CC.weat > 0 and CC.WeatherCD > 0 then -- 如果有一个天气状态不是空值		
        CC.Weather[CC.weat][1] = CC.WeatherCD
        if CC.Weather[CC.weat][1] > 0 then
            lib.LoadPNG(91, 71 * 2, CC.ScreenW / 2 - CC.ScreenW / 17.5, CC.ScreenH / 200, 1)
            lib.LoadPNG(91, (CC.Weather[CC.weat][3]) * 2, CC.ScreenW / 2 - CC.ScreenW / 18.5, CC.ScreenH / 130, 1)
            DrawString(tx + w1, ty + size, CC.Weather[CC.weat][2], C_BLACK, size2)
        end
    end
    -- 天气
    lib.DrawStr(tx + CC.ScreenW / 42.5 + w1, ty - CC.ScreenH / 153.6, Mwz, scolor, size2 * 2,CONFIG.CurrentPath .. "FONT/2.ttf", 0, 0) -- 季节
    DrawString(tx + w1, ty, Hwz[CC.Daytime], C_BLACK, size2) -- 一天
    -- lib.LoadPNG(91, 130*2, CC.ScreenW/2, 0, 1)
    local st = MM .. "月" .. DD .. "日" .. HH .. "时"
    local stn = string.len(st) / 2
    local hsize = bx * 180 / stn
    lib.LoadPNG(91, 123 * 2, bx * 1268, by * 135, 1)
    draw3(st, bx * 1320, by * 245 - ((stn - 1) * hsize + size) / 2, C_CYGOLD, size2 * 1.3, nil, hsize)

end

-- 执行战斗，自动和手动战斗都调用
-- id战斗人物编号
-- wugongnum 使用的武功在位置
-- x,y为战斗场景坐标
function War_Fight_Sub(id, wugongnum, x, y)
    -------------------战斗初始设定---------------------
    WAR.Person[id]['特效动画'] = -1
    WAR.Person[id]['特效文字0'] = nil
    WAR.Person[id]['特效文字1'] = nil
    WAR.Person[id]['特效文字2'] = nil
    WAR.Person[id]['特效文字3'] = nil
    WAR.Person[id]['特效文字4'] = nil
    local pid = WAR.Person[id]["人物编号"]
    local kf = JY.Person[pid]['主运内功']
    local dkfcj_ng = JY.Wugong[kf]['层级']
    local level = KF_level(pid, kf)
    if WAR.PD['内伤状态'][pid] == nil then
        WAR.PD['内伤状态'][pid] = 0
    end
    local x0, y0 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
    local wugong = 0
    if wugongnum < 100 then
        wugong = JY.Person[pid]["武功" .. wugongnum]
    else
        -- 范围内目标
        local xznum = 0
        for i = 0, CC.WarWidth - 1 do
            for j = 0, CC.WarHeight - 1 do
                lib.GetKey()
                local effect = GetWarMap(i, j, 4)
                if 0 < effect then
                    local emeny = GetWarMap(i, j, 2)
                    if emeny > -1 then
                        if WAR.Person[emeny]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
                            JY.Person[WAR.Person[emeny]["人物编号"]]["生命"] > 0 then
                            xznum = xznum + 1;
                        end
                    end
                end
            end
        end
        local fj = "反击" -- 斗转错误
        wugong = wugongnum - 100
        wugongnum = 1
        for i = 1, JY.Base["武功数量"] do
            if xznum > 0 then
                if WAR.DZXYLV[pid] ~= nil and JY.Person[pid]["生命"] > 0 then -- 如果学习有斗转星移
                    wugongnum = i -- 记录斗转武功位置
                    lib.Debug('斗转有用3' .. JY.Person[pid]['姓名'])
                    break
                elseif WAR.Person[id]['反击'] > 0 and JY.Person[pid]["生命"] > 0 and WAR.DZXY ~= 1 then
                    if JY.Person[pid]['武功' .. i] == JY.Person[pid]['优先使用'] then
                        lib.Debug('反击有用2' .. JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名'])
                        wugongnum = i
                        break
                    end
                elseif WAR.Person[id]['反击武功'] > 0 and JY.Person[pid]["生命"] > 0 and WAR.DZXY ~= 1 then
                    if JY.Person[pid]['武功' .. i] == WAR.Person[id]['反击武功'] then
                        wugongnum = i
                        lib.Debug('反击有用2-1' .. JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名'])
                        break
                    end
                end
            end
        end
        if x ~= nil and y ~= nil then
            x = WAR.Person[WAR.CurID]["坐标X"] - x
            y = WAR.Person[WAR.CurID]["坐标Y"] - y
        end
        WarDrawMap(0)

        -- 斗转星移提示的文字
        if WAR.DZXYLV[pid] == 200 then
            fj = ""

        elseif WAR.DZXYLV[pid] == 120 then
            fj = string.format("%s发动幻梦星辰反击", JY.Person[pid]["姓名"])
        elseif WAR.DZXYLV[pid] == 110 then
            fj = string.format("%s发动离合参商反击", JY.Person[pid]["姓名"])
        elseif WAR.DZXYLV[pid] == 100 then
            fj = string.format("%s发动斗转星移反击", JY.Person[pid]["姓名"])
        elseif WAR.DZXYLV[pid] == 90 then
            fj = string.format("%s发动北斗移辰反击", JY.Person[pid]["姓名"])
        else
            fj = ""
        end
        Set_Eff_Text(id, "特效文字0", fj);
        WAR.DZXYLV[pid] = nil
        WAR.Person[id]["反击武功"] = -1
        -- WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = nil
    end

    local fightscope = JY.Wugong[wugong]["攻击范围"] -- 没啥用的玩意
    local kfkind = JY.Wugong[wugong]["武功类型"]
    local level = JY.Person[pid]["武功等级" .. wugongnum] -- 判断武功是否为极
    if WAR.DZXY > 0 then
        WAR.WGZS = WAR.PD['斗转招式'][pid]
    end
    if level == 999 then
        level = 11
    else
        level = math.modf(level / 100) + 1
    end
    WAR.WGWL = get_skill_power(pid, wugong, level)
    WAR.ShowHead = 0

    -- 防止以后不指定主角的情况下被斗转带出特效
    -- 九阳归0
    WAR.JYZS = 0
    -- 碧海归0
    WAR.LXBHZS = 0
    WAR.BHJTZ = 0

    local m1, m2, a1, a2, a3, a4, a5, a6 = refw(wugong, level) -- 获取武功的范围

    local movefanwei = {m1, m2} -- 可移动的范围
    local atkfanwei = {a1, a2, a3, a4, a5} -- 攻击范围
    if a6 == 0 then
        WAR.JYZS = 0;
        WAR.LXBHZS = 0;
        return 0
    end
    x, y = War_FightSelectType(movefanwei, atkfanwei, x, y, wugong)
    -- 取消时顺带恢复技能释放 九阳 碧海 招式
    -- 防止出现选择武功后取消的情况
    if x == nil then
        WAR.JYZS = 0;
        WAR.LXBHZS = 0;
        return 0
    end
    if WAR.Person[WAR.CurID]["贴图"] ~= WarCalPersonPic(WAR.CurID) then
        WAR.Person[WAR.CurID]["贴图"] = WarCalPersonPic(WAR.CurID)
        SetWarMap(x0, y0, 5, WAR.Person[WAR.CurID]["贴图"])
        -- WarDrawMap(0)
        Cat('实时特效动画')
        WarDrawMap(0)
        Cat('实时特效动画2')
        ShowScreen()
        lib.Delay(CC.BattleDelay)
    end
    -- 判断合击
    local ZHEN_ID = -1
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[WAR.CurID]["我方"] == WAR.Person[i]["我方"] and i ~= WAR.CurID and WAR.Person[i]["死亡"] ==
            false then
            local nx = WAR.Person[i]["坐标X"]
            local ny = WAR.Person[i]["坐标Y"]
            local fid = WAR.Person[i]["人物编号"]
            for j = 1, JY.Base["武功数量"] do
                if JY.Person[fid]["武功" .. j] == wugong then
                    if math.abs(nx - x0) + math.abs(ny - y0) < 9 then
                        local flagx, flagy = 0, 0
                        if math.abs(nx - x0) <= 1 then
                            flagx = 1
                        end
                        if math.abs(ny - y0) <= 1 then
                            flagy = 1
                        end
                        if x0 == nx then
                            flagy = 1
                        end
                        if y0 == ny then
                            flagx = 1
                        end
                        if between(x, x0, nx, flagx) and between(y, y0, ny, flagy) then
                            ZHEN_ID = i
                            WAR.Person[i]["人方向"] = 3 - War_Direct(x0, y0, x, y)
                            break
                        end
                    end
                end
            end
            if ZHEN_ID >= 0 then
                break
            end
        end
    end

    -- 攻击次数
    WAR.ATNum = 1

    -- 判定左右
    if Pmiji(pid, 4) and WAR.ZYHB == 0 and fjpd(WAR.CurID) == false then
        -- 判断左右，71-资质
        local zyjl = 25 + (71 - JY.Person[pid]['资质']) / 2
        -- 1-30资质+10
        if JY.Person[pid]['资质'] < 31 then
            zyjl = zyjl + 10
        end
        -- 周伯通100%
        if match_ID(pid, 64) then
            zyjl = 100
        end
        -- 郭靖80%
        if match_ID(pid, 55) then
            zyjl = 80
        end
        -- 小龙女70%
        if match_ID(pid, 59) or match_ID(pid, 9832) then
            zyjl = 70
        end

        -- 暴怒+20%
        if WAR.LQZ[pid] == 100 then
            zyjl = zyjl + 20
        end
        -- 周伯通支线完成后，主角+20%
        if pid == 0 and JY.Person[64]["品德"] == 80 then
            zyjl = zyjl + 20
        end

        -- 上限100%
        if zyjl > 100 then
            zyjl = 100
        end
        -- 斗转星移不触发左右
        if JLSD(0, zyjl, pid) and WAR.DZXY == 0 then
            WAR.ZYHB = 1
            -- 改到特效文字4显示
            Set_Eff_Text(WAR.CurID, 4, "左右互搏")
        end
    end

    -- 周伯通触发一次左右后，有几率根据资质追加第二次左右，畅想专属
    if match_ID(pid, 64) and WAR.ZYHB == 2 and WAR.ZHB == 0 then
        local zyjl = 80 - JY.Person[pid]["资质"]
        if zyjl < 0 then
            zyjl = 0
        end
        -- 斗转星移不触发左右
        -- 永无止境不触发左右
        if JLSD(0, zyjl, pid) and (WAR.DZXY == 0 or WAR.LJXD == 0) and fjpd(WAR.CurID) == false then
            WAR.ZYHB = 1
            WAR.ZHB = 1
            Set_Eff_Text(WAR.CurID, 4, "左右互搏")
        end
    end
    ------------------  连击率 -------------------------
    -- 无酒不欢：连击率用函数计算
    local LJ;

    LJ = Person_LJ(pid)
    -- 敌人连击+20%
    -- if WAR.Person[id]["我方"] == false then
    --	LJ = LJ + 10
    --
    -- 仙都传人
    if wugong == 37 then
        if match_ID(pid, 180) or match_ID(pid, 181) then
            LJ = LJ + 20
        end
    end
    -- 佛笑珈蓝
    if wugong == 194 then
        if match_ID(pid, 313) then
            LJ = LJ + 50
        end
    end
    if kfkind == 3 then
        -- 邱莫言
        if match_ID(pid, 457) then
            LJ = LJ + 100
        end
    end
    -- 五丁手
    if match_ID(pid, 182) then
        if JY.Wugong[wugong]['武功类型'] == 1 or JY.Wugong[wugong]['武功类型'] == 2 then
            LJ = LJ + 20
        end
    end
    -- 天衣无缝组合，刀法连击率+30%
    if kfkind == 4 and Pmiji(pid, 36) then
        LJ = LJ + 30
    end
    -- 定神门
    if (kfkind == 4 or kfkind == 3) and Pmiji(pid, 72) then
        LJ = LJ + 10
    end
    -- 少林寺武学
    if JY.Wugong[wugong]['门派'] == 1 then
        -- 少林高手
        for i = 461, 478 do
            if match_ID(pid, i) then
                LJ = LJ + 10
            end
        end
        -- 少林高手
        if match_ID(pid, 509) or match_ID(pid, 540) or match_ID(pid, 541) or match_ID(pid, 542) or match_ID(pid, 543) or
            match_ID(pid, 544) then
            LJ = LJ + 10
        end
        -- 少林长老
        for i = 479, 496 do
            if match_ID(pid, i) then
                LJ = LJ + 20
            end
        end
        if match_ID(pid, 572) or match_ID(pid, 653) or match_ID(pid, 655) or match_ID(pid, 656) then
            LJ = LJ + 20
        end
        if match_ID(pid, 653) or match_ID(pid, 655) or match_ID(pid, 656) then
            LJ = LJ + 30
        end
        -- 少林神僧
        if match_ID(pid, 597) or match_ID(pid, 598) or match_ID(pid, 599) or match_ID(pid, 658) then
            LJ = LJ + 40
        end
    end
    -- 武当派武学
    if JY.Wugong[wugong]['门派'] == 2 then
        -- 武当长老
        for i = 532, 538 do
            if match_ID(pid, i) then
                LJ = LJ + 20
            end
        end
        -- 武当高手
        if match_ID(pid, 570) or match_ID(pid, 726) then
            LJ = LJ + 10
        end
    end
    -- 日月神教武学
    if JY.Wugong[wugong]['门派'] == 4 then
        -- 日月长老
        if match_ID(pid, 231) or match_ID(pid, 232) or match_ID(pid, 233) or match_ID(pid, 235) or match_ID(pid, 236) or
            match_ID(pid, 237) or match_ID(pid, 238) or match_ID(pid, 239) or match_ID(pid, 240) then
            LJ = LJ + 20
        end
    end
    -- 明教武学
    if JY.Wugong[wugong]['门派'] == 5 then
        -- 五散人
        if match_ID(pid, 306) or match_ID(pid, 307) or match_ID(pid, 308) or match_ID(pid, 309) or match_ID(pid, 310) then
            LJ = LJ + 20
        end
        -- 魔道祖师
        if match_ID(pid, 641) then
            LJ = LJ + 40
        end
    end
    -- 丐帮武学
    if JY.Wugong[wugong]['门派'] == 8 then
        -- 丐帮长老
        if match_ID(pid, 271) or match_ID(pid, 272) or match_ID(pid, 273) or match_ID(pid, 274) or match_ID(pid, 275) or
            match_ID(pid, 276) or match_ID(pid, 277) or match_ID(pid, 278) or match_ID(pid, 279) or match_ID(pid, 280) or
            match_ID(pid, 723) then
            LJ = LJ + 20
        end
    end
    -- 嵩山派武学
    if JY.Wugong[wugong]['门派'] == 10 then
        -- 嵩山高手
        if match_ID(pid, 195) or match_ID(pid, 196) or match_ID(pid, 197) or match_ID(pid, 198) or match_ID(pid, 199) or
            match_ID(pid, 200) then
            LJ = LJ + 20
        end
    end
    -- 青城派武学
    if JY.Wugong[wugong]['门派'] == 11 then
        -- 青城四秀
        if match_ID(pid, 211) or match_ID(pid, 212) or match_ID(pid, 213) or match_ID(pid, 214) then
            LJ = LJ + 10
        end
        -- 青城长老
        if match_ID(pid, 218) or match_ID(pid, 219) then
            LJ = LJ + 20
        end
        -- 青城掌门
        if match_ID(pid, 220) then
            LJ = LJ + 40
        end
    end
    -- 衡山派武学
    if JY.Wugong[wugong]['门派'] == 12 then
        -- 衡山长老
        if match_ID(pid, 378) or match_ID(pid, 377) or match_ID(pid, 376) then
            LJ = LJ + 20
        end
        -- 衡山掌门
        if match_ID(pid, 379) then
            LJ = LJ + 40
        end
    end
    -- 恒山派武学
    if JY.Wugong[wugong]['门派'] == 13 then
        -- 恒山长老
        if match_ID(pid, 388) or match_ID(pid, 389) or match_ID(pid, 386) then
            LJ = LJ + 20
        end
        -- 恒山掌门
        if match_ID(pid, 21) or match_ID(pid, 387) then
            LJ = LJ + 40
        end
    end
    -- 泰山派武学
    if JY.Wugong[wugong]['门派'] == 14 then
        -- 泰山祖师
        if match_ID(pid, 201) then
            LJ = LJ + 50
        end
        -- 泰山长老
        if match_ID(pid, 206) or match_ID(pid, 207) or match_ID(pid, 208) or match_ID(pid, 209) or match_ID(pid, 210) then
            LJ = LJ + 20
        end
    end
    -- 血刀门武学
    if JY.Wugong[wugong]['门派'] == 17 then
        -- 血刀高手
        if match_ID(pid, 595) then
            LJ = LJ + 20
        end
    end
    -- 雪山派武学
    if JY.Wugong[wugong]['门派'] == 18 then
        -- 雪山掌门
        if match_ID(pid, 250) or match_ID(pid, 43) then
            LJ = LJ + 40
        end
        -- 雪山长老
        if match_ID(pid, 245) or match_ID(pid, 246) or match_ID(pid, 247) or match_ID(pid, 248) then
            LJ = LJ + 20
        end
    end
    -- 峨眉派武学
    if JY.Wugong[wugong]['门派'] == 19 then
        -- 峨眉掌门
        if match_ID(pid, 6) then
            LJ = LJ + 40
        end
        -- 峨眉掌门
        if match_ID(pid, 585) then
            LJ = LJ + 20
        end
    end
    -- 崆峒派武学
    if JY.Wugong[wugong]['门派'] == 20 then
        -- 崆峒掌门
        if match_ID(pid, 359) or match_ID(pid, 8) then
            LJ = LJ + 40
        end
        -- 崆峒长老
        if match_ID(pid, 358) or match_ID(pid, 357) or match_ID(pid, 167) or match_ID(pid, 168) then
            LJ = LJ + 20
        end
    end
    -- 昆仑派武学
    if JY.Wugong[wugong]['门派'] == 21 then
        -- 昆仑掌门
        if match_ID(pid, 7) then
            LJ = LJ + 40
        end
        -- 昆仑长老
        if match_ID(pid, 344) or match_ID(pid, 345) or match_ID(pid, 346) or match_ID(pid, 347) or match_ID(pid, 348) or
            match_ID(pid, 349) then
            LJ = LJ + 20
        end
    end
    -- 八卦门武学
    if JY.Wugong[wugong]['门派'] == 25 then
        -- 八卦高手
        if match_ID(pid, 739) then
            LJ = LJ + 20
        end
        -- 八卦长老
        if match_ID(pid, 722) or match_ID(pid, 737) or match_ID(pid, 740) or match_ID(pid, 741) then
            LJ = LJ + 20
        end
    end
    -- 密宗武学
    if JY.Wugong[wugong]['门派'] == 29 then
        -- 密宗高手
        if match_ID(pid, 644) or match_ID(pid, 645) or match_ID(pid, 753) then
            LJ = LJ + 20
        end
    end
    -- 金乌翠鸣
    if match_ID(pid, 249) then
        if wugong == 61 then
            LJ = LJ + 30
        end
    end

    -- 连击率上限100
    if LJ > 100 then
        LJ = 100
    end
    ------------------  连击次数 -------------------------	
    if JLSD(0, LJ, pid) then
        WAR.ATNum = 2
    end
    -- 宋缺天刀
    if match_ID(pid, 756) and wugong == 335 then
        WAR.ATNum = 2
    end

    -- 高连击武功
    local glj = {7, 2, 34, 37, 55, 57, 70, 77, 156}
    for i = 1, 8 do
        if JY.Person[pid]["武功" .. wugongnum] == glj[i] and JLSD(20, 75, pid) and WAR.ATNum < 2 then
            WAR.ATNum = 2
            break
        end
    end
    if match_ID(pid, 99) and wugong == 78 then
        WAR.ATNum = 2
    end
    -- 五岳剑法组合额外连击
    if wugong >= 30 and wugong <= 34 and JLSD(30, WuyueJFSL(pid) * 5 + 30, pid) and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    if WAR.PD["以眼还眼1"][pid] == 1 then
        WAR.ATNum = 2
        WAR.PD["以眼还眼1"][pid] = nil
    end
    -- 萧中慧夫妻必连
    if match_ID(pid, 77) and wugong == 62 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 装备鸳鸯刀，夫妻必连
    if (JY.Person[pid]["武器"] == 217 or JY.Person[pid]["武器"] == 218) and wugong == 62 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end
    -- 狄云，
    if match_ID(pid, 37) and PersonKF(pid, 114) then
        WAR.ATNum = 2
    end
    -- 水笙连城高连
    if (match_ID(pid, 589)) and wugong == 114 and JLSD(20, 75, pid) and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 枯荣一阳指高连
    if match_ID(pid, 102) and wugong == 17 and JLSD(20, 75, pid) and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 小龙女玉女素心剑高连
    if match_ID(pid, 59) and wugong == 139 and JLSD(20, 75, pid) and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 张三丰太极神功蓄力超过600，必连
    -- 适用任何武功 
    if WAR.PD["蓄气值"][pid] ~= nil then
        if WAR.PD["蓄气值"][pid] > 600 then
            WAR.ATNum = 2
        end
    end

    -- 余沧海觉醒后松风剑法必连击
    if (match_ID(pid, 24) or match_ID(pid, 9891)) and wugong == 27 and JY.Person[0]["六如觉醒"] > 0 and WAR.ATNum <
        2 then
        WAR.ATNum = 2
    end
    -- 仙剑神猿 剑法必连击
    if match_ID(pid, 185) or match_ID(pid, 575) and kfkind == 3 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end
    -- 宋缺天刀
    if match_ID(pid, 756) and wugong == 335 then
        WAR.ATNum = 2
    end
    -- 双剑合壁 必连
    if (wugong == 39 or wugong == 42 or wugong == 139) and Pmiji(pid, 23) and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 玉女十九剑 满怒必连
    if WAR.YLSJJ == 1 and WAR.LQZ[pid] == 100 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 蓝烟清：装备真武剑时使用太极剑法必连击
    if JY.Person[pid]["武器"] == 236 and wugong == 46 and WAR.ATNum < 2 then
        WAR.ATNum = 2;
    end
    -- 岳云 岳家枪法必连
    if match_ID(pid, 568) and wugong == 200 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end

    -- 三花聚顶掌必连击
    if wugong == 115 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end
    -- 擒龙手连击
    if wugong == 187 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end
    -- 猿公剑法必定连击
    if wugong == 188 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end
    -- 中平枪法必定连击
    if wugong == 70 and WAR.ATNum < 2 then
        WAR.ATNum = 2
    end
    -- 入魔
    if WAR.PD['入魔'][pid] ~= nil and WAR.PD['入魔'][pid] == 1 then
        if JLSD(0, 50, pid) and WAR.ATNum < 3 then
            WAR.ATNum = 3
        elseif WAR.ATNum < 2 then
            WAR.ATNum = 2
        end
    end

    -- 招式连击
    for i = 1, JY.Base["武功数量"] do
        local yxsy = JY.Person[pid]["优先使用"]
        if yxsy > 0 then
            for j = 1, #CC.KFMove[yxsy] do
                local zs = CC.WUGONGZS[i][j]
                local wugong = JY.Person[pid]["武功" .. i]
                if wugong == yxsy and WAR.WGZS == j then
                    if JY.Wugong[yxsy]["招式" .. j] >= 41 and JY.Wugong[yxsy]["招式" .. j] <= 204 then
                        local jl = JY.Wugong[yxsy]["层级"] * 2 + 20
                        if JLSD(0, jl, pid) and WAR.ATNum < 2 then
                            WAR.ATNum = 2
                        end
                    end
                end
            end
        end
    end
    if WAR.LQZ[pid] == 100 then
        local jl = 50
        if JLSD(0, jl, pid) then
            WAR.ATNum = 2
        end
    end
    -- 内轻特效903
    if NeiGong_tx(pid, 903) then
        local gl = dkfcj_ng * 25
        if JLSD(0, gl, pid) then
            WAR.ATNum = 2
        end
    end
    -- 内轻特效904
    if NeiGong_tx(pid, 904) then
        local gl = dkfcj_ng * 25
        if JLSD(0, gl, pid) then
            WAR.ATNum = 3
        end
    end
    -- 无酒不欢：黯然极意和三叠浪
    -- 杨过才能触发
    if wugong == 25 and level == 11 then
        local jl = 20;
        if match_ID(pid, 58) then
            jl = jl + 20
        end
        -- 通臂拳
        if JY.Person[pid]['奇穴' .. 36] == 1 then
            jl = jl + 10
        end
        -- 内伤大于30时，每点内伤增加1%几率
        if JY.Person[pid]["受伤程度"] > 30 then
            -- jl = jl + (JY.Person[pid]["受伤程度"]-30) 1018
            jl = jl + (WAR.PD['内伤状态'][pid] or 0) - 30
        end
        -- 生命少于70%时，每少一百生命，机率增加10%
        if JY.Person[pid]["生命"] < (JY.Person[pid]["生命最大值"] * 0.7) then
            jl = jl + math.ceil(((JY.Person[pid]["生命最大值"] * 0.7) - JY.Person[pid]["生命"]) / 10);
        end

        -- 几率大于0才触发
        if jl > 0 then
            -- 暴怒必触发
            if WAR.LQZ[pid] == 100 or JLSD(0, jl, pid) or match_ID(pid, 58) then
                WAR.ARJY = 1
                -- 三叠浪，限杨过
                if (match_ID(pid, 58) or match_ID(pid, 9935)) and JY.Person[pid]["资质"] > 30 and WAR.ATNum < 3 then
                    WAR.ATNum = 3;
                    Set_Eff_Text(id, "特效文字0", "黯然销魂.物我两忘.黯然三叠浪");
                elseif WAR.ATNum < 2 then
                    WAR.ATNum = 2;
                end
            end
        end
    end

    -- 九阴极意 
    if wugong == 11 and level == 11 and (Curr_NG(pid, 107) or match_ID(pid, 640)) then
        WAR.JYSZ = 1
        Set_Eff_Text(id, "特效文字0", "九阴神爪.无坚不摧");
        -- 三连黄衫女
        if match_ID(pid, 640) and WAR.JYSZ == 1 then
            if JY.Base["天书数量"] >= 7 and (JLSD(20, 60, pid) or WAR.LQZ[pid] == 100) then
                WAR.ATNum = 3
            else
                WAR.ATNum = 2
            end
        end
        -- 三连 黄赏
        if match_ID(pid, 9729) and WAR.JYSZ == 1 then
            if (JY.Base["天书数量"] >= 7 or not isteam(pid)) and (JLSD(20, 60, pid) or WAR.LQZ[pid] == 100) then
                WAR.ATNum = 3
            else
                WAR.ATNum = 2
            end
        end
        -- 万寿道藏
        if match_ID(pid, 9929) and WAR.JYSZ == 1 then
            if (JLSD(20, 60, pid) or WAR.LQZ[pid] == 100) then
                WAR.ATNum = 3
            else
                WAR.ATNum = 2
            end
        end
    end

    -- 三连天山双鹰
    if match_ID(pid, 311) or match_ID(pid, 312) then
        if wugong == 29 then
            WAR.ATNum = 3
        end
    end
    -- 我欲成仙
    if Pmiji(pid, 77) then
        if wugong == 8 or wugong == 14 or wugong == 201 or wugong == 202 then
            WAR.ATNum = 3
        end
    end
    -- 素质三连
    if Pmiji(pid, 14) and (JLSD(0, 50, pid) or WAR.LQZ[pid] == 100) then
        WAR.ATNum = 3
    end

    -- 乔峰
    if wugong == 26 then
        -- if match_ID(pid, 9755) or match_ID(pid, 539) or match_ID(pid, 9861) then
        -- 狂龙天征40%的机率三连击，怒气暴发时必三连
        -- 音箱提高三叠浪几率20%
        -- 丐帮弟子增加30%概率
        local ex_chance = 0
        if JY.Person[pid]["武器"] == 300 then
            ex_chance = JY.Thing[300]["装备等级"] * 5
        end
        if match_ID(pid, 9861) then
            ex_chance = ex_chance + 40
        end
        if JY.Person[pid]['门派'] == 8 then
            ex_chance = ex_chance + 30
        end
        if JY.Person[pid]["武器"] == 300 then
            ex_chance = ex_chance + 10
        end
        -- 通臂拳
        if JY.Person[pid]['奇穴' .. 36] == 1 then
            ex_chance = ex_chance + 10
        end
        if wugong == 26 and (JLSD(0, ex_chance, pid) or WAR.LQZ[pid] == 100) and WAR.ATNum < 3 then
            WAR.FS = 1
            WAR.ATNum = 3
            local color = M_Red
            local display = "六军辟易.奋英雄怒.降龙三叠浪"
            -- 装备音箱，暴怒有50%几率出四叠浪
            if JY.Person[pid]["武器"] == 300 and WAR.LQZ[pid] == 100 and JLSD(25, 75, pid) then
                WAR.ATNum = 4
                display = "虎啸龙吟.帝释天威.降龙四叠浪"
                color = C_GOLD
            end
            Set_Eff_Text(id, "特效文字0", display);
        end
        -- NPC乔峰回内
        if isteam(pid) == false then
            if JY.Person[pid]["内力"] < 1000 then
                JY.Person[pid]["内力"] = 1200 + math.random(100)
            end
        end
    end

    -- 桃花绝技，有40%几率三连击，暴怒必触发
    if (wugong == 12 or wugong == 18 or wugong == 38) and Pmiji(pid, 5) and WAR.ATNum < 3 then
        local jl = 30
        if WAR.LQZ[pid] == 100 then
            jl = 100
        end
        if JY.Person[pid]['门派'] == 22 then
            jl = jl + 30
        end
        if JLSD(0, jl, pid) then
            WAR.ATNum = 3
            Set_Eff_Text(id, "特效文字0", "桃花影落飞神剑，碧海潮生按玉箫");
        end
    end
    -- 君子剑
    if match_ID(pid, 19) and JLSD(0, 30, pid) and JY.Wugong[wugong]["武功类型"] == 3 then
        WAR.ATNum = 3
    end
    -- 华山特性
    if JY.Person[pid]['门派'] == 9 and JLSD(0, 30, pid) and JY.Wugong[wugong]["武功类型"] == 3 then
        WAR.ATNum = 3
    end
    -- 商宝震 八卦掌 标记修改
    if match_ID(pid, 9922) and wugong == 230 and WAR.BGD == 1 then
        WAR.ATNum = 3
        WAR.BGD = 0
        Set_Eff_Text(id, "特效文字0", "八卦掌法秘传・游龙八卦式");
    end

    -- 老顾0309
    if JY.Person[pid]["优先使用"] == 48 and WAR.WGZS == 6 and WAR.PD["辟邪连击"][pid] == nil then
        if JLSD(0, 50, pid) then
            WAR.ATNum = 4
        else
            WAR.ATNum = 3
        end
        WAR.PD["辟邪连击"][pid] = 1
        for i = 1, WAR.PersonNum do
            if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                WAR.PD["恐惧状态"][pid] = 1
            end
        end
    end

    -- 进阶太岳，连击时为三连击
    if (wugong == 34 or wugong == 374) and PersonKF(pid, 175) and WAR.ATNum == 2 then
        WAR.ATNum = 3
    end

    -- 成不忧，连击时为三连击
    if kfkind == 3 and (match_ID(pid, 141) or match_ID(pid, 9840)) and WAR.ATNum == 2 then
        WAR.ATNum = 3
    end

    -- 我欲成仙
    -- if WoYuCX(pid) and (wugong==8 or wugong==14 or wugong==201 or wugong==202) then
    --	WAR.ATNum = 3
    --	Set_Eff_Text(id,"特效文字0","我欲成仙");
    -- end

    -- 太虚剑意剑法50%几率三连击，
    if Curr_NG(pid, 152) and kfkind == 3 then
        local jl = 50
        if math.random(100) <= jl and WAR.ATNum < 3 then
            WAR.ATNum = 3
            Set_Eff_Text(id, "特效文字0", "三环套月");
        end
    end

    -- 招式加连
    for i = 1, JY.Base["武功数量"] do
        local yxsy = JY.Person[pid]["优先使用"]
        if yxsy > 0 then
            for j = 1, #CC.KFMove[yxsy] do
                local zs = CC.WUGONGZS[i][j]
                local wugong = JY.Person[pid]["武功" .. i]
                if wugong == yxsy and WAR.WGZS == j then
                    if JY.Wugong[yxsy]["招式" .. j] >= 231 and JY.Wugong[yxsy]["招式" .. j] <= 234 then
                        local jl = JY.Wugong[yxsy]["层级"] * 10
                        local ljnum = WAR.ATNum
                        if JLSD(0, jl, pid) then
                            ljnum = WAR.ATNum + 1
                        end
                        WAR.ATNum = ljnum
                    end
                end
            end
        end
    end

    -- 狄云赤心连城追加连击
    if (match_ID(pid, 37) or match_ID(pid, 9903)) and WAR.CXLC == 1 and WAR.CXLC_Count < 3 then
        WAR.ATNum = WAR.ATNum + 1
        WAR.CXLC_Count = WAR.CXLC_Count + 1
    end

    -- 风云再起
    if match_ID(pid, 9765) and (WAR.LQZ[pid] == 100 or JLSD(10, 50, pid)) then
        WAR.ATNum = WAR.ATNum + 1
    end

    -- 天刀九问 九歌
    if wugong == 335 then
        local jl = 30
        if WAR.PD['九歌'][pid] ~= nil and WAR.PD['九歌'][pid] > 0 then
            jl = WAR.PD['九歌'][pid] * 10
        end
        if JY.Person[pid]['奇穴' .. 48] == 1 then
            jl = jl + 10
        end

        if JLSD(0, jl, pid) then
            if WAR.PD['九歌'][pid] == nil then
                WAR.PD['九歌'][pid] = 0
            end
            if WAR.PD['九歌'][pid] < 3 then
                WAR.Person[id]["特效动画"] = 131
                WAR.ATNum = WAR.ATNum + 1
                WAR.PD['九歌'][pid] = WAR.PD['九歌'][pid] or 0 + 1
                if WAR.PD['九歌'][pid] < 2 then
                    WAR.PD['九歌'][pid] = 2
                end
                if WAR.PD['九歌'][pid] > 5 then
                    WAR.PD['九歌'][pid] = 5
                end
                lib.Debug('九歌==' .. WAR.PD['九歌'][pid])
                Set_Eff_Text(id, "特效文字0", "九歌")
            end
        end
    end

    -- 倚天连击
    if JY.Person[pid]["武器"] == 37 and JY.Thing[37]["装备等级"] == 6 and kfkind == 3 then
        local jl = 0;
        if JY.Person[pid]["御剑能力"] > 200 then
            jl = jl + (JY.Person[pid]["御剑能力"] * 0.1);
        end
        if jl > 0 then
            -- 暴怒必触发
            if WAR.LQZ[pid] == 100 or JLSD(0, jl, pid) then
                WAR.ATNum = WAR.ATNum + 1
                Set_Eff_Text(id, "特效文字0", "谁与争锋");
            end
        end
    end

    if match_ID(pid, 9934) and WAR.PD["七略连击"][pid] ~= nil and WAR.PD["七略连击"][pid] > 0 then
        WAR.ATNum = WAR.ATNum + WAR.PD["七略连击"][pid]
        WAR.PD["七略连击"][pid] = nil
    end
    -- 陆渐三十二身相 神鱼相，33%追加连击一次 
    if WAR.PD["三十二身像"][pid] ~= nil and WAR.SSESS4 < 1 and (WAR.LQZ[pid] == 100 or JLSD(33, 53, pid)) then
        local pd = false
        if inteam(pid) then
            if JY.Base["天书数量"] > 0 then
                pd = true
            end
        else
            pd = true
        end
        if pd == true then
            WAR.ATNum = WAR.ATNum + 1
            WAR.SSESS4 = WAR.SSESS4 + 1
            Set_Eff_Text(id, "特效文字2", "神鱼相");
        end
    end
    -- 内轻特效301
    if NeiGong_tx(pid, 301) then
        local gl = dkfcj_ng * level
        if JLSD(0, gl, pid) then
            WAR.ATNum = WAR.ATNum + 1
        end
    end
    WAR.ACT = 1
    WAR.SSESS4 = 0 -- 三十二身相
    WAR.TDLP = 0

    -- 斗转
    if WAR.DZXY == 1 then
        if WAR.DZXYLV[pid] ~= nil and WAR.DZXYLV[pid] ~= 120 then
            WAR.ATNum = 1
        end
        -- 慕容博两次，其他人一次
        if match_ID(pid, 9876) then
            if WAR.ATNum < 2 then
                WAR.ATNum = 2
            end
        end
    end

    -- 剑魔BOSS模式
    if match_ID(pid, 592) and Boss(WAR.CurID) then
        WAR.PD['独孤剑势'][pid] = WAR.PD['独孤剑势'][pid] or 1
        if WAR.PD['独孤剑势'][pid] ~= nil then
            if WAR.PD['独孤剑势'][pid] < 2 then
                WAR.ATNum = 5
            elseif WAR.PD['独孤剑势'][pid] < 4 then
                WAR.ATNum = 4
            elseif WAR.PD['独孤剑势'][pid] < 6 then
                WAR.ATNum = 3
            elseif WAR.PD['独孤剑势'][pid] < 8 then
                WAR.ATNum = 2
            else
                WAR.ATNum = 1
            end
        end
    end
    ------------------  单击 ------------------------------
    if JY.Wugong[wugong]['武功类型'] == 8 then
        WAR.ATNum = 1
        WAR.TWLJ = 2
    end
    -- 尼摩星必定单击
    if match_ID(pid, 159) then
        WAR.ATNum = 1
        WAR.TWLJ = 2
    end

    -- 释迦掷象功必定单击 修改标记
    if wugong == 357 then
        WAR.ATNum = 1
        WAR.TWLJ = 2
    end
    -- 内轻特效902
    if NeiGong_tx(pid, 902) then
        WAR.ATNum = 1
        WAR.TWLJ = 2
    end
    -- 陆天枢使用刀法必定单击
    if match_ID(pid, 94) and kfkind == 4 then
        WAR.ATNum = 1
        WAR.TWLJ = 2
    end

    -- 倚天密道，成昆必定单击
    -- 天外也不会连击
    if WAR.ZDDH == 237 and pid == 18 then
        WAR.ATNum = 1
        WAR.TWLJ = 2
    end

    local klj = Cat('tx', wugong, '连击')

    if WAR.ATNum < klj then
        WAR.ATNum = klj
    end

    local kf = wugong
    -------------------清零---------------------------    
    while WAR.ACT <= WAR.ATNum do
        wugong = kf
        if JY.Restart == 1 then
            break
        end
        lib.GetKey()

        if WAR.WS == 1 then -- 误伤
            WAR.WS = 0
        end

        if WAR.BJ == 1 then -- 暴击
            WAR.BJ = 0
        end

        if WAR.PD["先天罡气"][pid] ~= nil then
            WAR.PD["先天罡气"][pid] = nil
        end
        WAR.PD['鹤啸九天'][pid] = nil -- 标记修改
        WAR.PD['受想行识'][pid] = nil
        WAR.PD['亦复如是'][pid] = nil
        WAR.PD['虎啸龙吟'][pid] = nil
        WAR.PD['奇门内伤'][pid] = nil
        WAR.PD['奇门流血'][pid] = nil
        WAR.PD['奇门封穴'][pid] = nil
        WAR.PD['浩然罡气'][pid] = nil
        WAR.PD['以气运剪'][pid] = nil
        WAR.PD['野球拳'][pid] = nil
        WAR.PD['西瓜刀'][pid] = nil
        WAR.PD["金刚般若"][pid] = nil
        WAR.PD['雪花六出'][pid] = nil
        WAR.PD['降龙・亢龙有悔'][pid] = nil
        WAR.PD['降龙・震惊百里'][pid] = nil
        WAR.PD['降龙・见龙在田'][pid] = nil
        WAR.PD['黯然・饮恨吞声'][pid] = nil
        WAR.PD['黯然・六神不安'][pid] = nil
        WAR.PD['黯然・行尸走肉'][pid] = nil
        WAR.PD['黯然・穷途末路'][pid] = nil
        WAR.PD['黯然・倒行逆施'][pid] = nil
        WAR.PD['穿山虎铁臂神拳'][pid] = nil
        WAR.PD['龙破斩'][pid] = nil
        WAR.PD['龙爪手'][pid] = nil
        WAR.PD['火延'][pid] = nil
        WAR.PD['侵如火'][pid] = nil
        WAR.PD['绊字决'][pid] = nil
        WAR.PD['封字决'][pid] = nil
        WAR.PD['缠字决'][pid] = nil
        WAR.PD['挑字决'][pid] = nil
        WAR.PD['戳字决'][pid] = nil
        WAR.PD['曲夕烟隙'][pid] = nil
        WAR.PD['曲径通幽'][pid] = nil
        WAR.PD['万佛朝宗'][pid] = nil
        WAR.PD['九阴破体'][pid] = nil
        WAR.PD["必命中"][pid] = nil
        if WAR.DJGZ == 1 then -- 刀剑归真
            WAR.DJGZ = 0
        end
        WAR.NSFEWSS = 0
        if WAR.HQT == 1 then -- 霍青桐 杀体力
            WAR.HQT = 0
        end
        if WAR.CY == 1 then -- 程英 杀内力
            WAR.CY = 0
        end
        WAR.JYZJ_FXJ = 0
        WAR.DFMQ = 0 -- 大伏魔拳	
        WAR.NGJL = 0 -- 当前加力内功编号
        WAR.KHBX = 0 -- 葵花刺目
        WAR.LXZQ = 0
        WAR.LXYZ = 0
        WAR.GCTJ = 0
        WAR.ASKD = 0
        WAR.LXBR = 0
        WAR.JSYX = 0
        WAR.JLJG = 0
        WAR.BMXH = 0
        WAR.BMSGXL = 0
        WAR.DZTG_DZS = 0
        WAR.CQSX_WZSX = 0
        WAR.TD = -1
        WAR.TDnum = 0
        WAR.TZ_XZ = 0 -- 虚竹指令
        WAR.THYG = 0 -- 铁画银钩
        WAR.JGZ_DMZ = 0 -- 达摩掌
        WAR.LHQ_BNZ = 0 -- 般若掌
        WAR.WD_CLSZ = 0 -- 赤练神掌
        WAR.LHFSD = 0 -- 连环腐尸毒
        WAR.QZ_QXJF = 0 -- 七星剑法	
        WAR.BXXHSJ = 0 --
        WAR.LWSWD = 0 --	
        WAR.TXZQ = {} -- 太玄之轻清除记录
        WAR.HSHD = {} -- 黄赏气盾	
        WAR.DZZ = {} -- 三十二身相 大自在相 大自在清除记录
        WAR.FGPZ = {} --	
        WAR.JJJ = {} -- 将进酒清除记录
        CleanWarMap(4, 0) -- 全屏
        WAR.SJHB_G = 0
        WAR.L_TLD = 0 -- 装备屠龙刀特效，流血
        WAR.PJTX = 0 -- 玄铁剑配玄铁剑法，破尽天下
        WAR.YLSJJ = 0
        WAR.NZZ1 = 0
        WAR.JGSL = 0 -- 大金刚神力
        WAR.CXLC = 0 -- 狄云赤心连城
        WAR.YTLJ = 0 -- 倚天连击	
        WAR.FQY = 0 -- 风清扬无招胜有招
        WAR.GHQH = 0 -- 黄衫女广寒清辉	
        WAR.LXXZD = 0 -- 梁萧谐之道
        WAR.AJFHNP = 0 --
        WAR.YTML = 0 -- 毒王大招
        WAR.SLSS = 0 -- 梁萧 星罗散手	
        WAR.JSTG = 0 -- 天罡大招
        WAR.TXZZ = 0 -- 太玄之重
        WAR.MMGJ = 0 -- 盲目攻击
        WAR.CMGJ = 0 -- 盲目攻击		
        WAR.KHLH = 0
        WAR.JSAY = 0 -- 金蛇奥义
        WAR.QMJ = 0 -- 青蟒剑
        WAR.CZD = 0 -- 陈正德
        WAR.WDKTJ = 0 --
        WAR.HZGX = 0 -- 标记修改
        WAR.GHQH = 0 --	
        WAR.YQFSQ = 0 -- 一气化三清	

        WAR.QXWXJ = 0 -- 七弦无形剑 莫大	
        WAR.OYFXL = 0 -- 欧阳锋根据蛤蟆蓄力增加伤害
        WAR.LXXL = 0 -- 梁萧蓄力增加伤害	
        WAR.XHMGXX = 0
        WAR.XWTXX = 0 -- 向问天吸血
        WAR.XDLeech = 0 -- 血刀吸血量
        WAR.RMXX = 0 -- 入魔吸血 
        WAR.ZSXX = 0 -- 招式吸血 
        WAR.WYXLeech = 0 -- 韦一笑吸血量
        WAR.YZHLeech = 0 -- 云中鹤吸血量
        WAR.QZWDS = 0 -- 殷离吸血量
        WAR.YLXX = 0 -- 千蛛万毒手吸血	标记修改
        WAR.TMGLeech = 0 -- 天魔功吸内量
        WAR.BHGLeech = 0 -- 碧海吸血量	
        WAR.XHSJ = 0 -- 血河神鉴吸血量
        WAR.WXXX = 0
        WAR.YYHY = 0 -- 以眼还眼
        WAR.XDQX1 = 0 -- 血刀
        WAR.KMZWD = 0 -- 周伯通空明之武道
        WAR.LFHX = 0 -- 林朝英流风回雪
        WAR.YNXJ = 0 -- 夭矫空碧
        WAR.HXZYJ = 0 -- 会心之一击
        WAR.YYBJ = 0 -- 郭靖：有余不尽
        WAR.SEYB = 0
        WAR.BHJTZ = 0 --		
        WAR.MHSN = 0 --	
        WAR.KZJYBF = 0 --
        WAR.BJYPYZ = 0 --
        WAR.XMJDHS = 0

        WAR.BJYJF = 0 -- 碧海招式
        WAR.BHJTZ1 = 0
        WAR.BHJTZ2 = 0
        WAR.BHJTZ3 = 0
        WAR.BHJTZ4 = 0
        WAR.BHJTZ5 = 0
        WAR.BHJTZ6 = 0

        WAR.DSP_LM1 = 0 -- 六脉大招
        WAR.DSP_LM2 = 0
        WAR.DSP_LM3 = 0
        WAR.DSP_LM4 = 0

        WAR.NGXS = 0 -- 内功攻击的系数
        WAR.TJXS = 0
        WAR.TYJQ = 0 -- 阿青天元剑气
        WAR.WWWJ = 0
        WAR.HYYQ = 0
        WAR.LDJT = 0
        WAR.CXLZ = 0
        WAR.QBLL = 0 --
        WAR.SZXM = 0 --	
        WAR.BLCC = 0
        WAR.BLCC_1 = {}
        WAR.XMHSQ = 0
        WAR.HZD_1 = 0 -- 陆渐海之道，上善若水，
        WAR.HZD_2 = 0 -- 陆渐海之道，海纳百川		
        WAR.OYK = 0 -- 欧阳克灵蛇拳
        WAR.BJGJ = 0 -- 白驹过隙
        WAR.JYJS = 0 -- 九阴极盛
        WAR.DSWS = 0 -- 大蛇无双
        WAR.YTZ = 0 -- 游坦之 标记修改		
        WAR.HZJHS = 0 -- 虎爪绝户手
        WAR.DN = 0 -- 鹤笔翁
        WAR.YKDD = 0 -- 玄慈一空到底
        WAR.JQBYH = 0 -- 六脉：剑气碧烟横
        WAR.LPZ = 0 -- 林平之
        WAR.JXG_SJG = 0 -- 鲸息功 神鲸歌

        WAR.QQSH1 = 0 -- 琴棋书画之持瑶琴
        WAR.QQSH2 = 0 -- 琴棋书画之妙笔丹青
        WAR.QQSH3 = 0 -- 琴棋书画之倚天屠龙功

        WAR.CMDF = 0 -- 沧溟刀法
        WAR.ZWX = 0
        WAR.HTS = 0 -- 何铁手五毒随机2-5倍威力
        WAR.YZQS = 0 -- 一震七伤

        WAR.JJZC = 0 -- 九剑真传的4种主动攻击特效，攻击后会清0
        WAR.JMZL = 0

        WAR.ZWYJF = 0 -- 有剑诀的五岳剑法，无视绝对气防

        WAR.JuHuo = 0 -- 举火燎原
        WAR.LiRen = 0 -- 利刃寒锋
        WAR.FLHS1 = 0 -- 其疾如风
        WAR.FLHS2 = 0 -- 其徐如林
        WAR.FLHS3 = 0 -- 其徐如林
        WAR.FLHS5 = 0 -- 其徐如林
        WAR.FLHS4 = 0 -- 不动如山
        WAR.FLHS6 = 0

        WAR.LWX = 0 -- 李文秀的破气防特效
        WAR.LXZL10 = 0 -- 龙象之力暴怒，忽视绝对气防 
        WAR.XC_WLCZ = 0 --	
        WAR.YZG = 0
        WAR.XC_JJNP = 0
        WAR.PDJN = 0 -- 陈家洛庖丁解牛	
        WAR.L_QKDNY = {} -- 重新计算乾坤大挪移是否被反弹过
        WAR.TXXS = {} -- 特效点数显示
        WAR.RULAISZ = 0
        WAR.RULAISZ_1 = 0

        WarDrawAtt(x, y, atkfanwei, 3)
    ----------------------攻击特效统一写这里-----------------
        -- 内轻特效901
        if NeiGong_tx(pid, 901) and JLSD(0,dkfcj_ng*25,pid) then
            lib.Debug('触发901吸血0')
            WAR.PD['血魔吸血'][pid] = 1
            Set_Eff_Text(id, "特效文字1", "吸血")
        end

        if match_ID(pid, 9746) and JY.Wugong[wugong]['武功类型'] == 3  then
            WAR.PD['剑心通明'][pid] = 1
            Set_Eff_Text(id, "特效文字0", "剑心通明")
        end
        --傲寒六诀
        if match_ID(pid, 9948) and JY.Wugong[wugong]["武功类型"] == 4 then
            local jl = 30
            WAR.PD['傲寒六诀'][pid] = 1
        end
        -- 定乾坤
        if match_ID(pid, 9756) then
            WAR.PD["定乾坤"][pid] = 100
            WAR.Person[id]["特效动画"] = 198
            Set_Eff_Text(id, "特效文字3", "定乾坤")
        end   
        -- 天外，有33%几率多连击一次
        if Given_WG(pid, wugong) and JLSD(33, 66, pid) and WAR.TWLJ == 0 and WAR.ATNum < 2 then
            WAR.ATNum = WAR.ATNum + 1
            WAR.TWLJ = 1
        end 
        -- 	鲸息功碧海惊涛掌
        --if Curr_NG(pid, 180) then
        --内轻轻特效1034
        if NeiGong_tx(pid,1034) then 
            local pd = 0
            if wugong == 179 and JLSD(0, 40, pid) then
                pd = 1
            elseif match_ID(pid, 635) then
                pd = 1
            elseif JY.Person[pid]['奇穴' .. 87] == 1 then
                pd = 1
            elseif JLSD(0,dkfcj_ng*15,pid) then 
                pd = 1
            end
            if pd == 1 then
                local bh = math.random(6)
                if bh == 1 then
                    WAR.BHJTZ1 = 1
                    Set_Eff_Text(id, "特效文字1", "阴阳流");
                elseif bh == 2 then
                    WAR.BHJTZ3 = 1
                    Set_Eff_Text(id, "特效文字1", "生灭道");
                elseif bh == 3 then
                    Set_Eff_Text(id, "特效文字1", "漩涡劲");
                    WAR.ATNum = WAR.ATNum + 1
                elseif bh == 4 then
                    WAR.BHJTZ5 = 1
                    Set_Eff_Text(id, "特效文字1", "滴水劲");
                elseif bh == 5 then
                    WAR.BHJTZ2 = 1
                    Set_Eff_Text(id, "特效文字1", "滔天");
                elseif bh == 6 then
                    WAR.BHJTZ6 = 1
                    Set_Eff_Text(id, "特效文字1", "陷空力");
                end
            end
        end 
        --内轻特效800
        if NeiGong_tx(pid,800) and JLSD(0,dkfcj_ng*15,pid) then
            WAR.PD['意气素霓生'][pid] = 1
            Set_Eff_Text(id, "特效文字0", "意气素霓生");
        end 
        --内轻特效1039 太上忘情
        if NeiGong_tx(pid,1039) and JLSD(0,dkfcj_ng*15,pid) then
            local wq = math.random(3) 
            if wq == 1 then 
                WAR.PD['风流'][pid] = 1
                Set_Eff_Text(id, "特效文字0", "风流");
            elseif wq == 2 then 
                WAR.PD['火延'][pid] = 1
                Set_Eff_Text(id, "特效文字0", "火延");
            elseif wq == 3 then 
                WAR.PD['云翳'][pid] = 1
                --Set_Eff_Text(id, "特效文字0", "云翳");
            end    
        end
        -- 王重阳1 一气化三清
        if match_ID(pid, 9851) and (WAR.LQZ[pid] == 100 or JLSD(35, 85, pid)) then
            WAR.YQFSQ = 1
        end
        -- 陈达海青蟒剑
        if (match_ID(pid, 137) or match_ID(pid, 9849)) and wugong == 40 then
            WAR.QMJ = 1
        end
        -- 陈正德三分剑法
        if match_ID(pid, 311) and wugong == 29 then
            WAR.CZD = 1
        end
        -- 双剑合壁.攻击
        if Pmiji(pid, 23) and (wugong == 39 or wugong == 42 or wugong == 139) then
            WAR.SJHB_G = 1
        end
        -- 圣火神功
        if Curr_NG(pid, 93) and JY.Person[pid]["特殊兵器"] >= 200 then
            WAR.DHBUFF = 1
        end
        -- 白秀 雪花神剑
        if match_ID(pid, 9739) and (JLSD(20, 50 + JY.Base["天书数量"], pid) or WAR.LQZ[pid] == 100) and WAR.DZXY ~= 1 then
            WAR.BXXHSJ = 1
        end
        if match_ID(pid, 510) then
            if JLSD(0, 30, pid) then
                WAR.PD['曲径通幽'][pid] = 1
                Set_Eff_Text(id, "特效文字1", "曲径通幽")
                WAR.Person[id]["特效动画"] = 61
            end
        end
        -- 葵花秘法百分百刺目
        if NeiGong_tx(pid, 520) and JLSD(0, dkfcj_ng * 10, pid) then
            WAR.PD['刺目'][pid] = 1
            Set_Eff_Text(id, "特效文字1", "葵花刺目")
            WAR.Person[id]["特效动画"] = 6
        end
        -- 岳老三大剪刀
        if match_ID(pid, 44) and wugong == 75 and WAR.LQZ[pid] == 100 then
            WAR.DJD = 1
            local size = 60
            local x = CC.ScreenW / 2;
            local y = CC.ScreenH / 2;
            local offx = (#"【南海鳄神・大剪刀真传】") * size / 4
            local offy = size / 2
            for k = 1, 10 do
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                lib.Background(0, y - 50, CC.ScreenW, y + 50, 98)
                DrawString(x - offx, y - offy, "【南海鳄神・大剪刀真传】", C_GOLD, size);
                ShowScreen();
                lib.Delay(CC.BattleDelay)
            end
        end
        -- 欧阳克，暴怒使用雪山白驼掌，变为灵蛇拳
        if match_ID(pid, 61) and wugong == 9 and WAR.LQZ[pid] == 100 then
            WAR.OYK = 1
            Set_Eff_Text(id, "特效文字1", "气息紊乱")
        end
        -- 游坦之 使用冰蚕毒掌
        if (match_ID(pid, 48) or match_ID(pid, 9885)) and wugong == 120 then
            WAR.YTZ = 1
            Set_Eff_Text(id, "特效文字1", "千年冰蚕")
        end
        -- 鹤笔翁蓑羽凶鹤		
        if match_ID(pid, 9727) and WAR.LQZ[pid] == 100 then
            WAR.DN = 1
            Set_Eff_Text(id, "特效文字1", "此地可是白门楼")
        end
        -- 玄慈般若掌极意 一空到底
        if match_ID(pid, 9880) and kfkind == 1 and WAR.LQZ[pid] == 100 then
            WAR.LHQ_BNZ = 1
            WAR.YKDD = 1
            Set_Eff_Text(id, "特效文字1", "般若掌劲")
            WAR.PD["一空到底"][pid] = 10
        end
        if match_ID(pid, 9779) and JLSD(10, 40, pid) then
            WAR.THYG = 1
            Set_Eff_Text(id, "特效文字1", "银钩铁划")
        end
        -- 鲸息功 神鲸歌
        if Curr_NG(pid, 180) and JLSD(0, 30, pid) then
            WAR.JXG_SJG = 1
            Set_Eff_Text(id, "特效文字1", "神鲸歌")
        end
        -- 万佛朝宗	标记修改
        if match_ID(pid, 577) and WAR.DZXY ~= 1 then
            local pd = false
            if JLSD(20, 45, pid) then
                pd = true
            end
            if WAR.PD["万佛朝宗"][pid] ~= nil and WAR.PD["降临"][pid] >= 5 then
                pd = true
            end
            if pd == true then
                WAR.PD["万佛朝宗"][pid] = 1
                Set_Eff_Text(id, "特效文字0", "万佛朝宗");
                if WAR.PD["降临"][pid] >= 5 then
                    WAR.PD["降临"][pid] = 0
                end
            end
        end
        -- 仁者
        if JY.Base["标准"] == 7 and pid == 0 and JY.Person[pid]["品德"] == 120 then
            WAR.SEYB = 1
            Set_Eff_Text(id, "特效文字0", "善恶有报");
        end

        -- 陆无双 五毒
        if match_ID_awakened(pid, 580, 1) and (JLSD(20, 70, pid) or WAR.LQZ[pid] == 100) then
            WAR.LWSWD = 1
            Set_Eff_Text(id, "特效文字0", "五毒无双");
        end
        -- 文泰来 奔雷手
        if match_ID(pid, 151) and wugong == 191 and WAR.LQZ[pid] == 100 then
            WAR.LDJT = 1
            Set_Eff_Text(id, "特效文字0", "雷动九天");
        end
        -- 黄赏 万寿道藏，大伏魔拳
        if wugong == 342 and (JLSD(10, 30 + JY.Base["天书数量"], pid) or WAR.LQZ[pid] == 100) then
            WAR.DFMQ = 1
            WAR.WS = 1
            Set_Eff_Text(id, "特效文字0", "损余补足");
        end
        --宗师 神话无误伤
        if JY.Person[pid]['畅想分阶'] <= 2 then 
            WAR.PD['高手'][pid] = 1
        end
        -- 阿青，天元剑气
        if match_ID(pid, 9806) and kfkind == 3 then
            WAR.TYJQ = 1
            Set_Eff_Text(id, 0, '天元剑气')
        end
        -- 浩然罡气
        if WAR.PD['浩然正气'][pid] ~= nil and WAR.PD['浩然正气'][pid] > 0 then
            WAR.TYJQ = 1
            Set_Eff_Text(id, 0, '浩然罡气')
        end
        -- 天人合一
        if JY.Person[pid]['奇穴' .. 129] == 1 then
            if Curr_NG(pid, 104) or Curr_NG(pid, 221) then
                if WAR.PD['天人合一'][pid] == nil then
                    WAR.PD['天人合一'][pid] = 0
                end
                WAR.PD['天人合一'][pid] = WAR.PD['天人合一'][pid] + 1
                if WAR.PD['天人合一'][pid] > 49 then
                    WAR.PD['天人合一'][pid] = 49
                end
                Set_Eff_Text(id, 0, '天人合一')
            end
        end
        -- 西域奇毒
        if JY.Person[pid]['奇穴' .. 72] == 1 and wugong == 81 then
            WAR.DSWS = 1
            Set_Eff_Text(id, 1, '大蛇无双')
        end
        -- 盖世神拳
        if JY.Person[pid]['奇穴' .. 40] == 1 and JY.Wugong[JY.Person[pid]['优先使用']]['武功类型'] == 1 then
            WAR.PD['盖世神拳'][pid] = 1
        end
        -- 通臂拳 般若禅掌
        if WAR.PD['般若禅掌'][pid] ~= nil and WAR.PD['般若禅掌'][pid] > 0 then
            Set_Eff_Text(id, 0, '般若禅掌')
        end
        -- 绣花针，忽视绝对气防 
        if JY.Person[pid]["武器"] == 349 and JY.Thing[349]["装备等级"] == 6 then
            WAR.PD["绣花针"][pid] = 1
        end
        -- 灵犀一指
        if JY.Person[pid]["奇穴" .. 9] == 1 and JY.Wugong[wugong]['武功类型'] == 2 then
            WAR.PD['灵犀一指'][pid] = 1
            Set_Eff_Text(id, 0, '灵犀一指')
        end
        -- 内轻特效934
        if NeiGong_tx(pid, 934) and JLSD(0, dkfcj_ng * 20, pid) then
            WAR.PD['天罗地网'][pid] = 1
            -- Set_Eff_Text(id,1,'天罗地网')
        end

        -- 丐帮弟子，打狗诀
        if wugong == 80 and JY.Person[pid]['门派'] == 8 then
            local dgyjwz = {'缠字决', '绊字决', '封字决', '挑字决', '引字决'}
            local dgyj = math.random(#dgyjwz)
            local hh = math.random(1, 5)
            local dg = dgyjwz[dgyj]
            --WAR.PD['打狗要诀']['pid'] = dgyj
            WAR.PD[dg][pid] = hh
            Set_Eff_Text(id, "特效文字1", "打狗棒法要诀・" .. dg)
        end
        -- 虎爪绝户手
        if match_ID(pid, 9835) and wugong == 244 then
            WAR.HZJHS = 1
        end
        -- 一剑无血
        if match_ID(pid, 150) then
            WAR.PD["一剑无血"][pid] = 1
            Set_Eff_Text(id, 1, '一剑无血')
        end
        -- 立地成佛
        if match_ID(pid, 9815) and WAR.LQZ[pid] == 100 then
            WAR.PD["立地成佛"][pid] = 1
            Set_Eff_Text(id, 0, '立地成佛')
        end
        -- 陈家洛and JLSD(0,25,pid)
        if match_ID(pid, 75) then
            WAR.PD["减气"][pid] = 1
        end
        if match_ID(pid, 9781) and JY.Person[pid]["生命"] - JY.Person[pid]["生命最大值"] / 10 > 0 then
            WAR.PD["天魔解体"][pid] = 1
            Set_Eff_Text(id, "特效文字1", "以眼还眼")
        end
        if match_ID(pid, 9939) and Boss(WAR.CurID) then
            WAR.PD["毗婆舍那"][pid] = 1
        end

        -- 虎啸龙吟
        if Pmiji(pid, 38) and JY.Wugong[wugong]["武功类型"] == 2 then
            local jl = 20
            if wugong == 244 or wugong == 187 then
                jl = jl + 20
            end
            if WAR.LQZ[pid] == 100 then
                jl = jl * 2
            end
            local hx = math.random(2)
            if JLSD(0, jl, pid) then
                if hx == 1 then
                    WAR.PD["虎啸龙吟"][pid] = 1
                    -- WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 500
                    Set_Eff_Text(id, "特效文字2", "龙吟")
                end
                if hx == 2 then
                    WAR.PD["虎啸龙吟"][pid] = 2
                    Set_Eff_Text(id, "特效文字2", "虎啸")
                end
            end
        end
        -- 鹤啸九天 标记修改
        if match_ID(pid, 9914) and wugong == 347 then
            local jl = 40
            if WAR.LQZ[pid] == 100 then
                jl = jl * 2
            end
            if JLSD(0, jl, pid) then
                WAR.PD["鹤啸九天"][pid] = 1
                Set_Eff_Text(id, "特效文字2", "鹤鸣")
            end
        end
        -- 浩然罡气		
        if match_ID(pid, 9946) and kfkind == 6 and JLSD(0, 50, pid) then
            WAR.PD["浩然罡气"][pid] = 1
            Set_Eff_Text(id, "特效文字1", "浩然罡气")
        end
        -- 五六七 以气运剪 标记修改		
        if match_ID(pid, 9918) and wugong == 75 then
            WAR.PD["以气运剪"][pid] = 1
            Set_Eff_Text(id, "特效文字1", "以气运剪")
        end

        -- 般若金刚掌
        if (wugong == 22 or wugong == 289) and Pmiji(pid, 15) then
            WAR.PD["金刚般若"][pid] = 1
        end
        -- 混元功
        if match_ID(pid, 189) or (wugong == 306 and PersonKF(pid, 90)) or (Curr_NG(pid, 90) and JLSD(0, 50, pid)) then
            WAR.HYYQ = 1
            Set_Eff_Text(id, "特效文字1", "混元一气")
        end
        -- 七宝琉璃 标记修改
        if JY.Person[pid]["武器"] == 200 and JLSD(0, 50, pid) then
            WAR.QBLL = 1
            Set_Eff_Text(id, "特效文字1", "七宝琉璃")
        end
        -- 世尊降魔
        if Pmiji(pid, 20) then
            local ex_chance = 0
            if JY.Person[pid]["武器"] == 323 then
                ex_chance = JY.Thing[323]["装备等级"] * 2
            end
            if (wugong == 96 or wugong == 86 or wugong == 82 or wugong == 83) and
                (JLSD(20, 60 + ex_chance, pid) or WAR.LQZ[pid] == 100) then
                WAR.SZXM = 1
                Set_Eff_Text(id, "特效文字1", "世尊降魔")
            end
        end

        -- 宁中则 玉女十九剑
        if (match_ID(pid, 649) and kfkind == 3) or wugong == 303 then
            WAR.YLSJJ = 1
            Set_Eff_Text(id, "特效文字1", "玉女十九剑")
        end
        -- 宁中则 宁氏一剑
        if ((match_ID(pid, 649) and kfkind == 3) or wugong == 302) and (JLSD(20, 80, pid) or WAR.LQZ[pid] == 100) then
            WAR.NZZ1 = 1
            Set_Eff_Text(id, "特效文字1", "宁氏一剑・无双无对")
        end


        -- 无酒不欢：举火燎原，金乌+燃木+火焰刀，引燃效果，平时50%几率，暴怒必出
        -- 寇仲
        if ((wugong == 61 or wugong == 65 or wugong == 66) and Pmiji(pid, 19)) or
            (match_ID(pid, 578) and JY.Person[pid]["内力性质"] == 1 and JLSD(0, 50, pid)) then
            Set_Eff_Text(id, "特效文字1", "举火燎原")
            WAR.JuHuo = 1
        end
        -- 林殊概率引燃
        if match_ID(pid, 9745) and JLSD(20, 30, pid) then
            WAR.JuHuo = 1
        end
        -- 丁当，平时50%几率，暴怒必出
        if match_ID_awakened(pid, 581, 1) and wugong == 61 and JLSD(20, 40, pid) then
            Set_Eff_Text(id, "特效文字1", "举火燎原")
            WAR.JuHuo = 1
        end
        -- 无酒不欢：利刃寒锋，修罗+阴风+沧溟，冻结效果，平时50%几率，暴怒必出
        if (wugong == 58 or wugong == 174 or wugong == 153) and Pmiji(pid, 24) and JLSD(0, 50, pid) then
            Set_Eff_Text(id, "特效文字1", "利刃寒锋")
            WAR.LiRen = 1
        end
        -- 玄阴煞气
        if JY.Person[pid]['奇穴' .. 83] == 1 and Curr_NG(pid, 107) then
            WAR.LiRen = 1
        end
        -- 逍遥御风 
        if Pmiji(pid, 25) and JLSD(20, 70, pid) and
            (WAR.PD["逍遥御风"][pid] == nil or WAR.PD["逍遥御风"][pid] < 9) and WAR.YFCS < 3 and
            WAR.PD['逍遥御风闪避'][pid] == nil then
            WAR.YFCS = WAR.YFCS + 1
            WAR.PD["逍遥御风"][pid] = (WAR.PD["逍遥御风"][pid] or 0) + 1
            Set_Eff_Text(id, "特效文字0", "逍遥御风")
            if WAR.PD["逍遥御风"][pid] == 9 then
                WAR.PD["逍遥御风"][pid] = 11
                WAR.PD['逍遥御风闪避'][pid] = 15
                WAR.Person[id]["特效动画"] = 153
            end
        end
        -- 商宝震 八卦掌 标记修改
        if match_ID(pid, 9922) and wugong == 230 then
            WAR.BGZ = 1
        end

        -- 商宝震 八卦刀	标记修改
        if match_ID(pid, 9922) and wugong == 231 then
            WAR.BGD = 1
        end
        -- 主运太玄，太玄之重，不加怒
        if Curr_NG(pid, 102) and JLSD(20, 35 + math.modf(JY.Person[pid]["实战"] / 25), pid) and match_ID(pid, 39) ==
            false then
            WAR.TXZZ = 1
            Set_Eff_Text(id, "特效文字1", "太玄之重")
        end
        -- 一灯用一阳指，无明业火
        if match_ID(pid, 65) and wugong == 17 then
            Set_Eff_Text(id, "特效文字1", "无明业火")
        end
        -- 王重阳1，同归剑法
        if match_ID(pid, 129) and JLSD(20, 60, pid) then
            Set_Eff_Text(id, "特效文字1", "同归剑法")
        end
        -- 决胜千里
        if match_ID(pid, 9968) and JLSD(0, 20, pid) then
            if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 500 then
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 72, 1, "决胜千里", C_GOLD)
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                        WAR.PD["恐惧状态"][WAR.Person[j]["人物编号"]] = 2
                        WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 150
                        DrawTimeBar2()
                    end
                end
                AddPersonAttrib(pid, '体力', -5)
                AddPersonAttrib(pid,'内力',-500)
            end
        end
        -- 周伯通空明之武道使敌方不会护体，初始几率25%，每20点实战+1%几率
        if match_ID(pid, 9854)  then
            WAR.KMZWD = 1
            Set_Eff_Text(id, "特效文字1", "空明之武道")
        --内轻特效929    
        elseif NeiGong_tx(pid,929) and JLSD(0,dkfcj_ng*10,pid) then 
            WAR.KMZWD = 1
            Set_Eff_Text(id, "特效文字1", "破罡")
        end
        if JY.Wugong[wugong]["武功类型"] == 5 then
            local r = math.random(3)
            if r == 1 then
                WAR.PD["奇门内伤"][pid] = 1
            end
            if r == 2 then
                WAR.PD["奇门流血"][pid] = 1
            end
            if r == 3 then
                WAR.PD["奇门封穴"][pid] = 1
            end
        end
        -- 九剑真传，剑法主动攻击70%几率触发4种特效之一
        if Cat('九剑真传', pid, wugong) then
            local t = math.random(4)
            local wz = {"离剑式", "倒剑式", "撩剑式", "荡剑式"}
            WAR.JJZC = t
            Set_Eff_Text(id, "特效文字1", "九剑真传・" .. wz[t])
        end
        -- 剑魔再临，剑法主动攻击50%几率触发2种特效之一
        if Cat('剑魔再临', pid, wugong) then
            local t = math.random(2)
            local wz = {"天极剑渊", "破尽天下"}
            WAR.JMZL = t
            Set_Eff_Text(id, "特效文字1", "剑魔再临・" .. wz[t])
        end
        -- 琴棋书画：持瑶琴，不加怒
        if wugong == 73 and Pmiji(pid, 63) then
            WAR.QQSH1 = 1
            Set_Eff_Text(id, "特效文字1", "琴音悦耳")
            -- 50%几率触发清怒
            if JLSD(20, 70, pid) then
                WAR.QQSH1 = 2
                Set_Eff_Text(id, "特效文字1", "菩提清心")
            end
        end
        -- 琴棋书画：妙笔丹青，冰封
        if wugong == 142 and Pmiji(pid, 63) then
            -- 60%几率冰封
            if JLSD(20, 80, pid) then
                WAR.QQSH2 = 1
                Set_Eff_Text(id, "特效文字1", "画地为牢")
            end

            -- 30%几率大冰封
            if JLSD(30, 60, pid) then
                WAR.QQSH2 = 2
                Set_Eff_Text(id, "特效文字1", "江山如画")
            end
        end
        -- 琴棋书画：倚天屠龙功，50%几率出特效，伤害提高20%，必封穴
        if wugong == 84 and Pmiji(pid, 63) and JLSD(20, 70, pid) then
            WAR.QQSH3 = 1
            Set_Eff_Text(id, "特效文字1", "秉笔直书")
        end
        -- 梁萧 星罗散手，必封穴
        if match_ID(pid, 9732) then
            WAR.SLSS = 1
            Set_Eff_Text(id, "特效文字1", "星罗散手")
        end
        -- 连击伤害杀气不减
        -- 黄衫女必发动
        -- 内轻特效911
        if NeiGong_tx(pid, 911) and WAR.ACT > 1 then
            local jl = 30 + JY.Base["天书数量"] * 2
            if match_ID(pid, 640) then
                jl = jl + 20
            end
            if JLSD(0, jl, pid) then
                WAR.YNXJ = 1
                Set_Eff_Text(id, "特效文字1", "夭矫空碧")
            end
        end
        -- 萧秋水 剑气飞纵 连击伤害杀气不减
        if match_ID(pid, 9725) and (JY.Base["天书数量"] > 5 or inteam(pid) == false) then
            WAR.YNXJ = 1
            Set_Eff_Text(id, "特效文字1", "剑气飞纵")
        end

        -- 奇门DEBFU
        if JY.Wugong[wugong]["武功类型"] == 5 then
            local qm = math.random(4)
            WAR.PD["奇门DEBUF"][pid] = qm
        end
        local rfpd = false
        if match_ID(pid, 9973) or (match_ID(pid, 27) and isteam(pid) == false and WAR.ZDDH == 348) then
            if JLSD(10, 40, pid) then
                WAR.FLHS1 = 1
            end
        end


        -- 张三丰 万法自然，集气从500开始
        if (match_ID(pid, 9770) or match_ID(pid, 9820)) and JLSD(0, 70, pid) then
            WAR.ZSF = 1
            Set_Eff_Text(id, "特效文字1", "万法自然")
        end
        -- 陆渐大金刚神力
        if match_ID(pid, 497) and JLSD(0, 70, pid) and WAR.PD["金刚法相"][pid] ~= nil then
            WAR.JGSL = 1
            Set_Eff_Text(id, "特效文字1", "大金刚神力")
        end
        -- 谢逊指令 咆哮
        if match_ID(pid, 9768) then
            if JLSD(0, 25, pid) then
                if JY.Person[pid]["体力"] > 20 and JY.Person[pid]["内力"] > 3000 then
                    CurIDTXDH(WAR.CurID, 118, 1, "狮王咆哮", C_GOLD)
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] ==
                            false then
                            WAR.PD["混乱状态"][WAR.Person[j]["人物编号"]] = 2
                        end
                    end
                    JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
                    JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 2000
                end
            end
        end
        if ZHEN_ID >= 0 then
            local tmp_id = WAR.CurID
            WAR.CurID = ZHEN_ID
            WarDrawAtt(WAR.Person[ZHEN_ID]["坐标X"] + x0 - x, WAR.Person[ZHEN_ID]["坐标Y"] + y0 - y, atkfanwei, 3)
            WAR.CurID = tmp_id
        end
        Cat('神游太虚2')
        if wugong == 20 then
            if pid == 0 and JY.Person[170]["声望"] == 30 then
                Set_Eff_Text(id, "特效文字0", "百发百中穿心抓奶龙爪手");
                WAR.PD['龙爪手'][pid] = 1
            end
        end
        -- 穿山虎铁臂神拳
        if Pmiji(pid, 11) then
            local jgfmq = 0
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    jgfmq = jgfmq + 1
                end
            end
            if jgfmq >= 3 and math.random(10) < 4 then
                WAR.PD['穿山虎铁臂神拳'][pid] = 1
                Set_Eff_Text(id, "特效文字3", "穿山虎铁臂神拳")
            end
        end

        if JY.Person[pid]["武器"] == 43 and JY.Wugong[wugong]["武功类型"] == 4 then
            if JLSD(0, 30, pid) then
                Set_Eff_Text(id, "特效文字1", "龙破斩")
                WAR.PD['龙破斩'][pid] = 1
            end
        end
        kfkind = JY.Wugong[wugong]["武功类型"]
        -- 刀剑绝技
        if WAR.PD["刀剑绝技"][pid] ~= nil and WAR.PD["刀剑绝技"][pid] == 1 and WAR.ACT == 2 then
            WAR.Person[id]["特效动画"] = 119
            wugong = 44
            WAR.WGZS = 1

            local HDJYLJZS = {"刀剑绝技・苗剑・ 苏秦背剑", "刀剑绝技・苗剑・ 黄龙吐须",
                              "刀剑绝技・苗剑・ 白鹤舒翅", "刀剑绝技・苗剑・ 怀中抱月",
                              "刀剑绝技・苗剑・ 力劈华山"};
            local A = HDJYLJZS[math.random(5)];
            -- Set_Eff_Text(id,"特效文字0",A);
            TXWZ_BIG(A, C_RED, CC.FONT2)
            WAR.PD["刀剑绝技"][pid] = 2
        end


        -- 九阴极意连击文字
        if WAR.JYSZ == 1 and WAR.SYLJ == 0 and WAR.ACT > 1 then
            WAR.JYLJ = 1
            local color = M_DeepSkyBlue
            local n = {'二击', '三击', '四击', '五击'}
            local display = "九阴神爪.无坚不催."
            if WAR.ACT > 1 then
                display = display .. n[WAR.ACT - 1]
                Set_Eff_Text(id, "特效文字0", display);
            end
        end

        -- 内轻特效926
        if NeiGong_tx(pid, 926) then
            -- if PersonKF(pid,85) then
            local gl = (dkfcj_ng + 1) * 10
            -- 魔帝吸星必定触发
            if match_ID(pid, 9764) or match_ID(pid, 26) then
                gl = 100
            end
            local pd = false
            if JLSD(0, gl, pid) then
                pd = true
            end
            if pd == true then
                local wz = '北冥神功'
                if kf == 88 then
                    wz = '吸星大法'
                end
                if WAR.Person[id]["特效动画"] == -1 then
                    WAR.Person[id]["特效动画"] = math.fmod(85, 10) + 85
                end
                Set_Eff_Text(id, "特效文字2", "北冥神功");
                WAR.BMXH = 1

                -- 北冥神功升级
                for w = 1, JY.Base["武功数量"] do
                    if JY.Person[pid]["武功" .. w] < 0 then
                        break
                    end
                end
            end
        end
        -- 内轻特效927
        if NeiGong_tx(pid, 927) then
            local gl = (dkfcj_ng + 1) * 10
            if JLSD(0, gl, pid) then
                WAR.PD['吸体力'][pid] = 1
            end
        end
        -- 内轻特效928
        if NeiGong_tx(pid, 928) then
            local gl = (dkfcj_ng + 1) * 10
            if JLSD(0, gl, pid) then
                WAR.PD['吸怒气'][pid] = 1
            end
        end
        -- 内轻特效932
        if NeiGong_tx(pid, 932) then
            local gl = (dkfcj_ng + 1) * 10
            if JLSD(0, gl, pid) then
                WAR.PD['化内力'][pid] = 1
            end
        end
        -- 陈家洛庖丁解牛
        if match_ID(pid, 9856) and JLSD(20, 70, pid) then
            WAR.PDJN = 1
            Set_Eff_Text(id, "特效文字1", "庖丁解牛")
        end

        -- 九阴 飞絮劲
        if Curr_NG(pid, 107) and (JY.Person[pid]["内力性质"] == 0 or JY.Person[pid]["内力性质"] == 3) then
            local jl = 70
            if JLSD(0, jl, pid) or WAR.LQZ[pid] == 100 then
                WAR.JYZJ_FXJ = 1
                Set_Eff_Text(id, "特效文字1", "飞絮劲");
            end
        end

        -- 大周天功 大宗师
        if Curr_NG(pid, 190) or Curr_NG(pid, 85) then
            local jl = 50
            if JLSD(0, jl, pid) or WAR.LQZ[pid] == 100 then
                WAR.DZTG_DZS = 1
                Set_Eff_Text(id, "特效文字1", "大宗师");
            end
        end
        -- 其疾如风
        if WAR.FLHS1 == 1 then
            WAR.Person[id]["特效动画"] = 6
            Set_Eff_Text(id, "特效文字0", "其疾如风")
            WAR.PD['疾如风'][pid] = (WAR.PD['疾如风'][pid] or 0) + 1
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    WAR.Person[j].Time = WAR.Person[j].Time + 100
                end
                if WAR.Person[j].Time > 980 then
                    WAR.Person[j].Time = 980
                end
            end
        end
        -- 钻天虎身轻如燕
        if Pmiji(pid, 11) then
            local jgfmq = 0
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    jgfmq = jgfmq + 1
                end
            end
            if jgfmq >= 1 and math.random(10) < 4 then
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                        WAR.Person[j].Time = WAR.Person[j].Time + 100
                    end
                    if WAR.Person[j].Time > 980 then
                        WAR.Person[j].Time = 980
                    end
                end
                Set_Eff_Text(id, "特效文字3", "赞天虎身轻如燕")
            end
        end
        -- 	段思平 六脉神剑
        if wugong == 49 then
            local gl = math.modf(JY.Person[pid]["实战"] / 20)
            local jntg = 0
            local jhjy = 0
            local nkwj = 0
            local hxjy = 0
            local times = 1
            if match_ID(pid, 9893) then
                gl = 50
            end
            if match_ID(pid, 9881) then
                gl = gl + 20
            end
            if JLSD(0, 25 + gl, pid) then
                if WAR.WGZS == 3 then
                    jntg = 1
                elseif WAR.WGZS == 4 then
                    jhjy = 1
                elseif WAR.WGZS == 5 then
                    nkwj = 1
                elseif WAR.WGZS == 6 then
                    hxjy = 1
                end
            end
            -- 防御减30
            if jntg == 1 then
                WAR.DSP_LM1 = 1
                -- Set_Eff_Text(id,"特效文字1","奥义.剑逆天光");
                TXWZ_BIG("【六脉奥义.剑逆天光", C_RED, CC.FONT2)
            end
            -- 必灼烧
            if jhjy == 1 then
                -- Set_Eff_Text(id,"特效文字1","奥义.剑煌镜影");
                TXWZ_BIG("【六脉奥义.剑煌镜影", C_RED, CC.FONT2)
                WAR.DSP_LM2 = 1
                WAR.ATNum = WAR.ATNum + 1
            end
            -- 必爆击爆伤50%	
            if nkwj == 1 then
                -- Set_Eff_Text(id,"特效文字1","奥义.南柯万剑");
                TXWZ_BIG("【六脉奥义.南柯万剑", C_RED, CC.FONT2)
                WAR.BJ = 1
                WAR.DSP_LM3 = 1
            end
            -- 状态
            if hxjy == 1 then
                -- Set_Eff_Text(id,"特效文字1","奥义.皇玺剑印");
                TXWZ_BIG("【六脉奥义.皇玺剑印】", C_RED, CC.FONT2)
                WAR.DSP_LM4 = 1
            end
        end
        -- 野球拳
        if wugong == 109 then
            local gl = 0
            if isteam(pid) then
                gl = math.modf(JY.Person[pid]["实战"] / 20)
            else
                gl = 25
            end
            if JLSD(0, 25 + gl, pid) then
                local str = {'猜拳・拳崩如山', '猜拳・裁云剪水', '猜拳・星罗云布'}
                local a = math.random(3)
                WAR.PD['野球拳'][pid] = a
                Set_Eff_Text(id, "特效文字3", str[a])
            end
        end
        -- 西瓜刀
        if wugong == 111 then
            local gl = 0
            if isteam(pid) then
                gl = math.modf(JY.Person[pid]["实战"] / 20)
            else
                gl = 25
            end
            if JLSD(0, 25 + gl, pid) then
                local str = {'刀・迎风回浪', '刀・阴阳交错', '刀・草木成佛', '刀・天人五衰'}
                local a = math.random(4)
                if a < 4 then
                    WAR.PD['西瓜刀'][pid] = a
                else
                    WAR.PD['西瓜刀・天人'][pid] = 2
                end
                Set_Eff_Text(id, "特效文字3", str[a])
            end
            if WAR.PD['西瓜刀・残刀'][pid] == nil then
                WAR.PD['西瓜刀・残刀'][pid] = {}
                WAR.PD['西瓜刀・残刀'][pid][1] = 1
                WAR.PD['西瓜刀・残刀'][pid][2] = 50
            else
                WAR.PD['西瓜刀・残刀'][pid][1] = (WAR.PD['西瓜刀・残刀'][pid][1] or 0) + 1
                if WAR.PD['西瓜刀・残刀'][pid][1] > 20 then
                    WAR.PD['西瓜刀・残刀'][pid][1] = 20
                end
                WAR.PD['西瓜刀・残刀'][pid][2] = 50
            end
        end

        if wugong == 26 then
            WAR.XLwav = 1
        end
        if match_ID(pid, 9912) and JLSD(0, 50, pid) then
            WAR.JNTM = 1
            Set_Eff_Text(id, "特效文字3", "幻阴魔相")
        end

        -- 罗汉拳，易筋经变身，般若掌，60%几率，敌方必出
        if wugong == 1 and Curr_NG(pid, 108) then
            if JLSD(20, 80, pid) then
                WAR.LHQ_BNZ = 1
            end
        end

        -- 大力金刚掌，易筋经变身，达摩掌，60%几率，敌方必出
        if wugong == 22 and Curr_NG(pid, 108) then
            if JLSD(40, 100, pid) then
                WAR.JGZ_DMZ = 1
            end
        end
        -- 五毒神掌，李莫愁变赤练神掌 标记修改
        if wugong == 3 and (match_ID(pid, 161) or Curr_NG(pid, 220)) then
            WAR.WD_CLSZ = 1
            if match_ID(pid, 161) then
                local zs = {"问世间情是何物", "直教人生死相许"}
                Set_Eff_Text(id, "特效文字3", zs[math.random(2)])
            end
        end
        -- 萧秋水 天剑
        if match_ID(pid, 652) then
            if (JY.Base['畅想'] == 652 and CC.TX['天剑开启'] >= 3) or inteam(pid) == false then
                if JLSD(0, 30, pid) then
                    WAR.PD["天剑"][pid] = 1
                    Set_Eff_Text(id, "特效文字3", "天剑")
                end
            end
        end
        -- 连环腐尸毒 标记修改
        if wugong == 295 and (match_ID(pid, 46) or match_ID(pid, 9902) or WAR.LQZ[pid] == 100 or JLSD(30, 70, pid)) then
            WAR.LHFSD = 1
        end
        -- 丘处机 全真剑法学会先天功 变七星剑法
        if wugong == 39 and match_ID(pid, 68) and PersonKF(pid, 100) then
            WAR.QZ_QXJF = 1
        end

        -- 六脉神剑，50%几率剑气碧烟横
        if wugong == 49 then
            local jl = 50
            if PersonKF(pid, 207) then
                jl = jl + 10
                if JLSD(20, jl, pid) or match_ID(pid, 499) then
                    WAR.JQBYH = 1
                    Set_Eff_Text(id, "特效文字3", "剑气碧烟横")
                end
            end
        end
        -- 陈正德鹰爪
        if wugong == 4 and match_ID(pid, 9811) then
            WAR.YZG = 1
            -- Set_Eff_Text(id, "特效文字1", "天山双鹰・秃鹰")
        end
        -- 钟灵 使用闪电貂，可偷窃，朱聪妙手空空也可
        -- 陆渐补天劫手  司空摘星
        local toudao = false
        if match_ID(pid, 90) and wugong == 113 then
            toudao = true
        elseif match_ID(pid, 131) and wugong == 116 then
            toudao = true
        elseif match_ID(pid, 497) or match_ID(pid, 579) then
            toudao = true
        elseif JY.Person[pid]['门派'] == 8 then
            toudao = true
        end
        if toudao == true then
            for i = 1, WAR.PersonNum - 1 do
                if WAR.Person[WAR.CurID]["我方"] == false then
                    WAR.TD = -2
                    -- 蓝烟清：挑战战斗不可偷东西
                    if WAR.ZDDH == 226 or WAR.ZDDH == 79 or WAR.ZDDH == 354 then
                        WAR.TD = -1;
                    end
                end
            end
        end
        -- 招式防御
        for i = 1, JY.Base["武功数量"] do
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 271 and JY.Wugong[yxsy]["招式" .. j] <= 274 then
                            local jl = JY.Wugong[yxsy]["层级"] * 20 + 20
                            if JLSD(0, jl, pid) then
                                WAR.WDRX = 1
                            end
                        end
                    end
                end
            end
        end

        -- 武当七侠使用太极拳或太极剑攻击后自动进入防御状态
        if wugong == 16 or wugong == 46 then
            if match_ID(pid, 9917) or JY.Person[pid]['门派'] == 2 then
                WAR.WDRX = 1
            end
        end
        -- 象形
        if JY.Person[pid]['奇穴' .. 87] == 1 then
            WAR.WDRX = 1
        end
        -- 空性使用龙爪手攻击后自动进入等待状态
        if match_ID(pid, 170) and wugong == 20 then
            WAR.SLGFH = 1
        end
        -- 林朝英，流风回雪
        if match_ID(pid, 605) and JLSD(20, 80, pid) then
            WAR.LFHX = 1
            if WAR.Person[id]["特效文字3"] ~= nil then
                WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] .. "・流风回雪"
            else
                WAR.Person[id]["特效文字3"] = "流风回雪"
            end
        end

        -- 进阶泰山，使用后30时序内闪避
        if (wugong == 31 or wugong == 371) and PersonKF(pid, 175) then
            WAR.PD["十八盘"][pid] = 30
        end
        -- 身藏身与名，使用后10时序内闪避
        if match_ID(pid, 9730) then
            WAR.PD["身藏身与名"][pid] = 30
        end

        -- 陆渐金刚法相
        if match_ID(pid, 497) then
            WAR.PD["金刚法相"][pid] = 100
        end
        -- 空闻使用大力金刚掌
        if match_ID(pid, 169) and wugong == 22 then
            War_ActupMenu()
        end
        -- 六如的风火雷
        if match_ID(pid, 9778) then
            local rate = limitX(math.modf(20 + (101 - JY.Person[pid]["资质"]) / 10 + JY.Person[pid]["实战"] / 50 +
                                              JY.Person[pid]["攻击力"] / 40 + JY.Person[pid]["武学常识"] / 10),
                0, 100)
            local low = 10
            local lr = 0
            local times = 1
            for i = 1, times do
                -- if JLSD(low, rate, pid) then
                local n = math.random(3)
                lr = n
                -- end
            end
            if lr == 1 then
                WAR.FLHS1 = 1
            end
            if lr == 2 then
                WAR.FLHS3 = 1
            end
            if lr == 3 and WAR.FLHS6 < 3 then
                -- 动如雷震
                WAR.Person[id]["特效动画"] = 6
                Set_Eff_Text(id, "特效文字2", "动如雷震")
                WAR.ATNum = WAR.ATNum + 1
                WAR.FLHS6 = WAR.FLHS6 + 1
            end
        end
        -- 程英，使用玉箫剑法，杀内力300
        if match_ID(pid, 63) and wugong == 38 then
            WAR.CY = 1
        end
    ---------------------多倍威力特效写这里-------------------
        -- 五毒神功 五毒神掌随机1-3倍威力 标记修改
        if Curr_NG(pid, 220) and wugong == 3 then
            WAR.HTS = math.random(1, 3)
        end
        -- 何铁手五毒随机2-5倍威力
        if (match_ID(pid, 83) or match_ID(pid, 9814)) and wugong == 3 then
            WAR.HTS = WAR.HTS + math.random(2, 5)
        end
        -- 周威信随机2-5倍威力
        if match_ID(pid, 612) and wugong == 206 then
            WAR.ZWX = math.random(2, 5)
        end
        -- 卓天雄随机3倍威力
        if match_ID(pid, 613) and wugong == 206 then
            WAR.ZWX = 3
        end
        -- 卓天雄随机3倍威力
        if match_ID(pid, 613) and wugong == 205 then
            WAR.ZWX = 2
        end
    --------------------无误伤特效统一写这里------------------------    
        --宗师，神话不会误伤
        if WAR.PD['高手'][pid] == nil and WAR.PD['高手'][pid] == 1 then 
            WAR.WS = 1
        end
        -- 喵姐 无误伤
        if match_ID(pid, 92) then
            WAR.WS = 1
        end
        -- 张三丰 无误伤
        if match_ID(pid, 5) then
            WAR.WS = 1
        end
        -- 欧阳锋 无误伤
        if match_ID(pid, 60) then
            WAR.WS = 1
        end

        -- 东方不败 无误伤
        if match_ID(pid, 27) then
            WAR.WS = 1
        end

        -- 扫地 无误伤
        if match_ID(pid, 114) then
            WAR.WS = 1
        end

        -- 阿青，越女无误伤
        if match_ID(pid, 604) and wugong == 156 then
            WAR.WS = 1
        end

        -- 剑仙剑魔战，独孤无误伤
        if match_ID(pid, 592) and WAR.ZDDH == 291 then
            WAR.WS = 1
        end

        -- 乔峰，郭靖，洪七公，使用降龙十八掌 无误伤
        if (match_ID(pid, 50) or match_ID(pid, 539) or match_ID(pid, 55) or match_ID(pid, 69)) and wugong == 26 then
            WAR.WS = 1
        end

        -- 萧中慧 骆冰使用夫妻刀法 无误伤
        if (match_ID(pid, 77) or match_ID(pid, 154)) and wugong == 62 then
            WAR.WS = 1
        end

        -- 令狐冲 二觉之后，使用独孤九剑 无误伤
        if match_ID_awakened(pid, 35, 2) and wugong == 47 then
            WAR.WS = 1
        end

        -- 玉女素心剑 无误伤
        if wugong == 139 then
            WAR.WS = 1
        end

    --------------------增加气攻和增加气攻的特效写这里----------------------
        local ng = 0
        lib.Debug('内功加力气攻初始计算'..' ng='..ng)

        -- 铜人阵，9个强力铜人，直接触发达摩掌
        if pid > 480 and pid < 490 then
            -- WAR.Person[id]["特效文字2"] = "易经筋加力"
            Set_Eff_Text(id, "特效文字2", "易经筋加力")
            ng = ng + 1200
            WAR.JGZ_DMZ = 1
            lib.Debug('易经筋加力'..' ng='..ng)
        end
        --计算主运内功加力
        if JY.Person[pid]["主运内功"] > 0 then
            local ng1 = 0
            for i = 1, JY.Base["武功数量"] do
                local kfid = JY.Person[pid]["武功" .. i]
                local kflvl = JY.Person[pid]["武功等级" .. i]
                if kflvl == 999 then
                    kflvl = 11
                else
                    kflvl = math.modf(kflvl / 100) + 1
                end
                if kfid == JY.Person[pid]["主运内功"] then
                    ng1 = get_skill_power(pid, kfid, kflvl)
                end
            end
            ng = ng + ng1
            local dh = {93, 91, 92}
            local dh1 = dh[WGns(JY.Person[pid]["主运内功"]) + 1]
            WAR.Person[id]["特效动画"] = dh1
            lib.Debug('计算主运内功加力'..' ng='..ng)
        end

        -- 张无忌 斗酒僧 补偿加力
        if match_ID(pid, 9) or match_ID(pid, 638) and WAR.NGJL == 0 and Curr_NG(pid, 106) then
            WAR.Person[id]["特效动画"] = math.fmod(106, 10) + 85
            -- WAR.Person[id]["特效文字2"] = "九阳神功加力"
            Set_Eff_Text(id, "特效文字2", "九阳神功加力")
            ng = ng + 1200
            lib.Debug('九阳神功加力'..' ng='..ng)
        end

        -- 天赋外功提高100点气攻
        if Given_WG(pid, wugong) then
            ng = ng + dkfcj_ng*100
            lib.Debug('天赋外功提高100点气攻'..' ng='..ng)
        end
        -- 碧海招式1 常规伤害
        -- if WAR.LXBHZS == 1 then
        -- ng = ng +200
        -- end
        -- 狼牙 天狼啸月


        -- 蒙哥，气攻+2000点
        if pid == 627 then
            ng = ng + 2000
            lib.Debug('蒙哥，气攻+2000点'..' ng='..ng)
        end

        -- 七宝琉璃
        if WAR.QBLL == 1 then
            ng = ng * 2
            lib.Debug('七宝琉璃'..' ng='..ng)
        end
        -- 论剑风清扬奖励
        if pid == 0 and CC.TX["风清扬奖励"] == 1 then
            ng = ng + 1000
            lib.Debug('风清扬奖励'..' ng='..ng)
        end
        -- 萧半和使用混元功增加1000气攻
        if match_ID(pid, 189) and wugong == 90 then
            ng = ng + 1000
            lib.Debug('萧半和使用混元功增加1000气攻'..' ng='..ng)
        end
        -- 乔峰侵略如火
        if  WAR.ZDDH == 348 then 
            if (match_ID(pid, 50) and not isteam(pid)  and JLSD(10, 50, pid)) then
                WAR.Person[id]["特效动画"] = 6
                Set_Eff_Text(id, "特效文字0", "侵略如火");
                ng = ng + 2000
                lib.Debug('侵略如火'..' ng='..ng)
            end
        end

        -- 乔峰侵略如火
        if (match_ID(pid, 9972) and JLSD(10, 50, pid)) or WAR.FLHS3 == 1 or
            (match_ID(pid, 50) and not isteam(pid) and WAR.ZDDH == 348 and JLSD(10, 50, pid)) then
            WAR.PD['侵如火'][pid] = 1
            WAR.Person[id]["特效动画"] = 6
            Set_Eff_Text(id, "特效文字0", "侵略如火");
            ng = ng + 2000
            lib.Debug('侵略如火'..' ng='..ng)
        end
        -- 阿紫曼珠沙华，每杀一个人+200气攻
        if match_ID(pid, 47) or match_ID(pid, 9886) then
            ng = ng + 200 * WAR.MZSH
            lib.Debug('阿紫曼珠沙华，每杀一个人'..' ng='..ng)
        end
        -- 天罡内功到极无误伤，50%几率发动天罡真气・
        if pid == 0 and JY.Base["标准"] == 6 and kfkind == 6 and level == 11 then
            WAR.WS = 1
            if JLSD(25, 75, pid) then
                Set_Eff_Text(id, 3, '天罡真气')
                ng = ng + JY.Wugong[wugong]["攻击力10"]
            end
            lib.Debug('几率发动天罡真气・'..' ng='..ng)
        end
        -- 腾龙剑
        if match_ID(pid, 724) then
            if kfkind == 3 then
                ng = ng + 300
            end
            lib.Debug('腾龙剑'..' ng='..ng)
        end

        -- 九阴极意1
        if wugong == 11 and (Curr_NG(pid, 107) or match_ID(pid, 640)) then
            local jy = 0
            ---黄衫50% 阴内其它40
            if WAR.JYSZ == 0 and (JY.Person[pid]["内力性质"] == 0 or JY.Person[pid]["内力性质"] == 3) and
                (JLSD(20, 60 + JY.Base["天书数量"] * 2, pid) or WAR.LQZ[pid] == 100) then
                jy = 1
                ng = ng + 1000
                WAR.WS = 1
                for i = 1, (level) / 2 + 1 do
                    for j = 1, (level) / 2 + 1 do
                        SetWarMap(x + i - 1, y + j - 1, 4, 1)
                        SetWarMap(x - i + 1, y + j - 1, 4, 1)
                        SetWarMap(x + i - 1, y - j + 1, 4, 1)
                        SetWarMap(x - i + 1, y - j + 1, 4, 1)
                    end
                end
                lib.Debug('九阴极意1'..' ng='..ng)
            end
        end

        if WAR.PD['野球拳'][pid] == 3 then
            ng = ng + 1000
            WAR.WS = 1
            for i = 1, (level) / 2 + 1 do
                for j = 1, (level) / 2 + 1 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('野球拳'..' ng='..ng)
        end
        -- 绝招
        if wugong == JY.Person[pid]["优先使用"] and WAR.WGZS == #CC.KFMove[JY.Person[pid]["优先使用"]] then
            ng = ng * 1.5
            WAR.WS = 1
            local mj = (level) / 3 + 2
            -- lib.Debug('mj= '..mj)
            for i = 1, mj do
                for w = 1, mj do
                    SetWarMap(x + i - 1, y + w - 1, 4, 1)
                    SetWarMap(x - i + 1, y + w - 1, 4, 1)
                    SetWarMap(x + i - 1, y - w + 1, 4, 1)
                    SetWarMap(x - i + 1, y - w + 1, 4, 1)
                end
            end
            lib.Debug('使用绝招'..' ng='..ng)
            -- WAR.LQZ[pid] =  WAR.LQZ[pid] - JZ_lqz(pid)
        end

        -- 使用降龙十八掌
        if wugong == 26 then
            local jy = 0
            local xljl = 0
            if PersonKF(pid, 204) then
                xljl = 0
            end
            -- 乔峰必出极意，洪七公，郭靖，拳主角40% 擒龙功15%
            -- if match_ID(pid, 50) or ((match_ID(pid, 69) or match_ID(pid, 55) or (pid == 0 and JY.Base["标准"] == 1)) and JLSD(30, 70+xljl, pid)) or (Curr_NG(pid,204) and JLSD(0,xljl*2,pid) then
            if match_ID(pid, 69) then
                xljl = xljl + 40
            end
            if pid == 0 and JY.Base["标准"] == 1 then
                xljl = xljl + 40
            end
            if match_ID(pid, 9865) then
                xljl = xljl + 40
            end
            if Curr_NG(pid, 204) then
                xljl = xljl + 15
            end

            if JLSD(0, 10 + xljl, pid) or match_ID(pid, 50) then
                WAR.PD['降龙・飞龙在天'][pid] = 1
                -- Set_Eff_Text(id, "特效文字3", XL18JY[math.random(8)])	
                local xlwz = XL18JY[math.random(8)]
                TXWZ_BIG(xlwz, C_RED, CC.FONT2)
                jy = 1
                ng = ng + 1000
                WAR.WS = 1
                for i = 1, (level) / 2 + 1 do
                    for j = 1, (level) / 2 + 1 do
                        SetWarMap(x + i - 1, y + j - 1, 4, 1)
                        SetWarMap(x - i + 1, y + j - 1, 4, 1)
                        SetWarMap(x + i - 1, y - j + 1, 4, 1)
                        SetWarMap(x - i + 1, y - j + 1, 4, 1)
                    end
                end
                lib.Debug('降龙・飞龙在天'..' ng='..ng)
            end
            -- 降龙招式
            if myrandom(15 + (level), pid) then
                if jy == 0 then
                    -- Set_Eff_Text(id, "特效文字3", XL18[math.random(6)])
                    ng = ng + 1500
                    for i = 1, (1 + (level)) / 2 do
                        for j = 1, (1 + (level)) / 2 do
                            SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1,
                                WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
                            SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1,
                                WAR.Person[WAR.CurID]["坐标Y"] + j * 2 - 1, 4, 1)
                            SetWarMap(WAR.Person[WAR.CurID]["坐标X"] + i * 2 - 1,
                                WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
                            SetWarMap(WAR.Person[WAR.CurID]["坐标X"] - i * 2 + 1,
                                WAR.Person[WAR.CurID]["坐标Y"] - j * 2 + 1, 4, 1)
                        end
                    end
                    lib.Debug('降龙招式'..' ng='..ng)
                end
            end
        end
        -- 双剑合壁，连击文字
        if Pmiji(pid, 23) and (wugong == 39 or wugong == 42 or wugong == 139) then
            Set_Eff_Text(id, "特效文字3", SJHBJFZS[math.random(10)])
            ng = ng + 800
            WAR.WS = 1
            lib.Debug('双剑合壁，连击文字'..' ng='..ng)
        end

        -- 玄冥极意，主角有40%几率触发，暴怒必出，玄冥二老必出
        if wugong == 21 and level == 11 then
            local gl = 40
            if pid == 0 and WAR.LQZ[pid] == 100 then
                gl = 100
            end
            if match_ID(pid, 647) or match_ID(pid, 648) then
                gl = 100
            end
            if JLSD(0, gl, pid) then
                ng = ng + 1000
                WAR.WS = 1
                Set_Eff_Text(id, "特效文字0", "『玄冥神掌・寒阴侵体』");
                for i = 1, 5 do
                    for j = 1, 5 do
                        SetWarMap(x + i - 1, y + j - 1, 4, 1)
                        SetWarMap(x - i + 1, y + j - 1, 4, 1)
                        SetWarMap(x + i - 1, y - j + 1, 4, 1)
                        SetWarMap(x - i + 1, y - j + 1, 4, 1)
                    end
                end
                lib.Debug('『玄冥神掌・寒阴侵体』'..' ng='..ng)
            end
        end

        -- 使用六脉神剑
        if wugong == 49 then
            local jl = 0
            -- 学会一阳指
            if PersonKF(pid, 17) then
                jl = jl + 30
            end
            if myrandom(level + jl, pid) or (match_ID(pid, 53) and myrandom(level + jl, pid)) then
                -- Set_Eff_Text(id, "特效文字3", LMSJ[math.random(6)])
                ng = ng + 1000
                if match_ID(pid, 53) then
                    WAR.LMSJwav = 1
                    WAR.WS = 1
                end
                lib.Debug('使用六脉神剑'..' ng='..ng)
            end
        end

        -- 狄云，神经照，追加气攻
        if match_ID(pid, 37) and wugong == 94 and level == 11 then
            -- WAR.Person[id]["特效文字3"] = "神照功・无影神拳"
            Set_Eff_Text(id, "特效文字3", "神照功・无影神拳")
            ng = ng + 800
            lib.Debug('神照功・无影神拳'..' ng='..ng)
        end

        -- 小昭，圣火，追加气攻
        if match_ID(pid, 66) and wugong == 93 and level == 11 then
            local zs = {"赤沙流虹降心火", "恍起未明净萦魂", "星引瀚光沙劫海",
                        "业火焚心无量尊"}
            -- WAR.Person[id]["特效文字3"] = zs[math.random(4)]
            Set_Eff_Text(id, "特效文字3", zs[math.random(4)])
            ng = ng + 800
            lib.Debug('小昭，圣火，追加气攻'..' ng='..ng)
        end
        -- 七星剑法
        if WAR.QZ_QXJF == 1 and match_ID(pid, 68) then
            ng = ng + 800
            Set_Eff_Text(id, "特效文字3", '七星剑法')
            -- 50%几率触发再次追加杀气
            if JLSD(20, 70, pid) then
                local zs = {"天枢", "天璇", "天玑", "天权", "玉衡", "开阳", "瑶光"}
                ng = ng + 800
                Set_Eff_Text(id, "特效文字1", '七星-' .. zs[math.random(7)])               
            end
            lib.Debug('七星剑法'..' ng='..ng)
        end
        -- 潇湘夜雨，追加气攻
        if match_ID(pid, 9890) and JLSD(0, 40, pid) then
            local zs = {"沧海一声笑", "滔滔两岸潮", "纷纷世上潮", "浮沉记今朝 "}
            Set_Eff_Text(id, "特效文字3", zs[math.random(4)])
            ng = ng + 800
            lib.Debug('潇湘夜雨，追加气攻'..' ng='..ng)
        end
        -- 玉堂飞燕
        if match_ID(pid, 9943) then
            ng = ng + JY.Person[pid]["轻功"] * 2
            lib.Debug('玉堂飞燕'..' ng='..ng)
        end

        -- 苗家剑法，为极，配合胡家刀法。 60%刀剑归真
        if wugong == 44 and level == 11 and JLSD(0, 60, pid) then
            if match_ID(pid, 9794) then
                Set_Eff_Text(id, "特效文字1", "归真合一.刀剑绝技")
                WAR.Person[id]["特效动画"] = 6
                WAR.DJGZ = 1
                ng = ng + 1000
                if WAR.ACT == 1 then
                    local HDJYZS = {"刀剑绝技・苗剑・怀中抱月", "刀剑绝技・苗剑・黄龙吐须",
                                    "刀剑绝技・苗剑・怀中抱月", "刀剑绝技・苗剑・苏秦背剑",
                                    "刀剑绝技・苗剑・太白醉酒"};
                    local djnum = math.random(5)
                    local display = HDJYZS[djnum];
                    WAR.Person[id]["特效动画"] = 119
                    WAR.PD["刀剑绝技"][pid] = 1
                    local Actn = math.modf(djnum/2)
                    WAR.ATNum = 2 + Actn
                    -- Set_Eff_Text(id,"特效文字0",display);
                    TXWZ_BIG(display, C_RED, CC.FONT2)
                end
            else
                if PersonKF(pid, 67) then
                    -- Set_Eff_Text(id, "特效文字1", "胡刀苗剑 归真合一")
                    TXWZ_BIG('【胡刀苗剑.归真合一】', C_RED, CC.FONT2)
                    WAR.Person[id]["特效动画"] = 6
                    WAR.DJGZ = 1
                    ng = ng + 1000
                end
            end
            lib.Debug('苗家剑法，为极，配合胡家刀法。'..' ng='..ng)
        end

        -- 胡家刀法，为极，配合苗家剑法。 60%刀剑归真、
        -- 胡一刀觉醒不需要
        if wugong == 67 and level == 11 and JLSD(0, 60, pid) then
            if match_ID(pid, 9794) then
                Set_Eff_Text(id, "特效文字1", "归真合一.刀剑绝技")
                WAR.Person[id]["特效动画"] = 6
                WAR.DJGZ = 1
                ng = ng + 1000
                if WAR.ACT == 1 then
                    local HDJYZS = {"刀剑绝技・胡刀・云龙三现", "刀剑绝技・胡刀・拜佛听经",
                                    "刀剑绝技・胡刀・沙鸥掠波", "刀剑绝技・胡刀・参拜北斗",
                                    "刀剑绝技・胡刀・八方藏刀式"};
                    local djnum = math.random(5)
                    local display = HDJYZS[djnum];
                    WAR.Person[id]["特效动画"] = 119
                    WAR.PD["刀剑绝技"][pid] = 1
                    local Actn = math.modf(djnum/2)
                    WAR.ATNum = 2 + Actn
                    -- Set_Eff_Text(id,"特效文字0",display);
                    TXWZ_BIG(display, C_RED, CC.FONT2)
                end
            else
                if PersonKF(pid, 44) then
                    Set_Eff_Text(id, "特效文字1", "胡刀苗剑 归真合一")
                    WAR.Person[id]["特效动画"] = 6
                    WAR.DJGZ = 1
                    ng = ng + 1000
                end
            end
            lib.Debug('胡一刀觉醒不需要'..' ng='..ng)
        end


        -- 破尽天下，增加2000点气攻
        if WAR.PJTX == 1 then
            ng = ng + 1000
            lib.Debug('破尽天下，增加2000点气攻'..' ng='..ng)
        end
        -- 绣花针	
        if WAR.PD["绣花针"][pid] ~= nil and WAR.PD["绣花针"][pid] > 0 then
            ng = ng + 800
            lib.Debug('绣花针'..' ng='..ng)
        end
        -- 大金刚神力，增加1200点气攻
        if WAR.JGSL == 1 then
            ng = ng + 800
            lib.Debug('大金刚神力，增加1200点气攻'..' ng='..ng)
        end

        -- 张家辉的隐身戒指
        if JY.Person[pid]["防具"] == 304 then
            local cd = 40
            if JY.Thing[304]["装备等级"] >= 5 then
                cd = 20
            elseif JY.Thing[304]["装备等级"] >= 3 then
                cd = 30
            end
            WAR.YSJZ = cd
        end

        -- 装备鸳鸯刀，5级开始，夫妻追加500气攻
        if JY.Person[pid]["武器"] == 217 and wugong == 62 and JY.Thing[217]["装备等级"] >= 5 then
            ng = ng + 500
            lib.Debug('装备鸳刀，5级开始，夫妻追加500气攻'..' ng='..ng)
        end

        if JY.Person[pid]["武器"] == 218 and wugong == 62 and JY.Thing[218]["装备等级"] >= 5 then
            ng = ng + 500
            lib.Debug('装备鸯刀，5级开始，夫妻追加500气攻'..' ng='..ng)
        end

        -- 五岳剑法组合，50%几率额外气攻+1000，暴怒必发动，学有五岳剑诀必发动
        if wugong >= 30 and wugong <= 34 and JLSD(20, WuyueJFSL(pid) * 10 + 20, pid) then
            local qg = 500
            -- 学会五岳剑诀，气攻再加500，无视绝对气防
            if PersonKF(pid, 175) then
                qg = qg + 500
                WAR.ZWYJF = 1
            end
            ng = ng + qg

            Set_Eff_Text(id, "特效文字3", "气贯五岳")
            lib.Debug('气贯五岳'..' ng='..ng)
        end
        -- 剑魔再临 
        if WAR.JMZL == 2 then
            ng = ng + 800
            lib.Debug('剑魔再临'..' ng='..ng)
        end

        --  
        if WAR.DSP_LM1 == 1 then
            ng = ng + 800
            lib.Debug('DSP_LM1'..' ng='..ng)
        end
        -- 琴棋书画：棋盘招式，额外杀气
        if wugong == 72 and Pmiji(pid, 63) then
            ng = ng + 800

            Set_Eff_Text(id, "特效文字3", "棋高一着")
            -- 50%几率触发再次追加杀气
            if JLSD(20, 70, pid) then
                ng = ng + 500
                Set_Eff_Text(id, "特效文字1", "星罗棋布")
            end
            lib.Debug('琴棋书画：棋盘招式，额外杀气'..' ng='..ng)
        end

        -- 沧溟刀法，30%几率，额外杀气，必定流血
        -- 刀主二次判定
        if wugong == 153 and (JLSD(30, 60, pid) or (pid == 0 and JY.Base["标准"] == 4 and JLSD(30, 60, pid))) then
            WAR.CMDF = 1
            ng = ng + 1000

            Set_Eff_Text(id, "特效文字1", "颠动沧溟")
            lib.Debug('颠动沧溟'..' ng='..ng)
        end

        -- 龙爪手 额外杀气
        if wugong == 20 then
            ng = ng + 800
            Set_Eff_Text(id, "特效文字1", "批亢捣虚")
            lib.Debug('批亢捣虚'..' ng='..ng)
        end
        -- 王重阳北斗七闪追加气攻1000点
        if match_ID(pid, 9786) and WAR.BDQS > 0 then
            ng = ng + 1000
            local BDQS = {"天枢", "天璇", "天玑", "天权", "玉衡", "开阳", "摇光"}
            Set_Eff_Text(id, "特效文字2", "北斗七闪・" .. BDQS[WAR.BDQS])
            lib.Debug('王重阳北斗七闪追加气攻1000点'..' ng='..ng)
        end

        -- 萧远山杀破狼加气攻2000点
        if match_ID(pid, 112) and WAR.PD["杀破狼"][pid] ~= nil and WAR.PD["杀破狼"][pid] > 0 then
            ng = ng + 2000
            local BDQS = {"贪狼", "破军", "七杀"}
            local n = math.random(#BDQS)
            if WAR.Person[id]["特效文字2"] ~= nil then
                WAR.Person[id]["特效文字2"] = WAR.Person[id]["特效文字2"] .. "+" .. "杀破狼・" .. BDQS[n]
            else
                WAR.Person[id]["特效文字2"] = "杀破狼・" .. BDQS[n]
            end
            lib.Debug('萧远山杀破狼加气攻2000点'..' ng='..ng)
        end

        -- 朱子柳装备判官笔追加气攻666点
        if match_ID(pid, 122) and JY.Person[pid]["武器"] == 53 then
            ng = ng + 666
            Set_Eff_Text(id, "特效文字1", "尔乃蛮夷")
            lib.Debug('朱子柳装备判官笔追加气攻666点'..' ng='..ng)
        end
        -- 七伤拳，机率造成内伤17点
        -- 谢逊必出
        if wugong == 23 then
            local gl = 20
            if match_ID(pid, 13) then
                gl = 100
            end
            if JLSD(0, gl, pid) then
                WAR.YZQS = 1
                ng = ng + 777
                local jsm = math.modf(JY.Person[pid]["生命"] / 7)
                local jnl = math.modf(JY.Person[pid]["内力"] / 7)
                -- 崆峒五老
                if match_ID(pid, 9750) then
                    jsm = math.modf(jsm / 2)
                    jnl = math.modf(jnl / 2)
                end
                WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -jsm);
                WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -jnl)
                Set_Eff_Text(id, "特效文字1", "一震七伤")
                lib.Debug('七伤拳，机率造成内伤17点'..' ng='..ng)
            end
        end
        -- 玄澄 无量禅震 追加10-15点内伤
        if match_ID(pid, 9994) then
            WAR.XC_WLCZ = 1

            Set_Eff_Text(id, "特效文字1", "无量禅震")
            lib.Debug('玄澄 无量禅震 追加10-15点内伤'..' ng='..ng)
        end

        -- 星宿海奥义・连环腐尸毒           
        if wugong == 295 and level == 11 and WAR.LHFSD == 1 then
            ng = ng + 1000
            -- Set_Eff_Text(id,"特效文字0","『星宿海奥义・连环腐尸毒』");
            TXWZ_BIG("【星宿海奥义・连环腐尸毒】", C_RED, CC.FONT2)
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('【星宿海奥义・连环腐尸毒】'..' ng='..ng)
        end
        -- 如来神掌
        if WAR.PD["如来神掌"][pid] ~= nil and WAR.PD["如来神掌"][pid] > 0 then
            ng = ng + 1200
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('如来神掌'..' ng='..ng)
        end
        -- 黯然极意
        if WAR.ARJY == 1 then
            ng = ng + 1200
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('黯然极意'..' ng='..ng)
        end

        -- 刀剑绝技
        if WAR.PD["刀剑绝技"][pid] ~= nil and WAR.PD["刀剑绝技"][pid] < 3 then
            ng = ng + 1000
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('刀剑绝技'..' ng='..ng)
        end

        -- 九阴极意
        if WAR.JYSZ == 1 then
            ng = ng + 1000
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('九阴极意'..' ng='..ng)
        end

        -- 碧海招式5 滔天
        if WAR.BHJTZ2 == 1 then
            ng = ng + 1000
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('碧海招式5'..' ng='..ng)
        end
        if WAR.PD["前"][pid] == 1 then
            ng = ng + 1000
            WAR.WS = 1
            for i = 1, 5 do
                for j = 1, 5 do
                    SetWarMap(x + i - 1, y + j - 1, 4, 1)
                    SetWarMap(x - i + 1, y + j - 1, 4, 1)
                    SetWarMap(x + i - 1, y - j + 1, 4, 1)
                    SetWarMap(x - i + 1, y - j + 1, 4, 1)
                end
            end
            lib.Debug('WAR.PD["前"][pid]'..' ng='..ng)
        end
        -- 金轮法王 气攻+2500
        if match_ID(pid, 62) then
            ng = ng + 2000
            lib.Debug('金轮法王 气攻+2500'..' ng='..ng)
        end
        -- 天罡每个内功+100气攻
        -- 浩然罡气
        if match_ID(pid, 9946) then
            local hrgq = 0
            for i = 1, JY.Base["武功数量"] do
                if JY.Wugong[JY.Person[pid]["武功" .. i]]["武功类型"] == 6 then
                    hrgq = hrgq + 1
                end
            end
            ng = ng + hrgq * 100
            lib.Debug('天罡每个内功+100气攻'..' ng='..ng)
        end

        -- 花铁干，使用中平枪法，气攻+1500
        if (match_ID(pid, 52)) and wugong == 70 then
            Set_Eff_Text(id, "特效文字3", "中平神枪")
            ng = ng + 1000
            lib.Debug('花铁干，使用中平枪法，气攻+1500'..' ng='..ng)
        end
 
        -- 东方不败 萧半和 葵花点穴手，气攻+1000
        -- 葵尊必出点穴手
        if match_ID(pid, 9762) or match_ID_awakened(pid, 189, 1) or (Curr_NG(pid, 105) and JLSD(0, 30, pid)) then
            ng = ng + 1400
            WAR.BFX = 1
            Set_Eff_Text(id, "特效文字3", "葵花点穴")
            lib.Debug('葵花点穴'..' ng='..ng)
        end

        if match_ID(pid, 9744) then
            if JLSD(0, 30, pid) then
                WAR.PD['曲夕烟隙'][pid] = 1
                Set_Eff_Text(id, "特效文字1", "曲夕烟隙")
                WAR.Person[id]["特效动画"] = 61
            end
            lib.Debug('曲夕烟隙'..' ng='..ng)
        end


        -- 借力打力
        if WAR.PD["蓄气值"][pid] ~= nil and WAR.PD["蓄气值"][pid] > 0 then
            Set_Eff_Text(id, "特效文字3", "借力打力")
            ng = ng + WAR.PD["蓄气值"][pid]
            lib.Debug('借力打力'..' ng='..ng)
        end

        -- 白秀雪山剑法
        if wugong == 35 and match_ID_awakened(pid, 582, 1) and WAR.DZXY ~= 1 then
            ng = ng + 600
            lib.Debug('白秀雪山剑法'..' ng='..ng)
        end
        if WAR.BXXHSJ == 1 then
            local exng = 0
            local CN_num = {"一式", "二式", "三式", "四式", "五式", "六式", "七式", "八式", "九式",
                            "十式", "十一式", "十二式", "十三式", "十四式", "十五式"}
            for i = 1, JY.Base["武功数量"] do
                if JY.Person[pid]["武功" .. i] ~= 35 and JY.Person[pid]["武功等级" .. i] == 999 then
                    ng = ng + 100
                    exng = exng + 1

                end
            end
            lib.Debug('白秀雪山剑法'..' ng='..ng)
            if exng > 0 then
                Set_Eff_Text(id, "特效文字3", "雪花神剑・" .. CN_num[exng])
            end
        end
        -- 天山折梅手，杀气提高
        if wugong == 14 and WAR.DZXY ~= 1 then
            local exng = 0
            local CN_num = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二",
                            "十三", "十四", "十五"}
            for i = 1, JY.Base["武功数量"] do
                if JY.Person[pid]["武功" .. i] ~= 14 and JY.Person[pid]["武功等级" .. i] == 999 then
                    ng = ng + 100
                    exng = exng + 1
                end
            end
            lib.Debug('天山折梅手，杀气提高'..' ng='..ng)
            if exng > 0 then
                Set_Eff_Text(id, "特效文字3", "天山折梅" .. CN_num[exng])
            end
        end
        -- 棋势伤害
        if match_ID(pid, 586) and JY.Base["天书数量"] > 0 and WAR.DZXY ~= 1 then
            local zs = {" 十王走马势", "长气杀有眼", "回龙征", "一子解双征"}
            local exng = JY.Base["天书数量"] * 1
            local CN_num = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二",
                            "十三", "十四", "十五"}
            ng = ng + 1000
            Set_Eff_Text(id, "特效文字3", "奕棋・" .. CN_num[exng] .. "势・" .. zs[math.random(4)])
            lib.Debug('棋势伤害'..' ng='..ng)
        end

        -- 虚竹使用天山六阳掌或折梅手，出生死符，杀集气+1700
        if (wugong == 8 or wugong == 14) and (JLSD(20, 80, pid) or WAR.NGJL == 98) and WAR.DZXY ~= 1 then
            if match_ID(pid, 49) or JY.Person[pid]['门派'] == 3 then
                Set_Eff_Text(id, "特效文字1", "灵鹫宫绝学・生死符")
                ng = ng + 1000
                WAR.PD['生死符绝学'][pid] = 1
                lib.Debug('生死符绝学'..' ng='..ng)
            end
        end
        -- 李文秀使用特系攻击，60%的机率大幅度杀集气
        if match_ID(pid, 9850) and kfkind == 5 then
            if JLSD(0, 50 + JY.Base["天书数量"] * 2 + math.modf(JY.Person[pid]["实战"] / 25), pid) then
                Set_Eff_Text(id, "特效文字3", "心秀天铃・星月争辉")
                ng = ng + 800
                -- 如有14天书，则忽视绝对气防
                if (inteam(pid) and JY.Base["天书数量"] >= 14) or JLSD(0, 40, pid) then
                    WAR.LWX = 1
                end
                lib.Debug('李文秀使用特系攻击，60'..' ng='..ng)
            end
        end
        -- 黄衫女 广寒清辉
        -- 暴怒必触发
        if match_ID(pid, 640) and JY.Person[0]["六如觉醒"] > 0 and
            (JLSD(0, 10 + JY.Base["天书数量"] * 1, pid) or WAR.LQZ[pid] == 100) and WAR.DZXY ~= 1 then
            ng = ng + 1000
            WAR.GHQH = 1
            Set_Eff_Text(id, "特效文字3", "c")
            lib.Debug('广寒清辉'..' ng='..ng)
        end

        -- 梁萧谐之道
        -- 梁萧华山觉醒领悟谐之道
        if match_ID(pid, 9731) and WAR.LQZ[pid] == 100 and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500 or isteam(pid) == false) then
            ng = ng + 1000
            WAR.LXXZD = 1
            lib.Debug('梁萧谐之道'..' ng='..ng)
            Set_Eff_Text(id, "特效文字0", "谐之道・天道有常", 126)
        end


        -- 风清扬，暴怒九剑触发无招胜有招
        if (match_ID(pid, 140) or match_ID(pid, 9844)) and wugong == 47 and WAR.LQZ[pid] == 100 then
            Set_Eff_Text(id, "特效文字3", "无招胜有招")
            ng = ng + 2000
            WAR.FQY = 1
            lib.Debug('无招胜有招'..' ng='..ng)
        end
        -- 武功招式加杀集气
        if CC.KFMove[JY.Person[pid]["优先使用"]] ~= nil then
            local zsnum = 0
            if JY.Person[pid]["优先使用"] > 0 and WAR.DZXY ~= 1 then
                zsnum = WAR.WGZS
            else
                zsnum = 1
            end
            ng = ng + CC.KFMove[JY.Person[pid]["优先使用"]][zsnum][2]
            lib.Debug('武功招式加杀集气'..' ng='..ng)
        end
        -- 通微显化，50%机率增加气攻
        if match_ID(pid, 9770) and JLSD(30, 80, pid) then
            Set_Eff_Text(id, "特效文字3", '化朽为奇')
            ng = ng + get_skill_power(pid, wugong, 11)
            lib.Debug('通微显化，50'..' ng='..ng)
        end
        -- 王重阳，全真剑法，60%几率重阳剑气777气攻
        if wugong == 39 and match_ID(pid, 129) and JLSD(20, 80, pid) then
            ng = ng + 777
            Set_Eff_Text(id, "特效文字3", '重阳剑气')
            lib.Debug('重阳剑气'..' ng='..ng)
        end
        -- 天刀九问	标记修改
        if wugong == 335 then
            ng = ng + JY.Base["天书数量"] * 100
            Set_Eff_Text(id, "特效文字3", '天刀九问')
            lib.Debug('天刀九问'..' ng='..ng)
        end
        -- 魔刀千刃，标记修改
        if wugong == 75 and JY.Wugong[75]["名称"] == "魔刀千刃" and match_ID(pid, 9919) then
            ng = ng + 1000
            Set_Eff_Text(id, "特效文字3", '魔刀千刃')
            lib.Debug('魔刀千刃'..' ng='..ng)
        end
        if wugong == 75 and JY.Wugong[75]["名称"] == "大剪刀" and match_ID(pid, 9919) then
            ng = ng + 567
            Set_Eff_Text(id, "特效文字3", '洗剪吹')
            lib.Debug('洗剪吹'..' ng='..ng)
        end
        -- 九字真言，斗
        if WAR.PD["斗"][pid] ~= nil and WAR.PD["斗"][pid] == 1 then
            ng = ng + 800
            lib.Debug('九字真言，斗'..' ng='..ng)
        end
        -- 弹指神通，配合桃花绝技，气攻+1000
        if wugong == 18 and Pmiji(pid, 5) then
            ng = ng + 1000
            Set_Eff_Text(id, "特效文字3", '无影神石')
            lib.Debug('无影神石'..' ng='..ng)
        end
        -- 打狗棒法 极意
        if wugong == 80 and level == 11 then
            local jl = 50
            if JY.Person[pid]["武器"] == 218 and JY.Thing[218]["装备等级"] >= 5 then
                jl = jl + 10
            end
            if pid == 0 and JY.Base["标准"] == 5 then
                jl = jl + 5
            end
            if Curr_NG(204, pid) then
                jl = jl + 10
            end
            if JY.Person[pid]['奇穴' .. 72] == 1 then
                jl = jl + 20
            end
            if WAR.LQZ[pid] == 100 or JLSD(0, jl, pid) then
                -- Set_Eff_Text(id, "特效文字3", '打狗棒法绝学.天下无狗',89)
                TXWZ_BIG('打狗棒法绝学.天下无狗', C_RED, CC.FONT2)
                ng = ng + 1000
                WAR.WS = 1
                for i = 1, 6 do
                    for j = 1, 6 do
                        SetWarMap(x + i - 1, y + j - 1, 4, 1)
                        SetWarMap(x - i + 1, y + j - 1, 4, 1)
                        SetWarMap(x + i - 1, y - j + 1, 4, 1)
                        SetWarMap(x - i + 1, y - j + 1, 4, 1)
                    end
                end
                lib.Debug('打狗棒法绝学'..' ng='..ng)
            end
        end
        -- 胡家刀法，极意
        -- 刀系主角40%，胡斐50%，暴怒必出
        -- 胡一刀60%
        if wugong == 67 and level == 11 and WAR.PD["刀剑绝技"][pid] == nil then
            local pd = false
            local gl = 0
            local asgd = 0
            if pid == 0 and JY.Base["标准"] == 4 then
                gl = 40
            end
            if pid == 633 then
                gl = 60
            end
            if pid == 1 then
                gl = 50
            end
            if WAR.LQZ[pid] == 100 then
                gl = 100
            end
            if match_ID(pid, 9772) then
                gl = gl + 40
            end
            if JY.Person[pid]['奇穴' .. 51] == 1 then
                gl = 100
                asgd = 1
            end
            if JLSD(0, gl, pid) then
                local HDJY = {"极意・伏虎式", "极意・拜佛听经", "极意・穿手藏刀",
                              "极意・沙鸥掠波", "极意・参拜北斗", "极意・闭门铁扇刀",
                              "极意・缠身摘心刀", "极意・进步连环刀", "极意・八方藏刀式"};
                -- WAR.Person[id]["特效文字3"] = HDJY[math.random(9)];
                TXWZ_BIG(HDJY[math.random(9)], C_RED, CC.FONT2)
                WAR.Person[id]["特效动画"] = 6
                ng = ng + 1000
                WAR.WS = 1
                WAR.HDJY = 1
                for i = 1, 5 + asgd do
                    for j = 1, 5 + asgd do
                        SetWarMap(x + i - 1, y + j - 1, 4, 1)
                        SetWarMap(x - i + 1, y + j - 1, 4, 1)
                        SetWarMap(x + i - 1, y - j + 1, 4, 1)
                        SetWarMap(x - i + 1, y - j + 1, 4, 1)
                    end
                end
                lib.Debug('胡家刀法，极意'..' ng='..ng)
            end
        end
        -- 杨过，神雕，标主剑神 玄铁极意
        -- 无招式时必触发，暴怒时必出
        if wugong == 45 and level == 11 then
            local jl = 20
            if match_ID(pid, 58) or match_ID(pid, 628) then
                jl = jl + 30
            end
            if pid == 0 and JY.Base["标准"] == 3 then
                jl = jl + 10
            end
            if WAR.LQZ[pid] == 100 then
                jl = jl * 2
            end
            if JLSD(0, jl, pid) then
                if WAR.Person[id]["特效文字3"] ~= nil then
                    WAR.Person[id]["特效文字3"] = WAR.Person[id]["特效文字3"] ..
                                                          "+重剑真传・浪如山涌剑如虹"
                else
                    WAR.Person[id]["特效文字3"] = "重剑真传・浪如山涌剑如虹"
                end
                WAR.Person[id]["特效动画"] = 84
                ng = ng + 1200
                WAR.WS = 1
                for i = 1, 5 do
                    for j = 1, 5 do
                        SetWarMap(x + i - 1, y + j - 1, 4, 1)
                        SetWarMap(x - i + 1, y + j - 1, 4, 1)
                        SetWarMap(x + i - 1, y - j + 1, 4, 1)
                        SetWarMap(x - i + 1, y - j + 1, 4, 1)
                    end
                end
                lib.Debug('重剑真传・浪如山涌剑如虹'..' ng='..ng)
            end
        end


        
        -- 开太极 
        if Curr_NG(pid, 171) and (wugong == 16 or wugong == 46) then
            local md = false
            if WAR.LQZ[pid] == 100 and (WAR.PD["蓄气值"][pid] ~= nil and WAR.PD["蓄气值"][pid] >= 600) then
                md = true
            end
            if WAR.PD["太极之形"][pid] ~= nil and WAR.PD["太极之形"][pid] >= 8 and WAR.LQZ[pid] == 100 then
                md = true
            end
            if match_ID(pid, 5) and ((WAR.PD["蓄气值"][pid] ~= nil and WAR.PD["蓄气值"][pid] >= 600) or
                (WAR.PD["太极之形"][pid] ~= nil and WAR.PD["太极之形"][pid] >= 5)) then
                md = true
            end
            if md == true then
                local qg = (WAR.PD["蓄气值"][pid] or 0) + (WAR.PD["太极之形"][pid] or 0) * 100
                WAR.WDKTJ = 1
                ng = ng + qg
                local size = 60
                local x = CC.ScreenW / 2;
                local y = CC.ScreenH / 2;
                local offx = (#"【太一初分.开太极】") * size / 4
                local offy = size / 2
                for k = 1, 10 do
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    lib.Background(0, y - 50, CC.ScreenW, y + 50, 98)
                    DrawString(x - offx, y - offy, "【太一初分.开太极】", C_GOLD, size);
                    ShowScreen();
                    lib.Delay(CC.BattleDelay)
                end
                DrawTimeBar2()
                lib.Debug('【太一初分'..' ng='..ng)
            end
        end
        -- 李白七书觉醒后
        if (match_ID_awakened(pid, 636, 1) or (not isteam(pid) and match_ID(pid, 636))) and kfkind == 3 and WAR.LQZ[pid] ==
            100 then
            WAR.QLJG = 1
            ng = ng + 1500
            local size = 60
            local x = CC.ScreenW / 2;
            local y = CC.ScreenH / 2;
            local offx = (#"【绝技・青莲剑歌】") * size / 4
            local offy = size / 2
            for k = 1, 10 do
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                lib.Background(0, y - 50, CC.ScreenW, y + 50, 98)
                DrawString(x - offx, y - offy, "【绝技・青莲剑歌】", C_GOLD, size);
                ShowScreen();
                lib.Delay(CC.BattleDelay)
            end
            lib.Debug('【绝技・青莲剑歌】'..' ng='..ng)
        end

        -- 火焰刀奥义 标记修改
        if wugong == 66 and level >= 10 then
            local jl = 30
            if WAR.LQZ[pid] == 100 or match_ID(pid, 9873) or (pid == 0 and JY.Base['畅想'] == 103) then
                jl = 100
            end
            if JY.Person[pid]['奇穴' .. 48] == 1 then
                jl = jl + 10
            end
            if JY.Person[pid]['门派'] == 29 then
                jl = jl + 30
            end

            if JLSD(0, jl, pid) then
                TXWZ_BIG("【大轮密宗奥义・烈焰焚空】", C_RED, CC.FONT2)
                ng = ng + 1000
                WAR.WS = 1
                WAR.HZGX = 1
                lib.Debug('【大轮密宗奥义・烈焰焚空】'..' ng='..ng)
            end
        end
        -- 袁承志觉醒后，生命低于30%，50%几率出金蛇奥义
        -- 夏雪宜满怒30%几率出金蛇奥义
        -- if (match_ID_awakened(pid, 54, 1) and wugong == 40 and JY.Person[pid]["生命"] <= (JY.Person[pid]["生命最大值"]*0.3) and JLSD(20,70,pid)) or  (match_ID(pid,639) and (WAR.LQZ[pid] == 100 or JLSD(10,40,pid))) then
        if (match_ID(pid, 9773) and wugong == 40 and JLSD(20, 70, pid)) or
            (match_ID(pid, 639) and (WAR.LQZ[pid] == 100 or JLSD(10, 40, pid))) then
            WAR.JSAY = 1
            ng = ng + 1000
            TXWZ_BIG("【金蛇奥义.金蛇狂舞", C_RED, CC.FONT2)
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 5 and offset2 <= 5 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                    end
                end
            end
            lib.Debug('金蛇狂舞'..' ng='..ng)
        end

        -- 血战八方
        if WAR.PD["血战八方"][pid] ~= nil and WAR.PD["血战八方"][pid] > 0 and WAR.DZXY ~= 1 then
            WAR.WS = 1
            WAR.PD["血战八方"][pid] = WAR.PD["血战八方"][pid] - 1
            if WAR.PD["血战八方"][pid] < 0 then
                WAR.PD["血战八方"][pid] = nil
            end
            ng = ng + 800
            local size = 60
            local x = CC.ScreenW / 2;
            local y = CC.ScreenH / 2;
            local offx = (#"【血魔之怒.血战八方】") * size / 4
            local offy = size / 2
            for k = 1, 10 do
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                lib.Background(0, y - 50, CC.ScreenW, y + 50, 98)
                DrawString(x - offx, y - offy, "【血魔之怒.血战八方】", C_GOLD, size);
                ShowScreen();
                lib.Delay(CC.BattleDelay)
            end
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 5 and offset2 <= 5 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                        WAR.PD['卸甲状态'][WAR.Person[i]['人物编号']] = 3
                    end
                end
            end
            lib.Debug('血战八方】'..' ng='..ng)
        end
        -- 阿九 凤鸣九宵
        if match_ID_awakened(pid, 629, 1) and WAR.LQZ[pid] == 100 and WAR.DZXY ~= 1 then
            WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力",  -math.modf(JY.Person[pid]["内力"] / 10))
            WAR.AJFHNP = 1
            WAR.WS = 1
            ng = ng + 800
            local size = 60
            local x = CC.ScreenW / 2;
            local y = CC.ScreenH / 2;
            local offx = (#"【凤鸣九宵.谁主沉浮】") * size / 4
            local offy = size / 2
            for k = 1, 10 do
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                lib.Background(0, y - 50, CC.ScreenW, y + 50, 98)
                DrawString(x - offx, y - offy, "【凤鸣九霄.谁主沉浮】", C_GOLD, size);
                ShowScreen();
                lib.Delay(CC.BattleDelay)
            end
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 5 and offset2 <= 5 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                    end
                end
            end
            lib.Debug('谁主沉浮】'..' ng='..ng)
        end
        -- 莫大，50%几率出七弦无形剑奥义
        if match_ID(pid, 20) and (WAR.LQZ[pid] == 100 or JLSD(35, 85, pid)) then
            -- WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -math.modf(JY.Person[pid]["内力"]/10))
            WAR.QXWXJ = 1
            ng = ng + 800
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 4 and offset2 <= 4 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                    end
                end
            end
            lib.Debug('几率出七弦无形剑奥义'..' ng='..ng)
        end
        -- 屠龙刀特效一，追加等同于武功威力的杀气
        if WAR.L_TLD == 1 then
            ng = ng + get_skill_power(pid, wugong, 11)
            lib.Debug('屠龙刀特效一，追加等同于武功威力的杀气'..' ng='..ng)
        end
        -- 蓄力攻击
        if WAR.Actup[pid] ~= nil then
            -- 主运蛤蟆，追加杀气
            if Curr_NG(pid, 95) then
                ng = ng + 1200
            else
                ng = ng + 600
            end
            local str = "蓄力攻击"
            if WAR.PD["十龙十象"][pid] ~= nil then
                str = str .. "・十龙十象"
            end
            Set_Eff_Text(id, "特效文字1", str)
            lib.Debug('蓄力攻击'..' ng='..ng)
        end
        -- 西门吹雪
        if match_ID(pid, 9748) then
            WAR.XMJDHS = 1
            ng = ng + 1000
            Set_Eff_Text(id, "特效文字1", "剑道化身・破苍穹")
            lib.Debug('剑道化身・破苍穹'..' ng='..ng)
        end
        -- 怒气暴发，气攻+1200
        if WAR.LQZ[pid] == 100 and WAR.DZXY ~= 1 then
            WAR.HXZYJ = 1
            WAR.Person[id]["特效动画"] = 6
            ng = ng + 1200
            lib.Debug('怒气暴发，气攻'..' ng='..ng)
        end
        local pz = math.modf(JY.Person[0]["实战"] / 25)
        -- 主角剑神大招，10格攻击
        if pid == 0 and JY.Base["标准"] == 3 and 120 <= TrueYJ(pid) and 0 < JY.Person[pid]["武功9"] and kfkind == 3 and
            wugong ~= 43 and JLSD(25, 50 + JY.Person[pid]["御剑能力"] * 0.0625, pid) and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            CleanWarMap(4, 0)
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                end
            end

            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[3]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[3] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[3] .. TFSSJ[3], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.JSYX = 1
            lib.Debug('主角剑神大招，10格攻击'..' ng='..ng)
        end
        -- 步惊云剑廿三6格
        if match_ID(pid, 9738) and (JY.Base["天书数量"] > 8 or isteam(pid) == false) and 230 <= TrueYJ(pid) and
            WAR.LQZ[pid] == 100 and kfkind == 3 then
            CleanWarMap(4, 0)
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 7 and offset2 <= 7 then
                        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                    end
                end
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, " 剑圣再临--" .. "圣灵・『剑廿三』", C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.SL23 = 1
            lib.Debug('步惊云剑廿三6格'..' ng='..ng)
        end

        -- 井月八法寇仲
        if match_ID(pid, 9742) and kfkind == 4 then
            local df = 0
            for i = 1, JY.Base["武功数量"] do
                if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] ==
                    999 then
                    df = df + 1
                end
            end
            local DFWZ = {"不攻", "击奇", "战定", "用谋", "速战", "棋弈", "兵诈", "方圆"}
            if isteam(pid) then
                WAR.KZJYBF = math.random(0, df)
                if WAR.KZJYBF > 8 then
                    WAR.KZJYBF = 8
                end
                -- 保底后三刀
                if df > 7 then
                    WAR.KZJYBF = math.random(6, 8)
                end
            else
                WAR.KZJYBF = math.random(1, 8)
            end
            if WAR.KZJYBF > 0 then
                ng = ng + 1000 + WAR.KZJYBF * 150
            end
            lib.Debug('井月八法寇仲'..' ng='..ng)
        end
        -- 步惊云排云掌
        if match_ID(pid, 584) and kfkind == 1 then
            local DFWZ = {"一式『流水行云』", "二式『披云戴月』", "三式『翻云覆雨』",
                          "四式『排山倒海』", "五式『乌云蔽日』", "六式『重云深锁』",
                          "七式『撕天排云』", "八式『云海波涛』", "九式『燮云无定』",
                          "十式『殃云天降』", "十一式『云莱仙境』", "十二式『愁云惨淡』"}
            if isteam(pid) then
                WAR.BJYPYZ = math.random(0, JY.Base["天书数量"])
                if WAR.BJYPYZ > 12 then
                    WAR.BJYPYZ = 12
                end
                -- 保底天书数量-5
                if JY.Base["天书数量"] > 5 then
                    if WAR.BJYPYZ < JY.Base["天书数量"] - 5 then
                        WAR.BJYPYZ = JY.Base["天书数量"] - 5
                    end
                end
            else
                WAR.BJYPYZ = math.random(1, 10)
            end
            if WAR.BJYPYZ > 0 then
                ng = ng + 1000
                if WAR.Person[id]["特效文字0"] ~= nil then
                    WAR.Person[id]["特效文字0"] = "排云掌・" .. DFWZ[WAR.BJYPYZ] .. "+" ..
                                                          WAR.Person[id]["特效文字0"]
                else
                    WAR.Person[id]["特效文字0"] = "排云掌・" .. DFWZ[WAR.BJYPYZ]
                end
            end
            lib.Debug('步惊云排云掌'..' ng='..ng)
        end
        -- 步惊云圣灵剑法15~22 "圣灵・『剑十』", "圣灵・『剑十一』", "圣灵・『剑十二』", "圣灵・『剑十三』", "圣灵・『剑十四』","圣灵・『剑十』", "圣灵・『剑十一』", 
        -- "圣灵・『剑十二』", "圣灵・『剑十三』", "圣灵・『剑十四』",
        if match_ID(pid, 9738) and kfkind == 3 and WAR.SL23 == 0 then
            local txwz = {"圣灵・『剑十五』", "圣灵・『剑十六』", "圣灵・『剑十七』",
                          "圣灵・『剑十八』", "圣灵・『剑十九』", "圣灵・『剑廿』",
                          "圣灵・『剑廿一』", "圣灵・『剑廿二』"}
            if isteam(pid) then
                WAR.BJYJF = math.random(0, JY.Base["天书数量"])
                -- 保底天书数量-5
                if JY.Base["天书数量"] > 8 then
                    if WAR.BJYJF < JY.Base["天书数量"] - 8 then
                        WAR.BJYJF = JY.Base["天书数量"] - 8
                    end
                    if WAR.BJYJF > 8 then
                        WAR.BJYJF = 8
                    end
                end
            else
                WAR.BJYJF = math.random(1, 8)
            end
            if WAR.BJYJF > 0 then
                ng = ng + (1000 + WAR.BJYJF * 80)
                if WAR.Person[id]["特效文字0"] ~= nil then
                    WAR.Person[id]["特效文字0"] = txwz[WAR.BJYJF] .. "+" .. WAR.Person[id]["特效文字0"]
                else
                    WAR.Person[id]["特效文字0"] = txwz[WAR.BJYJF]
                end
            end
            lib.Debug('步惊云圣灵剑法15'..' ng='..ng)
        end
        -- 梅花三弄
        if match_ID(pid, 634) then
            local txwz = {"一", "二", "三"}
            if isteam(pid) then
                WAR.MHSN = math.random(1, 3)
                if WAR.MHSN > 0 then
                    ng = ng + WAR.MHSN * 150
                    if WAR.Person[id]["特效文字1"] ~= nil then
                        WAR.Person[id]["特效文字1"] = "梅花" .. txwz[WAR.MHSN] .. "弄" .. "+" ..
                                                              WAR.Person[id]["特效文字1"]
                    else
                        WAR.Person[id]["特效文字1"] = "梅花" .. txwz[WAR.MHSN] .. "弄"
                    end
                end
            end
            lib.Debug('梅花三弄'..' ng='..ng)
        end
        -- 步惊云 圣灵剑法1-9
        if match_ID(pid, 9738) and kfkind == 3 and WAR.BJYJF < 1 and WAR.SL23 == 0 then
            local zs = {"圣灵・『剑一』", "圣灵・『剑二』", "圣灵・『剑三』", "圣灵・『剑四』",
                        "圣灵・『剑五』", "圣灵・『剑六』", "圣灵・『剑七』", "圣灵・『剑八』",
                        "圣灵・『剑九』"}
            WAR.Person[id]["特效文字1"] = zs[math.random(9)]
            ng = ng + 1000
            lib.Debug('圣灵剑法1'..' ng='..ng)
        end
        -- 郭靖，降龙连击时随机后劲，有余不尽
        if match_ID(pid, 9865) and wugong == 26 and WAR.ACT > 1 then
            local txwz = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十", "十一", "十二",
                          "十三"}
            if isteam(pid) then
                WAR.YYBJ = math.random(0, JY.Base["天书数量"])
                if WAR.YYBJ > 13 then
                    WAR.YYBJ = 13
                end
                -- 保底天书数量-7
                if JY.Base["天书数量"] > 7 then
                    if WAR.YYBJ < JY.Base["天书数量"] - 7 then
                        WAR.YYBJ = JY.Base["天书数量"] - 7
                    end
                end
            else
                WAR.YYBJ = math.random(1, 10)
            end
            if WAR.YYBJ > 0 then
                ng = ng + WAR.YYBJ * 150
                if WAR.Person[id]["特效文字1"] ~= nil then
                    WAR.Person[id]["特效文字1"] =
                        "降龙・有余不尽・" .. txwz[WAR.YYBJ] .. "重后劲" .. "+" ..
                            WAR.Person[id]["特效文字1"]
                else
                    WAR.Person[id]["特效文字1"] = "降龙・有余不尽・" .. txwz[WAR.YYBJ] .. "重后劲"
                end
            end
            lib.Debug('郭靖，降龙连击时随机后劲，有余不尽'..' ng='..ng)
        end
        -- 主角拳系大招
        if pid == 0 and JY.Base["标准"] == 1 and 0 < JY.Person[pid]["武功9"] and 120 <= TrueQZ(pid) and
            JLSD(25, 50 + JY.Person[pid]["拳掌功夫"] * 0.1, pid) and kfkind == 1 and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[1]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[1] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[1] .. TFSSJ[1], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.LXZQ = 1
            lib.Debug('主角拳系大招'..' ng='..ng)
        end
        -- 主角指法大招
        if pid == 0 and JY.Base["标准"] == 2 and 0 < JY.Person[pid]["武功9"] and 120 <= TrueZF(pid) and
            JLSD(25, 60 + JY.Person[pid]["指法技巧"] * 0.1, pid) and kfkind == 2 and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[2]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[2] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[2] .. TFSSJ[2], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.LXYZ = 1
            lib.Debug('主角指法大招'..' ng='..ng)
        end
        -- 主角特系大招
        if pid == 0 and JY.Base["标准"] == 5 and 0 < JY.Person[pid]["武功9"] and 120 <= TrueTS(pid) and
            JLSD(25, 50 + JY.Person[pid]["特殊兵器"] * 0.1, pid) and kfkind == 5 and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[5]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[5] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[5] .. TFSSJ[5], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.GCTJ = 1
            lib.Debug('主角特系大招'..' ng='..ng)
        end
        -- 主角刀系大招
        if pid == 0 and JY.Base["标准"] == 4 and 0 < JY.Person[pid]["武功9"] and 120 <= TrueSD(pid) and
            JLSD(25, 50 + JY.Person[pid]["耍刀技巧"] * 0.1, pid) and kfkind == 4 and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[4]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[4] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[4] .. TFSSJ[4], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.ASKD = 1
            -- 触发后给自己加怒气25
            WAR.YZHYZ = WAR.YZHYZ + 25
            lib.Debug('主角刀系大招'..' ng='..ng)
        end
        -- 主角天罡大招，内功可触发
        if pid == 0 and JY.Base["标准"] == 6 and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid) and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[6]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[6] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            ng = ng + 1000
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[6] .. TFSSJ[6], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.JSTG = 1
            lib.Debug('主角天罡大招，内功可触发'..' ng='..ng)
        end
        -- 主角毒王大招，自身中毒100可触发
        if pid == 0 and JY.Base["标准"] == 9 and 0 < JY.Person[pid]["武功9"] and JLSD(25, 60 + pz, pid) and
            JY.Person[pid]["中毒程度"] > 99 and
            (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
            WAR.Person[id]["特效动画"] = 6
            if WAR.Person[id]["特效文字3"] == nil then
                WAR.Person[id]["特效文字3"] = ZJTF[9]
            else
                WAR.Person[id]["特效文字3"] = ZJTF[9] .. "・" .. WAR.Person[id]["特效文字3"]
            end
            WAR.WS = 1
            for n = 1, 20 do
                local i = n
                if i > 10 then
                    i = 10
                end
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                NewDrawString(-1, -1, ZJTF[9] .. TFSSJ[9], C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                lib.Delay(CC.BattleDelay)
            end
            WAR.YTML = 1
            lib.Debug('主角毒王大招，自身中毒100可触发'..' ng='..ng)
        end
        lib.Debug('攻击特效增加气攻结算'..' ng='..ng)




    ------------------大范围特效独立写这里----------------------------------------   
        -- 九寒焰 沧溟刀法
        if JY.Person[pid]['奇穴' .. 48] == 1 then
            local wz = nil
            if wugong == 153 then
                wz = '九寒焰.沧溟'
            elseif wugong == 335 then
                wz = '九寒焰.九歌'
            elseif wugong == 66 then
                wz = '九寒焰.烈焰'
            end
            if wz ~= nil then
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                        local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[j]["坐标X"])
                        local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[j]["坐标Y"])
                        if offset1 <= 7 and offset2 <= 7 then
                            -- WAR.Person[id]["特效动画"] = 6
                            Set_Eff_Text(id, "特效文字2", wz)
                            if wugong == 153 then
                                if JLSD(0, 20, pid) then
                                    WAR.PD["冻结"][WAR.Person[j]["人物编号"]] = 10
                                    WAR.Person[j]["特效动画"] = 116
                                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                                else
                                    WAR.Person[j]["冰封程度"] =
                                        (WAR.Person[j]["冰封程度"] or 0) +
                                            AddPersonAttrib(WAR.Person[j]["人物编号"], "冰封程度", 20)
                                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                                end
                            elseif wugong == 335 then
                                WAR.LXZT[WAR.Person[j]["人物编号"]] =
                                    WAR.LXZT[WAR.Person[j]["人物编号"]] or 0 + math.random(20, 40)
                                WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                            elseif wugong == 66 then
                                if JLSD(0, 20, pid) then
                                    WAR.PD['点燃'][WAR.Person[j]["人物编号"]] = math.random(5, 10)
                                    WAR.Person[j]["特效动画"] = 112
                                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                                else
                                    WAR.Person[j]["灼烧程度"] =
                                        (WAR.Person[j]["灼烧程度"] or 0) +
                                            AddPersonAttrib(WAR.Person[j]["人物编号"], "灼烧程度", 20)
                                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                                end
                            end
                        end
                    end
                end
            end
        end

        -- 剑魔BOSS
        if match_ID(pid, 592) and Boss(WAR.CurID) then
            local zs = {"独孤一式", "独孤二式", "独孤三式", "独孤四式", "独孤五式", "独孤六式",
                        "独孤七式", "独孤八式", "独孤九式", "独孤极意・无招胜有招"};
            local num = WAR.PD['独孤剑势'][pid] or 1;
            local zsnum = WAR.PD['独孤剑势'][pid] or 1;
            local n = 0;
            local person = {};
            -- 清掉之前的范围
            CleanWarMap(4, 0)
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                    n = n + 1
                    person[n] = i;
                end
            end
            -- 根据不同的X攻击不同的敌人
            if n <= num or zsnum >= 10 then
                for i = 1, n do
                    SetWarMap(WAR.Person[person[i]]["坐标X"], WAR.Person[person[i]]["坐标Y"], 4, 1)
                end
            else
                while num > 0 do
                    local t = math.random(n);
                    if person[t] ~= nil then
                        SetWarMap(WAR.Person[person[t]]["坐标X"], WAR.Person[person[t]]["坐标Y"], 4, 1)
                        person[t] = nil;
                        num = num - 1;
                    end
                end
            end

            local str = zs[limitX(zsnum, 1, 10)]
            WAR.Person[id]["特效文字3"] = str
            Cls()
            ShowScreen()
            if num >= 10 then -- 独孤求败发动极意后，恢复５００命，２０００内力，内伤和中毒减半
                -- WAR.Person[id]["生命点数"] = (WAR.Person[id]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", 500);
                WAR.Person[id]["内力点数"] = (WAR.Person[id]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", 2000);
                WAR.Person[id]["解毒点数"] = (WAR.Person[id]["解毒点数"] or 0) -  AddPersonAttrib(pid, "中毒程度", -50);
                -- AddPersonAttrib(pid, "受伤程度", -50);   --1018
                if WAR.PD['内伤状态'][id] ~= nil and WAR.PD['内伤状态'][id] > 50 then
                    WAR.PD['内伤状态'][id] = (WAR.PD['内伤状态'][id] or 0) - 50
                else
                    WAR.PD['内伤状态'][id] = 0
                end
                WAR.Person[id]["特效动画"] = 6
                for n = 1, 20 do
                    local i = n
                    if i > 10 then
                        i = 10
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    NewDrawString(-1, -1, str, C_GOLD, CC.DefaultFont + i * 2)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end
        end
        WAR.KF = wugong
        if MyFj(WAR.CurID) == false then
            if DGFJ() == 1 then
                return 1
            end
        end
        wugong = WAR.KF

        if JY.Person[pid]["生命"] <= 0 then
            return 1
        end
        -- 剑魔BOSS结束

        -- 无酒不欢：狮子吼
        --内轻特效921
        if NeiGong_tx(pid,921) then 
            if WAR.Person[id]["特效动画"] == -1 then
                WAR.Person[id]["特效动画"] = math.fmod(92, 10) + 85
            end
            local nl = JY.Person[pid]["内力"];
            local f = 0;
            local chance = dkfcj_ng*25
            local force = dkfcj_ng*25
            local pns = dkfcj_ng*5
            -- 一般人需要内力差大于1000，而谢逊只要内力差大于0即可
            local neilicha = 1000
            if match_ID(pid, 13) then
                neilicha = 0
            end

            if JLSD(0, chance, pid)  then
                f = 1
            end

            if f == 1 then
                if JY.Person[pid]["性别"] ~= 0 then
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] ==
                            false and (nl - JY.Person[WAR.Person[j]["人物编号"]]["内力"]) > neilicha then
                            WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - force * 2
                            if  myns(j) == false then
                                -- 1018
                                -- WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", math.random(10,18))
                                WAR.Person[j]["内伤点数"] =
                                    (WAR.PD['内伤状态'][WAR.Person[j]["人物编号"]] or 0) + math.modf(pns/2,pns)

                                WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                            end
                        end
                    end
                    Set_Eff_Text(id, "特效文字2", "河东狮吼");
                    WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(pid, "内力", -180);
                else
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] ==
                            false and (nl - JY.Person[WAR.Person[j]["人物编号"]]["内力"]) > neilicha then
                            WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - force
                            if  myns(j) == false then
                                -- 1018
                                -- WAR.Person[j]["内伤点数"] = (WAR.Person[j]["内伤点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "受伤程度", math.random(5,9))
                                WAR.Person[j]["内伤点数"] =
                                    (WAR.PD['内伤状态'][WAR.Person[j]["人物编号"]] or 0) + math.modf(pns/3,pns/2)
                                WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                            end
                        end
                    end
                    Set_Eff_Text(id, "特效文字2", "狮子吼");
                end
            end
        end      
        --天狼啸月
        if JY.Person[pid]["武器"] == 320 and JY.Wugong[wugong]["武功类型"] == 2 and JY.Thing[320]["装备等级"] == 6 and JLSD(20, 70, pid) then
            Set_Eff_Text(id, "特效文字1", "天狼啸月");
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                    WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
                end
            end
        end
        --金毗罗陀
        if match_ID(pid, 9913) and WAR.LQZ[pid] == 100 then
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    -- if offset1 <= 7 and offset2 <= 7 then
                    WAR.LQZ[WAR.Person[i]['人物编号']] = 0
                    -- say("金毗罗陀"..WAR.LQZ[WAR.Person[i]['人物编号']].."点",1)
                    -- end				
                end
            end
            Set_Eff_Text(id, "特效文字1", "金毗罗陀");
        end
        -- 杨过 攻击，非吼 全体集气减100
        if (match_ID(pid, 58) or match_ID(pid, 9833)) and WAR.XK ~= 2 then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 100
                    if WAR.Person[j].Time < -450 then
                        WAR.Person[j].Time = -450
                    end
                end
            end
            if WAR.Person[id]["特效动画"] == -1 then
                WAR.Person[id]["特效动画"] = 89
            end
            Set_Eff_Text(id, "特效文字2", "西狂之怒啸");
        end
        -- 杨过吼
        if WAR.XK == 2 and match_ID(pid, 58) and WAR.Person[WAR.CurID]["我方"] == WAR.XK2 then
            for e = 0, WAR.PersonNum - 1 do
                if WAR.Person[e]["死亡"] == false and WAR.Person[e]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    WAR.Person[e].TimeAdd = WAR.Person[e].TimeAdd -
                                                math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
                    if WAR.Person[e].Time < -450 then
                        WAR.Person[e].Time = -450
                    end
                    JY.Person[WAR.Person[e]["人物编号"]]["内力"] =
                        JY.Person[WAR.Person[e]["人物编号"]]["内力"] -
                            math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 5)
                    if JY.Person[WAR.Person[e]["人物编号"]]["内力"] < 0 then
                        JY.Person[WAR.Person[e]["人物编号"]]["内力"] = 0
                    end
                    JY.Person[WAR.Person[e]["人物编号"]]["生命"] =
                        JY.Person[WAR.Person[e]["人物编号"]]["生命"] -
                            math.modf(JY.Person[WAR.Person[WAR.CurID]["人物编号"]]["内力"] / 25)
                end
                if JY.Person[WAR.Person[e]["人物编号"]]["生命"] < 0 then
                    JY.Person[WAR.Person[e]["人物编号"]]["生命"] = 0
                end
            end

            -- 吼过之后，内力为0，内力最大值-1000，并且用声望控制上限
            if isteam(pid) then
                JY.Person[pid]["内力"] = 0
                JY.Person[pid]["内力最大值"] = JY.Person[pid]["内力最大值"] - 1000
                JY.Person[300]["声望"] = JY.Person[300]["声望"] + 1
            else
                AddPersonAttrib(pid, "内力", -1000) -- 做敌方内力只减1000
            end

            if JY.Person[pid]["内力最大值"] < 500 then
                JY.Person[pid]["内力最大值"] = 500
            end
            Set_Eff_Text(id, "特效文字2", "西狂之震怒・雷霆狂啸");
            WAR.Person[id]["特效动画"] = 6
            WAR.XK = 3
        end
        -- 七弦无形剑气
        if match_ID(pid, 9843) then
            local jl = 25
            if wugong == 73 then
                jl = 100
            end
            if JLSD(0, jl, pid) then
                Set_Eff_Text(id, "特效文字2", "七弦无形剑气");
                WAR.Person[id]["特效动画"] = 89
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                        -- 无酒不欢：记录人物血量
                        WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                        JY.Person[WAR.Person[j]["人物编号"]]["生命"] =
                            JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 50
                        WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 50
                        -- 沉睡状态的敌人会醒来
                        if WAR.PD["沉睡状态"][WAR.Person[j]["人物编号"]] ~= nil then
                            WAR.PD["沉睡状态"][WAR.Person[j]["人物编号"]] = nil
                        end
                    end
                end
            end
        end
        -- 碧海潮生，第一次攻击，伤内力500，内力不足500追加伤害
        if match_ID(pid, 9860) then
            local pd = false
            if WAR.ACT == 1 then
                pd = true
            end
            if WAR.ACT > 1 and JLSD(0, 40, pid) then
                pd = true
            end
            -- 东邪BOSS
            if Boss(id) then
                pd = true
            end
            if pd == true then
                for j = 0, WAR.PersonNum - 1 do
                    local mid = WAR.Person[j]["人物编号"]
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        if JY.Person[mid]["内力"] > 500 then
                            WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) +AddPersonAttrib(mid, '内力', -500);
                        else
                            WAR.Person[j]["内力点数"] = (WAR.Person[j]["内力点数"] or 0) +AddPersonAttrib(mid, '内力', -500);
                            -- 无酒不欢：记录人物血量
                            WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                            WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) +AddPersonAttrib(mid, '生命', -100);
                        end

                        -- 概率混乱
                        if JLSD(0, 30, pid) then
                            WAR.PD["紊乱状态"][mid] = 20
                        end
                        WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                    end
                end
                Set_Eff_Text(id, "特效文字2", "魔音・碧海潮生曲");
                WAR.Person[id]["特效动画"] = 39
            end
        end
        -- 成昆幻阴魔相
        if match_ID(pid, 9912) and WAR.JNTM == 1 then
            for j = 0, WAR.PersonNum - 1 do
                local mid = WAR.Person[j]["人物编号"]
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[j]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[j]["坐标Y"])
                    if offset1 <= 7 and offset2 <= 7 then
                        WAR.PD["紊乱状态"][mid] = 5
                        WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                    end
                end
            end
        end
        -- 剑胆琴心 持瑶琴回血1%，减少10内伤 标记修改
        if wugong == 73 and Pmiji(pid, 18) then
            Set_Eff_Text(id, "特效文字3", "清心普善咒")
            WAR.Person[id]["特效动画"] = 89
            local HP = math.modf(JY.Person[pid]["生命"] * 0.01)
            if HP > 100 then
                HP = 100
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", HP)
            -- 1018
            -- WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", -10)
            WAR.Person[WAR.CurID]["内伤点数"] = (WAR.PD['内伤状态'][pid] or 0) - 10

        end
        -- 七夕任盈盈加强版效果
        if match_ID(pid, 611) and wugong == 73 then
            Set_Eff_Text(id, "特效文字2", "魔音搜魂");
            WAR.Person[id]["特效动画"] = 89
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    JY.Person[WAR.Person[j]["人物编号"]]["生命"] =
                        JY.Person[WAR.Person[j]["人物编号"]]["生命"] - 100
                end
            end
        end

        -- 何足道，攻击时附加琴音状态，上限30层
        if match_ID(pid, 586) then
            WAR.PD["曲风状态"][pid] = (WAR.PD["曲风状态"][pid] or 0) + math.random(2, 4)
            if WAR.PD["曲风状态"][pid] > 30 then
                WAR.PD["曲风状态"][pid] = 30
            end
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    if WAR.PD["琴音状态"][WAR.Person[j]["人物编号"]] == nil then
                        WAR.PD["琴音状态"][WAR.Person[j]["人物编号"]] = math.random(2, 3)
                    else
                        WAR.PD["琴音状态"][WAR.Person[j]["人物编号"]] =
                            WAR.PD["琴音状态"][WAR.Person[j]["人物编号"]] + math.random(3)
                        if WAR.PD["琴音状态"][WAR.Person[j]["人物编号"]] > 30 then
                            WAR.PD["琴音状态"][WAR.Person[j]["人物编号"]] = 30
                        end
                    end
                end
            end
            Set_Eff_Text(id, "特效文字2", "凤求凰");
            WAR.Person[id]["特效动画"] = 83
        end
        -- 紫气天罗 附带冰冻
        if Pmiji(pid, 6) and (wugong == 9 or wugong == 5 or wugong == 21 or wugong == 118) then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    if WAR.PD["冰冻状态"][WAR.Person[j]["人物编号"]] == nil then
                        WAR.PD["冰冻状态"][WAR.Person[j]["人物编号"]] = math.random(1, 3)
                    else
                        WAR.PD["冰冻状态"][WAR.Person[j]["人物编号"]] =
                            WAR.PD["冰冻状态"][WAR.Person[j]["人物编号"]] + math.random(1, 3)
                        if WAR.PD["冰冻状态"][WAR.Person[j]["人物编号"]] > 50 then
                            WAR.PD["冰冻状态"][WAR.Person[j]["人物编号"]] = 50
                        end
                    end

                end
            end
            Set_Eff_Text(id, "特效文字2", "紫气天罗");
            WAR.Person[id]["特效动画"] = 80
        end
        -- 曲风伤害
        if match_ID(pid, 586) and WAR.PD["曲风状态"][pid] > 20 then
            CleanWarMap(4, 0)
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    local eid = WAR.Person[j]["人物编号"]
                    local qycs = WAR.PD["琴音状态"][eid] or 0
                    if qycs > 0 then
                        WAR.TXXS[eid] = 1
                        -- 无酒不欢：记录人物血量
                        WAR.Person[j]["Life_Before_Hit"] = JY.Person[eid]["生命"]
                        JY.Person[eid]["生命"] = JY.Person[eid]["生命"] - 20 * qycs
                        WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) - 20 * qycs
                        WAR.PD["曲风状态"][pid] = nil
                        SetWarMap(WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"], 4, 1)
                    end
                end
            end
            Set_Eff_Text(id, "特效文字2", "百鸟朝凤");
            WAR.Person[id]["特效动画"] = 154
        end
        -- 血战沙场
        if (wugong == 200 or wugong == 198) and Pmiji(pid, 13) then
            local jl = 2 + WAR.XZSC
            local tim = 0
            if WAR.LQZ[pid] ~= nil then
                jl = jl + math.modf(WAR.LQZ[pid] * 0.02)
            end
            if WAR.LQZ[pid] == 100 then
                jl = jl + 2
            end
            while tim < jl + 1 do
                local dam = math.random(10, 20)
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                        local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                        local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                        if offset1 <= 7 and offset2 <= 7 then
                            WAR.Person[i]["特效动画"] = 157
                            WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) +  AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", -dam)
                            WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                            Set_Eff_Text(id, "特效文字2", "醉卧沙场君莫笑・古来征战几人回？");
                        end
                    end
                end
                tim = tim + 1;
            end
        end
        -- 程灵素 攻击全屏中毒+20
        if match_ID(pid, 2) or match_ID(pid, 9904) then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
                    myzd(j) == false then
                    WAR.Person[j]["中毒点数"] = (WAR.Person[j]["中毒点数"] or 0) + AddPersonAttrib(WAR.Person[j]["人物编号"], "中毒程度",20)
                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                end
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                    local yx = math.random(6)
                    if yx == 1 then
                        WAR.PD['白云熊胆'][WAR.Person[j]["人物编号"]] = 200
                    end
                    if yx == 2 then
                        WAR.PD['天王护命'][WAR.Person[j]["人物编号"]] = 100
                    end
                    if yx == 3 then
                        WAR.PD['小还丹'][WAR.Person[j]["人物编号"]] = 50
                    end
                    if yx == 4 then
                        WAR.PD['黄连解毒'][WAR.Person[j]["人物编号"]] = 50
                    end
                    if yx == 5 then
                        WAR.PD['牛黄血蝎'][WAR.Person[j]["人物编号"]] = 50
                    end
                    if yx == 6 then
                        WAR.PD['六阳正气'][WAR.Person[j]["人物编号"]] = 1
                    end
                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                end
            end
            Set_Eff_Text(id, "特效文字2", "七心海棠");
            WAR.Person[id]["特效动画"] = 64
        end

        if WAR.PD['傲寒六诀'][pid] ~= nil and WAR.PD['傲寒六诀'][pid] > 0 then
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 10 and offset2 <= 10 and mybf(i) == false then
                        WAR.Person[i]["冰封程度"] = (WAR.Person[i]["冰封程度"] or 0) + AddPersonAttrib(WAR.Person[i]["人物编号"],"冰封程度", 20)
                        WAR.BFXS[WAR.Person[i]["人物编号"]] = 1
                        WAR.Person[i]["特效动画"] = 80
                        if JLSD(0, 30, pid) then
                            WAR.PD["冻结"][WAR.Person[i]["人物编号"]] = 10
                            WAR.Person[i]["特效动画"] = 116
                        end
                        WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                    end
                end
            end
            WAR.Person[id]["特效动画"] = 174
        end
        -- 玄阴煞气
        if JY.Person[pid]['奇穴' .. 83] == 1 and Curr_NG(pid, 107) then
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then
                    local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                    local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                    if offset1 <= 7 and offset2 <= 7 then
                        WAR.PD['冻结'][WAR.Person[i]["人物编号"]] = 10
                        WAR.BFXS[WAR.Person[i]["人物编号"]] = 1
                        WAR.Person[i]["特效动画"] = 116
                        WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                    end
                end
            end
        end

        if math.random(100) < 21 then
            local LFQ_MLZ;
            for i = 0, CC.WarWidth - 1 do
                for j = 0, CC.WarHeight - 1 do
                    local effect = GetWarMap(i, j, 4)
                    if 0 < effect then
                        local emeny = GetWarMap(i, j, 2)
                        if emeny >= 0 and emeny ~= WAR.CurID then
                            if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and (match_ID(WAR.Person[emeny]["人物编号"], 83) or  match_ID(WAR.Person[emeny]["人物编号"], 700)) then
                                LFQ_MLZ = emeny
                                break
                            end
                        end
                    end
                end
            end
            if LFQ_MLZ ~= nil then
                local s = WAR.CurID
                WAR.CurID = LFQ_MLZ
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 151, 1, "含沙射影")
                War_ExecuteMenu_Sub(WAR.Person[s]["坐标X"], WAR.Person[s]["坐标Y"], 4, math.random(28, 35))
                WAR.CurID = s
                LFQ_MLZ = nil
            end
        end

        if math.random(100) < 21 then
            local LFQ_MLZ;
            for i = 0, CC.WarWidth - 1 do
                for j = 0, CC.WarHeight - 1 do
                    local effect = GetWarMap(i, j, 4)
                    if 0 < effect then
                        local emeny = GetWarMap(i, j, 2)
                        if emeny >= 0 and emeny ~= WAR.CurID then
                            if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and match_ID(WAR.Person[emeny]["人物编号"], 499) then
                                LFQ_MLZ = emeny
                                break
                            end
                        end
                    end
                end
            end
            if LFQ_MLZ ~= nil then
                local s = WAR.CurID
                WAR.CurID = LFQ_MLZ
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 157, 1, "灵犀一指")
                WAR.CurID = s
                LFQ_MLZ = nil
                return 1
            end
        end
        -- 青青 雷霆万钧
        if math.random(10) > 7 then
            local WQQ_LTWJ;
            for i = 0, CC.WarWidth - 1 do
                for j = 0, CC.WarHeight - 1 do
                    local effect = GetWarMap(i, j, 4)
                    if 0 < effect then
                        local emeny = GetWarMap(i, j, 2)
                        if emeny >= 0 and emeny ~= WAR.CurID then
                            if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and  match_ID(WAR.Person[emeny]["人物编号"], 9867) then
                                WQQ_LTWJ = emeny
                                break
                            end
                        end
                    end
                end
            end
            if WQQ_LTWJ ~= nil then
                local s = WAR.CurID
                WAR.CurID = WQQ_LTWJ
                local jl = 5
                local XZ = {}
                local tim = 1
                local num = 0
                while tim < jl + 1 do
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] ==  false then
                            local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                            local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                            if offset1 <= 9 and offset2 <= 9 then
                                WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                                table.insert(XZ, i)
                                num = num + 1
                            end
                        end
                    end
                    local si = XZ[math.random(#XZ)]
                    local dam = math.modf(TrueYJ(s) * 0.1) + math.random(10)
                    if num > 0 then
                        WAR.Person[si]["特效动画"] = 131
                        WAR.Person[si]["生命点数"] = (WAR.Person[si]["生命点数"] or 0) +  AddPersonAttrib(WAR.Person[si]["人物编号"], "生命",  -dam)
                        tim = tim + 1
                    else
                        tim = tim + 1
                    end
                end
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 131, 1, "雷霆万钧")
                WAR.CurID = s
                WAR.ACT = 10
                WQQ_LTWJ = nil
            end
        end


        -- 李秋水无相转身，没有触发过，或者分身已死，才可触发，有30%几率触发
        -- 李秋水无相转身，没有触发过，或者分身已死，才可触发，有30%几率触发
        if (WAR.WXFS == nil or (WAR.WXFS ~= nil and WAR.Person[WAR.WXFS]["死亡"] == true)) and math.random(10) < 4 then
            local lqs_WXZS;
            for i = 0, CC.WarWidth - 1 do
                for j = 0, CC.WarHeight - 1 do
                    local effect = GetWarMap(i, j, 4)
                    if 0 < effect then
                        local emeny = GetWarMap(i, j, 2)
                        if emeny >= 0 and emeny ~= WAR.CurID then

                            if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[emeny]["我方"] and  match_ID(WAR.Person[emeny]["人物编号"], 118) and WAR.Person[emeny]["人物编号"] ==  0 then
                                lqs_WXZS = emeny
                                SetWarMap(i, j, 4, 0)
                                break
                            end
                        end
                    end
                end
            end

            if lqs_WXZS ~= nil then

                -- ID临时交给李秋水
                local s = WAR.CurID
                WAR.CurID = lqs_WXZS
                local wxlox, wxloy;
                War_CalMoveStep(WAR.CurID, 10, 0)
                local function SelfXY(x, y)
                    local yes = 0
                    if x == WAR.Person[WAR.CurID]["坐标X"] then
                        yes = yes + 1
                    end
                    if y == WAR.Person[WAR.CurID]["坐标Y"] then
                        yes = yes + 1
                    end
                    if yes == 2 then
                        return true
                    end
                    return false
                end
                local x, y = nil, nil
                while true do
                    x, y = War_SelectMove()
                    if x ~= nil then
                        WAR.ShowHead = 0
                        wxlox, wxloy = x, y
                        break
                        -- ESC退出
                    else
                        WAR.ShowHead = 0
                        x, y = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
                        -- wxlox, wxloy = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
                        break
                    end
                end
                -- 不在自身位置才能触发幻象
                if SelfXY(x, y) == false then
                    SetWarMap(wxlox, wxloy, 4, 0)
                    -- 本场还没触发过无相转身，则加入新人物
                    if WAR.WXFS == nil then
                        WAR.Person[WAR.PersonNum]["人物编号"] = 600
                        WAR.Person[WAR.PersonNum]["我方"] = WAR.Person[WAR.CurID]["我方"]
                        WAR.Person[WAR.PersonNum]["坐标X"] = wxlox
                        WAR.Person[WAR.PersonNum]["坐标Y"] = wxloy
                        WAR.Person[WAR.PersonNum]["死亡"] = false
                        WAR.Person[WAR.PersonNum]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
                        WAR.Person[WAR.PersonNum]["贴图"] = WarCalPersonPic(WAR.PersonNum)

                        -- lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[600]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[600]["头像代号"]), 4 + WAR.PersonNum)
                        WAR.JQSDXS[600] = 0 -- 直接指定集气，以免召唤出来马上被斗转跳出
                        WAR.WXFS = WAR.PersonNum
                        WAR.PersonNum = WAR.PersonNum + 1
                        -- 已经触发过，则让分身复活
                    else
                        WAR.Person[WAR.WXFS]["死亡"] = false
                        WAR.Person[WAR.WXFS]["我方"] = WAR.Person[WAR.CurID]["我方"]
                        WAR.Person[WAR.WXFS]["坐标X"] = wxlox
                        WAR.Person[WAR.WXFS]["坐标Y"] = wxloy
                        WAR.Person[WAR.WXFS]["人方向"] = WAR.Person[WAR.CurID]["人方向"]
                        WAR.Person[WAR.WXFS]["贴图"] = WarCalPersonPic(WAR.WXFS)
                        JY.Person[600]["生命"] = JY.Person[600]["生命最大值"]
                        JY.Person[600]["内力"] = JY.Person[600]["内力最大值"]
                        JY.Person[600]["体力"] = 100
                        -- JY.Person[600]["受伤程度"] = 0 
                        JY.Person[600]["中毒程度"] = 0
                        JY.Person[600]["冰封程度"] = 0
                        JY.Person[600]["灼烧程度"] = 0
                        WAR.Person[WAR.WXFS].Time = 0

                        -- 流血
                        if WAR.LXZT[600] ~= nil then
                            WAR.LXZT[600] = nil
                        end
                        -- 封穴
                        if WAR.FXDS[600] ~= nil then
                            WAR.FXDS[600] = nil
                        end
                        -- 1018
                        Cat('清除所有异常', WAR.WXFS)
                    end

                    -- 清除自身位置贴图
                    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5, -1)
                    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, -1)
                    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10, -1)
                    -- 修改自身与幻象坐标
                    WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"] =
                        WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"],
                        WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]

                    -- 增加幻象贴图
                    SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 5,
                        WAR.Person[WAR.WXFS]["贴图"])
                    SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 2, WAR.WXFS)
                    SetWarMap(WAR.Person[WAR.WXFS]["坐标X"], WAR.Person[WAR.WXFS]["坐标Y"], 10,
                        JY.Person[WAR.Person[WAR.WXFS]["人物编号"]]['头像代号'])

                    -- 增加自身贴图
                    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                        WAR.Person[WAR.CurID]["贴图"])
                    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
                    SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                        JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
                end
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 90, 1, "无相转身")

                -- 还原ID并打断连击
                WAR.CurID = s
                WAR.ACT = 10
            end
        end
        -- 随机移动
        local tf97 = hastf(WAR.CurID, 97, 2)
        if tf97 ~= nil then
            WAR.WS = 0
        end

    -------------记录攻击方特效文字，音效----------------------------     
        -- 判断攻击次数大于1，显示连击文字
        if WAR.ACT > 1 and WAR.PD["刀剑绝技"][pid] == nil then
            local A = "连击"
            if WAR.TWLJ == 1 then
                A = "天赋外功.炉火纯青"
            end
            if WAR.TJZX_LJ == 1 then
                A = "太极之形.圆转不断"
                WAR.TJZX_LJ = 0
            end
            -- 夫妻刀法
            if wugong == 62 then
                -- 萧中慧
                if match_ID(pid, 77) or match_ID(pid, 154) then
                    A = "碧箫声里双鸣凤"
                    -- 主角男性
                elseif pid == 0 and JY.Person[0]["性别"] == 0 then
                    A = "英雄无双风流婿"
                    -- 主角女性
                elseif pid == 0 and JY.Person[0]["性别"] ~= 0 then
                    A = "刀光掩映孔雀屏"
                end
            end
            -- 风云再起
            if match_ID(pid, 9763) then
                A = "风云再起"
            end
            -- Set_Eff_Text(WAR.CurID,4,A)
        end

        -- 全真七子，天罡北斗阵，文字显示
        if (pid >= 123 and pid <= 128) or pid == 68 then
            WAR.Person[id]["特效动画"] = 93
            Set_Eff_Text(id, "特效文字1", "天罡北斗阵加力")
        end
        -- 武当七侠，真武七截阵，文字显示
        if (pid >= 532 and pid <= 538) then
            WAR.Person[id]["特效动画"] = 93
            Set_Eff_Text(id, "特效文字1", "真武七截阵加力")
        end

        -- 特效文字1，动画为红色圈
        if WAR.Person[id]["特效文字1"] ~= nil and WAR.Person[id]["特效动画"] == -1 then
            WAR.Person[id]["特效动画"] = 88
        end
        -- 北斗七闪的特效动画
        if match_ID(pid, 9786) and WAR.BDQS > 0 then
            WAR.Person[id]["特效动画"] = 126
        end
        -- 达摩攻击特效动画
        if match_ID(pid, 577) then
            WAR.Person[id]["特效动画"] = 183
        end
        -- 无酒不欢的特效动画
        if pid == 0 and JY.Base["特殊"] == 1 then
            WAR.Person[id]["特效动画"] = 132
        end
        -- 萧秋水觉醒特效动画
        if match_ID(pid, 652) and JY.Person[0]["六如觉醒"] > 0 then
            WAR.Person[id]["特效动画"] = 83
        end
        -- 开太极的动画
        if WAR.WDKTJ == 1 then
            WAR.Person[id]["特效动画"] = 159
        end
        -- 梁萧觉醒特效动画
        if match_ID(pid, 9731) and (JY.Person[0]["六如觉醒"] > 0 or inteam(pid) == false) then
            WAR.Person[id]["特效动画"] = 126
        end
        -- 双剑合壁动画 	
        if (wugong == 39 or wugong == 42 or wugong == 139) and Pmiji(pid, 23) then
            WAR.Person[id]["特效动画"] = 83
        end

        -- 苗人凤破军的动画和文字
        if match_ID(pid, 3) and WAR.MRF == 1 then
            Set_Eff_Text(id, "特效文字1", "破军")
            WAR.Person[id]["特效动画"] = 146
        end

        -- 阿九 凤鸣九宵
        if match_ID(pid, 629) and WAR.AJFHNP == 1 then
            WAR.Person[id]["特效动画"] = 154
        end

        --雪花六出
        if Given_WG(pid, wugong) and wugong == 35 then
            if WAR.ATNum > 1 then
                local str = {'一', '二', '三', '四', '五', '六'}                
                WAR.PD['雪花六出'][pid] = math.random(6)
                local wz = str[WAR.PD['雪花六出'][pid]] .. '花'
                Set_Eff_Text(id, "特效文字1", wz)
            end
        end
  
        -- 无酒不欢：标主的大招音效
        local dhxg = JY.Wugong[wugong]["武功动画&音效"]
        if WAR.LXZQ == 1 then
            dhxg = 71
        elseif WAR.JSYX == 1 then
            dhxg = 84
        elseif WAR.ASKD == 1 then
            dhxg = 65
        elseif WAR.LXBR == 1 then
            dhxg = 65
        elseif WAR.GCTJ == 1 then
            dhxg = 108
        elseif WAR.JSTG == 1 then
            dhxg = 119
        end
        -- 记录攻击方特效文字，防止防御的时候冲突
        WAR.WZ[pid] = {WAR.Person[WAR.CurID]['特效文字0'], WAR.Person[WAR.CurID]['特效文字1'],
                       WAR.Person[WAR.CurID]['特效文字2'], WAR.Person[WAR.CurID]['特效文字3'],
                       WAR.Person[WAR.CurID]['特效文字4'], WAR.Person[WAR.CurID]['特效动画']}
        WAR.Person[WAR.CurID]['特效文字0'] = nil;
        WAR.Person[WAR.CurID]['特效文字1'] = nil;
        WAR.Person[WAR.CurID]['特效文字2'] = nil;
        WAR.Person[WAR.CurID]['特效文字3'] = nil;
        WAR.Person[WAR.CurID]['特效文字4'] = nil;
        WAR.Person[WAR.CurID]['特效动画'] = -1;
        lib.Debug(JY.Person[pid]['姓名']..'使用武功'..JY.Wugong[wugong]['名称']..'追加气攻 ='..ng)
        Cat('挪移闪避', wugong, x, y)
        Cat('伤害结算', wugong, level, ng, x, y, ZHEN_ID)
        -- 记录攻击方特效文字，防止防御的时候冲突
        WAR.WZ1[pid] = {WAR.Person[WAR.CurID]['特效文字0'], WAR.Person[WAR.CurID]['特效文字1'],
                        WAR.Person[WAR.CurID]['特效文字2'], WAR.Person[WAR.CurID]['特效文字3'],
                        WAR.Person[WAR.CurID]['特效文字4'], WAR.Person[WAR.CurID]['特效动画']}
        -- 无酒不欢：人物的攻击动画和点数显示
        -- 攻击方动画
        War_ShowFight(pid, wugong, JY.Wugong[wugong]["武功类型"], level, x, y, dhxg, ZHEN_ID)
        -- 李莫愁赤练神掌		
        if WAR.ZQTL[1] ~= nil then
            local dam = WAR.ZQTL[1]
            local ybid = WAR.ZQTL[2]
            local bpX = WAR.ZQTL[3]
            local bpY = WAR.ZQTL[4]
            local pid = WAR.ZQTL[5]
            local ran = 5
            for i = 1, 5 do
                WAR.ZQTL[i] = nil
            end
            local ys_list = {}
            local ys_num = 0
            for i = 0, WAR.PersonNum - 1 do
                if GetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4) == 1 then
                    ys_num = ys_num + 1
                    ys_list[ys_num] = {WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]}
                end
            end
            local yes = 1
            while (yes == 1) do
                yes = 0
                WAR.Person[ybid]["引爆"] = 1
                WAR.Person[ybid]["特效动画"] = 117
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["引爆"] == nil and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
                        WAR.Person[i]["死亡"] == false then
                        local bdid = WAR.Person[i]["人物编号"]
                        local offset1 = math.abs(bpX - WAR.Person[i]["坐标X"])
                        local offset2 = math.abs(bpY - WAR.Person[i]["坐标Y"])
                        if offset1 <= ran and offset2 <= ran then
                            WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - dam
                            JY.Person[bdid]["生命"] = JY.Person[bdid]["生命"] - dam
                            if JY.Person[bdid]["生命"] < 0 then
                                JY.Person[bdid]["生命"] = 0
                                yes = 1
                                ybid = i
                                bpX = WAR.Person[i]["坐标X"]
                                bpY = WAR.Person[i]["坐标Y"]
                            end
                            WAR.TXXS[bdid] = 1
                        end
                    end
                end
                War_ShowFight(-1, 0, 0, 0, 0, 0, 0, 0)
            end
            CleanWarMap(4, 0)
            for i = 1, ys_num do
                SetWarMap(ys_list[i][1], ys_list[i][2], 4, 1)
            end
        end
        if WAR.WZ1[pid] ~= nil then
            WAR.Person[WAR.CurID]['特效文字0'] = WAR.WZ1[pid][1]
            WAR.Person[WAR.CurID]['特效文字1'] = WAR.WZ1[pid][2]
            WAR.Person[WAR.CurID]['特效文字2'] = WAR.WZ1[pid][3]
            WAR.Person[WAR.CurID]['特效文字3'] = WAR.WZ1[pid][4]
            WAR.Person[WAR.CurID]['特效文字4'] = WAR.WZ1[pid][5]
            WAR.Person[WAR.CurID]['特效动画'] = WAR.WZ1[pid][6]
        end
        WAR.WZ1[pid] = nil
        Cat('防御方动画')
        Cat('数值显示')
    --------------------攻击后计算吸血和掉血----------------------------------------    
        -- 血刀吸血，上限100点
        local xdmxxtx = 0
        if WAR.XDLeech > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XDLeech);
        end
        if WAR.XWTXX > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XWTXX);
        end
        if WAR.ZSXX > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.ZSXX);
        end
        if WAR.RMXX > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.RMXX);
        end
        -- 韦一笑吸血10%，上限100点
        if WAR.WYXLeech > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.WYXLeech);
        end
        if WAR.YZHLeech > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.YZHLeech);
        end
        if WAR.QZWDS > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +  AddPersonAttrib(pid, "生命", WAR.QZWDS);
        end
        if WAR.YLXX > 0 then ---标记修改
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +  AddPersonAttrib(pid, "生命", WAR.YLXX);
        end
        -- 天魔功吸血20%
        if WAR.TMGLeech > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +  AddPersonAttrib(pid, "生命", WAR.TMGLeech);
        end
        -- 一剑无血吸血
        if WAR.WXXX > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.WXXX);
        end
        -- 血海魔功吸血
        if WAR.XHMGXX > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", WAR.XHMGXX);
        end
        -- 以眼还眼
        if WAR.YYHY > 0 then
            local xxnnn = JY.Person[pid]['生命'] + WAR.XDLeech - JY.Person[pid]['生命最大值']
            if xxnnn > 0 then
                xdmxxtx = xdmxxtx + xxnnn
            end
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -WAR.YYHY);
        end
        if xdmxxtx > 0 and JY.Person[pid]['门派'] == 17 then
            WAR.PD['血刀门特性'][pid] = xdmxxtx
        end
        if WAR.PD['血刀门特性'][pid] ~= nil then
            WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +  AddPersonAttrib(pid, "内力", math.modf(WAR.PD['血刀门特性'][pid] * 0.8))
            AddPersonAttrib(pid, "体力", math.modf(WAR.PD['血刀门特性'][pid] * 0.2))
            WAR.PD['血刀门特性'][pid] = nil
        end
        -- 血刀
        for i = 1, WAR.PersonNum - 1 do
            local id = WAR.Person[i]["人物编号"]
            if WAR.XDQX[id] == 1 then
                WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) -
                                                    limitX(math.modf(WAR.XDQX1), 0, 100)
                SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 2)
                WAR.XDQX[id] = nil
                if JY.Person[id]["生命"] < 0 then
                    JY.Person[id]["生命"] = 0
                end
                Cat('数值显示')
            end
        end
        -- 无明业火状态，耗损使用的内力一半的生命
        if WAR.PD["无名业火"][pid] ~= nil then
            CurIDTXDH(WAR.CurID, 127, 1, "无明业火", C_ORANGE)
            local nlDam = math.modf(JY.Wugong[wugong]["消耗内力点数"] / 2)
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", -nlDam)
            -- 至少留1滴血
            if JY.Person[pid]["生命"] <= 0 then
                JY.Person[pid]["生命"] = 1
            end
        end
        WAR.PD['神游太虚'] = {}
        War_Show_Count(WAR.CurID); -- 显示当前控制人的点数       
        WAR.TFBW = 0 -- 听风辨位的文字记录恢复
        -- 老顾0305
        for i = 1, JY.Base["武功数量"] do
            local yx = JY.Person[pid]["优先使用"]
            if yx > 0 then
                local menu = {}
                local menu1 = {}
                local wz = {"一", "二", "三", "四", "五", "六", "七", "八", "九", "十"}
                if yx == JY.Person[pid]["武功" .. i] and CC.WUGONGZS[i] ~= nil and inteam(pid) then
                    for j = 1, #CC.WUGONGZS[i] do
                        if j > #CC.KFMove[yx] then
                            j = #CC.KFMove[yx]
                        end
                        if JY.Person[pid]["武功招式" .. CC.WUGONGZS[i][j]] == 0 then
                            menu[#menu + 1] = CC.WUGONGZS[i][j]
                            RandFetch(menu1, 1, #menu, menu)
                            local jl = 5
                            if j > 3 then
                                jl = jl * 3 / (j - 1) * 2
                            end
                            if jl < 1 then
                                jl = 1
                            end
                            if JLSD(0, jl, pid) and 0 < #menu1 then
                                local bx = CC.WX
                                local by = CC.HY

                                JY.Person[pid]["武功招式" .. menu1[1]] = 1
                                for p = 102, 105 do
                                    lib.LoadPNG(90, JY.Person[pid]["半身像"] * 2, bx * 351, by * 288, 1, 0, 128)
                                    lib.LoadPNG(91, p * 2, -1, -1, 1)
                                end
                                PlayWavAtk(42)
                                ShowScreen()
                                lib.Delay(500)
                                DrawStrBoxWaitKey("Ｒ灵光一闪!Ｏ" .. JY.Person[pid]["姓名"] ..
                                                      "领悟了武功Ｒ" .. JY.Wugong[yx]["名称"] .. "Ｏ第" ..
                                                      wz[j] .. "招Ｒ" .. CC.KFMove[yx][j][1], C_ORANGE,
                                    CC.DefaultFont, 4)
                                break
                            end
                        end
                    end
                end
            end
        end
        if WAR.FHJZ == 1 then
            DrawStrBoxWaitKey("【Ｇ复活戒指Ｏ】损坏了！", C_ORANGE, CC.DefaultFont, 2)
            WAR.FHJZ = 0
        end
        WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 2
        local kfjy = math.modf(JY.Person[pid]["资质"] / 30 + math.random(2))
        if JY.Person[pid]['坐骑'] == 312 then
            -- kfjy = 90
        end
        local level = math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1
        if inteam(pid) then
            if JY.Person[pid]["武功等级" .. wugongnum] < 900 then
                JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + kfjy
            elseif JY.Person[pid]["武功等级" .. wugongnum] < 999 then
                if CC.TX['心魔'] == 0 then
                    local jl = (500 - JY.Person[pid]["实战"]) / 20
                    if JY.Person[512]["声望"] == 1 then
                        kfjy = 0
                        JY.Person[pid]["武功等级" .. JY.Person[512]["出战"]] = 998
                        -- say("没有空挥经验",0,1)					
                    elseif JY.Person[512]["声望"] == 0 then
                        JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + kfjy
                        -- say("获得空挥经验"..kfjy,0,1)
                        -- say(JY.Person[pid]['武功等级1'],0,1)	
                        -- math.random(100) < jl and  			
                        if JY.Person[pid]["武功等级" .. wugongnum] >= 980 and
                            JY.Person[pid]["武功等级" .. wugongnum] < 999 and JY.Person[512]["出战"] == 0 then
                            JY.Person[pid]["武功等级" .. wugongnum] = 980
                            -- say("准备召唤心魔",0,1)
                            JY.Person[512]["出战"] = wugongnum
                            JY.Person[512]["声望"] = 1
                            kfjy = 0
                            DrawStrBoxWaitKey(string.format("%s修炼%s走火入魔引来心魔",
                                JY.Person[pid]["姓名"], JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"]),
                                C_ORANGE, CC.DefaultFont)
                            local xx, yy = WE_xy(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"] - 1)
                            for i = 1, JY.Base['武功数量'] do
                                local wg = JY.Person[512]['武功' .. i]
                                if wg > 0 then
                                    -- lib.Debug('心魔武功 '..i..' == '..JY.Wugong[wg]['名称'])
                                    if CC.KFMove[wg] ~= nil then
                                        for p = 1, #CC.KFMove[wg] do
                                            local zs = CC.WUGONGZS[i][p]
                                            JY.Person[512]['武功招式' .. zs] = 0
                                        end
                                        JY.Person[512]['武功' .. i] = 0
                                        JY.Person[512]['武功等级' .. i] = 0
                                    end
                                end
                            end
                            for qx = 1, 149 do
                                JY.Person[512]['奇穴' .. qx] = 0
                            end
                            for i = 1, 5 do
                                JY.Person[512]["天赋" .. i] = JY.Person[pid]["心魔"]
                            end
                            WAR.JQSDXS[512] = 0
                            JY.Person[512]["心魔"] = pid
                            JY.Person[512]["头像代号"] = JY.Person[pid]["头像代号"]
                            JY.Person[512]["半身像"] = JY.Person[pid]["半身像"]
                            JY.Person[512]["天赋内功"] = JY.Person[pid]["天赋内功"]
                            JY.Person[512]["天赋外功1"] = JY.Person[pid]["天赋外功1"]
                            JY.Person[512]["天赋外功2"] = JY.Person[pid]["天赋外功2"]
                            JY.Person[512]["天赋轻功"] = JY.Person[pid]["天赋轻功"]
                            JY.Person[512]["指法技巧"] = math.modf(JY.Person[pid]["指法技巧"])
                            JY.Person[512]["御剑能力"] = math.modf(JY.Person[pid]["御剑能力"])
                            JY.Person[512]["耍刀技巧"] = math.modf(JY.Person[pid]["耍刀技巧"])
                            JY.Person[512]["特殊兵器"] = math.modf(JY.Person[pid]["特殊兵器"])
                            JY.Person[512]["武学常识"] = math.modf(JY.Person[pid]["武学常识"])
                            JY.Person[512]["攻击带毒"] = JY.Person[pid]["攻击带毒"] * 1.5
                            for i = 1, 5 do
                                JY.Person[512]["秘技" .. i] = JY.Person[pid]["秘技" .. i]
                            end
                            JY.Person[512]["攻击力"] = JY.Person[pid]["攻击力"]
                            JY.Person[512]["防御力"] = JY.Person[pid]["防御力"]
                            JY.Person[512]["轻功"] = JY.Person[pid]["轻功"]
                            JY.Person[512]["医疗能力"] = JY.Person[pid]["医疗能力"]
                            JY.Person[512]["用毒能力"] = JY.Person[pid]["用毒能力"]
                            JY.Person[512]["解毒能力"] = JY.Person[pid]["解毒能力"]
                            JY.Person[512]["暗器技巧"] = JY.Person[pid]["暗器技巧"]
                            JY.Person[512]["抗毒能力"] = JY.Person[pid]["抗毒能力"]
                            JY.Person[512]["个人觉醒"] = JY.Person[pid]["个人觉醒"]
                            JY.Person[512]["六如觉醒"] = JY.Person[pid]["六如觉醒"]
                            JY.Person[512]["畅想分阶"] = JY.Person[pid]["畅想分阶"]
                            for i = 1, 5 do
                                JY.Person[512]["出招动画帧数" .. i] = JY.Person[pid]["出招动画帧数" .. i]
                                JY.Person[512]["出招动画延迟" .. i] = JY.Person[pid]["出招动画延迟" .. i]
                                JY.Person[512]["武功音效延迟" .. i] = JY.Person[pid]["武功音效延迟" .. i]
                            end
                            JY.Person[512]["武器"] = JY.Person[pid]["武器"]
                            JY.Person[512]["防具"] = JY.Person[pid]["防具"]
                            JY.Person[512]["坐骑"] = JY.Person[pid]["坐骑"]
                            JY.Person[512]["生命最大值"] = math.modf(JY.Person[pid]["生命最大值"] * 1.5)
                            JY.Person[512]["生命"] = JY.Person[512]["生命最大值"]
                            JY.Person[512]["内力最大值"] = math.modf(JY.Person[pid]["内力最大值"] * 1.5)
                            JY.Person[512]["内力"] = JY.Person[512]["内力最大值"]
                            JY.Person[512]["体质"] = JY.Person[pid]["体质"]
                            JY.Person[512]["内力性质"] = JY.Person[pid]["内力性质"]
                            JY.Person[512]["性别"] = JY.Person[pid]["性别"]
                            JY.Person[512]["资质"] = JY.Person[pid]["资质"]
                            JY.Person[512]["优先使用"] = JY.Person[pid]["优先使用"]
                            JY.Person[512]["主运内功"] = JY.Person[pid]["主运内功"]
                            JY.Person[512]["主运轻功"] = JY.Person[pid]["主运轻功"]
                            JY.Person[512]["能量"] = 2
                            for xx = 1, JY.Base['武功数量'] do
                                for p = 1, #CC.KFMove[wugong] do
                                    local zs = CC.WUGONGZS[xx][p]
                                    JY.Person[512]['武功' .. xx] = JY.Person[pid]['武功' .. xx]
                                    JY.Person[512]['武功等级' .. xx] = JY.Person[pid]['武功等级' .. xx]
                                    JY.Person[512]["武功招式" .. zs] = JY.Person[pid]["武功招式" .. zs]
                                end
                            end
                            for qx = 1, 149 do
                                JY.Person[512]['奇穴' .. qx] = JY.Person[pid]['奇穴' .. qx]
                            end
                            Health_in_Battle()

                            local nn = math.random(5)
                            NewWARPersonZJ(512, false, xx + nn, yy + nn, false, 2)
                            JY.Person[512]["优先使用"] = JY.Person[pid]["优先使用"]
                            lib.Debug(JY.Person[512]['代号'] .. '生成时：使用武功==============' ..
                                          JY.Wugong[JY.Person[512]['优先使用']]['名称'])

                        end
                    end
                    if JY.Person[512]["品德"] == 2 and JY.Person[512]["声望"] == 1 then
                        JY.Person[pid]["武功等级" .. JY.Person[512]["出战"]] = 999
                        -- say("终于击击败了心魔,感觉对武功的领悟又进了一步。",pid,1)				
                    end
                else
                    JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] + kfjy
                end
                if JY.Person[pid]["武功等级" .. wugongnum] >= 999 and wugongnum > 0 then
                    JY.Person[pid]["武功等级" .. wugongnum] = 999
                    -- say("到极了。。。",0,1)	
                    PlayWavAtk(42)
                    DrawStrBoxWaitKey(string.format("%s修炼%s到登峰造极", JY.Person[pid]["姓名"],
                        JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"]), C_ORANGE, CC.DefaultFont)
                    -- 虚竹 天山折梅手为极，资质变回30 标记修改
                    if match_ID(pid, 49) and wugong == 14 then
                        say("逍遥派的武学果然博大精深，让小僧有醍醐灌顶之感。", 49, 0);
                        DrawStrBoxWaitKey("虚竹资质改变！", C_ORANGE, CC.DefaultFont)
                        local xid = 49; -- 标记修改
                        if JY.Base["畅想"] == 49 or JY.Base["畅想"] == 52 then
                            xid = 0
                        end
                        set_potential(xid, 30)
                    end
                    -- 玉真子铁血大旗
                    if match_ID(pid, 9895) and (wugong == 13 or wugong == 143) then
                        local jysg = 0
                        for i = 1, JY.Base["武功数量"] do
                            if JY.Person[pid]["武功" .. i] == 143 and JY.Person[pid]["武功等级" .. i] == 999 then
                                jysg = jysg + 1
                            end
                            if JY.Person[pid]["武功" .. i] == 13 and JY.Person[pid]["武功等级" .. i] == 999 then
                                jysg = jysg + 1
                            end
                        end
                        if jysg > 1 then
                            say("原来这就是嫁衣神功", 184, 0);
                            DrawStrBoxWaitKey("玉真子三围各增加100！", C_ORANGE, CC.DefaultFont)
                            AddPersonAttrib(pid, "攻击力", 100)
                            AddPersonAttrib(pid, "防御力", 100)
                            AddPersonAttrib(pid, "轻功", 100)
                        end
                    end
                    -- 真名神照，增加轻功20点
                    if match_ID(pid, 9761) and wugong == 94 then
                        say(
                            "神照经当真奇妙，四肢百骸感觉劲力充盈。丁大哥，我一定不会让你失望的！",
                            37, 0);
                        DrawStrBoxWaitKey("领悟神照经的真髓，轻功加二十", C_ORANGE, CC.DefaultFont)
                        AddPersonAttrib(pid, "轻功", 20)
                    end
                    -- 魂系一刀，胡家刀法到极，增加10点耍刀技巧
                    if match_ID(pid, 9972) and wugong == 67 then
                        say("刀法真是越练越精妙。", 1, 0);
                        DrawStrBoxWaitKey("耍刀技巧各增加10点", C_ORANGE, CC.DefaultFont)
                        AddPersonAttrib(pid, "耍刀技巧", 10)
                    end
                end
            end
            if level < (math.modf(JY.Person[pid]["武功等级" .. wugongnum] / 100) + 1) and WAR.DZXY == 0 then
                if JY.Person[pid]["出战"] ~= 1 and inteam(pid) and level >= 10 then
                    break
                else
                    local lv = 0
                    local ljy = JY.Person[pid]["修炼点数"]
                    local xlwp = 0
                    if JY.Person[pid]["修炼物品"] ~= nil then
                        xlwp = JY.Person[pid]["修炼物品"]
                    end
                    local wp = -1
                    local lv = 0
                    if KF_thing(wugong) == nil then
                        local lvkf = JY.Person[pid]["武功" .. wugongnum]
                        KF_addsx(pid, lvkf)
                        lib.Debug('升级了')
                    else
                        JY.Person[pid]["修炼物品"] = KF_thing(wugong)
                        local r = 0
                        if lv < 9 then
                            r = math.modf((5 - math.modf(JY.Person[pid]["资质"] / 25)) *
                                              JY.Thing[KF_thing(wugong)]["需经验"] * (lv + 1) * 0.5);
                        else
                            r = math.huge;
                        end
                        JY.Person[pid]["武功等级" .. wugongnum] = JY.Person[pid]["武功等级" .. wugongnum] - 100
                        JY.Person[pid]["修炼点数"] = r
                        War_PersonTrainBook1(pid)
                        JY.Person[pid]["修炼物品"] = -1
                        JY.Person[pid]["修炼点数"] = ljy
                        JY.Person[pid]["修炼物品"] = xlwp
                    end
                    Cat('实时特效动画')
                    Cls()
                    Cat('实时特效动画2')
                    DrawStrBox(-1, -1, string.format("%s 升为 %d 级",JY.Wugong[JY.Person[pid]["武功" .. wugongnum]]["名称"], level), C_ORANGE, CC.DefaultFont)
                    ShowScreen()
                    lib.Delay(CC.BattleDelay)
                end
            end
        end

    ----------------------计算攻击内力消耗体力消耗气消耗--------------------------------------------    
        local nl = nil
        lib.Debug(JY.Person[pid]['姓名'] .. ' 使用武功 ' .. JY.Wugong[wugong]['名称'] .. ' 第 ' .. WAR.WGZS ..'招')
        local nl1 = 0
        local xhwg1 = 0
        if #CC.KFMove[wugong] ~= nil then
            nl1 = CC.KFMove[wugong][WAR.WGZS][3]
        end
        nl = math.modf((level+1)/3*JY.Wugong[wugong]["消耗内力点数"]/5)
        
        -- 物转星移
        if JY.Person[pid]['奇穴' .. 149] == 1 then
            nl = math.modf(nl * 0.5)
            nl1 = math.modf(nl1 * 0.5)
        end
        -- 我方，消耗的内力能量体力 武功消耗
        -- 物转星移
        if JY.Person[pid]['奇穴' .. 149] == 1 then
            nl = math.modf(nl * 0.5)
        end
        if PersonKF(pid, 43) then
            nl = math.modf(nl * 1.3)
        end


        -- 乔峰降龙消耗减半
        if (match_ID(pid, 50) or match_ID(pid, 539)) and wugong == 26 then
            nl = math.modf(nl / 2);
        end

        -- 石破天觉醒后，太玄消耗减半
        if match_ID(pid, 9759) and wugong == 102 then
            nl = math.modf(nl / 2);
        end

        -- 段誉六脉消耗减半
        if match_ID(pid, 9881) and wugong == 49 then
            nl = math.modf(nl / 2);
        end

        -- 指法主角六脉消耗减半
        if pid == 0 and JY.Base["标准"] == 2 and wugong == 49 then
            nl = math.modf(nl / 2);
        end

        -- 天外攻击，只消耗一半内力
        if Given_WG(pid, wugong) then
            nl = math.modf(nl / 2);
        end

        -- 周伯通论剑奖励，体内消耗减少50%
        if pid == 0 and CC.TX["周伯通奖励"] == 1 then
            nl = math.modf(nl / 2)
        end
        -- 一气化三清
        if match_ID(pid, 9851) and JLSD(0, 40,pid) then
            AddPersonAttrib(pid, "生命", nl)
            AddPersonAttrib(pid, "体力", math.modf(nl / 10))
            WAR.LQZ[pid] = WAR.LQZ[pid] or 0 + math.modf(nl / 10)
            if WAR.LQZ[pid] > 100 then
                WAR.LQZ[pid] = 100
            end
            if JY.Person[pid]["体力"] > 100 then
                JY.Person[pid]["体力"] = 100
            end
            if JY.Person[pid]["生命"] > JY.Person[pid]["生命最大值"] then
                JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
            end
        end
        -- 老顾0309
        if (WAR.Person[WAR.CurID]["反击武功"] > 0 and fjpd(WAR.CurID)) or WAR.DZXY > 0 or WAR.ZYHB == 2 then
            -- nl1 = nl1
            -- nl = math.modf(nl/2)
        end
        if match_ID(pid, 504) and JLSD(0, 30, pid) and JY.Wugong[wugong]['武功类型'] == 3 then
            nl1 = 0
        end

        
        if JY.Person[pid]["优先使用"] > 0 then
            if WAR.WGZS == #CC.KFMove[JY.Person[pid]["优先使用"]] then
                if WAR.LQZ[pid] == nil then
                    WAR.LQZ[pid] = 0
                end
                WAR.LQZ[pid] = WAR.LQZ[pid] - JZ_lqz(pid)
                xhwg1 = JZ_lqz(pid)
            end
        end
        if WAR.ACT == 1 then
            
            AddPersonAttrib(pid, "能量", -nl1)
            AddPersonAttrib(pid, "内力", -nl)
            lib.Debug(JY.Person[pid]['姓名'] .. '使用武功' .. JY.Wugong[wugong]['名称'] .. ' 第 ' .. WAR.WGZS ..' 招' .. '耗内' .. nl .. '/耗气' .. nl1 .. '/耗怒' .. xhwg1..'剩余内力='..JY.Person[pid]['内力'])
            if JY.Person[pid]["内力"] < 0 then
                JY.Person[pid]["内力"] = 0
            end
            if JY.Person[pid]["能量"] < 0 then
                JY.Person[pid]["能量"] = 0
            end
            if JY.Person[pid]["生命"] <= 0 then
                break
            end
            lib.Debug("")
            lib.Debug("...............一次伤害结束分界线...............")
            lib.Debug("")
        --连击消耗内力  
        elseif WAR.ACT > 1 then 
            if (WAR.Person[WAR.CurID]["反击武功"] > 0 and fjpd(WAR.CurID)) or WAR.DZXY > 0 or WAR.ZYHB == 2 then
            else
                nl = math.modf(nl * 0.5)
                nl1 = math.modf(nl1 / 2)
                AddPersonAttrib(pid, "能量", -(nl1))
                AddPersonAttrib(pid, "内力", -nl)
                lib.Debug('连击 '..JY.Person[pid]['姓名'] .. '使用武功' .. JY.Wugong[wugong]['名称'] .. ' 第 ' .. WAR.WGZS ..' 招' .. '耗内' .. nl .. '/耗气' .. nl1 .. '/耗怒' .. xhwg1..'剩余内力='..JY.Person[pid]['内力'])
            end
            if JY.Person[pid]["内力"] < 0 then
                JY.Person[pid]["内力"] = 0
            end
            if JY.Person[pid]["生命"] <= 0 then
                break
            end    
            lib.Debug("")
            lib.Debug("...............连击伤害结束分界线...............")
            lib.Debug("")       
        end
        -- 计算消耗的体力
        local jtl = 0
        if 2000 <= WAR.WGWL then
            jtl = 5
        elseif 1500 <= WAR.WGWL then
            jtl = 4
        elseif 1000 <= WAR.WGWL then
            jtl = 3
        elseif 600 <= WAR.WGWL then
            jtl = 2
        else
            jtl = 1
        end
        -- 周伯通论剑奖励，体内消耗减少50%
        if pid == 0 and CC.TX["周伯通奖励"] == 1 then
            jtl = math.modf(jtl / 2)
        end
        if PersonKF(pid, 43) then
            jtl = math.modf(jtl * 1.3)
        end
        -- 装备青驴 体力-2
        if JY.Person[id]["坐骑"] == 339 then
            jtl = jtl - 2
        end
        if JY.Person[pid]["实战"] >= 500 then
            jtl = jtl - 1
        end
        if jtl < 1 then
            jtl = 1
        end
        -- 人厨子攻击不消耗体力
        -- NPC只消耗1点
        if match_ID(pid, 89) == false and match_ID(pid, 9828) == false then
            if WAR.Person[WAR.CurID]["我方"] then
                AddPersonAttrib(pid, "体力", -(jtl))
            else
                AddPersonAttrib(pid, "体力", -1);
            end
        end
    ------------------一次攻击伤害结束分界线-----------------   
    ----------------------计算连击----------------------------------------------------    
        WAR.ACT = WAR.ACT + 1 -- 统计攻击次数累加1

        -- 蓝烟清：攻击范围内的敌人全部死亡时取消连击
        local flag = 0;
        local n = 0;
        for i = 0, CC.WarWidth - 1 do
            for j = 0, CC.WarHeight - 1 do
                lib.GetKey()
                local effect = GetWarMap(i, j, 4)
                if 0 < effect then
                    local emeny = GetWarMap(i, j, 2)
                    if 0 <= emeny and WAR.Person[id]["我方"] ~= WAR.Person[emeny]["我方"] then
                        n = n + 1;
                        if JY.Person[WAR.Person[emeny]["人物编号"]]["生命"] > 0 then
                            flag = 1;
                        end
                    end
                end
            end
        end
        -- 无酒不欢：程灵素不会中断连击
        if flag == 0 and n > 0 and match_ID(pid, 2) == false then
            break
        end
        -- 内轻特效1029，太极之形增加连击
        if NeiGong_tx(pid, 1029) and WAR.PD["太极之形"][pid] ~= nil and WAR.PD["太极之形"][pid] >= 5 then
            WAR.ATNum = WAR.ATNum + 1
            WAR.PD["太极之形"][pid] = WAR.PD["太极之形"][pid] - 5
            WAR.TJZX_LJ = 1
        end
        -- if match_ID(pid,9994) then 
        if WAR.PD['无量禅震'][pid] ~= nil then
            if WAR.PD['无量禅震'][pid].s == 1 and WAR.PD['无量禅震'][pid].n < 3 then
                WAR.ATNum = WAR.ATNum + 1
                WAR.PD['无量禅震'][pid].s = nil
            end
        end
        -- 剑魔BOSS模式
        if match_ID(pid, 592) and Boss(WAR.CurID) then
            if WAR.PD['独孤剑势'][pid] ~= nil and WAR.PD['独孤剑势'][pid] >= 10 then
                WAR.PD['独孤剑势'][pid] = 1
            else
                WAR.PD['独孤剑势'][pid] = (WAR.PD['独孤剑势'][pid] or 1) + 1
            end
        end
        -- 无酒不欢：被杀气的动态显示
        DrawTimeBar2()
    end
    ---------------攻击后状态清除-----------------
    -- 天外连击判定取消
    WAR.TWLJ = 0
    WAR.DJJJ_LJ = 0
    WAR.wugongjz = 0
    -- 黯然极意范围恢复
    -- 老顾0305
    WAR.ARJY = 0
    WAR.BXZS = 0
    WAR.LMZS = 0
    WAR.ARJY1 = 0 -- 黯然极意	
    -- 云罗天网恢复
    WAR.YLTW = 0
    -- 九阴极意范围恢复
    WAR.JYSZ = 0
    -- 九阴极意1范围恢复
    WAR.JYSZ1 = 0
    WAR.PD["如来神掌"][pid] = nil
    WAR.PD["刀剑绝技"][pid] = nil
    WAR.PD["天魔解体"][pid] = nil
    WAR.PD["你是风儿我是沙1"][pid] = nil
    WAR.PD["你是风儿我是沙2"][pid] = nil
    WAR.PD["辟邪连击"][pid] = nil
    -- 狄云赤心连城计数恢复
    WAR.CXLC_Count = 0
    -- 无量连击恢复
    WAR.WLLJ_Count = 0
    -- 逍遥御风计数恢复
    WAR.YFCS = 0
    WAR.MHSN = 0
    WAR.DJD = 0
    WAR.QLJG = 0
    WAR.QMWZ = 0
    -- 连击结束

    -- 太极拳，借力打力，蓄力清除
    -- 武当弟子在这里清除
    if WAR.PD["蓄气值"][pid] ~= nil and WAR.PD["蓄气值"][pid] > 0 then
        -- 太极图
        if JY.Person[pid]['门派'] == 2 or (Curr_NG(pid, 171) and JY.Person[pid]['奇穴' .. 146] == 1) then
            WAR.PD["蓄气值"][pid] = math.modf(WAR.PD["蓄气值"][pid] / 2)
        else
            WAR.PD["蓄气值"][pid] = 0
        end
    end

    -- 如果触发了逆转乾坤的强化反弹效果，在这里恢复
    if WAR.NZQK > 0 then
        WAR.NZQK = 0
    end

    WarSetPerson()

    -- 斗转星移计算	标记修改
    local dz = {}
    local dznum = 0
    for i = 0, WAR.PersonNum - 1 do
        -- if WAR.Person[i]["反击武功"] ~= -1 and WAR.Person[i]["反击武功"] ~= 9999 then --如果反击武功不为空值 和？
        if WAR.Person[i]["反击武功"] ~= -1 then -- 如果反击武功不为空值 和？   
            dznum = dznum + 1 -- 斗转 = 斗转 +1 
            dz[dznum] = {i, WAR.Person[i]["反击武功"], x - WAR.Person[WAR.CurID]["坐标X"],  y - WAR.Person[WAR.CurID]["坐标Y"]} -- 斗转人数 = 反击武功 x Y坐标范围内
            if WAR.DZXYLV[WAR.Person[WAR.CurID]['人物编号']] ~= nil then
                if WAR.DZXYLV[WAR.Person[WAR.CurID]['人物编号']] < 200 then
                    WAR.Person[i]["反击武功"] = 9999
                    lib.Debug('斗转有用7' .. JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名'])
                    break
                elseif WAR.DZXYLV[WAR.Person[WAR.CurID]['人物编号']] == 200 then
                    WAR.Person[i]['反击武功'] = JY.Person[WAR.Person[i]["人物编号"]]['优先使用']
                    lib.Debug('反击有用1' .. JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名'])
                    break
                end
            else
                WAR.Person[i]['反击武功'] = JY.Person[WAR.Person[i]["人物编号"]]['优先使用']
                lib.Debug('反击有用3' .. JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名'])
                break
            end
            lib.Debug(JY.Person[WAR.Person[i]['人物编号']]['姓名'] .. '斗转有用6')
        end
    end
    for i = 1, dznum do
        local tmp = WAR.CurID
        WAR.CurID = dz[i][1]
        if WAR.Person[WAR.CurID]['死亡'] == false then
            WAR.DZXY = 1
            if WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 90 then
                -- WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 50
            elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 100 then
                -- WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 60
            elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 110 then
                -- WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 70
            elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 120 then -- 三才归元反击比例
                -- WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 80
            elseif WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] == 200 then -- 无酒不欢：增加斗转第四层
                -- WAR.DZXYLV[WAR.Person[WAR.CurID]["人物编号"]] = 100
            end
            if WAR.AutoFight == 1 or WAR.Person[WAR.CurID]['我方'] == false or WAR.ZDDH == 354 or
                JY.Person[WAR.Person[WAR.CurID]['人物编号']]['资质'] <= 79 then
                War_Fight_Sub(dz[i][1], dz[i][2] + 100, dz[i][3], dz[1][4])
            else
                War_Fight_Sub(dz[i][1], dz[i][2] + 100)
            end
            lib.Debug('斗转有用5' .. JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名'])
            WAR.PD['斗转武功气攻'][WAR.Person[WAR.CurID]["人物编号"]] = nil
            WAR.CurID = tmp
            WAR.DZXY = 0
        end
    end

    fjtx()

    if JY.Restart == 1 then
        return 1
    end
    WAR.PD['无量禅震'][pid] = {}

    if WAR.PD['降龙・双龙取水'][pid] ~= nil and WAR.PD['降龙・双龙取水'][pid] == 1 and
        JY.Person[pid]['生命'] > 0 then
        WAR.PD['降龙・双龙取水'][pid] = 2
        WAR.Person[WAR.CurID]['移动步数'] = 0
        if WAR.AutoFight == 1 or WAR.Person[WAR.CurID]['我方'] == false or WAR.ZDDH == 354 then
            Cat('自动攻击', wugongnum)
        else
            War_Fight_Sub(WAR.CurID, wugongnum)
        end
        WAR.PD['降龙・双龙吸水'][pid] = nil
    end
    return 1;
end

-- 战斗主函数
function WarMain(warid, isexp)
    ------------------------初始化战斗数据----------------------------
    WarLoad(warid) -- 初始化战斗数据
    WarSelectTeam_Enhance() -- 选择我方（优化版）
    WarSelectEnemy() -- 选择敌人

    Health_in_Battle() -- 无酒不欢：血量翻倍

    if JY.Restart == 1 then
        return false
    end

    CleanMemory()
    -- lib.PicInit()
    lib.ShowSlow(20, 1)
    WarLoadMap(WAR.Data["地图"]) -- 加载战斗地图

    -- 默认在当前场景战斗
    local BattleField = JY.SubScene
    if WAR.ZDDH == 354 then
        BattleField = 25
    end
    -- 倚天正线拿九阳战斗
    if WAR.ZDDH == 287 or WAR.ZDDH == 110 then
        BattleField = 116
    end

    for i = 0, CC.WarWidth - 1 do
        for j = 0, CC.WarHeight - 1 do
            lib.SetWarMap(i, j, 0, lib.GetS(BattleField, i, j, 0))
            lib.SetWarMap(i, j, 1, lib.GetS(BattleField, i, j, 1))
        end
    end

    -- 雪山落花流水战役
    if WAR.ZDDH == 42 then
        SetS(2, 24, 31, 1, 0)
        SetS(2, 30, 34, 1, 0)
        SetS(2, 27, 27, 1, 0)
    end

    -- 旧版华山论剑的擂台
    if WAR.ZDDH == 238 then
        for x = 24, 34 do
            for y = 24, 34 do
                lib.SetWarMap(x, y, 0, 1030)
            end
        end
        for y = 23, 35 do
            lib.SetWarMap(23, y, 1, 1174)
            lib.SetWarMap(35, y, 1, 1174)
        end
        for x = 24, 35 do
            lib.SetWarMap(x, 35, 1, 1174)
            lib.SetWarMap(x, 23, 1, 1174)
        end
        lib.SetWarMap(23, 23, 0, 1174)
        lib.SetWarMap(35, 35, 0, 1174)
        lib.SetWarMap(23, 35, 0, 1174)
        lib.SetWarMap(35, 23, 0, 1174)
        lib.SetWarMap(23, 23, 1, 2960)
        lib.SetWarMap(35, 35, 1, 2960)
        lib.SetWarMap(23, 35, 1, 2960)
        lib.SetWarMap(35, 23, 1, 2960)
    end
    -- 天关修正地形
    if WAR.ZDDH == 348 or WAR.ZDDH == 349 or WAR.ZDDH == 350 or WAR.ZDDH == 356 or WAR.ZDDH == 357 or WAR.ZDDH == 358 then
        lib.SetWarMap(28, 6, 1, 1843 * 2)
        lib.SetWarMap(28, 5, 1, 1843 * 2)
    end

    -- 20大高手，修正地形
    if WAR.ZDDH == 289 then
        lib.SetWarMap(39, 29, 1, 1417 * 2)
        lib.SetWarMap(39, 30, 1, 1416 * 2)
        lib.SetWarMap(39, 31, 1, 1416 * 2)
        lib.SetWarMap(39, 32, 1, 1417 * 2)
        for i = 40, 43 do
            lib.SetWarMap(i, 30, 0, 35 * 2)
            lib.SetWarMap(i, 31, 0, 35 * 2)
            lib.SetWarMap(i, 32, 0, 35 * 2)
            lib.SetWarMap(i, 30, 1, 0)
            lib.SetWarMap(i, 32, 1, 0)
        end
        for i = 30, 32 do
            lib.SetWarMap(40, i, 0, 76 * 2)
            lib.SetWarMap(41, i, 0, 72 * 2)
        end
        lib.SetWarMap(15, 19, 1, 1843 * 2)
        lib.SetWarMap(15, 20, 1, 1843 * 2)
    end
    -- 20大高手，修正地形
    if WAR.ZDDH == 337 then
        lib.SetWarMap(39, 29, 1, 1417 * 2)
        lib.SetWarMap(39, 30, 1, 1416 * 2)
        lib.SetWarMap(39, 31, 1, 1416 * 2)
        lib.SetWarMap(39, 32, 1, 1417 * 2)
        for i = 40, 43 do
            lib.SetWarMap(i, 30, 0, 35 * 2)
            lib.SetWarMap(i, 31, 0, 35 * 2)
            lib.SetWarMap(i, 32, 0, 35 * 2)
            lib.SetWarMap(i, 30, 1, 0)
            lib.SetWarMap(i, 32, 1, 0)
        end
        for i = 30, 32 do
            lib.SetWarMap(40, i, 0, 76 * 2)
            lib.SetWarMap(41, i, 0, 72 * 2)
        end

    end
    -- 战四大山，修正地形
    if WAR.ZDDH == 290 then
        for i = 5, 34 do
            lib.SetWarMap(7, i, 1, 0)
            lib.SetWarMap(9, i, 1, 0)
            lib.SetWarMap(54, i, 1, 0)
            lib.SetWarMap(56, i, 1, 0)
        end
    end

    -- 杀东方不败
    if WAR.ZDDH == 54 then
        lib.SetWarMap(11, 36, 1, 2)
    end

    -- 改变游戏状态
    JY.Status = GAME_WMAP

    -- 加载贴图文件
	LoadWMAP()
    --lib.PicLoadFile(CC.WMAPPicFile[1], CC.WMAPPicFile[2], 0)						--战场贴图，内存区域0

    lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.WX*100,0,100))	--人物大头像，内存区域1
	lib.LoadPNGPath(CC.ThingPath, 2, CC.ThingNum, limitX(CC.WX*100,0,100))	--物品贴图
    --lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)			--物品贴图，内存区域2
    --lib.LoadPNGPath('./data/thing',0,-1,100)
    lib.PicLoadFile(CC.EFTFile[1], CC.EFTFile[2], 3)								--特效贴图，内存区域3
    --lib.LoadPNGPath('./data/eft',3,-1,100)
    lib.LoadPNGPath(CC.PTPath, 95, CC.PTNum, limitX(CC.WX*100,0,100))

    lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.WX*100,0,100))

    lib.LoadPNGPath(CC.IconPath, 98, CC.IconNum, limitX(CC.WX*100,0,100))	--状态图标，内存区域98

    lib.LoadPNGPath(CC.HeadPath, 99, CC.HeadNum, 26.923076923)						--人物小头像，用于集气条，内存区域99

    lib.LoadPNGPath(CC.BodyPath, 90, CC.BodyNum, limitX(CC.WX*100,0,100))	--半身象
    lib.LoadPNGPath(CC.XTPath, 91, CC.XTNum, limitX(CC.WX*100,0,100))	--UI	
    lib.PicLoadFile(CC.BJ[1], CC.BJ[2], 92) 
    --lib.LoadPNGPath('./data/bj',0,-1,100)	
    lib.LoadPNGPath(CC.TFPath, 89, CC.TFNum, limitX(CC.WX * 100, 0, 100)) -- TF
    -- 无酒不欢：随机战斗音乐
    local zdmusic = {5,6,7,8,11,18}
    local zdyy = math.random(10) + 99
    zdyy = zdmusic[math.random(#zdmusic)]
    if CC.TX['怀旧音乐'] == 1 then 
        zdyy = math.random(10) + 99
    end
    -- 15大固定
    if WAR.ZDDH == 133 or WAR.ZDDH == 134 then
        zdyy = 27
    end

    -- VS少林诸僧战固定
    if WAR.ZDDH == 80 then
        zdyy = 22
    end

    if WAR.ZDDH == 377 then
        zdyy = 120
    end

    -- 葵花尊者战固定
    if WAR.ZDDH == 54 then
        zdyy = 112
    end

    -- 侠客邪固定
    if WAR.ZDDH == 170 then
        zdyy = 119
    end

    -- 蒙哥战固定
    if WAR.ZDDH == 278 then
        zdyy = 110
    end

    -- 武当战三丰固定
    if WAR.ZDDH == 22 then
        zdyy = 113
    end

    -- 20大高手战固定
    if WAR.ZDDH == 289 then
        zdyy = 115
    end

    -- 战四大山固定
    if WAR.ZDDH == 290 then
        zdyy = 117
    end

    -- 剑魔剑仙固定
    if WAR.ZDDH == 291 then
        zdyy = 118
    end

    PlayMIDI(zdyy)

    -- PlayMIDI(WAR.Data["音乐"])  

    local warStatus = nil -- 战斗状态

    WarPersonSort() -- 按轻功排序
    CleanWarMap(2, -1)
    CleanWarMap(6, -2)

    for i = 0, WAR.PersonNum - 1 do

        if i == 0 then
            WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"] =
                WE_xy(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"])
        else
            WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"] =
                WE_xy(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], i)
        end

        SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 2, i)

        local pid = WAR.Person[i]["人物编号"]
		LoadFights(pid,i) --适配新fight

        WAR.Person[i]["贴图"] = WarCalPersonPic(i)
        -- lib.PicLoadFile(string.format(CC.FightPicFile[1], JY.Person[pid]["头像代号"]), string.format(CC.FightPicFile[2], JY.Person[pid]["头像代号"]), 4 + i)	--人物战斗动作贴图，内存区域4-29（一场战斗上限26人）
        if WAR.ZDDH == 357 then
            WAR.Boss[513] = 1
        end
        if WAR.ZDDH == 358 then
            WAR.Boss[26] = 1
        end
        if WAR.ZDDH == 359 then
            WAR.Boss[592] = 1
        end
        if WAR.ZDDH == 350 then
            WAR.Boss[577] = 1
        end
        if WAR.ZDDH == 54 and WAR.MCRS == 1 then
            WAR.Boss[27] = 1
        end
        savetf(i)
        savewg(i)
    end
    ---------------------设置人物的初始集气位置------------------------	  
    -- 轻功对移动格子的计算
    -- x为战场轻功，y为体力
    local function getnewmove(x, y)
        local mob = x + y
        if mob > 478 then
            return 7
        elseif mob > 328 then
            return 6
        elseif mob > 198 then
            return 5
        elseif mob > 148 then
            return 4
        elseif mob > 126 then
            return 3
        elseif mob > 116 then
            return 2
        else
            return 1
        end
    end
    local function getdelay(x, y)
        return math.modf(1.5 * (x / y + y - 3))
    end

    for i = 0, WAR.PersonNum - 1 do
        WAR.Person[i]["贴图"] = WarCalPersonPic(i)
    end
    WarSetPerson()
    WAR.CurID = 0
    WarDrawMap(0)
    lib.ShowSlow(20, 0)

    -- 无酒不欢：设置人物的初始集气位置
    for i = 0, WAR.PersonNum - 1 do
        WAR.Person[i].Time = 800 - i * 1000 / WAR.PersonNum
        local id = WAR.Person[i]["人物编号"]
        local kf_ng = JY.Person[id]['主运内功']
        local dkfcj_ng = JY.Wugong[kf_ng]['层级']
        local kf_qg = JY.Person[id]['主运轻功']
        local dkfcj_qg = JY.Wugong[kf_qg]['层级']
        -- 老顾0309
        -- JY.Person[WAR.Person[i]["人物编号"]]["能量"] = 2 
        AddPersonAttrib(WAR.Person[i]["人物编号"], "能量", 2)
        -- 内轻特效304
        if NeiGong_tx(WAR.Person[i]["人物编号"], 304) then
            WAR.Person[i].Time = WAR.Person[i].Time - 500
        end
        -- 岳灵珊 每个剑法+50点初始集气
        if match_ID(WAR.Person[i]["人物编号"], 9842) then
            WAR.PD["入魔"][WAR.Person[i]["人物编号"]] = 1
            WAR.PD["破甲状态"][WAR.Person[i]["人物编号"]] = 1
            local JF = 0
            for i = 1, JY.Base["武功数量"] do
                if JY.Wugong[JY.Person[id]["武功" .. i]]["武功类型"] == 3 then
                    JF = JF + 1
                end
            end
            WAR.Person[i].Time = WAR.Person[i].Time + (JF) * 50
        end
        -- 令狐冲，一觉之后，初始满集气
        -- 闪电惊鸿
        if match_ID_awakened(WAR.Person[i]["人物编号"], 35, 1) or match_ID(WAR.Person[i]["人物编号"], 9941) or
            match_ID(WAR.Person[i]["人物编号"], 9996) then
            WAR.Person[i].Time = 990
        end
        -- 独孤求败 风清扬
        if match_ID(WAR.Person[i]["人物编号"], 592) or match_ID(WAR.Person[i]["人物编号"], 140) then
            WAR.Person[i].Time = 990
        end
        -- 血刀老祖 初始集气900
        if match_ID(WAR.Person[i]["人物编号"], 97) then
            WAR.Person[i].Time = 900
        end
        -- 太监初始集气-200
        if JY.Person[WAR.Person[i]["人物编号"]]["性别"] == 2 then
            WAR.Person[i].Time = -200
        end

        -- 林平之 初始集气900
        if match_ID(WAR.Person[i]["人物编号"], 36) then
            WAR.Person[i].Time = 900
        end

        -- 木桩的初始集气
        if WAR.Person[i]["人物编号"] == 591 and WAR.ZDDH == 226 then
            WAR.Person[i].Time = 0
        end

        -- 圣火神功 初始集气加200和100随机
        --内轻特效1013
        if NeiGong_tx(id,1013) then 
            WAR.Person[i].Time = WAR.Person[i].Time + dkfcj_ng*100
        end
        --内轻特效1013
        if NeiGong_tx(id,1013,1) then 
            WAR.Person[i].Time = WAR.Person[i].Time + dkfcj_qg*100
        end       
        if JY.Person[id]["坐骑"] == 312 then
            -- WAR.Person[i].Time = 998
        end
        -- 绣花针
        if JY.Person[id]["武器"] == 349 then
            WAR.Person[i].Time = 900
        end

        -- 论剑打赢阿凡提奖励，绝对先手，且全场敌方位置-500
        if WAR.Person[i]["人物编号"] == 0 and CC.TX["阿凡提奖励"] == 1 then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["我方"] ~= WAR.Person[j]["我方"] then
                    WAR.Person[j].Time = WAR.Person[j].Time - 500
                end
                if WAR.Person[j].Time < -50 then
                    WAR.Person[j].Time = -50
                end
            end
            WAR.Person[i].Time = 1005
        end
        if WAR.Person[i].Time > 990 then
            WAR.Person[i].Time = 990
        end
        --梁萧测试霸体
        if match_ID(id, 635) then
            Cat('护盾停止', WAR.CurID)
            WAR.Person[i]['护盾'] = 16
        end
        if match_ID(id, 577) then
            WAR.PD['菩提金身'][id] = 1
            Cat('护盾停止', WAR.CurID)
            WAR.Person[i]['护盾'] = 2
        end
        if match_ID(id, 752) then
            Cat('护盾停止', WAR.CurID)
            WAR.Person[i]['护盾'] = 12
        end
        if match_ID(id, 513) then
            if WAR.PD['破剑八刀'][id] == nil then
                WAR.PD['破剑八刀'][id] = 50
                WAR.PD['破剑八刀CD'][id] = 100
                Cat('护盾停止', WAR.CurID)
                WAR.Person[i]['护盾'] = 4
                WAR.CurID = i
                WarDrawMap(0)
                CurIDTXDH(WAR.CurID, 132, 1, '破剑八刀')
            end
        end
        -- savetf(i)
    end
    ---------------------携带物品的初始化-----------------------------    
    -- 携带物品的初始化
    for a = 0, WAR.PersonNum - 1 do
        for s = 1, 4 do
            if JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] == nil or
                JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] < 1 then
                JY.Person[WAR.Person[a]["人物编号"]]["携带物品" .. s] = -1
                JY.Person[WAR.Person[a]["人物编号"]]["携带物品数量" .. s] = 0;
            end
        end
    end
    --------------------特殊战斗设置----------------------------------	
    -- 笑傲邪线，黑木崖如果单挑东方不败，则东方会以葵花尊者形态出战
    if WAR.ZDDH == 54 and WAR.MCRS == 1 then
        local dfid;
        for i = 0, WAR.PersonNum - 1 do
            local id = WAR.Person[i]["人物编号"]
            if id == 27 then
                dfid = i;
                break
            end
        end
        local orid = WAR.CurID
        WAR.CurID = dfid

        Cls()
        local KHZZ = {"面对本座", "对方竟敢单独出战", "伤自尊啊"}

        for n = 1, #KHZZ + 25 do
            local i = n
            if i > #KHZZ then
                i = #KHZZ
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            DrawString(-1, -1, KHZZ[i], C_GOLD, CC.Fontsmall)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
        Cls()
        CurIDTXDH(WAR.CurID, 7, 1)

        for n = 1, 50 do
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.Background(0, 200, CC.ScreenW, 400, 78)
            NewDrawString(CC.ScreenW, CC.ScreenH / 2 + 160, "葵花诀尊者形态", C_GOLD, 80)
            NewDrawString(CC.ScreenW, CC.ScreenH / 2 + 360, "看吧 东方在赤红的燃烧", C_RED, 70)

            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
        Cls()
        local KHZZ2 = {"不知死活的" .. JY.Person[0]["外号2"], "好好体验一下死亡的恐怖吧"}

        for n = 1, #KHZZ2 + 25 do
            local i = n
            if i > #KHZZ2 then
                i = #KHZZ2
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            DrawString(-1, -1, KHZZ2[i], C_GOLD, CC.Fontsmall)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
        WAR.CurID = orid
    end

    if WAR.ZDDH == 356 then
        for n = 1, 50 do
            local j = 70 + n
            local k = 60 + n
            if j > 80 then
                j = 80
            end
            if k > 70 then
                k = 70
            end
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.Background(0, 200, CC.ScreenW, 400, 78)
            NewDrawString(CC.ScreenW, CC.ScreenH / 2 + 160, "四神之阵", C_GOLD, j)
            NewDrawString(CC.ScreenW, CC.ScreenH / 2 + 360, "风林火山", C_RED, k)

            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
        Cat('天关阵')
        -- local 
        -- WAR.PD['天关阵4'] = {5,27,50,114}
    end
    -- 圣火三使战开局的文字特效
    if WAR.ZDDH == 14 then
        say("Ｇ１妙风使！", 173, 0) -- 妙风使
        say("Ｇ１流云使！", 174, 1) -- 流云使
        say("Ｇ１辉月使！Ｈ圣火三绝阵！", 175, 5) -- 辉月使！Ｈ圣火三绝阵！
        for n = 15, 50 do
            local i = n
            if i > 35 then
                i = 35
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.GetKey()
            NewDrawString(-1, -1, "圣火三绝阵", C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    -- 侠客正太玄战李白对话
    if WAR.ZDDH == 302 then
        say("Ｄ２蓬莱文章建安骨，中间小谢又清发。", 636, 0)
        say("Ｄ２俱怀逸兴壮思飞，欲上青天览明月。", 0, 1)
        say("Ｄ２抽刀断水水更流，举杯消愁愁更愁。", 636, 0)
        say("Ｄ２人生在世不称意，明朝散发弄扁舟。", 0, 1)
    end
    if WAR.ZDDH > 0 then
        local id;
        for a = 0, WAR.PersonNum - 1 do
            id = WAR.Person[a]["人物编号"]
        end
        local md = false
        for j = 123, 128 do
            if id == j or id == 68 or JY.Base["畅想"] == 68 or JY.Base["畅想"] == 123 then
                md = true
            end
        end
        if md == true then
            for i = 15, 35 do
                lib.GetKey()
                NewDrawString(-1, -1, "天罡北斗阵.七星聚会", C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                Cls()
                if i == 35 then
                    lib.Delay(500)
                else
                    lib.Delay(5)
                end
            end
        end
    end
    if WAR.ZDDH > 0 then
        local id;
        for a = 0, WAR.PersonNum - 1 do
            id = WAR.Person[a]["人物编号"]
        end
        if (id >= 532 and id <= 538) and WAR.ZDDH > 0 then
            for i = 15, 35 do
                lib.GetKey()
                Cat('实时特效动画')
                Cls()
                Cat('实时特效动画2')
                lib.GetKey()
                NewDrawString(-1, -1, "真武七截阵", C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                Cls()
                if i == 35 then
                    lib.Delay(500)
                else
                    lib.Delay(5)
                end
            end
        end
    end
    if WAR.ZDDH > 0 then
        local id;
        local m = 0
        local m1 = 0
        local md = false
        for a = 0, WAR.PersonNum - 1 do
            id = WAR.Person[a]["人物编号"]
            for j = 1, JY.Base["武功数量"] do
                if JY.Person[id]["武功" .. j] == 82 then
                    if inteam(id) then
                        m = m + 1
                    else
                        m1 = m1 + 1
                    end
                end
            end
        end
        if m >= 3 then
            md = true
        elseif m1 >= 3 then
            md = true
        end
        if md == true then
            for i = 15, 35 do
                lib.GetKey()
                NewDrawString(-1, -1, "金刚伏魔圈.佛力伏魔", C_GOLD, CC.DefaultFont + i * 2)
                ShowScreen()
                Cls()
                if i == 35 then
                    lib.Delay(500)
                else
                    lib.Delay(5)
                end
            end
        end
    end

    -- 天正第五战
    if WAR.ZDDH == 81 then
        say("Ｒ＜今日一战，如果败了，我慕容复还有何颜面再苟活于世？定要殊死一搏！＞",
            51, 0)
        say(
            "Ｒ＜古来成大功业者，哪一个不历尽千辛万苦？汉高祖有白登之困，汉光武有冀北之厄，你连勾践、韩信也不如，当真无知无识！姑苏慕容氏的家传武功神奇精奥，当世罕有，只不过你没学到家而已。＞",
            113, 0)
    end

    -- 天邪第五战
    if WAR.ZDDH == 251 then
        say("Ｒ＜你……你是我爹爹……＞", 50, 0)
        say(
            "Ｒ＜好孩子，好孩儿，我正是你的爹爹。咱爷儿俩一般的身形相貌，不用记认，谁都知道我是你的老子。＞",
            112, 0)
    end

    -- 神正单挑金轮
    if WAR.ZDDH == 275 then
        say(
            "Ｒ＜郭襄大喜，凝目望那两人时，但见左首一人青冠黄衫，正是杨过，右首那人白衣飘飘，却是个美貌女子。???人各执长剑，舞起一团白光，随在神雕身后，冲向高台。郭襄失声叫道“大哥哥，这位就是小龙女么？””＞",
            626, 0)
        for n = 15, 50 do
            local i = n
            if i > 35 then
                i = 35
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.GetKey()
            NewDrawString(-1, -1, "龙象般若功.十龙十象", C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end
    -- 密道成昆战，我方集气全体为0
    if WAR.ZDDH == 237 then
        for a = 0, WAR.PersonNum - 1 do
            if WAR.Person[a]["我方"] == true then
                WAR.Person[a].Time = 0
            end
        end
    end
    if WAR.ZDDH == 386 then
        for a = 0, WAR.PersonNum - 1 do
            if WAR.Person[a]["我方"] == false then
                WAR.Person[a].Time = 0
            end
        end
    end

    -- 梁萧 谐之道・归藏
    if WAR.ZDDH > 0 and JY.Base["畅想"] == 635 and JY.Person[0]["六如觉醒"] > 0 then
        for n = 15, 50 do
            local i = n
            if i > 35 then
                i = 35
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.GetKey()
            NewDrawString(-1, -1, "谐之道・归藏", C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end
    JY.Person[512]["声望"] = 0
    JY.Person[512]["出战"] = 0
    JY.Person[512]["品德"] = 0
    -- 陆渐 海之道・海纳百川
    if WAR.ZDDH > 0 and JY.Base["畅想"] == 497 and JY.Person[0]["六如觉醒"] > 0 then

        for n = 15, 50 do
            local i = n
            if i > 35 then
                i = 35
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.GetKey()
            NewDrawString(-1, -1, "海之道・海纳百川", C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end

    -- 丐帮打狗阵
    if WAR.ZDDH == 344 then

        for n = 15, 50 do
            local i = n
            if i > 35 then
                i = 35
            end
            lib.GetKey()
            Cat('实时特效动画')
            Cls()
            Cat('实时特效动画2')
            lib.GetKey()
            NewDrawString(-1, -1, "真.打狗阵", C_GOLD, CC.DefaultFont + i * 2)
            ShowScreen()
            lib.Delay(CC.BattleDelay)
        end
    end
    ---------------------组合动画显示--------------------------------
    -- 组合动画显示
    if CC.CoupleDisplay == 1 then
        local function fightcombo()
            local combo = {}
            for i = 1, #CC.COMBO do
                combo[i] = {CC.COMBO[i][1], CC.COMBO[i][2], CC.COMBO[i][3], 0}
            end
            for i = 0, WAR.PersonNum - 1 do
                local t = WAR.Person[i]["人物编号"]
                for j = 1, #combo do
                    lib.GetKey()
                    if match_ID(t, combo[j][1]) then
                        for z = 0, WAR.PersonNum - 1 do
                            local t2 = WAR.Person[z]["人物编号"]
                            if match_ID(t2, combo[j][2]) and WAR.Person[i]["我方"] == WAR.Person[z]["我方"] then
                                combo[j][4] = 1
                                break
                            end
                        end
                    end
                end
            end
            for i = 1, #combo do
                if combo[i][4] == 1 then
                    local t1 = combo[i][1]
                    local t2 = combo[i][2]
                    for k = 0, 20 do
                        local j = k
                        if k > 10 then
                            k = 10
                        end
                        lib.GetKey()
                        local str = JY.Person[t1]["姓名"] .. "＆" .. JY.Person[t2]["姓名"]
                        local str2 = combo[i][3]
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        DrawBox(150, CC.ScreenH / 3 + 30, CC.ScreenW - 150, CC.ScreenH / 3 * 2 - 20, C_BLACK)
                        lib.LoadPNG(1, JY.Person[t1]["半身像"] * 2, CC.ScreenW / 4 - 80, CC.ScreenH / 2 - 35, 1)
                        lib.LoadPNG(1, JY.Person[t2]["半身像"] * 2, CC.ScreenW / 4 + 50, CC.ScreenH / 2 - 35, 1)
                        NewDrawString(CC.ScreenW / 2 * 3 - 170, CC.ScreenH + 120, str, C_ORANGE, 25)
                        NewDrawString(CC.ScreenW / 2 * 3 - 170, -1, str2, C_GOLD, 50 + j)
                        ShowScreen()
                        lib.Delay(CC.BattleDelay)
                    end
                end
            end
        end
        fightcombo()
    end

    warStatus = 0
    buzhen()

    -- 黄蓉奇门遁甲，我方才触发
    for j = 0, WAR.PersonNum - 1 do
        if match_ID(WAR.Person[j]["人物编号"], 56) and WAR.Person[j]["我方"] == true then
            WarNewLand(j, WAR.Person[j]["坐标X"], WAR.Person[j]["坐标Y"])
            break
        end
    end

    WAR.Delay = GetJiqi()
    local startt, endt = lib.GetTime()

    ----------------------- 战斗主循环 -----------------------------
    -- 战斗主循环
    while true do
        if JY.Restart == 1 then
            return false
        end

        local p = -1
        local id = -1
        WAR.ShowHead = 0
        WAR.CurID = DrawTimeBar()
        if WAR.ZYHB == 1 then
            WAR.ZYHB = 2
        end

        if WAR.ATK['中断'] == true then
            WAR.ATK['中断'] = false
            goto label0
        end

        Cat('人物移动步数')
        WarDrawMap(0)
        lib.GetKey()
        ShowScreen()
        p = WAR.CurID
        id = WAR.Person[p]["人物编号"]
        if WAR.PD['内伤状态'][id] == nil then
            WAR.PD['内伤状态'][id] = 0
        end
        if 0 < War_isEnd() then
            goto label0
        end

        if WAR.Person[p]["死亡"] == false and JY.Person[id]['生命'] > 0 then
            WAR.Person[p].Time = 1000
            Cat('实时特效动画')
            WarDrawMap(0)
            Cat('实时特效动画2')
            local keypress = lib.GetKey()
            -- 自动停止
            if WAR.AutoFight == 1 and (keypress == VK_SPACE or keypress == VK_RETURN) then
                WAR.AutoFight = 0
            end

            ShowScreen()
            lib.Delay(CC.BattleDelay)
            WAR.ShowHead = 0
            WAR.Person[p].TimeAdd = 0
            local r = nil
            local pid = id
            if JY.Person[pid]['主运内功'] == 0 then 
                for i = 1,JY.Base['武功数量'] do 
                    if JY.Wugong[JY.Person[pid]['武功'..i]]['武功类型'] == 6 then 
                        JY.Person[pid]['主运内功'] = JY.Person[pid]['武功'..i]
                        break
                    end
                end
            end
            if JY.Person[pid]['主运轻功'] == 0 then 
                for i = 1,JY.Base['武功数量'] do 
                    if JY.Wugong[JY.Person[pid]['武功'..i]]['武功类型'] == 7 then 
                        JY.Person[pid]['主运轻功'] = JY.Person[pid]['武功'..i]
                        break
                    end
                end
            end
            local kf_ng = JY.Person[pid]['主运内功']
            local kf_qg = JY.Person[pid]['主运轻功']
            local dkfcj_ng = JY.Wugong[kf_ng]['层级']
            local dkfcj_qg = JY.Wugong[kf_qg]['层级']
            WAR.Defup[pid] = nil
            -- lib.Debug(pid..'行动前：使用武功 ====='..JY.Wugong[JY.Person[pid]['优先使用']]['名称'])
            -- 逍遥御风，行动前恢复
            -- 左右第二下不会清0
            if WAR.PD["逍遥御风"][pid] ~= nil and WAR.PD["逍遥御风"][pid] == 11 and WAR.ZYHB ~= 2 then
                WAR.PD["逍遥御风"][pid] = nil
            end
            if WAR.JJPZ[pid] ~= nil then
                WAR.JJPZ[pid] = nil
            end
            -- 段誉的指令，行动前恢复
            if match_ID(pid, 53) then
                WAR.TZ_DY = 0
            end
            if JY.Person[pid]['门派'] == 29 then
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["我方"] ~= WAR.Person[p]['我方'] then
                        local mz = WAR.PD['密宗印记'][WAR.Person[i]['人物编号']]
                        if mz == nil then
                            mz = 0
                        end
                        WAR.PD['密宗印记'][WAR.Person[i]['人物编号']] = mz + 1
                    end
                end
            end
            -- 慕容复的指令，行动前恢复
            if match_ID(pid, 51) then
                WAR.TZ_MRF = 0
            end
            if WAR.PD['百劫'][pid] ~= nil then 
                WAR.PD['百劫'][pid] = nil 
            end
            WAR.ZSSS = 0 -- 张三
            WAR.LSFE = 0 -- 李四
            -- 浩然正气
            if JY.Person[pid]['奇穴' .. 139] == 1 and WAR.ZYHB ~= 2 then
                local hrnum = {'一', '二', '三', '四', '五', '六', '七', '八', '九', '十', '十一', '十二',
                               '十三', '十四', '十五', '十六', '十七', '十八', '十九', '二十', '二一',
                               '二二', '二三', '二四', '二五', '二六', '二七', '二八', '二九'}
                -- lib.Debug()				
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false then
                        local hid = WAR.Person[i]['人物编号']
                        for j = 1, #WAR.Debuf do
                            local yc = WAR.Debuf[j][1]
                            if WAR.PD[yc][hid] ~= nil and WAR.PD[yc][hid] > 0 then
                                -- lib.Debug('浩然判定成功')
                                if WAR.PD['浩然正气'][pid] == nil then
                                    WAR.PD['浩然正气'][pid] = 0
                                end
                                WAR.PD['浩然正气'][pid] = WAR.PD['浩然正气'][pid] + 1
                                if WAR.PD['浩然正气'][pid] > 29 then
                                    WAR.PD['浩然正气'][pid] = 29
                                end
                                lib.Debug('debuf==' .. WAR.PD['浩然正气'][pid])
                                WAR.PD[yc][hid] = nil
                            end
                        end
                    end
                end
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false then
                        local hid = WAR.Person[i]['人物编号']
                        for j = 1, #WAR.Debuf2 do
                            local yc = WAR.Debuf2[j][1]
                            if WAR.PD[yc][hid] ~= nil and WAR.PD[yc][hid] > 0 then
                                if WAR.PD['浩然正气'][pid] == nil then
                                    WAR.PD['浩然正气'][pid] = 0
                                end
                                WAR.PD['浩然正气'][pid] = WAR.PD['浩然正气'][pid] + 1
                                if WAR.PD['浩然正气'][pid] > 29 then
                                    WAR.PD['浩然正气'][pid] = 29
                                end
                                lib.Debug('Debuf2=='..WAR.PD['浩然正气'][pid])

                                WAR.PD[yc][hid] = nil
                            end
                        end
                    end
                end

                for j = 1, #WAR.Debuf1 do
                    -- lib.Debug('浩然判定成功1')	
                    local yc = WAR.Debuf1[j][1]
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["死亡"] == false then
                            -- lib.Debug('浩然判定成功2')
                            local hid = WAR.Person[i]['人物编号']
                            local p = JY.Person[hid]

                            if WAR.PD[yc][hid] ~= nil and WAR.PD[yc][hid] > 0 then
                                -- lib.Debug('浩然判定成功3')						
                                if WAR.PD['浩然正气'][pid] == nil then
                                    WAR.PD['浩然正气'][pid] = 0
                                end
                                WAR.PD['浩然正气'][pid] = WAR.PD['浩然正气'][pid] + 1
                                if WAR.PD['浩然正气'][pid] > 29 then
                                    WAR.PD['浩然正气'][pid] = 29
                                end
                                -- lib.Debug('Debuf1=='..WAR.PD['浩然正气'][pid])
                                if p["中毒程度"] > 0 then -- 中毒
                                    p["中毒程度"] = 0
                                end
                                if p["冰封程度"] > 0 then -- 冰封
                                    p["冰封程度"] = 0
                                end
                                if p["灼烧程度"] > 0 then
                                    p["灼烧程度"] = 0 -- 灼烧
                                end
                                if p["受伤程度"] > 0 then
                                    p["受伤程度"] = 0 -- 内伤
                                end
                                if WAR.FXDS[hid] ~= nil and WAR.FXDS[hid] > 0 then -- 封穴
                                    WAR.FXDS[hid] = nil
                                end
                                if WAR.LXZT[hid] ~= nil and WAR.LXZT[hid] > 0 then -- 流血
                                    WAR.LXZT[hid] = nil
                                end
                                WAR.PD[yc][hid] = nil
                            end
                        end
                    end
                end
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false then
                        local hid = WAR.Person[i]['人物编号']
                        for j = 1, #WAR.Buf do
                            local yc = WAR.Buf[j][1]
                            if WAR.PD[yc][hid] ~= nil and WAR.PD[yc][hid] > 0 and WAR.Person[i]['我方'] ~=
                                WAR.Person[WAR.CurID]['我方'] then
                                if WAR.PD['浩然正气'][pid] == nil then
                                    WAR.PD['浩然正气'][pid] = 0
                                end
                                WAR.PD['浩然正气'][pid] = (WAR.PD['浩然正气'][pid] or 0) + 1
                                if WAR.PD['浩然正气'][pid] > 29 then
                                    WAR.PD['浩然正气'][pid] = 29
                                end
                                -- lib.Debug('Buf=='..WAR.PD['浩然正气'][pid])
                                -- WAR.PD[yc][hid] = nil
                            end
                        end
                    end
                end
                -- War_ShowFight(id,0,0,0,0,0,1);                
            end
            -- 金轮 龙象
            if match_ID(pid, 9931) and JLSD(0, 30, pid) then
                if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 1000 then
                    WAR.PD["十龙十象"][pid] = 1
                    JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 10
                    JY.Person[pid]["内力"] = JY.Person[pid]["内力"] - 1000
                end
            end
            -- 花铁杆
            if pid == 0 and JY.Base["畅想"] == 52 then
                CurIDTXDH(WAR.CurID, 104, 1, "文体两开花", LimeGreen);
                local clone_choice = CC.HTG[math.random(#CC.HTG)]
                JY.Person[0]["代号"] = JY.Person[clone_choice]["代号"]
                JY.Person[0]["姓名"] = JY.Person[clone_choice]["姓名"]
                JY.Person[0]["头像代号"] = JY.Person[clone_choice]["头像代号"]
                JY.Person[0]["半身像"] = JY.Person[clone_choice]["半身像"]
                for i = 1, 5 do
                    JY.Person[0]["出招动画帧数" .. i] = JY.Person[clone_choice]["出招动画帧数" .. i]
                    JY.Person[0]["出招动画延迟" .. i] = JY.Person[clone_choice]["出招动画延迟" .. i]
                    JY.Person[0]["武功音效延迟" .. i] = JY.Person[clone_choice]["武功音效延迟" .. i]
                end
                if JY.Person[clone_choice]["武功1"] > 0 then
                    JY.Person[0]["武功1"] = JY.Person[clone_choice]["武功1"]
                end
                savewg(WAR.CurID)
                CurIDTXDH(WAR.CurID, 104, 1, "文体两开花", LimeGreen);
                SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 5,
                    WAR.Person[WAR.CurID]["贴图"])
                SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 2, WAR.CurID)
                SetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 10,
                    JY.Person[WAR.Person[WAR.CurID]["人物编号"]]['头像代号'])
                WarDrawMap(0)
                DrawTimeBar2()
            end
            -- 万象天引
            if Pmiji(pid, 7) then
                WAR.PD['万象CD'][pid] = (WAR.PD['万象CD'][pid] or 0) + 1
                if WAR.PD['万象CD'][pid] == 3 then
                    WAR.PD['万象CD'][pid] = 0
                    WANXIANGTY(WAR.CurID)
                end
            end
            if match_ID(pid, 9877) then
                WAR.PD["魔神降临计时"][pid] = (WAR.PD["魔神降临计时"][pid] or 0) + 1
                if WAR.PD["魔神降临计时"][pid] == 3 then
                    if WAR.PD["魔神降临"][pid] == 50 then
                        CurIDTXDH(WAR.CurID, 128, 1, "魔神降临", C_RED);
                    end
                    WAR.PD["魔神降临计时"][pid] = nil
                end
            end
            --内轻特效1035
            if NeiGong_tx(id,1035) and JLSD(0,dkfcj_ng*25,id) then 
                local jmenu = {'即墨老酒', '玉露酒', '梨花酒', '五宝花蜜酒'}
                local jiu = jmenu[math.random(#jmenu)]
                if WAR.PD[jiu][id] == nil then
                    WAR.PD[jiu][id] = WAR.PD[jiu][id] or 0 + 50
                    -- War_ShowFight(id,0,0,0,0,0,30);
                    CurIDTXDH(WAR.CurID, 168, 1, "酒神", C_RED);
                end
                for i = 1,#jmenu do 
                    if WAR.PD[jmenu[i]][id] ~= nil and WAR.PD[jmenu[i]][id] > 0 then 
                        WAR.PD['醉意'][id] = (WAR.PD['醉意'][id] or 0 ) + 2
                        if WAR.PD['醉意'][id] > 10 then 
                            WAR.PD['醉意'][id] = 10
                        end
                    end
                end
            end
            -- 逍遥游 浑天气功
            if Curr_NG(id, 264) and JY.Person[id]['奇穴' .. 135] == 1 then
                local jmenu = {'即墨老酒', '玉露酒', '梨花酒', '五宝花蜜酒'}
                local jiu = jmenu[math.random(#jmenu)]
                if WAR.PD[jiu][id] == nil then
                    WAR.PD[jiu][id] = 50
                    -- War_ShowFight(id,0,0,0,0,0,30);
                    CurIDTXDH(WAR.CurID, 168, 1, "酒神", C_RED);
                end
            end
            -- 阿紫，禁药
            if match_ID(pid, 9757) and JLSD(0, 50, pid) then
                WAR.PD["禁药状态"][pid] = 1
                CurIDTXDH(WAR.CurID, 128, 1, "引盅入体", C_RED);
                -- return 20
            end
            -- 阿九，行动开始前，60%几率降低敌方集气-150点
            if match_ID(pid, 9799) and JLSD(20, 80, pid) then
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 150
                    end
                end
                DrawTimeBar2()
            end

            -- 止杀计时状态已方
            if match_ID(pid, 9831) and WAR.PD["止杀CD"][pid] ~= nil then
                WAR.PD["止杀CD"][pid] = WAR.PD["止杀CD"][pid] - 1
                if WAR.PD["止杀CD"][pid] <= 0 then
                    WAR.PD["止杀CD"][pid] = nil
                end
            end
            -- 尹克西
            if match_ID(pid, 158) then
                if JLSD(0, 30, pid) then
                    local s = WAR.CurID
                    -- WAR.CurID = i
                    WarDrawMap(0)
                    local XZ = {}
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] ==
                            false then
                            WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                            local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[j]["坐标X"])
                            local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[j]["坐标Y"])
                            local jl = 9
                            if offset1 <= jl and offset2 <= jl then
                                table.insert(XZ, j)
                            end
                        end
                    end
                    if #XZ > 0 then
                        CurIDTXDH(WAR.CurID, 106, 1, "金钱镖", PinkRed)
                        local ri = XZ[math.random(#XZ)]
                        War_ExecuteMenu_Sub(WAR.Person[ri]["坐标X"], WAR.Person[ri]["坐标Y"], 4, 31)
                        WAR.CurID = s
                    end
                end
            end

            -- 摩天居士
            if match_ID(pid, 164) then
                if WAR.PD['玄铁令'][id] ~= nil then
                    WAR.PD['玄铁令'][id] = nil
                end
                local xt = math.random(3)
                WAR.PD["玄铁令"][pid] = xt
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 186, 1, "玄铁令", C_ORANGE);
            end
            -- 先天调息，60%几率休息 标记修改
            --内轻特效1003
            if NeiGong_tx(pid,1003) and JLSD(0,dkfcj_ng*25,pid) then 
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 19,1,"调息",C_ORANGE);
                WAR.XTTX = 1
                War_RestMenu()
                WAR.XTTX = 0
            end
            if WAR.PD['蛇影'][pid] ~= nil then
                if JY.Person[pid]['中毒程度'] > 0 then
                    AddPersonAttrib(id, "生命", JY.Person[pid]['中毒程度'] * (1 + WAR.PD['蛇影'][pid] / 10))
                end
            end

            -- 金刚狮子吼
            if Curr_NG(pid, 91) then
                CleanWarMap(4, 0)
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                        local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                        local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                        if offset1 <= 7 and offset2 <= 7 then
                            SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                            WAR.PD["金刚咒"][WAR.Person[i]["人物编号"]] = 1
                        end
                    end
                end
            end

            -- 金刚狮子吼		
            if Curr_NG(pid, 91) then
                CleanWarMap(4, 0)
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["我方"] == WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                        local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                        local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                        if offset1 <= 7 and offset2 <= 7 then
                            SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                            -- WAR.PD["金刚护盾"][WAR.Person[i]["人物编号"]] = 200
                            WAR.PD['护盾值'][WAR.Person[i]["人物编号"]] =
                                WAR.PD['护盾值'][WAR.Person[i]["人物编号"]] or 0 + 200
                        end
                    end
                end
                -- WAR.PD["金刚护盾"][pid] = 200
                WAR.PD['护盾值'][pid] = WAR.PD['护盾值'][pid] or 0 + 200
            end

            -- 金刚狮子吼		
            if PersonKF(pid, 91) then
                CleanWarMap(4, 0)
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                        local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                        local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                        if offset1 <= 7 and offset2 <= 7 then
                            SetWarMap(WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"], 4, 1)
                            if Curr_NG(pid, 91) and JLSD(10, 30, pid) then
                                WAR.PD["度化状态"][WAR.Person[i]["人物编号"]] = 1
                            end
                        end
                    end
                end
                lib.Delay(20)
                DrawTimeBar2()
            end

            -- 紫衫龙王
            if (match_ID(pid, 15) or match_ID(pid, 9817)) and JY.Person[id]["生命"] > 0 then
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] == false then
                        if JLSD(10, 30, pid) then
                            WAR.PD["魅惑状态"][WAR.Person[i]["人物编号"]] = 1
                        end
                    end
                end
                CurIDTXDH(WAR.CurID, 129, 1, "倾国倾城", LimeGreen);
            end
            --风流
            if WAR.PD['风流'][pid] ~= nil and WAR.PD['风流'][pid] == 1 then 
                local num = 0
                for i = 0 , WAR.PersonNum - 1 do 
                    if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then 
                        num = num + 1
                        if num > 1 then 
                            if JY.Person[WAR.Person[i]['人物编号']]['性别'] == 1 and JLSD(0,dkfcj_ng*15,pid) then 
                                WAR.PD["魅惑状态"][WAR.Person[i]["人物编号"]] = 1
                            end 
                            if JY.Person[WAR.Person[i]['人物编号']]['性别'] == 1 and JLSD(0,dkfcj_ng*5,pid) then 
                                WAR.PD["魅惑状态"][WAR.Person[i]["人物编号"]] = 1
                            end 
                        end
                    end
                end
                WAR.PD['风流'][pid] = nil
            end
            -- 吴侬软语 行动开始前，提升我方100集气
            if (match_ID(pid, 105) or match_ID(pid, 9871)) and JY.Person[id]["生命"] > 0 then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 20, 1, "吴侬软语", LimeGreen);
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                        WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + 100
                    end
                end
                lib.Delay(20)
                DrawTimeBar2()
            end
            -- 老顾0309
            -- JY.Person[pid]["能量"] = JY.Person[pid]["能量"] + 1
            -- AddPersonAttrib(pid,'能量',1)
            PNGHH_nl(pid) -- 主运内功能量回复
            -- 内轻特效207
            if NeiGong_tx(pid, 207) then
                if WAR.PD['虚弱状态'][pid] ~= nil then
                    WAR.PD['虚弱状态'][pid] = nil
                end
            end
            -- 内轻特效208
            if NeiGong_tx(pid, 208) then
                if WAR.PD['散功状态'][pid] ~= nil then
                    WAR.PD['散功状态'][pid] = nil
                end
            end
            -- 内轻特效209
            if NeiGong_tx(pid, 209) then
                if WAR.PD['破甲状态'][pid] ~= nil then
                    WAR.PD['破甲状态'][pid] = nil
                end
            end
            -- 内轻特效210
            if NeiGong_tx(pid, 210) then
                if WAR.PD['点燃'][pid] ~= nil then
                    WAR.PD['点燃'][pid] = nil
                end
            end
            -- 内轻特效211
            if NeiGong_tx(pid, 211) then
                if WAR.PD['剧毒'][pid] ~= nil then
                    WAR.PD['剧毒'][pid] = nil
                end
            end

            -- 天仙锁魂
            if match_ID(pid, 9784) then
                local txsh = math.random(5)
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        if WAR.PD["破甲状态"][WAR.Person[j]["人物编号"]] == nil and JLSD(0, 60, pid) then
                            WAR.PD["破甲状态"][WAR.Person[j]["人物编号"]] = 2
                        end
                    end
                end
            end
            -- 万佛朝宗	标记修改
            if match_ID(pid, 577) then
                WAR.PD["降临"][pid] = (WAR.PD["降临"][pid] or 0) + 1
                if WAR.PD["降临"][pid] > 5 then
                    WAR.PD["降临"][pid] = 5
                end
            end
            -- 血海魔功行动前吸取七格内敌人的流血为已用
            --内轻特效1042
            if NeiGong_tx(pid,1042) then
                local hpmax = JY.Person[pid]['生命最大值']
                local hp = JY.Person[pid]['生命']
                local xhmg = 0
                local xhhd = 0
                for x = 0, WAR.PersonNum - 1 do
                    if WAR.Person[x]['我方'] ~= WAR.Person[WAR.CurID]['我方'] and
                        WAR.LXZT[WAR.Person[x]['人物编号']] ~= nil then
                        xhmg = xhmg + WAR.LXZT[WAR.Person[x]['人物编号']]
                    end
                end
                WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", xhmg)
                if hp + xhmg > hpmax then 
                    xhhd = hp + xhmg - hpmax
                end
                local xhn = JY.Person[pid]['生命最大值'] * 10 / 100
                if xhhd > xhn then 
                    xhhd = xhn
                end
                if xhhd > 0 then
                    WAR.PD['护盾值'][pid] = WAR.PD['护盾值'][pid] or 0 + xhhd
                    Cat('护盾停止', WAR.CurID)
                    WAR.Person[WAR.CurID]['护盾'] = 6
                end
            end
            --if Curr_NG(pid, 100) and WAR.PD["先天护盾CD"][pid] == nil then
            --内轻特效1004
            if NeiGong_tx(pid,1004) and WAR.PD["先天护盾CD"][pid] == nil then 
                WAR.PD['护盾值'][pid] = WAR.PD['护盾值'][pid] or 0 + dkfcj_ng*125
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 80, 1, "罡气护体", C_ORANGE);
                Cat('护盾停止', WAR.CurID)
                WAR.Person[WAR.CurID]['护盾'] = 6
                WAR.PD["先天护盾CD"][pid] = 200 - dkfcj_ng*25
            end

            -- 丘处机 一言止杀and WAR.LQZ[pid] == 100
            if match_ID(pid, 9831) and JY.Person[pid]["体力"] > 25 and WAR.LQZ[pid] == 100 then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 98, 1, "一言止杀", C_GOLD)
                for j = 0, WAR.PersonNum - 1 do
                    local zid = WAR.Person[j]["人物编号"]
                    if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false then
                        local offset1 = math.abs(WAR.Person[j]["坐标X"] - WAR.Person[WAR.CurID]["坐标X"])
                        local offset2 = math.abs(WAR.Person[j]["坐标Y"] - WAR.Person[WAR.CurID]["坐标Y"])
                        if offset1 < 10 and offset2 < 10 then
                            WAR.PD["恐惧状态"][zid] = 1
                            WAR.Person[j]["特效动画"] = 123
                        end
                    end
                end
                JY.Person[pid]["体力"] = JY.Person[pid]["体力"] - 25
                WAR.PD["止杀CD"][pid] = 2
            end
            -- 霍青桐统率指令，我方全体提升500时序
            if match_ID(pid, 9829) then
                if JY.Person[pid]["体力"] > 10 and JY.Person[pid]["内力"] > 150 and WAR.HQT_CD == 0 then
                    CurIDTXDH(WAR.CurID, 92, 1, "指挥"); -- 动画显示
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == true and WAR.Person[i]["死亡"] == false then
                            WAR.PD["号令三军"][WAR.Person[i]["人物编号"]] = 50
                            WAR.HQT_CD = 2
                            WAR.Person[i].Time = WAR.Person[i].Time + 300;
                            if WAR.Person[i].Time > 999 then
                                WAR.Person[i].Time = 999;
                            end
                        end
                    end
                    AddPersonAttrib(pid, "体力", -15)
                    AddPersonAttrib(pid, "内力", -500)
                end
            end
            --内轻特效1023
            if NeiGong_tx(pid,1023) then 
                Cat('清除基础异常', WAR.CurID)
            -- 阿青，行动前清除所有异常
            elseif match_ID(pid, 604) then
                Cat('清除所有异常', WAR.CurID)
            -- 内轻特效1022
            elseif NeiGong_tx(pid,1022) then 
                Cat('清除基础异常', WAR.CurID)
            elseif WAR.JHZT == 1 then
                Cat('清除基础异常', WAR.CurID)
                WAR.JHZT = 0
            end

            if WAR.PD['我无'][pid] ~= nil then
                WAR.PD['我无'][pid] = nil
            end

            if JY.Person[pid]["生命"] > 0 and JY.Person[pid]["中毒程度"] > 0 and WAR.ZYHB ~= 2 then
                local heal_amount1;
                local heal_amount;
                heal_amount = JY.Person[pid]["生命"]
                heal_amount1 = JY.Person[pid]["中毒程度"]
                if heal_amount1 > heal_amount then
                    heal_amount1 = heal_amount - 1
                end
                WAR.Person[WAR.CurID]["Life_Before_Hit"] = JY.Person[WAR.CurID]["生命"]
                if WAR.PD["剧毒"][pid] ~= nil then
                    heal_amount1 = heal_amount1 * 2
                end
                if pid == 0 and JY.Base["标准"] == 9 then
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", heal_amount1);
                else
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(pid, "生命", -heal_amount1);
                end
                Cls();
                War_Show_Count(WAR.CurID, "毒性发作");
            end

            -- 萧远山杀破狼
            if match_ID(pid, 112) and JY.Person[pid]["生命"] > 0 and WAR.PD["杀破狼"][pid] == nil and
                WAR.PD["杀破狼计时"][pid] == nil then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示				
                CurIDTXDH(WAR.CurID, 122, 1, "杀破狼", M_DeepSkyBlue);
                WAR.LQZ[pid] = 100
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示		
                WAR.PD["杀破狼"][pid] = 3
                WAR.PD["杀破狼计时"][pid] = 1
            end
            -- 盖世神拳，自动蓄力
            if JY.Person[pid]['奇穴' .. 40] == 1 and JY.Wugong[JY.Person[pid]['优先使用']]['武功类型'] == 1 then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示				
                CurIDTXDH(WAR.CurID, 146, 1, "盖世神拳", C_RED);
                WAR.LQZ[id] = 100
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示	
            end
            -- 徐子陵
            if match_ID(pid, 9979) and WAR.ZYHB ~= 2 then
                Bagua(pid)
            end
            -- 只剩一个敌人时不会进行随机
            if WAR.PD["魅惑状态"][pid] ~= nil then
                local EmenyNum = 0
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == false then
                        EmenyNum = EmenyNum + 1
                    end
                end
                if EmenyNum > 1 then
                    if math.random(2) == 1 then
                        WAR.Person[p]["我方"] = true
                    else
                        WAR.Person[p]["我方"] = false
                    end
                end
            end
            if WAR.PD["度化状态"][pid] ~= nil then
                local EmenyNum = 0
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == false then
                        EmenyNum = EmenyNum + 1
                    end
                end
                if EmenyNum > 1 then
                    WAR.Person[p]["我方"] = true
                end
            end

            if WAR.PD["魅惑状态"][pid] ~= nil then
                local EmenyNum = 0
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == false then
                        EmenyNum = EmenyNum + 1
                    end
                end
                if EmenyNum > 1 then
                    WAR.Person[p]["我方"] = true
                end
            end
            if match_ID(pid, 9939) then
                local pd = false
                if JY.Person[pid]["生命"] == JY.Person[pid]["生命最大值"] then
                    pd = true
                end
                if JY.Person[pid]["内力"] == JY.Person[pid]["内力最大值"] then
                    pd = true
                end
                if JY.Person[pid]["体力"] == 100 then
                    pd = true
                end
                if WAR.LQZ[pid] == 100 then
                    pd = true
                end
                if pd == true then
                    Cat('清除所有异常', WAR.CurID)
                    local R = math.random(4)
                    if R == 1 then
                        JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
                    end
                    if R == 2 then
                        JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
                    end
                    if R == 3 then
                        JY.Person[pid]["体力"] = 100
                    end
                    if R == 4 then
                        JY.Person[pid]["体力"] = 100
                        JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
                        JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
                    end
                end
            end
            -- 内轻特效1021
            if NeiGong_tx(pid,1021) and JY.Person[pid]["生命"] > 0 then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 64, 1, "暴雨梨花", LightGreen);
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        local zid = WAR.Person[i]["人物编号"]
                        for j = 1, #WAR.Debuf1 do
                            if j == math.random(#WAR.Debuf1) then
                                local dbf = WAR.Debuf1[j][1]
                                local n = math.random(5, 15)
                                if WAR.PD[dbf][zid] == nil then
                                    WAR.PD[dbf][zid] = n
                                else
                                    WAR.PD[dbf][zid] = (WAR.PD[dbf][zid] or 0) + n
                                end
                                WAR.TXXS[zid] = 1
                            end
                        end
                    end
                end
            end
            -- 毒布武林 标记修改
            if Pmiji(pid, 8) and JY.Person[pid]["生命"] > 0 then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 64, 1, "毒布武林", LightGreen);
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
                        myzd(j) then
                        WAR.Person[j]["中毒点数"] = War_PoisonHurt(pid, j)
                    end
                end
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        local zid = WAR.Person[i]["人物编号"]
                        for j = 1, #WAR.Debuf3 do
                            if j == math.random(#WAR.Debuf3) then
                                local dbf = WAR.Debuf3[j][1]
                                local n = math.random(5, 15)
                                if WAR.PD[dbf][zid] == nil then
                                    WAR.PD[dbf][zid] = n
                                else
                                    WAR.PD[dbf][zid] = (WAR.PD[dbf][zid] or 0) + n
                                end
                                WAR.TXXS[zid] = 1
                            end
                        end
                    end
                end
            end
            -- 受想行识
            if match_ID(pid, 9940) and Boss(WAR.CurID) then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 78, 1, "受想行识", C_ORANGE);
                local nm = 0
                for i = 0, WAR.PersonNum - 1 do
                    if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                        local zid = WAR.Person[i]["人物编号"]
                        for j = 1, #WAR.Debuf do
                            if j == math.random(#WAR.Debuf) then
                                local dbf = WAR.Debuf[j][1]
                                local n = math.random(20, 50)
                                if WAR.PD[dbf][zid] == nil then
                                    WAR.PD[dbf][zid] = n
                                else
                                    WAR.PD[dbf][zid] = (WAR.PD[dbf][zid] or 0) + n
                                end
                                WAR.TXXS[zid] = 1
                            end
                        end
                        for j = 1, #WAR.Debuf2 do
                            if j == math.random(#WAR.Debuf2) then
                                local dbf = WAR.Debuf2[j][1]
                                local n = math.random(2)
                                if WAR.PD[dbf][zid] == nil then
                                    WAR.PD[dbf][zid] = n
                                else
                                    WAR.PD[dbf][zid] = (WAR.PD[dbf][zid] or 0) + n
                                end
                                WAR.TXXS[zid] = 1
                            end
                        end
                    end
                end
            end
            -- 行动时显示血条
            WAR.ShowHP = 1
            WAR.PD['降龙・飞龙在天'][pid] = nil
            WAR.PD['黯然・倒行逆施'][pid] = nil

            -- 无酒不欢：行动时，获取指令
            if WAR.PD["昏迷状态"][pid] ~= nil then -- 昏迷状态
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 94, 1, "昏迷中", C_ORANGE)
            elseif WAR.PD["生死符"][pid] ~= nil then
                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                CurIDTXDH(WAR.CurID, 78, 1, "生死符.折服", C_ORANGE);
                local rn = math.random(5)
                if rn == 1 then
                    War_Wait() -- 等待
                elseif rn == 2 then
                    War_Focus() -- 集中 
                elseif rn == 3 then
                    War_DefupMenu() -- 防御 
                elseif rn == 4 then
                    War_ActupMenu() -- 蓄力
                elseif rn == 5 then
                    War_RestMenu() -- 休息
                end
                WAR.PD["生死符"][pid] = nil
            elseif WAR.ZDDH == 354 then
                r = War_Auto()
            elseif isteam(pid) and WAR.Person[p]["我方"] then
                -- 混乱状态50%概率自动
                if WAR.PD["混乱状态"][pid] ~= nil and math.random(100) <= 50 then
                    r = War_Auto()
                elseif WAR.AutoFight == 0 then
                    r = War_Manual()
                else
                    r = War_Auto()
                end
            else
                r = War_Auto()
            end

            if JY.Restart == 1 then
                return false
            end
            -- 如果发动左右互搏
            if WAR.ZYHB == 1 then
                WAR.ATK['人物'] = p
                WAR.Person[p].Time = 1000
                if WAR.ZHB == 0 then -- 周伯通的额外左右这里不再重复记录
                    WAR.ZYYD = WAR.Person[p]["移动步数"]
                end

                -- 阎基偷钱
                if WAR.YJ > 0 then
                    instruct_2(174, WAR.YJ)
                    WAR.YJ = 0
                end
            else
                if WAR.ZYHB == 2 then
                    WAR.ZYHB = 0
                end
                ---------------行动后特效统一写这里----------------------
                -- 至阳之体 奇穴61
                if JY.Person[pid]['奇穴' .. 61] == 1 and Curr_NG(pid, 106) then
                    local jy = math.modf(JY.Person[pid]['防御力'] / 2)
                    if WAR.PD['护盾值'][pid] == nil then
                        WAR.PD['护盾值'][pid] = 0
                    end
                    WAR.PD['护盾值'][pid] = WAR.PD['护盾值'][pid] + jy
                    lib.Debug(JY.Person[pid]['姓名'] ..'至阳之体奇穴61'..'增加护盾值2' .. jy) 
                    Cat('护盾停止', WAR.CurID)
                    WAR.Person[p]['护盾'] = 6
                end    
                WAR.Person[p].Time = WAR.Person[p].Time - 1000
                if WAR.Person[p].Time < -100 then
                    WAR.Person[p].Time = -100
                end
                -- 步惊云 剑23	
                if WAR.SL23 == 1 and match_ID(pid, 9738) then
                    WAR.SL23 = 0
                end
                -- 张三
                if (match_ID(pid, 41) or match_ID(pid, 9825)) and JY.Person[0]["品德"] >= 60 then
                    WAR.ZSSS = 1
                    CleanWarMap(4, 0)
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 155, 1, "赏善罚恶")
                    local x1 = WAR.Person[WAR.CurID]["坐标X"]
                    local y1 = WAR.Person[WAR.CurID]["坐标Y"]
                    War_ExecuteMenu_Sub(x1, y1, 3, -1)
                end
                -- 李四
                if (match_ID(pid, 42) or match_ID(pid, 9824)) and JY.Person[0]["品德"] <= 60 then
                    WAR.LSFE = 1
                    CleanWarMap(4, 0)
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 155, 1, "赏善罚恶")
                    local x1 = WAR.Person[WAR.CurID]["坐标X"]
                    local y1 = WAR.Person[WAR.CurID]["坐标Y"]
                    War_ExecuteMenu_Sub(x1, y1, 1, -1)
                end
                -- 天域幻音
                if ZDGH(WAR.CurID, 9998) then
                    Cat('清除基础异常', WAR.CurID)
                    local heal_amount1;
                    local heal_amount;
                    heal_amount1 = (JY.Person[id]["生命最大值"] - JY.Person[id]["生命"])
                    heal_amount = limitX(math.modf(heal_amount1 * 0.05), 100, 200)
                    if heal_amount < 100 then
                        heal_amount = 100
                    end
                    if JY.Base["天书数量"] > 6 or not isteam(id) then
                        heal_amount = math.modf(heal_amount1 * 0.1)
                    end
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
                    Cls();
                    War_Show_Count(WAR.CurID, "");
                end
                -- 汤沛 甘霖惠七省 标记修改
                if ZDGH(WAR.CurID, 9923) then
                    local sm = math.modf(JY.Person[id]['生命最大值'] * 0.05)
                    if sm > 200 then
                        sm = 200
                    end
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", sm);
                    Cls();
                    War_Show_Count(WAR.CurID, "甘霖惠七省");
                end
                -- 萧远山调息
                if match_ID(id, 112) and WAR.ZHRM[id] ~= nil then
                    WarDrawMap(0)
                    CurIDTXDH(WAR.CurID, 124, 1, "走火入魔", C_GOLD);
                    WAR.PD["走火入魔"][id] = WAR.ZHRM[id]
                    WAR.ZHRM[id] = WAR.ZHRM[id] + 1
                end
                if match_ID(id, 9933) then
                    if WAR.PD["逆水寒"][id] ~= nil and WAR.PD["逆水寒"][id] > 0 and JY.Person[id]["生命"] > 0 then
                        WAR.PD["逆水寒"][id] = nil
                        local sm = math.modf(JY.Person[id]["生命最大值"] / 10)
                        WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", sm);
                        Cls();
                        War_Show_Count(WAR.CurID, "");
                        Cat('护盾停止', WAR.CurID)
                        WAR.Person[WAR.CurID]['护盾'] = 12
                    end
                end
                -- 匪石之心
                if match_ID(id, 738) then
                    local menu = {}
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]['我方'] == WAR.Person[WAR.CurID]['我方'] and WAR.Person[j]['死亡'] ==
                            true then
                            menu[#menu + 1] = j
                            say(JY.Person[WAR.Person[j]['人物编号']]['姓名'], 1, 1)
                        end
                    end
                    if menu[1] ~= nil then
                        local nn = math.random(#menu)
                        local mm = menu[nn]
                        local wid = WAR.Person[mm]['人物编号']
                        -- say(JY.Person[wid]['姓名'],1,1) 
                        WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                        CurIDTXDH(WAR.CurID, 200, 1, "日居月诸.胡迭而微", C_ORANGE);
                        JY.Person[wid]['生命'] = JY.Person[wid]['生命最大值']
                        JY.Person[wid]['内力'] = JY.Person[wid]['内力最大值']
                        JY.Person[wid]['体力'] = 100
                        JY.Person[id]['生命'] = 0
                        NewWARPersonZJ(wid, true, WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'],
                            false, 2)
                    end
                end
                -- 内轻特效100
                if NeiGong_tx(pid, 100) then
                    local sm = dkfcj_ng * 100
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", sm)
                end
                -- 内轻特效101
                if NeiGong_tx(pid, 101) then
                    local sm = dkfcj_ng * 100
                    WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", sm)
                end
                -- 内轻特效102
                if NeiGong_tx(pid, 102) then
                    local sm = dkfcj_ng
                    AddPersonAttrib(id, "体力", sm)
                end
                -- 内轻特效103
                if NeiGong_tx(pid, 103) then
                    local sm = dkfcj_ng
                    AddPersonAttrib(id, "能量", sm)
                end
                -- 内轻特效104
                if NeiGong_tx(pid, 104) then
                    local sm = math.modf(JY.Person[id]["生命最大值"] * dkfcj_ng / 100)
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", sm)
                end
                -- 内轻特效105
                if NeiGong_tx(pid, 105) then
                    local sm = math.modf(JY.Person[id]["内力最大值"] * dkfcj_ng / 100)
                    WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", sm)
                end
                -- 内轻特效109
                if NeiGong_tx(pid, 109) then
                    local heal_amount = JY.Person[id]["生命最大值"] - JY.Person[id]["生命"]
                    heal_amount = math.modf(heal_amount * dkfcj_ng * 5 / 100)
                    WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", heal_amount);
                end
                -- 内轻特效201
                if NeiGong_tx(pid, 201) then
                    WAR.LQZ[pid] = WAR.LQZ[pid] or 0 + (dkfcj_ng * 2)
                    if WAR.LQZ[pid] > 100 then 
                        WAR.LQZ[pid] = 100
                    end
                end
                -- 内轻特效202
                if NeiGong_tx(pid, 202) then
                    local zd = dkfcj_ng * 5
                    WAR.Person[WAR.CurID]["中毒点数"] = AddPersonAttrib(WAR.Person[WAR.CurID]["人物编号"],  "中毒程度", -zd)
                end
                -- 内轻特效203
                if NeiGong_tx(pid, 203) then
                    local zd = dkfcj_ng * 5
                    AddPersonAttrib(id, '灼烧程度', -zd)
                end
                -- 内轻特效204
                if NeiGong_tx(pid, 204) then
                    local zd = dkfcj_ng * 5
                    if WAR.LXZT[pid] ~= nil then
                        WAR.LXZT[pid] = WAR.LXZT[pid] - zd
                        if WAR.LXZT[pid] < 1 then
                            WAR.LXZT[pid] = nil
                        end
                    end
                end
                -- 内轻特效205
                if NeiGong_tx(pid, 205) then
                    local zd = dkfcj_ng * 5
                    AddPersonAttrib(id, '冰封程度', -zd)
                end
                -- 内轻特效206
                if NeiGong_tx(pid, 206) then
                    local zd = dkfcj_ng * 5
                    if WAR.PD['内伤状态'][pid] ~= nil then
                        WAR.PD['内伤状态'][pid] = (WAR.PD['内伤状态'][pid] or 0) - zd
                        if WAR.PD['内伤状态'][pid] < 1 then
                            WAR.PD['内伤状态'][pid] = 0
                        end
                    end
                end

                -- 内轻特效112
                if NeiGong_tx(pid, 112) then
                    local heal_amount = JY.Person[id]["内力最大值"] - JY.Person[id]["内力"]
                    heal_amount = math.modf(heal_amount * dkfcj_ng * 5 / 100)
                    WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", heal_amount);
                end
                -- 天刀九问 九歌
                if WAR.PD['九歌'][id] ~= nil and WAR.PD['九歌'][id] > 0 then
                    -- lib.Debug('九歌回血1')
                    if WAR.PD["九歌回血"][id] ~= nil and WAR.PD["九歌回血"][id] > 0 then
                        -- lib.Debug('九歌回血2')
                        local sm = WAR.PD["九歌回血"][id]
                        -- local jg = math.modf(WAR.PD['九歌'][pid]*sm)
                        WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", sm);
                        WAR.PD["九歌"][id] = WAR.PD["九歌"][id] - 1
                        if WAR.PD["九歌"][id] < 1 then
                            WAR.PD["九歌"][id] = nil
                        end
                        Cls();
                        War_Show_Count(WAR.CurID, "九歌恢复生命");
                    end
                end
                -- 金镶玉
                if match_ID(id, 456) then
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 145, 1, "赛西施.魅惑", C_ORANGE);
                    for j = 0, WAR.PersonNum - 1 do
                        local eid = WAR.Person[j]["人物编号"]
                        if JLSD(0, 15, eid) then
                            if WAR.Person[j]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false then
                                WAR.PD['魅惑状态'][eid] = 1
                                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                                CurIDTXDH(j, 145, 1, "魅惑", C_ORANGE)
                            end
                        end
                        lib.Delay(20)
                        DrawTimeBar2()
                    end
                end
                -- 珠落玉盘 行动后提升我方全体100集气
                if (match_ID(id, 104) or match_ID(id, 9872)) and JY.Person[id]["生命"] > 0 then
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 22, 1, "珠落玉盘", C_ORANGE);
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ==
                            WAR.Person[WAR.CurID]["我方"] then
                            WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + 100
                        end
                    end
                    lib.Delay(20)
                    DrawTimeBar2()
                end
                --内轻特效1027
                if NeiGong_tx(id,1027) then 
                    local heal_hp = math.modf(JY.Person[id]['生命最大值'] * dkfcj_ng/100*2)
                    local heal_mp = math.modf(JY.Person[id]['生命最大值'] * dkfcj_ng/100*2)
                    local tl = dkfcj_ng
                    AddPersonAttrib(id, "生命", heal_hp)
                    AddPersonAttrib(id, "内力", heal_mp)
                    AddPersonAttrib(id, "体力", tl)
                end
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false then
                        -- 离经易道主运长生诀，大长和诀，枯荣禅功             
                        if Curr_NG(WAR.Person[j]["人物编号"], 203) or Curr_NG(WAR.Person[j]["人物编号"], 253) or  Curr_NG(WAR.Person[j]["人物编号"], 207) then
                            if JY.Person[WAR.Person[j]["人物编号"]]['奇穴' .. 117] == 1 then
                                local heal_amount = math.modf(JY.Person[WAR.Person[j]["人物编号"]]['生命最大值'] * 0.05)
                                WAR.Person[j]["生命点数"] = AddPersonAttrib(WAR.Person[j]["人物编号"], "生命", heal_amount)
                                WAR.Person[j]["内力点数"] = AddPersonAttrib(WAR.Person[j]["人物编号"], "内力", 200)
                                AddPersonAttrib(id, "体力", 1)
                                if WAR.LQZ[id] == nil then
                                    WAR.LQZ[id] = 0
                                end
                                WAR.LQZ[id] = WAR.LQZ[id] + 5
                                if WAR.LQZ[id] > 100 then 
                                    WAR.LQZ[id] = 100
                                end
                                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                                WAR.CurID = j
                                CurIDTXDH(WAR.CurID, 200, 1, "离经易道", C_RED);
                            end
                        end
                        -- 内轻特效304
                        if NeiGong_tx(WAR.Person[j]["人物编号"], 304) then
                            if JLSD(0, dkfcj_ng * 10, WAR.Person[j]["人物编号"]) then
                                lib.Debug('前是' .. WAR.Person[j].TimeAdd)
                                WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + dkfcj_ng * 50
                                lib.Debug('后是' .. WAR.Person[j].TimeAdd)
                                lib.Debug('编号是' .. WAR.Person[j]["人物编号"])
                                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                                WAR.CurID = j
                                CurIDTXDH(WAR.CurID, 167, 1, "后发先至", C_RED);
                                lib.Delay(20)
                                DrawTimeBar2()
                            end
                        end
                    end
                end
                -- 木兰词 葵花
                if Curr_NG(id, 105) and JY.Person[id]['奇穴' .. 125] == 1 then
                    WAR.PD['光君'][id] = 1
                end
                if JY.Person[id]['门派'] == 29 then
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~=
                            WAR.Person[WAR.CurID]["我方"] then
                            local mid = WAR.Person[j]['人物编号']
                            if WAR.PD['密宗印记'][mid] ~= nil then
                                WAR.PD['密宗印记'][mid] = WAR.PD['密宗印记'][mid] - 1
                                if WAR.PD['密宗印记'][mid] < 1 then
                                    WAR.PD['密宗印记'][mid] = nil
                                end
                                if WAR.PD['密宗印记'][mid] ~= nil then
                                    lib.Debug(JY.Person[mid]['姓名'] .. WAR.PD['密宗印记'][mid])
                                end
                            end
                        end
                    end
                end
                -- 星宿特性
                if JY.Person[id]['门派'] == 28 and JLSD(0, 50, id) then
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 22, 1, "腐尸毒", C_ORANGE);
                    local zd = math.random(40, 80)
                    local x1 = WAR.Person[WAR.CurID]["坐标X"]
                    local y1 = WAR.Person[WAR.CurID]["坐标Y"]
                    for ex = x1 - 6, x1 + 6 do
                        for ey = y1 - 6, y1 + 6 do
                            SetWarMap(ex, ey, 4, 1)
                            if GetWarMap(ex, ey, 2) ~= nil and GetWarMap(ex, ey, 2) > -1 then
                                local ep = GetWarMap(ex, ey, 2)
                                if (WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[ep]["我方"]) then
                                    WAR.Person[ep]["Life_Before_Hit"] =
                                        JY.Person[WAR.Person[ep]["人物编号"]]["生命"]
                                    if myzd(ep) == false then
                                        WAR.Person[ep]["中毒点数"] = (WAR.Person[ep]["中毒点数"] or 0) +   AddPersonAttrib(WAR.Person[ep]["人物编号"], "中毒程度", zd)
                                    end
                                    SetWarMap(ex, ey, 5, 6)
                                    WAR.Effect = 5
                                    WAR.TXXS[WAR.Person[ep]["人物编号"]] = 1
                                end
                            end
                        end
                    end
                    Cat('数值显示')
                end
                -- 七星聚会
                if match_ID(id, 9753) then
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 126, 1, "七星聚会", C_ORANGE);
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == true and
                            WAR.Person[j]["人物编号"] == 9753 then
                            WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd + 200
                        end
                    end
                    lib.Delay(20)
                    DrawTimeBar2()
                end
                -- 枯荣禅功每回合概率以内力换生命
                --内轻特效1016
                if NeiGong_tx(id,1016) and JY.Person[id]["生命"] > 0 and JY.Person[id]["内力"] > 0 and  JY.Person[id]["生命"] < JY.Person[id]["生命最大值"]  then 
                    local knl = math.modf(JY.Person[id]["内力"]/JY.Person[id]["内力最大值"]*100) 
                    local knl1 = math.modf(JY.Person[id]["内力最大值"]*dkfcj_ng*3/100) 
                    local rsm = math.modf(JY.Person[id]["生命最大值"]*dkfcj_ng*3/100) 
                    if knl > 8 then 
                        CurIDTXDH(WAR.CurID, 77, 1, "亦枯亦荣", C_ORANGE);
                        WAR.Person[WAR.CurID]["生命点数"] = AddPersonAttrib(id, "生命", rsm);
                        Cls();
                        WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", -knl1);
                        Cls();
                        War_Show_Count(WAR.CurID, "");
                    end
                end
                

                -- 紫霞神功行动后，回复内力
                --内轻特效1043
                if NeiGong_tx(pid,1043) then     
                    local HN;
                    HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[pid]["内力"]) * dkfcj_ng/10)
                    WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
                    Cls();
                    War_Show_Count(WAR.CurID, "回复内力");
                end

                -- 老汉推车 行动后，回复内力 标记修改
                if match_ID(id, 9926) then
                    local MP1
                    local MP2
                    MP1 = math.modf(JY.Person[id]["内力最大值"] / 2)
                    MP2 = math.modf(JY.Person[id]["内力"])
                    if MP1 > MP2 then
                        local HN;
                        HN = math.modf((JY.Person[id]["内力最大值"] - JY.Person[id]["内力"]) * 0.25)
                        WAR.Person[WAR.CurID]["内力点数"] = AddPersonAttrib(id, "内力", HN);
                        WAR.Person[WAR.CurID]["体力点数"] = AddPersonAttrib(id, "体力", -5)
                        Cls();
                        War_Show_Count(WAR.CurID, "老汉推车补魔");
                    end
                end

                -- 梅长苏行动后冰封值+10 灼烧值+5
                if match_ID(id, 9969) then
                    local bfz = 0
                    local zsz = 0
                    bfz = bfz + 10
                    zsz = zsz + 5
                    AddPersonAttrib(id, '灼烧程度', zsz)
                    AddPersonAttrib(id, '灼烧程度', bfz)
                    WAR.ZSXS[id] = 1
                    WAR.BFXS[id] = 1
                end


                -- 鳄皮护甲 每回合解毒
                if JY.Person[id]["防具"] == 61 and JY.Person[id]["中毒程度"] > 0 then
                    local JD = 25 + 10 * (JY.Thing[61]["装备等级"] - 1)
                    if JY.Person[id]["中毒程度"] < JD then
                        JD = JY.Person[id]["中毒程度"]
                    end
                    WAR.Person[WAR.CurID]["解毒点数"] = -AddPersonAttrib(id, "中毒程度", -JD)
                    Cls();
                    War_Show_Count(WAR.CurID, "鳄皮护甲生化解毒");
                end

                -- 连环迷踪腿
                if match_ID(id, 9836) and JY.Person[id]["生命"] > 0 and JLSD(0, 50, id) then
                    CurIDTXDH(WAR.CurID, 172, 1, "连环迷踪腿", C_GOLD);
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] ==
                            false then
                            local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                            local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                            if offset1 <= 3 and offset2 <= 3 then
                                WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]
                                JY.Person[WAR.Person[i]["人物编号"]]["生命"] =
                                    JY.Person[WAR.Person[i]["人物编号"]]["生命"] - 100
                                WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - 100
                                -- 沉睡状态的敌人会醒来
                                if WAR.PD["沉睡状态"][WAR.Person[i]["人物编号"]] ~= nil then
                                    WAR.PD["沉睡状态"][WAR.Person[i]["人物编号"]] = nil
                                end
                                WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                            end
                        end
                    end
                    Cls();
                    Cat('数值显示')
                end

                -- 碧针清掌
                if (match_ID(id, 164) or match_ID(id, 9822)) and JY.Person[id]["生命"] > 0 then
                    CurIDTXDH(WAR.CurID, 153, 1, "碧针清掌", C_GOLD);
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[i]["死亡"] ==
                            false then
                            local offset1 = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"])
                            local offset2 = math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
                            if offset1 <= 7 and offset2 <= 7 then
                                WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]
                                JY.Person[WAR.Person[i]["人物编号"]]["生命"] =
                                    JY.Person[WAR.Person[i]["人物编号"]]["生命"] - 100
                                WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) - 100
                                -- 沉睡状态的敌人会醒来
                                if WAR.PD["沉睡状态"][WAR.Person[i]["人物编号"]] ~= nil then
                                    WAR.PD["沉睡状态"][WAR.Person[i]["人物编号"]] = nil
                                end
                                WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                            end
                        end
                    end
                    Cls();
                    Cat('数值显示')
                end

                -- 丁春秋
                if (match_ID(id, 46) or match_ID(id, 9901)) and JY.Person[id]["生命"] > 0 then
                    CurIDTXDH(WAR.CurID, 64, 1, "三笑销魂散", C_ORANGE);
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["死亡"] == false and JY.Person[WAR.Person[j]["人物编号"]]["生命"] > 0 and
                            WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                            if JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"] > 0 then
                                WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                                JY.Person[WAR.Person[j]["人物编号"]]["生命"] =
                                    JY.Person[WAR.Person[j]["人物编号"]]["生命"] -
                                        JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"]
                                WAR.Person[j]["生命点数"] =
                                    (WAR.Person[j]["生命点数"] or 0) -
                                        (JY.Person[WAR.Person[j]["人物编号"]]["中毒程度"] or 0)
                                if JY.Person[WAR.Person[j]["人物编号"]]["生命"] < 1 then
                                    JY.Person[WAR.Person[j]["人物编号"]]["生命"] = 1
                                end
                                -- 沉睡状态的敌人会醒来
                                if WAR.PD["沉睡状态"][WAR.Person[j]["人物编号"]] ~= nil then
                                    WAR.PD["沉睡状态"][WAR.Person[j]["人物编号"]] = nil
                                end
                                WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                            end
                        end
                    end
                    Cls();
                    Cat('数值显示')
                end
                -- 摩天居士玄铁令三
                if WAR.PD['玄铁令'][id] == 3 then
                    Cat('立刻出手', WAR.CurID)
                end

                -- 空性使用龙爪手攻击后自动进入等待状态
                if match_ID(id, 170) and WAR.SLGFH == 1 then
                    War_Wait()
                    WAR.SLGFH = 0
                end

                if WAR.PD["风身"][id] ~= nil then
                    WAR.PD["风身"][id] = nil
                end
                if WAR.PD["轻体"][id] ~= nil then
                    WAR.PD["轻体"][id] = nil
                end
                -- 无酒不欢：等待
                if WAR.Wait[id] == 1 then
                    WAR.Wait[id] = 0
                    WAR.Person[p].Time = WAR.Person[p].Time + 400
                end

                -- 蛤蟆蓄力
                if WAR.HMGXL[id] == 1 then
                    WAR.HMGXL[id] = 0
                    WAR.Person[p].Time = WAR.Person[p].Time + 300
                end

                -- 林平之根据伤害
                if match_ID(id, 9887) and WAR.LPZ > 0 then
                    WAR.Person[p].Time = WAR.Person[p].Time + WAR.LPZ
                    WAR.LPZ = 0
                end

                -- 神足经 标记修改
                if Curr_NG(id, 233) and JY.Person[id]["坐骑"] == -1 then
                    local HQ = math.modf(TrueTS(id) / 2)
                    WAR.Person[p].Time = WAR.Person[p].Time + HQ
                end
                -- 虚竹福泽加护
                if (match_ID(id, 49) or match_ID(id, 9883)) and WAR.XZZ == 1 then
                    WAR.XZZ = 0
                    WAR.Person[p].Time = WAR.Person[p].Time + 200
                end
                -- 其疾如风
                if match_ID(id, 9970) then
                    WAR.Person[p].Time = WAR.Person[p].Time + 100
                end
                -- 通微显化、万法自然 
                if (match_ID(id, 9820) and WAR.ZSF == 1) then
                    WAR.Person[p].Time = WAR.Person[p].Time + 500
                    WAR.ZSF = 0
                end

                -- if WAR.PD['西瓜刀'][pid] == 1 then
                if WAR.PD['回气'][id] ~= nil then
                    WAR.Person[p].Time = WAR.Person[p].Time + WAR.PD['回气'][id]
                    WAR.PD['回气'][id] = nil
                end

                -- 李白诗酒化行 
                if match_ID(id, 9730) and WAR.QLBLX == 1 then
                    WAR.Person[p].Time = WAR.Person[p].Time + 200
                    WAR.QLBLX = 0
                end

                -- 封不平狂风快剑
                if (match_ID(id, 142) or match_ID(id, 9839)) and WAR.KFKJ == 1 then
                    WAR.Person[p].Time = WAR.Person[p].Time + 150
                    WAR.KFKJ = 0
                end

                -- 九剑真传，荡剑式200
                if WAR.JJDJ == 1 and id == 0 then
                    WAR.JJDJ = 0
                    WAR.Person[p].Time = WAR.Person[p].Time + 200
                end

                -- 闪电惊鸿
                if match_ID(id, 9996) then
                    WAR.Person[p].Time = WAR.Person[p].Time + 200
                end
                -- 运轻功
                if WAR.YQG == 1 then
                    WAR.Person[p].Time = WAR.Person[p].Time + 500
                    WAR.YQG = 0
                end

                -- 朱九真，随机得到食材
                if match_ID(id, 81) and WAR.ZJZ == 0 and JLSD(0, 40, id) then
                    instruct_2(210, 10)
                    WAR.ZJZ = 1
                end

                -- 九剑破招减少集气
                if WAR.JJPZ[id] ~= nil then
                    WAR.Person[p].Time = WAR.Person[p].Time - 200 * WAR.JJPZ[id]
                end

                -- 太空卸劲减少集气
                if WAR.TKJQ[id] ~= nil then
                    WAR.Person[p].Time = WAR.Person[p].Time - 100 * WAR.TKJQ[id]
                    WAR.TKJQ[id] = nil
                end

                -- 杨过，行动后集气初始位置额外增加
                -- 生命少过二分之一时每少100增加行动后集气位置加100
                if match_ID(id, 58) and JY.Person[id]["生命"] < JY.Person[id]["生命最大值"] / 2 then
                    WAR.Person[p].Time = WAR.Person[p].Time + math.floor(JY.Person[id]["生命最大值"] / 2 - JY.Person[id]["生命"]);
                end

                if WAR.PD['疾如风'][id] ~= nil and WAR.PD['疾如风'][id] > 0 then
                    local rf = WAR.PD['疾如风'][id]
                    WAR.Person[p].Time = WAR.Person[p].Time + rf * 300
                    lib.Debug(JY.Person[WAR.Person[p]['人物编号']]['姓名'] .. ' 如风')
                    if WAR.Person[p].Time > 980 then
                        WAR.Person[p].Time = 980
                    end
                    WAR.PD['疾如风'][id] = nil
                end

                -- 阎基偷钱
                if WAR.YJ > 0 then
                    instruct_2(174, WAR.YJ)
                    WAR.YJ = 0
                end

                -- 恐惧
                if WAR.PD["恐惧状态"][id] ~= nil then
                    WAR.PD["恐惧状态"][id] = nil
                end

                -- 王重阳1 同归剑气 30时序
                if WAR.PD["同归状态"][id] ~= nil then
                    WAR.PD["同归状态"][id] = nil
                end

                -- 天罗地网恢复
                if WAR.PD['天罗地网'][id] ~= nil then
                    WAR.PD['天罗地网'][id] = nil
                end

                -- 宋远桥使用太极拳或太极剑攻击后自动进入防御状态
                if WAR.WDRX == 1 then
                    War_DefupMenu()
                    WAR.WDRX = 0
                end
                --内轻特效1030 
                if NeiGong_tx(pid,1030) then 
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    War_DefupMenu()
                end
                if WAR.PD['降龙・潜龙勿用'][id] == 1 then
                    -- War_DefupMenu()
                    -- WAR.PD['降龙・潜龙勿用'][id] = nil
                end

             ---------------------------行动后回合结束清除状态--------------------------
                if WAR.PD['醉意'][id] ~= nil then 
                    WAR.PD['醉意'][id] = WAR.PD['醉意'][id] - 1
                    if WAR.PD['醉意'][id] < 1 then 
                        WAR.PD['醉意'][id] = nil 
                    end
                end
                if WAR.PD['缓步'][id] ~= nil then
                    WAR.PD['缓步'][id] = WAR.PD['缓步'][id] - 1
                    if WAR.PD['缓步'][id] < 1 then
                        WAR.PD['缓步'][id] = nil
                    end
                end
                -- 般若禅掌清除
                if WAR.PD['般若禅掌'][id] ~= nil then
                    WAR.PD['般若禅掌'][id] = nil
                end
                if WAR.PD['西瓜刀・天人'][id] ~= nil then
                    WAR.PD['西瓜刀・天人'][id] = WAR.PD['西瓜刀・天人'][id] - 1
                    if WAR.PD['西瓜刀・天人'][id] < 1 then
                        WAR.PD['西瓜刀・天人'][id] = nil
                    end
                end

                if WAR.Actup[id] ~= nil and WAR.Actup[id] > 0 then
                    WAR.Actup[id] = WAR.Actup[id] - 1 -- 蓄力，行动一次减1                        
                    if WAR.Actup[id] == 0 then
                        WAR.Actup[id] = nil
                    end
                end

                if WAR.PD["十龙十象"][pid] ~= nil then
                    WAR.PD["十龙十象"][pid] = WAR.PD["十龙十象"][pid] - 1
                    if WAR.PD["十龙十象"][pid] == 0 then
                        WAR.PD["十龙十象"][pid] = nil
                    end
                end
                -- 度化状态，解除后，敌人状态恢复
                if WAR.PD["度化状态"][id] ~= nil then
                    WAR.PD["度化状态"][id] = WAR.PD["度化状态"][id] - 1
                    if WAR.PD["度化状态"][id] < 1 then
                        WAR.PD["度化状态"][id] = nil
                        if not inteam(id) then
                            WAR.Person[p]["我方"] = false
                        end
                    end
                end

                if WAR.PD["魅惑状态"][id] ~= nil then
                    WAR.PD["魅惑状态"][id] = WAR.PD["魅惑状态"][id] - 1
                    if WAR.PD["魅惑状态"][id] < 1 then
                        WAR.PD["魅惑状态"][id] = nil
                        if not inteam(id) then
                            WAR.Person[p]["我方"] = false
                        end
                    end
                end

                if WAR.PD["参合状态"][id] ~= nil then
                    WAR.PD["参合状态"][id] = WAR.PD["参合状态"][id] - 1
                    if WAR.PD["参合状态"][id] == 0 then
                        WAR.PD["参合状态"][id] = nil
                    end
                end

                if WAR.PD["格挡状态"][id] ~= nil then
                    WAR.PD["格挡状态"][id] = WAR.PD["格挡状态"][id] - 1
                    if WAR.PD["格挡状态"][id] == 0 then
                        WAR.PD["格挡状态"][id] = nil
                    end
                end

                if WAR.PD["外伤状态1"][id] ~= nil then
                    WAR.PD["外伤状态1"][id] = WAR.PD["外伤状态1"][id] - 1
                    if WAR.PD["外伤状态1"][id] == 0 then
                        WAR.PD["外伤状态1"][id] = nil
                    end
                end

                if WAR.PD["外伤状态2"][id] ~= nil then
                    WAR.PD["外伤状态2"][id] = WAR.PD["外伤状态2"][id] - 1
                    if WAR.PD["外伤状态2"][id] == 0 then
                        WAR.PD["外伤状态2"][id] = nil
                    end
                end

                if WAR.PD["外伤状态3"][id] ~= nil then
                    WAR.PD["外伤状态3"][id] = WAR.PD["外伤状态3"][id] - 1
                    if WAR.PD["外伤状态3"][id] == 0 then
                        WAR.PD["外伤状态3"][id] = nil
                    end
                end

                if WAR.PD["外伤状态4"][id] ~= nil then
                    WAR.PD["外伤状态4"][id] = WAR.PD["外伤状态4"][id] - 1
                    if WAR.PD["外伤状态4"][id] == 0 then
                        WAR.PD["外伤状态4"][id] = nil
                    end
                end

                if WAR.PD["招式・集气加速1"][id] ~= nil then
                    WAR.PD["招式・集气加速1"][id] = WAR.PD["招式・集气加速1"][id] - 1
                    if WAR.PD["招式・集气加速1"][id] == 0 then
                        WAR.PD["招式・集气加速1"][id] = nil
                    end
                end

                if WAR.PD["招式・集气加速2"][id] ~= nil then
                    WAR.PD["招式・集气加速2"][id] = WAR.PD["招式・集气加速2"][id] - 1
                    if WAR.PD["招式・集气加速2"][id] == 0 then
                        WAR.PD["招式・集气加速2"][id] = nil
                    end
                end

                if WAR.PD["招式・集气加速3"][id] ~= nil then
                    WAR.PD["招式・集气加速3"][id] = WAR.PD["招式・集气加速3"][id] - 1
                    if WAR.PD["招式・集气加速3"][id] == 0 then
                        WAR.PD["招式・集气加速3"][id] = nil
                    end
                end

                if WAR.PD["招式・集气加速4"][id] ~= nil then
                    WAR.PD["招式・集气加速4"][id] = WAR.PD["招式・集气加速4"][id] - 1
                    if WAR.PD["招式・集气加速4"][id] == 0 then
                        WAR.PD["招式・集气加速4"][id] = nil
                    end
                end

                if WAR.PD["招式减防1"][id] ~= nil then
                    WAR.PD["招式减防1"][id] = WAR.PD["招式减防1"][id] - 1
                    if WAR.PD["招式减防1"][id] == 0 then
                        WAR.PD["招式减防1"][id] = nil
                    end
                end

                if WAR.PD["招式减防2"][id] ~= nil then
                    WAR.PD["招式减防2"][id] = WAR.PD["招式减防2"][id] - 1
                    if WAR.PD["招式减防2"][id] == 0 then
                        WAR.PD["招式减防2"][id] = nil
                    end
                end

                if WAR.PD["招式减防3"][id] ~= nil then
                    WAR.PD["招式减防3"][id] = WAR.PD["招式减防3"][id] - 1
                    if WAR.PD["招式减防3"][id] == 0 then
                        WAR.PD["招式减防3"][id] = nil
                    end
                end

                if WAR.PD["招式减防4"][id] ~= nil then
                    WAR.PD["招式减防4"][id] = WAR.PD["招式减防4"][id] - 1
                    if WAR.PD["招式减防4"][id] == 0 then
                        WAR.PD["招式减防4"][id] = nil
                    end
                end

                if WAR.PD["招式减攻1"][id] ~= nil then
                    WAR.PD["招式减攻1"][id] = WAR.PD["招式减攻1"][id] - 1
                    if WAR.PD["招式减攻1"][id] == 0 then
                        WAR.PD["招式减攻1"][id] = nil
                    end
                end

                if WAR.PD["招式减攻2"][id] ~= nil then
                    WAR.PD["招式减攻2"][id] = WAR.PD["招式减攻2"][id] - 1
                    if WAR.PD["招式减攻2"][id] == 0 then
                        WAR.PD["招式减攻2"][id] = nil
                    end
                end

                if WAR.PD["招式减攻3"][id] ~= nil then
                    WAR.PD["招式减攻3"][id] = WAR.PD["招式减攻3"][id] - 1
                    if WAR.PD["招式减攻3"][id] == 0 then
                        WAR.PD["招式减攻3"][id] = nil
                    end
                end
                -- 招式再动概率
                if WAR.PD['招式・再动概率'][id] ~= nil then
                    WAR.PD['招式・再动概率'][id] = nil
                end
                if WAR.PD["招式减攻4"][id] ~= nil then
                    WAR.PD["招式减攻4"][id] = WAR.PD["招式减攻4"][id] - 1
                    if WAR.PD["招式减攻4"][id] == 0 then
                        WAR.PD["招式减攻4"][id] = nil
                    end
                end
                -- 集中状态
                if WAR.PD["集中状态"][id] ~= nil then
                    WAR.PD["集中状态"][id] = WAR.PD["集中状态"][id] - 1
                    if WAR.PD["集中状态"][id] == 0 then
                        WAR.PD["集中状态"][id] = nil
                    end
                end

                -- 混乱状态，解除后，敌人状态恢复
                if WAR.PD["混乱状态"][id] ~= nil then
                    WAR.PD["混乱状态"][id] = WAR.PD["混乱状态"][id] - 1
                    if WAR.PD["混乱状态"][id] < 1 then
                        WAR.PD["混乱状态"][id] = nil
                    end
                end

                -- 锁足状态
                if WAR.PD["锁足状态"][id] ~= nil then
                    WAR.PD["锁足状态"][id] = nil
                end

                if WAR.PD["洞火"][id] ~= nil then
                    WAR.PD["洞火"][id] = nil
                end
                -- 盲目状态恢复

                if WAR.PD["盲目状态"][pid] ~= nil then
                    WAR.PD["盲目状态"][pid] = WAR.PD["盲目状态"][pid] - 1
                    if WAR.PD["盲目状态"][pid] == 0 then
                        WAR.PD["盲目状态"][pid] = nil
                    end
                    for k = 0, 10 do
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        DrawStrBox(-1, -1, "盲目状态恢复", C_ORANGE, CC.DefaultFont)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                end
                -- 昏迷
                if WAR.PD["昏迷状态"][pid] ~= nil then
                    WAR.PD["昏迷状态"][pid] = WAR.PD["昏迷状态"][pid] - 1
                    if WAR.PD["昏迷状态"][pid] == 0 then
                        WAR.PD["昏迷状态"][pid] = nil
                    end
                end
                -- 菩提树
                if WAR.PD["菩提树"][pid] ~= nil then
                    WAR.PD["菩提树"][pid] = WAR.PD["菩提树"][pid] - 1
                    if WAR.PD["菩提树"][pid] == 0 then
                        WAR.PD["菩提树"][pid] = nil
                    end
                end
                -- 刺目
                if WAR.PD["刺目"][pid] ~= nil then
                    WAR.PD["刺目"][pid] = nil
                end

                -- 迟缓
                if WAR.PD["迟缓状态"][pid] ~= nil then
                    WAR.PD["迟缓状态"][pid] = WAR.PD["迟缓状态"][pid] - 1
                    if WAR.PD["迟缓状态"][pid] == 0 then
                        WAR.PD["迟缓状态"][pid] = nil
                    end
                end
                -- 冰冻
                if WAR.PD["冰冻状态"][pid] ~= nil then
                    WAR.PD["冰冻状态"][pid] = WAR.PD["冰冻状态"][pid] - 1
                    if WAR.PD["冰冻状态"][pid] == 0 then
                        WAR.PD["冰冻状态"][pid] = nil
                    end
                end
                -- 破甲状态
                if WAR.PD["破甲状态"][pid] ~= nil then
                    WAR.PD["破甲状态"][pid] = WAR.PD["破甲状态"][pid] - 1
                    if WAR.PD["破甲状态"][pid] == 0 then
                        WAR.PD["破甲状态"][pid] = nil
                    end
                end
                -- 卸甲状态
                if WAR.PD['卸甲状态'][pid] ~= nil then
                    WAR.PD["卸甲状态"][pid] = WAR.PD["卸甲状态"][pid] - 1
                    if WAR.PD["卸甲状态"][pid] == 0 then
                        WAR.PD["卸甲状态"][pid] = nil
                    end
                end
                if WAR.PD['斗转武功气攻'][pid] ~= nil then
                    WAR.PD['斗转武功气攻'][pid] = nil
                end
                -- 剧毒
                if WAR.PD["剧毒"][pid] ~= nil then
                    WAR.PD["剧毒"][pid] = WAR.PD["剧毒"][pid] - 1
                    if WAR.PD["剧毒"][pid] == 0 then
                        WAR.PD["剧毒"][pid] = nil
                    end
                end
                -- 封
                if WAR.PD["封"][pid] ~= nil then
                    WAR.PD["封"][pid] = WAR.PD["封"][pid] - 1
                    if WAR.PD["封"][pid] == 0 then
                        WAR.PD["封"][pid] = nil
                    end
                end
                -- 逆水寒倒计时
                if WAR.PD["逆水寒CD"][pid] ~= nil then
                    WAR.PD["逆水寒CD"][pid] = WAR.PD["逆水寒CD"][pid] - 1
                    if WAR.PD["逆水寒CD"][pid] < 1 then
                        WAR.PD["逆水寒CD"][pid] = nil
                    end
                end

                -- 放下屠刀
                if WAR.PD["放下屠刀"][pid] ~= nil then
                    WAR.PD["放下屠刀"][pid] = WAR.PD["放下屠刀"][pid] - 1
                    if WAR.PD["放下屠刀"][pid] == 0 then
                        WAR.PD["放下屠刀"][pid] = nil
                    end
                end
                -- 金刚狮子吼
                if WAR.PD["金刚咒"][pid] ~= nil then
                    WAR.PD["金刚咒"][pid] = WAR.PD["金刚咒"][pid] - 1
                    if WAR.PD["金刚咒"][pid] == 0 then
                        WAR.PD["金刚咒"][pid] = nil
                    end
                end
                -- 霸体时序
                if WAR.PD["霸体"][pid] ~= nil then
                    WAR.PD["霸体"][pid] = WAR.PD["霸体"][pid] - 1
                    if WAR.PD["霸体"][pid] < 1 then
                        WAR.PD["霸体"][pid] = nil
                    end
                end
                -- 招式必中恢复
                if WAR.PD['招式必中'][pid] ~= nil then
                    WAR.PD['招式必中'][pid] = nil
                    -- lib.Debug('招式必中清除')
                end
                if WAR.HQT_CD > 0 then
                    WAR.HQT_CD = WAR.HQT_CD - 1
                end

                -- 行动后漏出破绽
                WAR.Weakspot[id] = 0
                -- 行动后减CD
                -- 双剑合壁无破绽
                if ShuangJianHB(id) then
                    WAR.Weakspot[id] = nil
                end
                -- 十三太保
                if match_ID(id, 9807) then
                    WAR.Weakspot[id] = nil
                end
                -- 辟邪冷却时间恢复
                if WAR.BXLQ[id] then
                    local KH = 0
                    for i = 1, 6 do
                        WAR.BXLQ[id][i] = WAR.BXLQ[id][i] - 1
                        if WAR.BXLQ[id][i] < 0 then
                            WAR.BXLQ[id][i] = 0
                        end
                    end
                end
                if WAR.PD["杀破狼"][id] ~= nil then
                    WAR.PD["杀破狼"][id] = WAR.PD["杀破狼"][id] - 1
                    if WAR.PD["杀破狼"][id] == 0 then
                        WAR.PD["杀破狼"][id] = nil
                    end
                end
                -- 六脉冷却时间恢复
                if WAR.LMLQ[id] then
                    local KH = 0
                    for i = 1, 6 do
                        WAR.LMLQ[id][i] = WAR.LMLQ[id][i] - 1
                        if WAR.LMLQ[id][i] < 0 then
                            WAR.LMLQ[id][i] = 0
                        end
                    end
                end
                -- 九阳冷却时间恢复
                if WAR.JYLQ[id] then
                    for i = 1, 3 do
                        WAR.JYLQ[id][i] = WAR.JYLQ[id][i] - 1
                        if WAR.JYLQ[id][i] < 0 then
                            WAR.JYLQ[id][i] = 0
                        end
                    end
                end
                -- 天剑CD
                if WAR.PD["天剑"][id] ~= nil then
                    WAR.PD["天剑"][id] = WAR.PD["天剑"][id] - 1
                    if WAR.PD["天剑"][id] == 0 then
                        WAR.PD["天剑"][id] = nil
                    end
                end
                -- 顽童武痴，每行动一次，攻击时伤害一+5%
                if match_ID(id, 64) then
                    WAR.ZBT = WAR.ZBT + 1
                    if WAR.ZBT > 30 then
                        WAR.ZBT = 30
                    end
                end
                --内轻特效1032 
                if NeiGong_tx(id,1032) then 
                    WAR.PD['六道轮回'][id] = (WAR.PD['六道轮回'][id] or 0) + 1
                    if WAR.PD['六道轮回'][id] > 6 then 
                        WarDrawMap(0)
                        CurIDTXDH(WAR.CurID, 104, 1, "六道轮回", PinkRed)
                        Cat('清除所有异常', WAR.CurID)
                        JY.Person[id]["生命"] = JY.Person[id]["生命最大值"]
                        JY.Person[id]["内力"] = JY.Person[id]["内力最大值"]
                        JY.Person[id]["体力"] = 100
                        WAR.PD['六道轮回'][id] = 1
                    end
                end
                --内轻特效1017
                if NeiGong_tx(id,1017) then 
                    WAR.PD['天行健.攻'][id] = (WAR.PD['天行健.攻'][id] or 0) + 1
                    if WAR.PD['天行健.攻'][id] > 12 then 
                        WAR.PD['天行健.攻'][id] = 10 
                    end
                end
                -- 浑天气功行动前加防
                --内轻特效1018
                if NeiGong_tx(id,1018) then
                    WAR.PD['天行健.守'][id] = WAR.PD['天行健.守'][id] or 0 + 1
                    if WAR.PD['天行健.守'][id] > 12 then
                        WAR.PD['天行健.守'][id] = 10
                        -- lib.Debug('浑天3')
                    end
                end
                -- 剑气护体
                if match_ID(id, 9810) then
                    WAR.PD['剑气护体'][id] = WAR.PD['剑气护体'][id] or 0 + 1
                    if WAR.PD['剑气护体'][id] > 6 then
                        WAR.PD['剑气护体'][id] = 6
                    end
                end
                -- 十里坡剑神 激昂状态
                if match_ID(id, 9810) then
                    WAR.PD['激昂'][id] = WAR.PD['激昂'][id] or 0 + 1
                    if WAR.PD['激昂'][id] > 6 then
                        WAR.PD['激昂'][id] = 6
                    end
                end

                -- 武当七侠真武七截阵，每行动一次，攻击时伤害一+10%
                if id == 532 or id == 533 or id == 534 or id == 535 or id == 536 or id == 537 or id == 538 then
                    -- WAR.ZWQJZ = WAR.ZWQJZ + 1
                end

                -- 花铁杆，每行动一次，集气速度加一
                if id == 0 and JY.Base["畅想"] == 52 then
                    WAR.HTG = WAR.HTG + 1
                    if WAR.HTG > 81 then
                        WAR.HTG = 81
                    end
                end

                if match_ID(id, 9984) then
                    if WAR.PD["诸法无我"][id] == nil then
                        WAR.PD["诸法无我"][id] = 1
                    else
                        WAR.PD["诸法无我"][id] = WAR.PD["诸法无我"][id] + 1
                    end
                    if WAR.PD["诸法无我"][id] > 6 then
                        WAR.PD["诸法无我"][id] = 6
                    end
                end

                -- 王重阳北斗七闪状态减少
                if match_ID(id, 9786) and WAR.BDQS > 0 then
                    WAR.BDQS = WAR.BDQS - 1
                    if WAR.BDQS == 0 then
                        CurIDTXDH(WAR.CurID, 126, 1, "北斗七闪・收招", C_GOLD);
                    end
                end

                -- 暴怒恢复
                if WAR.LQZ[id] == 100 then
                    -- 王重阳北斗七闪状态行动后暴怒不减
                    local lx = false
                    if match_ID(id, 9786) and WAR.BDQS > 0 then
                        lx = true
                    end
                    if WAR.PD["魔神降临"][id] ~= nil then
                        lx = true
                    end
                    if match_ID(id, 639) or match_ID(id, 9908) then
                        WAR.LQZ[id] = math.random(60, 90)
                        lx = true
                    end
                    if match_ID(id, 112) and WAR.PD["杀破狼"][id] ~= nil then
                        lx = true
                    end
                    if lx == true then
                    else
                        WAR.LQZ[id] = 0
                        if WAR.PD['入魔'][id] ~= nil and WAR.PD['入魔'][id] == 1 then
                            WAR.PD['入魔'][id] = nil
                        end
                    end
                end

                -- 北冥神功给自己加怒气
                if WAR.BMSGXL > 0 and id == 0 then
                    WAR.LQZ[id] = (WAR.LQZ[id] or 0) + WAR.BMSGXL
                    if WAR.LQZ[id] > 100 then
                        WAR.LQZ[id] = 100
                        WAR.BMSGXL = 0
                        CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
                    end
                end

                -- 刀主大招，行动后恢复怒气
                if id == 0 and JY.Base["标准"] == 4 and WAR.YZHYZ > 0 then
                    WAR.LQZ[id] = limitX((WAR.LQZ[id] or 0) + WAR.YZHYZ, 0, 100)
                    WAR.YZHYZ = 0
                    if WAR.LQZ[id] ~= nil and WAR.LQZ[id] == 100 then
                        CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
                    end
                end
                -- 内轻特效201
                if NeiGong_tx(id, 201) then
                    WAR.LQZ[id] = WAR.LQZ[id] or 0 + (dkfcj_ng * 2)
                    if WAR.LQZ[id] > 100 then
                        WAR.LQZ[id] = 100
                        CurIDTXDH(WAR.CurID, 6, 1, "怒气爆发")
                    end
                end

                -- 杨过 吼  龙儿~~
                if WAR.XK == 1 then
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["人物编号"] == 58 and 0 <
                            JY.Person[WAR.Person[j]["人物编号"]]["生命"] and WAR.Person[j]["我方"] ~=
                            WAR.Person[WAR.CurID]["我方"] then
                            WAR.Person[j].Time = 980
                            say(
                                "１Ｒ龙儿－－－－－－！Ｈ５啊－－－－４－－－－３－－－－２－－－－１－－－－－－－－！！！",
                                58, 0)
                            WAR.XK = 2
                        end
                    end
                end
                -- 难知如阴
                if WAR.FLHS5 == 1 then
                    local z = WAR.CurID
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["人物编号"] == 0 and 0 < JY.Person[0]["生命"] then
                            WAR.FLHS5 = 2
                            WAR.CurID = j
                        end
                    end
                    if WAR.FLHS5 == 2 and WAR.AutoFight == 0 then
                        WAR.Person[WAR.CurID]["移动步数"] = 6
                        War_CalMoveStep(WAR.CurID, WAR.Person[WAR.CurID]["移动步数"], 0)
                        local x, y = nil, nil
                        while 1 do
                            if JY.Restart == 1 then
                                break
                            end
                            x, y = War_SelectMove()
                            if x ~= nil then
                                WAR.ShowHead = 0
                                War_MovePerson(x, y)
                                break
                            end
                        end
                    end
                    WAR.FLHS5 = 0
                    WAR.CurID = z
                end
                -- 攻击后可移动
                -- 内轻特效1002
                if NeiGong_tx(id, 1002) then
                    if (0 < WAR.Person[p]["移动步数"] or 0 < WAR.ZYYD) and WAR.Person[p]["我方"] == true and
                        isteam(id) and WAR.AutoFight == 0 and 0 < JY.Person[id]["生命"] then
                        if 0 < WAR.ZYYD then
                            WAR.Person[p]["移动步数"] = WAR.ZYYD
                            War_CalMoveStep(p, WAR.ZYYD, 0)
                        else
                            War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
                        end
                        local x, y = nil, nil
                        while 1 do
                            if JY.Restart == 1 then
                                break
                            end
                            x, y = War_SelectMove()
                            if x ~= nil then
                                WAR.ShowHead = 0
                                War_MovePerson(x, y)
                                break
                            end
                        end
                    end
                end

                -- 无酒不欢：无论是否触发了圣火再移动，这个变量都应该在这一步清除，否则会影响到下一个人的圣火判定
                -- 触发周伯通左右补偿不清除
                if WAR.ZHB == 0 then
                    WAR.ZYYD = 0
                end

                -- 周伯通的追加互搏判定
                if WAR.ZHB == 1 then
                    WAR.ZHB = 0
                end
                -- 阿凡提 攻击后可移动
                if match_ID(id, 9802) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 <
                    JY.Person[id]["生命"] then
                    WAR.Person[p]["移动步数"] = 10
                    War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
                    local x, y = nil, nil
                    while 1 do
                        if JY.Restart == 1 then
                            break
                        end
                        x, y = War_SelectMove()
                        if x ~= nil then
                            WAR.ShowHead = 0
                            War_MovePerson(x, y)
                            break
                        end
                    end
                end

                -- 司空摘星 攻击后可移动
                if match_ID(id, 579) and WAR.Person[p]["我方"] == true and WAR.AutoFight == 0 and 0 <
                    JY.Person[id]["生命"] then
                    WAR.Person[p]["移动步数"] = 5
                    War_CalMoveStep(p, WAR.Person[p]["移动步数"], 0)
                    local x, y = nil, nil
                    while 1 do
                        if JY.Restart == 1 then
                            break
                        end
                        x, y = War_SelectMove()
                        if x ~= nil then
                            WAR.ShowHead = 0
                            War_MovePerson(x, y)
                            break
                        end
                    end
                end

                -- 雪山上杀血刀老祖后，恢复我方人物 
                if WAR.ZDDH == 7 then
                    for x = 0, WAR.PersonNum - 1 do
                        if WAR.Person[x]["人物编号"] == 97 and JY.Person[97]["生命"] <= 0 then
                            for xx = 0, WAR.PersonNum - 1 do
                                if WAR.Person[xx]["人物编号"] ~= 97 then
                                    WAR.Person[xx]["我方"] = true
                                end
                            end
                        end
                    end
                end

                -- 行动后的效果上限600点
                if 600 < WAR.Person[p].Time then
                    WAR.Person[p].Time = 600
                end
                -- 西门吹雪 
                local ljxd = 0
                if match_ID(pid, 500) then
                    local pd = false
                    if WAR.LJXD < 1 and JLSD(10, 50, pid) then
                        if inteam(pid) then
                            if match_ID_awakened(pid, 500, 1) and JY.Person[0]["资质"] > 79 then
                                pd = true
                            end
                        else
                            pd = true
                        end
                    end
                    if pd == true then
                        WAR.LJXD = WAR.LJXD + 1
                        ljxd = 1
                        WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                        CurIDTXDH(WAR.CurID, 132, 1, "剑道巅峰・五方行尽", C_ORANGE);
                        for j = 0, WAR.PersonNum - 1 do
                            WAR.Person[j].Time = WAR.Person[j].Time - 10
                            if 995 < WAR.Person[j].Time then
                                WAR.Person[j].Time = 995
                            end
                        end
                        WAR.Person[WAR.CurID].Time = 1005
                    end
                end
                if ljxd == 0 then
                    WAR.LJXD = 0
                end
                -- 金镶玉
                if match_ID(id, 456) then
                    WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                    CurIDTXDH(WAR.CurID, 145, 1, "赛西施.魅惑", C_ORANGE);
                    for j = 0, WAR.PersonNum - 1 do
                        local eid = WAR.Person[j]["人物编号"]
                        if JLSD(0, 15, eid) then
                            if WAR.Person[j]["死亡"] == false and WAR.Person[WAR.CurID]["我方"] == false then
                                WAR.PD['魅惑状态'][eid] = 1
                                WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                                CurIDTXDH(j, 145, 1, "魅惑", C_ORANGE)
                            end
                        end
                        lib.Delay(20)
                        DrawTimeBar2()
                    end
                end
                -- 无酒不欢：袁承志，碧血长风，杀人后再动
                if match_ID(id, 54) and WAR.BXCF == 1 and War_isEnd() == 0 then
                    for k = 1, 20 do
                        local i = 12 + k
                        if i > 24 then
                            i = 24
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        NewDrawString(-1, -1, "碧血长风", C_RED, 25 + i)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                    for j = 0, WAR.PersonNum - 1 do
                        WAR.Person[j].Time = WAR.Person[j].Time - 10
                        if 995 < WAR.Person[j].Time then
                            WAR.Person[j].Time = 995
                        end
                    end
                    WAR.Person[WAR.CurID].Time = 1005

                    WAR.BXCF = 0
                end
                -- 五六七，杀人后再动 标记修改
                if match_ID(id, 514) and WAR.ZQCK == 1 and War_isEnd() == 0 then
                    for k = 1, 20 do
                        local i = 12 + k
                        if i > 24 then
                            i = 24
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        NewDrawString(-1, -1, "敌挡就杀敌・鸡挡就杀鸡", Violet, 25 + i)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                    for j = 0, WAR.PersonNum - 1 do
                        WAR.Person[j].Time = WAR.Person[j].Time - 10
                        if 995 < WAR.Person[j].Time then
                            WAR.Person[j].Time = 995
                        end
                    end
                    WAR.Person[WAR.CurID].Time = 1005

                    WAR.ZQCK = 0
                end
                -- 黯然无中生有
                if WAR.PD['黯然・无中生有'][pid] ~= nil and WAR.PD['黯然・无中生有'][pid] == 1 and
                    War_isEnd() == 0 then
                    for k = 1, 20 do
                        local i = 12 + k
                        if i > 24 then
                            i = 24
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        NewDrawString(-1, -1, "无中生有", LimeGreen, 25 + i)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                    for j = 0, WAR.PersonNum - 1 do
                        WAR.Person[j].Time = WAR.Person[j].Time - 10
                        if 995 < WAR.Person[j].Time then
                            WAR.Person[j].Time = 995
                        end
                    end
                    WAR.Person[WAR.CurID].Time = 1005
                    WAR.PD['黯然・无中生有'][pid] = nil
                end

                -- 招式再次行动
                if WAR.PD['招式・再次行动'][pid] ~= nil and WAR.PD['招式・再次行动'][pid] == 1 and
                    War_isEnd() == 0 then
                    for k = 1, 20 do
                        local i = 12 + k
                        if i > 24 then
                            i = 24
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        NewDrawString(-1, -1, "再次行动", C_ORANGE, 25 + i)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                    for j = 0, WAR.PersonNum - 1 do
                        WAR.Person[j].Time = WAR.Person[j].Time - 10
                        if 995 < WAR.Person[j].Time then
                            WAR.Person[j].Time = 995
                        end
                    end
                    Cat('立刻出手', WAR.CurID)
                    WAR.PD['招式・再次行动'][pid] = nil
                end

                -- 李白十步杀一人，杀人后再动
                if match_ID(id, 9730) and id == 0 and WAR.SBSYR == 1 and War_isEnd() == 0 then
                    for k = 1, 20 do
                        local i = 12 + k
                        if i > 24 then
                            i = 24
                        end
                        Cat('实时特效动画')
                        Cls()
                        Cat('实时特效动画2')
                        NewDrawString(-1, -1, "十步杀一人", C_RED, 25 + i)
                        ShowScreen();
                        lib.Delay(CC.BattleDelay)
                    end
                    for j = 0, WAR.PersonNum - 1 do
                        WAR.Person[j].Time = WAR.Person[j].Time - 10
                        if 995 < WAR.Person[j].Time then
                            WAR.Person[j].Time = 995
                        end
                    end
                    WAR.Person[WAR.CurID].Time = 1005

                    WAR.SBSYR = 0
                end
                -- 御气纵横
                if match_ID(id, 9945) then
                    local sz = JY.Person[id]['实战']
                    local ts = JY.Base['天书数量']
                    local jl = sz / 25 + ts
                    if JLSD(0, 30, id) then
                        CurIDTXDH(WAR.CurID, 129, 1, '御气纵横')
                        WAR.PD['御气纵横'][id] = 50
                        Cat('护盾停止', WAR.CurID)
                        WAR.Person[WAR.CurID]['护盾'] = 7
                    end
                end

                -- 资质越高发动几率越高
                local pz = math.modf(JY.Person[0]["资质"] / 10)
                -- 主角医生大招，直接再次行动
                if id == 0 and JY.Base["标准"] == 8 and
                    (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500) then
                    if WAR.HTSS == 1 then
                        WAR.HTSS = 0
                    else
                        if JY.Person[0]["体力"] > 50 then
                            if WAR.HTSS == 0 and JLSD(25, 60 + pz, 0) and 0 < JY.Person[0]["武功9"] then
                                CurIDTXDH(WAR.CurID, 91, 1)

                                for k = 1, 20 do
                                    local i = 12 + k
                                    if i > 24 then
                                        i = 24
                                    end
                                    Cat('实时特效动画')
                                    Cls()
                                    Cat('实时特效动画2')
                                    NewDrawString(-1, -1, ZJTF[8] .. TFSSJ[8], C_GOLD, 25 + i)
                                    ShowScreen();
                                    lib.Delay(CC.BattleDelay)
                                end

                                for j = 0, WAR.PersonNum - 1 do
                                    WAR.Person[j].Time = WAR.Person[j].Time - 10
                                    if 995 < WAR.Person[j].Time then
                                        WAR.Person[j].Time = 995
                                    end
                                end
                                WAR.Person[WAR.CurID].Time = 1005
                                JY.Person[0]["体力"] = JY.Person[0]["体力"] - 10
                                -- 有低概率再次发动
                                if JLSD(45, 50, 0) then
                                    WAR.HTSS = 0
                                else
                                    WAR.HTSS = 1
                                end
                            end
                        end
                    end
                end
                -- 朱长龄
                if match_ID(pid, 165) then
                    local sm = math.modf(JY.Person[pid]["生命最大值"] / 10)
                    if WAR.SXTJ == 50 then
                        WAR.Person[WAR.CurID]['生命点数'] = WAR.Person[WAR.CurID]['生命点数'] or 0 + sm
                    elseif WAR.SXTJ == 100 then
                        WAR.Person[WAR.CurID]['生命点数'] = WAR.Person[WAR.CurID]['生命点数'] or 0 - sm * 2
                    end
                    if JY.Person[pid]["生命"] < 1 then
                        JY.Person[pid]["生命"] = 1
                    end
                end
                -----------------特殊战斗胜利--------------------
                --阳内九阳战
                if WAR.ZDDH == 287 and  (JY.Person[638]['生命'] < JY.Person[638]['生命最大值']/2) and JY.Person[0]['内力性质'] == 1 then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    if JY.Person[0]["性别"] == 0 then
                        TalkEx( "小兄弟年纪轻轻，根骨奇佳，正可传我衣钵，这九阳神功就送你了。", 638, 0) -- 对话
                    else
                        TalkEx( "小姑娘年纪轻轻，根骨奇佳，正可传我衣钵，这九阳神功就送你了。", 638, 0) -- 对话
                    end
                end

                if WAR.ZDDH == 373 and 200 < WAR.SXTJ then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    say("胡兄，今日就到此为止罢！", 3, 0)
                    Cls()
                    say("那明日再战", 633, 0)
                    Cls()
                end
                -- 胡苗战5
                if WAR.ZDDH == 373 and CC.TX['胡苗战5'] == 1 and 100 == WAR.SXTJ then
                    say('苗兄，你这招闭门铁扇刀，还是使得太快了些，劲力不长。', 633, 0)
                    Cls()
                    say('多承指教，我只道已经够慢了', 3, 0)
                    Cls()
                    break
                end
                if WAR.ZDDH == 380 and WAR.Data["敌人2"] == nil and 100 < WAR.SXTJ then
                    say("二弟，你退下，让我来会会胡家刀法！", 741, 0)
                    WAR.Data["敌人2"] = 741
                    NewWARPersonZJ(741, false, 17, 21, false, 2)
                end

                -- 成昆密道 100时序就跑
                if WAR.ZDDH == 237 and 100 < WAR.SXTJ then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    say("１Ｌ＜嗯，没功夫跟这" .. JY.Person[0]["外号2"] .. "纠缠了＞Ｗ哈哈哈，" .. JY.Person[0]["外号2"] .. "，算你走运！老夫还有要事待办，这次就放你一马！", 18, 0)
                end
                if WAR.ZDDH == 383 then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false and WAR.Person[i]["死亡"] == true then
                            say(
                                "Ｌ＜惨然道＞Ｗ一身做事一身当，凤某行事不当，惹得尊驾打这个抱不平，这与小儿可不相干。凤某不敢再活，但求饶了小儿性命。",
                                748, 0)
                            Cls()
                            say(
                                "Ｌ＜忽听得嗤嗤声响，一件暗器从殿门外自高而下的飞射过来，铮的一声，在单刀上一碰。凤天南一荡，单刀立时歪了，但还是在左肩上划了一道口子，鲜血迸流。确是救了凤天南一命，胡斐心下大惊。＞",
                                1, 1)
                            Cls()
                        end
                    end
                end
                -- 成昆密道 小于100时序战胜
                if WAR.ZDDH == 237 and 100 > WAR.SXTJ and War_isEnd() then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false and WAR.Person[i]["死亡"] == true then
                            instruct_2(14, 1)
                        end
                    end
                end
                -- 大金刚掌战胜天虹半血即可
                if WAR.ZDDH == 353 and JY.Person[657]["生命"] < JY.Person[657]["生命最大值"] / 2 then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                end
                -- 张三丰 太极神功200时序
                if WAR.ZDDH == 22 and (JY.Person[5]["生命"] < JY.Person[5]["生命最大值"] / 2 or 200 < WAR.SXTJ) then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    if JY.Person[0]["性别"] == 0 then
                        TalkEx(
                            "小兄弟年纪轻轻，武功就已到如此境界，实属难得。今日就到此为止",
                            5, 0) -- 对话
                    else
                        TalkEx(
                            "小姑娘年纪轻轻，武功就已到如此境界，实属难得。今日就到此为止",
                            5, 0) -- 对话
                    end
                end

                -- 易筋战 达摩半血即获胜
                if WAR.ZDDH == 309 and
                    (JY.Person[577]["生命"] < JY.Person[577]["生命最大值"] / 2 or 300 < WAR.SXTJ) then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    if JY.Person[0]["性别"] == 0 then
                        TalkEx(
                            "小兄弟年纪轻轻，武功就已到如此境界，实属难得。今日就到此为止",
                            577, 0) -- 对话
                    else
                        TalkEx(
                            "小姑娘年纪轻轻，武功就已到如此境界，实属难得。今日就到此为止",
                            577, 0) -- 对话
                    end
                end

                -- 西夏皇宫 李秋水半血即获胜
                if WAR.ZDDH == 333 and
                    (JY.Person[118]["生命"] < JY.Person[118]["生命最大值"] / 2 or 300 < WAR.SXTJ) then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    if JY.Person[0]["性别"] == 0 then
                        TalkEx("小少年，我就要死了，谁不会死呢，哼！那老妖婆也要活不成了",
                            118, 0) -- 对话
                    else
                        TalkEx("小姑娘，我就要死了，谁不会死呢，哼！那老妖婆也要活不成了",
                            118, 0) -- 对话
                    end
                end

                -- 冰糖恋：邪十五大20时序胜利
                if WAR.ZDDH == 133 and 20 < WAR.SXTJ and GetS(87, 31, 31, 5) == 1 then
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["我方"] == false then
                            WAR.Person[i]["死亡"] = true
                        end
                    end
                    TalkEx("恭喜" .. JY.Person[0]["外号"] .. "挺过20时序，成功过关。", 269, 0);
                end

                -- 旧版华山论剑，敌我随机变换
                if WAR.ZDDH == 238 then
                    local life = 0 ---激活敌人
                    WAR.NO1 = 114; --- 1号 战斗角色等于扫地
                    for i = 0, WAR.PersonNum - 1 do -- 执行指令
                        if WAR.Person[i]["死亡"] == false and 0 < JY.Person[WAR.Person[i]["人物编号"]]["生命"] then -- 如果没有死人和人物生命大于0 这样
                            life = life + 1 -- 敌人+1
                            if WAR.NO1 >= WAR.Person[i]["人物编号"] then -- 如果编号大于等于1号人物
                                WAR.NO1 = WAR.Person[i]["人物编号"] -- 敌人等于1号
                            end
                        end
                    end

                    if 1 < life then -- 如果激活人数大于1
                        local m, n = 0, 0 -- 编号 设定 一个M方,一个N方
                        while true do -- 防止全部随机到已方
                            if m >= 1 and n >= 1 then -- 如果M方大于等于1，N方大于等于1
                                break -- 终止循环
                            else -- 也可能是
                                m = 0; -- M方为0 
                                n = 0; -- N方为0
                            end

                            for i = 0, WAR.PersonNum - 1 do -- 执行指令
                                if WAR.Person[i]["死亡"] == false and 0 <
                                    JY.Person[WAR.Person[i]["人物编号"]]["生命"] then -- 如果没有人死亡和人物生命大于0 
                                    if WAR.Person[i]["人物编号"] == 0 then -- 如果人物编号等于0
                                        WAR.Person[i]["我方"] = true -- 则为我方
                                        m = m + 1 -- M方人数+1
                                    elseif math.random(2) == 1 then -- 也可能 随机1~2为1时
                                        WAR.Person[i]["我方"] = true -- 成为我方
                                        m = m + 1 -- M方人数+1
                                    else
                                        WAR.Person[i]["我方"] = false -- 也可能不是我方
                                        n = n + 1 -- 则N方人数+1
                                    end
                                end
                            end
                        end
                    end
                end
            end
        end
        ::label0::
        CleanMemory()
        -- end
        warStatus = War_isEnd()
        if 0 < warStatus then
            break
        end

        WarPersonSort(1)
        WAR.Delay = GetJiqi()
        startt = lib.GetTime()
        collectgarbage("step", 0)
    end
    local r = nil
    WAR.ShowHead = 0

    -- 战斗结束后的奖励
    if WAR.ZDDH == 238 then
        PlayMIDI(111)
        PlayWavAtk(41)
        DrawStrBoxWaitKey("论剑结束", C_WHITE, CC.DefaultFont)
        DrawStrBoxWaitKey("武功天下第一者：" .. JY.Person[WAR.NO1]["姓名"], C_RED, CC.DefaultFont)
        if WAR.NO1 == 0 then
            r = true
        else
            r = false
        end
        -- 战斗胜利
    elseif warStatus == 1 then
        PlayMIDI(111)
        PlayWavAtk(41)
        local picmenu = {}
        for i = 0, JY.PersonNum - 1 do
            if JY.Person[i]["性别"] == 1 then
                picmenu[#picmenu + 1] = JY.Person[i]["半身像"]
            end
        end
        local nn = math.random(#picmenu)
        local nm = picmenu[nn]
        lib.LoadPNG(91, 1 * 2, CC.WX * 275, CC.HY * 205, 1)
        lib.LoadPNG(90, nm * 2, CC.WX * 275, CC.HY * 205, 1, 0, 100)
        ShowScreen();
        WaitKey();

        if WAR.ZDDH == 76 then
            DrawStrBoxWaitKey("特殊奖励：千年灵芝一枚", C_GOLD, CC.DefaultFont)
            instruct_32(14, 1)

        elseif WAR.ZDDH == 15 or WAR.ZDDH == 80 then
            DrawStrBoxWaitKey("特殊奖励：主角五系兵器值提升十点", C_RED, CC.DefaultFont, nil, C_GOLD)
            AddPersonAttrib(0, "拳掌功夫", 10)
            AddPersonAttrib(0, "指法技巧", 10)
            AddPersonAttrib(0, "御剑能力", 10)
            AddPersonAttrib(0, "耍刀技巧", 10)
            AddPersonAttrib(0, "特殊兵器", 10)
        elseif WAR.ZDDH == 292 then
            local hqjl = LGMsgBox("特殊奖励", "你完成了奖励战**请选择一项兵器值进行提高",
                {"拳法", "指法", "剑法", "刀法", "奇门"}, 5, 69)
            if hqjl == 1 then
                AddPersonAttrib(0, "拳掌功夫", 10)
                DrawStrBoxWaitKey("你的拳掌功夫提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 2 then
                AddPersonAttrib(0, "指法技巧", 10)
                DrawStrBoxWaitKey("你的指法技巧提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 3 then
                AddPersonAttrib(0, "御剑能力", 10)
                DrawStrBoxWaitKey("你的御剑能力提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 4 then
                AddPersonAttrib(0, "耍刀技巧", 10)
                DrawStrBoxWaitKey("你的耍刀技巧提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 5 then
                AddPersonAttrib(0, "特殊兵器", 10)
                DrawStrBoxWaitKey("你的特殊兵器提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            end
            DrawStrBoxWaitKey("特殊奖励：获得峨眉九阳功秘籍一本", C_GOLD, CC.DefaultFont)
            instruct_32(379, 1)
        elseif WAR.ZDDH == 172 then
            DrawStrBoxWaitKey("特殊奖励：获得蛤蟆功秘籍一本", C_GOLD, CC.DefaultFont)
            instruct_32(73, 1)
        elseif WAR.ZDDH == 173 then
            DrawStrBoxWaitKey("特殊奖励：获得天山雪莲两枚", C_GOLD, CC.DefaultFont)
            instruct_32(17, 2)
        elseif WAR.ZDDH == 188 then
            local hqjl = LGMsgBox("特殊奖励", "你完成了奖励战**请选择一项兵器值进行提高",
                {"拳法", "指法", "剑法", "刀法", "奇门"}, 5, 69)
            if hqjl == 1 then
                AddPersonAttrib(0, "拳掌功夫", 10)
                DrawStrBoxWaitKey("你的拳掌功夫提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 2 then
                AddPersonAttrib(0, "指法技巧", 10)
                DrawStrBoxWaitKey("你的指法技巧提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 3 then
                AddPersonAttrib(0, "御剑能力", 10)
                DrawStrBoxWaitKey("你的御剑能力提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 4 then
                AddPersonAttrib(0, "耍刀技巧", 10)
                DrawStrBoxWaitKey("你的耍刀技巧提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            elseif hqjl == 5 then
                AddPersonAttrib(0, "特殊兵器", 10)
                DrawStrBoxWaitKey("你的特殊兵器提高了十点", C_GOLD, CC.DefaultFont, nil, LimeGreen)
                Cls() -- 清屏
            end
        elseif WAR.ZDDH == 211 then
            DrawStrBoxWaitKey("特殊奖励：主角防御力和轻功各提升十点", C_GOLD, CC.DefaultFont)
            AddPersonAttrib(0, "防御力", 10)
            AddPersonAttrib(0, "轻功", 10)

        elseif WAR.ZDDH == 86 then
            instruct_2(66, 1)
            -- 战胜海大富
        elseif WAR.ZDDH == 259 then
            DrawStrBoxWaitKey("特殊奖励：获得化骨绵掌秘籍一本", C_GOLD, CC.DefaultFont)
            instruct_32(275, 1)
            -- 标记修改
        elseif WAR.ZDDH == 100 then
            DrawStrBoxWaitKey("特殊奖励：获得火焰刀法秘籍一本", C_GOLD, CC.DefaultFont)
            instruct_32(135, 1)
            -- 新论剑奖励 根据敌人不同奖励不同
        elseif WAR.ZDDH == 266 then
            -- 老周
            if GetS(85, 40, 38, 4) == 64 then
                DrawStrBoxWaitKey("特殊奖励：你的体内消耗永久降低了50% ", LimeGreen, 36, nil, C_GOLD)
                CC.TX["周伯通奖励"] = 1
                -- 老王
            elseif GetS(85, 40, 38, 4) == 129 then
                DrawStrBoxWaitKey("特殊奖励：你的伤害量永久提高了20% ", LimeGreen, 36, nil, C_GOLD)
                CC.TX["王重阳奖励"] = 1
                -- 林朝英
            elseif GetS(85, 40, 38, 4) == 605 then
                DrawStrBoxWaitKey("特殊奖励：你的连击暴击率永久提高了50% ", LimeGreen, 36, nil, C_GOLD)
                CC.TX["林朝英奖励"] = 1
                -- 阿青
            elseif GetS(85, 40, 38, 4) == 604 then
                DrawStrBoxWaitKey("特殊奖励：你的气防永久提高了800点", LimeGreen, 36, nil, C_GOLD)
                CC.TX["阿青奖励"] = 1
                -- 风清扬
            elseif GetS(85, 40, 38, 4) == 140 then
                DrawStrBoxWaitKey("特殊奖励：你的气攻永久提高了1000点", LimeGreen, 36, nil, C_GOLD)
                CC.TX["风清扬奖励"] = 1
                -- 东方不败
            elseif GetS(85, 40, 38, 4) == 27 then
                DrawStrBoxWaitKey("特殊奖励：你的集气速度永久提高了8点", LimeGreen, 36, nil, C_GOLD)
                CC.TX["东方不败奖励"] = 1
                -- 扫地
            elseif GetS(85, 40, 38, 4) == 114 then
                DrawStrBoxWaitKey("特殊奖励：你的气防永久提高了1000点", LimeGreen, 36, nil, C_GOLD)
                -- AddPersonAttrib(0, "武学常识", 100)
                CC.TX["扫地奖励"] = 1
                -- 三丰
            elseif GetS(85, 40, 38, 4) == 5 then
                DrawStrBoxWaitKey("特殊奖励：你的攻防轻和五系兵器值全面提高了", LimeGreen, 36, nil,  C_GOLD)
                AddPersonAttrib(0, "攻击力", 30)
                AddPersonAttrib(0, "防御力", 30)
                AddPersonAttrib(0, "轻功", 30)
                AddPersonAttrib(0, "拳掌功夫", 20)
                AddPersonAttrib(0, "指法技巧", 20)
                AddPersonAttrib(0, "御剑能力", 20)
                AddPersonAttrib(0, "耍刀技巧", 20)
                AddPersonAttrib(0, "特殊兵器", 20)
                -- 阿凡提
            elseif GetS(85, 40, 38, 4) == 606 then
                DrawStrBoxWaitKey("特殊奖励：你获得了绝对先手的能力", LimeGreen, 36, nil, C_GOLD)
                CC.TX["阿凡提奖励"] = 1
            end
        end

        r = true
        -- 赵半山 李寻欢战斗胜利获得暗器
        if (JY.Base["畅想"] == 153 or JY.Base["畅想"] == 498) and WAR.ZDDH ~= 226 and WAR.ZDDH ~= 354 then
            local anqi = math.random(28, 35)
            local num = math.random(5)
            instruct_2(anqi, num)
        end
        r = true
        if WAR.ZDDH ~= 226 and WAR.ZDDH ~= 354 then
            for i = 0, WAR.PersonNum - 1 do
                local id = WAR.Person[i]['人物编号']
                local menu = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13}
                local menu1 = {}
                local n = Rnd(2)
                if n < 1 then
                    n = 1
                end
                RandFetch(menu1, n, #menu)
            end
        end
        r = true
        -- 战斗胜利获得银两
        if (JY.Base["标准"] > 0 or JY.Base["畅想"] > 0) and WAR.ZDDH ~= 226 and WAR.ZDDH > 0 and WAR.ZDDH ~= 354 and
            WAR.ZDDH ~= 352 and WAR.ZDDH ~= 67 and WAR.ZDDH ~= 82 then
            local num = math.random(50, 100)
            local num1 = math.random(1, 3)
            if JY.Base["单通"] == 0 then
                num = num * 10
                num1 = num1 * 10
            end
            instruct_2(174, num)
            instruct_2(550, num1)
        end
        if WAR.ZDDH ~= 226 and WAR.ZDDH ~= 354 then
            for i = 0, WAR.PersonNum - 1 do
                local id = WAR.Person[i]['人物编号']
                if WAR.Person[i]['我方'] then
                    if match_ID(id, 9965) then
                        local a = math.random(22, 25)
                        local b = math.random(0, 13)
                        instruct_2(a, 1)
                        instruct_2(b, 1)
                        break
                    end
                end
            end
        end
        r = true
        -- 战斗失败
    elseif warStatus == 2 then
        local picmenu = {}
        for i = 0, JY.PersonNum - 1 do
            if JY.Person[i]["性别"] == 0 then
                picmenu[#picmenu + 1] = JY.Person[i]["半身像"]
            end
        end
        if picmenu[1] == nil then 
            picmenu[1] = 642
        end
        local nn = math.random(#picmenu)
        local nm = picmenu[nn]
        local xx, yy = lib.GetPNGXY(91, 2 * 2)
        lib.LoadPNG(91, 2 * 2, CC.ScreenW / 2 - xx / 2, CC.ScreenH / 2 - yy / 2, 1)
        lib.LoadPNG(90, nm * 2, CC.ScreenW / 2 - xx / 2, CC.ScreenH / 2 - yy / 2, 1, 0, CC.ScreenW / 1360 * 100)
        ShowScreen();
        WaitKey();
        r = false
    end

    War_EndPersonData(isexp, warStatus)
    lib.ShowSlow(20, 1)
    if 0 <= JY.Scene[JY.SubScene]["进门音乐"] then
        PlayMIDI(JY.Scene[JY.SubScene]["进门音乐"])
    else
        PlayMIDI(0)
    end
    CleanMemory()
    -- lib.PicInit()

    -- 战斗结束，重新加载场景贴图
    -- lib.PicLoadFile(CC.SMAPPicFile[1], CC.SMAPPicFile[2], 0)	--子场景贴图，内存区域0
    -- lib.LoadPNGPath('./data/smap',0,-1,100)
    -- lib.LoadPNGPath(CC.HeadPath, 1, CC.HeadNum, limitX(CC.WX*100,0,100))	--人物头像，内存区域1
    -- lib.LoadPNGPath(CC.XTPath, 91, CC.XTNum, limitX(CC.WX*100,0,100))	--UI		
    -- lib.LoadPNGPath(CC.BodyPath, 90, CC.BodyNum, limitX(CC.WX*100,0,100))	--半身像，内存区域100
    -- lib.LoadPNGPath(CC.UIPath, 96, CC.UINum, limitX(CC.WX*100,0,100))
    -- lib.PicLoadFile(CC.ThingPicFile[1], CC.ThingPicFile[2], 2, 100, 100)	--物品贴图，内存区域2
    -- lib.LoadPNGPath('./data/thing',0,-1,100)
    -- lib.PicLoadFile(CC.BJ[1], CC.BJ[2], 92)
    -- lib.LoadPNGPath('./data/bj',0,-1,100)
    lib.LoadPNGPath(CC.TFPath, 89, CC.TFNum, limitX(CC.WX * 100, 0, 100)) -- TF
    JY.Status = GAME_SMAP
    return r
end

--战斗结束处理函数
--isexp 经验值
--warStatus 战斗状态
function War_EndPersonData(isexp, warStatus)
	--无酒不欢：血量还原函数
	Health_in_Battle_Reset()
	--无酒不欢：战后状态恢复
	JY.Person[512]['品德'] = 0
	JY.Person[512]['声望'] = 0
	JY.Person[512]['出战'] = 0
    JY.Person[512]['心魔'] = 0
    JY.Person[512]['头像代号'] = 512

	for i = 0, WAR.PersonNum - 1 do
		local pid = WAR.Person[i]["人物编号"]
		--敌方回复满状态
		if isteam(pid) == false then
			JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
			JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
			JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
            WAR.PD['内伤状态'][pid] = 0
			JY.Person[pid]["中毒程度"] = 0
			JY.Person[pid]["冰封程度"] = 0
			JY.Person[pid]["灼烧程度"] = 0
		--我方恢复状态
		else
			JY.Person[pid]["生命"] = JY.Person[pid]["生命最大值"]
			JY.Person[pid]["内力"] = JY.Person[pid]["内力最大值"]
			JY.Person[pid]["体力"] = CC.PersonAttribMax["体力"]
            WAR.PD['内伤状态'][pid] = 0
			JY.Person[pid]["中毒程度"] = 0
			JY.Person[pid]["冰封程度"] = 0
			JY.Person[pid]["灼烧程度"] = 0
			--出战统计
			JY.Person[pid]["出战"] = JY.Person[pid]["出战"] + 1
		end
	end

	--乔峰武功回复
	JY.Person[50]["武功1"] = 26
	JY.Wugong[13]["名称"] = "铁掌"
	
	--花铁杆
	if JY.Base["畅想"]==52 then
			JY.Person[0]["姓名"]= "花铁杆"
			JY.Person[0]["代号"]=52
			JY.Person[0]["头像代号"]=52
		    JY.Person[0]["半身像"]=52		
			JY.Person[0]["出招动画帧数1"]=0
			JY.Person[0]["出招动画帧数2"]=0
			JY.Person[0]["出招动画帧数3"]=0
			JY.Person[0]["出招动画帧数4"]=0
			JY.Person[0]["出招动画帧数5"]=6
			JY.Person[0]["出招动画延迟1"]=0
			JY.Person[0]["出招动画延迟2"]=0
			JY.Person[0]["出招动画延迟3"]=0
			JY.Person[0]["出招动画延迟4"]=0
			JY.Person[0]["出招动画延迟5"]=5
			JY.Person[0]["武功音效延迟1"]=0
			JY.Person[0]["武功音效延迟2"]=0
			JY.Person[0]["武功音效延迟3"]=0
			JY.Person[0]["武功音效延迟4"]=0
			JY.Person[0]["武功音效延迟5"]=4
		end
	
	--鸠摩智武功恢复
	if JY.Base["畅想"] == 103 then
		JY.Person[0]["武功2"] = 98
	end
	
	--花铁杆武功恢复
	if JY.Base["畅想"] == 52 then
		JY.Person[0]["武功1"] = 70
	end
	
	if JY.Base["畅想"] == 514 then
		JY.Person[0]["武功1"] = 75
	end
	
	if JY.Wugong[75]["名称"] == "魔刀千刃" then
	   JY.Wugong[75]["名称"] = "大剪刀"
	   JY.Wugong[75]["武功类型"] = 5
	end
  
	--破丐帮打狗阵
	if WAR.ZDDH == 82 then
		SetS(10, 0, 18, 0, 1)
	end
  
	--梅庄 秃笔翁战斗后
	if WAR.ZDDH == 44 then
		instruct_3(55, 6, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
		instruct_3(55, 7, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
	--梅庄 黑白子战斗
	if WAR.ZDDH == 45 then
		instruct_3(55, 9, 1, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
	--梅庄 黄钟公战斗
	if WAR.ZDDH == 46 then
		instruct_3(55, 13, 0, 0, 0, 0, 0, -2, -2, -2, 0, -2, -2)
	end
  
  	--葵花尊者战斗胜利
	--用东方的品德记录
	if WAR.ZDDH == 54 and CC.TX["笑傲邪线"] == 1 and WAR.MCRS == 1 then
		CC.TX["笑傲邪线"] = 2
        CC.TG[9967] = 1
	end		
	
    if WAR.ZDDH == 100 and warStatus == 1 then
	    JY.Person[344]["品德"] = 10
    end
	--战斗失败，并且无经验
	if warStatus == 2 and isexp == 0 then
		return 
	end
  
	--统计活的人数
	local liveNum = 0
	for i = 0, WAR.PersonNum - 1 do
		if WAR.Person[i]["我方"] == true and JY.Person[WAR.Person[i]["人物编号"]]["生命"] > 0 and WAR.Person[i]["死亡"] == false then
			liveNum = liveNum + 1
		end
	end
  
	--分配经验
    if liveNum > 0 then 
        local canyu = false
        if warStatus == 1 then
            --超级木桩和木桩的经验
            if WAR.ZDDH == 226   then
                WAR.Data["经验"] = 0
            end
            for i = 0, WAR.PersonNum - 1 do
                local pid = WAR.Person[i]["人物编号"]
                if WAR.Person[i]["我方"] == true and inteam(pid) and JY.Person[pid]["生命"] > 0 and WAR.Person[i]["死亡"] == false then
                    if pid == 0 then
                        canyu = true
                    end
                    --超级木桩的经验
                    if WAR.ZDDH == 226 then
                        WAR.Person[i]["经验"] = 0
                        WAR.Data["经验"] = 0
                    else
                        if JY.Base["单通"] == 0 then
                            WAR.Person[i]["经验"] =  math.modf(WAR.Data["经验"]*3)
                        else
                            WAR.Person[i]["经验"] =  math.modf(WAR.Data["经验"])
                        end
                    end
                end
            end
        end

        --把等级放在修炼秘籍的后面
        for i = 0, WAR.PersonNum - 1 do
            local pid = WAR.Person[i]["人物编号"]
            if WAR.Person[i]["我方"] == true and inteam(pid) and JY.Person[pid]["生命"] > 0 and WAR.Person[i]["死亡"] == false  then
                if WAR.ZDDH == 226   then
                    WAR.Person[i]["经验"] = 0
                    WAR.Data["经验"] = 0
                else
                    WAR.Person[i]["经验"] =  WAR.Data['经验']
                end
                local wpxlds = math.modf(WAR.Person[i]["经验"])
                if wpxlds > 5000 then
                    wpxlds = 5000
                end
                local lxds = wpxlds
                if JY.Base['单通'] == 0 then 
                    if pid ~= 0 then 
                        lxds = lxds*3
                    end
                end
                local lxds1 = 0
                if lxds > 0 then 
                    lxds1 = limitX(math.random(lxds),lxds*0.95,lxds*1.1)
                end
                lxds1 = math.modf(lxds1*1.5)
                local n = "Ｏ"..JY.Person[pid]["姓名"].."Ｗ获得修炼点数".."Ｏ"..lxds1.."Ｗ点"			
                AddPersonAttrib(pid, "物品修炼点数",lxds1)
                AddPersonAttrib(pid, "修炼点数", lxds1 )
                if WAR.Person[i]["经验"] > 0 then
                    --local ww = 
                    local xx,yy = lib.GetPNGXY(91,121*2)
                    lib.LoadPNG(91,121*2,CC.ScreenW/2-xx/2,CC.ScreenH/2-yy/2,1)
                    tjm(CC.ScreenW/2-string.len(n)/4*CC.DefaultFont*0.9+CC.DefaultFont*0.9*3,CC.ScreenH/2,n,C_CYGOLD,CC.DefaultFont*0.9,13,CC.DefaultFont*0.9)		
                    ShowScreen()
                    WaitKey()
                    Cls()
                end
                if JY.Person[pid]["修炼点数"] < 0 then
                    JY.Person[pid]["修炼点数"] = 0
                end
                War_PersonTrainBook(pid)     --修炼秘籍
                War_PersonTrainDrug(pid)		 --修炼药品
                --把等级放在修炼秘籍的后面
                AddPersonAttrib(pid, "经验", math.modf(WAR.Person[i]["经验"]))
                --War_AddPersonLVUP(pid)
                if WAR.ZDDH ~= 226  or WAR.ZDDH ~= 352 or  WAR.ZDDH ~= 354  then 
                    AddPersonAttrib(pid, "门派贡献",8)
                end
            else
                AddPersonAttrib(pid, "经验", WAR.Person[i]["经验"]/5)
            end
        end
	end
  
	--青城四秀
	if WAR.ZDDH == 48 then
		SetS(57, 52, 29, 1, 0)
		SetS(57, 52, 30, 1, 0)
	--一灯居，欧阳锋，裘千刃
	elseif WAR.ZDDH == 175 then
		instruct_3(32, 12, 1, 0, 0, 0, 0, 0, 0, 0, -2, -2, -2)
	--破打狗阵
	elseif WAR.ZDDH == 82 then
		SetS(10, 0, 18, 0, 1)
	--木人巷
	elseif WAR.ZDDH == 214 then
		SetS(10, 0, 19, 0, 1)
	--侠客邪
	elseif WAR.ZDDH == 170 then
		JY.Scene[JY.SubScene]["进门音乐"] = -1
	end

    --自创武功
    local zcjl = math.random(100)  
    local zc = 0
    if zcjl < 11 then
        zc = 1
    end
    local bx = CC.WX
    local by = CC.HY
    if zc == 1 and CC.ZCNUM == 0 and JY.Person[0]["奇穴"..139] == 1 and JY.Person[0]["奇穴"..149] == 1 and instruct_18(182) then
        for p = 102,105 do
            lib.LoadPNG(90,JY.Person[0]["半身像"]*2,bx*351,by*288,1,0,128 )
            lib.LoadPNG(91,p*2,-1,-1,1)
        end
        PlayWavAtk(42)
        ShowScreen()		   
        lib.Delay(500)
        DrawStrBoxWaitKey("Ｒ灵光一闪!心中似隐隐有所得，看来可以尝试创一门属于自己的武学了。", C_ORANGE, CC.DefaultFont,4)
        if DrawStrBoxYesNo(-1, -1, "要创造武功吗？", C_WHITE, CC.DefaultFont) then
            local zckf = 333
            local kflx = {{1,41,0,0,3,0},{4,19,0,1,6,0},{6,46,0,2,7,0},{5,65,0,1,7,0},{1,50,0,1,4,0}} 
            DrawStrBoxWaitKey('请输入自创武功的名字', C_WHITE, 30)
            JY.Wugong[zckf]['名称'] = Shurufa(10,10)  
            JY.Wugong[zckf]['门派'] = JY.Person[0]['门派']		
            instruct_35(0, 0, 333, 999)
            local level=math.modf(JY.Person[0]["武功等级" .. 1] /100)+1
            JY.Wugong[zckf]['层级'] = 4
            local kftype = LGMsgBox("请选择", "要自创哪门武功呢？", {"拳法","指法","剑法","刀法","奇门"}, 5, JY.Person[0]["半身像"])
            JY.Wugong[zckf]['武功类型'] = kftype
            local zckfatk = 1000

            for i = 1,10 do 
                JY.Wugong[zckf]["攻击力"..i] = zckfatk + i*200                
            end
            JY.Wugong[zckf]["加命中"] = zckfatk + level*50

            local zckfwz = {'神拳.','神指.','神剑.','神刀.','神兵.'}
            for i = 1,#CC.KFMove[zckf] do 
                CC.KFMove[zckf][i][1] =  zckfwz[kftype]..CC.KFMove[zckf][i][1]
            end  
            JY.Wugong[zckf]["出招音效"] = kflx[kftype][1]  
            JY.Wugong[zckf]["武功动画&音效"] =  kflx[kftype][2]
            JY.Wugong[zckf]["伤害类型"] = kflx[kftype][3]
            JY.Wugong[zckf]["攻击范围"] = kflx[kftype][4]
            JY.Wugong[zckf]["移动范围" .. 10] = kflx[kftype][5] 
            JY.Wugong[zckf]["杀伤范围" .. 10] = kflx[kftype][6] 
        
            local wz1 = {} 
            for i = 1,#ZSTX[1] do
                wz1[#wz1+1] = ZSTX[1][i][2]
            end 
            local kftype1 = LGMsgBox("请选择", "请选择第一招的特效", wz1,#ZSTX[1], JY.Person[0]["半身像"])          
            JY.Wugong[zckf]['招式'..1] = ZSTX[1][kftype1][1]*10+4
            --say(JY.Wugong[333]['招式'..1],1,1)
        
            local wz2 = {} 
            for i = 1,#ZSTX[2] do
                wz2[#wz2+1] = ZSTX[2][i][2]
            end 
            local kftype2 = LGMsgBox("请选择", "请选择第二招的特效", wz2, #ZSTX[2], JY.Person[0]["半身像"])
            JY.Wugong[zckf]['招式'..2] = ZSTX[2][kftype2][1]*10+4 
            --say(JY.Wugong[333]['招式'..2],1,1) 
        
            local wz3 = {} 
            for i = 1,#ZSTX[3] do
                wz3[#wz3+1] = ZSTX[3][i][2]
            end 
            local kftype3 = LGMsgBox("请选择", "请选择第三招的特效", wz3, #ZSTX[3], JY.Person[0]["半身像"])
            JY.Wugong[zckf]['招式'..3] = ZSTX[3][kftype3][1]*10+4 
            --say(JY.Wugong[333]['招式'..3],1,1) 	
        
            local wz4 = {} 
            for i = 1,#ZSTX[4] do
                wz4[#wz4+1] = ZSTX[4][i][2]
            end 
            local kftype4 = LGMsgBox("请选择", "请选择第四招的特效", wz4, #ZSTX[4], JY.Person[0]["半身像"])
            JY.Wugong[zckf]['招式'..4] = ZSTX[4][kftype4][1]*10+4 
        
            local wz5 = {} 
            for i = 1,#ZSTX[5] do
                wz5[#wz5+1] = ZSTX[5][i][2]
            end 
            local kftype5 = LGMsgBox("请选择", "请选择第五招的特效", wz5, #ZSTX[5], JY.Person[0]["半身像"])
            JY.Wugong[zckf]['招式'..5] = ZSTX[5][kftype5][1]*10+4 
        
            local wz6 = {} 
            for i = 1,#ZSTX[6] do
                wz6[#wz6+1] = ZSTX[6][i][2]
            end 
            local kftype6 = LGMsgBox("请选择", "请选择第六招的特效", wz6, #ZSTX[6], JY.Person[0]["半身像"])
            JY.Wugong[zckf]['招式'..6] = ZSTX[6][kftype6][1]*10+4 
            instruct_2(182,-1)
            instruct_35(0, 0, 333, 50)
            --JY.Person[0]['武功'..1] = zcwg
            --JY.Person[0]['武功等级'..1] = 50
            CC.ZCNUM = 1
        end
    end

	if JY.Restart == 1 then
		return
	end
end

-- 自动战斗（暗器攻击）函数
-- 参数：
-- self：自身信息（包含x, y坐标）
-- enemy：敌人信息（包含x, y坐标，hp血量）
-- 功能：自动移动至暗器射程（5格内），并发起攻击
function autoAttackWithDart(self, enemy)
    -- 计算当前距离（曼哈顿距离，简化格子移动逻辑）
    local function getDistance(a, b)
        return math.abs(a.x - b.x) + math.abs(a.y - b.y)
    end

    local currentDist = getDistance(self, enemy)
    lib.Debug(string.format("初始位置：自身(%d,%d)，敌人(%d,%d)，距离：%d格",  self.x, self.y, enemy.x, enemy.y, currentDist))

    -- 自动移动至5格内
    while currentDist > 5 do
        -- 计算移动方向（优先x轴靠近，再y轴）
        if self.x < enemy.x then
            self.x = self.x + 1  -- 向右移
            lib.Debug("向右移动1格，当前位置：(" .. self.x .. "," .. self.y .. ")")
        elseif self.x > enemy.x then
            self.x = self.x - 1  -- 向左移
            lib.Debug("向左移动1格，当前位置：(" .. self.x .. "," .. self.y .. ")")
        elseif self.y < enemy.y then
            self.y = self.y + 1  -- 向下移
            lib.Debug("向下移动1格，当前位置：(" .. self.x .. "," .. self.y .. ")")
        else
            self.y = self.y - 1  -- 向上移
            lib.Debug("向上移动1格，当前位置：(" .. self.x .. "," .. self.y .. ")")
        end

        currentDist = getDistance(self, enemy)
        lib.Debug("当前距离：" .. currentDist .. "格")
    end

    -- 进入射程，发起暗器攻击
    if currentDist <= 5 then
        local damage = math.random(15, 30)  -- 暗器伤害随机15-30
        enemy.hp = math.max(0, enemy.hp - damage)
        lib.Debug(string.format("\n已进入暗器射程（%d格）！使用暗器攻击敌人，造成%d点伤害！",  currentDist, damage))
            lib.Debug("敌人剩余血量：" .. enemy.hp)
        if enemy.hp == 0 then
            lib.Debug("敌人已被击败！")
        end
    end

    -- 返回更新后的自身和敌人状态
    return self, enemy
end


-- 攻击方伤害计算
Ct['伤害计算Act'] = function(wugong, level, ang, x, y)
    ----------------------函数初始设定-------------------------------------
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    -- local eid = WAR.Person[enemyid]["人物编号"]
    local eid = nil
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]["我方"] then
            eid = WAR.Person[i]["人物编号"]
        end
    end
    local ekf_ng = JY.Person[eid]['主运内功']
    local dkf_ng = JY.Person[pid]['主运内功']
    local ekfcj_ng = JY.Wugong[ekf_ng]['层级']
    local dkfcj_ng = JY.Wugong[dkf_ng]['层级']
    local ekf_qg = JY.Person[eid]['主运轻功']
    local dkf_qg = JY.Person[pid]['主运轻功']
    local ekfcj_qg = JY.Wugong[ekf_qg]['层级']
    local dkfcj_qg = JY.Wugong[dkf_qg]['层级']
    -- 毒抗
    local kdw = zdkx(WAR.CurID, JY.Person[pid]['中毒程度']) + JY.Person[pid]["内力"] / 50
    if WAR.PD['六阳正气'][pid] ~= nil then
        kdw = kdw + WAR.PD['六阳正气'][pid]
    end
    -- 500满毒抗可以降低100%的毒
    local atkd = limitX(1 - kdw / 500, 0, 1)

    -- 气防
    local dng = 0
    -- 内伤
    local nssz = 0
    -- 冰封
    local bfsz = 0
    -- 灼烧
    local zssz = 0
    -- 中毒
    local zdsz = 0
    -- 封穴
    local fxsz = 0
    -- 流血
    local lxsz = 0
    -- local 
    local WGLX = JY.Wugong[wugong]["武功类型"]
    local WGMP = JY.Wugong[wugong]["门派"]
    -- 李沅芷
    local LYZ = 0
    -- 赵敏在场

    local hurt = nil
    -- 无酒不欢：这里引入伤害二，计算保底伤害
    local hurt2 = 0
    local hurt3 = 0
    local zshurt = 0

    local w = {
        g = 0,
        f = 0,
        q = 0,
        n = 0,
        wc = 0,
        xs = 0,
        wl = 0
    }

    local d = {
        g = 0,
        f = 0,
        q = 0,
        n = 0,
        wc = 0,
        xs = 0,
        wl = 0
    }

    local wnc = 0

    local wwc = 0

    local wsc = 0

    local dnc = 0

    local dwc = 0

    local dsc = 0

    local wxs = 0

    local dxs = 0

    -- 获取武功的真实威力
    local true_WL = get_skill_power(pid, wugong, level)
    lib.Debug(JY.Person[pid]['姓名']..'伤害计算Act计算武功威力初始'..true_WL)
    lib.Debug(JY.Person[pid]['姓名']..'伤害计算Act计算气攻初始'..ang)
    -- 老顾0305
    if CC.KFMove[wugong] ~= nil then
        local level
        local wl
        local n = 0
        if wugong == JY.Person[pid]["优先使用"] then
            for i = 1, JY.Base["武功数量"] do
                if wugong == JY.Person[pid]["武功" .. i] then
                    level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1
                end
            end

            if level > 10 then
                level = 10
            end
            wl = get_skill_power(pid, wugong, level)
            if WAR.WGZS ~= nil and WAR.WGZS > 0 then
                local zh = WAR.WGZS
                if zh > 6 then
                    zh = 6
                end
                n = wl * (1 + (zh - 1) / 10)
            else
                return 
            end
        end
        true_WL = n
    end
    local atk = Atk(WAR.CurID) -- JY.Person[pid]["攻击力"]
    local defadd = 0
    local wgtype = JY.Wugong[wugong]["武功类型"];
    local NPCgxf = 1;
    local NPCfxf = 1;
    local defadd_max = 0
    ----------------------攻击方气攻加成---------------------------
    -- 斗转星移伤害和杀集气计算
    if WAR.DZXY == 1 then
        ang = WAR.PD['斗转武功气攻'][pid]
    end
    -- 连击气攻计算
    if WAR.ACT > 1 then
        local LJ_fac = 0.7 -- 通常为70%
        if match_ID(pid, 9763) or wugong == 49 or wugong == 62 or WAR.YNXJ == 1 or match_ID(pid, 5) or WAR.ZYHB > 0 then
            LJ_fac = 1
        end
        ang = math.modf(ang * LJ_fac)
    end

    -- 全真七子，天罡北斗阵，增加伤害和气攻
    if (pid >= 123 and pid <= 128) or pid == 68 then
        ang = ang + 1200
    end

    -- 武当七侠，真武七截阵，增加伤害和气攻
    if (pid >= 532 and pid <= 538) then
        ang = ang + 1200
    end
    -- 范一飞
    if match_ID(pid, 452) or match_ID(pid, 454) then
        if JY.Wugong[wugong]['武功类型'] == 5 then
            ang = ang + 500
        end
    end
    -- 范一飞
    if match_ID(pid, 453) then
        if JY.Wugong[wugong]['武功类型'] == 4 then
            ang = ang + 500
        end
    end
    -- 天龙门弟子
    if wugong == 28 then
        if match_ID(pid, 727) or match_ID(pid, 728) or match_ID(pid, 729) or match_ID(pid, 730) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 1 then
        -- 少林弟子
        if match_ID(pid, 400) or match_ID(pid, 401) or match_ID(pid, 402) or match_ID(pid, 403) or match_ID(pid, 404) or
            match_ID(pid, 405) or match_ID(pid, 406) or match_ID(pid, 407) or match_ID(pid, 408) or match_ID(pid, 409) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 2 then
        -- 武当弟子
        if match_ID(pid, 320) or match_ID(pid, 321) or match_ID(pid, 322) or match_ID(pid, 323) or match_ID(pid, 324) or
            match_ID(pid, 325) or match_ID(pid, 326) or match_ID(pid, 327) or match_ID(pid, 328) or match_ID(pid, 329) or
            match_ID(pid, 503) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 5 then
        -- 明教五行旗使
        if match_ID(pid, 301) or match_ID(pid, 302) or match_ID(pid, 303) or match_ID(pid, 304) or match_ID(pid, 305) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 7 then
        -- 全真弟子
        if match_ID(pid, 291) or match_ID(pid, 292) or match_ID(pid, 293) or match_ID(pid, 294) or match_ID(pid, 295) or
            match_ID(pid, 296) or match_ID(pid, 297) or match_ID(pid, 298) or match_ID(pid, 299) or match_ID(pid, 300) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 9 then
        -- 华山弟子
        if match_ID(pid, 360) or match_ID(pid, 361) or match_ID(pid, 362) or match_ID(pid, 363) or match_ID(pid, 364) or
            match_ID(pid, 365) or match_ID(pid, 366) or match_ID(pid, 367) or match_ID(pid, 368) or match_ID(pid, 369) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 10 then
        -- 嵩山弟子
        if match_ID(pid, 191) or match_ID(pid, 192) or match_ID(pid, 193) or match_ID(pid, 194) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 11 then
        -- 青城弟子
        if match_ID(pid, 370) or match_ID(pid, 371) or match_ID(pid, 372) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 12 then
        -- 衡山弟子
        if match_ID(pid, 370) or match_ID(pid, 371) or match_ID(pid, 372) or match_ID(pid, 373) or match_ID(pid, 374) or
            match_ID(pid, 375) then
            ang = ang + 500
        end
    end
    -- 铁掌帮众
    if wugong == 13 then
        if match_ID(pid, 281) or match_ID(pid, 282) or match_ID(pid, 283) or match_ID(pid, 284) or match_ID(pid, 285) or
            match_ID(pid, 286) or match_ID(pid, 287) or match_ID(pid, 288) or match_ID(pid, 289) or match_ID(pid, 290) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 13 then
        -- 恒山弟子
        if match_ID(pid, 382) or match_ID(pid, 383) or match_ID(pid, 384) or match_ID(pid, 385) or match_ID(pid, 386) or
            match_ID(pid, 387) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 14 then
        -- 泰山弟子
        if match_ID(pid, 202) or match_ID(pid, 203) or match_ID(pid, 204) or match_ID(pid, 205) or match_ID(pid, 206) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 15 then
        -- 五毒弟子
        if match_ID(pid, 221) or match_ID(pid, 222) or match_ID(pid, 223) or match_ID(pid, 224) or match_ID(pid, 225) or
            match_ID(pid, 226) or match_ID(pid, 227) or match_ID(pid, 228) or match_ID(pid, 229) or match_ID(pid, 230) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 18 then
        -- 雪山弟子
        if match_ID(pid, 243) or match_ID(pid, 241) or match_ID(pid, 242) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 19 then
        -- 峨眉弟子
        if match_ID(pid, 330) or match_ID(pid, 331) or match_ID(pid, 333) or match_ID(pid, 334) or match_ID(pid, 335) or
            match_ID(pid, 336) or match_ID(pid, 337) or match_ID(pid, 332) or match_ID(pid, 338) or match_ID(pid, 339) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 20 then
        -- 崆峒弟子
        if match_ID(pid, 350) or match_ID(pid, 351) or match_ID(pid, 352) or match_ID(pid, 353) or match_ID(pid, 354) or
            match_ID(pid, 355) or match_ID(pid, 356) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 28 then
        -- 星宿弟子
        if match_ID(pid, 261) or match_ID(pid, 262) or match_ID(pid, 263) or match_ID(pid, 264) or match_ID(pid, 265) or
            match_ID(pid, 266) or match_ID(pid, 267) or match_ID(pid, 268) or match_ID(pid, 269) or match_ID(pid, 270) then
            ang = ang + 500
        end
    end
    if JY.Wugong[wugong]["门派"] == 29 then
        -- 密宗弟子
        if match_ID(pid, 251) or match_ID(pid, 252) or match_ID(pid, 253) or match_ID(pid, 254) or match_ID(pid, 255) or
            match_ID(pid, 256) or match_ID(pid, 257) or match_ID(pid, 258) or match_ID(pid, 259) or match_ID(pid, 260) then
            ang = ang + 500
        end
    end

    -- 林朝英增加总气攻
    if match_ID(pid, 605) then
        ang = ang * 1.1
    end

    -- 斗转武功计算威力
    if WAR.DZXY == 1 then
        true_WL = WAR.PD["斗转武功气攻"][pid]
        lib.Debug('斗转武功威力' .. true_WL)
    end
    -- 八臂神剑
    if match_ID(pid, 643) and WGLX == 3 and JLSD(0, 50, pid) then
        true_WL = true_WL * 1.3
    end
    if WAR.DZXYLV[pid] == 200 then
        local yxsy = JY.Person[pid]['优先使用']
        for i = 1, JY.Base['武功数量'] do
            if JY.Person[pid]['武功' .. i] == yxsy then
                local level = math.modf(JY.Person[pid]["武功等级" .. i] / 100) + 1;
                if level > 10 then
                    level = 11
                end
                true_WL = get_skill_power(pid, yxsy, level)
                ang = true_WL
                lib.Debug("反击武功" .. JY.Wugong[yxsy]['名称'] .. "。 反击武功气攻" .. true_WL)
                break
            end
        end
    end

    -- 12虚弱
    if WAR.PD["虚弱状态"][pid] ~= nil then
        local yxsy = JY.Person[pid]["优先使用"]
        local xr = 0.5
        if yxsy > 0 then
            for i = 1, JY.Base["武功数量"] do
                local yxsy = JY.Person[pid]["优先使用"]
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if JY.Person[pid]["武功招式" .. zs] == 1 and wugong == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] == 124 then
                            xr = 0.5
                        elseif JY.Wugong[yxsy]["招式" .. j] == 123 then
                            xr = 0.4
                        elseif JY.Wugong[yxsy]["招式" .. j] == 122 then
                            xr = 0.3
                        elseif JY.Wugong[yxsy]["招式" .. j] == 121 then
                            xr = 0.2
                        end
                    end
                end
            end
        end
        ang = math.modf(ang * xr)
    end

    -- 集中状态，伤害和杀气都减半
    if WAR.PD["集中状态"][pid] ~= nil then
        ang = math.modf(ang * 0.5)
    end

    -- 罗汉伏魔提升伤害和杀气效果为：[(当前内力值/500)×(武功消耗内力/140)]%
    -- 内轻特效930
    if NeiGong_tx(pid, 930) or ((Curr_NG(pid, 108) or match_ID(pid, 38) or match_ID(pid, 9894)) and PersonKF(pid, 96)) then
        local wgmod = JY.Wugong[wugong]["消耗内力点数"] /100
        local nlmod = JY.Person[pid]['内力']/20
        local zng = 0
        zng = nlmod * wgmod;
        -- 石破天效果提高1.1倍
        if match_ID(pid, 38) or match_ID(pid, 9894) or Curr_NG(pid, 108) then
            zng = zng * 1.1;
        end
        ang = ang + zng
        lib.Debug('内轻特效930'..'增加气攻'..zng)
    end

    -- 黄蓉奇门遁甲，蓝色增加杀气
    if WAR.Person[WAR.CurID]["我方"] == true and
        GetWarMap(WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"], 6) == 3 then
        ang = ang + 400
    end
    -- 内轻特效308 增加气攻点数
    if NeiGong_tx(pid, 308) then
        local zng = dkfcj_ng * 250
        ang = ang + zng
        lib.Debug('内轻特效308'..'增加气攻'..zng)
    end
    -- 内轻特效933 攻击时随自身怒气值增加气攻
    if NeiGong_tx(pid, 933) then
        local num = (WAR.LQZ[pid] or 0) * dkfcj_ng*5
        ang = ang + num
        lib.Debug('内轻特效933'..'增加气攻'..num)
    end
    -- 内轻特效309 增加气攻百分比
    if NeiGong_tx(pid, 309) then
        local zng = ang*dkfcj_ng * 25 / 100
        ang = ang  + zng
        lib.Debug('内轻特效309'..'增加气攻'..zng)
    end
    ----------------------基础伤害计算-------------------------------------
    -- lib.Debug(JY.Person[pid]['姓名']..'气攻'..ang)
    w = {
        g = Atk(WAR.CurID),
        f = Def(WAR.CurID),
        q = Qg(WAR.CurID),
        wl = true_WL
    }
    atk = w.g -- *wwc/dwc--*wsc--*wgc	
    if WAR.PD['虚弱状态'][pid] ~= nil then
        atk = atk * 0.75
    end
    -- 谪仙之体
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] and WAR.Person[i]['人物编号'] == 636 then
            if atk > Def(i) then
                atk = Def(i)
            end
            if Def(i) > atk then
                atk = Def(i)
            end
        end
    end
    -- 谪仙之体
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]['我方'] ~= WAR.Person[i]['我方'] and WAR.Person[WAR.CurID]['人物编号'] == 636 then
            if Def(i) > atk then
                atk = Def(i)
            end
        end
    end
    -- 御剑术 五岳剑诀
    if JY.Person[pid]['奇穴' .. 15] == 1 and Curr_NG(pid, 175) then
        local zs = JY.Person[pid]['御剑能力'] / 2
        atk = atk + zs
    end
    local kfb = 1 + w.wl / 2000
    hurt = (atk * kfb)
    lib.Debug(JY.Person[pid]["姓名"] .. '=' .. math.modf(atk))
    lib.Debug(JY.Person[pid]["姓名"] .. '计算武功' .. JY.Wugong[wugong]['名称'] .. '增加' .. kfb ..'倍攻击力，计算伤害攻击力=' .. math.modf(hurt))
    lib.Debug(JY.Person[pid]['姓名']..'伤害计算Act计算武功威力结算'..true_WL)
    lib.Debug(JY.Person[pid]['姓名']..'伤害计算Act计算气攻结算'..ang)
    return hurt, ang
end

--防御方伤害计算
Ct['伤害计算Def'] = function(enemyid, wugong, level, ang, hurt, flag)
    -------------------------函数初始----------------------------------
    local pid = WAR.Person[WAR.CurID]["人物编号"]
    local eid = WAR.Person[enemyid]["人物编号"]
    local ekf_ng = JY.Person[eid]['主运内功']
    local dkf_ng = JY.Person[pid]['主运内功']
    local ekfcj_ng = JY.Wugong[ekf_ng]['层级']
    local dkfcj_ng = JY.Wugong[dkf_ng]['层级']
    local ekf_qg = JY.Person[eid]['主运轻功']
    local dkf_qg = JY.Person[pid]['主运轻功']
    local ekfcj_qg = JY.Wugong[ekf_qg]['层级']
    local dkfcj_qg = JY.Wugong[dkf_qg]['层级']
    local dng = 0
    local true_WL = get_skill_power(pid, wugong, level)
    local hurt2 = 0
    local hurt3 = 0
    local dxs = 0
    local wxc = 0
    local wxs = 0
    local def = Def(enemyid)
    local wgtype = JY.Wugong[wugong]["武功类型"];
    lib.Debug(JY.Person[eid]['姓名']..'受到的气攻是'..ang)
    -- 无酒不欢：记录人物血量
    WAR.Person[enemyid]["Life_Before_Hit"] = JY.Person[eid]["生命"]
    WAR.Person[enemyid]["Neili_Before_Hit"] = JY.Person[eid]["内力"]
    WAR.Person[enemyid]["HD_Before_Hit"] = WAR.PD['护盾值'][eid] or 0

    -- 毒抗
    local kd = zdkx(enemyid, JY.Person[eid]['中毒程度']) + JY.Person[eid]["内力"] / 50
    if WAR.PD['六阳正气'][eid] ~= nil then
        kd = kd + WAR.PD['六阳正气'][eid]
    end

    -- 毒抗
    local kdw = zdkx(enemyid, JY.Person[eid]['中毒程度']) + JY.Person[eid]["内力"] / 50
    if WAR.PD['六阳正气'][eid] ~= nil then
        kdw = kdw + WAR.PD['六阳正气'][eid]
    end

    -- 500满毒抗可以降低100%的毒
    local atkd = limitX(1 - kdw / 500, 0, 1)
    local zshurt = 0
    -- 气防
    local dng = 0
    -- 内伤
    local nssz = 0
    -- 冰封
    local bfsz = 0
    -- 灼烧
    local zssz = 0
    -- 中毒
    local zdsz = 0
    -- 封穴
    local fxsz = 0
    -- 流血
    local lxsz = 0

    -- 内伤
    local nssz1 = 0
    -- 冰封
    local bfsz1 = 0
    -- 灼烧
    local zssz1 = 0
    -- 中毒
    local zdsz1 = 0
    -- 封穴
    local fxsz1 = 0
    -- 流血
    local lxsz1 = 0
    -- local 
    local WGLX = JY.Wugong[wugong]["武功类型"]

    local wwc = 0

    local dwc = 0

    local wnc = 0

    local dnc = 0
  -------------------------挨打特效触发写这里-------------------------
    if hurt > 0 then 
        -- 以眼还眼 天赋9782
        if match_ID(eid, 9782) and hurt > 0 then
            if WAR.ACT > 1 then
                WAR.PD["以眼还眼1"][eid] = 1
            end
            if WAR.BJ == 1 then
                WAR.PD["以眼还眼2"][eid] = 1
            end

            if WAR.ACT > 1 or WAR.BJ == 1 then
                WAR.Person[enemyid]["特效动画"] = 126
                Set_Eff_Text(enemyid, "特效文字2", "以眼还眼")
            end
            
        end
        -- 文泰来 否极泰来 
        if match_ID(eid, 9847) and WAR.PD["否极泰来"][eid] == 0 and hurt > JY.Person[eid]["生命"] then
            WAR.WTL_PJTL[eid] = 10
        end
        -- 逆水寒
        if match_ID(eid, 9933) and hurt >= JY.Person[eid]["生命"] and WAR.PD["逆水寒CD"][eid] == nil then
            WAR.PD["逆水寒"][eid] = 1
            -- if WAR.Person[enemyid]['护盾'] == nil then 
            Cat('护盾停止', enemyid)
            WAR.Person[enemyid]['护盾'] = 13
            -- end				
        end   
        --百劫
        if WAR.PD['百劫'][eid] ~= nil then 
            WAR.PD['虚弱状态'][pid] = (WAR.PD['虚弱状态'][pid] or 0) + 1
            if WAR.PD['虚弱状态'][pid] > 4 then 
                WAR.PD['虚弱状态'][pid] = 4
            end
            if WAR.PD['盲目状态'][pid] ~= nil then 
                WAR.PD['盲目状态'][pid] = WAR.PD['盲目状态'][pid] + 1
            end
        end
        --内轻特效1006
        if NeiGong_tx(eid,1006) and JLSD(0,ekfcj_ng*15,eid) then 
            WAR.PD['菩提树'][pid] = (WAR.PD['菩提树'][pid] or 0 ) + 1
            Set_Eff_Text(enemyid, 1, '菩提树')
        end
        -- 天人合一
        if JY.Person[eid]['奇穴' .. 129] == 1 then
            if Curr_NG(eid, 104) or Curr_NG(eid, 221) then
                if WAR.PD['天人合一'][eid] == nil then
                    WAR.PD['天人合一'][eid] = 0
                end
                WAR.PD['天人合一'][eid] = WAR.PD['天人合一'][eid] + 1
                if WAR.PD['天人合一'][eid] > 49 then
                    WAR.PD['天人合一'][eid] = 49
                end
                Set_Eff_Text(enemyid, 1, '天人合一')
            end
        end
        -- 内轻特效822
        if NeiGong_tx(eid, 822) then
            local JL = ekfcj_ng*5
            local rn = math.random(4)
            if JLSD(0,JL,eid) then            
                WAR.PD['天机秘术'][eid] = rn
            end
        end
        --内轻特效826
        if NeiGong_tx(eid,826) then 
            WAR.PD['格挡点数'][eid] = (WAR.PD['格挡点数'][eid] or 0) + ekfcj_ng*50
        end    
        -- 内轻特效825
        if NeiGong_tx(eid, 825) then
            local gl = ekfcj_ng * 10
            if JLSD(0, gl, eid) then
                WAR.PD['易容'][eid] = 1
            end
        end
        -- 内轻特效402
        if NeiGong_tx(eid, 402) and WAR.ACT == 1 and JLSD(0, ekfcj_ng * 10, eid) then
            WAR.ACT = 10
            Set_Eff_Text(enemyid, 1, '上善若水')
        end

        -- 神罗天征
        if Pmiji(eid, 7) and WAR.PD['神罗CD'][eid] == nil and MyFj(WAR.CurID) == false then
            WAR.PD['神罗天征'][eid] = 20
        end
        -- 内轻特效813
        if NeiGong_tx(eid, 813) and JLSD(0, ekfcj_ng * 6, eid) then
            WAR.PD['长生诀'][eid] = ekfcj_ng * 2
            Set_Eff_Text(enemyid, "特效文字3", "大宗师")
        end
        -- 亦复如是
        if (match_ID(eid, 9940) and Boss(enemyid)) then
            WAR.PD['亦复如是'][eid] = 1
            Set_Eff_Text(enemyid, "特效文字0", "亦复如是")
        end
        -- 凌波闪避增加
        if NeiGong_tx(eid,823) then
            WAR.PD['凌波微步闪避'][eid] = WAR.PD['凌波微步闪避'][eid] or 0 + ekfcj_ng*25
        end
    end

  -------------------------追加真实伤害写这里--------------------------
    lib.Debug('追加真实伤害:')
    -- 内轻特效312
    if NeiGong_tx(pid, 312) then
        local zs = (JY.Person[eid]['冰封程度'] * dkfcj_ng * 50)/100
        zshurt = zshurt + zs
        lib.Debug('内轻特效312' ..'追加真实伤害'.. zs)
    end
    -- 内轻特效313
    if NeiGong_tx(pid, 313) then
        local zs = (JY.Person[eid]['灼烧程度'] * dkfcj_ng * 50)/100
        zshurt = zshurt + zs
        lib.Debug('内轻特效313' ..'追加真实伤害'.. zs)
    end
    -- 内轻特效314
    if NeiGong_tx(pid, 314) then
        local zs = ((WAR.LXZT[eid] or 0)  * dkfcj_ng * 50)/100
        zshurt = zshurt + zs
        lib.Debug('内轻特效314' ..'追加真实伤害'.. zs)
    end
    -- 内轻特效315
    if NeiGong_tx(pid, 315) then
        local zs = (JY.Person[eid]['中毒程度'] * dkfcj_ng * 50)/100
        zshurt = zshurt + zs
        lib.Debug('内轻特效315' ..'追加真实伤害'.. zs)
    end
    -- 内轻特效316
    if NeiGong_tx(pid, 316) then
        local zs = ((WAR.PD['内伤状态'][eid] or 0)  * dkfcj_ng * 50)/100
        zshurt = zshurt + zs
        lib.Debug('内轻特效316' ..'追加真实伤害'.. zs)
    end
    -- 内轻特效311
    if NeiGong_tx(pid, 311) then
        local zn = (JY.Person[eid]['冰封程度'] + JY.Person[eid]['灼烧程度'] + (WAR.LXZT[eid] or 0) +  JY.Person[eid]['中毒程度'] + (WAR.PD['内伤状态'][eid] or 0)) * dkfcj_ng * 30/100
        zshurt = zshurt + zn
        lib.Debug('内轻特效311'..'追加真实伤害'.. zn)
    end
    -- 剑气
    if JY.Person[pid]['奇穴' .. 12] == 1 then
        zshurt = zshurt + JY.Person[pid]['御剑能力']
        lib.Debug('剑气奇穴追加伤害' .. JY.Person[pid]['御剑能力'])
    end

    -- 浩然罡气 附加气攻/10的伤害
    if WAR.PD["浩然罡气"][pid] == 1 then
        if WAR.LQZ[pid] == 100 then
            zshurt = zshurt + ang / 10
            lib.Debug('浩然罡气' .. '' .. '追加伤害' .. ang / 10)
        else
            zshurt = zshurt + ang / 15
            lib.Debug('浩然罡气' .. '' .. '追加伤害' .. ang / 15)
        end
    end
    -- 伍六七
    if WAR.PD["以气运剪"][pid] == 1 then
        if WAR.LQZ[pid] == 100 then
            zshurt = zshurt + ang / 5
        else
            zshurt = zshurt + ang / 10
        end
        lib.Debug('以气运剪' .. '' .. '追加伤害' .. ang / 10)
    end

    -- 毒王的中毒补偿每5点中毒程度增伤1%
    if pid == 0 and JY.Base["标准"] == 9 then
        zshurt = zshurt + JY.Person[pid]["中毒程度"] / 2
        lib.Debug('毒王的中毒补偿' .. '' .. '追加伤害' .. JY.Person[pid]["中毒程度"] / 2)
    end
    -- 井月八法
    if PersonKF(pid, 181) then
        local dfjc = 0
        for i = 1, JY.Base["武功数量"] do

            if JY.Wugong[JY.Person[pid]['武功' .. i]]['武功类型'] == 4 and JY.Person[pid]['武功等级' .. i] ==  999 then
                dfjc = dfjc + 1
            end
            if dfjc >= 8 then
                zshurt = zshurt + dfjc * 10
                break
            end
        end
        lib.Debug('井月八法' .. '' .. '追加伤害' .. dfjc * 10)
    end
    if JY.Person[pid]["坐骑"] == 312 then
        zshurt = 9999
        lib.Debug('神秘护符' .. '' .. '追加伤害' .. zshurt)
    end
    -- 蓝烟清：燃木刀法，普通内功加力额外增加伤害
    if wugong == 65 and WAR.NGJL > 0 then
        local zs = math.modf(JY.Wugong[WAR.NGJL]["攻击力10"] / 12)
        zshurt = zshurt + math.modf(JY.Wugong[WAR.NGJL]["攻击力10"] / 12);
        lib.Debug('蓝烟清：燃木刀法，普通内功加力额外增加伤害' .. '' .. '追加伤害' .. zs)
    end

    -- 欧阳锋根据蛤蟆蓄力增加伤害
    if match_ID(pid, 60) and WAR.OYFXL > 0 then
        local zs = WAR.OYFXL / 2
        zshurt = zshurt + zs
        lib.Debug('欧阳锋根据蛤蟆蓄力增加伤害' .. '' .. '追加伤害' .. zs)
    end

    -- 梁萧蓄力增加伤害
    if match_ID(pid, 635) and WAR.LXXL > 0 then
        local zs = WAR.LXXL / 2
        zshurt = zshurt + zs
        lib.Debug('梁萧蓄力增加伤害' .. '' .. '追加伤害' .. zs)
    end

    -- 仁义无双增加伤害
    if (match_ID(pid, 94) or match_ID(pid, 9898)) and JY.Wugong[wugong]["武功类型"] == 4 then
        local zs = WAR.LXXL / 2
        zshurt = zshurt + zs
        lib.Debug('仁义无双增加伤害' .. '' .. '追加伤害' .. zs)
    end

    -- 棋势伤害
    if match_ID(pid, 586) and JY.Base["天书数量"] > 0 then
        local YQ = 0
        YQ = YQ + JY.Base["天书数量"] * 10
        zshurt = zshurt + YQ
        lib.Debug('棋势伤害' .. '' .. '追加伤害' .. YQ)
    end

    if WAR.LHQ_BNZ == 1 then -- 般若掌 伤害+50
        zshurt = zshurt + 50
        lib.Debug('般若掌' .. '' .. '追加伤害' .. '50')
    end

    if WAR.JGZ_DMZ == 1 then -- 达摩掌 伤害+100
        zshurt = zshurt + 100
        lib.Debug('达摩掌' .. '' .. '追加伤害' .. '100')
    end

    if WAR.WD_CLSZ == 1 then -- 赤练神掌 伤害+70
        zshurt = zshurt + 70
        lib.Debug('赤练神掌' .. '' .. '追加伤害' .. '70')
    end

    if WAR.PD['黯然・穷途末路'][pid] == 1 then
        local s1 = 1 + JY.Person[pid]["生命最大值"] - JY.Person[pid]["生命"]
        local s = math.modf(s1 * 0.2)
        zshurt = zshurt + s
        WAR.PD['黯然・穷途末路'][pid] = nil
        lib.Debug('黯然・穷途末路' .. '' .. '追加伤害' .. s)
    end

    -- 芙蓉金针
    if match_ID(pid, 9906) then
        local fr = JY.Person[pid]["暗器技巧"]
        zshurt = zshurt + fr
        lib.Debug('芙蓉金针' .. '' .. '追加伤害' .. fr)
    end
    if match_ID(pid, 9913) and WAR.PD['婆罗双树枯'][pid] ~= nil then
        zshurt = zshurt + WAR.PD['婆罗双树枯'][pid]
        lib.Debug('婆罗双树枯' .. '' .. '追加伤害' .. WAR.PD['婆罗双树枯'][pid])
        WAR.PD['婆罗双树枯'][pid] = nil

    end

    -- 神足经 标记修改
    if Curr_NG(pid, 233) and JY.Person[pid]["武器"] == -1 then
        local ZS = math.modf(TrueQZ(pid) / 2)
        zshurt = zshurt + ZS
        lib.Debug('神足经' .. '' .. '追加伤害' .. ZS)
    end

    -- 穿山虎铁臂神拳
    if Pmiji(pid, 11) then
        if WAR.PD['穿山虎铁臂神拳'][pid] == 1 then
            zshurt = zshurt + 100
            lib.Debug('穿山虎铁臂神拳' .. '' .. '追加伤害' .. '100')
        end
        WAR.PD['穿山虎铁臂神拳'][pid] = nil
    end

    -- 梅剑和，使用剑法攻击追加100点伤害，如装备武器，则此加成减半
    if match_ID(pid, 9812) and JY.Wugong[wugong]["武功类型"] == 3 then
        if JY.Person[pid]["武器"] == -1 then
            zshurt = zshurt + 100
        else
            zshurt = zshurt + 50
        end
        lib.Debug('梅剑和，使用剑法攻击追加100点伤害，如装备武器，则此加成减半' .. '' ..'追加伤害' .. '100')
    end

    -- 唐文亮，七伤拳追加777点伤害
    if WAR.YZQS == 1 then
        zshurt = zshurt + 277
        lib.Debug('唐文亮，七伤拳追加777点伤害' .. '' .. '追加伤害' .. '277')
    end

    -- 释迦掷象功
    if wugong == 357 and Curr_NG(pid, 169) then
        zshurt = zshurt + JY.Person[pid]["体质"] * 50
        lib.Debug('释迦掷象功' .. '' .. '追加伤害' .. JY.Person[pid]["体质"] * 50)
    end

    -- 三渡金刚伏魔圈
    if match_ID(pid, 9738) then
        local JLQX = 0
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
                JLQX = JLQX + 1
            end
        end
        if JLQX > 0 then
            zshurt = zshurt + JLQX * 200
        end
        lib.Debug('三渡金刚伏魔圈' .. '' .. '追加伤害' .. JLQX * 200)
    end

    -- 九阴飞絮
    if WAR.JYZJ_FXJ == 1 then
        zshurt = zshurt + 100
        if Curr_NG(pid, 107) then
            zshurt = zshurt + 100
        end
        lib.Debug('九阴飞絮' .. '' .. '追加伤害' .. '100')
    end

    -- 青莲剑歌
    if WAR.QLJG == 1 then
        local h = JY.Person[pid]['御剑能力']
        zshurt = zshurt + h
        lib.Debug('青莲剑歌' .. '' .. '追加伤害' .. h)
    end

    -- 玉堂飞燕
    if match_ID(pid, 9943) and wugong == 62 then
        zshurt = zshurt + math.modf(JY.Person[pid]["轻功"] / 3)
        lib.Debug('玉堂飞燕' .. '' .. '追加伤害' .. math.modf(JY.Person[pid]["轻功"] / 3))
    end

    -- 开太极
    if WAR.WDKTJ == 1 then
        local ktj = (WAR.PD["蓄气值"][pid] or 0) + (WAR.PD["太极之形"][pid] or 0) * 100
        zshurt = zshurt + ktj
        WAR.PD['封'][eid] = 20
        WAR.PD['撕裂'][eid] = 20
        lib.Debug('开太极' .. '' .. '追加伤害' .. ktj)
    end

    -- 火之高兴 标记修改
    if WAR.HZGX == 1 then
        local h = TrueSD(pid)
        zshurt = zshurt + h
        lib.Debug('火之高兴' .. '' .. '追加伤害' .. h)
    end

    -- 世尊降魔
    if WAR.SZXM == 1 then
        WAR.WS = 1
        --local hh1 = math.modf(ang / 15)
        --local hh2 = math.modf(ang / 20)
        local hh1 = math.modf(ang / 15)
        local hh2 = math.modf(ang / 20)
        if hurt < 200 then
            zshurt = zshurt + 200
        end
        if WAR.LQZ[pid] == 100 then
            zshurt = zshurt + math.modf(ang / 15)
        else
            zshurt = zshurt + math.modf(ang / 20)
        end
        lib.Debug('世尊降魔' .. '' .. '追加伤害' .. math.modf(ang / 20))
    end

    -- 剑二十三
    if WAR.SL23 == 1 then
        if hurt < 200 then
            zshurt = zshurt + 200
        end
        lib.Debug('剑二十三' .. '' .. '追加伤害' .. '200')
    end

    -- 天剑伤害 
    if match_ID(pid, 652) and WAR.PD["天剑"][pid] ~= nil then
        zshurt = zshurt + 1200
        lib.Debug('天剑伤害' .. '' .. '追加伤害' .. '200')
    end

    if WAR.PD['降龙・见龙在田'][pid] == 1 then
        -- zshurt = zshurt + 200
    end

    if WAR.PD['龙爪手'][pid] == 1 then
        zshurt = zshurt + 100
        lib.Debug('龙爪手' .. '' .. '追加伤害' .. '100')
    end

    -- 大伏魔拳
    if WAR.DFMQ == 1 then
        zshurt = zshurt + math.modf(JY.Person[eid]["生命最大值"] * 0.05)
        lib.Debug('大伏魔拳' .. '' .. '追加伤害' .. math.modf(JY.Person[eid]["生命最大值"] * 0.05))
    end


    -- 解牛刀法
    if wugong == 193 then
        if JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"] < 0.5 and JLSD(10, 60, pid) then
            zshurt = zshurt + math.modf(JY.Person[eid]["生命最大值"] * 0.05)
        end
        WAR.Person[enemyid]["特效动画"] = 116
        Set_Eff_Text(enemyid, "特效文字3", "良疱岁更刀")
        lib.Debug('解牛刀法' .. '' .. '追加伤害' .. math.modf(JY.Person[eid]["生命最大值"] * 0.05))
    end

    -- 须弥山神掌
    if wugong == 24 then
        local jl = 50
        local pd = false
        if JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"] >= 0.5 and JLSD(10, jl / 2, pid) then
            pd = true
        elseif JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"] < 0.5 and JLSD(10, jl, pid) then
            pd = true
        elseif Curr_NG(pid, 104) then
            pd = true
        end
        if pd == true then
            local jl1 = (1 - JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"]) * 30
            if JY.Person[pid]['奇穴' .. 36] == 1 then
                jl1 = jl1 + 10
            end
            if JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"] * 0.5 and math.random(100) <= jl1 then
                hurt = hurt + JY.Person[eid]["生命"]
                lib.Debug('须弥山神掌' .. '' .. '追加伤害' .. JY.Person[eid]["生命"])

            end
            if math.random(100) <= jl1 then
                WAR.PD["如来神掌"][pid] = 2
            else
                WAR.PD["如来神掌"][pid] = 1
                zshurt = zshurt + math.modf(JY.Person[eid]["生命最大值"] * 0.08)
                lib.Debug('须弥山神掌' .. '' .. '追加伤害' ..
                              math.modf(JY.Person[eid]["生命最大值"] * 0.08))
            end
        end

        -- Set_Eff_Text(enemyid, "特效文字3", "如来神掌")
    end

    -- 万佛朝宗
    if WAR.PD["万佛朝宗"][pid] ~= nil and WAR.PD["万佛朝宗"][pid] == 1 then
        local a1 = JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"]
        local nl = JY.Person[eid]["内力"] / 20

        zshurt = zshurt + math.modf(JY.Person[eid]["生命"] * 0.2)
        lib.Debug('万佛朝宗' .. '' .. '追加伤害' .. math.modf(JY.Person[eid]["生命"] * 0.2))
        AddPersonAttrib(eid, "内力", -nl)
        if a1 < 0.333 and JLSD(0, (1 - a1) * 20, pid) then
            zshurt = zshurt + JY.Person[eid]["生命"]
            lib.Debug('万佛朝宗' .. '' .. '追加伤害' .. JY.Person[eid]["生命"])
        end

    end
    -- 商宝震 八卦刀 标记修改
    if match_ID(pid, 9922) and wugong == 231 and WAR.BGZ == 1 then
        zshurt = zshurt + 300
        WAR.BGZ = 0
        Set_Eff_Text(id, "特效文字0", "八卦刀法秘传・席卷八荒式");
        lib.Debug('八卦刀' .. '' .. '追加伤害' .. '300')
    end

    -- 盅毒降
    if JY.Person[pid]['奇穴' .. 25] == 1 then
        hurt = hurt + JY.Person[eid]["中毒程度"]
        lib.Debug('盅毒降' .. '' .. '追加伤害' .. JY.Person[eid]["中毒程度"])
    end
    -- 丁春秋 根据敌方中毒追加伤害 
    if match_ID(pid, 46) and JY.Person[eid]["中毒程度"] > 0 then
        zshurt = zshurt + JY.Person[eid]["中毒程度"]
        lib.Debug('根据敌方中毒追加伤害' .. '' .. '追加伤害' .. JY.Person[eid]["中毒程度"])
    end

    -- 五毒心经 根据敌方中毒追加伤害 标记修改
    --内轻特效1037
    if NeiGong_tx(pid,1037) and JY.Person[eid]["中毒程度"] > 0 then
        local zs = JY.Person[eid]["中毒程度"]
        if JY.Person[eid]["中毒程度"] >= 100 then 
            zs = JY.Person[eid]["中毒程度"]*(dkfcj_ng+1)
            JY.Person[eid]["中毒程度"] = 0
        end
        zshurt = zshurt + zs
        lib.Debug('五毒心经根据敌方中毒追加伤害' .. '' .. '追加伤害' .. zs)
    end

    -- 玄澄无量禅震追加内伤伤害
    -- 陈正德鹰爪功追加内伤伤害
    if WAR.XC_WLCZ == 1 or WAR.YZG == 1 then
        -- zshurt = zshurt + JY.Person[eid]["受伤程度"]*2
        zshurt = zshurt + (WAR.PD['内伤状态'][eid] or 0) * 2
        lib.Debug('玄澄无量禅震追加内伤伤害/陈正德鹰爪功追加内伤伤害' .. '' .. '追加伤害' .. (WAR.PD['内伤状态'][eid] or 0) * 2)
    end

    -- 凝血神爪
    if wugong == 134 and WAR.LXZT[eid] ~= nil then
        zshurt = zshurt + WAR.LXZT[eid]
        lib.Debug('凝血神爪' .. '' .. '追加伤害' .. WAR.LXZT[eid])
    end
    -- 隔空点穴
    if match_ID(pid, 9743) then
        local fx = WAR.FXDS[eid] or 0
        local lx = WAR.LXZT[eid] or 0
        local n = fx * 2 + lx * 2 + 100
        zshurt = zshurt + n
        lib.Debug('隔空点穴' .. '' .. '追加伤害' .. n)
    end

    -- 白绣
    if match_ID(pid, 582) then
        local bxbf = JY.Person[eid]["冰封程度"]
        zshurt = zshurt + bxbf * 2
        lib.Debug('白绣冰封程度' .. '' .. '追加伤害' .. bxbf * 2)
    end

    -- 白万剑
    if match_ID(pid, 43) or match_ID(pid, 9823) then
        local bxbf = JY.Person[eid]["冰封程度"]
        zshurt = zshurt + bxbf
        lib.Debug('白万剑' .. '' .. '追加伤害' .. bxbf)
    end

    -- 鹿杖客
    if match_ID(eid, 9726) and JY.Person[pid]["性别"] > 0 then
        zshurt = zshurt + 666
        WAR.Person[enemyid]["特效动画"] = 96
        Set_Eff_Text(enemyid, "特效文字0", "峰吹起了从前")
        lib.Debug('鹿杖客' .. '' .. '追加伤害' .. '666')
    end
    -- 太极蓄力追加伤害
    if WAR.PD['蓄气值'][pid] ~= nil then
        zshurt = zshurt + WAR.PD['蓄气值'][pid]
    end
    -- 招式增伤
    for i = 1, JY.Base["武功数量"] do
        local yxsy = JY.Person[pid]["优先使用"]
        if yxsy > 0 then
            for j = 1, #CC.KFMove[yxsy] do
                local zs = CC.WUGONGZS[i][j]
                local wugong = JY.Person[pid]["武功" .. i]
                if wugong == yxsy and WAR.WGZS == j then
                    if JY.Wugong[yxsy]["招式" .. j] >= 151 and JY.Wugong[yxsy]["招式" .. j] <= 154 then
                        if JY.Wugong[yxsy]["招式" .. j] == 151 then
                            zshurt = zshurt + 50
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 152 then
                            zshurt = zshurt + 100
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 153 then
                            zshurt = zshurt + 150
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 154 then
                            zshurt = zshurt + 200
                        end
                    end
                end
            end
        end
    end
    lib.Debug('招式增伤' .. '' .. '追加伤害' .. JY.Wugong[JY.Person[pid]["优先使用"]]["层级"] * 50)
    -- 归辛树
    if match_ID(pid, 186) and wgtype == 1 then
        if JY.Person[pid]["武器"] == -1 then
            zshurt = zshurt + 200
        else
            zshurt = zshurt + 100
        end
        lib.Debug('归辛树' .. '' .. '追加伤害' .. '200')
    end

    if hurt > 0 then
        if WAR.PD["减气"][pid] == 1 then
            if JY.Person[eid]["能量"] > 1 then
                JY.Person[eid]["能量"] = JY.Person[eid]["能量"] - 1
            else
                zshurt = zshurt + 200
            end
            WAR.PD["减气"][pid] = nil
            lib.Debug('减气' .. '' .. '追加伤害' .. '200')
        end
    end
    -- 天龙弟子
    if JY.Person[pid]['门派'] == 27 then
        zshurt = zshurt + JY.Wugong[wugong]["消耗内力点数"]
        lib.Debug('天龙弟子' .. '' .. '追加伤害' .. JY.Wugong[wugong]["消耗内力点数"])
    end
    -- 结算追加伤害
    hurt = hurt + zshurt
    lib.Debug(JY.Person[pid]["姓名"] .. "追加伤害" .. zshurt)
    lib.Debug(JY.Person[pid]["姓名"] .. "总伤害" .. hurt)
  -------------------------闪避结算-------------------------------
    -- 无酒不欢：闪避统一结算
    if WAR.Miss[eid] == 1 then
        goto label0
    end

    if WAR.Miss[eid] == 1 then
        hurt = 0
    end
  -------------------------挨打气攻计算-------------------------------

    -- 八面威风
    if match_ID(eid, 187) then
        ang = ang * 0.9
        WAR.Person[enemyid]["特效动画"] = 153
    end


    if ZDGH(enemyid, 569) then
        ang = math.modf(ang * 0.8)
        WAR.Person[enemyid]["特效动画"] = 90
    end

    -- 冯衡
    if match_ID(eid, 588) then
        ang = math.modf(ang * 0.9)
    end


    -- 仪琳
    if match_ID(eid, 583) then
        ang = math.modf(ang * 0.85)
    end

    -- 太极奥义
    if Pmiji(eid, 72) then
        -- 张三丰85%几率
        -- 其他人(45+资质/4)%几率
        -- 武当弟子固定60
        local jl = 55 + math.modf(JY.Person[eid]["资质"] / 4)
        if match_ID(eid, 5) then
            jl = 85
        elseif JY.Person[eid]['门派'] == 2 then
            jl = 60
        end
        if JLSD(0, jl, eid) then
            WAR.TJAY = 3
        end
    end

    -- 杀气降低25%
    if WAR.TJAY == 3 then
        ang = ang * 0.75
    end

    -- 九阳神功
    if Curr_NG(eid, 106) and ang > 0 and (JY.Person[eid]["内力性质"] == 1 or JY.Person[eid]["内力性质"] == 3) and
        (JLSD(20, 80, eid) or WAR.LQZ[eid] == 100) then
        ang = ang * 0.7
        WAR.PD['氤氲紫气'][eid] = 1
        Set_Eff_Text(enemyid, "特效文字0", "氤氲紫气")
        WAR.Person[enemyid]["特效动画"] = 90
    end

    -- 主角刀系，每个刀法练到极，减少受到的5%杀气
    if JY.Base["标准"] == 4 and eid == 0 then
        local askd = 0
        for i = 1, JY.Base["武功数量"] do
            if JY.Wugong[JY.Person[0]["武功" .. i]]["武功类型"] == 4 and JY.Person[0]["武功等级" .. i] == 999 then
                askd = askd + 1
            end
        end
        if askd > 7 then
            askd = 7
        end
        ang = math.modf(ang * (1 - 0.05 * askd))
    end

    -- 小王爷每个武功练到极，减少受到的3%气攻
    if match_ID(eid, 84) or match_ID(eid, 650) then
        local LXBR = 0
        for i = 1, JY.Base["武功数量"] do
            if JY.Wugong[JY.Person[eid]["武功" .. i]] and JY.Person[eid]["武功等级" .. i] == 999 then
                LXBR = LXBR + 1
            end
        end
        if LXBR > 5 then
            LXBR = 5
        end
        ang = math.modf(ang * (1 - 0.05 * LXBR))
    end

    -- 不计算在原距离之中
    -- 魔帝BOSS距离越远，杀气越低
    if match_ID(eid, 9764) then
        local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[enemyid]["坐标X"]) +
                           math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[enemyid]["坐标Y"])
        if offset > 11 then
            offset = 11
        end
        local mang = ang * (100 - (offset - 1) * 3) / 100
        if Boss(enemyid) then
            mang = mang * 2
        end
        ang = mang
    end

    -- 两仪
    if PersonKF(eid, 37) and PersonKF(eid, 60) and JLSD(20, 84, eid) then
        ang = ang - 320
        if ang < 0 then
            ang = 0
        end
    end
    -- 32%几率变两仪守护・极 水岱100%
    if (PersonKF(eid, 37) and PersonKF(eid, 60)) or match_ID(eid, 96) then -- 修改BUG
        if JLSD(30, 62, eid) then
            ang = ang - 640
            WAR.Person[enemyid]["特效动画"] = 21
            Set_Eff_Text(enemyid, "特效文字1", "两仪守护・极")
        else
            ang = ang - 320
            WAR.Person[enemyid]["特效动画"] = 21
            Set_Eff_Text(enemyid, "特效文字1", "两仪守护")
        end
    end

    -- 阿九 降低999点气攻
    if WAR.FGPZ[eid] ~= nil then
        ang = ang - 999
        if ang < 0 then
            ang = 0
        end
        WAR.FGPZ[eid] = nil
    end

  -------------------------气防计算加成-------------------------------
    -- 周伯通空明之武道使敌方不会护体
    if WAR.KMZWD == 0 then
        if JY.Person[eid]["主运内功"] > 0 then
            local dng1 = 0
            for i = 1, JY.Base["武功数量"] do
                local kfid = JY.Person[eid]["武功" .. i]
                local kflvl = JY.Person[eid]["武功等级" .. i]
                if kflvl == 999 then
                    kflvl = 11
                else
                    kflvl = math.modf(kflvl / 100) + 1
                end
                if kfid == JY.Person[eid]["主运内功"] then
                    dng1 = get_skill_power(eid, kfid, kflvl)
                end
            end
            dng = dng + dng1
            local dh = {90, 88, 89}
            local dh1 = dh[WGns(JY.Person[eid]["主运内功"]) + 1]
            WAR.Person[enemyid]["特效动画"] = dh1
            WAR.NGHT = JY.Person[eid]["主运内功"];
            -- 运行天赋内功气防+200
            if  JY.Person[eid]["主运内功"] == JY.Person[eid]["天赋内功"] then
                dng = dng + 200;
            end
            -- 内轻特效306 
            if NeiGong_tx(eid, 306) then
                dng = dng + ekfcj_ng * 250
            end
        end
    end
    if WAR.PD['十八罗汉阵'][eid] ~= nil then
        dng = dng + 500
    end
    -- 扫地奖励
    if eid == 0 and CC.TX['扫地奖励'] == 1 then
        dng = dng + 1000
    end

    -- 天罡每个内功+100气防
    -- 浩然罡气
    if match_ID(eid, 9946) then
        local hrgq = 0
        for i = 1, JY.Base["武功数量"] do
            if JY.Wugong[JY.Person[eid]["武功" .. i]]["武功类型"] == 6 then
                hrgq = hrgq + 1
            end
        end
        dng = dng + hrgq * 100
    end
    -- 护体动画
    if WAR.NGHT == 204 then
        WAR.Person[enemyid]["特效动画"] = 111
    end

    -- 论剑打赢阿青的奖励，气防永久提高800点
    if eid == 0 and CC.TX["阿青奖励"] == 1 then
        dng = dng + 800
    end

    -- 九字真言 者
    if WAR.PD["者"][eid] ~= nil and WAR.PD["者"][eid] == 1 then
        dng = dng + 800
    end

    -- 蒙哥，气防+2000点
    if eid == 627 or eid == 567 or eid == 568 then
        dng = dng + 2000
    end

    -- 防御状态
    if WAR.Defup[eid] == 1 then
        WAR.Person[enemyid]["特效动画"] = 90
        Set_Eff_Text(enemyid, "特效文字1", "防御状态")                
        --内轻特效1030 
        if NeiGong_tx(pid,1030) then 
            dng = dng * dkfcj_ng*0.5
        end
    end



    -- 阿紫曼珠沙华，每杀一个人+200气防
    if match_ID(eid, 47) or match_ID(eid, 9886) then
        dng = dng + 200 * WAR.MZSH
    end

    if match_ID(eid, 637) then
        if WAR.HXZYJ == 1 then
            -- dng = dng + 1200
        end
    end

    -- 圣火三使 受伤害减少、气防提高
    if WAR.ZDDH == 14 and (eid == 173 or eid == 174 or eid == 175) then
        local shz = 0
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
                shz = shz + 1
            end
        end
        if shz == 3 then
            dng = dng + 1000
        end
    end

    -- 任飞燕
    if match_ID(eid, 9943) then
        dng = dng + JY.Person[eid]["轻功"] * 2
    end

    -- 太虚剑意 坐忘无我 韬光养晦
    if Curr_NG(eid, 152) then
        local TX = 0
        TX = ang * 0.2
        if TX < 1500 then
            dng = dng + TX
            WAR.Person[enemyid]["特效动画"] = 137
            Set_Eff_Text(enemyid, "特效文字1", "韬光养晦・坐忘无我")
        end
    end

    -- 全真七子，天罡北斗阵，受伤害减少和增加气防
    if (eid >= 123 and eid <= 128) or eid == 68 then
        dng = dng + 1200
        WAR.Person[enemyid]["特效动画"] = 93
        Set_Eff_Text(enemyid, "特效文字2", "天罡北斗阵护体")
    end

    -- 武当七侠，真武七截阵，受伤害减少和增加气防
    if (eid >= 532 and eid <= 538) then
        dng = dng + 1200
        WAR.Person[enemyid]["特效动画"] = 93
        Set_Eff_Text(enemyid, "特效文字2", "真武七截阵护体")
    end

    -- 金刚伏魔圈，伤害一减少，气防提高
    if PersonKF(eid, 82) then
        local jgfmq = 0
        local effstr = "金刚伏魔圈"
        for j = 0, WAR.PersonNum - 1 do
            if PersonKF(WAR.Person[j]["人物编号"], 82) and WAR.Person[j]["死亡"] == false and
                WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
                jgfmq = jgfmq + 1
            end
        end
        -- 上限3人
        if jgfmq > 3 then
            jgfmq = 3
        end
        if jgfmq == 3 then
            effstr = "真." .. effstr
        end
        if jgfmq > 1 then
            dng = dng + 500 * (jgfmq - 1)
            Set_Eff_Text(enemyid, "特效文字3", effstr)
        end
    end

    -- 彻地虎是条好汉
    if Pmiji(eid, 11) then
        local jgfmq = 0
        local effstr = "彻地虎是条好汉"
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
                jgfmq = jgfmq + 1
            end
        end
        if jgfmq >= 2 and math.random(10) < 4 then
            dng = dng + 1000
            Set_Eff_Text(enemyid, "特效文字3", effstr)
        end
    end

    if match_ID(eid, 597) or match_ID(eid, 598) or match_ID(eid, 599) then
        local dedjdn = 0
        local effstr = "无我相、无人相、无众生相、无寿者相"
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ~= WAR.Person[enemyid]["我方"] then
                dedjdn = dedjdn + 1
            end
        end
        if dedjdn > 0 then
            Set_Eff_Text(enemyid, "特效文字1", effstr)
            dng = dng + 1000 * (dedjdn)
        end
    end

    -- 江南四友
    if match_ID(eid, 31) or match_ID(eid, 32) or match_ID(eid, 33) or match_ID(eid, 34) then
        local jnsy = 0
        local effstr = "人生于世，忧多乐少"
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
                jnsy = jnsy + 1
            end
        end
        if jnsy > 0 then
            dng = dng + 400 * (jnsy)
            if jnsy > 1 then
                Set_Eff_Text(enemyid, "特效文字3", effstr .. "X" .. jnsy)
            else
                Set_Eff_Text(enemyid, "特效文字3", effstr)
            end
        end
    end

    -- 江南七怪
    if match_ID(eid, 9751) then
        local JLQX = 0
        local effstr = "要杀要剐,悉听尊便"
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] then
                JLQX = JLQX + 1
            end
        end
        if JLQX > 0 then
            dng = dng + 400 * (JLQX)
            if JLQX > 1 then
                Set_Eff_Text(enemyid, "特效文字3", effstr .. "X" .. JLQX)
            else
                Set_Eff_Text(enemyid, "特效文字3", effstr)
            end
        end
    end

    -- 九阳神功
    if WAR.PD['氤氲紫气'][eid] == 1 then
        dng = dng + 1000
    end
    -- 太极蓄气
    if WAR.PD['蓄气值'][eid] ~= nil and WAR.PD['蓄气值'][eid] > 0 then
        dng = dng + WAR.PD['蓄气值'][eid]
    end
    -- 天佛降世
    if match_ID(eid, 9986) and WAR.PD["复活"][eid] ~= nil and WAR.BJ == 1 and hurt > 0 then
        dng = dng + 1200
    end

    -- 森罗万象
    if Pmiji(eid, 12) then
        if WAR.HXZYJ == 1 then
            dng = dng + 1200
        end
    end


    -- 破绽
    if WAR.Weakspot[eid] ~= nil and WAR.Weakspot[eid] > 0 then
        dng = dng * 0.75
    end
    -- 归元境
    if WAR.PD["复活"][eid] == 2 then
        dng = dng + dng * 0.25
    end
    -- 内轻特效307
    if NeiGong_tx(eid, 307) then
        dng = dng + dng * (ekfcj_ng * 10 / 100)
    end
  -------------------------初始防御力计算-----------------------------
    local dkf = JY.Person[eid]["主运内功"]
    local dkfwl = 0
    if JY.Person[eid]["主运内功"] == 0 then
        dkfwl = 0
    else
        dkfwl = get_skill_power(eid, dkf, level)
        --内轻特效1036
        if NeiGong_tx(pid,1036) and JLSD(0,dkfcj_ng*25,pid) then 
            dkfwl = 0
        end
    end
    if WAR.PD['十八罗汉阵'][eid] ~= nil then
        def = def + 100
    end

    --内轻特效912
    if NeiGong_tx(pid,912) and wgtype == 1 then
        def = def - def*dkfcj_ng*0.1 
    end
    --内轻特效913
    if NeiGong_tx(pid,913) and wgtype == 2 then
        def = def - def*dkfcj_ng*0.1 
    end
    --内轻特效914
    if NeiGong_tx(pid,914) and wgtype == 3 then
        def = def - def*dkfcj_ng*0.1 
    end  
    --内轻特效915
    if NeiGong_tx(pid,915) and wgtype == 4 then
        def = def - def*dkfcj_ng*0.1 
    end      
    --内轻特效916
    if NeiGong_tx(pid,916) and wgtype == 5 then
        def = def - def*dkfcj_ng*0.1 
    end    
    --内轻特效917
    if NeiGong_tx(pid,917) and wgtype == 6 then
        def = def - def*dkfcj_ng*0.1 
    end
    --内轻特效918
    if NeiGong_tx(pid,918)  then
        def = def - def*dkfcj_ng*0.06 
    end
    -- 碎甲
    if JY.Person[pid]['奇穴' .. 65] == 1 then
        def = def * 0.6
		local ts = 0
		for i = 1,JY.Base['武功数量'] do 
			if JY.Wugong[JY.Person[pid]['武功' .. i]]['武功类型'] == 5 then
                ts = ts + 1
            end
		end
		if JLSD(0,ts,pid) then 
			def = 0
		end
    end
    local Pdef = dkfwl + def
    -- 灼烧减少防御
    if JY.Person[eid]["灼烧程度"] > 25 then
        Pdef = Pdef - JY.Person[eid]["灼烧程度"] * 2
    elseif JY.Person[eid]["灼烧程度"] > 0 then
        Pdef = Pdef - JY.Person[eid]["灼烧程度"]
    end
    lib.Debug(JY.Person[eid]["姓名"] .. "破防前防御是" .. (math.modf(Pdef)))
    -- 破苍穹
    if WAR.XMJDHS == 1 then
        def = def * 0.5
    end

    -- 剑法无极
    if match_ID(pid, 9977) and JY.Wugong[wugong]['武功类型'] == 3 then
        Pdef = Pdef * 0.9
        local jn = 0
        for i = 1, JY.Base['武功数量'] do
            if JY.Wugong[JY.Person[pid]['武功' .. i]]['武功类型'] == 3 then
                jn = jn + 1
            end
        end
        if jn > 0 then
            Pdef = Pdef * (1 - jn * 0.02)
        end
        Set_Eff_Text(enemyid, "特效文字1", "破防")
    end
    -- 寒露清梦
    if match_ID(pid, 9785) then
        if JLSD(0, 25, pid) then
            Pdef = Pdef * 0.85
            Set_Eff_Text(enemyid, "特效文字1", "破防")
        end
    end
	--傲世狂刀
	if JY.Person[pid]['奇穴' .. 51] == 1 then
		Pdef = Pdef * 0.7
	end
    if WAR.JMZL == 1 then
        Pdef = Pdef * 0.5
    end
    -- 天元剑气
    if WAR.TYJQ == 1 then
        Pdef = Pdef * 0.25
    end
    if WAR.PD['破甲状态'][eid] ~= nil then
        Pdef = Pdef * 0.75
    end
    -- 穿云劲
    if JY.Person[pid]["奇穴" .. 6] == 1 then
        Pdef = Pdef * 0.8
    end
    -- 大宗师
    if WAR.DZTG_DZS == 1 then
        Pdef = Pdef * 0.7
    end

    local lghurt1 = (Pdef) / (Pdef + hurt)
    hurt = hurt * (1 - lghurt1)
    lib.Debug(JY.Person[eid]["姓名"] .. "防御是" .. def .. "主运内功加成防御" .. dkfwl .. "总防御是" .. (def + dkfwl))
    lib.Debug(JY.Person[eid]["姓名"] .. "总防御是" .. (def + dkfwl) .. " 减少了伤害" .. (lghurt1 * 100) .. "%")
    lib.Debug(JY.Person[eid]["姓名"] .. "防御减少了伤害" .. (lghurt1 * 100) .."%计算防御后受到的伤害=" .. hurt)
    -------------------------减伤写这里---------------------------
    lib.Debug(JY.Person[eid]["姓名"] .. "百分比减伤：")
    local bfjs = 1
    if hurt > 0 then
        --内轻特效101
        --内轻特效1015
    ---------------------------百分比减伤写这里-------------------    
        -- 御剑术 五岳剑诀
        if JY.Person[eid]['奇穴' .. 15] == 1 and Curr_NG(eid, 175) then
            local zs = JY.Person[eid]['御剑能力'] /10
            if zs > 30 then 
                zs = 30
            end
            hurt = hurt*(100-zs)/100
            Set_Eff_Text(enemyid, "特效文字1", "以气御剑")
        end
        if NeiGong_tx(eid,1015) then 
            if WAR.ACT == 1 then 
                hurt = hurt*0.5
                Set_Eff_Text(enemyid, "特效文字1", "龟息")
            end
        end
       
        if  WAR.Defup[eid] ~= nil and  WAR.Defup[eid] == 1 then 
            --内轻特效922
            if NeiGong_tx(pid,922) then 
                hurt =hurt + hurt*(dkfcj_ng*25)/100
                lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效922" .. '减伤后伤害=' .. hurt)
            --内轻特效1030    
            elseif NeiGong_tx(pid,1030) then 
                hurt = hurt - hurt*(dkfcj_ng*10)/100
            end
        end
        --内轻特效931 
        if NeiGong_tx(pid,931) and JY.Person[eid]['性别'] == 0 then 
            hurt = hurt + hurt*(dkfcj_ng*10)/100
            lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效931" .. '减伤后伤害=' .. hurt)
        end
        --内轻特效931 
        if NeiGong_tx(eid,931) and JY.Person[pid]['性别'] == 0 then 
            hurt = hurt - hurt*(dkfcj_ng*10)/100
            lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效931" .. '减伤后伤害=' .. hurt)
        end
        --内轻特效923
        if NeiGong_tx(pid,923) and WAR.Person[enemyid]['护盾'] ~= nil  then 
            hurt =hurt + hurt*(dkfcj_ng*25)/100
            lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效923" .. '减伤后伤害=' .. hurt)
        end
        --内轻特效925
        if NeiGong_tx(pid,925) and (WAR.PD['蓄气值'][eid] ~= nil or WAR.PD["蛤蟆蓄力"][eid] ~= nil or WAR.PD["鲸息蓄力"][eid] ~= nil)  then 
            hurt =hurt + hurt*(dkfcj_ng*25)/100
            lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效925" .. '减伤后伤害=' .. hurt)
        end
        -- 内轻特效814 无视敌方附加攻击力
        if NeiGong_tx(eid, 814) then
            local gbf = JY.Person[pid]['攻击力'] / (JY.Person[pid]['攻击力'] + FJGONGJ(pid))
            hurt = hurt * gbf
            lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效814" .. '减伤后伤害=' .. hurt)
        end
        -- 内轻特效815 无视敌方附加攻击力
        if NeiGong_tx(eid, 815) then
            local gbf = FJGONGJ(pid) / (JY.Person[pid]['攻击力'] + FJGONGJ(pid))          
            hurt = hurt * gbf
            lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效815" .. '减伤后伤害=' .. hurt)
        end
        -- 内轻特效817
        if NeiGong_tx(eid, 817) then
            if wgtype == 1 then
                hurt = hurt * 0.5
                lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效817" .. '减伤后伤害=' .. hurt)
            end
        end

        -- 内轻特效818 
        if NeiGong_tx(eid, 818) then
            if wgtype == 2 then
                hurt = hurt * 0.5
                lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效818" .. '减伤后伤害=' .. hurt)
            end
        end
        -- 内轻特效819 
        if NeiGong_tx(eid, 819) then
            if wgtype == 3 then
                hurt = hurt * 0.5
                lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效819" .. '减伤后伤害=' .. hurt)
            end
        end
        -- 内轻特效820
        if NeiGong_tx(eid, 820) then
            if wgtype == 4 then
                hurt = hurt * 0.5
                lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效820" .. '减伤后伤害=' .. hurt)
            end
        end
        -- 内轻特效821 受到奇门伤害-50%
        if NeiGong_tx(eid, 821) then
            if wgtype == 5 then
                hurt = hurt * 0.5
                lib.Debug(JY.Person[eid]["姓名"] .. "内轻特效821" .. '减伤后伤害=' .. hurt)
            end
        end

        -- 内轻特效809 每1点体质减少1%承伤
        if NeiGong_tx(eid, 809) then
            local hh = JY.Person[eid]['体质']
            bfjs = bfjs * (1 - hh * 2 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效809' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效413 减少受到的拳掌伤害
        if NeiGong_tx(eid, 413) and wgtype == 1 then
            bfjs = bfjs * (1 - ekfcj_ng * 10 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效413' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效414 减少受到的指腿伤害
        if NeiGong_tx(eid, 414) and wgtype == 2 then
            bfjs = bfjs * (ekfcj_ng * 15 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效413' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效415  减少受到的剑法伤害
        if NeiGong_tx(eid, 415) and wgtype == 3 then
            bfjs = bfjs * (ekfcj_ng * 15 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效413' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效416 减少受到的刀法伤害
        if NeiGong_tx(eid, 416) and wgtype == 4 then
            bfjs = bfjs * (ekfcj_ng * 15 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效413' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效417 减少受到的奇门伤害
        if NeiGong_tx(eid, 417) and wgtype == 5 then
            bfjs = bfjs * (ekfcj_ng * 15 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效413' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效418  减少受到的内攻伤害
        if NeiGong_tx(eid, 418) and JY.Wugong[wugong]['武功类型'] == 6 then
            bfjs = bfjs * (ekfcj_ng * 15 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效413' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 内轻特效401 减少受到的伤害
        if NeiGong_tx(eid, 401) then
            bfjs = bfjs * (1 - ekfcj_ng * 10 / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效401' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 至阳之体
        if JY.Person[eid]['奇穴' .. 61] == 1 then
            if Curr_NG(eid, 106) then
                if JLSD(0, 30, eid) then
                    bfjs = bfjs * 0.5
                    Set_Eff_Text(enemyid, "特效文字1", "九阳护体")
                    lib.Debug(JY.Person[eid]["姓名"] .. '至阳之体' .. '' .. '后受的伤害  ' .. hurt * bfjs)
                end
            end
        end
        -- 延平郡王
        if match_ID(eid, 139) and JY.Person[pid]["性别"] == 1 then
            -- hurt = hurt*0.95 
            bfjs = bfjs * 0.95
            lib.Debug(JY.Person[eid]["姓名"] .. '破绽' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end

        -- 破绽
        if WAR.Weakspot[eid] ~= nil and WAR.Weakspot[eid] > 0 then
            -- hurt = hurt*1.25
            bfjs = bfjs * 1.25
            lib.Debug(JY.Person[eid]["姓名"] .. '破绽' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 达巴尔死战
        if match_ID(pid, 160) then
            if eid == WAR.SZSD then
                -- hurt = hurt*1.5
                bfjs = bfjs * 0.5
                lib.Debug(JY.Person[eid]["姓名"] .. '达巴尔死战' .. '' .. '后受的伤害  ' .. hurt * bfjs)
            end
        end
        -- 冰肌玉骨
        if match_ID(eid, 9924) then
            -- hurt = hurt*0.5
            bfjs = bfjs * 0.5
            lib.Debug(JY.Person[eid]["姓名"] .. '冰肌玉骨' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 剑气护体
        if WAR.PD['剑气护体'][eid] ~= nil then
            -- hurt = hurt*(1-WAR.PD['剑气护体'][eid]*5/100) 
            bfjs = bfjs * (1 - WAR.PD['剑气护体'][eid] * 5 / 100)
            Set_Eff_Text(enemyid, "特效文字1", "剑气护体")
            lib.Debug(JY.Person[eid]["姓名"] .. '剑气护体' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 参合状态
        if WAR.PD['参合状态'][eid] ~= nil then
            local n = math.random(110, 130)
            -- hurt = hurt*n/100 
            bfjs = bfjs * n / 100
            lib.Debug(JY.Person[eid]["姓名"] .. '参合状态' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 三十二身相减伤
        if WAR.PD['三十二身像'][eid] ~= nil then
            -- hurt = hurt*0.85
            bfjs = bfjs * 0.85
            lib.Debug(JY.Person[eid]["姓名"] .. '三十二身相减伤' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 十三太保
        if match_ID(eid, 9807) then
            -- hurt = hurt*0.87
            bfjs = bfjs * 0.87
            Set_Eff_Text(enemyid, "特效文字1", "十三太保横练")
            lib.Debug(JY.Person[eid]["姓名"] .. '十三太保横练' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 紫衣银鞭
        if match_ID(eid, 9793) then
            local n = QMnum(eid)
            if n > 7 then
                n = 7
            end
            -- hurt = hurt*(1-n*0.05)
            bfjs = bfjs * (1 - n * 0.05)
            lib.Debug(JY.Person[eid]["姓名"] .. '紫衣银鞭' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end

        -- 九剑克制减伤
        if JY.Person[eid]["优先使用"] == 47 then
            local dyx = JY.Person[pid]['优先使用']
            local dlx = JY.Wugong[dyx]['武功类型']
            if dlx == 1 then
                -- hurt = hurt*0.85
                bfjs = bfjs * 0.85
                Set_Eff_Text(enemyid, "特效文字1", "破掌式")
                WAR.Person[enemyid]["特效动画"] = 83
            elseif dlx == 2 then
                -- hurt = hurt*0.85
                bfjs = bfjs * 0.85
                Set_Eff_Text(enemyid, "特效文字1", "破指式")
                WAR.Person[enemyid]["特效动画"] = 83
            elseif dlx == 3 then
                -- hurt = hurt*0.85
                bfjs = bfjs * 0.85
                Set_Eff_Text(enemyid, "特效文字1", "破剑式")
                WAR.Person[enemyid]["特效动画"] = 83
            elseif dlx == 4 then
                -- hurt = hurt*0.85
                bfjs = bfjs * 0.85
                Set_Eff_Text(enemyid, "特效文字1", "破刀式")
                WAR.Person[enemyid]["特效动画"] = 83
            elseif dlx == 5 then
                -- hurt = hurt*0.85
                bfjs = bfjs * 0.85
                Set_Eff_Text(enemyid, "特效文字1", "破枪式")
                WAR.Person[enemyid]["特效动画"] = 83
            end
            lib.Debug(JY.Person[eid]["姓名"] .. '九剑克制减伤' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 密宗特性
        if JY.Person[pid]['门派'] == 29 then
            if WAR.PD['密宗印记'][eid] ~= nil and WAR.PD['密宗印记'][eid] > 1 then
                -- hurt = hurt*(1+ WAR.PD['密宗印记'][eid]/10)
                bfjs = bfjs * (1 + WAR.PD['密宗印记'][eid] / 10)
                Set_Eff_Text(enemyid, "特效文字1", "印记爆发")
                lib.Debug(JY.Person[eid]["姓名"] .. '密宗特性' .. '' .. '后受的伤害  ' .. hurt * bfjs)
            end
        end
        -- 延平郡王
        if match_ID(pid, 139) and JY.Person[eid]["性别"] == 1 then
            -- hurt = hurt*1.05 
            bfjs = bfjs * 1.05
            lib.Debug(JY.Person[eid]["姓名"] .. '延平郡王' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 9809一龙一象
        if match_ID(eid, 9809) then
            -- hurt = hurt*0.9
            bfjs = bfjs * 0.9
            lib.Debug(JY.Person[eid]["姓名"] .. '9809一龙一象' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 精忠报国
        if match_ID(eid, 9910) then
            local dd = 0
            local tt = JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"]
            if tt < 0.25 then
                dd = 0.5
            elseif tt < 0.5 then
                dd = 0.25
            end
            -- hurt = hurt*(1-dd)
            bfjs = bfjs * (1 - dd)
            lib.Debug(JY.Person[eid]["姓名"] .. '精忠报国' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 剑神随剑法增伤
        if match_ID(eid, 9941) then
            local n = 0
            for i = 1, JY.Base['武功数量'] do
                if JY.Wugong[JY.Person[eid]['武功' .. i]]['武功类型'] == 3 then
                    n = n + 1
                end
            end
            -- hurt = hurt *(1- n/100*3)
            bfjs = bfjs * (1 - n / 100 * 3)
            lib.Debug(JY.Person[eid]["姓名"] .. '剑神随剑法增伤' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 铁划银勾
        if match_ID(eid, 9780) then
            local tn = Person_LJ(eid) / 2
            -- hurt = hurt*(100-tn)/100 
            bfjs = bfjs * (100 - tn) / 100
            lib.Debug(JY.Person[eid]["姓名"] .. '铁划银勾' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 摩天居士玄铁令一
        if match_ID(eid, 164) then
            if WAR.PD["玄铁令"][eid] ~= nil and WAR.PD["玄铁令"][eid] == 1 then
                -- hurt = hurt*1.2
                bfjs = bfjs * 1.2
                Set_Eff_Text(enemyid, "特效文字1", "天下人负我")
                WAR.PD['玄铁令'][eid] = nil
                lib.Debug(JY.Person[eid]["姓名"] .. '摩天居士玄铁令一' .. '' .. '后受的伤害  ' .. hurt *
                              bfjs)
            end
        end
        -- 化三清
        if match_ID(eid, 9747) then
            -- hurt = hurt *0.7
            bfjs = bfjs * 0.7
            Set_Eff_Text(enemyid, "特效文字1", "化三清")
            lib.Debug(JY.Person[eid]["姓名"] .. '化三清' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 厚土旗使
        if match_ID(eid, 301) then
            -- hurt = hurt*0.85
            bfjs = bfjs * 0.85
            lib.Debug(JY.Person[eid]["姓名"] .. '厚土旗使' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 门派武功数量减伤
        if MP_wgnum(eid) > 7 then
            bfjs = bfjs * 0.8
            lib.Debug(JY.Person[eid]["姓名"] .. '门派武功数量减伤' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 越战越勇 
        if match_ID(eid, 9950) then
            local dd = 0
            local tt = JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"]
            dd = tt / 2
            if dd < 0.15 then
                dd = 0.15
            end
            if dd > 0.65 then
                dd = 0.35
            end
            -- hurt = hurt*(1-dd)
            bfjs = bfjs * (1 - dd)
            lib.Debug(JY.Person[eid]["姓名"] .. '越战越勇' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end

        -- 铜笔铁算盘
        if match_ID(eid, 188) then
            local gold = CC.Gold / 1000
            if gold > 20 then
                gold = 20
            end
            -- hurt = hurt *(1-gold/100)
            bfjs = bfjs * (1 - gold / 100)
            lib.Debug(JY.Person[eid]["姓名"] .. '铜笔铁算盘' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 论剑打赢独孤，九剑真传70%几率减伤20%，并降低攻方下回合集气位置
        -- 七夕令狐冲自带
        if hurt > 0 and PersonKF(eid, 47) then
            local jl = 10 + JY.Person[eid]["御剑能力"] / 10
            local pd = false
            if match_ID(eid, 592) then
                pd = true
            elseif JLSD(0, jl, eid) then
                pd = true
            end
            if pd == true then
                local jpwz;
                if JY.Wugong[wugong]["武功类型"] == 1 or JY.Wugong[wugong]["武功类型"] == 2 then
                    jpwz = "九剑真传・破掌式"
                elseif JY.Wugong[wugong]["武功类型"] == 3 then
                    jpwz = "九剑真传・破剑式"
                elseif JY.Wugong[wugong]["武功类型"] == 4 then
                    jpwz = "九剑真传・破刀式"
                elseif JY.Wugong[wugong]["武功类型"] == 5 then
                    jpwz = "九剑真传・破棍式"
                elseif JY.Wugong[wugong]["武功类型"] == 6 then
                    jpwz = "九剑真传・破气式"
                end
                WAR.Person[enemyid]["特效动画"] = 83
                local n = 0.2
                -- hurtjs =  hurtjs + (jsm-hurtjs)*n
                -- hurt = hurt*(1-n)
                bfjs = bfjs * (1 - n)
                WAR.JJPZ[pid] = (WAR.JJPZ[pid] or 0) + 1 -- 九剑破招
                Set_Eff_Text(enemyid, "特效文字1", jpwz)
                lib.Debug(JY.Person[eid]["姓名"] .. '九剑破招' .. '' .. '后受的伤害  ' .. hurt * bfjs)
            end
        end
        -- 无根无形
        if (match_ID(eid, 9770) or match_ID(eid, 9821)) and JLSD(0, 40, eid) then
            -- hurt =  hurt*0.7
            bfjs = bfjs * 0.7
            Set_Eff_Text(enemyid, "特效文字1", "无根无形")
        end
        -- 八面威风
        if match_ID(eid, 187) then
            -- hurt = hurt*0.9 
            bfjs = bfjs * 0.9
            WAR.Person[enemyid]["特效动画"] = 153
            lib.Debug(JY.Person[eid]["姓名"] .. '八面威风' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end

        -- 杀气降低25%
        if WAR.TJAY == 3 then
            -- 学有太极神功，触发太极奥义减伤10%
            if PersonKF(eid, 171) and hurt > 0 then
                -- hurt = math.modf(hurt * 0.9)
                bfjs = bfjs * 0.9
                lib.Debug(JY.Person[eid]["姓名"] .. '太极图' .. '' .. '后受的伤害  ' .. hurt * bfjs)
            end
            WAR.Person[enemyid]["特效动画"] = 21
            -- 学有太极神功必出真太奥，否则有35%几率发动
            if PersonKF(eid, 171) or JLSD(40, 75, eid) then
                -- hurt = math.modf(hurt * 0.8)
                -- 太极图
                if JY.Person[eid]['奇穴' .. 146] == 1 then
                    bfjs = bfjs * 0.5
                    WAR.TJAY = 4
                    lib.Debug(JY.Person[eid]["姓名"] .. '太极图' .. '' .. '后受的伤害  ' .. hurt * bfjs)
                else
                    bfjs = bfjs * 0.8
                    WAR.TJAY = 4
                    lib.Debug(JY.Person[eid]["姓名"] .. '真.太极奥义' .. '' .. '后受的伤害  ' .. hurt * bfjs)
                end
                Set_Eff_Text(enemyid, "特效文字1", "太极真义・四两拨千斤");
            else
                Set_Eff_Text(enemyid, "特效文字2", "太极奥义");
            end
        end

        -- 金刚不坏减伤
        if PersonKF(eid, 144) then
            local jl = 0
            if Curr_NG(eid, 144) then
                jl = 60
            end
            if match_ID(eid, 603) then
                jl = 100
            end
            if Curr_NG(eid, 108) then
                jl = 100
            end
            if JLSD(0, jl, eid) then
                -- hurt = hurt*0.7
                bfjs = bfjs * 0.7
                Set_Eff_Text(enemyid, "特效文字1", "金刚不坏")
                lib.Debug(JY.Person[eid]["姓名"] .. '金刚不坏' .. '' .. '后受的伤害  ' .. hurt * bfjs)
            end
        end

        -- 格档
        if WAR.PD["格挡"][eid] == 1 then
            if match_ID(eid, 9916) then
                -- hurt = 0
                bfjs = 0
                WAR.PD['三才归元'][eid] = 1
                Set_Eff_Text(enemyid, "特效文字3", "三才归元")
            else
                if WAR.PD['真武七截阵'][eid] ~= nil then
                    -- hurt = hurt*0.5
                    bfjs = bfjs * 0.5
                else
                    -- hurt = hurt *0.7
                    bfjs = bfjs * 0.7
                end
                lib.Debug(JY.Person[eid]["姓名"] .. "格挡后受的伤害  " .. hurt * bfjs)
            end
        end

        -- 防御状态
        if WAR.Defup[eid] == 1 then
            bfjs = bfjs * 0.8
            lib.Debug(JY.Person[eid]["姓名"] .. '防御状态' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 人物分阶写入减伤 
        local rwfj = JY.Person[eid]['畅想分阶']
        local rwmenu = {5, 4, 3, 2, 1}
        if rwfj < 6 then
            local fj = 0
            fj = rwmenu[JY.Person[eid]['畅想分阶']]
            bfjs = bfjs * (1 - fj * 0.1)
            lib.Debug(JY.Person[eid]["姓名"] .. '人物分阶写入减伤' .. '' .. '后受的伤害  ' .. hurt * bfjs)
        end
        -- 限制最大减伤倍数为0.8
        if bfjs < 0.2 then
            bfjs = 0.2
        end
        hurt = hurt * bfjs
        lib.Debug(JY.Person[eid]["姓名"] .. '合计减伤' .. (1 - bfjs))
        lib.Debug(JY.Person[eid]["姓名"] .. '减伤后受到的伤害' .. hurt)

    ------------------------分担伤害写这里-----------------------------------
        -- 误伤打到自己人
        if DWPD(WAR.CurID, enemyid) == false then
            -- 水笙误伤加血
            if match_ID(pid, 9905) and hurt > 0 then
                hurt = math.modf(-hurt)
            else
                -- hurt = math.random(hurt/3,hurt/2)             
            end

        end
        -- 背锅
        if not inteam(eid) and hurt > 30 then
            for j = 0, WAR.PersonNum - 1 do
                if (WAR.Person[j]["人物编号"] == 0 and JY.Base["畅想"] == 515) and
                    JY.Person[WAR.Person[j]["人物编号"]]["生命"] > 0 and Rnd(100) > 75 then
                    WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                    WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) +
                                                        AddPersonAttrib(WAR.Person[j]["人物编号"], '生命',
                            -math.modf(hurt));
                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                    hurt = 0
                    Set_Eff_Text(enemyid, "特效文字2", "背锅")
                end
            end
        end
        -- 十八罗汉阵
        if WAR.PD['十八罗汉阵'][eid] ~= nil then
            local s = 0
            local p = 0
            for j = 0, WAR.PersonNum - 1 do
                local zid = WAR.Person[j]["人物编号"]
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]['我方'] == WAR.Person[enemyid]['我方'] then
                    s = s + 1
                    p = math.modf(hurt / s)
                end
            end
			if s > 1 then 
				for i = 0, WAR.PersonNum - 1 do
					local mid = WAR.Person[i]["人物编号"]
					if WAR.Person[i]["死亡"] == false and WAR.Person[i]['我方'] == WAR.Person[enemyid]['我方'] then
						WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]
						WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(mid, '生命', -p);
						Set_Eff_Text(i, "特效文字0", "十八罗汉阵.众生平等")
						WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
					end
				end
				
				hurt = math.modf(hurt - p*(s-1))
				lib.Debug('十八罗汉阵承伤人数 = '..s..'每人承担伤害'..p..'所受伤害 ='..hurt)
			end
        end

        -- 江南七怪
        if match_ID(eid, 9751) then
            local s = 1
            local p = 0
            for j = 0, WAR.PersonNum - 1 do
                local zid = WAR.Person[j]["人物编号"]
                if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[enemyid]["我方"] and
                    (zid == 9751) then
                    s = s + 1
                    p = math.modf(hurt / s)
                end
            end
            for i = 0, WAR.PersonNum - 1 do
                local mid = WAR.Person[i]["人物编号"]
                if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[enemyid]["我方"] and
                    (mid == 9751) then
                    WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]
                    WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) +
                                                        AddPersonAttrib(mid, '生命', -p);
                    WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                end
            end
            hurt = math.modf(hurt / s)
        end

        -- 灵犀分水功
        --内轻特效1008
        if NeiGong_tx(eid,1008) and JLSD(0,ekfcj_ng*15,eid) then 
            local s = 1
            local p = 0
            for j = 0, WAR.PersonNum - 1 do
                local zid = WAR.Person[j]["人物编号"]
                if WAR.Person[j]["死亡"] == false then
                    s = s + 1
                    p = math.modf((hurt / 2) / s)
                end
            end
            for i = 0, WAR.PersonNum - 1 do
                local mid = WAR.Person[i]["人物编号"]
                if WAR.Person[i]["死亡"] == false then
                    WAR.Person[i]["Life_Before_Hit"] = JY.Person[WAR.Person[i]["人物编号"]]["生命"]
                    WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) + AddPersonAttrib(mid, '生命', -p);
                    WAR.TXXS[WAR.Person[i]["人物编号"]] = 1
                end
            end
            hurt = math.modf(hurt / s * 0.5)
        end

        -- 一灯保护渔樵耕读
        if match_ID(eid, 9896) and hurt > 0 then
            local s = 0
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["人物编号"] == 65 and JY.Person[WAR.Person[j]["人物编号"]]["生命"] > 0 and
                    WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                    WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) +AddPersonAttrib(WAR.Person[j]["人物编号"], '生命',-math.modf(hurt / 2));
                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                    hurt = math.modf(hurt / 2)
                end
            end
        end
        -- 尖酸伶俐
        if match_ID(eid, 632) and hurt > 0 and JLSD(0, 25, eid) then
            local tm = {}
            local wid = nil
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and
                    WAR.Person[j]["人物编号"] ~= 632 then
                    tm[#tm + 1] = j
                end
                local tn = nil
                if tm[1] ~= nil then
                    tn = tm[math.random(#tm)]
                end
                if tn ~= nil then
                    wid = WAR.Person[tn]["人物编号"]
                end
            end
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["人物编号"] == wid and JY.Person[WAR.Person[j]["人物编号"]]["生命"] > 0 and
                    WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                    WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) +AddPersonAttrib(WAR.Person[j]["人物编号"], '生命',-math.modf(hurt));
                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                    hurt = 0
                    Set_Eff_Text(j, "特效文字1", "代君受过")
                end
            end
        end
        -- 佛山一霸
        if match_ID(eid, 748) and hurt > 0 and JLSD(0, 25, eid) then
            local tm = {}
            local wid = nil
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and
                    WAR.Person[j]["人物编号"] ~= 748 then
                    tm[#tm + 1] = j
                end
                local tn = nil
                if tm[1] ~= nil then
                    tn = tm[math.random(#tm)]
                end
                if tn ~= nil then
                    wid = WAR.Person[tn]["人物编号"]
                end
            end
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["人物编号"] == wid and JY.Person[WAR.Person[j]["人物编号"]]["生命"] > 0 and
                    WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    WAR.Person[j]["Life_Before_Hit"] = JY.Person[WAR.Person[j]["人物编号"]]["生命"]
                    WAR.Person[j]["生命点数"] = (WAR.Person[j]["生命点数"] or 0) +AddPersonAttrib(WAR.Person[j]["人物编号"], '生命', -math.modf(hurt * 0.75));
                    WAR.TXXS[WAR.Person[j]["人物编号"]] = 1
                    hurt = math.modf(hurt * 0.25)
                    Set_Eff_Text(j, "特效文字1", "代霸受过")
                end
            end
        end

    ----------------暴击率统一写这里----------------
        -- 无酒不欢：暴击率用函数计算
        local BJ = 0
        local BJKX = 0
        local kfkind = JY.Wugong[wugong]['武功类型']
        BJ = Person_BJ(pid)
        -- 内轻特效403
        if NeiGong_tx(eid, 403) then
            BJKX = BJKX + ekfcj_ng * 10
        end
        if WAR.PD["以眼还眼2"][pid] == 1 then
            BJ = BJ + 100
            WAR.PD["以眼还眼2"][pid] = nil
        end
        -- 定神门
        if (kfkind == 4 or kfkind == 3) and Pmiji(pid, 72) then
            BJ = BJ + 10
        end
        -- 佛笑珈蓝
        if wugong == 194 then
            if match_ID(pid, 313) then
                BJ = BJ + 100
            end
        end
        -- 傲世狂刀
        if JY.Person[pid]['奇穴' .. 51] == 1 then
            BJ = BJ + 30
        end
        -- 虎虎生风
        if Pmiji(pid, 52) then
            if kfkind == 4 then
                BJ = BJ * 1.5
            end
        end
        -- 周淮安
        if kfkind == 3 then
            if match_ID(pid, 455) then
                BJ = BJ + 100
            end
        end
        -- 少林寺武学
        if JY.Wugong[wugong]['门派'] == 1 then
            -- 少林精英
            for i = 461, 478 do
                if match_ID(pid, i) then
                    BJ = BJ + 10
                end
            end
            -- 少林精英
            if match_ID(pid, 509) or match_ID(pid, 540) or match_ID(pid, 541) or match_ID(pid, 542) or
                match_ID(pid, 543) or match_ID(pid, 544) then
                BJ = BJ + 10
            end
            -- 少林长老
            for i = 479, 496 do
                if match_ID(pid, i) then
                    BJ = BJ + 20
                end
            end
            if match_ID(pid, 572) or match_ID(pid, 653) or match_ID(pid, 655) or match_ID(pid, 656) then
                BJ = BJ + 20
            end
            if match_ID(pid, 653) or match_ID(pid, 655) or match_ID(pid, 656) then
                BJ = BJ + 30
            end
            -- 少林神僧 / 掌门
            if match_ID(pid, 597) or match_ID(pid, 598) or match_ID(pid, 599) or match_ID(pid, 658) then
                BJ = BJ + 40
            end
        end
        -- 武当派武学
        if JY.Wugong[wugong]['门派'] == 2 then
            -- 武当长老
            for i = 532, 538 do
                if match_ID(pid, i) then
                    BJ = BJ + 20
                end
            end
            -- 武当高手
            if match_ID(pid, 570) or match_ID(pid, 726) then
                BJ = BJ + 10
            end
        end
        -- 日月神教武学
        if JY.Wugong[wugong]['门派'] == 4 then
            -- 日月长老
            if match_ID(pid, 231) or match_ID(pid, 232) or match_ID(pid, 233) then
                BJ = BJ + 20
            end
        end
        -- 明教武学
        if JY.Wugong[wugong]['门派'] == 5 then
            -- 五散人
            if match_ID(pid, 306) or match_ID(pid, 307) or match_ID(pid, 308) or match_ID(pid, 309) or
                match_ID(pid, 310) then
                BJ = BJ + 20
            end
            -- 魔道祖师
            if match_ID(pid, 641) then
                BJ = BJ + 40
            end
        end
        -- 丐帮武学
        if JY.Wugong[wugong]['门派'] == 8 then
            -- 丐帮长老
            if match_ID(pid, 271) or match_ID(pid, 272) or match_ID(pid, 273) or match_ID(pid, 274) or
                match_ID(pid, 275) or match_ID(pid, 276) or match_ID(pid, 277) or match_ID(pid, 278) or
                match_ID(pid, 279) or match_ID(pid, 280) or match_ID(pid, 723) then
                BJ = BJ + 20
            end
        end
        -- 嵩山派武学
        if JY.Wugong[wugong]['门派'] == 10 then
            -- 嵩山高手
            if match_ID(pid, 195) or match_ID(pid, 196) or match_ID(pid, 197) or match_ID(pid, 198) or
                match_ID(pid, 199) or match_ID(pid, 200) then
                BJ = BJ + 20
            end
        end
        -- 青城派武学
        if JY.Wugong[wugong]['门派'] == 11 then
            -- 青城四秀
            if match_ID(pid, 211) or match_ID(pid, 212) or match_ID(pid, 213) or match_ID(pid, 214) then
                BJ = BJ + 10
            end
            -- 青城长老
            if match_ID(pid, 218) or match_ID(pid, 219) then
                BJ = BJ + 20
            end
            -- 青城掌门
            if match_ID(pid, 220) then
                BJ = BJ + 40
            end
        end
        -- 衡山派武学
        if JY.Wugong[wugong]['门派'] == 12 then
            -- 衡山长老
            if match_ID(pid, 378) or match_ID(pid, 377) or match_ID(pid, 376) then
                BJ = BJ + 20
            end
            -- 衡山掌门
            if match_ID(pid, 379) then
                BJ = BJ + 40
            end
        end
        -- 恒山派武学
        if JY.Wugong[wugong]['门派'] == 13 then
            -- 恒山长老
            if match_ID(pid, 388) or match_ID(pid, 389) or match_ID(pid, 386) then
                BJ = BJ + 20
            end
            -- 恒山掌门
            if match_ID(pid, 21) or match_ID(pid, 387) then
                BJ = BJ + 40
            end
        end
        -- 泰山派武功
        if JY.Wugong[wugong]['门派'] == 14 then
            -- 泰山祖师
            if match_ID(pid, 201) then
                BJ = BJ + 50
            end
            if match_ID(pid, 206) or match_ID(pid, 207) or match_ID(pid, 208) or match_ID(pid, 209) or
                match_ID(pid, 210) then
                BJ = BJ + 20
            end
        end
        -- 血刀门武学
        if JY.Wugong[wugong]['门派'] == 17 then
            -- 血刀高手
            if match_ID(pid, 595) then
                BJ = BJ + 20
            end
        end
        -- 雪山派武学
        if JY.Wugong[wugong]['门派'] == 18 then
            -- 雪山掌门
            if match_ID(pid, 250) or match_ID(pid, 43) then
                BJ = BJ + 40
            end
            -- 雪山长老
            if match_ID(pid, 245) or match_ID(pid, 246) or match_ID(pid, 247) or match_ID(pid, 248) then
                BJ = BJ + 20
            end
        end
        -- 峨眉派武学
        if JY.Wugong[wugong]['门派'] == 19 then
            -- 峨眉掌门
            if match_ID(pid, 6) then
                BJ = BJ + 40
            end
            -- 峨眉长老
            if match_ID(pid, 585) then
                BJ = BJ + 20
            end
        end
        -- 崆峒派武学
        if JY.Wugong[wugong]['门派'] == 20 then
            -- 崆峒掌门
            if match_ID(pid, 359) or match_ID(pid, 8) then
                BJ = BJ + 40
            end
            -- 崆峒长老
            if match_ID(pid, 358) or match_ID(pid, 357) or match_ID(pid, 167) or match_ID(pid, 168) then
                BJ = BJ + 20
            end
        end
        -- 昆仑派武学
        if JY.Wugong[wugong]['门派'] == 21 then
            -- 昆仑掌门
            if match_ID(pid, 7) then
                BJ = BJ + 40
            end
            -- 昆仑长老
            if match_ID(pid, 344) or match_ID(pid, 345) or match_ID(pid, 346) or match_ID(pid, 347) or
                match_ID(pid, 348) or match_ID(pid, 349) then
                BJ = BJ + 20
            end
        end
        -- 八卦门武学
        if JY.Wugong[wugong]['门派'] == 25 then
            -- 八卦高手
            if match_ID(pid, 739) then
                BJ = BJ + 20
            end
            -- 八卦长老
            if match_ID(pid, 722) or match_ID(pid, 737) or match_ID(pid, 740) or match_ID(pid, 741) then
                BJ = BJ + 20
            end
        end
        -- 密宗武学
        if JY.Wugong[wugong]['门派'] == 29 then
            -- 密宗高手 长老
            if match_ID(pid, 644) or match_ID(pid, 645) or match_ID(pid, 753) then
                BJ = BJ + 20
            end
        end
        -- 金乌翠鸣
        if match_ID(pid, 249) then
            if wugong == 61 then
                BJ = BJ + 30
            end
        end

        -- 招式加爆
        for i = 1, JY.Base["武功数量"] do
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 241 and JY.Wugong[yxsy]["招式" .. j] <= 244 then
                            local jl = JY.Wugong[yxsy]["层级"] * 20 + 20
                            BJ = BJ + jl
                        end
                    end
                end
            end
        end
        -- 高暴击武功
        local gbj = {11, 13, 28, 33, 58, 59, 72, 75, 114}
        for i = 1, 9 do
            if wugong == gbj[i] and JLSD(20, 75, pid) then
                WAR.BJ = 1
                break
            end
        end
        if JLSD(0, BJ, pid) then
            WAR.BJ = 1
        end

        if Cat('tx', wugong, '暴击') == 1 then
            WAR.BJ = 1
        end

        -- 碧海招式5必暴击 滴水劲
        if WAR.BHJTZ5 == 1 then
            WAR.BJ = 1
        end
        -- 狄云，
        if match_ID(pid, 37) and PersonKF(pid, 63) then
            WAR.BJ = 1
        end
        -- 装备玄铁剑，配合玄铁剑法
        -- 1级50%暴击率，6级100%
        -- 6级解锁破尽天下，必暴击，无视绝对气防
        if JY.Person[pid]["武器"] == 36 and wugong == 45 then
            if JLSD(0, 40 + JY.Thing[36]["装备等级"] * 10, pid) then
                WAR.BJ = 1
            end
            if JY.Thing[36]["装备等级"] == 6 then
                WAR.PJTX = 1
                Set_Eff_Text(WAR.CurID, "特效文字0", "重剑无锋・破尽天下");
            end
        end
        -- 装备屠龙刀，使用等级为极的刀法，有几率触发两种特效
        if JY.Person[pid]["武器"] == 43 then
            if kfkind == 4 and level == 11 then
                -- 必流血，并追加等同于武功威力的杀气，50%几率优先判定
                if JLSD(25, 75, pid) then
                    WAR.L_TLD = 1;
                    Set_Eff_Text(WAR.CurID, "特效文字0", "武林至尊.宝刀屠龙");
                    -- 如果没有触发，则还有40%几率触发必定暴击
                elseif JLSD(35, 75, pid) then
                    WAR.BJ = 1
                    Set_Eff_Text(WAR.CurID, "特效文字0", "号令天下.莫敢不从");
                end
            end
        end

        if match_ID(pid, 9848) then
            WAR.BJ = 1
        end
        -- 弹指神通，配合桃花绝技，必暴击
        if wugong == 18 and Pmiji(pid, 5) then
            WAR.BJ = 1
        end
        -- 余沧海觉醒后松风剑法必暴击
        if wugong == 27 and (match_ID(pid, 24) or match_ID(pid, 9891)) and JY.Person[0]["六如觉醒"] > 0 then
            WAR.BJ = 1
        end
        -- 傲世神罡
        if match_ID(pid, 9989) then
            WAR.BJ = 1
        end
        -- 无量禅震
        if wugong == 86 and match_ID(pid, 9994) then
            WAR.BJ = 1
        end
        -- 金刚般若 大金刚掌
        if wugong == 22 and Pmiji(pid, 15) then
            WAR.BJ = 1
        end

        if match_ID(pid, 568) and wugong == 198 then
            WAR.BJ = 1
        end
        -- 三花聚顶掌必定不暴击
        if wugong == 115 then
            WAR.BJ = 0
        end
        -- 擒龙手必定不暴击
        if wugong == 187 then
            WAR.BJ = 0
        end
        -- 擒龙手必定不暴击
        if wugong == 188 then
            WAR.BJ = 0
        end
        -- 中平枪法必定不暴击
        if wugong == 70 then
            WAR.BJ = 0
        end

    ----------------暴击伤害写这里---------------------------------     
        -- 暴击率上限100
        if BJ > 100 then
            BJ = 100
        end
        local BJGL = BJ - BJKX
        local BAOJI = 0
        if WAR.BJ == 1 then
            WAR.PD['暴击判定'][eid] = 1
        elseif JLSD(0, BJGL, eid) then
            WAR.PD['暴击判定'][eid] = 1
        end

        -- 如果暴击
        if WAR.PD['暴击判定'][eid] == 1 then
            --内轻特效1009
            if NeiGong_tx(eid,1009)  and JLSD(0,ekfcj_ng*20,eid) then 
                WAR.ACT = 10
                Set_Eff_Text(enemyid, "特效文字2", "止息干戈")
            end
            WAR.Person[enemyid]["特效动画"] = 89 -- 暴击特效动画
            if match_ID(pid, 9755) or match_ID(pid, 539) then -- 乔峰特效文字
                local r = nil
                r = math.random(3)
                if r == 1 then
                    Set_Eff_Text(pid, "特效文字1", "教单于折箭 六军辟易 奋英雄怒");
                elseif r == 2 then
                    Set_Eff_Text(pid, "特效文字1", "虽万千人吾往矣");
                elseif r == 3 then
                    Set_Eff_Text(pid, "特效文字1", "胡汉恩仇 须倾英雄泪");
                end
            end
            -- Set_Eff_Text(enemyid,1,'暴击')      
            local bjsh = 1.5
            local SLWX = 0

            -- 四大恶人
            if match_ID(pid, 9758) then
                bjsh = bjsh + 0.5
            end
            --
            -- 六脉大招
            if WAR.DSP_LM3 == 1 then
                bjsh = bjsh + 0.5
            end
            -- 拔刀
            if JY.Person[pid]['奇穴' .. 44] == 1 then
                if JY.Wugong[wugong]['武功类型'] == 4 then
                    bjsh = bjsh + 0.3
                end
            end
            -- 内轻特效303
            if NeiGong_tx(pid, 303) then
                bjsh = bjsh + dkfcj_ng * 10 / 100
            end
            -- 袁承志志垂日月
            if match_ID(pid, 9816) then
                bjsh = bjsh + 0.1 * JY.Base["天书数量"]
            end
            -- 井月八法
            if PersonKF(pid, 181) then
                for i = 1, JY.Base["武功数量"] do
                    local dfjc = 0
                    if JY.Wugong[JY.Person[pid]['武功' .. i]]['武功类型'] == 4 and
                        JY.Person[pid]['武功等级' .. i] == 999 then
                        dfjc = dfjc + 1
                    end
                    if dfjc >= 8 then
                        bjsh = bjsh + dfjc * 0.02
                        break
                    end
                end
            end
            -- 逆运
            if match_ID(pid, 578) then
                bjsh = bjsh + 0.1
            end

            -- 招式爆伤
            for i = 1, JY.Base["武功数量"] do
                local yxsy = JY.Person[pid]["优先使用"]
                if yxsy > 0 then
                    for j = 1, #CC.KFMove[yxsy] do
                        local zs = CC.WUGONGZS[i][j]
                        local wugong = JY.Person[pid]["武功" .. i]
                        if wugong == yxsy and WAR.WGZS == j then
                            if JY.Wugong[yxsy]["招式" .. j] >= 251 and JY.Wugong[yxsy]["招式" .. j] <= 254 then
                                if JY.Wugong[yxsy]["招式" .. j] == 251 then
                                    bjsh = bjsh + 0.1
                                end
                                if JY.Wugong[yxsy]["招式" .. j] == 252 then
                                    bjsh = bjsh + 0.2
                                end
                                if JY.Wugong[yxsy]["招式" .. j] == 253 then
                                    bjsh = bjsh + 0.3
                                end
                                if JY.Wugong[yxsy]["招式" .. j] == 254 then
                                    bjsh = bjsh + 0.4
                                end
                            end
                        end
                    end
                end
            end
            -- 九逆

            if match_ID(eid, 9995) then
                bjsh = bjsh - 0.2
            end
            -- 黄裳
            if match_ID(eid, 637) then
                -- bjsh = 1
            end

            -- 天佛降世
            if match_ID(eid, 9986) and WAR.PD["复活"][eid] ~= nil then
                bjsh = 1
                Set_Eff_Text(enemyid, "特效文字1", "天佛降世")
            end
            -- 森罗万象
            if Pmiji(eid, 12) then
                WAR.Person[enemyid]["特效动画"] = 6
                Set_Eff_Text(enemyid, "特效文字2", "森罗万象")
                bjsh = 1
            end
            -- 苗若兰
            if match_ID(eid, 545) and JY.Person[pid]["性别"] == 0 then
                bjsh = 1
                Set_Eff_Text(enemyid, "特效文字2", "望雪颦愁")
            end
            -- 仁者无敌
            if match_ID(eid, 9925) and JY.Person[0]["品德"] > 100 then
                bjsh = 1
                Set_Eff_Text(enemyid, "特效文字2", "仁者无敌")
            end
            -- hurtsh = hurtsh + bjsh - 1
            if Pmiji(eid,72)  then 
                bjsh = 0.7
            end
            hurt = hurt * bjsh
            -- 内轻特铲405
            if NeiGong_tx(eid, 405) then
                hurt = hurt * (1 - ekfcj_ng * 15 / 100)
            end

            lib.Debug(JY.Person[eid]["姓名"] .. '受到暴击的伤害' .. hurt)
        end

    --------------------连击伤害计算------------------------------
        if WAR.ACT > 1 then
            --内轻特效1009
            if NeiGong_tx(eid,1009) and JLSD(0,ekfcj_ng*20,eid) then 
                WAR.ACT = 10
                Set_Eff_Text(enemyid, "特效文字2", "止息干戈")
            end
            local LJ_fac = 0.7 -- 通常为70%
            -- 风云再起 张三丰
            -- 六脉神剑，夫妻刀法不减少
            -- 夭矫空碧不减少
            if match_ID(pid, 9765) or wugong == 49 or wugong == 62 or WAR.YNXJ == 1 or match_ID(pid, 5) or
                JY.Person[pid]['门派'] == 9 then
                LJ_fac = 1
                -- 天山双鹰    
            elseif match_ID(pid, 311) or match_ID(pid, 312) and wugong == 4 then
                LJ_fac = 0.85
            end

            if match_ID(eid, 9995) then
                LJ_fac = LJ_fac - 0.2
            end
            -- 内轻特效302 
            if NeiGong_tx(pid, 302) then
                LJ_fac = 1 + dkfcj_ng * 10 / 100
            end
            
            --九阴九阳
            if Pmiji(eid,72)  then 
                LJ_fac = 0.7
            end
            hurt = math.modf(hurt * LJ_fac)
            if NeiGong_tx(pid, 404) then
                hurt = hurt * (1 - dkfcj_ng * 10 / 100)
            end
            lib.Debug(JY.Person[eid]["姓名"] .. '受到连击的伤害' .. hurt)
        end

    --------------------击中破绽伤害计算-------------------------
        if Cat('破绽', enemyid) and hurt > 0 and WAR.Weakspot[eid] ~= nil then
            -- 玄虚劲    
            if Pmiji(eid, 73) then
                hurt = 0
                lib.Debug(JY.Person[eid]["姓名"] .. '玄虚劲' ..'减伤后的伤害'.. hurt)
            else
                local num = 3
                if match_ID(pid, 635) and
                    (JY.Person[pid]["六如觉醒"] > 0 or JY.Person[pid]["实战"] >= 500 or isteam(pid) == false) then
                    num = 6
                end

                local pz_str = "击中破绽";

                if WAR.Weakspot[eid] < num then
                    hurt = math.modf(hurt * 1.25)
                    ang = math.modf(ang * 1.25)
                    if WAR.Weakspot[eid] == 1 then
                        pz_str = "再中破绽";
                    elseif WAR.Weakspot[eid] == 2 then
                        pz_str = "叁中破绽";
                    elseif WAR.Weakspot[eid] == 3 then
                        pz_str = "肆中破绽";
                    elseif WAR.Weakspot[eid] == 4 then
                        pz_str = "伍中破绽";
                    elseif WAR.Weakspot[eid] == 5 then
                        pz_str = "陆中破绽";
                    end
                    WAR.Weakspot[eid] = WAR.Weakspot[eid] + 1
                    Set_Eff_Text(enemyid, 0, pz_str)
                    if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
                        WAR.Person[enemyid]["特效动画"] = 63
                    end
                    lib.Debug(JY.Person[eid]["姓名"] .. '击中破绽后受到的伤害' .. hurt)
                end
            end
        end
    end
    -- hurt2 = limitX (math.modf(math.random(20) + math.modf(true_WL / 10)),math.random(20)+50)
    if WAR.Miss[eid] == 1 then
        hurt = 0
        lib.Debug(JY.Person[eid]["姓名"] .. '触发闪避' ..'减伤后的伤害'.. hurt)
    end
    -- ///////////////////////////加减法计算////////////////////////////////////
    if hurt > 0 then 
        -- 慈悲为怀：道德高于60时，如果伤害大于100减伤（道德-60）点
        if Pmiji(eid, 9) then
            if ((inteam(eid) and JY.Person[eid]['品德'] > 60) or inteam(eid) == false) and hurt > 100 then
                hurt = hurt - 60
                Set_Eff_Text(enemyid, "特效文字2", "慈悲为怀")
                lib.Debug(JY.Person[eid]["姓名"] .. '慈悲为怀' ..'减伤后的伤害'.. hurt)
            end
        end
        -- 内轻特效400
        if NeiGong_tx(eid, 400) then
            hurt = hurt - ekfcj_ng * 50
            lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效400' ..'减伤后的伤害'.. hurt)
        end
        -- 内轻特效1031
        if NeiGong_tx(eid, 1031) then
            local gl = (ekfcj_ng) /10
            local gl1 = ekfcj_ng * 25
            if JLSD(0,gl1,eid) then 
                local reduction = math.modf(hurt * gl)
                hurt = hurt - reduction
                WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid,'内力',-reduction)
                local bhwz;
                if math.random(2) == 1 then
                    bhwz = "八荒六合.唯我独尊"
                else
                    bhwz = "唯我独尊.八荒六合"
                end
                Set_Eff_Text(enemyid, "特效文字3", bhwz)
                lib.Debug(JY.Person[eid]["姓名"] .. '内轻特效1031' ..'减伤后的伤害'.. hurt)
            end
        end
    -----------------------------无视一切降低伤害-------------------------------------

        -- 天人合一
        if WAR.PD['天人合一'][eid] ~= nil and WAR.PD['天人合一'][eid] > 0 then
            hurt = hurt - WAR.PD['天人合一'][eid] * 10
            if hurt <= 0 then
                hurt = 0
            end
            lib.Debug(JY.Person[eid]["姓名"] .. '天人合一' ..'减伤后的伤害'.. hurt)
        end
        --天赋9933
        if match_ID(eid, 9933) then
            local n = JY.Person[eid]["生命最大值"] / 2
            if JY.Person[eid]["生命"] <= n then
                if hurt >= n / 2 then
                    hurt = n / 2
                end
            elseif JY.Person[eid]["生命"] > n then
                if hurt > n then
                    hurt = n
                end
            end
            lib.Debug(JY.Person[eid]["姓名"] .. '天赋9933' ..'减伤后的伤害'.. hurt)
        end


        -- 机敏无双，开场前50时序，受伤害不超过50 天赋9808
        if match_ID(eid, 9808) and WAR.SXTJ <= 50 and hurt > 50 then
            hurt = math.random(40, 50)
            WAR.Person[enemyid]["特效动画"] = 90
            Set_Eff_Text(enemyid, "特效文字1", "机敏无双")
            lib.Debug(JY.Person[eid]["姓名"] .. '天赋9808' ..'减伤后的伤害'.. hurt)
        end




        -- 鹿杖客 天赋9726
        if match_ID(eid, 9726) and WAR.ACT == 1 and JY.Person[pid]["性别"] == 0 and hurt > 0 then
            hurt = 0
            WAR.Person[enemyid]["特效动画"] = 126
            Set_Eff_Text(enemyid, "特效文字0", "江南苟王")
            lib.Debug(JY.Person[eid]["姓名"] .. '天赋9726' ..'减伤后的伤害'.. hurt)
        end

        -- 苗若兰不受连击伤害 天赋545
        if match_ID(eid, 545) and JY.Person[pid]["性别"] == 0 and WAR.ACT > 1 and hurt > 0 then
            hurt = 0
            Set_Eff_Text(enemyid, "特效文字2", "望雪颦愁")
            lib.Debug(JY.Person[eid]["姓名"] .. '天赋545' ..'减伤后的伤害'.. hurt)
        end

        -- 仁者无敌 天赋9925
        if match_ID(eid, 9925) and JY.Person[0]["品德"] > 100 and WAR.ACT > 1 and hurt > 0 then
            hurt = 0
            Set_Eff_Text(enemyid, "特效文字2", "仁者无敌")
            lib.Debug(JY.Person[eid]["姓名"] .. '天赋9925' ..'减伤后的伤害'.. hurt)
        end


        -- 雀母相
        if WAR.PD['三十二身像'][eid] ~= nil then
            if JLSD(0, 20, eid) then
                hurt = 50
                Set_Eff_Text(enemyid, "特效文字2", "雀母相")
                lib.Debug(JY.Person[eid]["姓名"] .. '雀母相' ..'减伤后的伤害'.. hurt)
            end
        end

        -- 不动如山 天赋9874
        if match_ID(eid, 9874) and JLSD(0, 20, eid) then
            local n = hurt - 30
            hurt = 30
            WAR.PD["护盾值"][eid] = n
            Cat('护盾停止', enemyid)
            WAR.Person[enemyid]['护盾'] = 6

            Set_Eff_Text(enemyid, "特效文字2", "不动如山")
            lib.Debug(JY.Person[eid]["姓名"] .. '天赋9874' ..'减伤后的伤害'.. hurt)
        end
        -- 太极图
        if JY.Person[eid]['奇穴' .. 146] == 1 and WAR.TJAY == 4 then
            if hurt > 99 and JLSD(0, 50, eid) then
                hurt = 99
                lib.Debug(JY.Person[eid]["姓名"] .. '奇穴146' ..'减伤后的伤害'.. hurt)
            end
        end
    end
    lib.Debug(JY.Person[eid]["姓名"] .. '无视一切降低伤害' ..' 减伤后的伤害'.. hurt)

    
  ----------------------------------------斩杀伤害 真实伤害----------------------------------------
    -- 天人合一 
    if WAR.PD['天人合一'][pid] ~= nil and WAR.PD['天人合一'][pid] > 0 then
        local zs = WAR.PD['天人合一'][pid] * 10
        hurt = hurt + zs
        lib.Debug('天人合一'..'斩杀伤害=' ..zs..'  hurt= '..hurt )
    end
    if WAR.PD["毗婆舍那"][pid] == 1 then
        JY.Person[eid]["生命最大值"] = JY.Person[eid]["生命最大值"] - JY.Person[eid]["生命最大值"] * 2 / 100
        WAR.PD["毗婆舍那"][pid] = nil
        local zs = JY.Person[eid]["生命"] * 2 / 100
        hurt = hurt + zs
        lib.Debug('毗婆舍那'..'斩杀伤害=' ..zs..'  hurt= '..hurt )
    end
    -- 天魔解体
    if WAR.PD['天魔解体'][pid] ~= nil then
        local zs = JY.Person[eid]['生命最大值'] * 0.05
        hurt = hurt + zs
        lib.Debug('天魔解体'..'斩杀伤害=' ..zs..'  hurt= '..hurt )
    end
    if WAR.PD['意气素霓生'][pid] ~= nil then 
        local smpd = JY.Person[eid]['生命']/JY.Person[eid]['生命最大值']*100
        local zs = 0
        if smpd >= 75 then 
            zs = JY.Person[eid]['生命最大值']*5/100
            hurt = hurt + zs
        elseif smpd >= 50 then 
            zs = JY.Person[eid]['生命最大值']*6/100
            hurt = hurt + zs
        elseif smpd >= 25 then 
            zs = JY.Person[eid]['生命最大值']*7/100
            hurt = hurt + zs
        end
        WAR.PD['意气素霓生'][pid]  = nil
        
        hurt = hurt + zs
        lib.Debug('意气素霓生'..'斩杀伤害=' ..zs..'  hurt= '..hurt )
    end
    -- 如来神掌灭
    -- 须弥山神掌 
    if WAR.PD['如来神掌'][pid] == 2 then
        local zs = JY.Person[eid]["生命"]
        hurt = hurt + zs
        lib.Debug('如来神掌'..'斩杀伤害=' ..zs..'  hurt= '..hurt )
        WAR.PD['如来神掌'][pid] = nil
    end
    -- 般若掌 般若禅掌
    if wugong == 189 then
        if JY.Person[pid]['奇穴' .. 36] == 1 then
            local br = get_skill_power(pid, 189, 10)
            if br > hurt then
                local zs = (br - hurt)
                WAR.PD['般若禅掌'][pid] = 1
                
                hurt = hurt + zs
                lib.Debug('般若禅掌'..'斩杀伤害=' ..zs..'  hurt= '..hurt )
            end
        end
    end

    -- 招式百分比伤害
    for i = 1, JY.Base["武功数量"] do
        local yxsy = JY.Person[pid]["优先使用"]
        if yxsy > 0 then
            for j = 1, #CC.KFMove[yxsy] do
                local zs = CC.WUGONGZS[i][j]
                local wugong = JY.Person[pid]["武功" .. i]
                if wugong == yxsy and WAR.WGZS == j then
                    if JY.Wugong[yxsy]["招式" .. j] >= 371 and JY.Wugong[yxsy]["招式" .. j] <= 374 then
                        local n = JY.Person[eid]["生命最大值"] / 100
                        if JY.Wugong[yxsy]["招式" .. j] == 371 then
                            hurt = hurt + n * 2
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 372 then
                            hurt = hurt + n * 3
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 373 then
                            hurt = hurt + n * 4
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 374 then
                            hurt = hurt + n * 5
                        end
                    end
                end
            end
        end
    end

    -- 解牛刀法
    if wugong == 193 then
        local jl = (1 - JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"]) * 30
        if JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"] < 0.1 and math.random(100) <= jl then
            hurt = hurt + JY.Person[eid]["生命"]
        end
    end

    -- 黯然销魂掌 
    if wugong == 25 and match_ID(pid, 58) then
        local jl = (1 - JY.Person[eid]["生命"] / JY.Person[eid]["生命最大值"]) * 30
        if JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"] * 0.1 and math.random(100) <= jl then
            hurt = hurt + JY.Person[eid]["生命"]
        end
    end

    -- 剑魔BOSS
    if match_ID(eid, 592) and Boss(enemyid) then
        WAR.PD['独孤剑势'][eid] = WAR.PD['独孤剑势'][eid] or 1
        if WAR.PD['独孤剑势'][eid] ~= nil then
            local pxs = {"破掌式", "破指式", "破剑式", "破刀式", "破枪式", "破气式"}
            local wgtype = JY.Wugong[wugong]["武功类型"];
            WAR.PD['独孤破招'][eid] = WAR.PD['独孤破招'][eid] or -1
            -- 重复使用相同的武功攻击时，攻击无效
            if wgtype == WAR.PD['独孤破招'][eid] or wgtype == 6 then
                hurt = 0;
                ang = 0;
                WAR.PD['独孤剑势'][eid] = (WAR.PD['独孤剑势'][eid] or 1) + 1;
            elseif (WAR.PD['独孤破招'][eid] == 1 and wgtype == 2) or
                (WAR.PD['独孤破招'][eid] == 2 and wgtype == 3) or (WAR.PD['独孤破招'][eid] == 3 and wgtype == 4) or
                (WAR.PD['独孤破招'][eid] == 4 and wgtype == 5) or (WAR.PD['独孤破招'][eid] == 5 and wgtype == 1) then
                hurt = math.modf(hurt * (1 - WAR.PD['独孤剑势'][eid] / 10));
                hurt = hurt * 1.2
                if hurt < 0 then
                    hurt = 0;
                end
                WAR.PD['独孤剑势'][eid] = WAR.PD['独孤剑势'][eid] - 1;
            else
                hurt = math.modf(hurt * (1 - WAR.PD['独孤剑势'][eid] / 10));
                ang = 0;
                WAR.PD['独孤剑势'][eid] = WAR.PD['独孤剑势'][eid] + 1;
            end

            -- brolycjw: 改变防御类型
            if wgtype > 0 and wgtype ~= 6 then
                WAR.PD['独孤破招'][eid] = wgtype;
            end

            -- 连击无效，可以左右
            WAR.ACT = 10;
            if WAR.PD['独孤剑势'][eid] <= 1 then
                WAR.PD['独孤剑势'][eid] = 1;
            end

            Set_Eff_Text(enemyid, "特效文字3", pxs[wgtype], 96)

        end
    end

    lib.Debug('斩杀伤害 真实伤害结算' ..' = '..hurt )

    ----------------------------------------特殊状态------------------------------------------- 
    if hurt > 0 then
    ---------------------------混乱统一写这里--------------------------- 
        -- 内轻特效519
        if NeiGong_tx(pid, dkfcj_ng * 15, pid) then
            WAR.PD["混乱状态"][eid] = (WAR.PD["混乱状态"][eid] or 0) + dkfcj_ng * 3
        end
        if match_ID(pid, 9744) and WAR.PD['曲夕烟隙'][pid] == 1 then
            WAR.PD["混乱状态"][eid] = 1
        end
        if WAR.PD["虎啸龙吟"][pid] == 2 then
            for i = 1, WAR.PersonNum do
                if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    local e = WAR.Person[WAR.CurID]["人物编号"]
                    local x1, y1 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
                    local x2, y2 = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
                    if math.abs(x1 - x2) + math.abs(y1 - y2) <= 5 then
                        WAR.PD["混乱状态"][eid] = 1
                    end
                end
            end
        end
        -- 鹤啸九天 标记修改
        if WAR.PD["鹤啸九天"][pid] == 1 then
            for i = 1, WAR.PersonNum do
                if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]["我方"] then
                    local e = WAR.Person[WAR.CurID]["人物编号"]
                    local x1, y1 = WAR.Person[WAR.CurID]["坐标X"], WAR.Person[WAR.CurID]["坐标Y"]
                    local x2, y2 = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
                    if math.abs(x1 - x2) + math.abs(y1 - y2) <= 5 then
                        WAR.PD["混乱状态"][eid] = 1
                    end
                end
            end
        end
        ---------------------------冻结统一写这里---------------------------
        -- 内轻特效506
        if NeiGong_tx(pid, 506) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['冻结'][eid] = (WAR.PD['冻结'][eid] or 0) + dkfcj_ng * 3
            WAR.Person[enemyid]["特效动画"] = 116
        end
        -- 玄冰界
        if JY.Person[eid]['奇穴' .. 80] == 1 and hurt >= JY.Person[eid]["生命"] and WAR.PD['玄冰界'][eid] == nil then
            lib.Debug(JY.Person[eid]['姓名'] .. '触发玄冰界')
            WAR.PD["冻结"][eid] = 30
            if CC.Weather[4][1] > 0 and CC.TX['战斗天气'] == 0  then
                CC.Weather[4][1] = 0
                CC.Weather[2][1] = 300
            end
            WAR.PD['玄冰界'][eid] = 300
            if WAR.Person[enemyid]['护盾'] == nil then
                WAR.Person[enemyid]['护盾'] = 15
            end
        end
        -- 无酒不欢：利刃寒锋，修罗+阴风+沧溟，暴怒造成冻结效果
        if WAR.LiRen == 1 and JLSD(0, 50, pid) then
            WAR.PD["冻结"][eid] = 10
            WAR.Person[enemyid]["特效动画"] = 116
        end

        if WAR.PD['西瓜刀'][pid] == 2 then
            if JY.Person[pid]['内力性质'] == 0 or JY.Person[pid]['内力性质'] == 3 then
                WAR.PD["冻结"][eid] = 10
                WAR.Person[enemyid]["特效动画"] = 116
            end
        end

        -- 白绣
        if match_ID(pid, 582) and JY.Person[eid]["冰封程度"] > 50 and (JLSD(20, 70, pid) or WAR.LQZ[pid] == 100) then
            WAR.PD["冻结"][eid] = 10
            WAR.Person[enemyid]["特效动画"] = 116
        end
        -- 至阴之体
        if JY.Person[pid]['奇穴' .. 80] == 1 then
            --九阴 逆运 寒冰真气 灵犀分水功
            if Curr_NG(pid, 107)  then 
                lib.Debug(JY.Person[pid]['姓名']..'攻击造成'..JY.Person[eid]['姓名']..'冻结10时序')
                if JLSD(0, 30, pid) then
                    WAR.PD["冻结"][eid] = 10
                    WAR.Person[enemyid]["特效动画"] = 116
                    lib.Debug(JY.Person[pid]['姓名']..'攻击造成'..JY.Person[eid]['姓名']..'冻结10时序')
                    for i = 0, WAR.PersonNum - 1 do
                        if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[enemyid]["我方"] then
                            local e = WAR.Person[i]["人物编号"]
                            local x1, y1 = WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]
                            local x2, y2 = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
                            if math.abs(x1 - x2) + math.abs(y1 - y2) <= 5 then
                                WAR.PD['冻结'][e] = 10
                            end
                        end
                    end
                end

            end
        end
        -- 白万剑
        if (match_ID(pid, 43) or match_ID(pid, 9823)) and JY.Person[eid]["冰封程度"] > 50 then
            WAR.PD["冻结"][eid] = 5
            WAR.Person[enemyid]["特效动画"] = 116
        end

        -- 萧秋水攻击冰封大于50的敌人，有60%几率将其冻结5时序
        if match_ID(pid, 652) and JY.Person[eid]["冰封程度"] > 50 and
            (JY.Base["天书数量"] > 1 or isteam(pid) == false) and JLSD(20, 70, pid) then
            WAR.PD["冻结"][eid] = 5
            WAR.Person[enemyid]["特效动画"] = 116
            Set_Eff_Text(enemyid, 3, "月映")
        end
        -- 游坦之攻击冰封大于50的敌人，有60%几率将其冻结10时序
        if (match_ID(pid, 48) or match_ID(pid, 9884)) and JY.Person[eid]["冰封程度"] > 50 and JLSD(20, 80, pid) then
            WAR.PD["冻结"][eid] = 10
            WAR.Person[enemyid]["特效动画"] = 116
            Set_Eff_Text(enemyid, 3, "千年冰蚕・冻结")
        end

        -- 胡一刀装备冷月宝刀攻击冰封大于50的敌人，有60%几率将其冻结10时序
        if match_ID(pid, 633) and JY.Person[pid]["武器"] == 45 and JY.Person[eid]["冰封程度"] > 50 and
            JLSD(20, 80, pid) then
            WAR.PD["冻结"][eid] = 10
            WAR.Person[enemyid]["特效动画"] = 116
            Set_Eff_Text(enemyid, 3, "冷月刀气・冻结")
        end
        -- 下雪天
        if CC.Weather[2][1] > 0 and CC.TX['战斗天气'] == 0  then
            if WAR.PD["冻结"][eid] ~= nil then
                WAR.PD["冻结"][eid] = WAR.PD["冻结"][eid] * 2
            end
        end
    ---------------------------点燃统一写这里----------------------------
        -- 内轻特效505
        if NeiGong_tx(pid, 505) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['点燃'][eid] = (WAR.PD['点燃'][eid] or 0) + dkfcj_ng
            WAR.Person[enemyid]["特效动画"] = 112
        end
        -- 火神君
        if JY.Person[pid]["奇穴" .. 57] == 1 then
            if Curr_NG(pid, 106) or Curr_NG(pid, 93) or Curr_NG(pid, 99) or Curr_NG(pid, 103) then
                if JLSD(0, 30, pid) then
                    WAR.PD['点燃'][eid] = (WAR.PD['点燃'][eid] or 0) + 10
                    Set_Eff_Text(enemyid, 3, "点燃")
                end
            end
        end
        -- 萧秋水攻击燃烧大于50的敌人，将其引燃
        if match_ID(pid, 652)  and JY.Person[eid]["灼烧程度"] >= 50 and
            JY.Base["天书数量"] > 2 and JLSD(20, 70, pid) then
            WAR.PD['点燃'][eid] = math.random(5, 10)
            WAR.Person[enemyid]["特效动画"] = 127
            Set_Eff_Text(enemyid, 3, "日明")
        end
        -- 无酒不欢：举火燎原，金乌+燃木+火焰刀，暴怒造成引燃效果
        if WAR.JuHuo == 1 then
            WAR.PD['点燃'][eid] = math.random(5, 10)
            WAR.Person[enemyid]["特效动画"] = 112
        end

        if WAR.PD['西瓜刀'][pid] == 2 then
            if JY.Person[pid]['内力性质'] == 1 or JY.Person[pid]['内力性质'] == 3 then
                WAR.PD['点燃'][eid] = math.random(5, 10)
                WAR.Person[enemyid]["特效动画"] = 112
            end
        end

        -- 圣火明尊
        if match_ID(pid, 9992) and JY.Person[eid]["灼烧程度"] > 25 then
            WAR.PD['点燃'][eid] = math.random(5, 10)
            WAR.Person[enemyid]["特效动画"] = 112
        end

        if match_ID(pid, 9992) and JY.Person[eid]["灼烧程度"] > 25 then
            for i = 0, WAR.PersonNum - 1 do
                if WAR.Person[i]["死亡"] == false and WAR.Person[i]["我方"] == WAR.Person[enemyid]["我方"] then
                    local e = WAR.Person[i]["人物编号"]
                    local x1, y1 = WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"]
                    local x2, y2 = WAR.Person[i]["坐标X"], WAR.Person[i]["坐标Y"]
                    if math.abs(x1 - x2) + math.abs(y1 - y2) <= 3 then
                        WAR.PD['点燃'][e] = math.random(3, 5)
                    end
                end
            end
        end
    ---------------------------剧毒统一写这里----------------------------
        -- 内轻特效511
        if NeiGong_tx(pid, 511) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['剧毒'][eid] = (WAR.PD['剧毒'][eid] or 0) + dkfcj_ng
        end
        -- 奇门无双
        if JY.Person[pid]['奇穴' .. 72] == 1 then
            local yxsy = JY.Person[pid]["优先使用"]
            local zd = JY.Wugong[yxsy]["层级"]
            local jl = JY.Wugong[yxsy]["层级"] * 2
            if JLSD(0, jl, pid) then
                local zd = JY.Wugong[yxsy]["层级"]
                WAR.PD['剧毒'][eid] = (WAR.PD["剧毒"][eid] or 0) + zd
            end
        end
        -- 大蛇无双
        if WAR.DSWS == 1 then
            WAR.PD['西域奇毒'][eid] = 15
            Set_Eff_Text(enemyid, 3, "西域奇毒")
        end
    ---------------------------撕裂统一写这里---------------------------- 
        -- 内轻特效507
        if NeiGong_tx(pid, 507) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['撕裂'][eid] = (WAR.PD['撕裂'][eid] or 0) + dkfcj_ng * 3
        end
        if WAR.DJD == 1 then
            WAR.PD['撕裂'][eid] = 30
            Set_Eff_Text(enemyid, 3, "撕裂")
        end
        -- 着落六魔
        if match_ID(pid, 314) or match_ID(pid, 315) or match_ID(pid, 315) or match_ID(pid, 315) or match_ID(pid, 315) or
            match_ID(pid, 315) then
            WAR.PD['撕裂'][eid] = (WAR.PD["撕裂"][eid] or 0) + 10
            Set_Eff_Text(enemyid, 3, "撕裂")
        end
        -- 虎爪绝户手
        if WAR.HZJHS == 1 then
            lib.Delay(40)
            if JY.Person[eid]["性别"] == 0 then
                lib.FillColor(0, 0, CC.ScreenW, CC.ScreenH, C_RED, 128)
                ShowScreen()
                JY.Person[eid]["性别"] = 2
                JY.Person[eid]["半身像"] = 721
                JY.Person[eid]["头像代号"] = 27
                Set_Eff_Text(enemyid, 2, "鸡飞蛋打")
                WAR.PD['撕裂'][eid] = 50
            end
        end
        -- 青莲剑歌 撕裂
        if WAR.QLJG == 1 then
            WAR.PD['撕裂'][eid] = 60
            if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
                WAR.Person[enemyid]["特效动画"] = 80
            end
            Set_Eff_Text(enemyid, 3, "撕裂")
        end
    ---------------------------虚弱统一写这里----------------------------
        -- 内轻特效507
        if NeiGong_tx(pid, 507) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['虚弱状态'][eid] = (WAR.PD['虚弱状态'][eid] or 0) + dkfcj_ng
        end
        -- 钟氏三雄
        if match_ID(pid, 745) or match_ID(pid, 746) or match_ID(pid, 747) then
            if JLSD(0, 20, eid) then
                WAR.PD["虚弱状态"][eid] = 20
                Set_Eff_Text(enemyid, 3, "虚弱")
            end
        end
        -- 商夫人八卦游龙
        if match_ID(pid, 737) and wugong == 231 then
            WAR.PD["虚弱状态"][eid] = 20
            Set_Eff_Text(enemyid, 3, "虚弱")
        end
    ---------------------------散功统一写这里----------------------------
        -- 内轻特效508
        if NeiGong_tx(pid, 508) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['散功状态'][eid] = (WAR.PD['散功状态'][eid] or 0) + dkfcj_ng * 3
            Set_Eff_Text(enemyid, 3, "散功")
        end
        -- 商剑鸣八卦游龙
        if match_ID(pid, 722) and wugong == 230 then
            WAR.PD["散功状态"][eid] = 20
            Set_Eff_Text(enemyid, 3, "散功")
        end
        -- 梅花三弄1
        if WAR.MHSN == 1 and WAR.ACT == 1 then
            WAR.PD["散功状态"][eid] = 20
            Set_Eff_Text(enemyid, 3, "散功")
        end
        -- 苗人凤指令 破军
        if match_ID(pid, 3) then
            WAR.PD["散功状态"][eid] = 10
            Set_Eff_Text(enemyid, 3, "散功")
        end
    ---------------------------破甲统一写这里----------------------------
        -- 内轻特效510
        if NeiGong_tx(pid, 510) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['破甲状态'][eid] = (WAR.PD['破甲状态'][eid] or 0) + dkfcj_ng
        end
        -- 破甲状态
        if WAR.NZZ1 == 1 then
            WAR.PD["破甲状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "破甲状态")
        end
    ---------------------------破绽统一写这里----------------------------
        -- 内轻特效512
        if NeiGong_tx(pid, 512) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['破绽'][eid] = (WAR.PD['破绽'][eid] or 0) + dkfcj_ng
        end
    ---------------------------集气紊乱统一写这里-------------------------   
        -- 神鲸歌
        if WAR.JXG_SJG == 1 then
            WAR.PD["紊乱状态"][eid] = 20
            Set_Eff_Text(enemyid, 3, "紊乱状态")
        end

        -- 混元一气
        if WAR.HYYQ == 1 then
            WAR.PD["紊乱状态"][eid] = math.random(5, 15)
            Set_Eff_Text(enemyid, 3, "紊乱状态")
        end

        -- 被灵蛇拳击中
        if WAR.OYK == 1 then
            WAR.PD["紊乱状态"][eid] = 20
            Set_Eff_Text(enemyid, 3, "紊乱状态")
        end
        -- 内轻特效521
        if NeiGong_tx(pid, 521) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['紊乱状态'][eid] = (WAR.PD['紊乱状态'][eid] or 0) + dkfcj_ng * 2
            Set_Eff_Text(enemyid, 3, "紊乱状态")
        end

    ---------------------------锁足统一写这里---------------------------- 
        -- 定乾坤
        if match_ID(pid, 9756) then
            WAR.PD["定乾坤"][eid] = 100
            WAR.Person[enemyid]["特效动画"] = 198
            Set_Eff_Text(enemyid, 3, "定乾坤")
        end
        -- 内轻特效522
        if NeiGong_tx(pid, 522) and JLSD(0, dkfcj_ng * 15, pid) then
            WAR.PD['锁足状态'][eid] = WAR.PD['锁足状态'][eid] or 0 + 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
        -- 云罗天网 锁足
        if WAR.YLTW == 1 and JLSD(20, 70, pid) then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
        -- 光君
        if JY.Person[pid]['奇穴' .. 125] == 1 and Curr_NG(pid, 204) then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
        -- 定神门
        if Pmiji(pid, 72) then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
        -- 鳌拜满洲摔跤，下回合不可移动
        if match_ID(pid, 9915) and wugong == 119 and WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
        -- 绝情谷众
        for p = 618, 625 do
            if match_ID(pid, p) and JLSD(0, 20, pid) then
                WAR.PD["锁足状态"][eid] = 1
                Set_Eff_Text(enemyid, 3, "锁足")
            end
        end
        -- 野球拳 锁足
        if WAR.PD['野球拳'][pid] == 3 and JLSD(0, 40, pid) then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end

        if WAR.PD['绊字决'][pid] == 1 then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end

        -- 金蛇缠丝手
        if match_ID(pid, 9961) and JLSD(0, 30, pid) then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
        -- 桃谷七仙
        local tglx = {143, 144, 145, 146, 147, 148}
        for i = 1, #tglx do
            if match_ID(pid, tglx[i]) and JY.Wugong[wugong]["武功类型"] == 2 then
                WAR.PD["锁足状态"][eid] = 1
                Set_Eff_Text(enemyid, 3, "锁足")
            end
        end
        -- 奇门无双
        if JY.Person[pid]['奇穴' .. 72] == 1 then
            WAR.PD["锁足状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "锁足")
        end
    -----------------------减集气统一写这里-----------------------------
        -- 鹤啸九天 标记修改
        if WAR.PD["鹤啸九天"][pid] == 1 then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and
                    eid == WAR.Person[j]["人物编号"] then
                    WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300
                end
            end
        end

        if WAR.PD["虎啸龙吟"][pid] == 1 then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.Person[j]["死亡"] == false and
                    eid == WAR.Person[j]["人物编号"] then
                    WAR.Person[j].TimeAdd = WAR.Person[j].TimeAdd - 300
                end
            end
        end
        -- 被无招胜有招击中
        -- 黄衫女 广寒清辉
        if WAR.FQY == 1 or WAR.GHQH == 1 then
            if WAR.PD["无招胜有招"][eid] == nil then
                WAR.PD["无招胜有招"][eid] = 10
            end
            if WAR.PD["无招胜有招"][eid] > 10 then
                WAR.PD["无招胜有招"][eid] = 10
            end
        end

        -- 被梁萧谐之道击中
        if WAR.LXXZD == 1 then
            if WAR.PD["无招胜有招"][eid] == nil then
                WAR.PD["无招胜有招"][eid] = 10
            end
            if WAR.PD["无招胜有招"][eid] > 10 then
                WAR.PD["无招胜有招"][eid] = 10
            end
        end
        -- 九字真言
        if WAR.PD["列"][pid] ~= nil and WAR.PD["列"][pid] == 1 then
            WAR.PD["麻痹状态"][eid] = 3
            Set_Eff_Text(enemyid, 3, "麻痹")
        end
        if WAR.DHBUFF == 1 then
            WAR.PD["洞火"][eid] = 1
            Set_Eff_Text(enemyid, 3, "洞火")
        end
        if WAR.PD['缠字决'][pid] == 1 then
            if WAR.PD["迟缓状态"][eid] == nil then
                WAR.PD["迟缓状态"][eid] = 20
            else
                WAR.PD["迟缓状态"][eid] = WAR.PD["迟缓状态"][eid] + 20
            end
            if WAR.PD["迟缓状态"][eid] > 20 then
                WAR.PD["迟缓状态"][eid] = 20
            end
            Set_Eff_Text(enemyid, 3, "迟缓")
        end
        -- 被冰蚕毒掌击中 标记修改减少敌人集气
        if WAR.YTZ == 1 then
            if WAR.PD["冰冻状态"][eid] == nil then
                WAR.PD["冰冻状态"][eid] = math.random(1, 3)
            else
                WAR.PD["冰冻状态"][eid] = WAR.PD["冰冻状态"][eid] + math.random(1, 3)
                if WAR.PD["冰冻状态"][eid] > 50 then
                    WAR.PD["冰冻状态"][eid] = 50
                end
            end
        end

    ---------------------------昏迷统一写这里---------------------------
        -- 金轮，十龙十象蓄力
        if WAR.PD["十龙十象"][pid] ~= nil then
            WAR.PD["昏迷状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "昏迷")
        end
        -- 雷动九天
        if WAR.LQZ[pid] == 100 and WAR.PD["雷音状态"][eid] ~= nil and WAR.PD["雷音状态"][eid] >= 3 then
            WAR.PD["昏迷状态"][eid] = 1
            WAR.WAR.PD["雷音状态"][eid] = nil
            Set_Eff_Text(enemyid, 3, "昏迷")
        end
        if WAR.SL23 == 1 and JLSD(20, 50, pid) then
            WAR.PD["昏迷状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "昏迷")
        end

        -- 卓天雄震天铁掌
        if match_ID(pid, 613) and wugong == 205 and JLSD(10, 20, pid) then
            WAR.PD["昏迷状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "昏迷")
        end
        if WAR.PD['降龙・震惊百里'][pid] == 1 then
            WAR.PD["昏迷状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "昏迷")
        end
    ---------------------------恐惧统一写这里----------------------------
        if WAR.PD['放下屠刀'][pid] ~= nil then 
            WAR.PD["恐惧状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "恐惧")
        end
        if WAR.PD['封字决'][pid] == 1 then
            WAR.PD["恐惧状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "恐惧")
        end
        --君王          
        if WAR.PD['君王'][eid] ~= nil and WAR.PD['君王'][eid] == 1 then 
            Set_Eff_Text(enemyid, 0, "君王")
            for i = 0,WAR.PersonNum- 1 do 
                if  WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[enemyid]['我方']  then 
                    WAR.PD['恐惧状态'][WAR.Person[i]['人物编号']] = 1
                end
            end
            WAR.PD['君王'][eid] = nil
        end
        -- 黯然销魂掌
        if WAR.PD['黯然・行尸走肉'][pid] == 1 then
            WAR.PD["恐惧状态"][eid] = 1
            WAR.PD['黯然・行尸走肉'][pid] = nil
        end
    ---------------------------盲目统一写这里----------------------------
        ---- 内轻特效520 辟邪刺目，100%MISS
        if WAR.PD['刺目'][pid] ~= nil and WAR.PD['刺目'][pid] > 0 and JY.Person[eid]['健康'] ~= 1 then
            WAR.PD["盲目状态"][eid] = (WAR.PD["盲目状态"][eid] or 0) + 1
            Set_Eff_Text(enemyid, 3, "盲目")
        end
        if WAR.PD['戳字决'][pid] == 1 and JLSD(0, 40, pid) then
            WAR.PD["盲目状态"][eid] = 1
        end

        if WAR.PD['野球拳'][pid] == 2 and JLSD(0, 40, pid) then
            WAR.PD["盲目状态"][eid] = 1
        end
    ---------------------------减移动写这里-----------------------------
        -- 内轻特效523
        if NeiGong_tx(pid, 523) and JLSD(0, dkfcj_ng * 25, pid) then
            WAR.PD['缓步'][eid] = (WAR.PD['缓步'][eid] or 0) + dkfcj_ng
        end
    ---------------------------其它特效 多个状态------------------------- 
        -- 六脉大招4
        if WAR.DSP_LM4 == 1 then
            local lm4 = math.random(3)
            if lm4 == 1 then
                WAR.PD["昏迷状态"][eid] = 1
                Set_Eff_Text(enemyid, 3, "昏迷")
            end
            if lm4 == 2 then
                WAR.PD["锁足状态"][eid] = 1
            end
            if lm4 == 3 then
                WAR.PD["破甲状态"][eid] = 1
            end
        end
        -- 辰宿列张
        if PersonKF(pid, 138) or PersonKF(pid, 265) then
            if WAR.PD["参合状态"][eid] == nil then
                WAR.PD["参合状态"][eid] = 1
            else
                WAR.PD["参合状态"][eid] = WAR.PD["参合状态"][eid] + 1
                if WAR.PD["参合状态"][eid] > 3 then
                    WAR.PD["参合状态"][eid] = 3
                end
            end
            Set_Eff_Text(enemyid, 0, "参合", 72)
        end
        --内轻特效919
        if NeiGong_tx(pid,919) and JLSD(0,dkfcj_ng,pid) then 
            WAR.PD['卸甲状态'][eid] = (WAR.PD['卸甲状态'][eid] or 0 ) + 1
        end
        --内轻特效920
        if NeiGong_tx(pid,920) and JLSD(0,dkfcj_ng,pid) then 
            WAR.PD['突防状态'][eid] = (WAR.PD['突防状态'][eid] or 0 ) + 1
        end
        -- 招式上状态
        for i = 1, JY.Base["武功数量"] do
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == yxsy and WAR.WGZS == j then
                        -- 7招式冻结
                        if JY.Wugong[yxsy]["招式" .. j] >= 71 and JY.Wugong[yxsy]["招式" .. j] <= 74 and hurt > 30 then
                            local dr = JY.Wugong[yxsy]["层级"] * 5
                            WAR.PD["冻结"][eid] = (WAR.PD["冻结"][eid] or 0) + dr
                            Set_Eff_Text(enemyid, 3, "冻结")
                        end
                        -- 8招式点燃
                        if JY.Wugong[yxsy]["招式" .. j] >= 81 and JY.Wugong[yxsy]["招式" .. j] <= 84 and hurt > 30 then
                            local dr = JY.Wugong[yxsy]["层级"] * 5
                            WAR.PD['点燃'][eid] = (WAR.PD['点燃'][eid] or 0) + dr
                            Set_Eff_Text(enemyid, 3, "点燃")
                        end
                        -- 招式剧毒
                        if JY.Wugong[yxsy]["招式" .. j] >= 91 and JY.Wugong[yxsy]["招式" .. j] <= 94 and hurt > 30 then
                            local zd = JY.Wugong[yxsy]["层级"]
                            WAR.PD['剧毒'][eid] = (WAR.PD["剧毒"][eid] or 0) + zd
                            Set_Eff_Text(enemyid, 3, "剧毒")
                        end
                        -- 招式晕眩
                        if JY.Wugong[yxsy]["招式" .. j] >= 101 and JY.Wugong[yxsy]["招式" .. j] <= 104 and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 20
                            if JLSD(0, jl, pid) then
                                WAR.PD["昏迷状态"][eid] = 1
                                Set_Eff_Text(enemyid, 3, "昏迷")
                            end
                        end
                        -- 招式撕裂
                        if JY.Wugong[yxsy]["招式" .. j] >= 111 and JY.Wugong[yxsy]["招式" .. j] <= 114 and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 20
                            if JLSD(0, jl, pid) then
                                WAR.PD['撕裂'][eid] = (WAR.PD["撕裂"][eid] or 0) + 10
                                Set_Eff_Text(enemyid, 3, "撕裂")
                            end
                        end
                        -- 招式虚弱
                        if JY.Wugong[yxsy]["招式" .. j] >= 121 and JY.Wugong[yxsy]["招式" .. j] <= 124 and hurt > 30 then
                            WAR.PD["破甲状态"][eid] = 1
                            Set_Eff_Text(enemyid, 3, "破甲状态")
                        end
                        -- 招式再次行动
                        if JY.Wugong[yxsy]["招式" .. j] >= 211 and JY.Wugong[yxsy]["招式" .. j] <= 214 and
                            WAR.PD["招式・再次行动"][pid] == nil and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 4
                            if WAR.PD['招式・再动概率'][pid] ~= nil then
                                jl = jl / (WAR.PD['招式・再动概率'][pid] + 1)
                            end
                            if JLSD(0, jl, pid) then
                                WAR.PD["招式・再次行动"][pid] = 1
                                WAR.PD['招式・再动概率'][pid] = WAR.PD['招式・再动概率'][pid] or 0 + 1
                            end
                        end
                        -- 招式集气加速
                        if JY.Wugong[yxsy]["招式" .. j] >= 221 and JY.Wugong[yxsy]["招式" .. j] <= 224 and hurt > 30 then
                            if JY.Wugong[yxsy]["招式" .. j] == 221 then
                                WAR.PD["招式・集气加速1"][pid] = 2
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 222 then
                                WAR.PD["招式・集气加速2"][pid] = 2
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 223 then
                                WAR.PD["招式・集气加速3"][pid] = 2
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 224 then
                                WAR.PD["招式・集气加速4"][pid] = 2
                            end
                        end
                        -- 招式回气
                        if JY.Wugong[yxsy]["招式" .. j] >= 281 and JY.Wugong[yxsy]["招式" .. j] <= 284 and hurt > 30 then
                            if JY.Wugong[yxsy]["招式" .. j] == 281 then
                                local nl = 1
                                AddPersonAttrib(pid, '能量', nl)
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 282 then
                                local nl = math.random(1, 2)
                                AddPersonAttrib(pid, '能量', nl)
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 283 then
                                local nl = math.random(2, 3)
                                AddPersonAttrib(pid, '能量', nl)
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 284 then
                                local nl = math.random(3, 4)
                                AddPersonAttrib(pid, '能量', nl)
                            end

                        end
                        -- 招式锁足
                        if JY.Wugong[yxsy]["招式" .. j] >= 291 and JY.Wugong[yxsy]["招式" .. j] <= 294 and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 15
                            if JLSD(0, jl, pid) then
                                WAR.PD["锁足状态"][eid] = 1
                                Set_Eff_Text(enemyid, 3, "锁足")
                            end
                        end

                        -- 招式反击
                        if JY.Wugong[yxsy]["招式" .. j] >= 301 and JY.Wugong[yxsy]["招式" .. j] <= 304 and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 10
                            if JLSD(0, jl, pid) then
                                WAR.PD["刺猬状态"][pid] = 2
                            end
                        end
                        -- 招式格挡
                        if JY.Wugong[yxsy]["招式" .. j] >= 311 and JY.Wugong[yxsy]["招式" .. j] <= 314 and hurt > 30 then
                            local gd = 0
                            gd = JY.Wugong[yxsy]["层级"] * 100
                            WAR.PD["格挡状态"][pid] = gd
                        end

                        -- 招式散功
                        if JY.Wugong[yxsy]["招式" .. j] >= 331 and JY.Wugong[yxsy]["招式" .. j] <= 334 and hurt > 30 then
                            local sg1 = JY.Wugong[yxsy]["层级"] * 5
                            local sg2 = (JY.Wugong[yxsy]["层级"] + 1) * 5
                            WAR.PD["散功状态"][eid] = (WAR.PD["散功状态"][eid] or 0) + math.random(sg1, sg2)
                            Set_Eff_Text(enemyid, 3, "散功")
                        end
                        -- 招式外伤
                        if JY.Wugong[yxsy]["招式" .. j] >= 341 and JY.Wugong[yxsy]["招式" .. j] <= 344 and hurt > 30 then
                            if JY.Wugong[yxsy]["招式" .. j] == 341 then
                                WAR.PD["外伤状态1"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 342 then
                                WAR.PD["外伤状态2"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 343 then
                                WAR.PD["外伤状态3"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 344 then
                                WAR.PD["外伤状态4"][eid] = 3
                            end
                            Set_Eff_Text(enemyid, 3, "外伤")
                        end
                        -- 招式混乱
                        if JY.Wugong[yxsy]["招式" .. j] >= 351 and JY.Wugong[yxsy]["招式" .. j] <= 354 and hurt > 30 then
                            local hl = (JY.Wugong[yxsy]["层级"] + 1) * 3 - 1
                            WAR.PD["紊乱状态"][eid] = (WAR.PD["紊乱状态"][eid] or 0) + hl
                            Set_Eff_Text(enemyid, 3, "混乱")
                        end
                        -- 招式恐惧
                        if JY.Wugong[yxsy]["招式" .. j] >= 361 and JY.Wugong[yxsy]["招式" .. j] <= 364 and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 10
                            if JLSD(0, jl, pid) then
                                WAR.PD["恐惧状态"][eid] = 1
                                Set_Eff_Text(enemyid, 3, "恐惧")
                            end
                        end
                        -- 招式盲目
                        if JY.Wugong[yxsy]["招式" .. j] >= 381 and JY.Wugong[yxsy]["招式" .. j] <= 384 and hurt > 30 then
                            local jl = JY.Wugong[yxsy]["层级"] * 10
                            if JLSD(0, jl, pid) then
                                WAR.PD["盲目状态"][eid] = 2
                                Set_Eff_Text(enemyid, 3, "盲目")
                            end
                        end
                        -- 招式迟缓
                        if JY.Wugong[yxsy]["招式" .. j] >= 391 and JY.Wugong[yxsy]["招式" .. j] <= 394 and hurt > 30 then
                            local ch = JY.Wugong[yxsy]["层级"] * 3
                            WAR.PD["迟缓状态"][eid] = (WAR.PD["迟缓状态"][eid] or 0) + ch
                            Set_Eff_Text(enemyid, 3, "迟缓")
                        end
                    end
                end
            end
        end
        if WAR.PD['黯然・六神不安'][pid] == 1 then
            WAR.PD["紊乱状态"][eid] = 20
            WAR.PD["混乱状态"][eid] = 1
            WAR.PD['黯然・六神不安'][pid] = nil
        end
        -- 般若掌 一空到底
        if WAR.YKDD == 1 then
            WAR.PD["一空到底"][eid] = 10
            Set_Eff_Text(enemyid, 3, "一空到底")
        end


        if WAR.PD['黯然・饮恨吞声'][pid] == 1 then
            WAR.PD["同归状态"][eid] = 1
            WAR.PD['黯然・饮恨吞声'][pid] = nil
        end

        -- 被杨逍击中的人，伤害增加1%，上限20%
        if match_ID(pid, 9788) or match_ID(pid, 11) then
            WAR.GMZS[eid] = (WAR.GMZS[eid] or 0) + 2
            if WAR.GMZS[eid] > 40 then
                WAR.GMZS[eid] = 40
            end
        end

        -- 先天罡气清蓄力
        --内轻特效924
        --if PersonKF(pid, 100) then
        if NeiGong_tx(pid,924) and JLSD(0,dkfcj_ng*25,pid) then 
            WAR.PD["先天罡气"][pid] = 1
            if WAR.PD["蓄气值"][eid] ~= nil or WAR.PD["蛤蟆蓄力"][eid] ~= nil or WAR.PD["鲸息蓄力"][eid] ~= nil then
                if WAR.Person[enemyid]["特效动画"] == nil or WAR.Person[enemyid]["特效动画"] == -1 then
                    WAR.Person[enemyid]["特效动画"] = 80
                end
                Set_Eff_Text(enemyid, 3, "罡气破力")
            end
        end
        -- 被虚竹生死符击中的
        if WAR.TZ_XZ == 1 or (WAR.PD['生死符绝学'][pid] ~= nil and JLSD(0, 20, eid)) then
            WAR.PD["生死符"][eid] = 1
            Set_Eff_Text(enemyid, 2, "生死符")
            WAR.Person[enemyid]["特效动画"] = 72
            WAR.PD['生死符绝学'][pid] = nil
        end
        -- 放下屠刀
        if match_ID(pid, 9875) and JLSD(0, 30, pid) then
            WAR.PD['放下屠刀'][eid] = 1
        end

        -- 一灯用一阳指，无明业火
        if match_ID(pid, 65) and wugong == 17 then
            WAR.PD["无名业火"][eid] = 30
            Set_Eff_Text(enemyid, 3, "无名业火")
        end

        -- 判官笔封穴
        if JY.Person[pid]["武器"] == 53 then
            local jl = JY.Thing[53]["装备等级"] * 5
            local fx = math.random(2, 8)
            if match_ID(pid, 101) then
                fx = math.random(4, 10)
            end
            if JLSD(0, jl, eid) then
                WAR.PD["判官笔封穴"][eid] = fx
            end
        end
        -- 王重阳1  同归剑气，
        if match_ID(pid, 129) then
            WAR.PD["同归状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "同归")
        end


        -- 黄衫女天罗地网觉醒增加疾风状态
        if Curr_QG(pid, 148) and match_ID(pid, 9728) then
            if WAR.PD["疾风劲"][pid] == nil then
                WAR.PD["疾风劲"][pid] = math.random(2)
            else
                WAR.PD["疾风劲"][pid] = WAR.PD["疾风劲"][pid] + math.random(3)
                if WAR.PD["疾风劲"][pid] > 10 then
                    WAR.PD["疾风劲"][pid] = 10
                end
            end
        end

        -- 逍遥御风 and JLSD(20,70,eid)
        if XiaoYaoYF(eid) and (WAR.PD["逍遥御风"][eid] == nil or WAR.PD["逍遥御风"][eid] < 9) and WAR.YFCS < 3 and WAR.PD['逍遥御风闪避'][eid] == nil then
            WAR.YFCS = WAR.YFCS + 1
            WAR.PD["逍遥御风"][eid] = (WAR.PD["逍遥御风"][eid] or 0) + 1
            Set_Eff_Text(enemyid, 2, "逍遥御风")
            if WAR.PD["逍遥御风"][eid] == 9 then
                WAR.PD["逍遥御风"][eid] = 11
                WAR.XYYF_10 = 1
                WAR.Person[enemyid]["特效动画"] = 153
                WAR.PD['逍遥御风闪避'][eid] = 15
            end
        end

        -- 走火入魔
        if WAR.PD["走火状态"][eid] ~= 1 and match_ID(eid, 9858) and Curr_NG(eid, 104) then
            if JY.Person[eid]["体力"] > 50 then
                WAR.Person[enemyid]["特效动画"] = math.fmod(wugong, 10) + 85
                Set_Eff_Text(enemyid, "特效文字3", "真--逆运筋脉走火入魔")
                WAR.PD["走火状态"][eid] = 1
            end
        end

        -- 娇美人妻降低攻击方体力
        if match_ID(eid, 9789) then
            WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", -math.random(5, 10))
        end

        -- 大周天功 养生主
        if WAR.PD["养生主"][eid] == nil then
            local jl = 50
            local pd = false
            if Curr_NG(eid, 190) then
                pd = true
            end
            if JY.Person[eid]['奇穴' .. 135] == 1 then
                jl = jl * 2
            end
            if JLSD(0, jl, eid) and pd == true then
                WAR.PD["养生主"][eid] = 50
                Set_Eff_Text(enemyid, 1, "养生主")
            end
        end

        -- 内轻特效1029，60%几率累积太极之形
        if NeiGong_tx(eid, 1029) and JLSD(20, 80, eid) then
            WAR.PD["太极之形"][eid] = (WAR.PD["太极之形"][eid] or 0) + 1
            if WAR.PD["太极之形"][eid] > 10 then
                WAR.PD["太极之形"][eid] = 10
            end
            Set_Eff_Text(enemyid, 3, "太极之形")
        end

        -- 司空摘星千变万幻
        if match_ID(eid, 9740) then
            WAR.SKZX[eid] = (WAR.SKZX[eid] or 0) + 2
            Set_Eff_Text(enemyid, 3, "千变万幻")
        end

        -- 雷动九天
        if WAR.LDJT == 1 then
            if WAR.PD["雷音状态"][eid] == nil then
                WAR.PD["雷音状态"][eid] = 1
            else
                WAR.PD["雷音状态"][eid] = WAR.PD["雷音状态"][eid] + 1
                if WAR.PD["雷音状态"][eid] > 3 then
                    WAR.PD["雷音状态"][eid] = 3
                end
            end
        end

        -- 一剑无血
        if match_ID(pid, 150) then
            WAR.PD["无血状态"][eid] = 1
        end

        if JY.Person[pid]['门派'] == 29 then
            WAR.PD['密宗印记'][eid] = WAR.PD['密宗印记'][eid] or 0 + 1
            Set_Eff_Text(enemyid, 3, "密宗印记")
        end

        -- 何太冲，攻击时60%几率附加琴音状态，上限20层
        if match_ID(pid, 9819) then
            if WAR.PD["琴音状态"][eid] == nil then
                WAR.PD["琴音状态"][eid] = math.random(3)
            else
                WAR.PD["琴音状态"][eid] = WAR.PD["琴音状态"][eid] + math.random(3)
                if WAR.PD["琴音状态"][eid] > 20 then
                    WAR.PD["琴音状态"][eid] = 20
                end
            end
            Set_Eff_Text(enemyid, 0, "铁琴琴音", 63)
        end

        -- 范遥挨打加减伤，上限20%
        if (match_ID(eid, 10)) and WAR.GMYS < 20 then
            WAR.GMYS = WAR.GMYS + 1
        end

        -- 招式效果
        for i = 1, JY.Base["武功数量"] do
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == yxsy and WAR.WGZS == j then
                        -- 招式减防
                        if JY.Wugong[yxsy]["招式" .. j] >= 171 and JY.Wugong[yxsy]["招式" .. j] <= 174 then
                            if JY.Wugong[yxsy]["招式" .. j] == 171 then
                                WAR.PD["招式减防1"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 172 then
                                WAR.PD["招式减防2"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 173 then
                                WAR.PD["招式减防3"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 174 then
                                WAR.PD["招式减防4"][eid] = 3
                            end
                            -- Set_Eff_Text(enemyid, 3, "招式减防")
                        elseif JY.Wugong[yxsy]["招式" .. j] > 260 and JY.Wugong[yxsy]["招式" .. j] < 265 then
                            local gl = JY.Wugong[yxsy]["层级"] * 20 + 20
                            local bf = 100
                            lib.Debug('必中概率' .. gl .. '/' .. bf)
                            if JLSD(0, gl, pid) then
                                WAR.PD["招式必中"][pid] = 1
                            end
                        end
                    end
                end
            end
        end

        -- 招式减攻
        for i = 1, JY.Base["武功数量"] do
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 181 and JY.Wugong[yxsy]["招式" .. j] <= 184 then
                            if JY.Wugong[yxsy]["招式" .. j] == 181 then
                                WAR.PD["招式减攻1"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 182 then
                                WAR.PD["招式减攻2"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 183 then
                                WAR.PD["招式减攻3"][eid] = 3
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 184 then
                                WAR.PD["招式减攻4"][eid] = 3
                            end
                            Set_Eff_Text(enemyid, 3, "招式减攻")
                        end
                    end
                end
            end
        end
        -- 内轻特效805
        if NeiGong_tx(eid, 805) and WAR.Defup[eid] == nil and JLSD(0, ekfcj_ng * 20, eid) then
            local s = WAR.CurID
            WAR.CurID = enemyid
            WarDrawMap(0)
            War_DefupMenu()
            WAR.CurID = s
        end
        -- 蛤蟆功蓄力
        if Curr_NG(eid, 95) then
            if WAR.PD["蛤蟆蓄力"][eid] == nil or WAR.PD["蛤蟆蓄力"][eid] == 0 then
                WAR.PD["蛤蟆蓄力"][eid] = 50;
            else
                WAR.PD["蛤蟆蓄力"][eid] = WAR.PD["蛤蟆蓄力"][eid] + 35;
            end
            Set_Eff_Text(enemyid, 2, "蛤蟆功蓄力")
        end

        -- 陆渐海之道
        if match_ID(eid, 497) and JY.Base["天书数量"] > 6 then
            WAR.HZD_2 = 1
            Set_Eff_Text(enemyid, 1, "海纳百川")
            WAR.Person[enemyid]["特效动画"] = 111
        end

        -- 阿九 凤凰涅
        if match_ID_awakened(eid, 629, 1) and (JLSD(20, 70, eid) or WAR.LQZ[eid] == 100) then
            WAR.FGPZ[eid] = 1
            WAR.Person[enemyid]["特效动画"] = 154
            Set_Eff_Text(enemyid, 1, "凤凰涅")
        end

        -- 除却四相，50%几率免疫本次攻击造成的内伤/封穴/冰封/灼烧
        if Pmiji(eid, 37) and JLSD(20, 70, eid) then
            -- WAR.PD['吸星真气'][eid] = (WAR.PD['吸星真气'][eid] or 0) + 40
            WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + 40
            WAR.CQSX = 1
            WAR.Person[enemyid]["特效动画"] = 79
            Set_Eff_Text(enemyid, 2, "无我相")
        end

        -- 除却四相，50%几率无视敌方武常
        if Pmiji(eid, 37) and JLSD(20, 70, eid) then
            -- WAR.PD['吸星真气'][eid] = (WAR.PD['吸星真气'][eid] or 0) + 40
            WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + 40
            WAR.CQSX_WZSX = 1
            Set_Eff_Text(enemyid, 2, "无众生相")
        end

        -- 三丰其徐如林
        if (match_ID(eid, 5) and not isteam(eid) and WAR.ZDDH == 348 and JLSD(10, 40, eid)) or
            (match_ID(eid, 9970) and JLSD(10, 50, eid)) or WAR.FLHS2 == 1 then
            WAR.Person[enemyid]["特效动画"] = 6
            Set_Eff_Text(enemyid, 0, "其徐如林")
            WAR.PD['徐如林'][eid] = limitX((WAR.PD['徐如林'][eid] or 0) + math.random(2, 3), 0, 20)
        end

        -- 陆渐三十二身相 一合相
        if match_ID(eid, 9749) then
            WAR.PD["三十二身像"][eid] = 100
        end
    end

    -- 鹤笔翁
    if WAR.DN == 1 then
        local DN = math.random(1, 16)
        if DN == 1 then
            WAR.PD["混乱状态"][eid] = math.random(2, 4)
            Set_Eff_Text(enemyid, 3, "混乱")
        elseif DN == 2 then
            WAR.PD["迟缓状态"][eid] = math.random(5, 15)
            Set_Eff_Text(enemyid, 3, "迟缓")
        elseif DN == 3 then
            WAR.PD["虚弱状态"][eid] = math.random(30, 50)
            Set_Eff_Text(enemyid, 3, "虚弱")
        elseif DN == 4 then
            WAR.PD["昏迷状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "昏迷")
        elseif DN == 5 then
            WAR.PD["散功状态"][eid] = math.random(35, 55)
            Set_Eff_Text(enemyid, 3, "散功")
        elseif DN == 6 then
            WAR.PD["紊乱状态"][eid] = math.random(20, 40)
            Set_Eff_Text(enemyid, 3, "迷茫")
        elseif DN == 7 then
            WAR.PD["同归状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "同归")
        elseif DN == 8 then
            WAR.PD["无名业火"][eid] = math.random(25, 45)
            Set_Eff_Text(enemyid, 3, "业火")
        elseif DN == 9 then
            WAR.PD["冻结"][eid] = math.random(5, 10)
            Set_Eff_Text(enemyid, 3, "冻结")
        elseif DN == 10 then
            WAR.PD['撕裂'][eid] = math.random(20, 35)
            Set_Eff_Text(enemyid, 3, "撕裂")
        elseif DN == 11 then
            WAR.PD["一空到底"][eid] = math.random(10, 20)
            Set_Eff_Text(enemyid, 3, "失智")
        elseif DN == 12 then
            WAR.PD["冰冻状态"][eid] = math.random(5, 15)
            Set_Eff_Text(enemyid, 3, "冰冻")
        elseif DN == 13 then
            WAR.PD["恐惧状态"][eid] = 1
            Set_Eff_Text(enemyid, 3, "止戈")
        elseif DN == 14 then
            WAR.PD["放下屠刀"][eid] = math.random(3, 5)
            Set_Eff_Text(enemyid, 3, "佛系")
        elseif DN == 15 then
            WAR.PD['点燃'][eid] = math.random(5, 10)
            Set_Eff_Text(enemyid, 3, "点燃")
        end
    end
    -- 内轻特效608
    if NeiGong_tx(eid, 608) and JLSD(0, ekfcj_ng *5, eid) then
        WAR.PD["霸体"][eid] = 1
    end


    -- 内轻特效822 之二
    if WAR.PD['天机秘术'][eid] == 2 then
        WAR.PD["霸体"][eid] = 1
        WAR.Person[enemyid]["特效文字2"] = "霸体"
        WAR.PD['天机秘术'][eid] = nil
    end
    -- 碧海招式2 生灭道
    if WAR.BHJTZ3 == 1 and WAR.PD["霸体"][pid] == nil then
        WAR.PD["霸体"][pid] = 2
        WAR.BHJTZ3 = 0
    end

  ------------------------被打回血前，清空伤害，防止伤害小0--------------------------------
    hurt = limitX(math.modf(hurt), 0)

    WAR.ZQHT = 0

    -- 九剑真传，倒剑式强制杀集气
    if WAR.JJZC == 2 then
        WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - 150
    end

    -- 忘情天书师教 
    if WAR.PD['师教'][eid] ~= nil and WAR.PD['师教'][eid] == 1 then
        Set_Eff_Text(enemyid, "特效文字3", "师教")
        WAR.Person[enemyid]["特效动画"] = 63
        for i = 0 , WAR.PersonNum - 1 do
            if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[enemyid]['我方'] then 
                WAR.Person[i].TimeAdd = WAR.Person[enemyid].TimeAdd - 200
            end
        end   
        WAR.PD['师教'][eid] = nil         
    end

  --------------------伤害特效---------------------
    -- 死亡
    if JY.Person[pid]["生命"] < 0 then
        JY.Person[pid]["生命"] = 0
        lib.Debug(JY.Person[pid]["姓名"] .. '退出战场')
    else
        -- 狄云赤心连城追加连击
        if (match_ID(pid, 37) or match_ID(pid, 9903)) and hurt < 150 then
            WAR.CXLC = 1
        end

        -- 血海飘香
        if match_ID(pid, 9887) then
            WAR.LPZ = hurt / 2
            if WAR.LPZ > 400 then
                WAR.LPZ = 400
            end
        end
        if Pmiji(pid, 18) then
            local sm = math.modf(JY.Person[pid]['生命最大值'] * 0.05)
            if wugong == 73 then
                WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +
                                                            AddPersonAttrib(pid, "生命", sm)
                Set_Eff_Text(enemyid, "特效文字3", "琴心")
            end
        end
        if match_ID(pid, 9737) then
            WAR.PD['金刚伏魔'][pid] = math.modf(hurt / 2)
            local jgn = 0
            for wid = 0, WAR.PersonNum - 1 do
                if WAR.Person[wid]['我方'] == WAR.Person[WAR.CurID]['我方'] and WAR.Person[wid]['死亡'] == false then
                    jgn = jgn + 1
                end
                if jgn > 0 then
                    local jgm = math.modf(WAR.PD['金刚伏魔'][pid] / jgn)
                    -- if WAR.Person[wid]['人物编号'] ~= WAR.Person[WAR.CurID]['人物编号'] then 
                    WAR.Person[wid]["生命点数"] = (WAR.Person[wid]["生命点数"] or 0) + AddPersonAttrib(WAR.Person[wid]['人物编号'], "生命", jgm)
                    -- end
                end
            end
        end
    end
    -- 神门+玄虚，50%几率将被杀气转化为内力消耗
    if Pmiji(eid, 16) and JLSD(40, 70, eid) then
        local NL = hurt
        if 0 < JY.Person[eid]["生命"] and hurt > 0 then
            WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -NL)
            WAR.Person[enemyid]["特效文字2"] = "洞虚玄门"
            WAR.Person[enemyid]["特效动画"] = 159
        end
        hurt = math.modf(hurt / 2)
    end

    -- 混沦太玄，有30%几率挨打回血
    -- 内轻特效801
    if WAR.TXZQ[eid] == 1  then
        local n = ekfcj_ng*15
        hurt = -math.modf(hurt*n/100)
    end

    -- 灵犀分水功
    if Curr_NG(eid, 362) and JY.Person[eid]["冰封程度"] > 0 then
        local h = JY.Person[eid]["冰封程度"] * 2
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", h)
        WAR.Person[enemyid]["特效动画"] = 12
    end
    -- 天行健 
    if WAR.PD['天行健'][eid] == nil then
        if Curr_NG(eid, 264) and JY.Person[eid]['生命'] < JY.Person[eid]['生命最大值'] * 0.5 then
            WAR.PD['天行健'][eid] = 200
        end
    end
    -- 天行健
    if WAR.PD['天行健'][eid] ~= nil and WAR.PD['天行健'][eid] == 200 then
        if hurt > 0 then
            hurt = -math.modf(JY.Person[eid]['生命最大值'] * 0.1)
            Set_Eff_Text(enemyid, "特效文字1", "天行健")
            WAR.Person[enemyid]["特效动画"] = 147
            -- WAR.PD['天行健'][eid] = WAR.PD['天行健'][eid] - 1
        end
        lib.Debug('天行健' .. WAR.PD['天行健'][eid])
    end
    -- 摩天居士玄铁令二
    if match_ID(eid, 164) then
        if WAR.PD['玄铁令'][eid] ~= nil and WAR.PD['玄铁令'][eid] == 2 then
            if hurt > 0 then
                hurt = -math.modf(hurt / 2)
                WAR.Person[enemyid]["特效文字2"] = "我负天下人"
                WAR.Person[enemyid]["特效动画"] = 200
                WAR.PD['玄铁令'][eid] = nil
            end
        end
    end


    -- 贝海石，有10%几率挨打回血
    if (match_ID(eid, 85) or match_ID(eid, 9866)) and math.random(10) <= 1 then
        if hurt > 0 then
            hurt = -math.modf(hurt / 2)
            WAR.Person[enemyid]["特效文字2"] = "妙手回春"
            WAR.Person[enemyid]["特效动画"] = 12
        end
    end
    -- 无忧水镜
    if match_ID(eid, 596) then
        WAR.PD['无忧水镜'][eid] = math.modf(hurt / 2)
        local m = math.modf(WAR.PD['无忧水镜'][eid] / 4)
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", m * 2)
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", m)
        JY.Person[eid]['体力'] = JY.Person[eid]['体力'] + AddPersonAttrib(eid, "体力", m)
    end


    if WAR.ZDDH == 356 and WAR.PD['天关阵4'][eid] == 5 then
        if hurt > 0 then
            hurt = -hurt
            WAR.Person[enemyid]["特效动画"] = 6
            Set_Eff_Text(enemyid, "特效文字0", "徐如林")
        end
    end


  --------------------------------------系数计算--------------------------------------------    
    local kfxs = JY.Wugong[wugong]['武功类型']
    local rwxs = {'拳掌功夫', '指法技巧', '御剑能力', '耍刀技巧', '特殊兵器', '内力最大值'}
    if match_ID(eid, 9845) then
        kfxs = 3
    end
    if match_ID(pid, 9845) then
        kfxs = 3
    end

    local dxs = rwxs[kfxs]
    local eidxs = JY.Person[eid][dxs]
    local pidxs = JY.Person[pid][dxs]

    -- 内轻特效817 攻击时与被攻击时对方拳法系数为0，受到拳法伤害-n% 
    if kfxs == 1 then
        if NeiGong_tx(eid, 817) and JLSD(0, ekfcj_ng * 20, eid) then
            pidxs = 0
        end
        if NeiGong_tx(pid, 817) and JLSD(0, dkfcj_ng * 20, pid) then
            eidxs = 0
        end
    end
    -- 内轻特效818 攻击时与被攻击时对方指法系数为0，受到拳法伤害-n% 
    if kfxs == 2 then
        if NeiGong_tx(eid, 818) and JLSD(0, ekfcj_ng * 20, eid) then
            pidxs = 0
        end
        if NeiGong_tx(pid, 818) and JLSD(0, dkfcj_ng * 20, pid) then
            eidxs = 0
        end
    end
    -- 内轻特效819 攻击时与被攻击时对方剑法系数为0，受到拳法伤害-n% 
    if kfxs == 3 then
        if NeiGong_tx(eid, 819) and JLSD(0, ekfcj_ng * 20, eid) then
            pidxs = 0
        end
        if NeiGong_tx(pid, 819) and JLSD(0, dkfcj_ng * 20, pid) then
            eidxs = 0
        end
    end
    -- 内轻特效820 攻击时与被攻击时对方刀法系数为0，受到拳法伤害-n% 
    if kfxs == 4 then
        if NeiGong_tx(eid, 820) and JLSD(0, ekfcj_ng * 20, eid) then
            pidxs = 0
        end
        if NeiGong_tx(pid, 820) and JLSD(0, dkfcj_ng * 20, pid) then
            eidxs = 0
        end
    end
    -- 内轻特效821 攻击时与被攻击时对方刀法系数为0，受到拳法伤害-n% 
    if kfxs == 5 then
        if NeiGong_tx(eid, 821) and JLSD(0, ekfcj_ng * 20, eid) then
            pidxs = 0
        end
        if NeiGong_tx(pid, 821) and JLSD(0, dkfcj_ng * 20, pid) then
            eidxs = 0
        end
    end

    local xshurt = pidxs - eidxs
    if kfxs == 6 then
        xshurt = xshurt / 10
        if xshurt > 666 then
            xshurt = 666
        end
    end
    --内轻特效1000
    if xshurt > 0 then 
        if NeiGong_tx(eid,1000) and JLSD(0,ekfcj_ng*25,eid) then 
            xshurt = 0
        end
    end
    if xshurt < 0 then 
        if NeiGong_tx(pid,1000) and JLSD(0,dkfcj_ng*25,pid) then 
            xshurt = 0
        end
    end
    --队友不计算系数差伤害
    if WAR.Person[enemyid]['我方'] == WAR.Person[WAR.CurID]['我方'] then
        xshurt = 0
    end

    lib.Debug('系数差伤害是' .. xshurt)
    -- 加入衰减计算
    local lgnum = 1 ^ 2
    hurt = hurt * lgnum + xshurt
    if hurt < 0 then 
        hurt = math.random(10,30)
    end

  ----------------免疫伤害 强制伤害为0的特效写这里--------------
    -- 文泰来否极泰来 	
    if WAR.WTL_PJTL[eid] ~= nil then
        WAR.Person[enemyid]["特效文字0"] = nil
        WAR.Person[enemyid]["特效文字1"] = nil
        WAR.Person[enemyid]["特效文字2"] = nil
        WAR.Person[enemyid]["特效文字3"] = nil
        WAR.Person[enemyid]["特效文字4"] = nil
        WAR.Person[enemyid]["特效动画"] = -1
        hurt = 0
        WAR.Person[enemyid]["特效动画"] = 157
        Set_Eff_Text(enemyid, "特效文字1", "否极泰来")
        lib.Debug(JY.Person[eid]['姓名']..'否极泰来' ..'减伤后受到的伤害 = '..hurt )
        -- 霸体状态
    elseif WAR.PD["霸体"][eid] ~= nil then
        hurt = 0
        WAR.Person[enemyid]["特效文字0"] = nil
        WAR.Person[enemyid]["特效文字1"] = nil
        WAR.Person[enemyid]["特效文字2"] = nil
        WAR.Person[enemyid]["特效文字3"] = nil
        WAR.Person[enemyid]["特效文字4"] = nil
        WAR.Person[enemyid]["特效动画"] = -1
        WAR.Person[enemyid]["特效动画"] = 118
        Set_Eff_Text(enemyid, "特效文字1", "霸体")
        lib.Debug(JY.Person[eid]['姓名']..'霸体' ..'减伤后受到的伤害 = '..hurt )
    elseif WAR.PD["逆水寒"][eid] ~= nil then
        hurt = 0
        WAR.Person[enemyid]["特效文字0"] = nil
        WAR.Person[enemyid]["特效文字1"] = nil
        WAR.Person[enemyid]["特效文字2"] = nil
        WAR.Person[enemyid]["特效文字3"] = nil
        WAR.Person[enemyid]["特效文字4"] = nil
        WAR.Person[enemyid]["特效动画"] = -1
        WAR.Person[enemyid]["特效动画"] = 184
        lib.Debug(JY.Person[eid]['姓名']..'逆水寒' ..'减伤后受到的伤害 = '..hurt )
    elseif WAR.PD["玄冰界"][eid] ~= nil and WAR.PD["玄冰界"][eid] >= 270 then
        hurt = 0
        WAR.Person[enemyid]["特效文字0"] = nil
        WAR.Person[enemyid]["特效文字1"] = nil
        WAR.Person[enemyid]["特效文字2"] = nil
        WAR.Person[enemyid]["特效文字3"] = nil
        WAR.Person[enemyid]["特效文字4"] = nil
        WAR.Person[enemyid]["特效动画"] = -1
        WAR.Person[enemyid]["特效动画"] = 174
        lib.Debug(JY.Person[eid]['姓名']..'玄冰界' ..'减伤后受到的伤害 = '..hurt )
    elseif WAR.PD["定乾坤"][eid] ~= nil then
        hurt = 0
        WAR.Person[enemyid]["特效文字0"] = nil
        WAR.Person[enemyid]["特效文字1"] = nil
        WAR.Person[enemyid]["特效文字2"] = nil
        WAR.Person[enemyid]["特效文字3"] = nil
        WAR.Person[enemyid]["特效文字4"] = nil
        WAR.Person[enemyid]["特效动画"] = -1
        WAR.Person[enemyid]["特效动画"] = 174
        lib.Debug(JY.Person[eid]['姓名']..'定乾坤' ..'减伤后受到的伤害 = '..hurt )
    end
    -- 斗酒僧不受连击伤害
    if match_ID(eid, 9966) and WAR.ACT > 1 then
        hurt = 0
        lib.Debug(JY.Person[eid]['姓名']..'斗酒僧不受连击伤害' ..'减伤后受到的伤害 = '..hurt )
    end

    -- 四大山，杂鱼不死不受伤害
    if eid == 642 then
        local s = 0
        for j = 0, WAR.PersonNum - 1 do
            if j ~= enemyid and WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] ==
                WAR.Person[enemyid]["我方"] then
                s = 1
                break
            end
        end
        if s == 1 then
            hurt = 0
            Set_Eff_Text(enemyid, "特效文字1", "星河真气・免疫伤害")
        end
    end

    --天赋9633不老长春
    if match_ID(eid, 9633) and hurt > 0 and JLSD(10, 50, eid) then
        WAR.Person[enemyid]["特效动画"] = 79
        Set_Eff_Text(enemyid, "特效文字1", "长春不老")
        if JY.Person[eid]["内力"] < 0 then
        elseif hurt * 2 < JY.Person[eid]["内力"] then
            WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -math.modf(hurt * 2));
            hurt = 0
        else
            hurt = hurt - math.modf(JY.Person[eid]["内力"] / 2)
            WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -JY.Person[eid]["内力"])
        end
        lib.Debug(JY.Person[eid]['姓名']..'天赋9633不老长春' ..'减伤后受到的伤害 = '..hurt )
    end

    hurt = math.modf(hurt) -- 标记修改

    -- 一灯复活后，不受连击伤害
    if match_ID(eid, 9855) and WAR.PD["复活"][eid] ~= nil and WAR.ACT > 1 and hurt > 0 then
        hurt = 0
        WAR.Person[enemyid]["特效动画"] = 136
        Set_Eff_Text(enemyid, "特效文字2", "不动明王")
        lib.Debug(JY.Person[eid]['姓名']..'不动明王' ..'减伤后受到的伤害 = '..hurt )
    end
    -- 内轻特效801
    if NeiGong_tx(eid, 801)  then
        local pd = 0
        local jl = (ekfcj_ng + 1) * 6
        if match_ID(eid, 9759) then
            pd = 1
        elseif CC.TX['太玄觉醒'] == 1 or not isteam(eid) then
            pd = 1
            if JY.Person[eid]['奇穴' .. 95] == 1 then
                jl = jl + 5
            end
        end
        if pd == 1  then
            if JLSD(0,jl,eid) then 
                hurt = -math.modf(hurt/2)
                WAR.TXZQ[eid] = 1
                WAR.Person[enemyid]["特效文字0"] = "五岳倒为轻."
                WAR.Person[enemyid]["特效动画"] = 147
            elseif JLSD(0,jl,eid) then 
                WAR.PD['混沌太玄'][eid] = 1
                WAR.Person[enemyid]["特效文字0"] = "救赵挥金槌."
                WAR.Person[enemyid]["特效动画"] = 119
                WAR.ACT = 10
            end
        end   
    end
     -- 蓄气值
    -- 内轻特效802
    if NeiGong_tx(eid, 802) then
        if WAR.PD["蓄气值"][eid] == nil or WAR.PD["蓄气值"][eid] == 0 then
            WAR.PD["蓄气值"][eid] = 0
        end
        if match_ID(eid, 5) then
            WAR.PD["蓄气值"][eid] = 50 + math.modf(WAR.PD["蓄气值"][eid] + math.modf(hurt) * 1.2);
        else
            WAR.PD["蓄气值"][eid] = 50 + WAR.PD["蓄气值"][eid] + math.modf(hurt);
        end
        -- 上限1080
        if WAR.PD["蓄气值"][eid] > 1080 then
            WAR.PD["蓄气值"][eid] = 1080
        end
    end
    -- 护盾计算
    if WAR.PD['护盾值'][eid] ~= nil and WAR.PD['护盾值'][eid] > 0 then
        lib.Debug(JY.Person[eid]['姓名'] .. '护盾伤害结算时，护盾值' .. (WAR.PD['护盾值'][eid] or 0))
        if hurt < WAR.PD['护盾值'][eid] then
            WAR.PD['护盾值'][eid] = math.modf(WAR.PD['护盾值'][eid] - hurt)
            hurt = 0
        else
            hurt = math.modf(hurt - WAR.PD['护盾值'][eid])
            lib.Debug(JY.Person[eid]["姓名"] .. '护盾值抵消伤害后受到伤害' .. hurt)

            if NeiGong_tx(eid,1044) then 
                WAR.PD['至刚至阳'][eid] = 5
                WAR.PD['至刚反伤'][eid] = WAR.PD['护盾值'][eid]*2
                WAR.PD['护盾值'][eid] = math.modf(JY.Person[eid]['生命最大值']*0.2)
                Cat('护盾停止', enemyid)
                WAR.Person[enemyid]['护盾'] = 6
            else
                WAR.PD['护盾值'][eid] = nil
                Cat('护盾停止', enemyid)
            end           
        end
    end
    lib.Debug(JY.Person[eid]["姓名"] .. '护盾结算伤害受到的伤害' .. hurt)
    if JY.Person[eid]["生命"] <= 0 then
        lib.Debug(JY.Person[eid]["姓名"] .. '退出战场')
    end

    -------------伤害后特效统一写这里---------------
    -- 至刚至阳
    --内轻特效1044
    if NeiGong_tx(eid,1044) then
        local jy = hurt*ekfcj_ng*5/100
        -- 至阳之体
        if JY.Person[eid]['奇穴' .. 61] == 1 then
            jy = hurt*ekfcj_ng*10/100
            lib.Debug(JY.Person[eid]['姓名'] ..'至阳之体奇穴61'..'增加护盾值2' .. jy) 
        end
        WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + jy
        Cat('护盾停止', enemyid)
        WAR.Person[enemyid]['护盾'] = 6
        lib.Debug(JY.Person[eid]['姓名'] ..'内轻特效1044'..'护盾值' .. (WAR.PD['护盾值'][eid] or 0))        
    end
    -- 坐忘勿我
    if Curr_NG(eid, 152) then
        WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + math.modf(hurt / 2)
        Cat('护盾停止', enemyid)
        WAR.Person[enemyid]['护盾'] = 1
    end
    -- 防止伤害出现小数字
    hurt = math.modf(hurt)
    lib.Debug(JY.Person[eid]["姓名"] .. "结算受到的伤害" .. hurt)


    ----------------------------------------------------伤害结算-------------------------------------------------------------   
    -- 生命扣点
    WAR.Person[enemyid]['生命点数'] = (WAR.Person[enemyid]['生命点数'] or 0) + AddPersonAttrib(eid, '生命', -hurt)


    -- 倾国倾城
    if match_ID(eid, 9767) and JLSD(0, 15, eid) and WAR.PD["倾国倾城"][eid] == nil then
        WAR.PD["倾国倾城"][eid] = 6
    end

    -- 获取得经验
    -- WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + math.modf((hurt) / 5)

    -- 装备获取经验
    if WAR.Person[WAR.CurID]["我方"] ~= WAR.Person[enemyid]["我方"] and WAR.ZDDH ~= 226 then
        -- 武器获取经验
        if JY.Person[pid]["武器"] ~= -1 then
            JY.Thing[JY.Person[pid]["武器"]]["装备经验"] = JY.Thing[JY.Person[pid]["武器"]]["装备经验"] + 5
            if JY.Thing[JY.Person[pid]["武器"]]["装备经验"] > 100 and
                JY.Thing[JY.Person[pid]["武器"]]["装备等级"] < 6 then
                JY.Thing[JY.Person[pid]["武器"]]["装备经验"] = 0
                JY.Thing[JY.Person[pid]["武器"]]["装备等级"] =
                    JY.Thing[JY.Person[pid]["武器"]]["装备等级"] + 1
            end
        end
        -- 防具获取经验
        if JY.Person[eid]["防具"] ~= -1 then
            JY.Thing[JY.Person[eid]["防具"]]["装备经验"] = JY.Thing[JY.Person[eid]["防具"]]["装备经验"] + 5
            if JY.Thing[JY.Person[eid]["防具"]]["装备经验"] > 100 and
                JY.Thing[JY.Person[eid]["防具"]]["装备等级"] < 6 then
                JY.Thing[JY.Person[eid]["防具"]]["装备经验"] = 0
                JY.Thing[JY.Person[eid]["防具"]]["装备等级"] =
                    JY.Thing[JY.Person[eid]["防具"]]["装备等级"] + 1
            end
        end
        -- 坐骑获取经验
        if JY.Person[eid]["坐骑"] ~= -1 then
            JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] = JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] + 5
            if JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] > 100 and
                JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"] < 6 then
                JY.Thing[JY.Person[eid]["坐骑"]]["装备经验"] = 0
                JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"] =
                    JY.Thing[JY.Person[eid]["坐骑"]]["装备等级"] + 1
            end
        end
    end

    if Curr_NG(eid, 99) and JY.Person[eid]['性别'] == 0 then
        dng = dng * 1.2
    end

    if match_ID(pid, 114) then
        dng = dng * 0.5
    end
    -- 玄虚劲
    if Pmiji(eid, 73) then
        dng = dng * 2
    end
    -- 炼气
    if JY.Person[eid]['奇穴' .. 121] == 1 then
        dng = dng * 1.1
    end
    -- 炼气
    if JY.Person[pid]['奇穴' .. 121] == 1 then
        ang = ang * 1.1
    end
    -- 内轻内特效412
    if NeiGong_tx(eid, 412) then
        ang = ang - ekf_ng * 200
    end
    ----------计算是否破气防，dng为0表示被破气防-------------
    lib.Debug('计算破气防时'..JY.Person[pid]['姓名']..'的气攻攻 ='..ang..' '..JY.Person[eid]['姓名']..'的气防 = '..dng)
    ang = ang - dng
    if 0 < ang then
        dng = 0
    else
        dng = -ang
        ang = 0
    end
    
    -- 内轻特效602
    if NeiGong_tx(eid, 602) and JLSD(0, ekfcj_ng * 25, eid) then
        dng = 1
        Set_Eff_Text(enemyid, "特效文字1", '免疫杀气')
    end
    -- 东方不败，岳云精忠报国 葵花秘法・化凤为凰免疫杀气
    if match_ID(eid, 568) and WAR.LQZ[eid] == 100 then
        dng = 1
    end
    -- 浑天气功
    if WAR.PD['天地浑圆'][eid] ~= nil and WAR.PD['天地浑圆'][eid] == 1 then
        dng = 1
        -- lib.Debug('浑天9')
    end
    -- 炼气
    if JY.Person[eid]['奇穴' .. 121] == 1 then
        dng = 1
    end
    -- 入魔
    if WAR.PD['入魔'][eid] ~= nil and WAR.PD['入魔'][eid] == 1 then
        dng = 1
    end
    -- 白毫相
    if WAR.PD['三十二身像'][eid] ~= nil then
        if JLSD(20, 70, eid) and (JY.Base["天书数量"] > 1 or isteam(eid) == false) then
            Set_Eff_Text(enemyid, "特效文字1", "白毫相");
            WAR.Person[enemyid]["特效动画"] = 144
            dng = 1
        end
    end
    -- 气防
    -- 扫地  免杀气
    if match_ID(eid, 114) then
        WAR.Person[enemyid]["特效文字2"] = "天地独尊"
        WAR.Person[enemyid]["特效动画"] = 39
        dng = 1
    end

    if match_ID(eid, 9807) then
        WAR.Person[enemyid]["特效动画"] = 31
        WAR.Person[enemyid]["特效文字1"] = "十三太保横练"
        dng = 1
    end

    -- 达摩 免杀气
    if match_ID(eid, 577) then
        dng = 1
    end
    if JY.Person[eid]["坐骑"] == 312 then
        -- dng = 1
    end

    -- 易筋真谛  免杀气
    if Curr_NG(eid, 108) and JLSD(30, 70, eid) then
        Set_Eff_Text(enemyid, "特效文字1", "易筋真谛");
        WAR.Person[enemyid]["特效动画"] = 39
        dng = 1
    end

    -- 黑级浮屠
    if match_ID(eid, 9930) and JLSD(30, 70, eid) then
        if WAR.Person[enemyid]["特效动画"] == -1 then
            WAR.Person[enemyid]["特效动画"] = 184
        end
        Set_Eff_Text(enemyid, "特效文字1", "黑级浮屠")
        dng = 1
    end

    -- 真名神照
    if match_ID(eid, 9761) and Curr_NG(eid, 94) then
        Set_Eff_Text(enemyid, "特效文字1", "真名神照");
        WAR.Person[enemyid]["特效动画"] = 89
        dng = 1
    end

    if match_ID(eid, 9761) and Curr_NG(eid, 203) then
        Set_Eff_Text(enemyid, "特效文字1", "真名长生");
        WAR.Person[enemyid]["特效动画"] = 89
        dng = 1
    end

    -- 盖世无双，50%几率免内伤，免杀气
    if Pmiji(eid, 72) then
        if JLSD(0, 50, eid) then
            WAR.GSWS = WAR.GSWS + 1
            dng = 1
            WAR.Person[enemyid]["特效动画"] = 10
            Set_Eff_Text(enemyid, "特效文字1", "丐世无双")
        end
    end

    if WAR.PD['西瓜刀・天人'][eid] ~= nil then
        dng = 1
        Set_Eff_Text(enemyid, "特效文字1", "天人五衰")
    end

    WAR.GSWS = 0

    -- 伤害小于等于30 免内伤，免杀气 
    if hurt <= 30 then
        dng = 1
    end
    -- 悲天佛怜 
    if match_ID(eid, 9983) and JY.Person[eid]["生命"] < JY.Person[eid]["生命最大值"] / 2 then
        dng = 1
    end
    -- 真太奥免疫杀气
    if WAR.TJAY == 4 then
        dng = 1
    end
    -- 十三太保免疫杀气
    if match_ID(eid, 9807) then
        dng = 1
    end
    WAR.TJAY = 0

    -- 伤害小于等于30 免内伤，免杀气 
    if hurt <= 30 then
        dng = 1
    end

    -- 刀系大招，忽视绝对气防
    if WAR.ASKD == 1 then
        dng = 0
    end

    if WAR.PD['侵如火'][pid] == 1 then
        dng = 0
    end

    if WAR.ZDDH == 356 and WAR.PD['天关阵4'][pid] == 50 then
        dng = 0
    end

    -- 排云掌
    if WAR.BJYPYZ > 9 then
        dng = 0
    end
    -- 天罡大招，忽视绝对气防
    if WAR.JSTG == 1 then
        dng = 0
    end

    -- 浩然罡气
    if match_ID(pid, 9946) and WAR.LQZ[pid] == 100 then
        dng = 0
    end
    -- 绣花针，忽视绝对气防 
    if WAR.PD["绣花针"][pid] ~= nil and WAR.PD["绣花针"][pid] > 0 then
        dng = 0
    end
    -- 灵犀一指
    if WAR.PD['灵犀一指'][pid] ~= nil and WAR.PD['灵犀一指'][pid] > 0 then
        dng = 0
    end
    -- 破尽天下，忽视绝对气防
    if WAR.PJTX == 1 then
        dng = 0
    end
    -- 奇门无双
    if JY.Person[pid]['奇穴' .. 72] == 1 then
        dng = 0
    end

    -- 陆渐大金刚神力，忽视绝对气防
    if WAR.JGSL == 1 then
        dng = 0
    end
    -- 青莲剑歌绝技，忽视绝对气防
    if WAR.QLJG == 1 then
        dng = 0
    end
    -- 忽视绝对气防
    if WAR.SL23 == 1 then
        dng = 0
    end
    -- 五岳剑法+五岳剑诀，忽视绝对气防
    if WAR.ZWYJF == 1 then
        dng = 0
    end
    if WAR.JMZL == 2 then
        dng = 0
    end
    if WAR.DSP_LM1 == 1 then
        dng = 0
    end
    -- 龙象之力暴怒，忽视绝对气防
    if WAR.LXZL10 == 1 then
        dng = 0
    end
    -- 李文秀14书，特效忽视绝对气防
    if WAR.LWX == 1 then
        dng = 0
    end
    -- 梅花三弄3
    if WAR.MHSN == 3 then
        dng = 0
    end
    -- 郭靖降龙后劲超过11道，忽视绝对气防
    if WAR.YYBJ > 11 then
        dng = 0
    end
    -- 黯然极意
    if WAR.ARJY == 1 then
        dng = 0
    end
    -- 鲸息功 陷空力
    if WAR.BHJTZ6 == 1 then
        dng = 0
    end

    -- 招式破气防
    for i = 1, JY.Base["武功数量"] do
        local yxsy = JY.Person[pid]["优先使用"]
        if yxsy > 0 then
            for j = 1, #CC.KFMove[yxsy] do
                local zs = CC.WUGONGZS[i][j]
                local wugong = JY.Person[pid]["武功" .. i]
                if wugong == yxsy and WAR.WGZS == j then
                    if JY.Wugong[yxsy]["招式" .. j] >= 191 and JY.Wugong[yxsy]["招式" .. j] <= 194 then
                        local jl = JY.Wugong[yxsy]["层级"] * 10
                        if JLSD(0, jl, pid) then
                            dng = 0
                        end
                    end
                end
            end
        end
    end

    -- 三才归元反击
    if WAR.PD['三才归元'][eid] ~= nil and WAR.Person[enemyid]["反击武功"] == -1 and MyFj(WAR.CurID) == false and
        WAR.DZXY ~= 1 and JY.Person[eid]["生命"] > 0 then
        -- PNGHH_nl(eid)
        WAR.Person[enemyid]['反击'] = 1
        WAR.DZXYLV[eid] = 200
        WAR.Person[enemyid]["特效动画"] = 166
        Set_Eff_Text(enemyid, "特效文字2", "镜心")
        WAR.PD['三才归元'][eid] = nil
    end
    if match_ID(eid, 9944) and WAR.Person[enemyid]["反击武功"] == -1 and MyFj(WAR.CurID) == false and WAR.DZXY ~= 1 and
        JY.Person[eid]["生命"] > 0 then
        WAR.Person[enemyid]['反击'] = 1
        WAR.DZXYLV[eid] = 200
        WAR.Person[enemyid]["特效动画"] = 93
        -- PNGHH_nl(eid)
        Set_Eff_Text(enemyid, "特效文字1", "流云飞袖")
        WAR.PD["流云飞袖"][eid] = 1
    end

    -- 王杰 标记修改
    if match_ID(eid, 9921) and WAR.Person[enemyid]["反击武功"] == -1 and MyFj(WAR.CurID) == false and WAR.DZXY ~= 1 and
        JY.Person[eid]["生命"] > 0 and JLSD(20, 50, pid) then
        WAR.Person[enemyid]['反击'] = 1
        WAR.DZXYLV[eid] = 200
        -- PNGHH_nl(eid)
        Set_Eff_Text(enemyid, "特效文字2", "宁碰阎王，莫碰大王")
    end
    -- 王τ 标记修改	
    if match_ID(eid, 9920) and WAR.Person[enemyid]["反击武功"] == -1 and MyFj(WAR.CurID) == false and WAR.DZXY ~= 1 and
        JY.Person[eid]["生命"] > 0 and JLSD(20, 50, pid) then
        -- PNGHH_nl(eid)
        WAR.Person[enemyid]['反击'] = 1
        WAR.DZXYLV[eid] = 200
        Set_Eff_Text(enemyid, "特效文字2", "宁碰阎王，莫碰二王")
    end
    -- 招式反击
    if WAR.PD["刺猬状态"][eid] ~= nil and WAR.Person[enemyid]["反击武功"] == -1 and MyFj(WAR.CurID) == false and
        WAR.DZXY ~= 1 and JY.Person[eid]["生命"] > 0 and DWPD(WAR.CurID, enemyid) then
        -- AddPersonAttrib(pid,'能量',2)	
        WAR.Person[enemyid]['反击'] = 1
        WAR.DZXYLV[eid] = 200
        WAR.PD["刺猬状态"][eid] = nil
        -- PNGHH_nl(eid)
        Set_Eff_Text(enemyid, "特效文字2", "反击")
    end
    -- 陆渐60%几率 大自在相 
    if WAR.PD["三十二身像"][eid] ~= nil then
        if JLSD(20, 80, eid) then
            if inteam(eid) then
                if JY.Base["天书数量"] > 3 then
                    WAR.DZZ[eid] = 1
                end
            else
                WAR.DZZ[eid] = 1
            end
            Set_Eff_Text(enemyid, "特效文字2", "大自在相 ")
        end
    end

    -- 能量回复
    if WAR.DZXYLV[eid] ~= nil and WAR.DZXYLV[eid] > 0 then
        -- JY.Person[eid]["能量"] = JY.Person[eid]["能量"] + 1
        -- AddPersonAttrib(eid,'能量',1)
        PNGHH_nl(eid)
    end

    -- 破防杀集气计算
    if dng == 0 and hurt > 0 then
        local killsq = 1

        local killjq = 0

        killjq = math.modf(ang / 15)

        -- 受伤害额外杀集气
        local spdhurt = 0

        local nd = JY.Base['难度']
        -- 难度加成
        if isteam(pid) == false then
            spdhurt = spdhurt + (nd - 1) * hurt * 0.15
        end

        if WAR.ZDDH == 356 and WAR.PD['天关阵4'][pid] == 50 then
            spdhurt = spdhurt + 200
        end

        -- 雷动九天追加伤害杀气
        if WAR.LDJT == 1 then
            spdhurt = spdhurt + math.modf(hurt * 0.6)
        end


        killjq = killjq + spdhurt

        if WAR.PD['西瓜刀'][pid] == 1 then
            WAR.PD['回气'][pid] = (WAR.PD['回气'][pid] or 0) + killjq
        end
        if WAR.PD["合川"][pid] ~= nil and WAR.PD["合川"][pid] == 1 then
            local sq = 0
            for j = 1, #WAR.Debuf do
                local yc = WAR.Debuf[j][1]
                if WAR.PD[yc][enemyid] ~= nil then
                    sq = sq + 1
                end
            end
            for j = 1, #WAR.Debuf2 do
                local yc = WAR.Debuf2[j][1]
                if WAR.PD[yc][enemyid] ~= nil then
                    sq = sq + 1
                end
            end
            -- local ns = JY.Person[enemyid]['受伤程度']
            local ns = (WAR.PD['内伤状态'][enemyid] or 0)
            local zd = JY.Person[enemyid]['中毒程度']
            local bf = JY.Person[enemyid]['冰封程度']
            local zs = JY.Person[enemyid]['灼烧程度']
            if ns > 0 then
                sq = sq + 1
            end
            if zd > 0 then
                sq = sq + 1
            end
            if bf > 0 then
                sq = sq + 1
            end
            if zs > 0 then
                sq = sq + 1
            end
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - sq * 4 * 10
            WAR.PD["合川"][pid] = nil
        end
        if Curr_NG(eid, 227) and WAR.Defup[eid] ~= nil and WAR.Defup[eid] > 0 then
            if WAR.Person[enemyid].TimeAdd < 0 then
                WAR.Person[enemyid].TimeAdd = 0
            end
            if JLSD(0, 35, eid) then
                WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 100
                Set_Eff_Text(enemyid, "特效文字1", "伺机而动")
            end
        elseif match_ID(eid, 9988) and JLSD(20, 50, eid) then
            WAR.Person[WAR.CurID].TimeAdd = WAR.Person[WAR.CurID].TimeAdd - killjq * 0.5
            -- 陆渐，被打加200集气	
        elseif WAR.DZZ[eid] ~= nil and WAR.DZZ[eid] == 1 then
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 200
            Set_Eff_Text(enemyid, "特效文字1", "大自在相")
            -- 鱼龙跃	
        elseif JY.Person[eid]['奇穴' .. 103] == 1 and JLSD(0, 30, eid) then
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 100
            Set_Eff_Text(enemyid, "特效文字1", "鱼龙跃")
            -- 梯云纵，被打加100集气	
            -- 浑天气功
        elseif WAR.PD['天地浑圆'][eid] ~= nil and WAR.PD['天地浑圆'][eid] == 1 then
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 200
            Set_Eff_Text(enemyid, "特效文字2", "天地浑圆")
            WAR.PD['天地浑圆'][eid] = nil
            -- lib.Debug('浑天10')   
            -- 除却四相，50%几率被打加100集气		
        elseif Pmiji(eid, 37) and JLSD(20, 70, eid) then
            -- WAR.PD['吸星真气'][eid] = (WAR.PD['吸星真气'][eid] or 0) + 40
            WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + 40
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 100
            Set_Eff_Text(enemyid, "特效文字2", "无人相")
        elseif match_ID(eid, 9932) and WAR.Actup[eid] ~= nil and WAR.Actup[eid] == 1 then
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 100
            Set_Eff_Text(enemyid, "特效文字2", "般若无相")
            -- 太玄之轻，把被杀的集气转为自己的集气值
        elseif WAR.TXZQ[eid] ~= nil and WAR.TXZQ[eid] == 1 then
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + killjq*ekfcj_ng*15/100
            --Set_Eff_Text(enemyid, "特效文字0", "五岳倒为轻")
        elseif WAR.PD['混沌太玄'][eid] ~= nil and WAR.PD['混沌太玄'][eid] == 1 then 
            for i = 0,WAR.PersonNum - 1 do 
                if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[enemyid]['我方'] then 
                    WAR.Person[i].TimeAdd = WAR.Person[i].TimeAdd - 200
                end
            end 
            WAR.PD['混沌太玄'][eid] = nil 
        elseif WAR.PD["七略集气"][eid] ~= nil and WAR.PD["七略集气"][eid] == 1 then
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd + 200
            Set_Eff_Text(enemyid, "特效文字0", "七略.固术")

        else
            WAR.Person[enemyid].TimeAdd = WAR.Person[enemyid].TimeAdd - killjq
        end

        -- 太极+柔云，以柔克刚，50%几率将被杀气转化为回血 刘乘风100%
        if Pmiji(eid, 27) then
            local jl = 50
            if match_ID(eid, 95) then
                jl = 100
            end
            if JLSD(0, jl, eid) then
                local heal = math.modf(killjq / 2)
                if 0 < JY.Person[eid]["生命"] and hurt > 0 then
                    WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +
                                                              AddPersonAttrib(eid, "生命", heal)
                    Set_Eff_Text(enemyid, "特效文字1", "太极道・以柔克刚")
                    WAR.Person[enemyid]["特效动画"] = 21
                end
            end
        end

        local heal = math.modf(killjq / 3)
        WAR.PD['九歌回血'][pid] = WAR.PD['九歌回血'][pid] or 0 + killjq * 5
        -- lib.Debug('九歌回血 =='..WAR.PD['九歌回血'][pid])
    end

    WAR.QMWZ = 0

    -- 小龙女死掉，杨过吼
    if match_ID(eid, 59) and JY.Person[eid]["生命"] <= 0 then
        WAR.XK = 1
        WAR.XK2 = WAR.Person[enemyid]["我方"]
    end

    -- 张家辉的麻痹戒指
    if JY.Person[pid]["防具"] == 301 then
        local mb = 1
        if JY.Thing[301]["装备等级"] >= 5 then
            mb = 3
        elseif JY.Thing[301]["装备等级"] >= 3 then
            mb = 2
        end
        WAR.PD["麻痹状态"][eid] = mb
    end

    -- 无酒不欢：优化钟灵闪电貂偷东西
    if WAR.TD == -2 and JLSD(0, 40, pid) then
        for i = 1, 4 do
            if 0 < JY.Person[eid]["携带物品数量" .. i] and -1 < JY.Person[eid]["携带物品" .. i] and eid ~= 0 then
                WAR.TD = JY.Person[eid]["携带物品" .. i]
                WAR.TDnum = JY.Person[eid]["携带物品数量" .. i]
                JY.Person[eid]["携带物品数量" .. i] = 0
                JY.Person[eid]["携带物品" .. i] = -1
                break
            end
        end
    else
        WAR.TD = -1
    end

    -- 招式吸血
    for i = 1, JY.Base["武功数量"] do
        local yxsy = JY.Person[pid]["优先使用"]
        if yxsy > 0 then
            for j = 1, #CC.KFMove[yxsy] do
                local zs = CC.WUGONGZS[i][j]
                local wugong = JY.Person[pid]["武功" .. i]
                if wugong == yxsy and WAR.WGZS == j then
                    if JY.Wugong[yxsy]["招式" .. j] >= 161 and JY.Wugong[yxsy]["招式" .. j] <= 164 and hurt > 30 then
                        if JY.Wugong[yxsy]["招式" .. j] == 161 then
                            WAR.ZSXX = WAR.ZSXX + math.modf(hurt * 0.2)
                            if WAR.ZSXX > 50 then
                                WAR.ZSXX = 50
                            end
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 162 then
                            WAR.ZSXX = WAR.ZSXX + math.modf(hurt * 0.2)
                            if WAR.ZSXX > 100 then
                                WAR.ZSXX = 100
                            end
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 163 then
                            WAR.ZSXX = WAR.ZSXX + math.modf(hurt * 0.2)
                            if WAR.ZSXX > 150 then
                                WAR.ZSXX = 150
                            end
                        end
                        if JY.Wugong[yxsy]["招式" .. j] == 164 then
                            WAR.ZSXX = WAR.ZSXX + math.modf(hurt * 0.2)
                            if WAR.ZSXX > 200 then
                                WAR.ZSXX = 200
                            end
                        end
                    end
                end
            end
        end
    end
    -- 殷离吸血 标记修改
    if match_ID(pid, 646) or match_ID(pid, 9790) then
        WAR.YLXX = WAR.YLXX + JY.Person[WAR.Person[enemyid]['人物编号']]['中毒程度']
        if WAR.YLXX > 100 then
            WAR.YLXX = 100
        end
    end
    -- 入魔吸血
    if WAR.PD['入魔'][pid] ~= nil and WAR.PD['入魔'][pid] == 1 then
        WAR.RMXX = WAR.RMXX + math.modf(hurt * 0.2)
        local xxmax = math.modf(JY.Person[pid]['生命最大值'] * 0.05)
        if WAR.RMXX > xxmax then
            WAR.RMXX = xxmax
        end
    end
    -- 血刀吸血，1级5%，3级6%，5级7%
    -- 上限100点
    local xldxx = 0
    if JY.Person[pid]['奇穴' .. 91] == 1 then
        xldxx = 100
    end
    if JY.Person[pid]["武器"] == 44 then
        local bs = 0
        if JY.Thing[44]["装备等级"] >= 5 then
            bs = 2
        elseif JY.Thing[44]["装备等级"] >= 3 then
            bs = 1
        end
        local leech_rate = 0.05 + 0.01 * bs
        if WAR.XDLeech < 100 then
            WAR.XDLeech = WAR.XDLeech + limitX(math.modf(hurt * leech_rate), 0, 100)
            if WAR.XDLeech > 100 then
                WAR.XDLeech = 100
            end
        end
    end
    -- 内轻特效900
    if NeiGong_tx(pid, 900) and JLSD(0,dkfcj_ng*25,pid) then
        WAR.XHMGXX = WAR.XHMGXX + math.modf(hurt * dkfcj_ng * 10 / 100)
        local xxmax = math.modf(JY.Person[pid]['生命最大值'] * 0.05)
        if WAR.XHMGXX > xxmax + xldxx then
            WAR.XHMGXX = xxmax + xldxx
        end
    end
    --内功特效901血魔吸血
    if WAR.PD['血魔吸血'][pid] ~= nil and WAR.PD['血魔吸血'][pid] == 1 then 
        WAR.XHMGXX = WAR.XHMGXX + math.modf(hurt * dkfcj_ng * 10 / 100)
        lib.Debug('触发901吸血 ='..WAR.XHMGXX)
        local xxmax = math.modf(JY.Person[pid]['生命最大值'] * 0.05)
        if WAR.XHMGXX > xxmax + xldxx then
            WAR.PD['血魔'][pid] = WAR.PD['血魔'][pid] or 0 + (WAR.XHMGXX - xxmax)
            Cat('护盾停止', WAR.CurID)
            WAR.Person[WAR.CurID]['护盾'] = 13
            WAR.XHMGXX = xxmax + xldxx
        end
    end

    -- 向问天吸血
    if match_ID(pid, 234) then
        WAR.XWTXX = WAR.XWTXX + math.modf(hurt * 0.1)
    end

    -- 吸血蝙蝠10%，上限200点
    if match_ID(pid, 9818) then
        if WAR.WYXLeech < 100 then
            WAR.WYXLeech = WAR.WYXLeech + limitX(math.modf((hurt) * 0.1), 0, 200)
            if WAR.WYXLeech > 200 then
                WAR.WYXLeech = 200
            end
        end
    end

    -- 云中鹤吸血10%，上限100点
    if match_ID(pid, 100) and JY.Person[eid]["性别"] > 0 then
        if WAR.YZHLeech < 100 then
            WAR.YZHLeech = WAR.YZHLeech + limitX(math.modf((hurt) * 0.1), 0, 100)
            if WAR.YZHLeech > 100 then
                WAR.YZHLeech = 100
            end
        end
    end

    -- 长春不老被攻击后生命+80
    if match_ID(eid, 9869) and 0 < JY.Person[eid]["生命"] and hurt > 0 then
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +
                                                  AddPersonAttrib(eid, "生命", 80);
    end

    -- 除却四相 被攻击后50%几率生命+100
    if Pmiji(eid, 37) and JLSD(20, 70, eid) and 0 < JY.Person[eid]["生命"] and hurt > 0 then
        -- WAR.PD['吸星真气'][eid] = (WAR.PD['吸星真气'][eid] or 0) + 40
        WAR.PD['护盾值'][eid] = WAR.PD['护盾值'][eid] or 0 + 40
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +  AddPersonAttrib(eid, "生命", 100);
        Set_Eff_Text(enemyid, "特效文字2", "无寿者相")
    end

    -- 铁甲依然在	标记修改
    if Pmiji(eid, 10) and hurt > 0 and 0 < JY.Person[eid]["生命"] and JLSD(20, 40, eid) then
        local ts = math.modf(JY.Person[eid]["生命最大值"] * 0.02)
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +
                                                  AddPersonAttrib(eid, "生命", ts);
        Set_Eff_Text(enemyid, "特效文字0", "铁甲依然在")
    end

    -- 程英 杀内力
    if WAR.CY == 1 then
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -300);
    end
    -- 九龙拳
    if match_ID(pid, 744) and JLSD(0, 30, eid) then
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -100);
    end
    if WAR.PD["阵"][pid] ~= nil and WAR.PD["阵"][pid] == 1 then
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -200)
    end
    -- 进阶万岳，杀内力
    if (wugong == 33 or wugong == 373) and PersonKF(pid, 175) then
        local neiliLoss = hurt
        local tililoss = Rnd(2)
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -neiliLoss);
        WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + AddPersonAttrib(eid, "体力", -tililoss);
    end

    -- 阎基偷钱
    if eid ~= 591 and match_ID(pid, 4) and JY.Person[eid]["生命"] <= 0 and isteam(pid) then
        WAR.YJ = WAR.YJ + math.random(15) + 25
    end

    -- 先天罡气清蓄力
    if WAR.PD["先天罡气"][pid] ~= nil then
        if WAR.PD["蓄气值"][eid] ~= nil and WAR.PD["蓄气值"][eid] > 0 then
            WAR.PD["蓄气值"][eid] = nil
        end
        if WAR.PD["鲸息蓄力"][eid] ~= nil and WAR.PD["鲸息蓄力"][eid] > 0 then
            WAR.PD["鲸息蓄力"][eid] = nil
        end
        if WAR.PD["蛤蟆蓄力"][eid] ~= nil and WAR.PD["蛤蟆蓄力"][eid] > 0 then
            WAR.PD["蛤蟆蓄力"][eid] = nil
        end
    end

    -- 怒气值计算，斗转星移不加怒，指法大招不加怒
    if JY.Person[eid]["生命"] > 0 and hurt > 0 and (WAR.LQZ[eid] == nil or WAR.LQZ[eid] < 100) or
        (match_ID(eid, 9939) == false and Boss(enemyid)) then
        if DWPD(WAR.CurID, enemyid) and WAR.DZXY ~= 1 and WAR.LXYZ ~= 1 then
            -- if 0 < JY.Person[eid]["生命"] and hurt > 0 and (WAR.LQZ[eid] == nil or WAR.LQZ[eid] < 100) and WAR.Person[enemyid]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and WAR.DZXY ~= 1 and WAR.LXYZ ~= 1 then
            local lqzj1 = math.modf((hurt) / 40 + 1)
            local lqzj = lqzj1
            lqzj = math.random(lqzj, lqzj + 5)
            -- 敌人难度下额外增加的怒气值
            if WAR.Person[enemyid]["我方"] == false then
                local flqzj = 0
                if JY.Base["难度"] == 1 then
                    flqzj = 2
                elseif JY.Base["难度"] == 2 then
                    flqzj = 4
                else
                    flqzj = 6 + JY.Base["难度"]
                end
                lqzj = lqzj + flqzj;
            end

            if lqzj < 1 then
                lqzj = 1
            end

            if Curr_NG(pid, 102) then
                lqzj = math.modf(lqzj / 2)
            end

            -- 草木成佛
            if WAR.PD['西瓜刀'][pid] == 3 then
                -- 太玄之重，不加怒    
            elseif WAR.TXZZ == 1 then
                -- 东洋剑魔
            elseif match_ID(pid, 501) then
                -- 琴棋书画之持瑶琴不加怒
            elseif WAR.QQSH1 > 0 then
            else
                if WAR.LQZ[eid] == nil then
                    WAR.LQZ[eid] = lqzj + 2

                else
                    WAR.LQZ[eid] = (WAR.LQZ[eid] or 0 ) + lqzj + 2

                end
                if WAR.LQZ[eid] ~=nil and  WAR.LQZ[eid] > 100 then 
                    WAR.LQZ[eid] = 100
                end
            end
        end
    end

    -- 怒气暴发
    if WAR.LQZ[eid] ~= nil and 100 <= WAR.LQZ[eid] then
        WAR.LQZ[eid] = 100
        -- 东方不败，葵花秘法・化凤为凰
        if match_ID(eid, 27) and Curr_NG(eid, 105) then
            WAR.Person[enemyid]["特效动画"] = 7
            Set_Eff_Text(enemyid, "特效文字1", "葵花秘法・化凤为凰");
        elseif match_ID(eid, 9949) and JLSD(0, 60, eid) then
            WAR.Person[enemyid]["特效动画"] = 157
            Set_Eff_Text(enemyid, "特效文字1", "冰心见魔・入魔");
            WAR.PD['入魔'][eid] = 1
        elseif Curr_NG(eid, 160) and JLSD(0, 30, eid) then
            WAR.Person[enemyid]["特效动画"] = 157
            Set_Eff_Text(enemyid, "特效文字1", "天魔大法");
            WAR.PD['入魔'][eid] = 1
        else
            WAR.Person[enemyid]["特效动画"] = 6
            Set_Eff_Text(enemyid, "特效文字1", "怒气爆发");
        end
    end

    if WAR.PD['西瓜刀'][pid] == 3 then
        if WAR.LQZ[eid] == 100 then
            WAR.PD["昏迷状态"][eid] = 1
        end
        if WAR.LQZ[eid] ~= nil then
            WAR.LQZ[eid] = WAR.LQZ[eid] - 20
        end
    end

    -- 北冥吸怒，斗转不触发   
    -- if XiaoYaoYF(pid)  and WAR.DZXY ~= 1 and WAR.LQZ[eid] ~= nil and JLSD(25, 40 + math.modf(JY.Person[pid]["实战"]/20), pid) then
    if WAR.PD['吸怒气'][pid] ~= nil and WAR.DZXY ~= 1 and WAR.LQZ[eid] ~= nil and
        JLSD(25, 40 + math.modf(JY.Person[pid]["实战"] / 20), pid) then
        local pd = false
        local lq = WAR.LQZ[eid] or 0
        if lq >= 10 then
            WAR.BMSGXL = WAR.BMSGXL + 10
            WAR.LQZ[eid] = WAR.LQZ[eid] - 10
        else
            WAR.BMSGXL = WAR.BMSGXL + lq
            WAR.LQZ[eid] = 0
        end
        Set_Eff_Text(enemyid, "特效文字1", "气吞山河");
        WAR.PD['吸怒气'][pid] = nil
    end

    -- 指法大招清一半怒
    if WAR.LXYZ == 1 and WAR.LQZ[eid] ~= nil then
        WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
    end

    -- 菩提清心清一半怒
    if WAR.QQSH1 == 2 and WAR.LQZ[eid] ~= nil then
        WAR.LQZ[eid] = math.modf(WAR.LQZ[eid] * 0.5)
    end

    -- 触发太玄之重时，敌方已经暴怒的话，则有几率清怒，
    if WAR.TXZZ == 1 and WAR.LQZ[eid] ~= nil  and
        JLSD(20, 45 + JY.Person[pid]["实战"] / 20, pid) then
        local lq = ekfcj_ng*5
        WAR.LQZ[eid] = WAR.LQZ[eid] - lq
        Set_Eff_Text(enemyid, "特效文字1", "救赵挥金锤.邯郸先震惊");
    end

    -- 立地成佛
    if WAR.PD["立地成佛"][pid] == 1 then
        local lq = WAR.LQZ[eid] or 0
        if lq > 0 then
            if myfx(enemyid) == false then
                fxsz = fxsz + math.modf(lq / 2)
            end
            if myns(enemyid) == false then
                nssz = nssz + math.modf(lq / 2)
            end
            WAR.LQZ[eid] = 0
        end
        WAR.PD["立地成佛"][pid] = nil
    end

    -- 防止怒气小于0
    if WAR.LQZ[eid] ~= nil and WAR.LQZ[eid] < 0 then
        WAR.LQZ[eid] = 0
    end

    -- 中庸之道 标记修改
    if Pmiji(eid, 2) and WAR.LQZ[eid] == 100 then
        local zz = JY.Person[eid]['资质']
        local jl = limitX(zz - 29, 2, 50)
        if JLSD(0, jl, eid) then
            WAR.Person[enemyid]["特效动画"] = 6
            Set_Eff_Text(enemyid, "特效文字0", "中庸之道")
            Cat('立刻出手', enemyid)
            WAR.ACT = 10
            WAR.ZYHB = 0
        end
    end

    -- 梵我合一 标记修改
    if ((Curr_NG(eid, 233) and PersonKF(eid, 169)) or (Curr_NG(eid, 169) and PersonKF(eid, 233))) and JLSD(30, 50, eid) and
        (WAR.BJ == 1 or WAR.ATNum > 1) then
        Set_Eff_Text(enemyid, "特效文字0", "梵我合一")
        WAR.ACT = 10
    end

    if WAR.ZDDH == 386 and eid == 742 then
        WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
        JY.Person[eid]["生命"] = 0
    end
    -- 成不忧 被令狐冲 秒杀
    if WAR.ZDDH == 205 and eid == 141 then
        WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
        JY.Person[eid]["生命"] = 0
    end
    -- 苗人凤秒杀阎基
    if WAR.ZDDH == 370 and eid == 4 then
        WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
        JY.Person[eid]["生命"] = 0
    end

    if WAR.ZDDH >= 0 and JY.Person[pid]["坐骑"] == 312 and hurt > 0 then
        WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
        -- JY.Person[eid]["生命"] = 0
    end
    -- 丁敏君 被周芷若 秒杀
    if WAR.ZDDH == 279 and eid == 632 then
        WAR.Person[enemyid]["生命点数"] = -JY.Person[eid]["生命"];
        JY.Person[eid]["生命"] = 0
    end

    -- 逍遥子 梅花三弄2
    if WAR.MHSN == 2 and WAR.ACT == 1 then
        local xnl = nil
        xnl = math.modf(JY.Person[eid]["内力"] * 0.05)
        -- 方证不会被吸
        if match_ID(eid, 149) then
            xnl = 0
        end
        WAR.Person[enemyid]["内力点数"] = AddPersonAttrib(eid, "内力", -xnl);
    end

    -- 吸内力
    if WAR.BMXH == 1 and 0 < hurt then
        local xnl = dkfcj_ng * 100
        -- 吸星魔帝
        if match_ID(pid, 9764) or match_ID(pid, 26) then
            local n = 500
            if Boss(WAR.CurID) then
                n = n * 2
            end
            xnl = xnl + n
        end
        -- 方证不会被吸
        if match_ID(eid, 149) then
            xnl = 0
        end
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
        WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", xnl)
        -- 吸星魔帝吸不到内就会直接杀血
        if xnl > JY.Person[eid]['内力'] then
            if match_ID(pid, 26) and Boss(WAR.CurID) then
                local sm = math.modf((xnl - JY.Person[eid]['内力']) / 2)
                WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -sm);
            end
        end
        if (match_ID(pid, 26) and Boss(WAR.CurID)) and Curr_NG(pid, 160) then
            if JY.Person[pid]['内力最大值'] - JY.Person[pid]['内力'] < xnl then
                local xn = xnl - (JY.Person[pid]['内力最大值'] - JY.Person[pid]['内力'])
                if WAR.PD['护盾值'][pid] == nil then
                    -- WAR.Person[WAR.CurID]['护盾'] = 
                    Cat('护盾停止', WAR.CurID)
                end
                -- WAR.PD['吸星真气'][pid] = limitX((WAR.PD['吸星真气'][pid] or 0) + math.modf(xn/2),0,JY.Person[pid]['生命最大值']*0.1)
                WAR.PD['护盾值'][eid] = limitX((WAR.PD['护盾值'][pid] or 0) + math.modf(xn / 2), 0,JY.Person[pid]['生命最大值'] * 0.1)
            end
        end
        -- 畅想无崖子发动北冥时吸取生命值
        if WAR.BMXH == 1 and match_ID(pid, 9801) and JLSD(0, 30, pid) then
            WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) + AddPersonAttrib(eid, "生命", -xnl);
            WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) + AddPersonAttrib(pid, "生命", xnl)
        end
    end

    -- 吸星
    if WAR.PD['吸体力'][pid] ~= nil and WAR.PD['吸体力'][pid] > 0 and 0 < hurt then
        -- 吸星大法，一般人吸3-4体力
        local xt1 = 3 + Rnd(2)
        local n = AddPersonAttrib(eid, "体力", -xt1)
        local m = AddPersonAttrib(pid, "体力", xt1)
        -- 任我行 额外吸3体力
        if match_ID(pid, 26) then
            n = n + AddPersonAttrib(eid, "体力", -3)
            m = m + AddPersonAttrib(pid, "体力", 3)
        end
        WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + n;
        WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + m;
        WAR.PD['吸体力'][pid] = nil
    end
    -- 化功
    if WAR.PD['化内力'][pid] ~= nil and 0 < hurt then
        local xnl = dkfcj_ng * 100
        WAR.Person[enemyid]["生命点数"] = (WAR.Person[enemyid]["生命点数"] or 0) +
                                                  AddPersonAttrib(eid, "生命", -xnl);
        WAR.PD['化内力'][pid] = nil
    end

    -- 田伯光
    if match_ID(pid, 29) and JY.Person[eid]["性别"] > 0 and 0 < hurt then
        local xnl = nil
        xnl = math.modf(JY.Person[eid]["内力"] * 0.05)
        if xnl < 100 then
            xnl = 100
        elseif xnl > 300 then
            xnl = 300
        end
        local xtl = math.modf(xnl * 0.01)
        WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", -xnl);
        WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", xnl)
        WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) +  AddPersonAttrib(eid, "体力", -xtl);
        WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) + AddPersonAttrib(pid, "体力", xtl)
    end

    -- 海大富化骨绵掌
    if wugong == 118 and 0 < hurt and match_ID(pid, 602) then
        local xnl = nil
        xnl = math.modf(JY.Person[eid]["内力"] * 0.05)
        if xnl < 100 then
            xnl = 100
        elseif xnl > 300 then
            xnl = 300
        end
        WAR.Person[enemyid]["内力点数"] = AddPersonAttrib(eid, "内力", -xnl);

        local xt1 = 3 + Rnd(2)
        local n = AddPersonAttrib(eid, "体力", -xt1)
        WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) + n;
    end

    if hurt > 0 and DWPD(WAR.CurID, enemyid) then
        local xnl = 200
        local pd = false
        -- 内轻特效810 被攻击时概率吸取内力值
        if NeiGong_tx(eid, 810) and JLSD(0, ekfcj_ng * 25, eid) then
            pd = true
            xnl = ekfcj_ng * 100
            -- 逍遥游
            -- 主运北冥挨打也吸内
        elseif PersonKF(eid, 85) and JY.Person[eid]['奇穴' .. 135] == 1 and JLSD(20, 70, eid) then
            pd = true
        end
        if pd == true then
            -- 方证不会被吸
            if match_ID(pid, 149) then
                xnl = 0
            end
            -- 吸星魔帝
            if match_ID(eid, 9964) then
                local n = 200
                if Boss(enemyid) then
                    n = n * 2
                end
                xnl = xnl + n
            end
            -- 吸星魔帝吸不到内就会直接杀血
            if xnl > JY.Person[pid]['内力'] then
                if match_ID(eid, 9964) then
                    local sm = math.modf((xnl - JY.Person[pid]['内力']) / 2)
                    if Boss(enemyid) then
                        sm = sm * 2
                    end
                    WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +  AddPersonAttrib(pid, "生命", -sm);
                end
            end

            if match_ID(eid, 26) and Boss(enemyid) then
                if JY.Person[eid]['内力最大值'] - JY.Person[eid]['内力'] < xnl then
                    local xn = xnl - (JY.Person[eid]['内力最大值'] - JY.Person[eid]['内力'])
                    if WAR.PD['护盾值'][eid] == nil then
                        Cat('护盾停止', enemyid)
                        WAR.Person[enemyid]['护盾'] = 6
                    end
                    -- WAR.PD['吸星真气'][eid] = limitX((WAR.PD['吸星真气'][eid] or 0) + math.modf(xn/2),0,JY.Person[eid]['生命最大值']*0.3)
                    WAR.PD['护盾值'][eid] = limitX((WAR.PD['护盾值'][eid] or 0) + math.modf(xn / 2), 0,JY.Person[eid]['生命最大值'] * 0.3)
                end
            end
            WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -xnl)
            WAR.Person[enemyid]["内力点数"] = (WAR.Person[enemyid]["内力点数"] or 0) + AddPersonAttrib(eid, "内力", xnl)
            AddPersonAttrib(eid, "内力最大值", 2000)
            WAR.Person[enemyid]["特效动画"] = 63
            Set_Eff_Text(enemyid, "特效文字1", "吸内");
        end
    end

    -- 内轻特效828 受到攻击概率减少攻击方内力
    if hurt > 0 and DWPD(WAR.CurID, enemyid) then
        local hgxl = false
        if NeiGong_tx(eid, 828) and 0 < hurt and JLSD(20, ekfcj_ng * 25, eid) then
            hgxl = true
            -- 观星    
        elseif JY.Person[eid]['奇穴' .. 142] == 1 and PersonKF(eid, 87) and JLSD(20, 70, eid) then
            hgxl = true
        end
        if hgxl == true then
            local xnl = 200
            -- 方证不会被吸
            if match_ID(pid, 149) then
                xnl = 0
            end
            WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) +  AddPersonAttrib(pid, "内力", -xnl)
            WAR.Person[enemyid]["特效动画"] = 64
            Set_Eff_Text(enemyid, "特效文字1", "化功");
        end
    end
    -- 内轻特效811 被攻击时概率吸取体力值
    if hurt > 0 and DWPD(WAR.CurID, enemyid) then
        local hgxl = false
        local xtl = ekfcj_ng * 2
        if NeiGong_tx(eid, 811) and 0 < hurt and JLSD(20, ekfcj_ng * 25, eid) then
            hgxl = true
        end
        if hgxl == true then
            local xnl = 200
            -- 方证不会被吸
            if match_ID(pid, 149) then
                xnl = 0
            end
            WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) +
                                                        AddPersonAttrib(pid, "体力", -xtl)
            WAR.Person[enemyid]["体力点数"] = (WAR.Person[enemyid]["体力点数"] or 0) +
                                                      AddPersonAttrib(eid, "体力", xtl);
            WAR.Person[enemyid]["特效动画"] = 64
            Set_Eff_Text(enemyid, "特效文字1", "吸体");
        end
    end
    -- 内轻特效812 被攻击时概率吸取怒气值
    if hurt > 0 and DWPD(WAR.CurID, enemyid) then
        local hgxl = false
        local xtl = ekfcj_ng * 2
        if NeiGong_tx(eid, 812) and 0 < hurt and JLSD(20, ekfcj_ng * 25, eid) then
            hgxl = true
        end
        if hgxl == true then
            -- 方证不会被吸
            if match_ID(pid, 149) then
                xnl = 0
            end
            if WAR.LQZ[WAR.Person[WAR.CurID]["人物编号"]] ~= nil and WAR.LQZ[WAR.Person[WAR.CurID]["人物编号"]] >
                0 then
                if WAR.LQZ[WAR.Person[WAR.CurID]["人物编号"]] <= xtl then
                    xtl = WAR.LQZ[WAR.Person[WAR.CurID]["人物编号"]]
                end
            end
            WAR.LQZ[eid] = (WAR.LQZ[eid] or 0) + xtl
            WAR.LQZ[WAR.Person[WAR.CurID]["人物编号"]] = (WAR.LQZ[WAR.Person[WAR.CurID]["人物编号"]] or 0) - xtl
            -- WAR.Person[enemyid]["特效动画"] = 64
            Set_Eff_Text(enemyid, "特效文字1", "吸怒");
            if WAR.LQZ[eid] >= 100 then
                WAR.LQZ[eid] = 100
                WAR.Person[enemyid]["特效动画"] = 6
                Set_Eff_Text(enemyid, "特效文字1", "怒气爆发");
            end
        end
    end
    --内轻特效1039
    if NeiGong_tx(eid,1039) then
        local md = false
        if WAR.LQZ[eid] == 100 and JLSD(0, 50, eid) then
            md = true
        end
        if JLSD(0, 25, eid) then
            md = true
        end
        if md == true then
            local wq = math.random(3)
            if wq == 1 then 
                WAR.PD['我无'][eid] = 1
            elseif wq == 2 then 
                WAR.PD['师教'][eid] = 1
            elseif wq == 3 then 
                WAR.PD['君王'][eid] = 1
            end
        end
    end
    ----------------流血统一计算--------------------------
    -- 装备倚天剑，屠龙刀第一种特效，奇门标主大招，必流血，其他30%几率流血
    -- 防御方带6级金丝免疫流血  标记修改
    if hurt > 30 and mylx(enemyid) == false then
        -- 倚天剑，必流血
        -- 1级70%几率流血
        -- 4级开始追加灼烧
        if JY.Person[pid]["武器"] == 37 then
            if JLSD(0, 40 + JY.Thing[37]["装备等级"] * 10, pid) then
                WAR.BLX = 1
            end
        end
        -- 狼牙，必流血
        -- 1级70%几率流血
        if JY.Person[pid]["武器"] == 320 then
            if JLSD(0, 40 + JY.Thing[320]["装备等级"] * 10, pid) then
                WAR.BLX = 1
            end
        end
        -- 内轻特效500
        if NeiGong_tx(pid, 500) and JLSD(0, dkfcj_ng * 25, pid) then
            WAR.BLX = 1
        end
        -- 锐金旗使
        if match_ID(pid, 305) then
            WAR.BLX = 1
        end
        -- 田归农装备闯王军刀，必流血
        if JY.Person[pid]["武器"] == 202 and match_ID(pid, 72) then
            WAR.BLX = 1
        end
        -- 陆无双，必流血
        if match_ID(pid, 580) then
            WAR.BLX = 1
        end
        -- 钟灵必流血
        if match_ID(pid, 90) or match_ID(pid, 9879) then
            WAR.BLX = 1
        end

        -- 剑法刀法45%几率流血
        if (WGLX == 3 or WGLX == 4) and JLSD(30, 75, pid) then
            WAR.BLX = 1
        end

        -- 沧溟刀法特效，必流血
        if WAR.CMDF == 1 then
            WAR.BLX = 1
        end

        -- 主运血河神鉴，必流血
        if Curr_NG(pid, 163) then
            WAR.BLX = 1
        end

        -- 毒王大招必流血
        if WAR.YTML == 1 then
            WAR.BLX = 1
        end
        -- 一剑无血
        if match_ID(pid, 150) then
            WAR.BLX = 1
            lib.Debug("必流血")
        end
        -- 龙爪手必流血
        if wugong == 20 then
            WAR.BLX = 1
        end
        -- 凝血神爪必流血
        if wugong == 134 then
            WAR.BLX = 1
        end
        -- 绣花针必流血
        if JY.Person[pid]["武器"] == 349 then
            WAR.BLX = 1
        end
        if WAR.PD['野球拳'][pid] == 2 then
            WAR.BLX = 1
        end

        local lxpd = false
        if match_ID(pid, 9848) == false then
            lxpd = true
        elseif (JY.Person[eid]["武器"] == 239 and JY.Thing[239]["装备等级"] == 6) == false then
            lxpd = true
        elseif WAR.L_TLD == 1 or WAR.BLX == 1 or WAR.GCTJ == 1 then
            lxpd = true
            WAR.BLX = 0
        end
        if lxpd == true then
            lxsz = lxsz + math.modf(hurt / 10)
        end
        -- 内轻特效517
        if NeiGong_tx(pid, 517) and JLSD(0, dkfcj_ng * 25, pid) then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            lxsz = lxsz + num
        end
        -- 剑法流血
        if JY.Wugong[wugong]["武功类型"] == 3 then
            lxsz = lxsz + JY.Wugong[wugong]["层级"] * 10
        end
        -- 奇门流血
        if JY.Wugong[wugong]["武功类型"] == 5 then
            if WAR.PD["奇门DEBUF"][pid] == 3 then
                lxsz = lxsz + JY.Wugong[wugong]["层级"] * 10
                WAR.PD["奇门DEBUF"][pid] = nil
            end
        end
        -- 招式流血
        for i = 1, JY.Base["武功数量"] do
            local kf = JY.Person[pid]["武功" .. i]
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                local kflv = JY.Wugong[yxsy]['层级']
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    if kf == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 11 and JY.Wugong[yxsy]["招式" .. j] <= 14 then
                            lxsz = limitX(lxsz + math.random(kflv * 5, kflv * 10), 0, 100)
                        end
                    end
                end
            end
        end
    end
    local liuxuebs = 1
    if WAR.PD["无血状态"][eid] ~= nil then
        liuxuebs = liuxuebs * 2
    end
    lxsz = lxkx(enemyid, lxsz) * liuxuebs
    lxsz = limitX(math.modf(lxsz), 0, 100)

    if lxsz > 0 then
        WAR.LXZT[eid] = limitX((WAR.LXZT[eid] or 0) + lxsz, 0, 100)
        WAR.LXXS[eid] = 1
        if WAR.LXZT[eid] ~= nil and WAR.LXZT[eid] > 0 then -- 流血
            WAR.PD["流血"][eid] = WAR.LXZT[eid]
        end
    end

    ----------------封穴统一计算--------------------------
    if hurt > 30 and myfx(enemyid) == false then
        -- 拳主大招，高几率封穴
        if WAR.LXZQ == 1 and JLSD(25, 75, pid) then
            WAR.BFX = 1
        end
        if match_ID(pid, 613) and wugong == 206 and JLSD(10, 60, pid) then
            WAR.BFX = 1
        end
        -- 琴棋书画之倚天屠龙功，必封穴
        if WAR.QQSH3 == 1 then
            WAR.BFX = 1
        end
        -- 神门十三剑，必封穴
        if wugong == 236 then
            WAR.BFX = 1
        end
        if Pmiji(pid, 16) and wugong == 64 then
            WAR.BFX = 1
        end
        -- 奇门主角大招，必封穴
        if WAR.GCTJ == 1 then
            WAR.BFX = 1
        end

        -- 一阳指50%几率封穴，优先判定
        if wugong == 17 and JLSD(30, 80, pid) then
            WAR.BFX = 1
        end

        -- 拳法指法45%几率封穴
        if (WGLX == 1 or WGLX == 2) and JLSD(30, 75, pid) then
            WAR.BFX = 1
        end

        if wugong == 226 then
            WAR.BFX = 1
        end

        -- 毒王大招必封穴
        if WAR.YTML == 1 then
            WAR.BFX = 1
        end
        -- 星罗散手必封穴
        if match_ID(pid, 9732) then
            WAR.BFX = 1
        end
        -- 岳云岳王散手必封穴
        if match_ID(pid, 568) and wugong == 198 then
            WAR.BFX = 1
        end

        -- 穴袖拂穴必封穴
        if wugong == 201 then
            WAR.BFX = 1
        end

        if WAR.PD['戳字决'][pid] == 1 then
            WAR.BFX = 1
        end

        -- 黄药师高几率封穴
        if match_ID(pid, 57) and JLSD(0, 50, pid) then
            WAR.BFX = 1
        end

        -- 伤害小于50无封穴，指法额外封穴，一阳指高封穴，其他30%几率封穴
        -- 除却四相免疫封穴
        -- if     then
        if WAR.BFX == 1 then
            -- 无酒不欢：使用分段函数
            if hurt >= 50 and hurt < 200 then
                fxsz = fxsz + math.random(1, 5)
            elseif hurt >= 200 and hurt <= 500 then
                fxsz = fxsz + math.random(3, 8)
            elseif hurt > 500 then
                fxsz = fxsz + math.random(5, 10)
            end
            WAR.BFX = 0
        end
        -- 主运混元，造成的封穴效果提高20%
        if Curr_NG(pid, 90) then
            fxsz = math.modf(fxsz * 1.2)
        end
        -- 隔空点穴
        if match_ID(pid, 9743) then
            fxsz = fxsz + 10
        end
        -- 定神门
        if Pmiji(pid, 72) then
            fxsz = fxsz + 5
        end
        if WAR.PD['戳字决'][pid] == 1 then
            fxsz = fxsz + 10
        end
        -- 穿云劲
        if JY.Person[pid]["奇穴" .. 6] == 1 then
            fxsz = fxsz + 5
        end
        -- 招式封穴
        for i = 1, JY.Base["武功数量"] do
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    local wugong = JY.Person[pid]["武功" .. i]
                    if wugong == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 21 and JY.Wugong[yxsy]["招式" .. j] <= 24 and hurt > 30 then
                            if JY.Wugong[yxsy]["招式" .. j] == 21 then
                                fxsz = limitX(fxsz + math.random(1, 3), 0, 20)
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 22 then
                                fxsz = limitX(fxsz + math.random(2, 5), 0, 20)
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 23 then
                                fxsz = limitX(fxsz + math.random(3, 8), 0, 20)
                            end
                            if JY.Wugong[yxsy]["招式" .. j] == 24 then
                                fxsz = limitX(fxsz + math.random(4, 10), 0, 20)
                            end
                        end
                    end
                end
            end
        end
        -- 奇门封穴
        if JY.Wugong[wugong]["武功类型"] == 5 then
            if WAR.PD["奇门DEBUF"][pid] == 2 then
                local n = math.random(JY.Wugong[wugong]["层级"], JY.Wugong[wugong]["层级"] * 2 + 2)
                fxsz = fxsz + n
                WAR.PD["奇门DEBUF"][pid] = nil
            end
        end
        -- 内轻特效513
        if NeiGong_tx(pid, 513) and JLSD(0, dkfcj_ng * 25, pid) then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            fxsz = fxsz + num
        end
        -- 指法封穴
        if JY.Wugong[wugong]["武功类型"] == 2 then
            local n = math.random(JY.Wugong[wugong]["层级"], JY.Wugong[wugong]["层级"] * 2 + 2)
            fxsz = fxsz + n
        end
        -- 白展堂被打反10点封穴
        if match_ID(eid, 9743) and myfx(WAR.CurID) == false then
            fxsz1 = fxsz1 + 10
        end

        if WAR.PD['野球拳'][pid] == 2 and 0 < hurt and myfx(enemyid) == false then
            local lx = WAR.LXZT[eid] or 0
            if lx >= 25 then
                WAR.LXXS[eid] = nil
                fxsz = fxsz + lx
                WAR.LXZT[eid] = nil
                Set_Eff_Text(enemyid, "特效文字1", "逆血封穴")
            end
        end

        -- 太玄反震，50%几率给攻击方上封穴
        if NeiGong_tx(eid,1041) and hurt > 0 then
            local pd = 0
            local jl = 0
            if match_ID(eid, 9759) then
                pd = 1
            elseif (CC.TX['太玄觉醒'] == 2 and JY.Person[eid]['奇穴' .. 95] == 1 ) or not isteam(eid) then
                pd = 1
                if JY.Person[eid]['奇穴' .. 95] == 1 then
                    jl = 5
                end
            end
            if pd == 1 and math.random(100) <= (50 + jl) then
                WAR.PD['太玄反震'][eid] = 1
                WAR.Person[enemyid]["特效动画"] = math.modf(wugong, 10) + 85
                Set_Eff_Text(enemyid, 2, "太玄反震")
                fxsz1 = fxsz1 + 10
                if JLSD(0,ekfcj_ng*5,eid) then 
                    WAR.PD['眩晕状态'][pid] = 2
                end
            end
        end
        -- 判官笔封穴
        if WAR.PD["判官笔封穴"][eid] ~= nil then
            fxsz1 = WAR.PD["判官笔封穴"][eid] + fxsz1
        end
        fxsz = fxsz + fxsz1

        -- end
    end

    local fxbs = 1
    local tglx = {143, 144, 145, 146, 147, 148}
    for i = 1, #tglx do
        if match_ID(pid, tglx[i]) and JY.Wugong[wugong]["武功类型"] == 2 then
            fxbs = fxbs + 1
        end
    end
    -- 下雨天
    if CC.Weather[1][1] > 0 and CC.TX['战斗天气'] == 0  then
        fxbs = fxbs - 0.5
    end
    -- 有雾天
    if CC.Weather[3][1] > 0 and CC.TX['战斗天气'] == 0  then
        fxbs = fxbs + 1
    end
    fxsz = fxkx(enemyid, fxsz) * fxbs

    fxsz = limitX(math.modf(fxsz), 0, 20)

    if fxsz > 0 and myfx(enemyid) == false then
        WAR.FXDS[eid] = limitX((WAR.FXDS[eid] or 0) + fxsz, 0, 20)
        WAR.FXXS[eid] = 1
        if WAR.FXDS[eid] ~= nil and WAR.FXDS[eid] > 0 then -- 封穴
            WAR.PD["封穴"][eid] = WAR.FXDS[eid]
        end
    end
    ----------------灼烧统一计算--------------------------
    if hurt > 30 and myzs(enemyid) == false then
        -- 灼烧计算

        -- 阳内九阳必灼烧
        if JY.Wugong[wugong]["灼烧系数"] == 1 and
            ((Curr_NG(pid, 106) and (JY.Person[pid]["内力性质"] == 1 or JY.Person[pid]["内力性质"] == 3)) or
                JLSD(10, 90, pid)) then
            WAR.BZS = 1
        end
        -- 火蟾
        if match_ID(pid, 440) then
            WAR.BZS = 1
        end
        -- 内轻特效503
        if NeiGong_tx(pid, 503) and JLSD(0, dkfcj_ng * 25, pid) then
            WAR.BZS = 1
        end
        -- 圣火明尊
        if match_ID(pid, 9992) then
            WAR.BZS = 1
        end
        -- 烈火旗使
        if match_ID(pid, 302) then
            WAR.BZS = 1
        end

        -- 苗人凤，天门，张三，高几率灼烧
        if (match_ID(pid, 3) or match_ID(pid, 23) or match_ID(pid, 41)) and JLSD(10, 90, pid) then
            WAR.BZS = 1
        end

        -- 毒王大招必灼烧
        if WAR.YTML == 1 then
            WAR.BZS = 1
        end

        if Pmiji(pid, 16) and wugong == 236 then
            WAR.BZS = 1
        end

        -- 六脉大招1 天山六阳掌
        if WAR.DSP_LM2 == 1 and wugong == 8 then
            WAR.BZS = 1
        end
        -- 林殊必灼烧
        if match_ID(pid, 9745) then
            WAR.BZS = 1
        end
        -- 寇仲必灼烧
        if match_ID(pid, 578) and JY.Person[pid]["内力性质"] == 1 then
            WAR.BZS = 1
        end
        -- 九字真言 在
        if WAR.PD["在"][pid] ~= nil and WAR.PD["在"][pid] == 1 then
            WAR.BZS = 1
        end
        -- 阴阳流1	
        if WAR.BHJTZ1 == 1 then
            WAR.BZS = 1
        end

        -- 丁当
        if match_ID(pid, 581) then
            WAR.BZS = 1
        end

        -- 长生
        --内轻特效1020
        if WAR.BZS == 1 and NeiGong_tx(pid,1020) then
            WAR.BBF = 1
        elseif WAR.BBF == 1 and NeiGong_tx(pid,1020) then
            WAR.BZS = 1
        end
        -- 浴火
        if JY.Person[eid]['奇穴' .. 54] == 1 then
            if JLSD(0, 100, eid) then
                WAR.BZS = 1
            end
        end
        --火延
        if WAR.PD['火延'][pid] ~= nil and  WAR.PD['火延'][pid] == 1 then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            for i = 0 , WAR.PersonNum - 1 do 
                if WAR.Person[i]['死亡'] == false and WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then 
                    zssz = zssz + num 
                end 
            end     
            WAR.PD['火延'][pid] = nil       
        end
        -- 必灼烧
        if WAR.BZS == 1 then
            local zsz = math.modf(hurt / 15)
            zssz = zssz + zsz
            -- 奇门灼烧
            if JY.Wugong[wugong]["武功类型"] == 5 then
                if WAR.PD["奇门DEBUF"][pid] == 4 then
                    -- local n = math.random(JY.Wugong[wugong]["层级"],JY.Wugong[wugong]["层级"]*2+2) 
                    zssz = zssz + JY.Wugong[wugong]["层级"] * 10
                    WAR.PD["奇门DEBUF"][pid] = nil
                end
            end
            WAR.BZS = 0
        end
        -- 内轻特效515
        if NeiGong_tx(pid, 515) and JLSD(0, dkfcj_ng * 25, pid) then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            zssz = zssz + num
        end
        -- 招式灼烧
        for i = 1, JY.Base["武功数量"] do
            local kf = JY.Person[pid]["武功" .. i]
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                local kflv = JY.Wugong[yxsy]['层级']
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    if kf == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 31 and JY.Wugong[yxsy]["招式" .. j] <= 34 and hurt > 30 then
                            zssz = limitX(zssz + math.random(kflv * 3, kflv * 5), 0, 100)
                        end
                    end
                end
            end
        end

    end
    local zhuoshaobs = 1
    -- 下雪天
    if CC.Weather[2][1] > 0 and CC.TX['战斗天气'] == 0  then
        zhuoshaobs = zhuoshaobs - zhuoshaobs / 2
    end
    -- 晴天
    if CC.Weather[4][1] > 0 and CC.TX['战斗天气'] == 0  then
        zhuoshaobs = zhuoshaobs + 1
    end
    -- 浴火
    if JY.Person[pid]['奇穴' .. 54] == 1 then
        zhuoshaobs = zhuoshaobs + 1
    end
    zssz = zskx(enemyid, zssz) * zhuoshaobs
    zssz = limitX(math.modf(zssz), 0, 50)

    if zssz > 0 and myzs(enemyid) == false and hurt > 30 then
        AddPersonAttrib(eid, "灼烧程度", zssz);
        WAR.ZSXS[eid] = 1
        if JY.Person[eid]["灼烧程度"] > 0 then
            WAR.PD["灼烧"][eid] = JY.Person[eid]["灼烧程度"] -- 灼烧
        end
    end
    ----------------冰封统一计算--------------------------   
    if hurt > 30 and mybf(enemyid) == false then
        -- 内轻特效502
        if NeiGong_tx(pid, 502) and JLSD(0, dkfcj_ng * 25, pid) then
            WAR.BBF = 1
        end
        -- 凛冽
        if JY.Person[eid]['奇穴' .. 76] == 1 then
            -- JY.Person[pid]['冰封程度'] = JY.Person[pid]['冰封程度'] + 20
            AddPersonAttrib(pid, "冰封程度", 20);
            WAR.BFXS[eid] = 1
        end
        -- 冰封计算 
        -- 阴内九阴必冰封
        if JY.Wugong[wugong]["冰封系数"] == 1 and ((Curr_NG(pid, 107) and (JY.Person[pid]["内力性质"] == 0 or JY.Person[pid]["内力性质"] == 3)) or JLSD(10, 90, pid)) then
            WAR.BBF = 1
        end

        -- 寒冰真气 必冰封
        if PersonKF(pid, 216) or match_ID(pid, 9978) then
            WAR.BBF = 1
        end
        -- 雪怪
        for i = 420, 429 do
            if match_ID(pid, i) then
                WAR.BBF = 1
            end
        end
        -- 灵犀分水功
        if Curr_NG(pid, 362) and JY.Wugong[wugong]["门派"] == 6 then
            WAR.BBF = 1
        end
        -- 林朝英流风回雪
        if WAR.LFHX == 1 then
            WAR.BBF = 1
        end

        -- 琴棋书画的妙笔丹青特效
        if WAR.QQSH2 >= 1 then
            WAR.BBF = 1
        end

        -- 玉箫剑法配合桃花绝技60%冰封
        if wugong == 38 and Pmiji(pid, 5) and JLSD(20, 80, pid) then
            WAR.BBF = 1
        end

        -- 左冷禅，李四，高几率冰封
        if (match_ID(pid, 22) or match_ID(pid, 42)) and JLSD(10, 90, pid) then
            WAR.BBF = 1
        end
        -- 胡一刀攻击冰封
        if match_ID(pid, 633) and JY.Person[pid]["武器"] == 45 then
            WAR.BBF = 1
        end
        -- 毒王大招必冰封
        if WAR.YTML == 1 then
            WAR.BBF = 1
        end
        -- 白绣必冰封
        if match_ID(pid, 582) then
            WAR.BBF = 1
        end
        -- 白万剑必冰封
        if match_ID(pid, 43) or match_ID(pid, 9823) then
            WAR.BBF = 1
        end
        -- 阴阳流2	
        if WAR.BHJTZ1 == 1 then
            WAR.BBF = 1
        end
        -- 内轻特效514
        if NeiGong_tx(pid, 514) and JLSD(0, dkfcj_ng * 25, pid) then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            bfsz = bfsz + num
        end
        -- 雪花神剑
        if WAR.BXXHSJ == 1 then
            if WAR.Person[enemyid]["特效动画"] == -1 or WAR.Person[enemyid]["特效动画"] == 63 then
                WAR.Person[enemyid]["特效动画"] = 80
            end
            bfsz = bfsz + 10 + Rnd(10)
        end
        -- 招式冰封
        for i = 1, JY.Base["武功数量"] do
            local kf = JY.Person[pid]["武功" .. i]
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                local kflv = JY.Wugong[yxsy]['层级']
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    if kf == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 41 and JY.Wugong[yxsy]["招式" .. j] <= 44 then
                            bfsz = limitX(bfsz + math.random(kflv * 3, kflv * 5), 0, 100)
                        end
                    end
                end
            end
        end
        -- 奇门冰封
        if JY.Wugong[wugong]["武功类型"] == 5 then
            if WAR.PD["奇门DEBUF"][pid] == 5 then
                -- local n = math.random(JY.Wugong[wugong]["层级"],JY.Wugong[wugong]["层级"]*2+2) 
                zssz = zssz + JY.Wugong[wugong]["层级"] * 10
                WAR.PD["奇门DEBUF"][pid] = nil
            end
        end

        -- 金乌映雪
        if Pmiji(pid, 21) and wugong == 61 then
            bfsz = bfsz + zssz
        end
        -- 金乌映雪
        if Pmiji(pid, 21) and wugong == 35 then
            zssz = zssz + bfsz
        end
        -- 除却四相 寒冰真气 免疫冰封
        if WAR.BBF == 1 then
            local bfz = math.modf(hurt / 15)
            bfsz = bfsz + bfz
            WAR.BBF = 0
        end
    end
    local bingfengbs = 1
    -- 下雪天
    if CC.Weather[2][1] > 0 and CC.TX['战斗天气'] == 0  then
        bingfengbs = bingfengbs + 1
    end
    -- 晴天
    if CC.Weather[4][1] > 0 and CC.TX['战斗天气'] == 0  then
        bingfengbs = bingfengbs * 0.5
    end

    -- 琴棋书画的妙笔丹青特效江山如画
    if WAR.QQSH2 == 2 then
        bingfengbs = bingfengbs + 1
    end
    -- 凛冽
    if JY.Person[pid]['奇穴' .. 76] == 1 then
        bingfengbs = bingfengbs + 1
    end
    bfsz = bfkx(enemyid, bfsz) * bingfengbs

    bfsz = limitX(math.modf(bfsz), 0, 100)

    if bfsz > 0 and hurt > 30 then
        AddPersonAttrib(eid, "冰封程度", bfsz);
        WAR.BFXS[eid] = 1
        if JY.Person[eid]["冰封程度"] > 0 then -- 冰封
            WAR.PD["冰封"][eid] = JY.Person[eid]["冰封程度"]
        end
    end
    ----------------内伤统一计算--------------------------
    if hurt > 30 and myns(enemyid) == false then
        -- 破气防后内伤计算
        -- 除却四相免疫内伤
        -- 毒王大招不破气防也上内伤  
        -- 内轻特效504
        if NeiGong_tx(pid, 504) then
            nssz = limitX((hurt) / 16, 5, 20)
        end
        if (WAR.YTML == 1 or match_ID(pid, 80)) and dng == 0 then
            local n = 0; -- 内伤点数值
            -- 冰肌玉骨
            if match_ID(eid, 9924) then
                n = (hurt) / 5
            elseif isteam(eid) then -- 队友内伤计算
                n = (hurt) / 10
            else
                n = (hurt) / 16
            end
            -- 张召重攻击，内伤加倍
            if match_ID(pid, 80) then
                n = n * 2
            end
            nssz = nssz + n
        end
        -- 招式内伤
        for i = 1, JY.Base["武功数量"] do
            local kf = JY.Person[pid]["武功" .. i]
            local yxsy = JY.Person[pid]["优先使用"]
            if yxsy > 0 then
                local kflv = JY.Wugong[yxsy]['层级']
                for j = 1, #CC.KFMove[yxsy] do
                    local zs = CC.WUGONGZS[i][j]
                    if kf == yxsy and WAR.WGZS == j then
                        if JY.Wugong[yxsy]["招式" .. j] >= 51 and JY.Wugong[yxsy]["招式" .. j] <= 54 then
                            nssz = limitX(nssz + math.random(kflv * 3, kflv * 5), 0, 100)
                        end
                    end
                end
            end
        end
        -- 内轻特效518
        if NeiGong_tx(pid, 518) and JLSD(0, dkfcj_ng * 25, pid) then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            nssz = nssz + num
        end
        -- 通臂拳
        if JY.Person[pid]['奇穴' .. 36] == 1 and JY.Wugong[wugong]['武功类型'] == 1 then
            nssz = nssz + 5
        end
        -- 铁掌，高机率造成内伤12~15点
        if wugong == 13 and JLSD(30, 90, pid) and myns(enemyid) == false then
            -- WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(12, 15));
            nssz = nssz + math.random(12, 15)
        end
        -- 铁掌莲花
        if match_ID(pid, 617) then
            if wugong == 157 then
                nssz = nssz + math.random(12, 15)
            end
        end
        if WAR.PD['野球拳'][pid] == 1 and myns(enemyid) == false then
            -- WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(15, 20));
            nssz = nssz + math.random(15, 20)
        end

        -- 萧半和混元一气
        if WAR.HYYQ == 1 and myns(enemyid) == false then
            -- WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(10, 15));  
            nssz = nssz + math.random(10, 15)
        end

        -- 伏魔禅杖造成内伤10~15点
        if JY.Person[pid]["武器"] == 323 and JY.Thing[323]["装备等级"] >= 2 and
            JLSD(0, 50 + (JY.Thing[323]["装备等级"] - 1) * 10, pid) and myns(enemyid) == false then
            -- WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", math.random(10, 15));
            nssz = nssz + math.random(10, 15)
        end

        -- 玄澄 无量禅震 追加10-15点内伤
        if WAR.XC_WLCZ == 1 and myns(enemyid) == false then
            local ns = 10 + math.random(1, 5)
            -- WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) + AddPersonAttrib(eid, "受伤程度", ns);
            nssz = nssz + ns
        end

        -- 陈正德鹰爪功
        if WAR.YZG == 1 and myns(enemyid) == false then
            nssz = nssz + math.random(15, 20)
        end

        -- 奇门内伤
        if JY.Wugong[wugong]["武功类型"] == 5 then
            if WAR.PD["奇门DEBUF"][pid] == 1 then
                -- local n = math.random(JY.Wugong[wugong]["层级"],JY.Wugong[wugong]["层级"]*2+2) 
                nssz = nssz + JY.Wugong[wugong]["层级"] * 5
                WAR.PD["奇门DEBUF"][pid] = nil
            end
        end
        -- 拳法内伤
        if JY.Wugong[wugong]["武功类型"] == 1 then
            nssz = nssz + JY.Wugong[wugong]["层级"] * 5
        end
    end
    -- 七伤拳，强制机率造成内伤17点
    if WAR.YZQS == 1 then
        local ns = 17
        -- 谢逊额外造成+7
        if match_ID(pid, 13) then
            ns = ns + 7
        end
        -- 崆峒五老
        if match_ID(pid, 9750) then
            -- WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", 4);
            ns = ns + 4
        elseif JY.Person[pid]["内力"] < 5000 then
            -- WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid, "受伤程度", 7);
            ns = ns + 7
        end
        nssz = nssz + ns
    end

    local neishangfb = 1
    nssz = nssz * neishangfb

    nssz = nskx(enemyid, nssz)
    nssz = limitX(math.modf(nssz), 0, 100)
    if nssz > 0 and myns(enemyid) == false and hurt > 30 then
        WAR.PD['内伤状态'][enemyid] = (WAR.PD['内伤状态'][eid] or 0) + nssz
        WAR.Person[enemyid]["内伤点数"] = (WAR.Person[enemyid]["内伤点数"] or 0) +
                                                  (WAR.PD['内伤状态'][eid] or 0);
    end
    ------------------中毒统一计算-------------------------------
    -- 中毒计算
    local daidu = JY.Person[pid]["攻击带毒"] + FJDAID(pid)
    local poisonnum = math.modf(JY.Wugong[wugong]["敌人中毒点数"] + daidu)
    -- 500满毒抗可以降低80%的毒
    local bl = limitX(1 - kd / 500, 0, 1)
    -- 炼毒

    if myzd(enemyid) == false then
        if hurt > 30 then
            -- 周芷若白骨爪无视敌人毒抗
            if match_ID(pid, 631) and wugong == 11 then
                bl = 1
            end
            -- 欧阳锋，攻击中毒+30
            if match_ID(pid, 60) then
                poisonnum = poisonnum + 30
            end
            -- 内轻特效501
            if NeiGong_tx(pid, 501) and JLSD(0, dkfcj_ng * 25, pid) then
                poisonnum = math.random(5, 15)
            end

            -- 西毒蛇杖
            if JY.Person[pid]["武器"] == 244 then
                local sz = 10 + 5 * (JY.Thing[244]["装备等级"] - 1)
                poisonnum = poisonnum + sz
            end

            -- 赤练神掌，强制上毒20
            if WAR.WD_CLSZ == 1 then
                poisonnum = poisonnum + 20
            end
            -- 蝶谷毒仙
            if match_ID(pid, 17) then
                poisonnum = poisonnum + math.random(50)
            end
            -- 千蛛万毒手，强制上毒20 标记修改
            if wugong == 334 then
                poisonnum = poisonnum + 20
            end

            -- 殷离 强制上毒20 标记修改
            if match_ID(pid, 646) then
                poisonnum = poisonnum + 20
            end


            -- 田归农与阎基的加成，中毒+5 + 随机15
            if match_ID(pid, 72) then
                for j = 0, WAR.PersonNum - 1 do
                    if match_ID(WAR.Person[j]["人物编号"], 4) and WAR.Person[j]["死亡"] == false and
                        WAR.Person[j]["我方"] == WAR.Person[WAR.CurID]["我方"] then
                        poisonnum = poisonnum + 5 + math.random(15)
                        break
                    end
                end
            end

            -- 招式中毒
            for i = 1, JY.Base["武功数量"] do
                local yxsy = JY.Person[pid]["优先使用"]
                if yxsy > 0 then
                    for j = 1, #CC.KFMove[yxsy] do
                        local zs = CC.WUGONGZS[i][j]
                        local wugong = JY.Person[pid]["武功" .. i]
                        if wugong == yxsy and WAR.WGZS == j then
                            if JY.Wugong[yxsy]["招式" .. j] >= 61 and JY.Wugong[yxsy]["招式" .. j] <= 64 and hurt >
                                30 then
                                local zd = JY.Wugong[yxsy]["层级"] * 10
                                poisonnum = poisonnum + zd
                            end
                        end
                    end
                end
            end
        end
        -- 万毒蚀体1
        if JY.Person[eid]['奇穴' .. 28] == 1 then
            local d = math.random(10, 20)
            -- d = math.modf(d*atkd)
            WAR.Person[WAR.CurID]["中毒点数"] = AddPersonAttrib(pid, "中毒程度", d)
        end
        -- 何铁手，给攻击方强制上毒
        if match_ID(eid, 83) then
            local d = math.random(45, 50)
            d = math.modf(d * atkd)
            -- WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", d)   
            poisonnum = poisonnum + d
        end
        -- 内轻特效516
        if NeiGong_tx(pid, 516) and JLSD(0, dkfcj_ng * 25, pid) then
            local num = math.random(dkfcj_ng+3,(dkfcj_ng+3)*2)
            poisonnum = poisonnum + num
        end
        -- 千蛛万毒 
        if match_ID(pid, 9790) then
            -- WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", 20)
            poisonnum = poisonnum + 20
        end
        -- 何红药，给攻击方强制上毒
        if match_ID(eid, 176) then
            local xnl = 200
            if xnl > JY.Person[pid]['内力'] then
                local sm = math.modf((xnl - JY.Person[pid]['内力']) / 2)
                WAR.Person[WAR.CurID]["生命点数"] = (WAR.Person[WAR.CurID]["生命点数"] or 0) +
                                                            AddPersonAttrib(pid, "生命", -sm);
            end
            WAR.Person[WAR.CurID]["内力点数"] = (WAR.Person[WAR.CurID]["内力点数"] or 0) + AddPersonAttrib(pid, "内力", -xnl)
            -- WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) + AddPersonAttrib(pid, "中毒程度", 20)
            poisonnum = poisonnum + 20
            WAR.Person[WAR.CurID]["体力点数"] = (WAR.Person[WAR.CurID]["体力点数"] or 0) +  AddPersonAttrib(pid, "体力", -5)
        end
        -- 千蛛万毒手 标记修改
        if wugong == 334 then
            WAR.QZWDS = WAR.QZWDS + JY.Person[WAR.Person[enemyid]['人物编号']]['中毒程度']
            if WAR.QZWDS > 100 then
                WAR.QZWDS = 100
            end
        end
        poisonnum = math.modf(poisonnum * bl)

        if poisonnum < 0 then
            poisonnum = 0
        end

        if poisonnum > 0 then
            WAR.Person[enemyid]["中毒点数"] = (WAR.Person[enemyid]["中毒点数"] or 0) + AddPersonAttrib(eid, "中毒程度", math.random(math.modf(poisonnum / 2), math.modf(poisonnum / 2) + 1))
            if JY.Person[eid]["中毒程度"] > 0 then -- 中毒
                WAR.PD["中毒"][eid] = JY.Person[eid]["中毒程度"]
            end

        end
        lib.Debug(JY.Wugong[wugong]['名称'] .. '上毒==' .. poisonnum)
    end

    ------------------战斗结算-------------------------------    
    -- 判断是否可以加实战
    if JY.Person[eid]["生命"] <= 0 and inteam(pid) and WAR.SZJPYX[eid] == nil then
        -- 崆峒派战斗、高升客栈杀欧阳克、家里练功房、全真教练功、青城派练功、少林练功   不加实战
        local wxzd = {17, 67, 226, 220, 224, 219, 79, 352, 354}
        local wx = 0
        for i = 1, 7 do
            if WAR.ZDDH == wxzd[i] then
                wx = 1
            end
        end

        -- 丐帮门口
        if WAR.ZDDH == 82 and GetS(10, 0, 18, 0) == 1 then
            -- wx = 1
        end
        -- 木人巷
        if WAR.ZDDH == 214 and GetS(10, 0, 19, 0) == 1 then
            -- wx = 1
        end

        if WAR.ZDDH == 128 then
            if isteam(pid) and pid ~= 0 then
                local szexp = 0
                if eid == 642 then
                    szexp = 100
                end
                if pid ~= 0 then
                    szexp = szexp * 3
                end
                AddPersonAttrib(pid, '实战', szexp)
                if JY.Person[pid]["实战"] < 500 then
                    AddPersonAttrib(pid, '武学点数', szexp)
                end
                if JY.Person[pid]["实战"] > 500 then
                    JY.Person[pid]["实战"] = 500
                end
                WAR.SZJPYX[eid] = 1
            end
        elseif wx == 0 and isteam(pid) then
            local szexp = 1
            if eid < 191 and 0 < eid then
                szexp = WARSZJY[eid]
                szexp = szexp - 2
                if szexp < 0 then
                    szexp = 1
                end
            end
            if pid ~= 0 then
                szexp = szexp * 3
            end
            AddPersonAttrib(pid, '实战', szexp)
            if JY.Person[pid]["实战"] > 500 then
                JY.Person[pid]["实战"] = 500
            end
            -- if JY.Person[pid]["实战"] < 500 then
            local wxcoint = szexp * 10
            if match_ID(pid, 121) then
                wxcoint = math.modf(wxcoint * 1.1)
            end
            if JY.Person[pid]["实战"] < 500 then
                AddPersonAttrib(pid, '武学点数', wxcoint)
                local n = "Ｏ" .. JY.Person[pid]["姓名"] .. "Ｗ获得武学点数" .. "Ｏ" .. wxcoint .. "Ｗ点"
                lib.LoadPNG(91, 121 * 2, CC.WX * 555, CC.HY * 373, 1)
                tjm(CC.WX * 625, CC.HY * 386, n, C_CYGOLD, CC.DefaultFont * 0.9, 13, CC.DefaultFont * 0.9)
            end
            -- AddPersonAttrib(pid,'武学点数',wxcoint)

            -- end
            WAR.SZJPYX[eid] = 1
        end
    end

    -- 复活
    fuhuo(enemyid)

    -- 人物死亡
    if JY.Person[eid]["生命"] < 0 then
        JY.Person[eid]["生命"] = 0
        WAR.Person[WAR.CurID]["经验"] = WAR.Person[WAR.CurID]["经验"] + 150
        WAR.Person[enemyid]["反击武功"] = -1 -- 如果被打死则不会触发反击
        if WAR.SZSD == eid then -- 取消死战标记
            WAR.SZSD = -1
        end
    end

    -- 平一指杀人
    if JY.Person[eid]["生命"] <= 0 and (match_ID(pid, 28) or match_ID(pid, 9889)) then
        WAR.PYZ = WAR.PYZ + 1
        if 10 < WAR.PYZ then
            WAR.PYZ = 10
        end
    end
    -- 血海魅影杀人
    if match_ID(pid, 9878) and JY.Person[eid]["生命"] <= 0 and WAR.Person[WAR.CurID]['我方'] ~=
        WAR.Person[enemyid]['我方'] then
        local rs = 0
        for j = 0, WAR.PersonNum - 1 do
            if WAR.Person[j]['我方'] ~= WAR.Person[WAR.CurID]['我方'] and WAR.PD['魅惑状态'][eid] == nil then
                rs = rs + 1

            end
        end
        lib.Debug('剩余人数' .. rs)
        if rs > 1 then
            JY.Person[eid]['生命'] = JY.Person[eid]['生命最大值']
            WAR.PD['魅惑状态'][eid] = 9999
        end
    end
    -- 阿紫杀人
    if JY.Person[eid]["生命"] <= 0 and (match_ID(pid, 47) or match_ID(pid, 9886)) then
        WAR.MZSH = WAR.MZSH + 1
    end

    if JY.Person[eid]["生命"] <= 0 and XueZhanShangChang(pid) then
        WAR.XZSC = WAR.XZSC + 1
    end
    -- 李白杀人
    if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 9730) then
        WAR.SBSYR = 1
    end

    -- 血战八方
    -- 内轻特效321
    if NeiGong_tx(pid, 321) and JY.Person[eid]["生命"] <= 0 then
        WAR.PD['血战八方'][pid] = (WAR.PD['血战八方'][pid] or 0) + 1
    end

    -- 无酒不欢：袁承志碧血长风
    -- 限主角
    if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 54) then
        WAR.BXCF = 1
    end
    -- 五六七 标记修改
    if JY.Person[eid]["生命"] <= 0 and match_ID(pid, 9917) and JY.Wugong[75]["名称"] == "魔刀千刃" then
        WAR.ZQCK = 1
    end
    -- 李莫愁赤练神掌
    if WAR.WD_CLSZ == 1 then
        local dam = JY.Person[eid]["中毒程度"]
        WAR.ZQTL = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], pid}
    end

    -- 丁春秋 连环腐尸毒
    if WAR.LHFSD == 1 then
        local dam = JY.Person[eid]["中毒程度"]
        WAR.ZQTL = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], pid}
    end

    -- 湘西尸王
    for i = 0, WAR.PersonNum - 1 do
        if match_ID(WAR.Person[i]["人物编号"], 157) then
            for j = 0, WAR.PersonNum - 1 do
                if WAR.Person[j]["死亡"] == false then
                    if JY.Person[WAR.Person[j]["人物编号"]]["生命"] <= 0 and WAR.Person[j]["人物编号"] ~= 157 then
                        WAR.Person[i]["生命点数"] = (WAR.Person[i]["生命点数"] or 0) +
                                                            AddPersonAttrib(WAR.Person[i]["人物编号"], "生命", 200)
                    end
                end
            end
        end
    end
    -- 青云之志
    for i = 0, WAR.PersonNum - 1 do
        if match_ID(WAR.Person[i]["人物编号"], 752) and WAR.GXZ == 0 then
            if WAR.Person[i]['死亡'] == true then
                for j = 0, WAR.PersonNum - 1 do
                    if WAR.Person[j]["死亡"] == false then
                        if JY.Person[WAR.Person[j]["人物编号"]]["生命"] <= 0 and
                            (WAR.Person[j]["人物编号"] ~= 752 or
                                (JY.Base['畅想'] == 752 and WAR.Person[j]["人物编号"] ~= 0)) then
                            local wid = 752
                            if JY.Base['畅想'] == 752 then
                                wid = 0
                            end
                            JY.Person[wid]['生命'] = JY.Person[wid]['生命最大值']
                            JY.Person[wid]['内力'] = JY.Person[wid]['内力最大值']
                            JY.Person[wid]['体力'] = 100
                            NewWARPersonZJ(wid, true, WAR.Person[j]['坐标X'], WAR.Person[j]['坐标Y'], false, 2)
                            WarDrawMap(0); -- 不加这条则动画位置无法正常显示
                            CurIDTXDH(j, 200, 1, "青云之志.借尸体还魂", C_ORANGE);
                            WAR.GXZ = 1
                        end
                    end
                end
            end
        end
    end
    -- 李莫愁赤练神掌
    if WAR.WD_CLSZ == 1 then
        local dam = JY.Person[eid]["中毒程度"]
        WAR.ZQTL = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], pid}
    end

    -- 丁春秋 连环腐尸毒
    if WAR.LHFSD == 1 then
        local dam = JY.Person[eid]["中毒程度"]
        WAR.ZQTL = {dam, enemyid, WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"], pid}
    end

    local kfjy1 = math.modf(JY.Person[eid]["资质"] / 30 + math.random(2))

    for i = 1, JY.Base["武功数量"] do
        local level = math.modf(JY.Person[eid]["武功等级" .. i] / 100) + 1
        local wugongnum = i
        local wugong = JY.Person[eid]["武功" .. i]
        if wugong == JY.Person[eid]["主运内功"] and wugong > 1 then
            if JY.Person[eid]["武功等级" .. i] >= 900 and JY.Person[eid]["武功等级" .. i] < 999 then
                JY.Person[eid]["武功等级" .. i] = JY.Person[eid]["武功等级" .. i] + kfjy1
                -- lib.Debug('武功'..JY.Wugong[JY.Person[eid]["主运内功"]]['名称']..'等级是'..JY.Person[eid]["武功等级" .. i])
            end
            if JY.Person[eid]["武功等级" .. i] < 999 and JY.Person[eid]["武功等级" .. i] >= 980 then
                local jl = (500 - JY.Person[eid]["实战"]) / 10
                if inteam(eid) then
                    if JY.Person[eid]["武功等级" .. i] < 999 and JY.Person[512]["出战"] == 0 and math.random(100) <
                        jl and eid == 0 and CC.TX["心魔"] == 0 then
                        JY.Person[eid]["武功等级" .. i] = 980
                        DrawStrBoxWaitKey(string.format("%s修炼%s走火入魔引来心魔", JY.Person[eid]["姓名"],
                            JY.Wugong[JY.Person[eid]["武功" .. i]]["名称"]), C_ORANGE, CC.DefaultFont)
                        kfjy1 = 0
                        JY.Person[512]["出战"] = i
                        JY.Person[512]["声望"] = 2
                        local xx, yy = WE_xy(WAR.Person[enemyid]["坐标X"], WAR.Person[enemyid]["坐标Y"] - 1)
                        JY.Person[512]["头像代号"] = 512
                        for i = 1, JY.Base['武功数量'] do
                            local wg = JY.Person[512]['武功' .. i]
                            if wg > 0 then
                                -- lib.Debug('心魔武功 '..i..' == '..JY.Wugong[wg]['名称'])
                                if CC.KFMove[wg] ~= nil then
                                    for p = 1, #CC.KFMove[wg] do
                                        local zs = CC.WUGONGZS[i][p]
                                        JY.Person[512]['武功招式' .. zs] = 0
                                    end
                                    JY.Person[512]['武功' .. i] = 0
                                    JY.Person[512]['武功等级' .. i] = 0
                                end
                            end
                        end
                        for qx = 1, 149 do
                            JY.Person[512]['奇穴' .. qx] = 0
                        end
                        for i = 1, 5 do
                            JY.Person[512]['天赋' .. i] = JY.Person[eid]['天赋' .. i]
                        end
                        JY.Person[512]["头像代号"] = 512
                        WAR.JQSDXS[512] = 0
                        JY.Person[512]["心魔"] = eid
                        JY.Person[512]["头像代号"] = JY.Person[eid]["头像代号"]
                        JY.Person[512]["半身像"] = JY.Person[eid]["半身像"]
                        JY.Person[512]["天赋内功"] = JY.Person[eid]["天赋内功"]
                        JY.Person[512]["天赋外功1"] = JY.Person[eid]["天赋外功1"]
                        JY.Person[512]["天赋外功2"] = JY.Person[eid]["天赋外功2"]
                        JY.Person[512]["天赋轻功"] = JY.Person[eid]["天赋轻功"]
                        JY.Person[512]["指法技巧"] = JY.Person[eid]["指法技巧"]
                        JY.Person[512]["御剑能力"] = JY.Person[eid]["御剑能力"]
                        JY.Person[512]["耍刀技巧"] = JY.Person[eid]["耍刀技巧"]
                        JY.Person[512]["特殊兵器"] = JY.Person[eid]["特殊兵器"]
                        JY.Person[512]["武学常识"] = JY.Person[eid]["武学常识"]
                        JY.Person[512]["攻击带毒"] = JY.Person[eid]["攻击带毒"]
                        for i = 1, 10 do
                            JY.Person[512]["秘技" .. i] = JY.Person[eid]["秘技" .. i]
                        end
                        JY.Person[512]["攻击力"] = JY.Person[eid]["攻击力"]
                        JY.Person[512]["防御力"] = JY.Person[eid]["防御力"]
                        JY.Person[512]["轻功"] = JY.Person[eid]["轻功"]
                        JY.Person[512]["医疗能力"] = JY.Person[eid]["医疗能力"]
                        JY.Person[512]["用毒能力"] = JY.Person[eid]["用毒能力"]
                        JY.Person[512]["解毒能力"] = JY.Person[eid]["解毒能力"]
                        JY.Person[512]["暗器技巧"] = JY.Person[eid]["暗器技巧"]
                        JY.Person[512]["抗毒能力"] = JY.Person[eid]["抗毒能力"]
                        JY.Person[512]["个人觉醒"] = JY.Person[eid]["个人觉醒"]
                        JY.Person[512]["六如觉醒"] = JY.Person[eid]["六如觉醒"]
                        JY.Person[512]["畅想分阶"] = JY.Person[eid]["畅想分阶"]

                        for i = 1, 5 do
                            JY.Person[512]["出招动画帧数" .. i] = JY.Person[eid]["出招动画帧数" .. i]
                            JY.Person[512]["出招动画延迟" .. i] = JY.Person[eid]["出招动画延迟" .. i]
                            JY.Person[512]["武功音效延迟" .. i] = JY.Person[eid]["武功音效延迟" .. i]
                        end
                        JY.Person[512]["武器"] = JY.Person[eid]["武器"]
                        JY.Person[512]["防具"] = JY.Person[eid]["防具"]
                        JY.Person[512]["坐骑"] = JY.Person[eid]["坐骑"]
                        JY.Person[512]["生命最大值"] = math.modf(JY.Person[eid]["生命最大值"] * 1.5)
                        JY.Person[512]["生命"] = JY.Person[512]["生命最大值"]
                        JY.Person[512]["内力最大值"] = math.modf(JY.Person[eid]["内力最大值"] * 1.5)
                        JY.Person[512]["内力"] = JY.Person[512]["内力最大值"]
                        JY.Person[512]["体质"] = JY.Person[eid]["体质"]
                        JY.Person[512]["内力性质"] = JY.Person[eid]["内力性质"]
                        JY.Person[512]["性别"] = JY.Person[eid]["性别"]
                        JY.Person[512]["资质"] = JY.Person[eid]["资质"]
                        JY.Person[512]["能量"] = 2
                        JY.Person[512]["优先使用"] = JY.Person[eid]["优先使用"]
                        JY.Person[512]["主运内功"] = JY.Person[eid]["主运内功"]
                        JY.Person[512]["主运轻功"] = JY.Person[eid]["主运轻功"]
                        for xx = 1, JY.Base['武功数量'] do
                            for p = 1, #CC.KFMove[wugong] do
                                local zs = CC.WUGONGZS[xx][p]
                                JY.Person[512]['武功' .. xx] = JY.Person[eid]['武功' .. xx]
                                JY.Person[512]['武功等级' .. xx] = JY.Person[eid]['武功等级' .. xx]
                                JY.Person[512]["武功招式" .. zs] = JY.Person[eid]["武功招式" .. zs]

                            end
                        end
                        for qx = 1, 149 do
                            JY.Person[512]['奇穴' .. qx] = JY.Person[eid]['奇穴' .. qx]
                        end
                        Health_in_Battle()

                        NewWARPersonZJ(512, false, xx + 1, yy + 1, false, 2)
                        -- end
                    else
                        if JY.Person[512]["出战"] == 1 then
                            JY.Person[eid]["武功等级" .. JY.Person[512]["出战"]] = 900
                            -- say("没有空挥经验",0,1)
                        else
                            if JY.Person[512]["出战"] == 0 then
                                JY.Person[eid]["武功等级" .. i] = JY.Person[eid]["武功等级" .. i] + kfjy1
                                -- say("获得空挥经验"..kfjy1,0,1)
                                if JY.Person[eid]["武功等级" .. i] > 999 then
                                    JY.Person[eid]["武功等级" .. i] = 999
                                    DrawStrBoxWaitKey(string.format("%s修炼%s到登峰造极",
                                        JY.Person[eid]["姓名"], JY.Wugong[JY.Person[eid]["武功" .. i]]["名称"]),
                                        C_ORANGE, CC.DefaultFont)
                                end
                            end
                        end
                    end
                else
                    JY.Person[eid]["武功等级" .. i] = JY.Person[eid]["武功等级" .. i] + kfjy1
                end
                if JY.Person[eid]["武功等级" .. i] >= 999 and i > 0 then
                    -- DrawStrBoxWaitKey(string.format("%s修炼%s到登峰造极", JY.Person[eid]["姓名"], JY.Wugong[JY.Person[eid]["武功" .. i]]["名称"]), C_ORANGE, CC.DefaultFont)
                end
            end
        end
        if JY.Person[512]["品德"] == 2 and JY.Person[512]["声望"] == 2 and
            JY.Person[eid]["武功等级" .. JY.Person[512]["出战"]] < 999 then
            JY.Person[eid]["武功等级" .. JY.Person[512]["出战"]] = 999
            -- say("终于击击败了心魔,感觉对武功的领悟又进了一步。",pid,1)
            DrawStrBoxWaitKey(string.format("%s修炼%s到登峰造极", JY.Person[eid]["姓名"],
                JY.Wugong[JY.Person[eid]["武功" .. JY.Person[512]["出战"]]]["名称"]), C_ORANGE, CC.DefaultFont)
            Cls()
            break
        end
    end
    -- 北冥神功和吸星大法，加内力上限	  
    WAR.NGHT = 0 -- 内功护体
    WAR.CQSX = 0 -- 除却四相
    if Curr_NG(177, eid) then
        WAR.Person[enemyid]["特效动画"] = 176
    end

    -- 达摩的特效动画
    if match_ID(eid, 577) then
        WAR.Person[enemyid]["特效动画"] = 156
    end
    -- 格挡
    if WAR.PD["格挡"][eid] ~= nil and WAR.PD["格挡"][eid] == 1 then
        WAR.Person[enemyid]['特效动画'] = 196
        WAR.PD["格挡"][eid] = nil
    end
    -- 免疫锁足
    if mysz(enemyid) then
        WAR.PD["锁足状态"][eid] = nil
    end

    -- 免疫昏迷
    if myhm(enemyid) then
        WAR.PD["昏迷状态"][eid] = nil
    end

    -- 免疫混乱
    if myhl(enemyid) then
        WAR.PD["混乱状态"][eid] = nil
    end

    if match_ID(pid, 511) and DWPD(WAR.CurID, enemyid) then
        local zt2 = {}
        local pd = false

        -- local n = 0
        local menu = {}
        for j = 1, #WAR.Debuf do
            local yc = WAR.Debuf[j][1]
            if WAR.PD[yc][eid] ~= nil and WAR.PD[yc][eid] > 0 then
                menu[#menu + 1] = {j, 1}
            end
        end
        for j = 1, #zt2 do
            local yc = zt2[j][1]
            if WAR[yc][eid] ~= nil and WAR[yc][eid] > 0 then
                menu[#menu + 1] = {j, 2}
            end
        end
        if #menu > 0 then
            local n = math.random(#menu)
            if menu[n][2] == 1 then
                local yc = zt[menu[n][1]][1]
                local lx = zt[menu[n][1]][2]
                if lx == 2 then
                    if WAR.PD[yc][pid] == nil then
                        WAR.PD[yc][pid] = WAR.PD[yc][eid]
                    else
                        WAR.PD[yc][pid] = WAR.PD[yc][pid] + WAR.PD[yc][eid]
                    end
                end
                WAR.PD[yc][eid] = nil
            else
                local yc = zt2[menu[n][1]][1]
                local lx = zt2[menu[n][1]][2]
                if lx == 2 then
                    if WAR.PD[yc][pid] == nil then
                        WAR.PD[yc][pid] = WAR.PD[yc][eid]
                    else
                        WAR.PD[yc][pid] = WAR.PD[yc][pid] + WAR.PD[yc][eid]
                    end
                end
                WAR[yc][eid] = nil
            end
        end
    end
    if match_ID(eid, 9934) and JLSD(0, 50, eid) and enemyid ~= WAR.CurID then
        local ftcs = 0
        for j = 1, #WAR.Debuf do
            local yc = WAR.Debuf[j][1]
            if WAR.PD[yc][eid] ~= nil then
                if WAR.PD[yc][pid] == nil then
                    WAR.PD[yc][pid] = WAR.PD[yc][eid]
                else
                    WAR.PD[yc][pid] = WAR.PD[yc][pid] + WAR.PD[yc][eid]
                end
                WAR.PD[yc][eid] = nil
                WAR.PD["七略集气"][eid] = 1
                ftcs = ftcs + 1
                if JLSD(0, 50, eid) then
                    if WAR.PD["七略连击"][eid] == nil then
                        WAR.PD["七略连击"][eid] = 1
                    else
                        WAR.PD["七略连击"][eid] = WAR.PD["七略连击"][eid] + 1
                    end
                    if WAR.PD["七略连击"][eid] > 3 then
                        WAR.PD["七略连击"][eid] = 3
                    end
                end
            end
        end
        for j = 1, #WAR.Debuf2 do
            local yc = WAR.Debuf2[j][1]
            if WAR.PD[yc][eid] ~= nil then
                if WAR.PD[yc][pid] == nil then
                    WAR.PD[yc][pid] = WAR.PD[yc][eid]
                else
                    WAR.PD[yc][pid] = WAR.PD[yc][pid] + WAR.PD[yc][eid]
                end
                WAR.PD[yc][eid] = nil
                WAR.PD["七略集气"][eid] = 1
                ftcs = ftcs + 1
                if JLSD(0, 50, eid) then
                    if WAR.PD["七略连击"][eid] == nil then
                        WAR.PD["七略连击"][eid] = 1
                    else
                        WAR.PD["七略连击"][eid] = WAR.PD["七略连击"][eid] + 1
                    end
                    if WAR.PD["七略连击"][eid] > 3 then
                        WAR.PD["七略连击"][eid] = 3
                    end
                end
            end
        end
        local ns = JY.Person[eid]['受伤程度']
        local zd = JY.Person[eid]['中毒程度']
        local bf = JY.Person[eid]['冰封程度']
        local zs = JY.Person[eid]['灼烧程度']
        if ns > 0 then
            -- WAR.Person[i]["解毒点数"]; if WAR.PD["蛤蟆蓄力"][eid] == nil or WAR.PD["蛤蟆蓄力"][eid] == 0 then
            -- WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + AddPersonAttrib(pid,'受伤程度',ns)
            local ns1 = (WAR.PD['内伤状态'][pid] or 0) + ns
            WAR.Person[WAR.CurID]["内伤点数"] = (WAR.Person[WAR.CurID]["内伤点数"] or 0) + ns1
            -- JY.Person[eid]['受伤程度'] = 0
            WAR.PD['内伤状态'][eid] = 0
            WAR.Person[enemyid]["内伤点数"] = nil
            WAR.PD["七略集气"][eid] = 1
            ftcs = ftcs + 1
            if JLSD(0, 50, eid) then
                if WAR.PD["七略连击"][eid] == nil then
                    WAR.PD["七略连击"][eid] = 1
                else
                    WAR.PD["七略连击"][eid] = WAR.PD["七略连击"][eid] + 1
                end
                if WAR.PD["七略连击"][eid] > 3 then
                    WAR.PD["七略连击"][eid] = 3
                end
            end
        end
        if zd > 0 then
            -- WAR.Person[i]["解毒点数"];
            WAR.Person[WAR.CurID]["中毒点数"] = (WAR.Person[WAR.CurID]["中毒点数"] or 0) +
                                                        AddPersonAttrib(pid, '中毒程度', zd)
            JY.Person[eid]['中毒程度'] = 0
            WAR.Person[enemyid]["中毒点数"] = nil
            WAR.PD["七略集气"][eid] = 1
            ftcs = ftcs + 1
            if JLSD(0, 50, eid) then
                if WAR.PD["七略连击"][eid] == nil then
                    WAR.PD["七略连击"][eid] = 1
                else
                    WAR.PD["七略连击"][eid] = WAR.PD["七略连击"][eid] + 1
                end
                if WAR.PD["七略连击"][eid] > 3 then
                    WAR.PD["七略连击"][eid] = 3
                end
            end
        end
        if bf > 0 then
            WAR.BFXS[pid] = 1
            AddPersonAttrib(pid, '冰封程度', bf)
            JY.Person[eid]['冰封程度'] = 0
            WAR.BFXS[eid] = nil
            WAR.PD["七略集气"][eid] = 1
            ftcs = ftcs + 1
            if JLSD(0, 50, eid) then
                if WAR.PD["七略连击"][eid] == nil then
                    WAR.PD["七略连击"][eid] = 1
                else
                    WAR.PD["七略连击"][eid] = WAR.PD["七略连击"][eid] + 1
                end
                if WAR.PD["七略连击"][eid] > 3 then
                    WAR.PD["七略连击"][eid] = 3
                end
            end
        end
        if zs > 0 then
            WAR.ZSXS[pid] = 1
            AddPersonAttrib(pid, '灼烧程度', zs)
            JY.Person[eid]['灼烧程度'] = 0
            WAR.ZSXS[eid] = nil
            WAR.PD["七略集气"][eid] = 1
            ftcs = ftcs + 1
            if JLSD(0, 50, eid) then
                if WAR.PD["七略连击"][eid] == nil then
                    WAR.PD["七略连击"][eid] = 1
                else
                    WAR.PD["七略连击"][eid] = WAR.PD["七略连击"][eid] + 1
                end
                if WAR.PD["七略连击"][eid] > 3 then
                    WAR.PD["七略连击"][eid] = 3
                end
            end
        end
        WAR.Person[enemyid]["特效动画"] = 176
        Set_Eff_Text(enemyid, "特效文字0", "七略.蓍龟");
        if ftcs > 3 then
            WAR.PD["七略坤元"][eid] = 1
        end
    end

    if enemyid ~= WAR.CurID then
        local pd = false
        local gl = (ekfcj_ng * 8)
        -- 内轻特效803
        if NeiGong_tx(eid, 803) and JLSD(0, gl, eid) then
            pd = true
        end
        if pd == true then
            -- 1018
            WAR.PD['内伤状态'][eid] = (WAR.PD['内伤状态'][eid] or 0) + JY.Person[eid]['受伤程度']
            WAR.PD["中毒"][eid] = JY.Person[eid]['中毒程度']
            WAR.PD["冰封"][eid] = JY.Person[eid]['冰封程度']
            WAR.PD["灼烧"][eid] = JY.Person[eid]['灼烧程度']

            local ns = WAR.PD['内伤状态'][eid]
            local zd = WAR.PD["中毒"][eid]
            local bf = WAR.PD["冰封"][eid]
            local zs = WAR.PD["灼烧"][eid]
            for j = 1, #WAR.Debuf do
                local yc = WAR.Debuf[j][1]
                if WAR.PD[yc][eid] ~= nil then
                    if WAR.PD[yc][pid] == nil then
                        WAR.PD[yc][pid] = WAR.PD[yc][eid]
                    else
                        WAR.PD[yc][pid] = WAR.PD[yc][pid] + WAR.PD[yc][eid]
                    end
                    WAR.PD[yc][eid] = nil
                end
            end
            for j = 1, #WAR.Debuf2 do
                local yc = WAR.Debuf2[j][1]
                if WAR.PD[yc][eid] ~= nil then
                    if WAR.PD[yc][pid] == nil then
                        WAR.PD[yc][pid] = WAR.PD[yc][eid]
                    else
                        WAR.PD[yc][pid] = WAR.PD[yc][pid] + WAR.PD[yc][eid]
                    end
                    WAR.PD[yc][eid] = nil
                end
            end
            WAR.Person[enemyid]["特效动画"] = 21
            Set_Eff_Text(enemyid, "特效文字0", "转阴阳");
        end
    end

    WAR.PD['氤氲紫气'][eid] = nil
    if match_ID(pid, 9965) then
        JY.Person[pid]['冰封程度'] = 0
        JY.Person[pid]['灼烧程度'] = 0
        WAR.BFXS[pid] = nil
        WAR.ZSXS[pid] = nil
    end
    -- 心魔战
    if inteam(eid) == false and WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[enemyid]['我方'] and
        JY.Person[eid]["生命"] <= 0 then
        if eid == 512 then
            JY.Person[512]["品德"] = 2
            JY.Person[502]["声望"] = JY.Person[502]["声望"] + 5
            if JY.Person[502]["声望"] > 1500 then
                JY.Person[502]["声望"] = 1500
            end
            AddPersonAttrib(pid, "物品修炼点数", 10000)
            AddPersonAttrib(pid, '武学点数', 100)
            DrawStrBoxWaitKey("我方获得武学点数100点", C_ORANGE, CC.DefaultFont)
        end
    end

    -- 实力升级
    if inteam(pid) and WAR.Person[WAR.CurID]['我方'] ~= WAR.Person[enemyid]['我方'] and JY.Person[eid]["生命"] <=
        0 then
        while JY.Person[pid]["畅想分阶"] > JY.Person[eid]["畅想分阶"] do
            JY.Person[pid]["畅想分阶"] = JY.Person[pid]["畅想分阶"] - 1
            if JY.Person[pid]["畅想分阶"] == 6 then
                JJ_TF(pid)
                -- CC.TX["三流"] = 1
                AddPersonAttrib(pid, "拳掌功夫", 10)
                AddPersonAttrib(pid, "指法技巧", 10)
                AddPersonAttrib(pid, "御剑能力", 10)
                AddPersonAttrib(pid, "耍刀技巧", 10)
                AddPersonAttrib(pid, "特殊兵器", 10)
                AddPersonAttrib(pid, "门派贡献", 50)
            end
            if JY.Person[pid]["畅想分阶"] == 5 then
                JJ_TF(pid)
                -- CC.TX["二流"] = 1
                AddPersonAttrib(pid, "攻击力", 15)
                AddPersonAttrib(pid, "防御力", 15)
                AddPersonAttrib(pid, "轻功", 15)
                AddPersonAttrib(pid, "门派贡献", 50)

            end
            if JY.Person[pid]["畅想分阶"] == 4 then
                JJ_TF(pid)
                -- CC.TX["一流"] = 1
                AddPersonAttrib(pid, "拳掌功夫", 15)
                AddPersonAttrib(pid, "指法技巧", 15)
                AddPersonAttrib(pid, "御剑能力", 15)
                AddPersonAttrib(pid, "耍刀技巧", 15)
                AddPersonAttrib(pid, "特殊兵器", 15)
                AddPersonAttrib(pid, "攻击力", 20)
                AddPersonAttrib(pid, "防御力", 20)
                AddPersonAttrib(pid, "轻功", 20)
                AddPersonAttrib(pid, "门派贡献", 50)

            end
            if JY.Person[pid]["畅想分阶"] == 3 then
                JJ_TF(pid)
                -- CC.TX["豪侠"] = 1
                AddPersonAttrib(pid, "攻击力", 30)
                AddPersonAttrib(pid, "防御力", 30)
                AddPersonAttrib(pid, "轻功", 30)
                AddPersonAttrib(pid, "门派贡献", 50)
            end
            if JY.Person[pid]["畅想分阶"] == 2 then
                JJ_TF(pid)
                -- CC.TX["宗师"] = 1
                AddPersonAttrib(pid, "攻击力", 40)
                AddPersonAttrib(pid, "防御力", 40)
                AddPersonAttrib(pid, "轻功", 40)
                AddPersonAttrib(pid, "门派贡献", 50)
            end
            if JY.Person[pid]["畅想分阶"] == 1 then
                JJ_TF(pid)
                -- CC.TX["传说"] = 1
                AddPersonAttrib(pid, "拳掌功夫", 30)
                AddPersonAttrib(pid, "指法技巧", 30)
                AddPersonAttrib(pid, "御剑能力", 30)
                AddPersonAttrib(pid, "耍刀技巧", 30)
                AddPersonAttrib(pid, "特殊兵器", 30)
                AddPersonAttrib(pid, "攻击力", 50)
                AddPersonAttrib(pid, "防御力", 50)
                AddPersonAttrib(pid, "轻功", 50)
                AddPersonAttrib(pid, "门派贡献", 50)
            end
            if JY.Person[pid]["畅想分阶"] == 0 then
                JJ_TF(pid)
                -- CC.TX["传说"] = 1
                AddPersonAttrib(pid, "拳掌功夫", 30)
                AddPersonAttrib(pid, "指法技巧", 30)
                AddPersonAttrib(pid, "御剑能力", 30)
                AddPersonAttrib(pid, "耍刀技巧", 30)
                AddPersonAttrib(pid, "特殊兵器", 30)
                AddPersonAttrib(pid, "攻击力", 50)
                AddPersonAttrib(pid, "防御力", 50)
                AddPersonAttrib(pid, "轻功", 50)
                AddPersonAttrib(pid, "门派贡献", 50)
            end
        end
    end
    ::label0::
end

--伤害结算
Ct['伤害结算'] = function(wugong, level, ang, x, y, ZHEN_ID)
    ----------------------函数初设变量--------------------------------
    local hurt = 0
    local pid = WAR.Person[WAR.CurID]['人物编号']
    local dkf_ng = JY.Person[pid]['主运内功']
    local dkfcj_ng = JY.Wugong[dkf_ng]['层级']
    local dkf_qg = JY.Person[pid]['主运轻功']
    local dkfcj_qg = JY.Wugong[dkf_qg]['层级']
    -- 没有合击
    if not ZHEN_ID then
        ZHEN_ID = -1
    end
    local yxsy = JY.Person[pid]['优先使用']
    -- 计算攻击方的输出
    hurt, ang = Cat('伤害计算Act', wugong, level, ang, x, y)
    lib.Debug(JY.Person[pid]['姓名']..'伤害结算计算气攻'..ang)
    if JY.Base["难度"] == 3 then
        -- hurt = hurt * 0.7
    elseif JY.Base["难度"] == 2 then
        -- hurt = hurt * 0.6
    elseif JY.Base["难度"] == 1 then
        ---hurt = hurt * 0.5		
    end

    if JY.Base["难度"] == 3 then
        -- ang = ang * 0.7
    elseif JY.Base["难度"] == 2 then
        -- ang = ang * 0.6
    elseif JY.Base["难度"] == 1 then
        -- ang = ang * 0.5		
    end
    -- 范围内目标
    local xznum = 0
    for i = 0, CC.WarWidth - 1 do
        for j = 0, CC.WarHeight - 1 do
            lib.GetKey()
            local effect = GetWarMap(i, j, 4)
            if 0 < effect then
                local emeny = GetWarMap(i, j, 2)
                if emeny > -1 then
                    if WAR.Person[emeny]["我方"] ~= WAR.Person[WAR.CurID]["我方"] and
                        JY.Person[WAR.Person[emeny]["人物编号"]]["生命"] > 0 then
                        xznum = xznum + 1;
                    end
                end
            end
        end
    end
  -------------------------百分比增伤写这里--------------------------
    lib.Debug('计算百分比增伤：')
    -- 斗转星移伤害和杀集气计算
    if WAR.DZXYLV[pid] ~= nil and WAR.DZXYLV[pid] > 0 then
        local dz = WAR.DZXYLV[pid] / 100 - 1
        --[[
    elseif WAR.DZXYLV[pid] == 120 then
        fj = string.format("%s发动幻梦星辰反击", JY.Person[pid]["姓名"])
    elseif WAR.DZXYLV[pid] == 110 then
        fj = string.format("%s发动离合参商反击", JY.Person[pid]["姓名"])
    elseif WAR.DZXYLV[pid] == 100 then
        fj = string.format("%s发动斗转星移反击", JY.Person[pid]["姓名"])
    elseif WAR.DZXYLV[pid] == 90 then
        ]]
        if WAR.DZXYLV[pid] == 200 then
            dz = 0
        end
        local zs = hurt * dz
        -- 物转星移
        if JY.Person[pid]['奇穴' .. 149] == 1 then
            zs = hurt * dz*1.2
        end
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'斗转星移伤害和杀集气计算' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    --蓄力
    if WAR.Actup[pid] ~= nil then 
        local zs = hurt*0.25
        --内轻特效1007
        if NeiGong_tx(pid,1007) then 
            zs = zs + hurt*(dkfcj_ng*0.125)
        end
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'蓄力' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    --醉意
    if WAR.PD['醉意'][pid] ~= nil then 
        local zs = hurt*(WAR.PD['醉意'][pid] or 0 )*0.1
        hurt = hurt + zs 
        lib.Debug(JY.Person[pid]["姓名"] ..'醉意' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 内轻特效933 攻击时随自身怒气值增加伤害
    if NeiGong_tx(pid, 933) then
        local zs = hurt*(WAR.LQZ[pid] or 0)/100 * dkfcj_ng*15/100
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'内轻特效933' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end    
    -- 内轻特效902
    if NeiGong_tx(pid, 902) then
        local zs = dkfcj_ng * 25/100*hurt
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'内轻特效902' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end

    -- 内轻特效300
    if NeiGong_tx(pid, 300) then
        local zs = hurt * (dkfcj_ng + 1) * 6 / 100
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'内轻特效300' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end

    -- 绝招
    if WAR.WGZS == #CC.KFMove[yxsy] then
        local zs = hurt * 0.5
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'绝招' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- lib.Debug(JY.Wugong[wugong]['名称']..'攻击范围内目标= '..xznum)
    -- 浩然正气
    if WAR.PD['浩然正气'][pid] ~= nil and WAR.PD['浩然正气'][pid] > 0 then
        local zs = hurt * (WAR.PD['浩然正气'][pid] * 0.05)
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'浩然正气' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 傲世狂刀
    local dfnum = 0
    if JY.Person[pid]['奇穴' .. 51] == 1 and JY.Wugong[JY.Person[pid]['优先使用']]['武功类型'] == 4 then
        WarDrawMap(0); -- 不加这条则动画位置无法正常显示				
        CurIDTXDH(WAR.CurID, 146, 1, "傲世狂刀", C_RED);
        WarDrawMap(0); -- 不加这条则动画位置无法正常显示	
        for i = 0, WAR.PersonNum - 1 do
            local yid = WAR.Person[i]['人物编号']
            if WAR.Person[i]['我方'] ~= WAR.Person[WAR.CurID]['我方'] then
                dfnum = dfnum + 1
            end
        end
        hurt = hurt * (1 + dfnum / 100 * 5)
        WAR.LQZ[pid] = WAR.LQZ[pid] or 0 + 5
        if WAR.LQZ[pid]  > 100 then 
            WAR.LQZ[pid]  = 100
        end
        local zs =  hurt * (dfnum / 100 * 5)
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'盖世神拳' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 盖世神拳
    if WAR.PD['盖世神拳'][pid] ~= nil and WAR.PD['盖世神拳'][pid] == 1 then
        local xx = (6 - xznum) / 10
        local zs = hurt * (xx)
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'盖世神拳' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 剑魔BOSS
    if match_ID(pid, 592) and Boss(WAR.CurID) then
        if WAR.PD['独孤剑势'][pid] ~= nil then
            local zs = hurt * (1 + WAR.PD['独孤剑势'][pid] / 20)
            hurt = hurt + zs
            lib.Debug(JY.Person[pid]["姓名"] ..'独孤剑势' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
        end
    end
    -- 以一贯之
    if match_ID(pid, 447) then
        if xznum == 1 then
            hurt = hurt * 1.3
            local zs = hurt*0.3
            hurt = hurt + zs
            lib.Debug(JY.Person[pid]["姓名"] ..'以一贯之' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
        end
    end
    -- 开碑
    if JY.Person[pid]['奇穴' .. 32] == 1 and JY.Wugong[wugong]['武功类型'] == 1 then
        local zs = hurt*0.2
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'开碑' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 裂石
    if JY.Person[pid]["奇穴" .. 3] == 1 and JY.Wugong[wugong]['武功类型'] == 2 then
        local zs = 0.05
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'裂石' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 血刀门特性
    if JY.Person[pid]['门派'] == 17 then
        if JY.Person[pid]['品德'] < 50 then
            local zs = (50 - JY.Person[pid]['品德'])/200*hurt
            hurt = hurt + zs
            lib.Debug(JY.Person[pid]["姓名"] ..'血刀门特性' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
        end
    end
    -- 集中状态
    if WAR.PD["集中状态"][pid] ~= nil then
        local zs = -hurt/2
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'集中状态' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 达尔巴死战
    -- 参合状态
    if WAR.PD['参合状态'][pid] ~= nil then
        local n = math.random(110, 130)
        local zs = hurt * (100 - n) / 100
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'参合状态' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 9988玉面孟尝
    if match_ID(pid, 9988) then
        local ym = 0
        for i = 0, WAR.PersonNum - 1 do
            local yid = WAR.Person[i]['人物编号']
            if WAR.Person[i]['我方'] == WAR.Person[WAR.CurID]['我方'] and JY.Person[yid]['性别'] == 1 then
                ym = ym + 1
            end
        end
        local zs = ym*10/100*hurt
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'9988玉面孟尝' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 门派武功数量增伤
    if MP_wgnum(pid) > 0 then
        local num = MP_wgnum(pid)
        local zs = 0
        zs = hurt*num*5/100
        if num > 7 then
            zs = hurt*20/100
        end
        if num > 3 and num < 8 then
            zs = hurt*10/100
        end
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'门派武功数量增伤' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 血战八方增伤
    if WAR.PD['血战八方'][pid] ~= nil then
        local zs = hurt * (WAR.PD['血战八方'][pid] / 10)
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'血战八方' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 汤大侠
    if match_ID(pid, 731) then
        local jl = 100 - JY.Person[0]['品德']
        if JLSD(0, jl, pid) then
            local zs = hurt*0.3
            hurt = hurt + zs
            lib.Debug(JY.Person[pid]["姓名"] ..'血战八方' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
        end
    end
    -- 激昂状态
    if WAR.PD['激昂'][pid] ~= nil then
        local zs = hurt * ( WAR.PD['激昂'][pid] * 5 / 100)
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'激昂状态' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 铁划银勾
    if match_ID(pid, 9779) then
        local tn = Person_BJ(pid) / 2
        local zs = hurt*(tn) / 100
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'铁划银勾' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 尼摩星
    if match_ID(pid, 159) then
        local zs = hurt*0.5
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'尼摩星' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 剑神随剑法增伤
    if match_ID(pid, 9941) then
        local n = 0
        for i = 1, JY.Base['武功数量'] do
            if JY.Wugong[JY.Person[pid]['武功' .. i]]['武功类型'] == 3 then
                n = n + 1
            end
        end
        local zs = hurt * (n / 100 * 3)
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'剑神随剑法增伤' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 外和内刚，生命低于30增伤15%
    if match_ID(pid, 9830) and JY.Person[pid]["生命"] < JY.Person[pid]["生命最大值"] * 0.3 then
        local zs = hurt*0.15
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'外和内刚，生命低于30增伤15' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 9809一龙一象
    if match_ID(pid, 9809) then
        local zs = hurt*0.1
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'9809一龙一象' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 千秋侠烈
    if match_ID(pid, 9909) then
        local dd = 0
        local tt = JY.Person[pid]["生命"] / JY.Person[pid]["生命最大值"]
        if tt < 0.25 then
            dd = 0.5
        elseif tt < 0.5 then
            dd = 0.25
        end
        local zs = hurt*dd
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'千秋侠烈' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 越战越勇 
    if match_ID(pid, 9950) then
        local dd = 0
        local tt = JY.Person[pid]["生命"] / JY.Person[pid]["生命最大值"]
        dd = tt / 2
        if dd < 0.15 then
            dd = 0.15
        end
        if dd > 0.65 then
            dd = 0.35
        end
        local zs = hurt*dd
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'千秋侠烈' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 铜笔铁算盘
    if match_ID(pid, 188) then
        if JY.Person[pid]['武器'] == 53 then
            local zs = hurt*0.05
            hurt = hurt + zs
            lib.Debug(JY.Person[pid]["姓名"] ..'铜笔铁算盘' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
        end
    end

    -- 顽童武痴
    if match_ID(pid, 64) and WAR.ZBT > 0 then
        local zs = hurt * WAR.ZBT * 0.05
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'顽童武痴' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    -- 太乙分光剑法 合计伤害1.5倍
    if wugong == 363 and ZHEN_ID >= 0 then
        local zs = hurt * 0.15
        hurt = hurt + zs
        lib.Debug(JY.Person[pid]["姓名"] ..'千秋侠烈' .. '增加伤害= ' ..zs.. ' hurt ='.. hurt)
    end
    lib.Debug(JY.Person[pid]["姓名"] ..'百分比增伤害后伤害=' .. hurt)
    -- 距离增减伤害
    -- 距离伤害递减
    -- 离剑式 梯云纵 剑气碧烟横不递减
    for i = 0, WAR.PersonNum - 1 do
        if WAR.Person[i]["我方"] ~= WAR.Person[WAR.CurID]['我方'] then
            local offset = math.abs(WAR.Person[WAR.CurID]["坐标X"] - WAR.Person[i]["坐标X"]) +
                               math.abs(WAR.Person[WAR.CurID]["坐标Y"] - WAR.Person[i]["坐标Y"])
            if offset > 11 then
                offset = 11
            end
            if match_ID(pid, 652) and JY.Base["天书数量"] > 5 then
                hurt = hurt * (100 + (offset - 1) * 6) / 100
                -- lib.Debug('距离1='..offset)
                break
                ---云罗天网，无情,寸长寸强    
            elseif WAR.YLTW == 1 or match_ID(pid, 448) or (Pmiji(pid, 17) and JY.Wugong[wugong]['武功类型'] == 5) then
                hurt = hurt * (100 + (offset - 1) * 3) / 100
                -- lib.Debug('距离2='..offset)
                break
            elseif isteam(pid) == false then
            elseif WAR.JQBYH ~= 1 then
            elseif WAR.JJZC ~= 1 then
            else
                hurt = hurt * (100 - (offset - 1) * 3) / 100
                -- lib.Debug('距离3='..offset)
                break
            end
        end
    end

    lib.Debug(JY.Person[pid]["姓名"] ..'距离增减伤害后伤害=' .. hurt)
    --内轻特效1036 伤害浮动
    if NeiGong_tx(pid,1036) then 
        if hurt > 0 then 
            local zs1 = hurt*(dkfcj_ng*5/100)
            local zs = hurt*(dkfcj_ng*15/100)
            local zs3 = math.random(zs1,zs)
            hurt = hurt + zs3
            lib.Debug(JY.Person[pid]["姓名"] ..'内轻特效1036'..'增伤'..zs3.. '后伤害=' .. hurt)
        end
    end
    -----------------------
    lib.Debug(JY.Person[pid]["姓名"] .. "最终造成的伤害=" .. hurt)
    -----------------------
    -- 王重阳1 同归剑法
    if WAR.PD["同归状态"][pid] ~= nil and MyFj(WAR.CurID) == false then
        Cat('伤害计算Def', WAR.CurID, wugong, level, ang, hurt)
        SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
        WAR.TXXS[pid] = 1
    end
    -------------------------反弹伤害统一写这里--------------------    
    for i = 0, WAR.PersonNum - 1 do
        local id = WAR.Person[i]['人物编号']
        local kf1 = JY.Person[id]['主运内功']
        local dkfcj1 = JY.Wugong[kf1]['层级']
        local x1, y1 = WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y']
        -- 是否命中，默认命中
        local mz = true
        -- 是否为反弹伤害
        local fs = false
        local hurt2 = hurt
        local ang2 = ang
        if WAR.Person[i]['死亡'] == false and GetWarMap(x1, y1, 4) > 0 and i ~= WAR.CurID then
            -- 是否队友误伤，队友情况下
            if DWPD(WAR.CurID, i) == false then
                -- 混乱为误伤，伤害不衰减
                if WAR.PD["混乱状态"][pid] ~= nil then
                    -- SetWarMap(x1,y1,4,2)
                    mz = true
                    -- 标记为反弹伤害
                    fs = true
                    -- 误伤不打到队友    
                elseif WAR.WS == 1 then
                    mz = false
                    -- 合击不打队友    
                elseif ZHEN_ID >= 0 then
                    mz = false
                end
            end
            -- 天王护命丹
            if WAR.PD['天王护命'][id] ~= nil and WAR.PD['天王护命'][id] >= 80 and hurt > JY.Person[id]['生命'] then
                JY.Person[id]['生命'] = 1
                WAR.Person[i]["特效文字3"] = "天王护命"
                WAR.Person[i]["特效动画"] = 135
                mz = false
            end

            -- 林朝阳 轻云蔽月 无法被打到
            if match_ID(id, 605) or match_ID(id, 9803) then
                if WAR.QYBY[id] == nil then
                    WAR.QYBY[id] = 50
                end
                if WAR.QYBY[id] > 40 then
                    WAR.Person[i]["特效文字3"] = "轻云蔽月"
                    WAR.Person[i]["特效动画"] = 102
                    mz = false
                end
            -- 忘情天书 云翳
            elseif WAR.PD['云翳'][id] ~= nil and WAR.PD['云翳'][id] == 1 then 
                if WAR.QYBY[id] == nil then
                    WAR.QYBY[id] = 50
                end
                if WAR.QYBY[id] >= 40 then
                    WAR.Person[i]["特效文字3"] = "云翳"
                    WAR.Person[i]["特效动画"] = 102
                    mz = false
                end
                WAR.PD['云翳'][id] = nil
            end
            if match_ID(id, 27) and WAR.LQZ[id] == 100 then
                if WAR.PD["唯我不败"][id] == nil then
                    WAR.PD["唯我不败"][id] = 20
                end
                if WAR.PD["唯我不败"][id] > 0 then
                    WAR.Person[i]["特效文字3"] = "唯我不败"
                    WAR.Person[i]["特效动画"] = 102
                    mz = false
                end
            end
            if match_ID(id, 9981) and JY.Person[0]["六如觉醒"] > 0 and WAR.FF < 3 then
                WAR.FF = WAR.FF + 1
                WAR.Person[i]["特效动画"] = 135
                mz = false
            end
            -- 天魔金身
            -- 内轻特效816
            if NeiGong_tx(id, 816) then
                if JY.Person[id]["生命"] < JY.Person[id]["生命最大值"] / 2 then
                    if WAR.TMJT[id] == nil then
                        WAR.TMJT[id] = 100
                    end
                    if WAR.TMJT[id] >= 100 - (dkfcj_ng * 3) then
                        WAR.Person[i]["特效文字1"] = "天魔金身"
                        WAR.Person[i]["特效动画"] = 122
                        mz = false
                    end
                end
            end

            -- 被打中时
            if mz == true then
                -- 龙王反弹
                if WAR.PD["倾国倾城"][id] ~= nil and MyFj(WAR.CurID) == false then
                    WAR.Person[i]["特效动画"] = 75
                    Set_Eff_Text(i, "特效文字2", "倾国倾城")
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    -- 将自己切换为随即敌方目标
                    if list[1] ~= nil then
                        WAR.Person[i]["特效动画"] = 149
                        F_target = list[math.random(#list)]
                        i = F_target
                    end
                    -- 无论是否有第三方，既无论是否反弹，都消耗一次次数
                    WAR.PD["倾国倾城"][id] = WAR.PD["倾国倾城"][id] - 1
                    if WAR.PD["倾国倾城"][id] < 1 then
                        WAR.PD["倾国倾城"][id] = nil
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                end
                -- 甩锅
                if match_ID(id, 515) and WAR.QMWZ < 1 and JLSD(10, 35, id) and MyFj(WAR.CurID) == false then
                    WAR.Person[i]["特效动画"] = 75
                    Set_Eff_Text(i, "特效文字2", "甩锅")
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    -- 将自己切换为随即敌方目标
                    if list[1] ~= nil then
                        F_target = list[math.random(#list)]
                        i = F_target
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                    WAR.QMWZ = WAR.QMWZ + 1
                end

                -- 阿碧替代慕容复承受伤害
                if match_ID(id, 105) and WAR.QMWZ < 1 then
                    WAR.Person[i]["特效动画"] = 75
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    -- 将自己切换为随即敌方目标
                    if list[1] ~= nil then
                        for z = 1, #list do
                            local n = list[z]
                            if WAR.Person[n]['人物编号'] == 105 then
                                F_target = 105
                                i = F_target
                            end
                        end
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                    WAR.QMWZ = WAR.QMWZ + 1
                end

                -- 无相转身替李秋水承受伤害
                if match_ID(id, 9835) and WAR.QMWZ < 1 then
                    WAR.Person[i]["特效动画"] = 75
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    -- 将自己切换为随即敌方目标
                    if list[1] ~= nil then
                        for z = 1, #list do
                            local n = list[z]
                            if WAR.Person[n]['人物编号'] == 600 then
                                F_target = 600
                                i = F_target
                            end
                        end
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                    WAR.QMWZ = WAR.QMWZ + 1
                end
                -- 内轻特效806 反弹
                if NeiGong_tx(id, 806) and MyFj(WAR.CurID) == false and JLSD(10, dkfcj1 * 25, id) then
                    WAR.Person[i]["特效动画"] = 95
                    Set_Eff_Text(i, "特效文字2", "反弹")
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    if list[1] ~= nil then
                        F_target = list[math.random(#list)]
                        i = F_target
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                    WAR.QMWZ = WAR.QMWZ + 1
                end
                if WAR.PD["七略坤元"][id] ~= nil and WAR.PD["七略坤元"][id] == 1 and WAR.QMWZ < 1 and
                    MyFj(WAR.CurID) == false then
                    WAR.PD["七略坤元"][id] = nil
                    WAR.Person[i]["特效动画"] = 188
                    Set_Eff_Text(i, "特效文字0", "坤元")
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    -- 将自己切换为随即敌方目标
                    if list[1] ~= nil then
                        F_target = list[math.random(#list)]
                        i = F_target
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                    WAR.QMWZ = WAR.QMWZ + 1
                end
                -- 内轻特效822 之三
                if  WAR.PD['天机秘术'][id] ~= nil and WAR.PD['天机秘术'][id] == 4 and WAR.QMWZ < 1 and MyFj(WAR.CurID) == false then
                    WAR.Person[i]["特效动画"] = 188
                    -- Set_Eff_Text(i, "特效文字0", "坤元")
                    local list = {}
                    for q = 0, WAR.PersonNum - 1 do
                        if WAR.Person[q]["死亡"] == false and DWPD(i, q) then
                            table.insert(list, q)
                        end
                    end
                    local F_target
                    -- 将自己切换为随即敌方目标
                    if list[1] ~= nil then
                        F_target = list[math.random(#list)]
                        i = F_target
                    end
                    id = WAR.Person[i]['人物编号']
                    -- 标记为反弹伤害
                    fs = true
                    WAR.QMWZ = WAR.QMWZ + 1
                    WAR.PD['天机秘术'][id] = nil
                end
                -- 斗转星移
                Cat('斗转', i, wugong, hurt, ang)
                --
                if WAR.PD['至刚反伤'][id] ~= nil  then 
                    local zgfs = (WAR.PD['至刚反伤'][id] or 0)*2
                    Set_Eff_Text(i, "特效文字0", "至刚反伤")
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.3, zgfs)
                    lib.Debug(JY.Person[WAR.Person[WAR.CurID]['人物编号']]['姓名']..'至刚反伤='..zgfs)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end
                -- 内轻特效807
                if NeiGong_tx(id, 807) then
                    local jl = JY.Wugong[JY.Person[id]['主运内功']]['层级'] * 25
                    if JLSD(0, jl, id) then
                        Set_Eff_Text(i, "特效文字0", "反震")
                        Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.3, hurt2 * 0.3)
                        SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                        WAR.TXXS[pid] = 1
                    end
                end
                -- 赵敏反震
                if match_ID(id, 609) and MyFj(WAR.CurID) == false then
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.3, hurt2 * 0.3)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end
                --太玄反震
                if WAR.PD ['太玄反震'][id] ~= nil and WAR.PD ['太玄反震'][id] == 1 then
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.3, hurt2 * 0.5)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1 
                    WAR.PD ['太玄反震'][id] = nil 
                end
                -- 神罗天征
                if Pmiji(id, 7) and WAR.PD['神罗天征'][id] ~= nil and MyFj(WAR.CurID) == false then
                    Set_Eff_Text(i, "特效文字0", "神罗天征")
                    -- SHENLUOTZ(i)
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.5, hurt2 * 0.5)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end
                -- 带刺玫瑰
                if match_ID(id, 9884) and JY.Person[id]["防具"] == 58 and MyFj(WAR.CurID) == false then
                    Set_Eff_Text(i, "特效文字0", "软猬甲")
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.3, hurt2 * 0.3)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end

                -- 锦毛虎一身是胆 
                if Pmiji(id, 11) then
                    local jgfmq = 0
                    for j = 0, WAR.PersonNum - 1 do
                        if WAR.Person[j]["死亡"] == false and WAR.Person[j]["我方"] == WAR.Person[i]["我方"] then
                            jgfmq = jgfmq + 1
                        end
                    end
                    if jgfmq >= 5 and math.random(10) < 4 then
                        Set_Eff_Text(i, "特效文字3", "锦毛虎一身是胆")
                        Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.1, hurt2 * 0.1)
                        SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                        WAR.TXXS[pid] = 1
                    end
                end
                -- 忘情天书-我无，反弹的是攻击者本身，不需要判定反弹伤害
                if WAR.PD['我无'][id] ~= nil and MyFj(WAR.CurID) == false then
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 2, hurt2 * 2)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end
                -- 破剑八刀标记为反弹伤害，反弹的是攻击者本身，不需要判定反弹伤害
                if WAR.PD['破剑八刀'][id] ~= nil and MyFj(WAR.CurID) == false then
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 2, hurt2 * 2)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end
                -- 亦复如是
                if WAR.PD['亦复如是'][id] ~= nil and MyFj(WAR.CurID) == false then
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang, hurt2)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end
                -- 斗酒僧
                if match_ID(id, 638) and MyFj(WAR.CurID) == false then
                    Set_Eff_Text(i, "特效文字0", "九阳神功・反震")
                    Cat('伤害计算Def', WAR.CurID, wugong, level, ang * 0.4, hurt2 * 0.4)
                    SetWarMap(WAR.Person[WAR.CurID]['坐标X'], WAR.Person[WAR.CurID]['坐标Y'], 4, 2)
                    WAR.TXXS[pid] = 1
                end

                -- 乾坤反弹减伤
                hurt2, ang2 = Cat('乾坤反弹', i, wugong, hurt, ang, level)

                -- 误伤时候伤害只有10%
                if (DWPD(WAR.CurID, i) == false and fs == false) or WAR.PD["易容"][id] ~= nil then
                    hurt2 = math.modf(hurt2 * 0.10)
                    ang2 = math.modf(ang2 * 0.10)
                    WAR.PD["易容"][id] = nil
                end
                -- 闪避的人物不计算伤害
                if WAR.Miss[id] == nil then
                    Cat('伤害计算Def', i, wugong, level, ang2, hurt2)
                    SetWarMap(WAR.Person[i]['坐标X'], WAR.Person[i]['坐标Y'], 4, 2)
                    WAR.TXXS[id] = 1
                end
            end
        end
    end
end
